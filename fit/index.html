<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>goatiFIT - Tu Entrenador Personal IA de Élite</title>

    <!-- Corrected favicon path to user's file -->
    <link rel="icon" href="Logos HD.png" type="image/png">

    <meta name="description" content="goatiFIT: Tu entrenador personal de élite con IA. Creado por goatify.app para mejorar tu vida con herramientas inteligentes. Rutinas personalizadas, seguimiento de progreso y bienestar.">
    <meta name="keywords" content="goatiFIT, entrenador personal, IA, fitness, gym, entrenamiento, rutinas, bienestar, salud, goati, goatify, Daniel Ortega Corella">
    <meta name="author" content="Daniel Ortega Corella, goatify.app">
    <link rel="canonical" href="https://goatifit.app">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* --- Root Variables for Themes --- */
        :root {
            --primary-glow: rgba(138, 79, 255, 0.7);
            --primary: #8a4fff;
            --primary-hover: #9d6bff;
            --secondary: #1a1a1a;
            --light: #282828;
            --dark: #101010;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --success: #22c55e;
            --warning: #facc15;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg-gradient-start: var(--dark);
            --bg-gradient-end: #1a0f2e;
            --bg-main: var(--dark);
            --bg-card: rgba(26, 26, 26, 0.7);
            --border-color: rgba(138, 79, 255, 0.1);
            --box-shadow-color: rgba(138, 79, 255, 0.05);
            --input-bg: var(--secondary);
        }

        /* Light Theme */
        body.light-theme {
            --primary-glow: rgba(138, 79, 255, 0.4);
            --primary: #8a4fff;
            --primary-hover: #9d6bff;
            --secondary: #f0f0f0;
            --light: #ffffff;
            --dark: #e0e0e0;
            --text-primary: #1a1a1a;
            --text-secondary: #505050;
            --success: #16a34a;
            --warning: #eab308;
            --danger: #dc2626;
            --info: #2563eb;
            --bg-gradient-start: #f5f5f5;
            --bg-gradient-end: #e0e0e0;
            --bg-main: #f5f5f5;
            --bg-card: rgba(255, 255, 255, 0.8);
            --border-color: rgba(138, 79, 255, 0.08);
            --box-shadow-color: rgba(138, 79, 255, 0.03);
            --input-bg: #ffffff;
        }

        /* --- ANIMATIONS --- */
        @keyframes background-pan {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes pulse-neon {
            0%,
            100% {
                box-shadow: 0 0 5px 1px var(--danger), 0 0 10px 2px var(--danger);
            }

            50% {
                box-shadow: 0 0 10px 2px var(--danger), 0 0 20px 5px var(--danger);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes toast-in {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes toast-out {
            from {
                transform: translateY(0);
                opacity: 0;
            }

            to {
                transform: translateY(100%);
                opacity: 0;
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(0.9);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.5;
            }

            100% {
                transform: scale(0.9);
                opacity: 1;
            }
        }

        /* Breathing Animations */
        @keyframes calm-breathe-in {
            from {
                transform: scale(0.8);
                opacity: 0.6;
                stroke: var(--info);
            }

            to {
                transform: scale(1.2);
                opacity: 1;
                stroke: var(--success);
            }
        }

        @keyframes calm-breathe-out {
            from {
                transform: scale(1.2);
                opacity: 1;
                stroke: var(--success);
            }

            to {
                transform: scale(0.8);
                opacity: 0.6;
                stroke: var(--info);
            }
        }

        @keyframes power-breathe-in {
            from {
                transform: scale(0.7);
                opacity: 0.8;
                stroke: #ff00ff;
            }

            /* Brighter color, smaller start */
            to {
                transform: scale(1.3);
                opacity: 1;
                stroke: #ff66ff;
            }

            /* Larger max scale for power */
        }

        @keyframes power-breathe-out {
            from {
                transform: scale(1.3);
                opacity: 1;
                stroke: #ff66ff;
            }

            to {
                transform: scale(0.7);
                opacity: 0.8;
                stroke: #ff00ff;
            }
        }

        @keyframes relax-breathe-in {
            from {
                transform: scale(0.7);
                opacity: 0.5;
                stroke: #6a0dad;
            }

            /* Deep purple */
            to {
                transform: scale(1.3);
                opacity: 1;
                stroke: #9932cc;
            }
        }

        @keyframes relax-breathe-out {
            from {
                transform: scale(1.3);
                opacity: 1;
                stroke: #9932cc;
            }

            to {
                transform: scale(0.7);
                opacity: 0.5;
                stroke: #6a0dad;
            }
        }

        /* Anti-Stress Visualizer Animation (More dynamic) */
        @keyframes stress-visualizer-pulse {
            0% {
                transform: scale(0.9);
                opacity: 0.7;
                box-shadow: 0 0 15px rgba(138, 79, 255, 0.6);
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
                box-shadow: 0 0 30px rgba(138, 79, 255, 1);
            }

            100% {
                transform: scale(0.9);
                opacity: 0.7;
                box-shadow: 0 0 15px rgba(138, 79, 255, 0.6);
            }
        }

        /* Progress Circle Glow & Animation */
        @keyframes circle-glow-pulse {
            0%,
            100% {
                filter: drop-shadow(0 0 8px var(--primary-glow));
            }

            50% {
                filter: drop-shadow(0 0 15px var(--primary));
            }
        }

        /* --- CORE LAYOUT FIX --- */
        html {
            height: 100%;
        }

        body {
            height: 100vh;
            /* Full viewport height */
            display: flex;
            flex-direction: column;
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-main);
            background-image: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 50%, var(--bg-gradient-start) 100%);
            background-size: 200% 200%;
            animation: background-pan 15s ease infinite;
            color: var(--text-primary);
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #app-container {
            flex-grow: 1;
            /* Takes up all available space */
            overflow-y: auto;
            /* Enables scrolling ONLY for the content area */
            overflow-x: hidden;
            padding-bottom: 100px;
            /* Space for content above the FIXED nav bar */
        }

        .screen {
            display: none;
            /* Hide screens by default */
            flex-direction: column;
            width: 100%;
            padding: 1rem;
            /* Default padding for screens */
            animation: fadeIn 0.5s ease-out;
            will-change: transform, opacity;
            min-height: 100%;
            /* Ensure screen takes at least full height */
        }

        .screen.active {
            display: flex;
            /* Show only the active screen */
        }

        .screen.fullscreen {
            padding: 0;
            height: 100%;
            justify-content: center;
        }

        /* --- GLOBAL NAVIGATION BAR --- */
        #global-nav-bar {
            position: fixed;
            /* Always visible at the bottom */
            bottom: 0;
            left: 0;
            right: 0;
            flex-shrink: 0;
            /* Prevent nav from shrinking */
            z-index: 1000;
            border-top: 1px solid var(--border-color);
        }

        .nav-btn {
            color: var(--text-secondary);
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
        }

        .nav-btn i {
            transition: all 0.2s ease-in-out;
        }

        .nav-btn.active {
            color: var(--primary);
            transform: translateY(-5px) scale(1.05);
        }

        .nav-btn.active i {
            filter: drop-shadow(0 0 8px var(--primary-glow));
        }

        /* --- GENERAL STYLING --- */
        .beast-mode-active {
            animation: pulse-neon 1.5s infinite;
        }

        .btn {
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--primary-hover));
            color: white;
            box-shadow: 0 4px 20px var(--primary-glow);
        }

        .btn-secondary {
            background-color: var(--light);
            color: var(--text-primary);
            border: 1px solid rgba(128, 128, 128, 0.2);
        }

        .btn-secondary.active,
        .btn-secondary:hover {
            background-color: var(--primary);
            border-color: var(--primary-hover);
            color: white;
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .btn-special-glow {
            background: linear-gradient(45deg, #ff2d2d, #ff7b2d);
            color: white;
            box-shadow: 0 0 25px rgba(255, 60, 60, 0.6);
            animation: pulse-neon 2s infinite;
        }

        .glassmorphism {
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 var(--box-shadow-color);
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        textarea,
        input,
        select {
            background-color: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid rgba(128, 128, 128, 0.2);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        textarea::placeholder,
        input::placeholder {
            color: var(--text-secondary);
        }

        /* --- CLOCK & TIMER DESIGN IMPROVEMENTS --- */
        .timer-circle-progress {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1s linear;
        }

        /* Stop the trembling/pulsing animation on the clock display */
        #timer-tool-display,
        #workout-timer-display,
        #sleep-clock {
            animation: none;
            font-variant-numeric: tabular-nums;
            /* Ensures numbers don't shift width */
        }

        /* Workout screen vertical alignment */
        #workout-screen main {
            justify-content: flex-end;
            /* Pushes content to the bottom */
            padding-bottom: 5vh;
            /* Adds some space from the bottom */
        }

        /* Sleep screen vertical alignment */
        #sleep-screen #sleep-main-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding-bottom: 15vh;
            /* Push content further down */
        }

        .phase-border-work {
            border-color: var(--success);
        }

        .phase-color-work {
            color: var(--success);
        }

        .phase-border-rest {
            border-color: var(--warning);
        }

        .phase-color-rest {
            color: var(--warning);
        }

        .phase-border-prep {
            border-color: var(--primary);
        }

        .phase-color-prep {
            color: var(--primary);
        }

        .phase-border-cooldown {
            border-color: var(--info);
        }

        .phase-color-cooldown {
            color: var(--info);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--secondary);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: var(--primary);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-hover);
        }

        .fade-in {
            animation: fadeIn 0.6s ease-in-out forwards;
            opacity: 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--light);
            transition: .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(22px);
        }

        .mood-btn {
            transition: all 0.2s ease;
        }

        .mood-btn.active svg {
            color: var(--primary);
            transform: scale(1.2);
            filter: drop-shadow(0 0 10px var(--primary-glow));
        }

        .mood-btn svg {
            color: var(--text-secondary);
        }

        .timer-active-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 12px;
            height: 12px;
            background-color: var(--success);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .circle-progress-container {
            position: relative;
            width: 100%;
            /* Make it responsive */
            max-width: 120px;
            /* Max size for larger screens */
            padding-bottom: 100%;
            /* Aspect ratio 1:1 */
            margin: auto;
        }

        .circle-progress-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .circle-bg {
            fill: none;
            stroke: var(--secondary);
            stroke-width: 8px;
        }

        .circle-progress {
            fill: none;
            stroke: var(--primary);
            stroke-width: 8px;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dasharray 0.5s, stroke 0.5s, filter 0.5s;
            filter: drop-shadow(0 0 5px var(--primary-glow));
            /* Subtle glow */
            animation: circle-glow-pulse 3s infinite ease-in-out;
            /* Added glow animation */
        }

        /* Removed heartbeat-anim from sleep clock */
        #sleep-clock {
            animation: none;
        }

        .muscle-group {
            fill: var(--secondary);
            stroke: var(--text-secondary);
            stroke-width: 0.5;
            transition: fill 0.3s ease, opacity 0.3s ease, transform 0.2s ease;
            opacity: 0.6;
        }

        .muscle-group:hover,
        .muscle-group.active {
            opacity: 1 !important;
            fill: var(--primary) !important;
            stroke: var(--primary-hover);
            cursor: pointer;
            transform: scale(1.05);
        }

        #tooltip {
            position: fixed;
            display: none;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: bold;
            pointer-events: none;
            z-index: 1000;
            transition: opacity 0.2s;
        }

        #toast-container {
            position: fixed;
            bottom: 100px;
            /* Adjusted for global nav */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 12px 20px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            animation: toast-in 0.5s forwards, toast-out 0.5s 3.5s forwards;
        }

        .toast.success {
            background: linear-gradient(45deg, var(--success), #2edc72);
        }

        .toast.error {
            background: linear-gradient(45deg, var(--danger), #f86c6c);
        }

        .toast.info {
            background: linear-gradient(45deg, var(--primary), var(--primary-hover));
        }

        /* Anti-Stress Modal specific styling */
        #anti-stress-modal-content {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, #1a0f2e 50%, var(--bg-gradient-start) 100%);
            background-size: 200% 200%;
            animation: background-pan 15s ease infinite;
            border: none;
            display: flex;
            /* Ensure flexbox for centering */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            /* Take full height of modal overlay */
            width: 100%;
            /* Take full width */
            padding: 2rem;
            /* Add padding for content */
        }

        #stress-visualizer-canvas {
            /* Changed from circle to canvas */
            width: 100%;
            max-width: 300px;
            /* Max size for the visualizer */
            height: 300px;
            margin: 2rem auto;
            border-radius: 50%;
            /* Keep it circular */
            background-color: transparent;
            /* Canvas will draw content */
            animation: stress-visualizer-pulse 4s infinite ease-in-out;
            /* New animation */
            transition: background-color 0.5s ease;
        }

        #stress-instruction {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        /* NEW: Improved Menstrual Tracker Card */
        #menstrual-tracker-card-new {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 105, 180, 0.2);
        }

        #menstrual-tracker-card-new .date-input-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--secondary);
            padding: 0.5rem 1rem;
            border-radius: 12px;
        }

        #menstrual-tracker-card-new input[type="date"] {
            background: transparent;
            border: none;
            color: var(--text-primary);
            flex-grow: 1;
            font-weight: bold;
        }

        #menstrual-tracker-card-new input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        #menstrual-cycle-display-new {
            margin-top: 1.5rem;
            text-align: center;
        }

        #menstrual-cycle-display-new .cycle-day-display {
            font-size: 3rem;
            font-weight: 900;
            color: var(--primary);
            line-height: 1;
        }

        #menstrual-cycle-display-new .cycle-phase-display {
            font-weight: bold;
            color: #ff69b4;
            /* Hot Pink */
            margin-top: 0.25rem;
        }

        #menstrual-cycle-display-new .phase-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            max-width: 250px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>

<body class="dark-theme">
    <div id="app-container" class="custom-scrollbar">
        <div id="dashboard-screen" class="screen items-center">
            <header class="w-full text-center mb-8 pt-8">
                <div class="flex justify-center items-center gap-4">
                    <!-- Corrected image source to "Logos HD.png" -->
                    <img src="Logos HD.png" alt="Logos HD" class="h-12 w-12 mr-2">
                    <i class="fas fa-dumbbell text-6xl text-primary" style="filter: drop-shadow(0 0 10px var(--primary-glow));"></i>
                    <div>
                        <h1 class="text-5xl font-black" data-translate-key="main_title">goati<span class="text-primary">FIT</span></h1>
                        <p class="text-xl text-text-secondary mt-2" data-translate-key="subtitle">Tu Entrenador de Élite con IA</p>
                    </div>
                </div>
                <div id="points-display" class="mt-4 glassmorphism inline-block px-4 py-2 rounded-full cursor-pointer">
                    <span class="font-bold text-primary"><i class="fas fa-star"></i> <span id="points-value">0</span> PTS</span>
                </div>
                <div id="daily-missions-display" class="mt-4 glassmorphism inline-block px-4 py-2 rounded-full cursor-pointer bg-red-800/20 border-red-500/30">
                    <span class="font-bold text-red-400"><i class="fas fa-clipboard-check"></i> <span id="missions-completed">0</span>/<span id="missions-total">0</span> Misiones</span>
                </div>
            </header>

            <main class="w-full max-w-4xl space-y-6">
                <a href="https://www.goatify.app" target="_blank" class="btn btn-special-glow w-full p-4 rounded-lg font-bold text-lg fade-in" style="animation-delay: 0.1s;">
                    <i class="fas fa-rocket mr-3"></i> <span>Organiza tu Vida con Goati</span>
                </a>

                <div class="glassmorphism p-6 rounded-2xl fade-in" style="animation-delay: 0.2s;">
                    <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-fire text-primary mr-3"></i><span data-translate-key="mission_title">Tu Misión de Hoy</span></h2>
                    <div id="workout-of-the-day" class="text-center p-6 bg-secondary rounded-lg">
                        <p class="text-text-secondary" data-translate-key="mission_placeholder">Usa el Laboratorio de Entrenamiento o pide una rutina a la IA para empezar.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glassmorphism p-6 rounded-2xl fade-in" style="animation-delay: 0.4s;">
                        <h2 class="text-2xl font-bold mb-4"><i class="fas fa-comments text-primary mr-3"></i><span data-translate-key="ia_prompt_title">Pide tu Rutina a la IA</span></h2>
                        <textarea id="user-prompt" class="w-full h-24 p-4 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none resize-none" data-translate-key="ia_prompt_placeholder" placeholder="Ej: 'Quiero una rutina de 45 mins en el gimnasio para espalda y bíceps'"></textarea>
                        <div class="flex gap-2 mt-2">
                            <button class="ai-modifier-btn btn btn-secondary flex-1 text-sm" data-modifier="sin equipo" data-original-text-key="ai_modifier_no_equipment" data-original-icon-class="fas fa-ban"><i class="fas fa-ban mr-1"></i> <span data-translate-key="ai_modifier_no_equipment">Sin Equipo</span></button>
                        </div>
                        <button id="generate-btn" class="btn btn-primary btn-glow w-full p-4 rounded-lg font-bold text-lg mt-4" data-original-text-key="ia_prompt_button" data-original-icon-class="fas fa-cogs">
                            <i class="fas fa-cogs mr-2"></i> <span data-translate-key="ia_prompt_button">Crear con IA</span>
                        </button>
                    </div>
                    <div class="glassmorphism p-6 rounded-2xl fade-in" style="animation-delay: 0.6s;">
                        <h2 class="text-2xl font-bold mb-4"><i class="fas fa-flask text-primary mr-3"></i><span data-translate-key="lab_title">Laboratorio de Entrenamiento</span></h2>
                        <p class="text-text-secondary mb-4" data-translate-key="lab_description">Elige un modo de entrenamiento o un desafío específico.</p>
                        <button id="open-lab-btn" class="btn btn-secondary btn-glow w-full p-4 rounded-lg font-bold text-lg mt-4">
                            <i class="fas fa-arrow-right mr-2"></i> <span data-translate-key="lab_button">Ir al Laboratorio</span>
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <div id="lab-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="lab_title">Workout Lab</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl mx-auto">
                <div class="mb-8 fade-in">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="tools_title">Herramientas de Precisión</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="timer-type-selection">
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="stopwatch" data-original-text-key="tool_stopwatch" data-original-icon-class="fas fa-stopwatch"><i class="fas fa-stopwatch text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_stopwatch">Cronómetro</span></button>
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="timer" data-original-text-key="tool_timer" data-original-icon-class="fas fa-hourglass-half"><i class="fas fa-hourglass-half text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_timer">Temporizador</span></button>
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="tabata" data-original-text-key="tool_tabata" data-original-icon-class="fas fa-bolt"><i class="fas fa-bolt text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_tabata">Tábata</span></button>
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="rounds" data-original-text-key="tool_rounds" data-original-icon-class="fas fa-sync-alt"><i class="fas fa-sync-alt text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_rounds">Rondas</span></button>
                    </div>
                </div>
                <div class="fade-in" style="animation-delay: 0.2s;">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="challenges_title">Desafíos Rápidos</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button class="challenge-btn btn btn-secondary p-6 rounded-lg text-left" data-challenge="abs" data-original-text-key="challenge_abs_title" data-original-icon-class="🔥">
                            <h3 class="text-xl font-bold text-primary" data-translate-key="challenge_abs_title">🔥 Abdomen de Acero</h3>
                            <p class="text-sm text-text-secondary mt-1" data-translate-key="challenge_abs_desc">Un reto rápido y brutal de 10 minutos para fortalecer tu core.</p>
                        </button>
                        <button class="challenge-btn btn btn-secondary p-6 rounded-lg text-left" data-challenge="plank" data-original-text-key="challenge_plank_title" data-original-icon-class="⏳">
                            <h3 class="text-xl font-bold text-primary" data-translate-key="challenge_plank_title">⏳ Plank Challenge</h3>
                            <p class="text-sm text-text-secondary mt-1" data-translate-key="challenge_plank_desc">¿Cuánto puedes aguantar? Un test de resistencia en plancha.</p>
                        </button>
                        <button class="challenge-btn btn btn-secondary p-6 rounded-lg text-left" data-challenge="pushups" data-original-text-key="challenge_pushups_title" data-original-icon-class="💪">
                            <h3 class="text-xl font-bold text-primary" data-translate-key="challenge_pushups_title">💪 Desafío de Flexiones</h3>
                            <p class="text-sm text-text-secondary mt-1" data-translate-key="challenge_pushups_desc">Máximas flexiones en 5 series. ¡Apunta a la fatiga muscular!</p>
                        </button>
                        <button class="challenge-btn btn btn-secondary p-6 rounded-lg text-left" data-challenge="pullups" data-original-text-key="challenge_pullups_title" data-original-icon-class="🧗">
                            <h3 class="text-xl font-bold text-primary" data-translate-key="challenge_pullups_title">🧗 Desafío de Barras</h3>
                            <p class="text-sm text-text-secondary mt-1" data-translate-key="challenge_pullups_desc">Un test de fuerza de espalda y bíceps. ¿Cuántas dominadas logras?</p>
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <div id="timer-tool-screen" class="screen items-center justify-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto absolute top-0 left-1/2 -translate-x-1/2">
                <button class="back-to-lab-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 id="timer-tool-title" class="text-3xl font-black text-primary">Herramienta</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-md flex flex-col items-center justify-center text-center h-full">
                <div id="timer-config-container" class="w-full mb-8">
                    <div id="timer-config" class="hidden w-full space-y-4">
                        <h3 class="text-xl font-bold">Configurar Tiempo</h3>
                        <div class="flex gap-4 justify-center">
                            <input id="timer-minutes" type="number" class="w-24 p-3 text-2xl text-center rounded-lg" placeholder="00" min="0" max="59">
                            <span class="text-4xl font-bold">:</span>
                            <input id="timer-seconds" type="number" class="w-24 p-3 text-2xl text-center rounded-lg" placeholder="00" min="0" max="59">
                        </div>
                    </div>
                    <div id="tabata-config" class="hidden w-full space-y-4">
                        <h3 class="text-xl font-bold">Configurar Tábata</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="tabata-work" class="font-bold">Trabajo (seg)</label><input id="tabata-work" type="number" class="w-full mt-1 p-3 text-center rounded-lg" value="20"></div>
                            <div><label for="tabata-rest" class="font-bold">Descanso (seg)</label><input id="tabata-rest" type="number" class="w-full mt-1 p-3 text-center rounded-lg" value="10"></div>
                            <div class="col-span-2"><label for="tabata-rounds" class="font-bold">Rondas</label><input id="tabata-rounds" type="number" class="w-full mt-1 p-3 text-center rounded-lg" value="8"></div>
                        </div>
                    </div>
                    <div id="rounds-config" class="hidden w-full space-y-4">
                        <h3 class="text-xl font-bold">Configurar Rondas</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="rounds-target" class="font-bold">Rondas Objetivo</label><input id="rounds-target" type="number" class="w-full mt-1 p-3 text-center rounded-lg" placeholder="10"></div>
                            <div><label for="rounds-rest" class="font-bold">Descanso (seg)</label><input id="rounds-rest" type="number" class="w-full mt-1 p-3 text-center rounded-lg" placeholder="60"></div>
                        </div>
                        <p class="text-text-secondary text-sm pt-4">Usa el botón grande para contar repeticiones manualmente.</p>
                    </div>
                </div>

                <div id="timer-tool-display-area" class="text-center mb-8 flex-grow flex flex-col justify-center items-center">
                    <div id="timer-tool-phase" class="text-3xl font-bold uppercase tracking-widest text-primary mb-2"></div>
                    <div id="timer-tool-display" class="text-8xl md:text-9xl font-black">00:00.00</div>
                    <div id="timer-tool-rounds-display" class="text-2xl font-semibold mt-2"></div>
                    <div id="lap-times-container" class="mt-4 w-full max-h-40 overflow-y-auto custom-scrollbar hidden">
                        <h4 class="text-lg font-bold text-primary mb-2">Vueltas:</h4>
                        <ul id="lap-times-list" class="list-none p-0 m-0 text-sm"></ul>
                    </div>
                </div>

                <div id="timer-tool-controls" class="flex gap-4">
                    <button id="timer-tool-start" class="btn btn-primary w-32 p-4 rounded-lg font-bold text-lg"><i class="fas fa-play mr-2"></i> Iniciar</button>
                    <button id="timer-tool-pause" class="btn btn-secondary w-32 p-4 rounded-lg font-bold text-lg hidden"><i class="fas fa-pause mr-2"></i> Pausar</button>
                    <button id="timer-tool-reset" class="btn btn-danger bg-danger w-32 p-4 rounded-lg font-bold text-lg"><i class="fas fa-sync-alt mr-2"></i> Reset</button>
                    <button id="timer-tool-lap" class="btn btn-info bg-info w-32 p-4 rounded-lg font-bold text-lg hidden"><i class="fas fa-flag mr-2"></i> Vuelta</button>
                </div>
                <div id="rounds-counter-control" class="hidden flex flex-col items-center gap-4">
                    <button id="round-counter-btn" class="btn btn-primary rounded-full w-48 h-48 text-6xl font-black">0</button>
                    <button id="round-next-btn" class="btn btn-success bg-success w-48 p-3 rounded-lg font-bold text-lg"><i class="fas fa-forward-step mr-2"></i> Siguiente Ronda</button>
                </div>
            </main>
        </div>

        <div id="workout-screen" class="screen justify-between">
            <header class="w-full flex justify-between items-center flex-shrink-0 pt-4 max-w-2xl mx-auto">
                <h2 id="workout-title" class="text-xl md:text-2xl font-bold truncate"></h2>
                <button id="exit-workout-btn" class="btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-times mr-2"></i> <span data-translate-key="exit_button">Salir</span></button>
            </header>
            <main class="flex flex-col items-center justify-center flex-grow text-center w-full max-w-2xl relative">
                <div id="exercise-info" class="w-full">
                    <p id="current-exercise" class="text-3xl md:text-4xl font-bold"></p>
                    <p id="next-exercise" class="text-lg md:text-xl text-text-secondary mt-2"></p>
                </div>
                <div class="relative w-64 h-64 md:w-80 md:h-80 flex items-center justify-center my-4">
                    <div class="absolute w-full h-full bg-secondary rounded-full opacity-50"></div>
                    <svg class="absolute w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-700" stroke-width="5" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="workout-progress-circle" class="timer-circle-progress" stroke-width="5" stroke-linecap="round" stroke="var(--primary)" fill="transparent" r="45" cx="50" cy="50" transform="rotate(-90 50 50)" />
                    </svg>
                    <div id="workout-timer-ring" class="z-10 text-center flex flex-col items-center justify-center w-[calc(100%-40px)] h-[calc(100%-40px)] rounded-full border-8 border-transparent transition-colors duration-500 bg-dark">
                        <p id="workout-phase-label" class="text-xl md:text-2xl font-bold uppercase tracking-widest"></p>
                        <p id="workout-timer-display" class="text-7xl md:text-8xl font-black"></p>
                    </div>
                </div>
                <div id="how-to-container" class="w-full max-w-md glassmorphism p-4 rounded-lg hidden">
                    <h4 class="text-lg font-bold text-primary mb-2"><i class="fas fa-lightbulb mr-2"></i><span data-translate-key="how_to_title">Cómo Hacerlo</span>:</h4>
                    <ol id="how-to-steps" class="text-left list-decimal list-inside space-y-1 text-sm"></ol>
                </div>
            </main>
            <footer class="w-full flex justify-center items-center gap-4 flex-shrink-0 pb-4">
                <button id="prev-btn" class="btn btn-secondary p-4 rounded-full w-16 h-16 text-2xl"><i class="fas fa-backward-step"></i></button>
                <button id="play-pause-btn" class="btn btn-primary btn-glow p-4 rounded-full w-24 h-24 text-4xl"><i class="fas fa-play ml-1"></i></button>
                <button id="next-btn" class="btn btn-secondary p-4 rounded-full w-16 h-16 text-2xl"><i class="fas fa-forward-step"></i></button>
                <button id="beast-mode-btn" class="btn btn-secondary p-4 rounded-full w-16 h-16 text-2xl text-danger border-danger" data-translate-key="beast_mode_button_title" title="Modo Bestia: Añade un finisher intenso"><i class="fas fa-skull-crossbones"></i></button>
            </footer>
        </div>

        <div id="post-workout-screen" class="screen fullscreen items-center justify-center text-center bg-gray-900 overflow-hidden">
            <div id="visualizer-canvas-container" class="absolute inset-0 w-full h-full">
                <canvas id="visualizer-canvas" class="w-full h-full"></canvas>
            </div>
            <div class="relative z-10 p-4">
                <h1 id="visualizer-title" class="text-3xl font-bold text-white mb-4"></h1>
                <p id="visualizer-message" class="text-xl text-gray-300"></p>
                <button id="exit-visualizer-btn" class="btn btn-primary mt-8 px-8 py-3 rounded-lg font-bold">
                    <i class="fas fa-check-circle mr-2"></i><span>Terminar</span>
                </button>
            </div>
        </div>

        <div id="offline-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="offline_title">Modo Offline</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl flex-grow mx-auto space-y-6">
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="create_own_title">Crea tu Propia Rutina</h2>
                    <p class="text-text-secondary mb-4" data-translate-key="create_own_desc">Diseña tu entrenamiento perfecto y guárdalo para acceder sin conexión.</p>
                    <div class="space-y-4">
                        <input type="text" id="new-routine-name" class="w-full p-3 rounded-lg" placeholder="Nombre de la rutina (ej: Lunes de Pecho)">
                        <textarea id="new-routine-exercises" class="w-full h-32 p-3 rounded-lg" placeholder="Ejercicios y series (ej: 4x12 Press Banca, 3x15 Aperturas, 4x10 Flexiones)"></textarea>
                        <button id="save-custom-routine-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold"><i class="fas fa-save mr-2"></i> Guardar Rutina</button>
                    </div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="offline_desc">Rutinas sin Conexión</h2>
                    <p class="text-text-secondary mb-4" data-translate-key="offline_info">Accede a una biblioteca de entrenamientos precargados, perfectos para cuando no tienes internet.</p>
                    <div id="offline-routines-list" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                    </div>
                </div>
            </main>
        </div>

        <div id="data-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="data_title">Mis Datos</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-6">
                    <div class="glassmorphism p-6 rounded-2xl">
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-weight-scale text-primary mr-3"></i>Datos Físicos</h2>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="input-weight" class="font-bold" data-translate-key="data_weight">Peso (kg)</label>
                                    <input id="input-weight" type="number" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="e.g., 75.5">
                                </div>
                                <div>
                                    <label for="input-height" class="font-bold" data-translate-key="data_height">Altura (cm)</label>
                                    <input id="input-height" type="number" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="e.g., 170">
                                </div>
                            </div>
                            <div>
                                <label for="input-bmi" class="font-bold" data-translate-key="data_bmi">IMC</label>
                                <input id="input-bmi" type="text" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="Calculado automáticamente" readonly>
                            </div>
                            <div>
                                <label for="input-sleep" class="font-bold" data-translate-key="data_sleep_hours">Horas de Sueño (hoy)</label>
                                <input id="input-sleep" type="number" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="e.g., 7.5">
                            </div>
                            <div>
                                <label class="font-bold" data-translate-key="data_water_liters">Agua (litros hoy)</label>
                                <input id="input-water" type="number" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="e.g., 2.5">
                            </div>
                        </div>
                    </div>
                    <div class="glassmorphism p-6 rounded-2xl">
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-ruler-combined text-primary mr-3"></i>Medidas Corporales (única vez)</h2>
                        <input id="input-measures" type="text" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="cintura:75, bíceps:35">
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="glassmorphism p-6 rounded-2xl">
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-smile text-primary mr-3"></i>Estado de Ánimo (hoy)</h2>
                        <div id="energy-tracker" class="flex justify-around mt-2">
                        </div>
                    </div>
                </div>
                <div class="md:col-span-2 space-y-6">
                    <button id="save-data-btn" class="btn btn-primary w-full p-4 rounded-lg font-bold text-lg"><i class="fas fa-save mr-2"></i><span data-translate-key="data_save_button">Guardar Datos de Hoy</span></button>
                    <button id="analyze-data-btn" class="btn btn-secondary w-full p-4 rounded-lg font-bold text-lg"><i class="fas fa-brain mr-2"></i><span data-translate-key="data_analyze_button">Analizar Mis Datos con IA</span></button>
                </div>
            </main>
        </div>

        <div id="sleep-screen" class="screen fullscreen items-center justify-center text-center bg-gray-900">
            <div class="absolute top-4 right-4">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-times"></i></button>
            </div>
            <div id="sleep-main-content">
                <div class="relative flex items-center justify-center w-64 h-64">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div id="sleep-clock" class="text-6xl font-black"></div>
                    </div>
                    <div class="breathing-circle-anim absolute w-full h-full bg-blue-500/30 rounded-full"></div>
                    <div class="breathing-circle-anim absolute w-3/4 h-3/4 bg-blue-500/40 rounded-full" style="animation-delay: -2s;"></div>
                    <div class="breathing-circle-anim absolute w-1/2 h-1/2 bg-blue-500/50 rounded-full" style="animation-delay: -4s;"></div>
                </div>
                <h1 class="text-3xl font-bold text-white mt-8" data-translate-key="sleep_title">Módulo de Sueño</h1>
                <p class="text-gray-300 mt-2" data-translate-key="sleep_desc">Relájate y prepárate para un descanso profundo.</p>
                <div class="mt-8 space-y-4 w-full max-w-xs">
                    <div class="flex justify-center gap-4">
                        <button class="sleep-sound-btn btn btn-secondary p-4 rounded-lg" data-sound="brown" title="Ruido Marrón"><i class="fas fa-wind text-2xl"></i></button>
                        <button class="sleep-sound-btn btn btn-secondary p-4 rounded-lg" data-sound="rain" title="Lluvia"><i class="fas fa-cloud-rain text-2xl"></i></button>
                        <button class="sleep-sound-btn btn btn-secondary p-4 rounded-lg" data-sound="forest" title="Bosque"><i class="fas fa-tree text-2xl"></i></button>
                    </div>
                    <div class="relative">
                        <input type="range" id="sleep-timer-slider" min="0" max="120" value="0" class="w-full">
                        <div id="sleep-timer-active-indicator" class="timer-active-indicator hidden"></div>
                    </div>
                    <p class="text-white"><span data-translate-key="sleep_timer_label">Timer</span>: <span id="sleep-timer-value">Off</span></p>
                    <button id="toggle-sleep-sound-btn" class="btn btn-primary w-full p-4 rounded-full font-bold">
                        <i class="fas fa-play mr-2"></i><span data-translate-key="sleep_start_button">Iniciar Sonido</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="wellness-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="wellness_title">Centro de Bienestar</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl flex-grow mx-auto">
                <div class="grid grid-cols-3 gap-4 md:gap-6">
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="breathing">
                        <i class="fas fa-lungs text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Respiración</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="mobility">
                        <i class="fas fa-person-walking text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Movilidad</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="reflection">
                        <i class="fas fa-lightbulb text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Reflexión</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="stress">
                        <i class="fas fa-brain text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Anti-Estrés</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="ice">
                        <i class="fas fa-snowflake text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Terapia Hielo</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="intimate">
                        <i class="fas fa-heart text-4xl mb-2"></i><span class="font-semibold text-center text-sm">B. Íntimo</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="supplements">
                        <i class="fas fa-pills text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Suplementos</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="sleep">
                        <i class="fas fa-moon text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Sueño</span>
                    </button>
                </div>
            </main>
        </div>

        <div id="breathing-screen" class="screen fullscreen items-center justify-center text-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto absolute top-0 left-1/2 -translate-x-1/2">
                <button class="back-to-wellness-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="wellness_breathing_title">Respiración Guiada</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-md flex flex-col items-center justify-center text-center">
                <div id="breathing-circle" class="relative w-64 h-64 mx-auto my-4 flex items-center justify-center">
                    <svg class="absolute w-full h-full" viewBox="0 0 100 100">
                        <circle id="breathing-visual-circle" stroke-width="5" stroke-linecap="round" stroke="var(--info)" fill="transparent" r="45" cx="50" cy="50" style="transform: scale(0.8); transform-origin: 50% 50%;"></circle>
                    </svg>
                    <i id="breathing-icon" class="fas fa-lungs text-6xl text-white z-10"></i>
                </div>
                <p id="breathing-instruction" class="text-2xl font-bold h-10"></p>
                <div class="flex justify-center gap-4 mt-8">
                    <button id="start-calm-breathing-btn" data-type="calm" class="btn btn-primary px-6 py-3"><i class="fas fa-play mr-2"></i><span data-translate-key="wellness_breathing_calm">Calma 4-7-8</span></button>
                    <button id="start-power-breathing-btn" data-type="power" class="btn btn-secondary px-6 py-3"><i class="fas fa-bolt mr-2"></i><span data-translate-key="wellness_breathing_power">Poder</span></button>
                    <button id="start-relax-breathing-btn" data-type="relax" class="btn btn-secondary px-6 py-3"><i class="fas fa-leaf mr-2"></i><span data-translate-key="wellness_breathing_relax">Relajación</span></button>
                </div>
            </main>
        </div>


        <div id="progress-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="progress_title">Mi Progreso</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl flex-grow mx-auto space-y-8">
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-between">
                        <span data-translate-key="progress_weekly_title">Actividad Semanal</span>
                        <button class="info-btn text-primary text-lg" data-info="weekly"><i class="fas fa-info-circle"></i></button>
                    </h2>
                    <!-- Flexbox for responsive progress circles -->
                    <div id="weekly-chart" class="flex flex-col sm:flex-row justify-around items-center p-4 text-center space-y-4 sm:space-y-0 sm:space-x-2 md:space-x-4">
                        <div class="flex-1 w-full sm:w-auto">
                            <div class="circle-progress-container">
                                <svg class="circle-progress-svg" viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" class="circle-bg"></circle>
                                    <circle id="minutes-circle" cx="60" cy="60" r="54" class="circle-progress" style="stroke-dasharray: 340; stroke-dashoffset: 340;"></circle>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <p id="total-minutes" class="text-3xl font-black">0</p>
                                    <p class="text-xs md:text-sm text-text-secondary">MINUTOS</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 w-full sm:w-auto">
                            <div class="circle-progress-container">
                                <svg class="circle-progress-svg" viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" class="circle-bg"></circle>
                                    <circle id="routines-circle" cx="60" cy="60" r="54" class="circle-progress" style="stroke-dasharray: 340; stroke-dashoffset: 340;"></circle>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <p id="total-routines" class="text-3xl font-black">0</p>
                                    <p class="text-xs md:text-sm text-text-secondary">RUTINAS</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 w-full sm:w-auto">
                            <div class="circle-progress-container">
                                <svg class="circle-progress-svg" viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" class="circle-bg"></circle>
                                    <circle id="calories-circle" cx="60" cy="60" r="54" class="circle-progress" style="stroke-dasharray: 340; stroke-dashoffset: 340;"></circle>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <p id="total-calories" class="text-3xl font-black">0</p>
                                    <p class="text-xs md:text-sm text-text-secondary">CALORÍAS</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 w-full sm:w-auto">
                            <div class="circle-progress-container">
                                <svg class="circle-progress-svg" viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" class="circle-bg"></circle>
                                    <circle id="total-workouts-circle" cx="60" cy="60" r="54" class="circle-progress" style="stroke-dasharray: 340; stroke-dashoffset: 340;"></circle>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <p id="total-workouts" class="text-3xl font-black">0</p>
                                    <p class="text-xs md:text-sm text-text-secondary">ENTRENOS</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="glassmorphism p-4 rounded-lg text-center mt-6">
                        <h3 class="text-xl font-bold text-primary mb-2">Racha de Entrenamientos</h3>
                        <p id="workout-streak" class="text-4xl font-black">0 <i class="fas fa-fire text-orange-400"></i></p>
                        <p class="text-sm text-text-secondary">Días consecutivos</p>
                    </div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-gift text-primary mr-3"></i>Recompensas
                    </h2>
                    <div id="rewards-grid" class="space-y-4"></div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-between">
                        <span data-translate-key="body_map_title">Músculos Trabajados</span>
                        <button class="info-btn text-primary text-lg" data-info="bodymap"><i class="fas fa-info-circle"></i></button>
                    </h2>
                    <div id="body-map-container" class="w-full max-w-sm mx-auto relative grid grid-cols-2 gap-4">
                    </div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-between">
                        <span data-translate-key="progress_achievements_title">Logros</span>
                        <button class="info-btn text-primary text-lg" data-info="achievements"><i class="fas fa-info-circle"></i></button>
                    </h2>
                    <div id="achievements-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4 text-center"></div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold" data-translate-key="progress_history_title">Historial de Actividad</h2>
                        <button id="analyze-history-btn" class="btn btn-primary text-sm px-3 py-1"><i class="fas fa-brain mr-2"></i>Analizar</button>
                    </div>
                    <div id="workout-history-list" class="space-y-3 max-h-64 overflow-y-auto custom-scrollbar pr-2"></div>
                </div>
            </main>
        </div>

        <div id="settings-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="settings_title">Ajustes</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-md flex-grow mx-auto space-y-6">
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="settings_notifications_title">Notificaciones</h2>
                    <div id="notifications-list" class="space-y-4"></div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold" data-translate-key="settings_alarms_title">Alarmas</h2>
                        <button id="add-alarm-btn" class="btn btn-primary p-2 rounded-lg w-10 h-10"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="alarms-list" class="space-y-3"></div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="settings_theme_title">Tema</h2>
                    <div class="flex justify-between items-center">
                        <span class="font-bold" data-translate-key="settings_theme_label">Modo Oscuro/Claro</span>
                        <label class="switch">
                            <input type="checkbox" id="theme-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="settings_language_title">Idioma</h2>
                    <div class="flex justify-between items-center">
                        <span class="font-bold" data-translate-key="settings_language_label">Seleccionar Idioma</span>
                        <select id="language-select" class="p-2 rounded-lg bg-secondary text-text-primary">
                            <option value="es">Español</option>
                        </select>
                    </div>
                </div>
            </main>
        </div>

        <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
            <div id="modal-content-wrapper" class="glassmorphism rounded-2xl w-full max-w-lg p-6 relative transform scale-95 transition-transform duration-300">
                <button id="close-modal-btn" class="absolute top-4 right-4 text-text-secondary hover:text-primary text-2xl">&times;</button>

                <div id="alarm-modal-content" class="hidden">
                    <h2 id="alarm-modal-title" class="text-2xl font-bold mb-4 text-primary">Nueva Alarma</h2>
                    <div class="space-y-4">
                        <input type="text" id="alarm-name" class="w-full p-3 rounded-lg" placeholder="Nombre (Ej: Tomar agua)">
                        <input type="time" id="alarm-time" class="w-full p-3 rounded-lg">
                        <div>
                            <p class="font-bold mb-2 text-left">Repetir</p>
                            <div id="alarm-day-selector" class="flex justify-between">
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="1">L</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="2">M</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="3">X</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="4">J</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="5">V</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="6">S</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="0">D</button>
                            </div>
                        </div>
                        <button id="save-alarm-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold">Guardar</button>
                    </div>
                </div>

                <div id="supplements-modal-content" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-primary">Asistente de Suplementos</h2>
                    <p class="text-text-secondary mb-4">Responde para obtener una recomendación de la IA:</p>
                    <div class="space-y-4">
                        <div>
                            <label for="supplement-goal" class="font-bold">¿Cuál es tu objetivo principal?</label>
                            <select id="supplement-goal" class="w-full p-3 rounded-lg mt-1">
                                <option>Ganar Músculo</option>
                                <option>Pérdida de Grasa</option>
                                <option>Rendimiento</option>
                                <option>Salud General</option>
                            </select>
                        </div>
                        <button id="get-supplement-rec-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold">Obtener Recomendación</button>
                    </div>
                </div>

                <div id="reflection-modal-content" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-primary">Shadow Tracker: Reflexión Privada</h2>
                    <div id="reflection-questions" class="space-y-3">
                    </div>
                    <button id="analyze-reflection-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold mt-6">Analizar con IA</button>
                </div>

                <div id="mobility-modal-content" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-primary">Rutinas de Movilidad</h2>
                    <p class="text-text-secondary mb-4">Pídele a la IA rutinas cortas para cualquier momento del día.</p>
                    <div class="grid grid-cols-3 gap-4">
                        <button class="mobility-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center" data-moment="morning">
                            <i class="fas fa-sun text-3xl mb-2 text-warning"></i>
                            <span class="font-bold">Mañana</span>
                        </button>
                        <button class="mobility-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center" data-moment="break">
                            <i class="fas fa-mug-hot text-3xl mb-2 text-info"></i>
                            <span class="font-bold">Descanso</span>
                        </button>
                        <button class="mobility-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center" data-moment="night">
                            <i class="fas fa-moon text-3xl mb-2 text-primary"></i>
                            <span class="font-bold">Noche</span>
                        </button>
                    </div>
                </div>

                <div id="ice-bath-modal-content" class="hidden text-center">
                    <h2 class="text-2xl font-bold mb-2 text-info">Terapia de Hielo</h2>
                    <p class="text-text-secondary mb-4">La exposición al frío puede mejorar la recuperación y aumentar la energía.</p>
                    <p class="font-bold">Prepárate...</p>
                    <div id="ice-bath-timer" class="text-7xl font-black my-2">00:30</div>
                    <button id="start-ice-bath-timer-btn" class="btn bg-info text-white w-full p-3 rounded-lg font-bold">Iniciar Timer de 30s</button>
                </div>

                <div id="intimate-wellness-modal-content" class="hidden">
                    <h2 class="text-2xl font-bold mb-2 text-danger">Bienestar Íntimo</h2>
                    <p class="text-text-secondary mb-4">Un espacio privado para registrar y entender tu energía.</p>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center bg-secondary p-3 rounded-lg">
                            <span>¿Actividad íntima hoy?</span>
                            <div class="flex gap-2">
                                <button class="intimate-btn btn btn-secondary px-4 py-1" data-answer="yes">Sí</button>
                                <button class="intimate-btn btn btn-secondary px-4 py-1 active" data-answer="no">No</button>
                            </div>
                        </div>
                        <div>
                            <label for="desire-level" class="font-bold">Nivel de deseo (1-5)</label>
                            <input type="range" id="desire-level" min="1" max="5" value="3" class="w-full mt-2">
                        </div>
                        <div id="menstrual-tracker-card" class="hidden"></div>

                        <div id="menstrual-tracker-card-new">
                            <h3 class="text-xl font-bold mb-4 flex items-center text-pink-400">
                                <i class="fas fa-venus mr-3"></i><span data-translate-key="menstrual_tracker_title">Ciclo Menstrual</span>
                            </h3>
                            <div class="date-input-group">
                                <label for="last-period-date" class="font-bold text-sm text-text-secondary">Último periodo:</label>
                                <input type="date" id="last-period-date" class="text-sm">
                            </div>
                            <div id="menstrual-cycle-display-new" class="space-y-4">
                                <div class="flex justify-around items-center">
                                    <div class="text-center">
                                        <p class="text-sm text-text-secondary">DÍA DEL CICLO</p>
                                        <p id="cycle-day" class="cycle-day-display">--</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-sm text-text-secondary">OVULACIÓN</p>
                                        <p id="ovulation-day" class="text-xl font-bold text-red-500">--</p>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <p class="text-sm text-text-secondary">VENTANA FÉRTIL</p>
                                    <p id="fertile-window" class="text-xl font-bold text-yellow-400">--</p>
                                </div>
                                <div class="text-center">
                                    <p id="cycle-phase-name" class="cycle-phase-display">--</p>
                                    <p id="cycle-phase-description" class="phase-description">Introduce la fecha de tu último periodo para iniciar el seguimiento.</p>
                                </div>
                            </div>
                        </div>

                    </div>
                    <button id="analyze-intimate-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold mt-6">Analizar Bienestar con IA</button>
                </div>

                <div id="beast-mode-modal-content" class="hidden text-center text-text-primary">
                    <h2 class="text-2xl font-bold mb-4 text-danger"><i class="fas fa-skull-crossbones mr-2"></i><span data-translate-key="beast_mode_modal_title">Modo Bestia</span></h2>
                    <p class="mb-6" data-translate-key="beast_mode_modal_desc">Esto añadirá un finisher brutal de 60 segundos de Burpees a tu entrenamiento. ¿Aceptas el desafío?</p>
                    <div class="flex justify-center gap-4">
                        <button id="cancel-beast-mode-btn" class="btn btn-secondary px-6 py-2 font-bold" data-translate-key="cancel_button">Cancelar</button>
                        <button id="confirm-beast-mode-btn" class="btn btn-danger bg-danger px-6 py-2 font-bold" data-translate-key="beast_mode_modal_confirm">¡Activar!</button>
                    </div>
                </div>
                <div id="info-modal-content" class="hidden text-text-primary">
                    <h2 id="info-modal-title" class="text-2xl font-bold mb-4 text-primary"></h2>
                    <div id="info-modal-body" class="max-h-[70vh] overflow-y-auto pr-4 custom-scrollbar"></div>
                </div>
                <div id="coach-modal-content" class="hidden text-center text-text-primary">
                    <div class="text-5xl mb-4">🐐</div>
                    <h2 class="text-2xl font-bold mb-2 text-primary" data-translate-key="coach_modal_title">Mensaje del Coach</h2>
                    <p id="coach-message" class="mb-6 text-lg"></p>
                    <button id="close-coach-modal-btn" class="btn btn-primary px-8 py-2 font-bold" data-translate-key="coach_modal_close">¡Entendido!</button>
                </div>
                <div id="oracle-modal-content" class="hidden text-center text-text-primary">
                    <div class="text-5xl mb-4">🔮</div>
                    <h2 class="text-2xl font-bold mb-2 text-primary" data-translate-key="oracle_title">Oráculo Fitness Diario</h2>
                    <p id="oracle-message" class="mb-6 text-lg italic"></p>
                    <button id="close-oracle-modal-btn" class="btn btn-primary px-8 py-2 font-bold" data-translate-key="coach_modal_close">¡Entendido!</button>
                </div>
                <div id="reward-claimed-modal-content" class="hidden text-center text-text-primary">
                    <div class="text-5xl mb-4">🎁</div>
                    <h2 class="text-2xl font-bold mb-2 text-primary" data-translate-key="reward_claimed_title">¡Recompensa Reclamada!</h2>
                    <p id="reward-claimed-message" class="mb-6 text-lg"></p>
                    <a id="reward-claimed-link" href="#" target="_blank" class="btn btn-primary px-8 py-2 font-bold mb-4 hidden">
                        <i class="fas fa-external-link-alt mr-2"></i><span data-translate-key="reward_claimed_action">Ir al Beneficio</span>
                    </a>
                    <button id="close-reward-claimed-modal-btn" class="btn btn-secondary px-8 py-2 font-bold" data-translate-key="coach_modal_close">Cerrar</button>
                </div>

                <div id="anti-stress-modal-content" class="hidden text-center text-text-primary">
                    <h2 class="text-2xl font-bold mb-4 text-primary">Modo Anti-Estrés</h2>
                    <p id="stress-instruction" class="text-lg mb-4">Concéntrate en el movimiento y el sonido para calmar tu mente.</p>
                    <canvas id="stress-visualizer-canvas"></canvas> <button id="toggle-stress-sound-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold mt-4">
                        <i class="fas fa-play mr-2"></i><span>Iniciar Sonido Calmante</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <nav id="global-nav-bar" class="w-full p-2 glassmorphism">
        <div class="grid grid-cols-6 gap-1 text-center text-xs">
            <button class="nav-btn" data-screen="dashboard-screen"><i class="fas fa-home text-2xl"></i><span data-translate-key="nav_dashboard">Inicio</span></button>
            <button class="nav-btn" data-screen="progress-screen"><i class="fas fa-trophy text-2xl"></i><span data-translate-key="nav_progress">Progreso</span></button>
            <button class="nav-btn" data-screen="data-screen"><i class="fas fa-chart-line text-2xl"></i><span data-translate-key="nav_data">Datos</span></button>
            <button class="nav-btn" data-screen="wellness-screen"><i class="fas fa-spa text-2xl"></i><span data-translate-key="nav_wellness">Bienestar</span></button>
            <button class="nav-btn" data-screen="offline-screen"><i class="fas fa-wifi text-2xl"></i><span data-translate-key="nav_offline">Offline</span></button>
            <button class="nav-btn" data-screen="settings-screen"><i class="fas fa-cog text-2xl"></i><span data-translate-key="nav_settings">Ajustes</span></button>
        </div>
    </nav>

    <div id="tooltip"></div>
    <div id="toast-container"></div>
<i class="fas fa-skull-crossbones"></i></button>
            </footer>
        </div>

        <!-- ================================================================= -->
        <!-- ================ PANTALLA: POST-ENTRENAMIENTO =================== -->
        <!-- ================================================================= -->
        <div id="post-workout-screen" class="screen fullscreen items-center justify-center text-center bg-gray-900 overflow-hidden">
            <div id="visualizer-canvas-container" class="absolute inset-0 w-full h-full">
                <canvas id="visualizer-canvas" class="w-full h-full"></canvas>
            </div>
            <div class="relative z-10 p-4">
                <h1 id="visualizer-title" class="text-3xl font-bold text-white mb-4"></h1>
                <p id="visualizer-message" class="text-xl text-gray-300"></p>
                <button id="exit-visualizer-btn" class="btn btn-primary mt-8 px-8 py-3 rounded-lg font-bold">
                    <i class="fas fa-check-circle mr-2"></i><span>Terminar</span>
                </button>
            </div>
        </div>

        <!-- ================================================================= -->
        <!-- ===================== PANTALLA: MODO OFFLINE ==================== -->
        <!-- ================================================================= -->
        <div id="offline-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="offline_title">Modo Offline</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl flex-grow mx-auto space-y-6">
                <!-- Crear Rutina Personalizada -->
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="create_own_title">Crea tu Propia Rutina</h2>
                    <p class="text-text-secondary mb-4" data-translate-key="create_own_desc">Diseña tu entrenamiento perfecto y guárdalo para acceder sin conexión.</p>
                    <div class="space-y-4">
                        <input type="text" id="new-routine-name" class="w-full p-3 rounded-lg" placeholder="Nombre de la rutina (ej: Lunes de Pecho)">
                        <textarea id="new-routine-exercises" class="w-full h-32 p-3 rounded-lg" placeholder="Ejercicios y series (ej: 4x12 Press Banca, 3x15 Aperturas, 4x10 Flexiones)"></textarea>
                        <button id="save-custom-routine-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold"><i class="fas fa-save mr-2"></i> Guardar Rutina</button>
                    </div>
                </div>
                <!-- Lista de Rutinas Offline -->
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="offline_desc">Rutinas sin Conexión</h2>
                    <p class="text-text-secondary mb-4" data-translate-key="offline_info">Accede a una biblioteca de entrenamientos precargados, perfectos para cuando no tienes internet.</p>
                    <div id="offline-routines-list" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                        <!-- Contenido generado por JS -->
                    </div>
                </div>
            </main>
        </div>

        <!-- ================================================================= -->
        <!-- ======================= PANTALLA: DATOS ========================= -->
        <!-- ================================================================= -->
        <div id="data-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                 <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="data_title">Mis Datos</h1>
                <div class="w-24"></div>
            </header>
            <!-- Tarjeta de Datos Mejorada -->
            <main class="w-full max-w-lg space-y-6">
                <div class="glassmorphism p-6 rounded-2xl space-y-6">
                    <!-- Datos Físicos -->
                    <div>
                        <h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-weight-scale text-primary mr-3"></i>Datos Físicos</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="input-weight" class="font-bold text-sm" data-translate-key="data_weight">Peso (kg)</label>
                                <input id="input-weight" type="number" class="w-full mt-1 p-3 rounded-lg" placeholder="75.5">
                            </div>
                            <div>
                                <label for="input-height" class="font-bold text-sm" data-translate-key="data_height">Altura (cm)</label>
                                <input id="input-height" type="number" class="w-full mt-1 p-3 rounded-lg" placeholder="170">
                            </div>
                             <div>
                                <label for="input-sleep" class="font-bold text-sm" data-translate-key="data_sleep_hours">Horas de Sueño</label>
                                <input id="input-sleep" type="number" class="w-full mt-1 p-3 rounded-lg" placeholder="7.5">
                            </div>
                             <div>
                                <label for="input-water" class="font-bold text-sm" data-translate-key="data_water_liters">Agua (litros)</label>
                                <input id="input-water" type="number" class="w-full mt-1 p-3 rounded-lg" placeholder="2.5">
                            </div>
                        </div>
                         <div class="mt-4">
                            <label for="input-bmi" class="font-bold text-sm" data-translate-key="data_bmi">IMC</label>
                            <input id="input-bmi" type="text" class="w-full mt-1 p-3 rounded-lg" placeholder="Calculado automáticamente" readonly>
                        </div>
                    </div>
                    <!-- Medidas Corporales -->
                    <div>
                        <h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-ruler-combined text-primary mr-3"></i>Medidas Corporales</h3>
                        <input id="input-measures" type="text" class="w-full mt-1 p-3 rounded-lg" placeholder="cintura:75, bíceps:35">
                    </div>
                    <!-- Estado de Ánimo -->
                    <div>
                        <h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-smile text-primary mr-3"></i>Estado de Ánimo</h3>
                        <div id="energy-tracker" class="flex justify-around mt-2">
                            <!-- Iconos de mood generados por JS -->
                        </div>
                    </div>
                </div>
                <!-- Botones de Acción -->
                <div class="space-y-4">
                    <button id="save-data-btn" class="btn btn-primary w-full p-4 rounded-lg font-bold text-lg"><i class="fas fa-save mr-2"></i><span data-translate-key="data_save_button">Guardar Datos de Hoy</span></button>
                    <button id="analyze-data-btn" class="btn btn-secondary w-full p-4 rounded-lg font-bold text-lg"><i class="fas fa-brain mr-2"></i><span data-translate-key="data_analyze_button">Analizar Mis Datos con IA</span></button>
                </div>
            </main>
        </div>
        
        <!-- ================================================================= -->
        <!-- ======================= PANTALLA: SUEÑO ========================= -->
        <!-- ================================================================= -->
        <div id="sleep-screen" class="screen fullscreen items-center justify-center text-center bg-gray-900">
            <div class="absolute top-4 right-4">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-times"></i></button>
            </div>
            <div id="sleep-main-content">
                <div class="relative flex items-center justify-center w-64 h-64">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div id="sleep-clock" class="text-6xl font-black"></div>
                    </div>
                    <!-- Círculos de animación de respiración -->
                    <div class="breathing-circle-anim absolute w-full h-full bg-blue-500/30 rounded-full"></div>
                    <div class="breathing-circle-anim absolute w-3/4 h-3/4 bg-blue-500/40 rounded-full" style="animation-delay: -2s;"></div>
                    <div class="breathing-circle-anim absolute w-1/2 h-1/2 bg-blue-500/50 rounded-full" style="animation-delay: -4s;"></div>
                </div>
                <h1 class="text-3xl font-bold text-white mt-8" data-translate-key="sleep_title">Módulo de Sueño</h1>
                <p class="text-gray-300 mt-2" data-translate-key="sleep_desc">Relájate y prepárate para un descanso profundo.</p>
                <div class="mt-8 space-y-4 w-full max-w-xs">
                    <div class="flex justify-center gap-4">
                        <button class="sleep-sound-btn btn btn-secondary p-4 rounded-lg" data-sound="brown" title="Ruido Marrón"><i class="fas fa-wind text-2xl"></i></button>
                        <button class="sleep-sound-btn btn btn-secondary p-4 rounded-lg" data-sound="rain" title="Lluvia"><i class="fas fa-cloud-rain text-2xl"></i></button>
                        <button class="sleep-sound-btn btn btn-secondary p-4 rounded-lg" data-sound="forest" title="Bosque"><i class="fas fa-tree text-2xl"></i></button>
                    </div>
                    <div class="relative">
                        <input type="range" id="sleep-timer-slider" min="0" max="120" value="0" class="w-full">
                        <div id="sleep-timer-active-indicator" class="timer-active-indicator hidden"></div>
                    </div>
                    <p class="text-white"><span data-translate-key="sleep_timer_label">Timer</span>: <span id="sleep-timer-value">Off</span></p>
                    <button id="toggle-sleep-sound-btn" class="btn btn-primary w-full p-4 rounded-full font-bold">
                        <i class="fas fa-play mr-2"></i><span data-translate-key="sleep_start_button">Iniciar Sonido</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ================================================================= -->
        <!-- ===================== PANTALLA: BIENESTAR ======================= -->
        <!-- ================================================================= -->
        <div id="wellness-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="wellness_title">Centro de Bienestar</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl flex-grow mx-auto">
                 <div class="grid grid-cols-3 gap-4 md:gap-6">
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="breathing">
                        <i class="fas fa-lungs text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Respiración</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="mobility">
                        <i class="fas fa-person-walking text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Movilidad</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="reflection">
                        <i class="fas fa-lightbulb text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Reflexión</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="stress">
                        <i class="fas fa-brain text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Anti-Estrés</span>
                    </button>
                     <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="ice">
                        <i class="fas fa-snowflake text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Terapia Hielo</span>
                    </button>
                    <!-- Bienestar Íntimo (Incluye Ciclo Menstrual) -->
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="intimate">
                        <i class="fas fa-heart-pulse text-4xl mb-2"></i><span class="font-semibold text-center text-sm">B. Íntimo</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="supplements">
                        <i class="fas fa-pills text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Suplementos</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="sleep">
                        <i class="fas fa-moon text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Sueño</span>
                    </button>
                </div>
            </main>
        </div>
        
        <!-- ================================================================= -->
        <!-- =================== PANTALLA: RESPIRACIÓN ======================= -->
        <!-- ================================================================= -->
        <div id="breathing-screen" class="screen fullscreen items-center justify-center text-center">
             <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto absolute top-0 left-1/2 -translate-x-1/2">
                <button class="back-to-wellness-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="wellness_breathing_title">Respiración Guiada</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-md flex flex-col items-center justify-center text-center">
                <div id="breathing-circle" class="relative w-64 h-64 mx-auto my-4 flex items-center justify-center">
                    <svg class="absolute w-full h-full" viewBox="0 0 100 100">
                        <circle id="breathing-visual-circle" stroke-width="5" stroke-linecap="round" stroke="var(--info)" fill="transparent" r="45" cx="50" cy="50" style="transform: scale(0.8); transform-origin: 50% 50%;"></circle>
                    </svg>
                    <i id="breathing-icon" class="fas fa-lungs text-6xl text-white z-10"></i>
                </div>
                <p id="breathing-instruction" class="text-2xl font-bold h-10"></p>
                <div class="flex justify-center gap-4 mt-8">
                    <button id="start-calm-breathing-btn" data-type="calm" class="btn btn-primary px-6 py-3"><i class="fas fa-play mr-2"></i><span data-translate-key="wellness_breathing_calm">Calma 4-7-8</span></button>
                    <button id="start-power-breathing-btn" data-type="power" class="btn btn-secondary px-6 py-3"><i class="fas fa-bolt mr-2"></i><span data-translate-key="wellness_breathing_power">Poder</span></button>
                    <button id="start-relax-breathing-btn" data-type="relax" class="btn btn-secondary px-6 py-3"><i class="fas fa-leaf mr-2"></i><span data-translate-key="wellness_breathing_relax">Relajación</span></button>
                </div>
            </main>
        </div>

        <!-- ================================================================= -->
        <!-- ===================== PANTALLA: PROGRESO ======================== -->
        <!-- ================================================================= -->
        <div id="progress-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="progress_title">Mi Progreso</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl flex-grow mx-auto space-y-8">
                <!-- Actividad Semanal (Círculos Compactos) -->
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-between">
                        <span data-translate-key="progress_weekly_title">Actividad Semanal</span>
                        <button class="info-btn text-primary text-lg" data-info="weekly"><i class="fas fa-info-circle"></i></button>
                    </h2>
                    <!-- Grid para vista móvil y flex para desktop -->
                    <div id="weekly-chart" class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                        <!-- Minutos -->
                        <div class="w-full">
                            <div class="circle-progress-container">
                                <svg class="circle-progress-svg" viewBox="0 0 120 120"><circle cx="60" cy="60" r="54" class="circle-bg"></circle><circle id="minutes-circle" cx="60" cy="60" r="54" class="circle-progress" style="stroke-dasharray: 340; stroke-dashoffset: 340;"></circle></svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center"><p id="total-minutes" class="text-2xl md:text-3xl font-black">0</p><p class="text-xs text-text-secondary">MINUTOS</p></div>
                            </div>
                        </div>
                        <!-- Rutinas -->
                        <div class="w-full">
                            <div class="circle-progress-container">
                                <svg class="circle-progress-svg" viewBox="0 0 120 120"><circle cx="60" cy="60" r="54" class="circle-bg"></circle><circle id="routines-circle" cx="60" cy="60" r="54" class="circle-progress" style="stroke-dasharray: 340; stroke-dashoffset: 340;"></circle></svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center"><p id="total-routines" class="text-2xl md:text-3xl font-black">0</p><p class="text-xs text-text-secondary">RUTINAS</p></div>
                            </div>
                        </div>
                        <!-- Calorías -->
                        <div class="w-full">
                            <div class="circle-progress-container">
                                <svg class="circle-progress-svg" viewBox="0 0 120 120"><circle cx="60" cy="60" r="54" class="circle-bg"></circle><circle id="calories-circle" cx="60" cy="60" r="54" class="circle-progress" style="stroke-dasharray: 340; stroke-dashoffset: 340;"></circle></svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center"><p id="total-calories" class="text-2xl md:text-3xl font-black">0</p><p class="text-xs text-text-secondary">CALORÍAS</p></div>
                            </div>
                        </div>
                        <!-- Entrenamientos -->
                        <div class="w-full">
                            <div class="circle-progress-container">
                                <svg class="circle-progress-svg" viewBox="0 0 120 120"><circle cx="60" cy="60" r="54" class="circle-bg"></circle><circle id="total-workouts-circle" cx="60" cy="60" r="54" class="circle-progress" style="stroke-dasharray: 340; stroke-dashoffset: 340;"></circle></svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center"><p id="total-workouts" class="text-2xl md:text-3xl font-black">0</p><p class="text-xs text-text-secondary">ENTRENOS</p></div>
                            </div>
                        </div>
                    </div>
                    <!-- Racha de Entrenamientos -->
                    <div class="glassmorphism p-4 rounded-lg text-center mt-6">
                        <h3 class="text-xl font-bold text-primary mb-2">Racha de Entrenamientos</h3>
                        <p id="workout-streak" class="text-4xl font-black">0 <i class="fas fa-fire text-orange-400"></i></p>
                        <p class="text-sm text-text-secondary">Días consecutivos</p>
                    </div>
                </div>
                <!-- Recompensas -->
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-gift text-primary mr-3"></i>Recompensas</h2>
                    <div id="rewards-grid" class="space-y-4"></div>
                </div>
                <!-- Mapa Corporal (Ajustado para mejor visualización) -->
                <div class="glassmorphism p-6 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-between">
                        <span data-translate-key="body_map_title">Músculos Trabajados</span>
                        <button class="info-btn text-primary text-lg" data-info="bodymap"><i class="fas fa-info-circle"></i></button>
                    </h2>
                    <div id="body-map-container" class="w-full max-w-xs sm:max-w-sm mx-auto relative grid grid-cols-2 gap-2">
                        <!-- SVGs del cuerpo generados por JS -->
                    </div>
                </div>
                <!-- Logros -->
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-between">
                        <span data-translate-key="progress_achievements_title">Logros</span>
                        <button class="info-btn text-primary text-lg" data-info="achievements"><i class="fas fa-info-circle"></i></button>
                    </h2>
                    <div id="achievements-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4 text-center"></div>
                </div>
                <!-- Historial de Actividad -->
                <div class="glassmorphism p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold" data-translate-key="progress_history_title">Historial de Actividad</h2>
                        <button id="analyze-history-btn" class="btn btn-primary text-sm px-3 py-1"><i class="fas fa-brain mr-2"></i>Analizar</button>
                    </div>
                    <div id="workout-history-list" class="space-y-3 max-h-64 overflow-y-auto custom-scrollbar pr-2"></div>
                </div>
            </main>
        </div>

        <!-- ================================================================= -->
        <!-- ======================= PANTALLA: AJUSTES ======================= -->
        <!-- ================================================================= -->
        <div id="settings-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="settings_title">Ajustes</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-md flex-grow mx-auto space-y-6">
                <!-- Notificaciones -->
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="settings_notifications_title">Notificaciones</h2>
                    <div id="notifications-list" class="space-y-4"></div>
                </div>
                <!-- Alarmas -->
                <div class="glassmorphism p-6 rounded-2xl">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold" data-translate-key="settings_alarms_title">Alarmas</h2>
                        <button id="add-alarm-btn" class="btn btn-primary p-2 rounded-lg w-10 h-10"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="alarms-list" class="space-y-3"></div>
                </div>
                <!-- Tema -->
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="settings_theme_title">Tema</h2>
                    <div class="flex justify-between items-center">
                        <span class="font-bold" data-translate-key="settings_theme_label">Modo Oscuro/Claro</span>
                        <label class="switch">
                            <input type="checkbox" id="theme-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <!-- Idioma -->
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="settings_language_title">Idioma</h2>
                    <div class="flex justify-between items-center">
                        <span class="font-bold" data-translate-key="settings_language_label">Seleccionar Idioma</span>
                        <select id="language-select" class="p-2 rounded-lg bg-secondary text-text-primary">
                            <option value="es">Español</option>
                            </select>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- ================================================================= -->
        <!-- ======================= MODALES GLOBALES ======================== -->
        <!-- ================================================================= -->
        <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
            <div id="modal-content-wrapper" class="glassmorphism rounded-2xl w-full max-w-lg p-6 relative transform scale-95 transition-transform duration-300 max-h-[90vh] overflow-y-auto custom-scrollbar">
                <button id="close-modal-btn" class="absolute top-4 right-4 text-text-secondary hover:text-primary text-2xl z-10">&times;</button>
                
                <!-- Contenido del Modal de Alarma -->
                <div id="alarm-modal-content" class="hidden">
                    <h2 id="alarm-modal-title" class="text-2xl font-bold mb-4 text-primary">Nueva Alarma</h2>
                    <div class="space-y-4">
                        <input type="text" id="alarm-name" class="w-full p-3 rounded-lg" placeholder="Nombre (Ej: Tomar agua)">
                        <input type="time" id="alarm-time" class="w-full p-3 rounded-lg">
                        <div>
                            <p class="font-bold mb-2 text-left">Repetir</p>
                            <div id="alarm-day-selector" class="flex justify-between">
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="1">L</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="2">M</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="3">X</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="4">J</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="5">V</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="6">S</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="0">D</button>
                            </div>
                        </div>
                        <button id="save-alarm-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold">Guardar</button>
                    </div>
                </div>
                
                <!-- Contenido del Modal de Suplementos -->
                <div id="supplements-modal-content" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-primary">Asistente de Suplementos</h2>
                    <p class="text-text-secondary mb-4">Responde para obtener una recomendación de la IA:</p>
                    <div class="space-y-4">
                        <div>
                            <label for="supplement-goal" class="font-bold">¿Cuál es tu objetivo principal?</label>
                            <select id="supplement-goal" class="w-full p-3 rounded-lg mt-1">
                                <option>Ganar Músculo</option>
                                <option>Pérdida de Grasa</option>
                                <option>Rendimiento</option>
                                <option>Salud General</option>
                            </select>
                        </div>
                        <button id="get-supplement-rec-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold">Obtener Recomendación</button>
                    </div>
                </div>

                <!-- Contenido del Modal de Reflexión -->
                <div id="reflection-modal-content" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-primary">Shadow Tracker: Reflexión Privada</h2>
                    <div id="reflection-questions" class="space-y-3"></div>
                    <button id="analyze-reflection-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold mt-6">Analizar con IA</button>
                </div>

                <!-- Contenido del Modal de Movilidad -->
                <div id="mobility-modal-content" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-primary">Rutinas de Movilidad</h2>
                    <p class="text-text-secondary mb-4">Pídele a la IA rutinas cortas para cualquier momento del día.</p>
                    <div class="grid grid-cols-3 gap-4">
                        <button class="mobility-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center" data-moment="morning"><i class="fas fa-sun text-3xl mb-2 text-warning"></i><span class="font-bold">Mañana</span></button>
                        <button class="mobility-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center" data-moment="break"><i class="fas fa-mug-hot text-3xl mb-2 text-info"></i><span class="font-bold">Descanso</span></button>
                        <button class="mobility-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center" data-moment="night"><i class="fas fa-moon text-3xl mb-2 text-primary"></i><span class="font-bold">Noche</span></button>
                    </div>
                </div>

                <!-- Contenido del Modal de Terapia de Hielo -->
                <div id="ice-bath-modal-content" class="hidden text-center">
                    <h2 class="text-2xl font-bold mb-2 text-info">Terapia de Hielo</h2>
                    <p class="text-text-secondary mb-4">La exposición al frío puede mejorar la recuperación y aumentar la energía.</p>
                    <p class="font-bold">Prepárate...</p>
                    <div id="ice-bath-timer" class="text-7xl font-black my-2">00:30</div>
                    <button id="start-ice-bath-timer-btn" class="btn bg-info text-white w-full p-3 rounded-lg font-bold">Iniciar Timer de 30s</button>
                </div>

                <!-- Contenido del Modal de Bienestar Íntimo -->
                <div id="intimate-wellness-modal-content" class="hidden">
                    <h2 class="text-2xl font-bold mb-2 text-danger">Bienestar Íntimo</h2>
                    <p class="text-text-secondary mb-4">Un espacio privado para registrar y entender tu energía.</p>
                    <div class="space-y-6">
                        <div class="flex justify-between items-center bg-secondary p-3 rounded-lg">
                            <span>¿Actividad íntima hoy?</span>
                             <div class="flex gap-2">
                                <button class="intimate-btn btn btn-secondary px-4 py-1" data-answer="yes">Sí</button>
                                <button class="intimate-btn btn btn-secondary px-4 py-1 active" data-answer="no">No</button>
                            </div>
                        </div>
                        <div>
                            <label for="desire-level" class="font-bold">Nivel de deseo (1-5)</label>
                            <input type="range" id="desire-level" min="1" max="5" value="3" class="w-full mt-2">
                        </div>
                        <!-- Tarjeta de Ciclo Menstrual Mejorada -->
                        <div id="menstrual-tracker-card-new">
                            <h3 class="text-xl font-bold mb-4 flex items-center text-pink-400"><i class="fas fa-venus mr-3"></i><span data-translate-key="menstrual_tracker_title">Ciclo Menstrual</span></h3>
                            <div class="date-input-group">
                                <label for="last-period-date" class="font-bold text-sm text-text-secondary">Último periodo:</label>
                                <input type="date" id="last-period-date" class="text-sm">
                            </div>
                            <div id="menstrual-cycle-display-new" class="mt-4"></div>
                        </div>
                    </div>
                    <button id="analyze-intimate-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold mt-6">Analizar Bienestar con IA</button>
                </div>

                <!-- Contenido del Modal de Modo Bestia -->
                <div id="beast-mode-modal-content" class="hidden text-center text-text-primary">
                    <h2 class="text-2xl font-bold mb-4 text-danger"><i class="fas fa-skull-crossbones mr-2"></i><span data-translate-key="beast_mode_modal_title">Modo Bestia</span></h2>
                    <p class="mb-6" data-translate-key="beast_mode_modal_desc">Esto añadirá un finisher brutal de 60 segundos de Burpees a tu entrenamiento. ¿Aceptas el desafío?</p>
                    <div class="flex justify-center gap-4">
                        <button id="cancel-beast-mode-btn" class="btn btn-secondary px-6 py-2 font-bold" data-translate-key="cancel_button">Cancelar</button>
                        <button id="confirm-beast-mode-btn" class="btn btn-danger bg-danger px-6 py-2 font-bold" data-translate-key="beast_mode_modal_confirm">¡Activar!</button>
                    </div>
                </div>
                <!-- Contenido del Modal de Información General -->
                <div id="info-modal-content" class="hidden text-text-primary">
                    <h2 id="info-modal-title" class="text-2xl font-bold mb-4 text-primary"></h2>
                    <div id="info-modal-body"></div>
                </div>
                <!-- Contenido del Modal del Coach -->
                <div id="coach-modal-content" class="hidden text-center text-text-primary">
                    <div class="text-5xl mb-4">🐐</div>
                    <h2 class="text-2xl font-bold mb-2 text-primary" data-translate-key="coach_modal_title">Mensaje del Coach</h2>
                    <p id="coach-message" class="mb-6 text-lg"></p>
                    <button id="close-coach-modal-btn" class="btn btn-primary px-8 py-2 font-bold" data-translate-key="coach_modal_close">¡Entendido!</button>
                </div>
                <!-- Contenido del Modal del Oráculo -->
                <div id="oracle-modal-content" class="hidden text-center text-text-primary">
                    <div class="text-5xl mb-4">🔮</div>
                    <h2 class="text-2xl font-bold mb-2 text-primary" data-translate-key="oracle_title">Oráculo Fitness Diario</h2>
                    <p id="oracle-message" class="mb-6 text-lg italic"></p>
                    <button id="close-oracle-modal-btn" class="btn btn-primary px-8 py-2 font-bold" data-translate-key="coach_modal_close">¡Entendido!</button>
                </div>
                <!-- Contenido del Modal de Recompensa Reclamada -->
                <div id="reward-claimed-modal-content" class="hidden text-center text-text-primary">
                    <div class="text-5xl mb-4">🎁</div>
                    <h2 class="text-2xl font-bold mb-2 text-primary" data-translate-key="reward_claimed_title">¡Recompensa Reclamada!</h2>
                    <p id="reward-claimed-message" class="mb-6 text-lg"></p>
                    <a id="reward-claimed-link" href="#" target="_blank" class="btn btn-primary px-8 py-2 font-bold mb-4 hidden"><i class="fas fa-external-link-alt mr-2"></i><span data-translate-key="reward_claimed_action">Ir al Beneficio</span></a>
                    <button id="close-reward-claimed-modal-btn" class="btn btn-secondary px-8 py-2 font-bold" data-translate-key="coach_modal_close">Cerrar</button>
                </div>
                <!-- Contenido del Modal Anti-Estrés -->
                <div id="anti-stress-modal-content" class="hidden text-center text-text-primary">
                    <h2 class="text-2xl font-bold mb-4 text-primary">Modo Anti-Estrés</h2>
                    <p id="stress-instruction" class="text-lg mb-4">Concéntrate en el movimiento y el sonido para calmar tu mente.</p>
                    <canvas id="stress-visualizer-canvas"></canvas> <button id="toggle-stress-sound-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold mt-4"><i class="fas fa-play mr-2"></i><span>Iniciar Sonido Calmante</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================= -->
    <!-- ================= NAVEGACIÓN GLOBAL INFERIOR ==================== -->
    <!-- ================================================================= -->
    <nav id="global-nav-bar" class="w-full p-2">
        <div class="grid grid-cols-6 gap-1 text-center text-xs">
            <button class="nav-btn" data-screen="dashboard-screen"><i class="fas fa-home text-2xl"></i><span data-translate-key="nav_dashboard">Inicio</span></button>
            <button class="nav-btn" data-screen="progress-screen"><i class="fas fa-trophy text-2xl"></i><span data-translate-key="nav_progress">Progreso</span></button>
            <button class="nav-btn" data-screen="data-screen"><i class="fas fa-chart-line text-2xl"></i><span data-translate-key="nav_data">Datos</span></button>
            <button class="nav-btn" data-screen="wellness-screen"><i class="fas fa-spa text-2xl"></i><span data-translate-key="nav_wellness">Bienestar</span></button>
            <button class="nav-btn" data-screen="offline-screen"><i class="fas fa-wifi text-2xl"></i><span data-translate-key="nav_offline">Offline</span></button>
            <button class="nav-btn" data-screen="settings-screen"><i class="fas fa-cog text-2xl"></i><span data-translate-key="nav_settings">Ajustes</span></button>
        </div>
    </nav>
    
    <!-- Elementos para Tooltip y Toasts -->
    <div id="tooltip"></div>
    <div id="toast-container"></div>

    <!-- START OF SCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DICCIONARIO PARA TRADUCCIONES (i18n) ---
            const translations = {
                es: {
                    // Navegación
                    nav_dashboard: "Inicio",
                    nav_progress: "Progreso",
                    nav_data: "Datos",
                    nav_wellness: "Bienestar",
                    nav_offline: "Offline",
                    nav_settings: "Ajustes",
                    back_button: "Volver",
                    exit_button: "Salir",
                    cancel_button: "Cancelar",

                    // Pantalla Principal
                    main_title: "goati<span class='text-primary'>FIT</span>",
                    subtitle: "Tu Entrenador de Élite con IA",
                    mission_title: "Tu Misión de Hoy",
                    mission_placeholder: "Usa el Laboratorio de Entrenamiento o pide una rutina a la IA para empezar.",
                    ia_prompt_title: "Pide tu Rutina a la IA",
                    ia_prompt_placeholder: "Ej: 'Quiero una rutina de 45 mins en el gimnasio para espalda y bíceps'",
                    ia_prompt_button: "Crear con IA",
                    ai_modifier_no_equipment: "Sin Equipo",
                    lab_title: "Laboratorio de Entrenamiento",
                    lab_description: "Elige un modo de entrenamiento o un desafío específico.",
                    lab_button: "Ir al Laboratorio",
                    
                    // Laboratorio y Entrenamientos Guardados
                    tools_title: "Herramientas de Precisión",
                    tool_stopwatch: "Cronómetro",
                    tool_timer: "Temporizador",
                    tool_tabata: "Tábata",
                    tool_rounds: "Rondas",
                    saved_workouts_title: "Entrenamientos Guardados",
                    
                    // Ejecución de Entrenamiento
                    how_to_title: "Cómo Hacerlo",
                    beast_mode_button_title: "Modo Bestia: Añade un finisher intenso",
                    beast_mode_activated_alert: "¡MODO BESTIA ACTIVADO! Se ha añadido un finisher brutal.",
                    beast_mode_modal_title: "Modo Bestia",
                    beast_mode_modal_desc: "Esto añadirá un finisher brutal de 60 segundos de Burpees a tu entrenamiento. ¿Aceptas el desafío?",
                    beast_mode_modal_confirm: "¡Activar!",
                    next_exercise_prefix: "Siguiente",
                    last_exercise_text: "¡Último ejercicio!",
                    workout_complete_title: "¡Completado!",
                    workout_complete_subtitle: "¡Excelente Trabajo!",
                    post_workout_title_calm: "Buen trabajo. Hoy tu cuerpo agradece la calma.",
                    post_workout_title_hard: "Has dado todo. La fuerza de hoy es el hábito de mañana.",
                    phase_prep: "PREPÁRATE",
                    phase_work: "TRABAJO",
                    phase_rest: "DESCANSO",
                    phase_cooldown: "ENFRIAMIENTO",
                    
                    // IA y Prompts
                    generating_routine: "Generando tu rutina de élite...",
                    system_prompt_base: `Eres "GoatiFit AI", un entrenador personal de élite. Crea una rutina de ejercicios en JSON. NUNCA respondas con texto conversacional, solo el JSON. Para cada fase de 'work', incluye un array "howTo" con 2-4 instrucciones cortas, paso a paso, en español. Si el usuario pide "sin equipo", asegúrate de que todos los ejercicios sean de peso corporal. Si el usuario especifica equipo, usa ese equipo. Si el usuario no especifica equipo, asume que tiene acceso a un gimnasio básico. Formato JSON requerido:`,
                    history_analysis_prompt: "Analiza mi historial de entrenamiento de las últimas 2 semanas y dame 3 consejos. Enfócate en consistencia, grupos musculares trabajados (¿hay desbalances?) y sugiere cómo podría mejorar. Sé directo y motivador. Mi historial (fecha, título, duración en min, músculos):",
                    
                    // Datos y Bienestar
                    data_title: "Mis Datos",
                    data_weight: "Peso (kg)",
                    data_height: "Altura (cm)",
                    data_bmi: "IMC",
                    data_sleep_hours: "Horas de Sueño",
                    data_water_liters: "Agua (litros)",
                    data_save_button: "Guardar Datos de Hoy",
                    data_analyze_button: "Analizar Mis Datos con IA",
                    menstrual_tracker_title: "Ciclo Menstrual",
                    menstrual_phase_menstrual: "Fase Menstrual",
                    menstrual_phase_menstrual_desc: "Energía baja. Prioriza descanso y ejercicios suaves como yoga o caminatas.",
                    menstrual_phase_follicular: "Fase Folicular",
                    menstrual_phase_follicular_desc: "Energía en aumento. Buen momento para entrenamientos de fuerza y cardio intenso.",
                    menstrual_phase_ovulation: "Fase de Ovulación",
                    menstrual_phase_ovulation_desc: "Pico de energía. Ideal para entrenamientos de alta intensidad y levantar pesado.",
                    menstrual_phase_luteal: "Fase Lútea",
                    menstrual_phase_luteal_desc: "La energía disminuye. Enfócate en cardio moderado y ejercicios de resistencia.",
                    sleep_title: "Módulo de Sueño",
                    sleep_desc: "Relájate y prepárate para un descanso profundo.",
                    sleep_start_button: "Iniciar Sonido",
                    sleep_stop_button: "Detener Sonido",
                    sleep_timer_label: "Apagar en",
                    wellness_title: "Centro de Bienestar",
                    wellness_breathing_title: "Respiración Guiada",
                    wellness_breathing_calm: "Calma 4-7-8",
                    wellness_breathing_power: "Poder",
                    wellness_breathing_relax: "Relajación",
                    wellness_breathe_in: "Inhala...",
                    wellness_breathe_hold: "Sostén...",
                    wellness_breathe_out: "Exhala...",
                    mobility_prompt_morning: "una rutina de movilidad de 5 minutos para despertar el cuerpo por la mañana",
                    mobility_prompt_break: "una rutina de estiramiento de 5 minutos para un descanso activo en la oficina",
                    mobility_prompt_night: "una rutina de estiramiento y relajación de 5 minutos para antes de dormir",
                    
                    // Progreso
                    progress_title: "Mi Progreso",
                    progress_weekly_title: "Actividad Semanal",
                    body_map_title: "Músculos Trabajados",
                    progress_achievements_title: "Logros",
                    progress_history_title: "Historial de Actividad",
                    achievement_first_workout_name: "Primer Paso",
                    achievement_first_workout_desc: "Completa tu primer entrenamiento.",
                    achievement_seven_day_streak_name: "Imparable",
                    achievement_seven_day_streak_desc: "Entrena 7 días seguidos.",
                    achievement_beast_mode_name: "Modo Bestia",
                    achievement_beast_mode_desc: "Activa y completa un finisher Modo Bestia.",
                    achievement_perfect_week_name: "Semana Perfecta",
                    achievement_perfect_week_desc: "Completa 5 o más entrenamientos en una semana.",
                    info_weekly_title: "Tu Actividad Semanal",
                    info_weekly_desc: "Este gráfico muestra tus métricas clave de la semana actual. ¡Intenta mantener la constancia para ver cómo crecen los círculos!",
                    info_achievements_title: "Tus Logros",
                    info_achievements_desc: "Estos son los hitos que has desbloqueado. Los logros en color están completados, mientras que los grises son tu próximo objetivo. ¡A por ellos!",
                    info_bodymap_title: "Mapa Corporal de Músculos",
                    info_bodymap_desc: "Este mapa te muestra qué grupos musculares has trabajado. El color más intenso indica un mayor volumen de trabajo. ¡Pasa el ratón o toca para ver el nombre del músculo!",
                    
                    // Ajustes
                    settings_title: "Ajustes",
                    settings_notifications_title: "Notificaciones",
                    settings_alarms_title: "Alarmas",
                    settings_theme_title: "Tema",
                    settings_theme_label: "Modo Oscuro/Claro",
                    settings_language_title: "Idioma",
                    settings_language_label: "Seleccionar Idioma",
                    notification_reminder_stand: "Recordatorio para levantarse",
                    notification_reminder_water: "Recordatorio para tomar agua",
                    notification_reminder_sleep: "Recordatorio para dormir",
                    notification_reminder_train: "Recordatorio para entrenar",
                    notification_reminder_motivation: "Dosis de motivación",
                    
                    // Modales y Mensajes
                    coach_modal_title: "Mensaje del Coach",
                    coach_modal_close: "¡Entendido!",
                    coach_message_1: "¡El dolor de hoy es la fuerza de mañana! Sigue así.",
                    coach_message_2: "Recuerda, la constancia es más importante que la intensidad. ¡No te rindas!",
                    coach_message_3: "¡Has completado otro entrenamiento! Estás un paso más cerca de tu meta.",
                    coach_message_4: "Tu cuerpo puede con casi todo. Es a tu mente a la que tienes que convencer.",
                    coach_message_5: "¡Buen trabajo! No olvides hidratarte y estirar bien.",
                    oracle_title: "Oráculo Fitness Diario",
                    reward_claimed_title: "¡Recompensa Reclamada!",
                    reward_claimed_action: "Ir al Beneficio",
                    reward_near_message: "¡Estás cerca de desbloquear: ",
                    
                    // Offline
                    offline_title: "Modo Offline",
                    offline_desc: "Rutinas sin Conexión",
                    offline_info: "Accede a una biblioteca de entrenamientos precargados, perfectos para cuando no tienes internet.",
                    create_own_title: "Crea tu Propia Rutina",
                    create_own_desc: "Diseña tu entrenamiento perfecto y guárdalo para acceder sin conexión.",
                    
                    // Músculos
                    muscle_shoulders: "Hombros", muscle_chest: "Pecho", muscle_biceps: "Bíceps", muscle_triceps: "Tríceps",
                    muscle_forearms: "Antebrazos", muscle_back: "Espalda", muscle_core: "Core", muscle_glutes: "Glúteos",
                    muscle_quads: "Cuádriceps", muscle_hamstrings: "Isquiotibiales", muscle_calves: "Pantorrillas",
                    muscle_legs: "Piernas", muscle_full_body: "Cuerpo Completo", muscle_traps: "Trapecios",
                    muscle_neck: "Cuello", muscle_feet: "Pies",
                    
                    // Misiones Diarias
                    daily_mission_workout: "Completa un entrenamiento",
                    daily_mission_water: "Bebe 2 litros de agua",
                    daily_mission_sleep: "Duerme 7+ horas",
                    daily_mission_reflection: "Haz una reflexión diaria",
                    daily_mission_breathing: "Haz una sesión de respiración",
                }
            };

            // --- MAPEO DE ELEMENTOS DEL DOM ---
            const dom = {
                appContainer: document.getElementById('app-container'),
                globalNavBar: document.getElementById('global-nav-bar'),
                screens: Array.from(document.querySelectorAll('.screen')).reduce((acc, screen) => {
                    acc[screen.id] = screen;
                    return acc;
                }, {}),
                dashboard: {
                    userPrompt: document.getElementById('user-prompt'),
                    generateBtn: document.getElementById('generate-btn'),
                    workoutOfTheDay: document.getElementById('workout-of-the-day'),
                    openLabBtn: document.getElementById('open-lab-btn'),
                    pointsValue: document.getElementById('points-value'),
                    pointsDisplay: document.getElementById('points-display'),
                    dailyMissionsDisplay: document.getElementById('daily-missions-display'),
                    missionsCompleted: document.getElementById('missions-completed'),
                    missionsTotal: document.getElementById('missions-total'),
                },
                lab: {
                    timerTypeSelection: document.getElementById('timer-type-selection'),
                    savedWorkoutsList: document.getElementById('saved-workouts-list'),
                },
                timerTool: {
                    screen: document.getElementById('timer-tool-screen'),
                    title: document.getElementById('timer-tool-title'),
                    displayArea: document.getElementById('timer-tool-display-area'),
                    phase: document.getElementById('timer-tool-phase'),
                    display: document.getElementById('timer-tool-display'),
                    roundsDisplay: document.getElementById('timer-tool-rounds-display'),
                    controls: document.getElementById('timer-tool-controls'),
                    startBtn: document.getElementById('timer-tool-start'),
                    pauseBtn: document.getElementById('timer-tool-pause'),
                    resetBtn: document.getElementById('timer-tool-reset'),
                    lapBtn: document.getElementById('timer-tool-lap'),
                    lapTimesContainer: document.getElementById('lap-times-container'),
                    lapTimesList: document.getElementById('lap-times-list'),
                    configContainer: document.getElementById('timer-config-container'),
                    configTimer: document.getElementById('timer-config'),
                    configTabata: document.getElementById('tabata-config'),
                    configRounds: document.getElementById('rounds-config'),
                    roundsCounterControl: document.getElementById('rounds-counter-control'),
                    roundCounterBtn: document.getElementById('round-counter-btn'),
                    roundNextBtn: document.getElementById('round-next-btn'),
                },
                workout: {
                    title: document.getElementById('workout-title'),
                    exitBtn: document.getElementById('exit-workout-btn'),
                    timerRing: document.getElementById('workout-timer-ring'),
                    progressCircle: document.getElementById('workout-progress-circle'),
                    phaseLabel: document.getElementById('workout-phase-label'),
                    timerDisplay: document.getElementById('workout-timer-display'),
                    currentExercise: document.getElementById('current-exercise'),
                    nextExercise: document.getElementById('next-exercise'),
                    howToContainer: document.getElementById('how-to-container'),
                    howToSteps: document.getElementById('how-to-steps'),
                    prevBtn: document.getElementById('prev-btn'),
                    playPauseBtn: document.getElementById('play-pause-btn'),
                    nextBtn: document.getElementById('next-btn'),
                    beastModeBtn: document.getElementById('beast-mode-btn'),
                },
                data: {
                    inputWeight: document.getElementById('input-weight'),
                    inputHeight: document.getElementById('input-height'),
                    inputBMI: document.getElementById('input-bmi'),
                    inputMeasures: document.getElementById('input-measures'),
                    energyTracker: document.getElementById('energy-tracker'),
                    inputSleep: document.getElementById('input-sleep'),
                    inputWater: document.getElementById('input-water'),
                    saveBtn: document.getElementById('save-data-btn'),
                    analyzeDataBtn: document.getElementById('analyze-data-btn'),
                },
                sleep: {
                    toggleBtn: document.getElementById('toggle-sleep-sound-btn'),
                    soundBtns: document.querySelectorAll('.sleep-sound-btn'),
                    timerSlider: document.getElementById('sleep-timer-slider'),
                    timerValue: document.getElementById('sleep-timer-value'),
                    timerIndicator: document.getElementById('sleep-timer-active-indicator'),
                    clock: document.getElementById('sleep-clock'),
                },
                wellness: {
                    startCalmBreathingBtn: document.getElementById('start-calm-breathing-btn'),
                    startPowerBreathingBtn: document.getElementById('start-power-breathing-btn'),
                    startRelaxBreathingBtn: document.getElementById('start-relax-breathing-btn'),
                    breathingInstruction: document.getElementById('breathing-instruction'),
                    breathingVisualCircle: document.getElementById('breathing-visual-circle'),
                },
                progress: {
                    minutesValue: document.getElementById('total-minutes'),
                    routinesValue: document.getElementById('total-routines'),
                    caloriesValue: document.getElementById('total-calories'),
                    minutesCircle: document.getElementById('minutes-circle'),
                    routinesCircle: document.getElementById('routines-circle'),
                    caloriesCircle: document.getElementById('calories-circle'),
                    totalWorkoutsValue: document.getElementById('total-workouts'),
                    totalWorkoutsCircle: document.getElementById('total-workouts-circle'),
                    bodyMapContainer: document.getElementById('body-map-container'),
                    achievementsGrid: document.getElementById('achievements-grid'),
                    historyList: document.getElementById('workout-history-list'),
                    analyzeHistoryBtn: document.getElementById('analyze-history-btn'),
                    rewardsGrid: document.getElementById('rewards-grid'),
                    workoutStreak: document.getElementById('workout-streak'),
                },
                settings: {
                    notificationsList: document.getElementById('notifications-list'),
                    alarmsList: document.getElementById('alarms-list'),
                    addAlarmBtn: document.getElementById('add-alarm-btn'),
                    themeToggle: document.getElementById('theme-toggle'),
                    languageSelect: document.getElementById('language-select'),
                },
                offline: {
                    routinesList: document.getElementById('offline-routines-list'),
                    newRoutineName: document.getElementById('new-routine-name'),
                    newRoutineExercises: document.getElementById('new-routine-exercises'),
                    saveCustomRoutineBtn: document.getElementById('save-custom-routine-btn'),
                },
                modals: {
                    overlay: document.getElementById('modal-overlay'),
                    contentWrapper: document.getElementById('modal-content-wrapper'),
                    closeBtn: document.getElementById('close-modal-btn'),
                    alarmContent: document.getElementById('alarm-modal-content'),
                    alarmTitle: document.getElementById('alarm-modal-title'),
                    alarmName: document.getElementById('alarm-name'),
                    alarmTime: document.getElementById('alarm-time'),
                    alarmDaySelector: document.getElementById('alarm-day-selector'),
                    saveAlarmBtn: document.getElementById('save-alarm-btn'),
                    supplementsContent: document.getElementById('supplements-modal-content'),
                    reflectionContent: document.getElementById('reflection-modal-content'),
                    reflectionQuestions: document.getElementById('reflection-questions'),
                    mobilityContent: document.getElementById('mobility-modal-content'),
                    iceBathContent: document.getElementById('ice-bath-modal-content'),
                    iceBathTimer: document.getElementById('ice-bath-timer'),
                    startIceBathTimerBtn: document.getElementById('start-ice-bath-timer-btn'),
                    intimateWellnessContent: document.getElementById('intimate-wellness-modal-content'),
                    lastPeriodDate: document.getElementById('last-period-date'),
                    menstrualCycleDisplay: document.getElementById('menstrual-cycle-display-new'),
                    beastModeContent: document.getElementById('beast-mode-modal-content'),
                    confirmBeastModeBtn: document.getElementById('confirm-beast-mode-btn'),
                    cancelBeastModeBtn: document.getElementById('cancel-beast-mode-btn'),
                    infoContent: document.getElementById('info-modal-content'),
                    infoTitle: document.getElementById('info-modal-title'),
                    infoBody: document.getElementById('info-modal-body'),
                    coachContent: document.getElementById('coach-modal-content'),
                    coachMessage: document.getElementById('coach-message'),
                    closeCoachBtn: document.getElementById('close-coach-modal-btn'),
                    oracleContent: document.getElementById('oracle-modal-content'),
                    oracleMessage: document.getElementById('oracle-message'),
                    closeOracleBtn: document.getElementById('close-oracle-modal-btn'),
                    rewardClaimedContent: document.getElementById('reward-claimed-modal-content'),
                    rewardClaimedMessage: document.getElementById('reward-claimed-message'),
                    rewardClaimedLink: document.getElementById('reward-claimed-link'),
                    closeRewardClaimedBtn: document.getElementById('close-reward-claimed-modal-btn'),
                    antiStressContent: document.getElementById('anti-stress-modal-content'),
                    stressVisualizerCanvas: document.getElementById('stress-visualizer-canvas'),
                    toggleStressSoundBtn: document.getElementById('toggle-stress-sound-btn'),
                },
                tooltip: document.getElementById('tooltip'),
                toastContainer: document.getElementById('toast-container'),
            };

            // --- OBJETO DE ESTADO PRINCIPAL ---
            let state = {
                currentScreen: 'dashboard-screen',
                language: 'es',
                audioContext: null,
                aiWorkout: { routine: null, currentIndex: 0, currentPhase: 'idle', phaseTimeLeft: 0, isPaused: true, timerInterval: null, beastModeActivated: false },
                sleep: { soundNode: null, gainNode: null, isPlaying: false, selectedSound: 'brown', timerId: null, clockInterval: null },
                wellness: { breathingInterval: null, isBreathing: false, breathingType: 'calm', iceBathInterval: null, stressSynth: null, isStressSoundPlaying: false, stressVisualizerAnimationId: null },
                progress: { history: [], achievements: { first_workout: false, seven_day_streak: false, beast_mode: false, perfect_week: false }, points: 0, muscleGroupsWorked: {}, claimedRewards: [], workoutStreak: 0, lastWorkoutDate: null },
                userData: { weight: null, height: null, bmi: null, measures: null, energy: null, sleep: null, water: null, lastPeriodDate: null, customRoutines: [], savedWorkouts: [] },
                notifications: { stand: true, water: true, sleep: false, train: false, motivation: true },
                alarms: [],
                timerTool: { type: null, interval: null, startTime: 0, elapsedTime: 0, isRunning: false, duration: 0, tabata: { work: 20, rest: 10, rounds: 8, currentRound: 0, isWorkPhase: true, timeLeft: 0 }, rounds: { count: 0, target: 0, rest: 0, current: 1, restTimerInterval: null }, lapTimes: [] },
                editingAlarmIndex: null,
                theme: 'dark',
                dailyMissions: [],
                missionsCompletedToday: 0,
            };

            // --- LÓGICA CENTRAL DE LA APLICACIÓN ---

            /**
             * Muestra una pantalla específica y oculta las demás.
             * @param {string} screenId - El ID de la pantalla a mostrar.
             */
            function showScreen(screenId) {
                if (!dom.screens[screenId]) return;
                
                const currentScreenEl = dom.screens[state.currentScreen];
                if (currentScreenEl) currentScreenEl.classList.remove('active');
                
                state.currentScreen = screenId;
                const targetScreen = dom.screens[screenId];
                targetScreen.classList.add('active');
                
                dom.appContainer.scrollTop = 0;

                const screensWithoutGlobalNav = ['workout-screen', 'post-workout-screen', 'sleep-screen', 'breathing-screen', 'timer-tool-screen'];
                dom.globalNavBar.style.display = screensWithoutGlobalNav.includes(screenId) ? 'none' : 'block';

                document.querySelectorAll('#global-nav-bar .nav-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.screen === screenId);
                });

                // Limpieza de estados al cambiar de pantalla
                stopVisualizer();
                stopSleepSound();
                toggleBreathingExercise(true);
                stopStressSound();
                if (state.sleep.clockInterval) clearInterval(state.sleep.clockInterval);
                resetTimerTool();

                // Renderizado específico de pantalla
                if (screenId === 'progress-screen') renderProgressScreen();
                if (screenId === 'data-screen') renderDataScreen();
                if (screenId === 'settings-screen') renderSettingsScreen();
                if (screenId === 'offline-screen') renderOfflineRoutines();
                if (screenId === 'lab-screen') renderSavedWorkouts();
                if (screenId === 'sleep-screen') startSleepClock();
            }

            /**
             * Establece el idioma de la aplicación.
             * @param {string} lang - El código del idioma (ej. 'es').
             */
            function setLanguage(lang) {
                state.language = lang;
                document.documentElement.lang = lang;
                dom.settings.languageSelect.value = lang;
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    const translation = translations[lang][key];
                    if (translation) {
                        if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') el.placeholder = translation;
                        else if (el.hasAttribute('title')) el.title = translation;
                        else el.innerHTML = translation;
                    }
                });
                updateMenstrualCycleDisplay();
            }
            
            /**
             * Muestra una notificación toast.
             * @param {string} message - El mensaje a mostrar.
             * @param {string} type - El tipo de toast ('info', 'success', 'error').
             */
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                dom.toastContainer.appendChild(toast);
                setTimeout(() => { toast.remove(); }, 4000);
            }

            /**
             * Inicializa el AudioContext para sonidos.
             */
            function initAudio() {
                if (!state.audioContext) {
                    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (state.audioContext.state === 'suspended') {
                    state.audioContext.resume();
                }
            }

            /**
             * Reproduce un sonido de beep.
             * @param {number} frequency - Frecuencia en Hz.
             * @param {number} duration - Duración en ms.
             * @param {string} type - Tipo de onda ('sine', 'square', etc.).
             */
            function playBeep(frequency = 440, duration = 100, type = 'sine') {
                initAudio();
                const oscillator = state.audioContext.createOscillator();
                const gainNode = state.audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(state.audioContext.destination);
                oscillator.type = type;
                oscillator.frequency.value = frequency;
                gainNode.gain.setValueAtTime(0, state.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, state.audioContext.currentTime + 0.01);
                oscillator.start(state.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, state.audioContext.currentTime + duration / 1000);
                oscillator.stop(state.audioContext.currentTime + duration / 1000);
            }

            // --- GENERACIÓN Y MANEJO DE ENTRENAMIENTOS ---

            /**
             * Muestra un estado de carga en un botón.
             * @param {HTMLElement} btn - El botón a modificar.
             */
            function showLoadingSkeleton(btn) {
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
                }
            }

            /**
             * Restaura un botón a su estado original.
             * @param {HTMLElement} btn - El botón a restaurar.
             * @param {string} originalTextKey - La clave de traducción para el texto.
             * @param {string} originalIconClass - La clase del icono original.
             */
            function resetButton(btn, originalTextKey, originalIconClass) {
                if (btn) {
                    btn.disabled = false;
                    const textContent = translations[state.language][originalTextKey] || originalTextKey;
                    btn.innerHTML = `<i class="${originalIconClass} mr-2"></i> <span>${textContent}</span>`;
                }
            }
            
            /**
             * Simula la llamada a la IA para obtener una rutina y la inicia.
             * @param {string} promptText - El prompt del usuario.
             * @param {string} workoutType - El tipo de entrenamiento.
             * @param {HTMLElement} btnToLoad - El botón que inició la acción.
             */
            async function fetchAndStartWorkout(promptText, workoutType, btnToLoad) {
                showLoadingSkeleton(btnToLoad);
                
                const lang = state.language;
                const jsonFormat = `{"title": "Creative Name", "totalDurationMinutes": 30, "type": "${workoutType}", "phases": [{"phaseName": "Warm-up", "type": "prep", "durationSeconds": 180, "exerciseName": "Dynamic Warm-up", "howTo": ["Instruction 1", "Instruction 2"], "muscleGroups": ["full_body"]}]}`;
                const systemPrompt = `${translations[lang].system_prompt_base} ${jsonFormat}`;

                try {
                    // Simulación de llamada a API
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Mock de respuesta de la IA
                    const mockResponse = {
                        title: `Rutina AI: ${promptText.substring(0, 20)}...`,
                        totalDurationMinutes: 30,
                        type: "Custom",
                        phases: [
                            { phaseName: "Calentamiento", type: "prep", durationSeconds: 180, exerciseName: "Movilidad Articular", howTo: ["Rota tobillos, rodillas y caderas.", "Haz círculos con los brazos hacia adelante y atrás."], muscleGroups: ["full_body"] },
                            { phaseName: "Sentadillas", type: "work", durationSeconds: 180, exerciseName: "Sentadillas con Peso Corporal", sets: "3", reps: "15", howTo: ["Pies al ancho de hombros.", "Baja la cadera como si te sentaras.", "Mantén la espalda recta y el pecho erguido."], muscleGroups: ["quads", "glutes"] },
                            { phaseName: "Descanso", type: "rest", durationSeconds: 60, exerciseName: "Descanso" },
                            { phaseName: "Flexiones", type: "work", durationSeconds: 180, exerciseName: "Flexiones (de rodillas si es necesario)", sets: "3", reps: "10-12", howTo: ["Apoya rodillas y manos en el suelo.", "Baja el pecho cerca del suelo.", "Empuja hacia arriba controladamente."], muscleGroups: ["chest", "triceps", "shoulders"] },
                            { phaseName: "Descanso", type: "rest", durationSeconds: 60, exerciseName: "Descanso" },
                            { phaseName: "Plancha", type: "work", durationSeconds: 120, exerciseName: "Plancha Abdominal", sets: "3", reps: "30-45s", howTo: ["Apóyate en antebrazos y puntas de pies.", "Mantén el cuerpo recto como una tabla.", "Contrae el abdomen y los glúteos."], muscleGroups: ["core"] },
                            { phaseName: "Enfriamiento", type: "cooldown", durationSeconds: 180, exerciseName: "Estiramientos Estáticos", howTo: ["Estira cuádriceps, isquiotibiales y pecho.", "Mantén cada estiramiento por 20-30 segundos."], muscleGroups: ["full_body"] }
                        ]
                    };
                    
                    // Guardar la rutina generada por la IA
                    state.userData.savedWorkouts.push(mockResponse);
                    saveAllData();

                    state.aiWorkout.routine = mockResponse;
                    startAiWorkout();

                } catch (error) {
                    showToast("Error generando rutina: " + error.message, 'error');
                } finally {
                    resetButton(btnToLoad, btnToLoad.dataset.originalTextKey, btnToLoad.dataset.originalIconClass);
                }
            }

            /**
             * Inicia un entrenamiento basado en la rutina cargada en el estado.
             */
            function startAiWorkout() {
                if (!state.aiWorkout.routine) return;
                showScreen('workout-screen');
                Object.assign(state.aiWorkout, { currentIndex: 0, isPaused: false, beastModeActivated: false });
                dom.workout.beastModeBtn.classList.remove('beast-mode-active');
                dom.workout.title.textContent = state.aiWorkout.routine.title;
                runAiPhase(0);
                updatePlayPauseIcon();
            }

            /**
             * Ejecuta una fase específica del entrenamiento.
             * @param {number} index - El índice de la fase a ejecutar.
             */
            function runAiPhase(index) {
                if (index >= state.aiWorkout.routine.phases.length) {
                    finishAiWorkout();
                    return;
                }
                const phase = state.aiWorkout.routine.phases[index];
                state.aiWorkout.currentIndex = index;
                state.aiWorkout.currentPhase = phase.type;
                state.aiWorkout.phaseTimeLeft = phase.durationSeconds;
                updateUIForAiPhase(phase);
                if (state.aiWorkout.timerInterval) clearInterval(state.aiWorkout.timerInterval);
                state.aiWorkout.timerInterval = setInterval(updateAiTimer, 1000);
                playBeep(phase.type === 'work' ? 660 : 440, 200);
            }

            /**
             * Actualiza la interfaz de usuario para la fase actual del entrenamiento.
             * @param {object} phase - El objeto de la fase actual.
             */
            function updateUIForAiPhase(phase) {
                const lang = state.language;
                dom.workout.phaseLabel.textContent = translations[lang][`phase_${phase.type}`] || phase.phaseName;
                let exerciseText = phase.exerciseName;
                if (phase.sets && phase.reps) {
                    exerciseText += ` (${phase.sets}x${phase.reps})`;
                }
                dom.workout.currentExercise.textContent = exerciseText;

                const nextPhaseData = state.aiWorkout.routine.phases[state.aiWorkout.currentIndex + 1];
                dom.workout.nextExercise.textContent = nextPhaseData ? `${translations[lang].next_exercise_prefix}: ${nextPhaseData.exerciseName || nextPhaseData.phaseName}` : translations[lang].last_exercise_text;
                
                const phaseType = phase.type || 'prep';
                dom.workout.timerRing.className = `z-10 text-center flex flex-col items-center justify-center w-[calc(100%-40px)] h-[calc(100%-40px)] rounded-full border-8 transition-colors duration-500 bg-dark phase-border-${phaseType}`;
                dom.workout.progressCircle.className = `timer-circle-progress phase-color-${phaseType}`;

                dom.workout.howToSteps.innerHTML = '';
                if (phase.howTo && phase.howTo.length > 0) {
                    phase.howTo.forEach(step => {
                        const li = document.createElement('li');
                        li.textContent = step;
                        dom.workout.howToSteps.appendChild(li);
                    });
                    dom.workout.howToContainer.classList.remove('hidden');
                } else {
                    dom.workout.howToContainer.classList.add('hidden');
                }
            }

            /**
             * Actualiza el temporizador del entrenamiento cada segundo.
             */
            function updateAiTimer() {
                if (state.aiWorkout.isPaused) return;
                if (state.aiWorkout.phaseTimeLeft > 0) state.aiWorkout.phaseTimeLeft--;
                
                const phaseDuration = state.aiWorkout.routine.phases[state.aiWorkout.currentIndex].durationSeconds;
                const progress = phaseDuration > 0 ? (state.aiWorkout.phaseTimeLeft / phaseDuration) : 0;
                dom.workout.progressCircle.style.strokeDashoffset = 283 * (1 - progress);
                
                if (state.aiWorkout.phaseTimeLeft <= 0) {
                    nextAiPhase();
                } else if (state.aiWorkout.phaseTimeLeft <= 3 && state.aiWorkout.phaseTimeLeft > 0) {
                    playBeep(523, 150, 'square');
                }
                
                const minutes = Math.floor(state.aiWorkout.phaseTimeLeft / 60);
                const seconds = state.aiWorkout.phaseTimeLeft % 60;
                dom.workout.timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            function nextAiPhase() { runAiPhase(state.aiWorkout.currentIndex + 1); }
            function prevAiPhase() { if (state.aiWorkout.currentIndex > 0) runAiPhase(state.aiWorkout.currentIndex - 1); }
            
            /**
             * Finaliza el entrenamiento, registra la actividad y muestra la pantalla de post-entrenamiento.
             */
            function finishAiWorkout() {
                clearInterval(state.aiWorkout.timerInterval);
                playBeep(1046, 500, 'triangle');
                logActivityToHistory({
                    type: 'workout',
                    title: state.aiWorkout.routine.title,
                    duration: state.aiWorkout.routine.totalDurationMinutes,
                    beastMode: state.aiWorkout.beastModeActivated,
                    muscleGroups: [...new Set(state.aiWorkout.routine.phases.flatMap(p => p.muscleGroups || []))],
                });
                showScreen('post-workout-screen');
                const title = state.aiWorkout.routine.type === 'Movilidad' ? translations[state.language].post_workout_title_calm : translations[state.language].post_workout_title_hard;
                document.getElementById('visualizer-title').textContent = title;
                document.getElementById('visualizer-message').textContent = `¡Ganaste ${state.aiWorkout.routine.totalDurationMinutes * 5} puntos!`;
                startVisualizer();
                checkDailyMissions('workout');
            }

            function toggleAiPause() {
                state.aiWorkout.isPaused = !state.aiWorkout.isPaused;
                updatePlayPauseIcon();
            }

            function updatePlayPauseIcon() {
                dom.workout.playPauseBtn.querySelector('i').className = state.aiWorkout.isPaused ? 'fas fa-play ml-1' : 'fas fa-pause';
            }
            
            // --- Lógica de Modales ---
            
            /**
             * Muestra un modal de un tipo específico.
             * @param {string} type - El tipo de modal a mostrar.
             * @param {object} [data] - Datos opcionales para el modal.
             */
            function showModal(type, data = {}) {
                dom.modals.overlay.classList.remove('hidden');
                // Ocultar todos los contenidos de modales
                Object.values(dom.modals.contentWrapper.children).forEach(child => {
                    if (child.id && child.id.endsWith('-modal-content')) child.style.display = 'none';
                });
                
                const contentEl = dom.modals[`${type}Content`] || dom.modals.infoContent;
                if (contentEl) contentEl.style.display = 'block';

                // Configuración específica del modal
                switch(type) {
                    case 'info':
                        dom.modals.infoTitle.innerHTML = data.title || '';
                        dom.modals.infoBody.innerHTML = data.body || '';
                        break;
                    case 'coach':
                        const lang = state.language;
                        const messages = [translations[lang].coach_message_1, translations[lang].coach_message_2, translations[lang].coach_message_3, translations[lang].coach_message_4, translations[lang].coach_message_5];
                        dom.modals.coachMessage.textContent = data.message || messages[Math.floor(Math.random() * messages.length)];
                        break;
                    case 'oracle':
                        dom.modals.oracleMessage.textContent = data.message;
                        break;
                    case 'alarm':
                        state.editingAlarmIndex = data.index;
                        dom.modals.alarmTitle.textContent = data.index === null ? 'Nueva Alarma' : 'Editar Alarma';
                        dom.modals.alarmName.value = data.alarm ? data.alarm.name : '';
                        dom.modals.alarmTime.value = data.alarm ? data.alarm.time : '07:00';
                        dom.modals.alarmDaySelector.querySelectorAll('.day-btn').forEach(btn => {
                            const dayIndex = btn.dataset.day;
                            btn.classList.toggle('active', data.alarm ? data.alarm.days[dayIndex] : false);
                        });
                        break;
                    case 'reflection':
                        renderReflectionQuestions();
                        break;
                    case 'intimateWellness':
                        dom.modals.lastPeriodDate.value = state.userData.lastPeriodDate || '';
                        updateMenstrualCycleDisplay();
                        break;
                    case 'rewardClaimed':
                        dom.modals.rewardClaimedMessage.textContent = data.message;
                        if (data.link) {
                            dom.modals.rewardClaimedLink.href = data.link;
                            dom.modals.rewardClaimedLink.classList.remove('hidden');
                        } else {
                            dom.modals.rewardClaimedLink.classList.add('hidden');
                        }
                        break;
                    case 'antiStress':
                        startStressVisualizer();
                        break;
                }

                setTimeout(() => dom.modals.contentWrapper.classList.remove('scale-95'), 10);
            }

            function hideModal() {
                dom.modals.contentWrapper.classList.add('scale-95');
                setTimeout(() => dom.modals.overlay.classList.add('hidden'), 300);
                stopStressVisualizer();
                stopStressSound();
            }

            // --- MÓDULOS DE DATOS Y BIENESTAR ---

            function calculateBMI(weightKg, heightCm) {
                if (!weightKg || !heightCm) return null;
                return (weightKg / ((heightCm / 100) ** 2)).toFixed(2);
            }

            function saveAndAnalyzeData() {
                // Guardar datos
                state.userData.weight = dom.data.inputWeight.value || null;
                state.userData.height = dom.data.inputHeight.value || null;
                state.userData.bmi = calculateBMI(state.userData.weight, state.userData.height);
                state.userData.measures = dom.data.inputMeasures.value || null;
                state.userData.sleep = dom.data.inputSleep.value || null;
                state.userData.water = dom.data.inputWater.value || null;
                
                saveAllData();
                showToast("Tus datos han sido guardados.", 'success');
                renderDataScreen();

                // Comprobar misiones diarias relacionadas
                if (state.userData.water >= 2) checkDailyMissions('water');
                if (state.userData.sleep >= 7) checkDailyMissions('sleep');
                
                // Analizar con IA
                analyzeUserDataWithAI();
            }
            
            function renderDataScreen() {
                dom.data.inputWeight.value = state.userData.weight || '';
                dom.data.inputHeight.value = state.userData.height || '';
                dom.data.inputBMI.value = state.userData.bmi || '';
                dom.data.inputMeasures.value = state.userData.measures || '';
                dom.data.inputSleep.value = state.userData.sleep || '';
                dom.data.inputWater.value = state.userData.water || '';

                dom.data.energyTracker.querySelectorAll('.mood-btn').forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.value) === state.userData.energy);
                });
            }

            function updateMenstrualCycleDisplay() {
                if (!dom.modals.lastPeriodDate.value) {
                    dom.modals.menstrualCycleDisplay.innerHTML = `<p class="text-text-secondary">Registra la fecha para empezar el seguimiento.</p>`;
                    return;
                }
                const lastDate = new Date(dom.modals.lastPeriodDate.value + 'T00:00:00');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const diffDays = Math.ceil((today - lastDate) / (1000 * 60 * 60 * 24)) + 1;
                
                let phaseKey = 'menstrual_phase_menstrual';
                if (diffDays > 5 && diffDays <= 13) { phaseKey = 'menstrual_phase_follicular'; }
                else if (diffDays > 13 && diffDays <= 16) { phaseKey = 'menstrual_phase_ovulation'; }
                else if (diffDays > 16 && diffDays <= 28) { phaseKey = 'menstrual_phase_luteal'; }
                
                const phaseName = translations[state.language][phaseKey];
                const phaseDesc = translations[state.language][`${phaseKey}_desc`];

                dom.modals.menstrualCycleDisplay.innerHTML = `
                    <p class="text-sm text-text-secondary">DÍA DEL CICLO</p>
                    <div class="cycle-day-display">${diffDays}</div>
                    <div class="cycle-phase-display">${phaseName}</div>
                    <p class="phase-description">${phaseDesc}</p>
                `;
            }
            
            // --- MÓDULO DE PROGRESO ---

            function logActivityToHistory(activity) {
                const today = new Date().toISOString().split('T')[0];
                const pointsEarned = (activity.duration || 1) * 5 + (activity.beastMode ? 50 : 0);
                
                state.progress.history.unshift({ date: today, ...activity });
                state.progress.points += pointsEarned;

                if (activity.type === 'workout') {
                    activity.muscleGroups.forEach(group => {
                        state.progress.muscleGroupsWorked[group] = (state.progress.muscleGroupsWorked[group] || 0) + (activity.duration * 60);
                    });
                    
                    const lastDate = state.progress.lastWorkoutDate ? new Date(state.progress.lastWorkoutDate) : null;
                    const todayDate = new Date(today);
                    if (lastDate) {
                        const diffDays = Math.ceil((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                        state.progress.workoutStreak = (diffDays === 1) ? state.progress.workoutStreak + 1 : 1;
                    } else {
                        state.progress.workoutStreak = 1;
                    }
                    state.progress.lastWorkoutDate = today;
                }

                checkAchievements();
                checkRewards();
                saveAllData();
                updatePointsDisplay();
            }

            function updatePointsDisplay() {
                dom.dashboard.pointsValue.textContent = state.progress.points;
            }

            function checkAchievements() {
                const achievements = state.progress.achievements;
                if (!achievements.first_workout) {
                    achievements.first_workout = true;
                    showToast("¡Logro desbloqueado: Primer Paso!", 'success');
                }
                if (state.aiWorkout.beastModeActivated && !achievements.beast_mode) {
                    achievements.beast_mode = true;
                    showToast("¡Logro desbloqueado: Modo Bestia!", 'success');
                }
                if (state.progress.workoutStreak >= 7 && !achievements.seven_day_streak) {
                    achievements.seven_day_streak = true;
                    showToast("¡Logro desbloqueado: Imparable (7 días de racha)!", 'success');
                }
                // Lógica de semana perfecta
                const today = new Date();
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1)));
                startOfWeek.setHours(0,0,0,0);
                const workoutsThisWeek = state.progress.history.filter(act => act.type === 'workout' && new Date(act.date) >= startOfWeek).length;
                if (workoutsThisWeek >= 5 && !achievements.perfect_week) {
                    achievements.perfect_week = true;
                    showToast("¡Logro desbloqueado: Semana Perfecta!", 'success');
                }
            }
            
            function renderProgressScreen() {
                renderHistory();
                renderAchievements();
                renderWeeklyMetrics();
                renderBodyMap();
                renderRewards();
                dom.progress.workoutStreak.textContent = state.progress.workoutStreak;
            }

            function renderHistory() {
                dom.progress.historyList.innerHTML = state.progress.history.length === 0 
                    ? `<p class="text-text-secondary text-center">No hay actividad registrada.</p>`
                    : state.progress.history.slice(0, 20).map(activity => {
                        const iconMap = { workout: 'fa-dumbbell', breathing: 'fa-lungs', reflection: 'fa-lightbulb', ice: 'fa-snowflake' };
                        return `
                            <div class="bg-secondary p-3 rounded-lg flex justify-between items-center">
                                <div class="flex items-center gap-4">
                                    <i class="fas ${iconMap[activity.type] || 'fa-question-circle'} text-primary text-xl"></i>
                                    <div>
                                        <p class="font-bold">${activity.title}</p>
                                        <p class="text-sm text-text-secondary">${new Date(activity.date).toLocaleDateString(state.language, { day: 'numeric', month: 'long' })}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                     <p class="font-bold text-primary">${activity.duration} min</p>
                                     ${activity.beastMode ? '<i class="fas fa-skull-crossbones text-danger"></i>' : ''}
                                </div>
                            </div>`;
                    }).join('');
            }
            
            // --- INICIALIZACIÓN Y EVENT LISTENERS ---

            /**
             * Adjunta todos los event listeners de la aplicación.
             */
            function setupEventListeners() {
                // Navegación principal
                dom.globalNavBar.addEventListener('click', e => {
                    const navBtn = e.target.closest('.nav-btn');
                    if (navBtn) showScreen(navBtn.dataset.screen);
                });

                // Dashboard
                dom.dashboard.generateBtn.addEventListener('click', e => {
                    const prompt = dom.dashboard.userPrompt.value;
                    if (prompt) fetchAndStartWorkout(prompt, 'Custom', e.currentTarget);
                });
                dom.dashboard.openLabBtn.addEventListener('click', () => showScreen('lab-screen'));
                dom.dashboard.pointsDisplay.addEventListener('click', () => showScreen('progress-screen'));

                // Laboratorio
                dom.lab.timerTypeSelection.addEventListener('click', e => {
                    const timerBtn = e.target.closest('.timer-type-btn');
                    if (timerBtn) openTimerTool(timerBtn.dataset.type);
                });
                dom.lab.savedWorkoutsList.addEventListener('click', e => {
                    const startBtn = e.target.closest('.start-saved-workout-btn');
                    if (startBtn) {
                        const routineTitle = startBtn.dataset.title;
                        const allRoutines = [...predefinedWorkouts, ...state.userData.savedWorkouts, ...state.userData.customRoutines];
                        const routine = allRoutines.find(r => r.title === routineTitle);
                        if (routine) {
                            state.aiWorkout.routine = routine;
                            startAiWorkout();
                        }
                    }
                });

                // Pantalla de Entrenamiento
                dom.workout.exitBtn.addEventListener('click', () => {
                    clearInterval(state.aiWorkout.timerInterval);
                    showScreen('dashboard-screen');
                });
                dom.workout.playPauseBtn.addEventListener('click', toggleAiPause);
                dom.workout.nextBtn.addEventListener('click', nextAiPhase);
                dom.workout.prevBtn.addEventListener('click', prevAiPhase);
                dom.workout.beastModeBtn.addEventListener('click', () => showModal('beastMode'));

                // Pantalla Post-Entrenamiento
                document.getElementById('exit-visualizer-btn').addEventListener('click', () => {
                    stopVisualizer();
                    showScreen('dashboard-screen');
                });

                // Pantalla de Datos
                dom.data.saveBtn.addEventListener('click', saveAndAnalyzeData);
                dom.data.analyzeDataBtn.addEventListener('click', analyzeUserDataWithAI);
                dom.data.energyTracker.addEventListener('click', e => {
                    const moodBtn = e.target.closest('.mood-btn');
                    if (moodBtn) {
                        dom.data.energyTracker.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
                        moodBtn.classList.add('active');
                        state.userData.energy = parseInt(moodBtn.dataset.value);
                    }
                });

                // Pantalla de Progreso
                dom.progress.analyzeHistoryBtn.addEventListener('click', analyzeUserDataWithAI); // Reutiliza la función de análisis general
                dom.progress.rewardsGrid.addEventListener('click', e => {
                    const claimBtn = e.target.closest('.claim-reward-btn');
                    if (claimBtn) claimReward(claimBtn.dataset.rewardId);
                });


                // Modales
                dom.modals.closeBtn.addEventListener('click', hideModal);
                dom.modals.overlay.addEventListener('click', e => {
                    if (e.target === dom.modals.overlay) hideModal();
                });
                dom.modals.confirmBeastModeBtn.addEventListener('click', () => {
                    // Lógica para activar modo bestia
                    hideModal();
                });
                dom.modals.cancelBeastModeBtn.addEventListener('click', hideModal);

                // Bienestar Íntimo
                dom.modals.lastPeriodDate.addEventListener('change', () => {
                    state.userData.lastPeriodDate = dom.modals.lastPeriodDate.value;
                    updateMenstrualCycleDisplay();
                    saveAllData();
                });

                // Ajustes
                dom.settings.themeToggle.addEventListener('change', () => {
                    state.theme = dom.settings.themeToggle.checked ? 'dark' : 'light';
                    document.body.className = state.theme + '-theme';
                    saveAllData();
                });
                
                // Botones de Volver
                document.querySelectorAll('.back-to-dashboard-btn').forEach(btn => btn.addEventListener('click', () => showScreen('dashboard-screen')));
                document.querySelectorAll('.back-to-lab-btn').forEach(btn => btn.addEventListener('click', () => showScreen('lab-screen')));
                document.querySelectorAll('.back-to-wellness-btn').forEach(btn => btn.addEventListener('click', () => showScreen('wellness-screen')));
            }

            /**
             * Función de inicialización de la aplicación.
             */
            function init() {
                // Cargar datos, configurar estado inicial, etc.
                loadAllData();
                renderMoodIcons();
                setLanguage(state.language);
                document.body.className = state.theme + '-theme';
                dom.settings.themeToggle.checked = state.theme === 'dark';
                updatePointsDisplay();
                setupDailyMissions();
                setupEventListeners();
                setupAlarmChecks();
                showScreen('dashboard-screen');
                setTimeout(showDailyOracle, 1500);
            }

            // Iniciar la aplicación
            init();
        });
    </script>
</body>

</html>
```
