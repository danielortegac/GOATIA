<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>goatiFIT - Tu Entrenador Personal IA de √âlite</title>
    <!-- Propiedad de goatify.app. El workflow IA es para usuarios registrados. -->
    <meta name="description" content="goatiFIT: Tu entrenador personal de √©lite con IA. Rutinas personalizadas, seguimiento de progreso y bienestar.">
    <meta name="keywords" content="goatiFIT, entrenador personal, IA, fitness, gym, entrenamiento, rutinas, bienestar, salud, goati, goatify">
    <link rel="canonical" href="https://goatifit.app">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-glow: rgba(138, 79, 255, 0.7);
            --primary: #8a4fff;
            --primary-hover: #9d6bff;
            --secondary: #1a1a1a;
            --light: #282828;
            --dark: #101010;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --success: #22c55e;
            --warning: #facc15;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg-gradient-start: var(--dark);
            --bg-gradient-end: #1a0f2e;
        }

        body.light-theme {
            --primary-glow: rgba(100, 120, 255, 0.4);
            --primary: #6478ff;
            --primary-hover: #7c8dff;
            --secondary: #f0f2f5;
            --light: #ffffff;
            --dark: #e9eef2;
            --text-primary: #1a1a1a;
            --text-secondary: #555555;
            --success: #16a34a;
            --warning: #f59e0b;
            --danger: #dc2626;
            --info: #2563eb;
            --bg-gradient-start: #fdfdff;
            --bg-gradient-end: #eef2f7;
        }

        @keyframes background-pan {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes pulse-neon {
            0%, 100% {
                box-shadow: 0 0 5px 1px var(--danger), 0 0 10px 2px var(--danger);
            }

            50% {
                box-shadow: 0 0 10px 2px var(--danger), 0 0 20px 5px var(--danger);
            }
        }

        .beast-mode-active {
            animation: pulse-neon 1.5s infinite;
        }

        @keyframes breath {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.8;
            }

            50% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .breathing-circle-anim {
            animation: breath 8s ease-in-out infinite;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--dark);
            background-image: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 50%, var(--bg-gradient-start) 100%);
            background-size: 200% 200%;
            animation: background-pan 15s ease infinite;
            color: var(--text-primary);
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }

        #app-container {
            height: 100vh;
            height: 100dvh;
            width: 100%;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .screen {
            min-height: 100%;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            will-change: transform, opacity;
            display: flex;
            flex-direction: column;
            width: 100%;
            padding: 1rem;
        }

        .screen.fullscreen {
            padding: 0;
            justify-content: center;
        }

        .screen.hidden {
            display: none;
        }

        .btn {
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--primary-hover));
            color: white;
            box-shadow: 0 4px 20px var(--primary-glow);
        }

        .btn-secondary {
            background-color: var(--light);
            color: var(--text-primary);
            border: 1px solid rgba(128, 128, 128, 0.2);
        }

        .btn-secondary.active,
        .btn-secondary:hover {
            background-color: var(--primary);
            border-color: var(--primary-hover);
            color: white;
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .glassmorphism {
            background: var(--light);
            border: 1px solid rgba(138, 79, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(138, 79, 255, 0.05);
        }

        body.dark-theme .glassmorphism {
            background: rgba(26, 26, 26, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        body.light-theme .glassmorphism {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        textarea,
        input[type=number],
        input[type=text],
        input[type=time],
        input[type=date] {
            background-color: var(--secondary);
            color: var(--text-primary);
            border: 1px solid rgba(128, 128, 128, 0.2);
        }

        textarea::placeholder,
        input::placeholder {
            color: var(--text-secondary);
        }

        .timer-circle-progress {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1s linear;
        }

        .phase-border-work { border-color: var(--success); }
        .phase-color-work { color: var(--success); }
        .phase-border-rest { border-color: var(--warning); }
        .phase-color-rest { color: var(--warning); }
        .phase-border-prep { border-color: var(--primary); }
        .phase-color-prep { color: var(--primary); }
        .phase-border-cooldown { border-color: var(--info); }
        .phase-color-cooldown { color: var(--info); }


        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--secondary); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--primary); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: var(--primary-hover); }

        .fade-in { animation: fadeIn 0.6s ease-in-out forwards; opacity: 0; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        input[type=number] { -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked+.slider { background-color: var(--primary); }
        input:checked+.slider:before { transform: translateX(26px); }

        .mood-btn.active { transform: scale(1.2); box-shadow: 0 0 15px var(--primary-glow); border-color: var(--primary); }

        .breathing-visual-circle { animation: breathe-circle 8s ease-in-out infinite; }
        @keyframes breathe-circle {
            0%, 100% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1); opacity: 1; }
        }

        .tab-button.active { background-color: var(--primary); color: white; box-shadow: 0 0 15px var(--primary-glow); }

        .timer-active-indicator { position: absolute; top: 5px; right: 5px; width: 12px; height: 12px; background-color: var(--success); border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.5; }
            100% { transform: scale(0.9); opacity: 1; }
        }
        
        .circle-progress-container { position: relative; width: 120px; height: 120px; margin: auto; }
        .circle-bg { fill: none; stroke: var(--secondary); stroke-width: 8px; }
        .circle-progress { fill: none; stroke: var(--primary); stroke-width: 8px; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dasharray 0.5s, stroke 0.5s; }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .heartbeat-anim { animation: heartbeat 1.5s ease-in-out infinite; }

        .muscle-group {
            fill: var(--secondary);
            stroke: var(--text-secondary);
            stroke-width: 0.5;
            transition: fill 0.3s ease, opacity 0.3s ease;
            opacity: 0.6;
        }
        .muscle-group:hover, .muscle-group.active {
            opacity: 1 !important;
            fill: var(--primary) !important;
            stroke: var(--primary-hover);
            cursor: pointer;
        }
    </style>
</head>

<body class="dark-theme">
    <!-- goatiFIT: Propiedad de goatify.app. El workflow IA es para usuarios registrados. SEO y Desarrollo por Goati. -->
    <div id="app-container">
        <!-- ======================= DASHBOARD SCREEN ========================== -->
        <div id="dashboard-screen" class="screen items-center justify-center">
            <header class="w-full text-center mb-8 pt-8">
                <div class="flex justify-center items-center gap-4">
                    <i class="fas fa-dumbbell text-6xl text-primary" style="filter: drop-shadow(0 0 10px var(--primary-glow));"></i>
                    <div>
                        <h1 class="text-5xl font-black" data-translate-key="main_title">goati<span class="text-primary">FIT</span></h1>
                        <p class="text-xl text-text-secondary mt-2" data-translate-key="subtitle">Tu Entrenador de √âlite con IA</p>
                    </div>
                </div>
                <div id="points-display" class="mt-4 glassmorphism inline-block px-4 py-2 rounded-full">
                    <span class="font-bold text-primary"><i class="fas fa-star"></i> <span id="points-value">0</span> PTS</span>
                </div>
            </header>

            <main class="w-full max-w-4xl space-y-6 flex-grow">
                <div id="daily-oracle-card" class="glassmorphism p-6 rounded-2xl fade-in hidden">
                    <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-magic text-primary mr-3"></i><span data-translate-key="oracle_title">Or√°culo Fitness Diario</span></h2>
                    <p id="oracle-message" class="text-center italic text-lg text-text-secondary"></p>
                </div>
                <div class="glassmorphism p-6 rounded-2xl fade-in" style="animation-delay: 0.2s;">
                    <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-fire text-primary mr-3"></i><span data-translate-key="mission_title">Tu Misi√≥n de Hoy</span></h2>
                    <div id="workout-of-the-day" class="text-center p-6 bg-secondary rounded-lg">
                        <p class="text-text-secondary" data-translate-key="mission_placeholder">Usa el Laboratorio de Entrenamiento o pide una rutina a la IA para empezar.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glassmorphism p-6 rounded-2xl fade-in" style="animation-delay: 0.4s;">
                        <h2 class="text-2xl font-bold mb-4"><i class="fas fa-comments text-primary mr-3"></i><span data-translate-key="ia_prompt_title">Pide tu Rutina a la IA</span></h2>
                        <textarea id="user-prompt" class="w-full h-24 p-4 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none resize-none" data-translate-key="ia_prompt_placeholder" placeholder="Ej: 'Quiero una rutina de 45 mins en el gimnasio para espalda y b√≠ceps'"></textarea>
                        <div class="flex gap-2 mt-2">
                            <button class="ai-modifier-btn btn btn-secondary flex-1 text-sm" data-modifier="sin equipo"><i class="fas fa-ban mr-1"></i> <span data-translate-key="ai_modifier_no_equipment">Sin Equipo</span></button>
                            <button class="ai-modifier-btn btn btn-secondary flex-1 text-sm" data-modifier="con silla y mochila"><i class="fas fa-couch mr-1"></i> <span data-translate-key="ai_modifier_home">En Casa</span></button>
                        </div>
                        <button id="generate-btn" class="btn btn-primary btn-glow w-full p-4 rounded-lg font-bold text-lg mt-4">
                            <i class="fas fa-cogs mr-2"></i> <span data-translate-key="ia_prompt_button">Crear con IA</span>
                        </button>
                    </div>
                    <div class="glassmorphism p-6 rounded-2xl fade-in" style="animation-delay: 0.6s;">
                        <h2 class="text-2xl font-bold mb-4"><i class="fas fa-flask text-primary mr-3"></i><span data-translate-key="lab_title">Laboratorio de Entrenamiento</span></h2>
                        <p class="text-text-secondary mb-4" data-translate-key="lab_description">Elige un modo de entrenamiento o un desaf√≠o espec√≠fico.</p>
                        <button id="open-lab-btn" class="btn btn-secondary btn-glow w-full p-4 rounded-lg font-bold text-lg mt-4">
                            <i class="fas fa-arrow-right mr-2"></i> <span data-translate-key="lab_button">Ir al Laboratorio</span>
                        </button>
                    </div>
                </div>
            </main>

            <footer class="w-full mt-8 pb-8 fade-in" style="animation-delay: 1s;">
                <nav class="grid grid-cols-3 sm:grid-cols-5 md:grid-cols-6 gap-4 text-center text-xs md:text-base">
                    <button id="open-progress-btn" class="flex flex-col items-center p-2 text-text-secondary hover:text-primary transition-colors" title="Progreso"><i class="fas fa-trophy text-2xl mb-1"></i><span data-translate-key="nav_progress">Progreso</span></button>
                    <button id="open-data-btn" class="flex flex-col items-center p-2 text-text-secondary hover:text-primary transition-colors" title="Mis Datos"><i class="fas fa-chart-line text-2xl mb-1"></i><span data-translate-key="nav_data">Datos</span></button>
                    <button id="open-wellness-btn" class="flex flex-col items-center p-2 text-text-secondary hover:text-primary transition-colors" title="Bienestar"><i class="fas fa-spa text-2xl mb-1"></i><span data-translate-key="nav_wellness">Bienestar</span></button>
                    <button id="open-sleep-btn" class="flex flex-col items-center p-2 text-text-secondary hover:text-primary transition-colors" title="Sue√±o"><i class="fas fa-moon text-2xl mb-1"></i><span data-translate-key="nav_sleep">Sue√±o</span></button>
                    <button id="open-offline-btn" class="flex flex-col items-center p-2 text-text-secondary hover:text-primary transition-colors" title="Modo Offline"><i class="fas fa-wifi text-2xl mb-1"></i><span data-translate-key="nav_offline">Offline</span></button>
                    <button id="open-settings-btn" class="flex flex-col items-center p-2 text-text-secondary hover:text-primary transition-colors" title="Ajustes"><i class="fas fa-cog text-2xl mb-1"></i><span data-translate-key="nav_settings">Ajustes</span></button>
                </nav>
            </footer>
        </div>

        <!-- ======================= WORKOUT LAB SCREEN ======================== -->
        <div id="lab-screen" class="screen hidden items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="lab_title">Workout Lab</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl flex-grow mx-auto">
                <div class="mb-8 fade-in">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="tools_title">Herramientas de Precisi√≥n</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="timer-type-selection">
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="stopwatch"><i class="fas fa-stopwatch text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_stopwatch">Cron√≥metro</span></button>
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="timer"><i class="fas fa-hourglass-half text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_timer">Temporizador</span></button>
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="tabata"><i class="fas fa-bolt text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_tabata">T√°bata</span></button>
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="rounds"><i class="fas fa-sync-alt text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_rounds">Rondas</span></button>
                    </div>
                </div>
                <div class="fade-in" style="animation-delay: 0.2s;">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="challenges_title">Desaf√≠os R√°pidos</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button class="challenge-btn btn btn-secondary p-6 rounded-lg text-left" data-challenge="abs">
                            <h3 class="text-xl font-bold text-primary" data-translate-key="challenge_abs_title">üî• Abdomen de Acero</h3>
                            <p class="text-sm text-text-secondary mt-1" data-translate-key="challenge_abs_desc">Un reto r√°pido y brutal de 10 minutos para fortalecer tu core.</p>
                        </button>
                        <button class="challenge-btn btn btn-secondary p-6 rounded-lg text-left" data-challenge="plank">
                            <h3 class="text-xl font-bold text-primary" data-translate-key="challenge_plank_title">‚è≥ Plank Challenge</h3>
                            <p class="text-sm text-text-secondary mt-1" data-translate-key="challenge_plank_desc">¬øCu√°nto puedes aguantar? Un test de resistencia en plancha.</p>
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- ======================= LIVE WORKOUT SCREEN ======================= -->
        <div id="workout-screen" class="screen hidden justify-between">
            <header class="w-full flex justify-between items-center flex-shrink-0 pt-4 max-w-2xl mx-auto">
                <h2 id="workout-title" class="text-xl md:text-2xl font-bold truncate"></h2>
                <button id="exit-workout-btn" class="btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-times mr-2"></i> <span data-translate-key="exit_button">Salir</span></button>
            </header>
            <main class="flex flex-col items-center justify-center flex-grow text-center w-full max-w-2xl relative">
                <div id="exercise-info" class="w-full">
                    <p id="current-exercise" class="text-3xl md:text-4xl font-bold"></p>
                    <p id="next-exercise" class="text-lg md:text-xl text-text-secondary mt-2"></p>
                </div>
                <div class="relative w-64 h-64 md:w-80 md:h-80 flex items-center justify-center my-4">
                    <div class="absolute w-full h-full bg-secondary rounded-full opacity-50"></div>
                    <svg class="absolute w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-700" stroke-width="5" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="workout-progress-circle" class="timer-circle-progress" stroke-width="5" stroke-linecap="round" stroke="var(--primary)" fill="transparent" r="45" cx="50" cy="50" transform="rotate(-90 50 50)" />
                    </svg>
                    <div id="workout-timer-ring" class="z-10 text-center flex flex-col items-center justify-center w-[calc(100%-40px)] h-[calc(100%-40px)] rounded-full border-8 border-transparent transition-colors duration-500 bg-dark">
                        <p id="workout-phase-label" class="text-xl md:text-2xl font-bold uppercase tracking-widest"></p>
                        <p id="workout-timer-display" class="text-7xl md:text-8xl font-black"></p>
                    </div>
                </div>
                <div id="how-to-container" class="w-full max-w-md glassmorphism p-4 rounded-lg hidden">
                    <h4 class="text-lg font-bold text-primary mb-2"><i class="fas fa-lightbulb mr-2"></i><span data-translate-key="how_to_title">C√≥mo Hacerlo</span>:</h4>
                    <ol id="how-to-steps" class="text-left list-decimal list-inside space-y-1 text-sm"></ol>
                </div>
            </main>
            <footer class="w-full flex justify-center items-center gap-4 flex-shrink-0 pb-4">
                <button id="prev-btn" class="btn btn-secondary p-4 rounded-full w-16 h-16 text-2xl"><i class="fas fa-backward-step"></i></button>
                <button id="play-pause-btn" class="btn btn-primary btn-glow p-4 rounded-full w-24 h-24 text-4xl"><i class="fas fa-play ml-1"></i></button>
                <button id="next-btn" class="btn btn-secondary p-4 rounded-full w-16 h-16 text-2xl"><i class="fas fa-forward-step"></i></button>
                <button id="beast-mode-btn" class="btn btn-secondary p-4 rounded-full w-16 h-16 text-2xl text-danger border-danger" data-translate-key="beast_mode_button_title" title="Modo Bestia: A√±ade un finisher intenso"><i class="fas fa-skull-crossbones"></i></button>
            </footer>
        </div>

        <!-- ======================= POST WORKOUT SCREEN (EMOTIONAL VISUALIZER) ======================= -->
        <div id="post-workout-screen" class="screen hidden fullscreen items-center justify-center text-center bg-gray-900 overflow-hidden">
            <div id="visualizer-canvas-container" class="absolute inset-0 w-full h-full">
                <canvas id="visualizer-canvas" class="w-full h-full"></canvas>
            </div>
            <div class="relative z-10 p-4">
                <h1 id="visualizer-title" class="text-3xl font-bold text-white mb-4"></h1>
                <p id="visualizer-message" class="text-xl text-gray-300"></p>
                <button id="exit-visualizer-btn" class="btn btn-primary mt-8 px-8 py-3 rounded-lg font-bold">
                    <i class="fas fa-check-circle mr-2"></i><span>Terminar</span>
                </button>
            </div>
        </div>

        <!-- ======================= OFFLINE SCREEN =========================== -->
        <div id="offline-screen" class="screen hidden items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="offline_title">Modo Offline</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl flex-grow mx-auto space-y-6 custom-scrollbar pr-2">
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="create_own_title">Crea tu Propia Rutina</h2>
                    <p class="text-text-secondary mb-4" data-translate-key="create_own_desc">Dise√±a tu entrenamiento perfecto y gu√°rdalo para acceder sin conexi√≥n.</p>
                    <div class="space-y-4">
                        <input type="text" id="new-routine-name" class="w-full p-3 rounded-lg" placeholder="Nombre de la rutina (ej: Lunes de Pecho)">
                        <textarea id="new-routine-exercises" class="w-full h-32 p-3 rounded-lg" placeholder="Ejercicios y series (ej: 4x12 Press Banca, 3x15 Aperturas, 4x10 Flexiones)"></textarea>
                        <button id="save-custom-routine-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold"><i class="fas fa-save mr-2"></i> Guardar Rutina</button>
                    </div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="offline_desc">Rutinas sin Conexi√≥n</h2>
                    <p class="text-text-secondary mb-4" data-translate-key="offline_info">Accede a una biblioteca de entrenamientos precargados, perfectos para cuando no tienes internet.</p>
                    <div id="offline-routines-list" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                        <!-- Offline routines will be injected here -->
                    </div>
                </div>
            </main>
        </div>

        <!-- ======================= DATA SCREEN =========================== -->
        <div id="data-screen" class="screen hidden items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="data_title">Mis Datos</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-md flex-grow mx-auto space-y-6 custom-scrollbar pr-2 pb-8">
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="data_input_title">Registro Diario</h2>
                    <div class="space-y-4">
                        <!-- Basic Data -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="input-weight" class="font-bold" data-translate-key="data_weight">Peso (kg)</label>
                                <input id="input-weight" type="number" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="e.g., 75.5">
                            </div>
                            <div>
                                <label for="input-sleep" class="font-bold" data-translate-key="data_sleep_hours">Horas de Sue√±o</label>
                                <input id="input-sleep" type="number" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="e.g., 7.5">
                            </div>
                        </div>
                        <div>
                            <label for="input-measures" class="font-bold" data-translate-key="data_measures">Medidas</label>
                            <input id="input-measures" type="text" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="cintura:75, b√≠ceps:35">
                        </div>
                        <!-- Wellness Data -->
                        <div>
                            <label class="font-bold" data-translate-key="data_energy">Energ√≠a Hoy</label>
                            <div id="energy-tracker" class="flex justify-around mt-2">
                                <button class="mood-btn btn btn-secondary rounded-full w-12 h-12 text-2xl" data-value="1">üò©</button>
                                <button class="mood-btn btn btn-secondary rounded-full w-12 h-12 text-2xl" data-value="2">üòü</button>
                                <button class="mood-btn btn btn-secondary rounded-full w-12 h-12 text-2xl" data-value="3">üòê</button>
                                <button class="mood-btn btn btn-secondary rounded-full w-12 h-12 text-2xl" data-value="4">üôÇ</button>
                                <button class="mood-btn btn btn-secondary rounded-full w-12 h-12 text-2xl" data-value="5">üòÅ</button>
                            </div>
                        </div>
                        <div>
                            <label class="font-bold" data-translate-key="data_water_liters">Agua (litros)</label>
                            <input id="input-water" type="number" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="e.g., 2.5">
                        </div>
                        
                        <!-- Menstrual Cycle Tracker -->
                        <div id="menstrual-tracker-card" class="glassmorphism p-4 rounded-lg border border-pink-500/20">
                            <h3 class="text-lg font-bold mb-3 flex items-center text-pink-400"><i class="fas fa-venus mr-3"></i><span data-translate-key="menstrual_tracker_title">Seguimiento Menstrual</span></h3>
                            <div class="space-y-3">
                                <div>
                                    <label for="last-period-date" class="font-bold text-sm">Fecha de inicio de tu √∫ltimo periodo:</label>
                                    <input type="date" id="last-period-date" class="w-full mt-1 p-2 rounded-lg text-sm">
                                </div>
                                <div id="menstrual-cycle-display" class="text-center bg-secondary p-2 rounded-lg text-sm">
                                    <!-- Cycle day info will be displayed here -->
                                </div>
                            </div>
                        </div>

                        <button id="save-data-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold mt-4"><i class="fas fa-save mr-2"></i><span data-translate-key="data_save_button">Guardar Datos</span></button>
                    </div>
                </div>
                <div id="ai-insights-container" class="glassmorphism p-6 rounded-2xl hidden">
                    <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-brain text-primary mr-3"></i><span data-translate-key="data_insights_title">An√°lisis de IA</span></h2>
                    <div id="ai-insights-content" class="text-sm space-y-2"></div>
                </div>
            </main>
        </div>
        
        <!-- ======================= SLEEP SCREEN =========================== -->
        <div id="sleep-screen" class="screen hidden items-center justify-center text-center bg-gray-900">
            <div class="absolute top-4 right-4">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-times"></i></button>
            </div>
            <div id="sleep-main-content">
                <div class="relative flex items-center justify-center w-64 h-64">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div id="sleep-clock" class="text-6xl font-black heartbeat-anim"></div>
                    </div>
                    <div class="breathing-circle-anim absolute w-full h-full bg-blue-500/30 rounded-full"></div>
                    <div class="breathing-circle-anim absolute w-3/4 h-3/4 bg-blue-500/40 rounded-full" style="animation-delay: -2s;"></div>
                    <div class="breathing-circle-anim absolute w-1/2 h-1/2 bg-blue-500/50 rounded-full" style="animation-delay: -4s;"></div>
                </div>
                <h1 class="text-3xl font-bold text-white mt-8" data-translate-key="sleep_title">M√≥dulo de Sue√±o</h1>
                <p class="text-gray-300 mt-2" data-translate-key="sleep_desc">Rel√°jate y prep√°rate para un descanso profundo.</p>
                <div class="mt-8 space-y-4 w-full max-w-xs">
                    <div class="flex justify-center gap-4">
                        <button class="sleep-sound-btn btn btn-secondary p-4 rounded-lg" data-sound="brown" title="Ruido Marr√≥n"><i class="fas fa-wind text-2xl"></i></button>
                        <button class="sleep-sound-btn btn btn-secondary p-4 rounded-lg" data-sound="rain" title="Lluvia"><i class="fas fa-cloud-rain text-2xl"></i></button>
                        <button class="sleep-sound-btn btn btn-secondary p-4 rounded-lg" data-sound="forest" title="Bosque"><i class="fas fa-tree text-2xl"></i></button>
                    </div>
                    <div class="relative">
                        <input type="range" id="sleep-timer-slider" min="0" max="120" value="0" class="w-full">
                        <div id="sleep-timer-active-indicator" class="timer-active-indicator hidden"></div>
                    </div>
                    <p class="text-white"><span data-translate-key="sleep_timer_label">Timer</span>: <span id="sleep-timer-value">Off</span></p>
                    <button id="toggle-sleep-sound-btn" class="btn btn-primary w-full p-4 rounded-full font-bold">
                        <i class="fas fa-play mr-2"></i><span data-translate-key="sleep_start_button">Iniciar Sonido</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ======================= WELLNESS SCREEN =========================== -->
        <div id="wellness-screen" class="screen hidden items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="wellness_title">Bienestar</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl flex-grow mx-auto space-y-8 custom-scrollbar pr-2 pb-8">
                <!-- Breathing Exercise -->
                <div class="glassmorphism p-6 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="wellness_breathing_title">Respiraci√≥n Guiada</h2>
                    <div id="breathing-circle" class="relative w-48 h-48 mx-auto my-4 flex items-center justify-center">
                        <svg class="absolute w-full h-full" viewBox="0 0 100 100">
                            <circle class="breathing-visual-circle" stroke-width="5" stroke-linecap="round" stroke="var(--info)" fill="transparent" r="45" cx="50" cy="50" style="animation-duration: 4s;"></circle>
                        </svg>
                        <i id="breathing-icon" class="fas fa-lungs text-5xl text-white z-10"></i>
                    </div>
                    <p id="breathing-instruction" class="text-xl font-bold h-8"></p>
                    <button id="start-breathing-btn" class="btn btn-primary mt-4 px-6 py-2"><i class="fas fa-play mr-2"></i><span data-translate-key="wellness_breathing_start">Comenzar 4-7-8</span></button>
                </div>
                <!-- Mobility Routines -->
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="wellness_mobility_title">Rutinas de Movilidad</h2>
                    <p class="text-text-secondary mb-4" data-translate-key="wellness_mobility_desc">P√≠dele a la IA rutinas cortas para cualquier momento del d√≠a.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button class="mobility-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center" data-moment="morning">
                            <i class="fas fa-sun text-3xl mb-2 text-warning"></i>
                            <span class="font-bold" data-translate-key="wellness_mobility_morning">Ma√±ana</span>
                        </button>
                        <button class="mobility-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center" data-moment="break">
                            <i class="fas fa-mug-hot text-3xl mb-2 text-info"></i>
                            <span class="font-bold" data-translate-key="wellness_mobility_break">Descanso</span>
                        </button>
                        <button class="mobility-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center" data-moment="night">
                            <i class="fas fa-moon text-3xl mb-2 text-primary"></i>
                            <span class="font-bold" data-translate-key="wellness_mobility_night">Noche</span>
                        </button>
                    </div>
                </div>
                <!-- Ice Bath Workout -->
                <div id="ice-bath-workout" class="glassmorphism p-6 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-center"><i class="fas fa-snowflake text-info mr-3"></i><span data-translate-key="ice_bath_title">Terapia de Hielo</span></h2>
                    <p class="text-text-secondary mb-4" data-translate-key="ice_bath_desc">Sigue esta gu√≠a para una inmersi√≥n segura y efectiva.</p>
                    <div class="space-y-2 mb-4 text-sm text-text-secondary text-left mx-auto max-w-sm">
                        <p>1. Prepara el ba√±o con agua fr√≠a (10-15¬∞C).</p>
                        <p>2. Respira profundamente antes de entrar.</p>
                        <p>3. Sum√©rgete y mant√©n la calma.</p>
                    </div>
                    <button id="start-ice-bath-btn" class="btn btn-info text-white bg-info px-8 py-3 rounded-lg font-bold">
                        <i class="fas fa-play mr-2"></i><span data-translate-key="ice_bath_start_button">Iniciar Inmersi√≥n (3 min)</span>
                    </button>
                </div>
                <!-- Sexual Wellness Module -->
                <div id="sexual-wellness-card" class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-heart text-danger mr-3"></i><span data-translate-key="sexual_wellness_title">Bienestar √çntimo</span></h2>
                    <p class="text-text-secondary mb-4" data-translate-key="sexual_wellness_desc">Un espacio para conectar con tu energ√≠a corporal y fortalecer tu centro.</p>
                    <div class="space-y-4">
                         <button id="sexual-wellness-workout-btn" class="btn btn-primary w-full p-4 rounded-lg font-bold"><i class="fas fa-dumbbell mr-2"></i><span data-translate-key="sexual_wellness_tips_button">Rutina Suelo P√©lvico (10 min)</span></button>
                    </div>
                </div>
            </main>
        </div>

        <!-- ======================= PROGRESS SCREEN =========================== -->
        <div id="progress-screen" class="screen hidden items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="progress_title">Mi Progreso</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl flex-grow mx-auto space-y-8 custom-scrollbar pr-2 pb-8">
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-between">
                        <span data-translate-key="progress_weekly_title">Actividad Semanal</span>
                        <button class="info-btn text-primary text-lg" data-info="weekly"><i class="fas fa-info-circle"></i></button>
                    </h2>
                    <div id="weekly-chart" class="flex justify-around items-center p-4 text-center space-x-2 md:space-x-4">
                        <div class="flex-1">
                            <div class="circle-progress-container">
                                <svg viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" class="circle-bg"></circle>
                                    <circle id="minutes-circle" cx="60" cy="60" r="54" class="circle-progress" style="stroke-dasharray: 340; stroke-dashoffset: 340;"></circle>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <p id="total-minutes" class="text-3xl font-black">0</p>
                                    <p class="text-xs md:text-sm text-text-secondary">MINUTOS</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="circle-progress-container">
                                <svg viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" class="circle-bg"></circle>
                                    <circle id="routines-circle" cx="60" cy="60" r="54" class="circle-progress" style="stroke-dasharray: 340; stroke-dashoffset: 340;"></circle>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <p id="total-routines" class="text-3xl font-black">0</p>
                                    <p class="text-xs md:text-sm text-text-secondary">RUTINAS</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="circle-progress-container">
                                <svg viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" class="circle-bg"></circle>
                                    <circle id="calories-circle" cx="60" cy="60" r="54" class="circle-progress" style="stroke-dasharray: 340; stroke-dashoffset: 340;"></circle>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <p id="total-calories" class="text-3xl font-black">0</p>
                                    <p class="text-xs md:text-sm text-text-secondary">CALOR√çAS</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Body Map Visual -->
                <div class="glassmorphism p-6 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-between">
                        <span data-translate-key="body_map_title">M√∫sculos Trabajados</span>
                        <button class="info-btn text-primary text-lg" data-info="bodymap"><i class="fas fa-info-circle"></i></button>
                    </h2>
                    <div id="body-map-container" class="w-full max-w-sm mx-auto relative grid grid-cols-2 gap-4">
                        <!-- SVG Body Map will be injected here -->
                    </div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-between">
                        <span data-translate-key="progress_achievements_title">Logros</span>
                        <button class="info-btn text-primary text-lg" data-info="achievements"><i class="fas fa-info-circle"></i></button>
                    </h2>
                    <div id="achievements-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4 text-center"></div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="progress_history_title">Historial de Entrenamiento</h2>
                    <div id="workout-history-list" class="space-y-3 max-h-64 overflow-y-auto custom-scrollbar pr-2"></div>
                </div>
            </main>
        </div>

        <!-- ======================= SETTINGS SCREEN =========================== -->
        <div id="settings-screen" class="screen hidden items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="settings_title">Ajustes</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-md flex-grow mx-auto space-y-6">
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="settings_notifications_title">Notificaciones</h2>
                    <div id="notifications-list" class="space-y-4"></div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="settings_alarms_title">Alarmas Personalizadas</h2>
                    <div id="alarms-list" class="space-y-4 mb-4"></div>
                    <div class="flex items-center gap-4">
                        <input type="time" id="new-alarm-time" class="flex-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
                        <button id="add-alarm-btn" class="btn btn-primary p-3 rounded-lg font-bold"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- ======================= MODALS ======================= -->
        <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
            <div id="modal-content-wrapper" class="glassmorphism rounded-2xl w-full max-w-lg p-6 relative transform scale-95 transition-transform duration-300">
                <button id="close-modal-btn" class="absolute top-4 right-4 text-text-secondary hover:text-primary text-2xl">&times;</button>
                <!-- Beast Mode Modal -->
                <div id="beast-mode-modal-content" class="hidden text-center text-text-primary">
                    <h2 class="text-2xl font-bold mb-4 text-danger"><i class="fas fa-skull-crossbones mr-2"></i><span data-translate-key="beast_mode_modal_title">Modo Bestia</span></h2>
                    <p class="mb-6" data-translate-key="beast_mode_modal_desc">Esto a√±adir√° un finisher brutal de 60 segundos de Burpees a tu entrenamiento. ¬øAceptas el desaf√≠o?</p>
                    <div class="flex justify-center gap-4">
                        <button id="cancel-beast-mode-btn" class="btn btn-secondary px-6 py-2 font-bold" data-translate-key="cancel_button">Cancelar</button>
                        <button id="confirm-beast-mode-btn" class="btn btn-danger bg-danger px-6 py-2 font-bold" data-translate-key="beast_mode_modal_confirm">¬°Activar!</button>
                    </div>
                </div>
                <!-- Info Modal -->
                <div id="info-modal-content" class="hidden text-text-primary">
                    <h2 id="info-modal-title" class="text-2xl font-bold mb-4 text-primary"></h2>
                    <div id="info-modal-body" class="max-h-[70vh] overflow-y-auto pr-4 custom-scrollbar"></div>
                </div>
                <!-- Coach Modal -->
                <div id="coach-modal-content" class="hidden text-center text-text-primary">
                    <div class="text-5xl mb-4">üêê</div>
                    <h2 class="text-2xl font-bold mb-2 text-primary" data-translate-key="coach_modal_title">Mensaje del Coach</h2>
                    <p id="coach-message" class="mb-6 text-lg"></p>
                    <button id="close-coach-modal-btn" class="btn btn-primary px-8 py-2 font-bold" data-translate-key="coach_modal_close">¬°Entendido!</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DICTIONARY FOR i18n ---
            const translations = {
                es: {
                    main_title: "goati<span class='text-primary'>FIT</span>",
                    subtitle: "Tu Entrenador de √âlite con IA",
                    nav_progress: "Progreso",
                    nav_data: "Datos",
                    nav_wellness: "Bienestar",
                    nav_sleep: "Sue√±o",
                    nav_offline: "Offline",
                    nav_settings: "Ajustes",
                    mission_title: "Tu Misi√≥n de Hoy",
                    mission_placeholder: "Usa el Laboratorio de Entrenamiento o pide una rutina a la IA para empezar.",
                    ia_prompt_title: "Pide tu Rutina a la IA",
                    ia_prompt_placeholder: "Ej: 'Quiero una rutina de 45 mins en el gimnasio para espalda y b√≠ceps'",
                    ia_prompt_button: "Crear con IA",
                    ai_modifier_no_equipment: "Sin Equipo",
                    ai_modifier_home: "En Casa",
                    lab_title: "Laboratorio de Entrenamiento",
                    lab_description: "Elige un modo de entrenamiento o un desaf√≠o espec√≠fico.",
                    lab_button: "Ir al Laboratorio",
                    back_button: "Volver",
                    tools_title: "Herramientas de Precisi√≥n",
                    tool_stopwatch: "Cron√≥metro",
                    tool_timer: "Temporizador",
                    tool_tabata: "T√°bata",
                    tool_rounds: "Rondas",
                    challenges_title: "Desaf√≠os R√°pidos",
                    challenge_abs_title: "üî• Abdomen de Acero",
                    challenge_abs_desc: "Un reto r√°pido y brutal de 10 minutos para fortalecer tu core.",
                    challenge_plank_title: "‚è≥ Plank Challenge",
                    challenge_plank_desc: "¬øCu√°nto puedes aguantar? Un test de resistencia en plancha.",
                    exit_button: "Salir",
                    how_to_title: "C√≥mo Hacerlo",
                    beast_mode_button_title: "Modo Bestia: A√±ade un finisher intenso",
                    beast_mode_activated_alert: "¬°MODO BESTIA ACTIVADO! Se ha a√±adido un finisher brutal.",
                    beast_mode_modal_title: "Modo Bestia",
                    beast_mode_modal_desc: "Esto a√±adir√° un finisher brutal de 60 segundos de Burpees a tu entrenamiento. ¬øAceptas el desaf√≠o?",
                    beast_mode_modal_confirm: "¬°Activar!",
                    cancel_button: "Cancelar",
                    next_exercise_prefix: "Siguiente",
                    last_exercise_text: "¬°√öltimo ejercicio!",
                    workout_complete_title: "¬°Completado!",
                    workout_complete_subtitle: "¬°Excelente Trabajo!",
                    post_workout_title_calm: "Buen trabajo. Hoy tu cuerpo agradece la calma.",
                    post_workout_title_hard: "Has dado todo. La fuerza de hoy es el h√°bito de ma√±ana.",
                    phase_prep: "PREP√ÅRATE",
                    phase_work: "TRABAJO",
                    phase_rest: "DESCANSO",
                    phase_cooldown: "ENFRIAMIENTO",
                    generating_routine: "Generando tu rutina de √©lite...",
                    system_prompt_base: `Eres "GoatiFit AI", un entrenador personal de √©lite. Crea una rutina de ejercicios en JSON. NUNCA respondas con texto conversacional, solo el JSON. Para cada fase de 'work', incluye un array "howTo" con 2-4 instrucciones cortas, paso a paso, en espa√±ol. Formato JSON requerido:`,
                    data_title: "Mis Datos",
                    data_input_title: "Registro Diario",
                    data_weight: "Peso (kg)",
                    data_measures: "Medidas",
                    data_energy: "Energ√≠a Hoy",
                    data_sleep_hours: "Horas de Sue√±o",
                    data_water_liters: "Agua (litros)",
                    data_save_button: "Guardar Datos",
                    data_insights_title: "An√°lisis de IA",
                    data_insights_prompt_base: "Soy un usuario de tu app de fitness. Mis datos de hoy son: Peso",
                    data_insights_prompt_end: "Basado en estos datos, dame 2-3 consejos cortos y accionables sobre fitness o nutrici√≥n, en formato de lista HTML (<ul><li>).",
                    menstrual_tracker_title: "Seguimiento Menstrual",
                    sleep_title: "M√≥dulo de Sue√±o",
                    sleep_desc: "Rel√°jate y prep√°rate para un descanso profundo.",
                    sleep_start_button: "Iniciar Sonido",
                    sleep_stop_button: "Detener Sonido",
                    sleep_timer_label: "Apagar en",
                    wellness_title: "Bienestar",
                    wellness_breathing_title: "Respiraci√≥n Guiada",
                    wellness_breathing_start: "Comenzar 4-7-8",
                    wellness_breathing_stop: "Detener",
                    wellness_breathe_in: "Inhala...",
                    wellness_breathe_hold: "Sost√©n...",
                    wellness_breathe_out: "Exhala...",
                    wellness_mobility_title: "Rutinas de Movilidad",
                    wellness_mobility_desc: "P√≠dele a la IA rutinas cortas para cualquier momento del d√≠a.",
                    wellness_mobility_morning: "Ma√±ana",
                    wellness_mobility_break: "Descanso",
                    wellness_mobility_night: "Noche",
                    mobility_prompt_morning: "una rutina de movilidad de 5 minutos para despertar el cuerpo por la ma√±ana",
                    mobility_prompt_break: "una rutina de estiramiento de 5 minutos para un descanso activo en la oficina",
                    mobility_prompt_night: "una rutina de estiramiento y relajaci√≥n de 5 minutos para antes de dormir",
                    ice_bath_title: "Terapia de Hielo",
                    ice_bath_desc: "Sigue esta gu√≠a para una inmersi√≥n segura y efectiva.",
                    ice_bath_start_button: "Iniciar Inmersi√≥n (3 min)",
                    sexual_wellness_title: "Bienestar √çntimo",
                    sexual_wellness_desc: "Un espacio para conectar con tu energ√≠a corporal y fortalecer tu centro.",
                    sexual_wellness_tips_button: "Rutina Suelo P√©lvico (10 min)",
                    progress_title: "Mi Progreso",
                    progress_weekly_title: "Actividad Semanal",
                    body_map_title: "M√∫sculos Trabajados",
                    progress_achievements_title: "Logros",
                    progress_history_title: "Historial de Entrenamiento",
                    achievement_first_workout_name: "Primer Paso",
                    achievement_first_workout_desc: "Completa tu primer entrenamiento.",
                    achievement_seven_day_streak_name: "Imparable",
                    achievement_seven_day_streak_desc: "Entrena 7 d√≠as seguidos.",
                    achievement_beast_mode_name: "Modo Bestia",
                    achievement_beast_mode_desc: "Activa y completa un finisher Modo Bestia.",
                    achievement_perfect_week_name: "Semana Perfecta",
                    achievement_perfect_week_desc: "Entrena todos los d√≠as de la semana.",
                    info_weekly_title: "Tu Actividad Semanal",
                    info_weekly_desc: "Este gr√°fico muestra los minutos totales que has entrenado cada d√≠a de la semana actual. ¬°Intenta mantener la constancia para ver c√≥mo crecen las barras!",
                    info_achievements_title: "Tus Logros",
                    info_achievements_desc: "Estos son los hitos que has desbloqueado. Los logros en color est√°n completados, mientras que los grises son tu pr√≥ximo objetivo. ¬°A por ellos!",
                    info_bodymap_title: "Mapa Corporal de M√∫sculos",
                    info_bodymap_desc: "Este mapa te muestra qu√© grupos musculares has trabajado en tus √∫ltimos entrenamientos. El color m√°s intenso indica un mayor volumen de trabajo.",
                    settings_title: "Ajustes",
                    settings_notifications_title: "Notificaciones",
                    settings_alarms_title: "Alarmas Personalizadas",
                    notification_reminder_stand: "Recordatorio para levantarse",
                    notification_reminder_water: "Recordatorio para tomar agua",
                    notification_reminder_sleep: "Recordatorio para dormir",
                    notification_reminder_train: "Recordatorio para entrenar",
                    notification_reminder_motivation: "Dosis de motivaci√≥n",
                    coach_modal_title: "Mensaje del Coach",
                    coach_modal_close: "¬°Entendido!",
                    coach_message_1: "¬°El dolor de hoy es la fuerza de ma√±ana! Sigue as√≠.",
                    coach_message_2: "Recuerda, la constancia es m√°s importante que la intensidad. ¬°No te rindas!",
                    coach_message_3: "¬°Has completado otro entrenamiento! Est√°s un paso m√°s cerca de tu meta.",
                    coach_message_4: "Tu cuerpo puede con casi todo. Es a tu mente a la que tienes que convencer.",
                    coach_message_5: "¬°Buen trabajo! No olvides hidratarte y estirar bien.",
                    oracle_title: "Or√°culo Fitness Diario",
                    offline_title: "Modo Offline",
                    offline_desc: "Rutinas sin Conexi√≥n",
                    offline_info: "Accede a una biblioteca de entrenamientos precargados, perfectos para cuando no tienes internet.",
                    create_own_title: "Crea tu Propia Rutina",
                    create_own_desc: "Dise√±a tu entrenamiento perfecto y gu√°rdalo para acceder sin conexi√≥n.",
                }
            };

            // --- DOM Elements ---
            const dom = {
                appContainer: document.getElementById('app-container'),
                screens: Array.from(document.querySelectorAll('.screen')).reduce((acc, screen) => {
                    acc[screen.id.replace('-screen', '')] = screen;
                    return acc;
                }, {}),
                dashboard: {
                    userPrompt: document.getElementById('user-prompt'),
                    generateBtn: document.getElementById('generate-btn'),
                    workoutOfTheDay: document.getElementById('workout-of-the-day'),
                    openLabBtn: document.getElementById('open-lab-btn'),
                    pointsValue: document.getElementById('points-value'),
                    oracleCard: document.getElementById('daily-oracle-card'),
                    oracleMessage: document.getElementById('oracle-message'),
                },
                lab: {
                    timerTypeSelection: document.getElementById('timer-type-selection'),
                    challengeBtns: document.querySelectorAll('.challenge-btn'),
                },
                workout: {
                    title: document.getElementById('workout-title'),
                    exitBtn: document.getElementById('exit-workout-btn'),
                    timerRing: document.getElementById('workout-timer-ring'),
                    progressCircle: document.getElementById('workout-progress-circle'),
                    phaseLabel: document.getElementById('workout-phase-label'),
                    timerDisplay: document.getElementById('workout-timer-display'),
                    currentExercise: document.getElementById('current-exercise'),
                    nextExercise: document.getElementById('next-exercise'),
                    howToContainer: document.getElementById('how-to-container'),
                    howToSteps: document.getElementById('how-to-steps'),
                    prevBtn: document.getElementById('prev-btn'),
                    playPauseBtn: document.getElementById('play-pause-btn'),
                    nextBtn: document.getElementById('next-btn'),
                    beastModeBtn: document.getElementById('beast-mode-btn'),
                },
                data: {
                    inputWeight: document.getElementById('input-weight'),
                    inputMeasures: document.getElementById('input-measures'),
                    energyTracker: document.getElementById('energy-tracker'),
                    inputSleep: document.getElementById('input-sleep'),
                    inputWater: document.getElementById('input-water'),
                    saveBtn: document.getElementById('save-data-btn'),
                    insightsContainer: document.getElementById('ai-insights-container'),
                    insightsContent: document.getElementById('ai-insights-content'),
                    lastPeriodDate: document.getElementById('last-period-date'),
                    menstrualCycleDisplay: document.getElementById('menstrual-cycle-display'),
                },
                sleep: {
                    toggleBtn: document.getElementById('toggle-sleep-sound-btn'),
                    soundBtns: document.querySelectorAll('.sleep-sound-btn'),
                    timerSlider: document.getElementById('sleep-timer-slider'),
                    timerValue: document.getElementById('sleep-timer-value'),
                    timerIndicator: document.getElementById('sleep-timer-active-indicator'),
                    clock: document.getElementById('sleep-clock'),
                },
                wellness: {
                    startBreathingBtn: document.getElementById('start-breathing-btn'),
                    breathingInstruction: document.getElementById('breathing-instruction'),
                    mobilityBtns: document.querySelectorAll('.mobility-btn'),
                    startIceBathBtn: document.getElementById('start-ice-bath-btn'),
                    sexualWellnessWorkoutBtn: document.getElementById('sexual-wellness-workout-btn'),
                },
                progress: {
                    minutesValue: document.getElementById('total-minutes'),
                    routinesValue: document.getElementById('total-routines'),
                    caloriesValue: document.getElementById('total-calories'),
                    minutesCircle: document.getElementById('minutes-circle'),
                    routinesCircle: document.getElementById('routines-circle'),
                    caloriesCircle: document.getElementById('calories-circle'),
                    bodyMapContainer: document.getElementById('body-map-container'),
                    achievementsGrid: document.getElementById('achievements-grid'),
                    historyList: document.getElementById('workout-history-list'),
                },
                settings: {
                    notificationsList: document.getElementById('notifications-list'),
                    alarmsList: document.getElementById('alarms-list'),
                    addAlarmBtn: document.getElementById('add-alarm-btn'),
                    newAlarmTime: document.getElementById('new-alarm-time'),
                },
                offline: {
                    routinesList: document.getElementById('offline-routines-list'),
                    newRoutineName: document.getElementById('new-routine-name'),
                    newRoutineExercises: document.getElementById('new-routine-exercises'),
                    saveCustomRoutineBtn: document.getElementById('save-custom-routine-btn'),
                },
                modals: {
                    overlay: document.getElementById('modal-overlay'),
                    contentWrapper: document.getElementById('modal-content-wrapper'),
                    closeBtn: document.getElementById('close-modal-btn'),
                    beastModeContent: document.getElementById('beast-mode-modal-content'),
                    confirmBeastModeBtn: document.getElementById('confirm-beast-mode-btn'),
                    cancelBeastModeBtn: document.getElementById('cancel-beast-mode-btn'),
                    infoContent: document.getElementById('info-modal-content'),
                    infoTitle: document.getElementById('info-modal-title'),
                    infoBody: document.getElementById('info-modal-body'),
                    coachContent: document.getElementById('coach-modal-content'),
                    coachMessage: document.getElementById('coach-message'),
                    closeCoachBtn: document.getElementById('close-coach-modal-btn'),
                },
                openDataBtn: document.getElementById('open-data-btn'),
                openSleepBtn: document.getElementById('open-sleep-btn'),
                openWellnessBtn: document.getElementById('open-wellness-btn'),
                openProgressBtn: document.getElementById('open-progress-btn'),
                openSettingsBtn: document.getElementById('open-settings-btn'),
                openOfflineBtn: document.getElementById('open-offline-btn'),
            };

            // --- Master State Object ---
            let state = {
                currentScreen: 'dashboard',
                language: 'es',
                audioContext: null,
                aiWorkout: {
                    routine: null,
                    currentIndex: 0,
                    currentPhase: 'idle',
                    phaseTimeLeft: 0,
                    isPaused: true,
                    timerInterval: null,
                    beastModeActivated: false,
                    beastModeExplained: false,
                },
                sleep: {
                    soundNode: null,
                    gainNode: null,
                    isPlaying: false,
                    selectedSound: 'brown',
                    timerId: null,
                    clockInterval: null,
                },
                wellness: {
                    breathingInterval: null,
                    isBreathing: false
                },
                progress: {
                    history: [],
                    achievements: {
                        first_workout: false,
                        seven_day_streak: false,
                        beast_mode: false,
                        perfect_week: false,
                    },
                    points: 0,
                    muscleGroupsWorked: {},
                },
                userData: {
                    weight: null,
                    measures: null,
                    energy: null,
                    sleep: null,
                    water: null,
                    lastPeriodDate: null,
                    customRoutines: [],
                },
                notifications: {
                    stand: { enabled: true, intervalId: null },
                    water: { enabled: true, intervalId: null },
                    sleep: { enabled: false, intervalId: null },
                    train: { enabled: false, intervalId: null },
                    motivation: { enabled: true, intervalId: null },
                },
                alarms: [],
                oracleMessage: null,
            };

            // --- CORE APP LOGIC ---
            function showScreen(screenId) {
                const targetScreen = document.getElementById(screenId);
                if (!targetScreen) return;
                Object.values(dom.screens).forEach(screen => screen.classList.add('hidden'));
                targetScreen.classList.remove('hidden');
                state.currentScreen = screenId.replace('-screen', '');
                dom.appContainer.scrollTop = 0;

                stopVisualizer();
                stopSleepSound();
                toggleBreathingExercise(true); 
                if (state.sleep.clockInterval) clearInterval(state.sleep.clockInterval);

                if (screenId === 'progress-screen') renderProgressScreen();
                if (screenId === 'data-screen') renderDataScreen();
                if (screenId === 'settings-screen') renderSettingsScreen();
                if (screenId === 'offline-screen') renderOfflineRoutines();
                if (screenId === 'sleep-screen') startSleepClock();
            }

            function setLanguage(lang) {
                state.language = lang;
                document.documentElement.lang = lang;
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    const translation = translations[lang][key];
                    if (translation) {
                        if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') el.placeholder = translation;
                        else if (el.hasAttribute('title')) el.title = translation;
                        else el.innerHTML = translation;
                    }
                });
            }

            function initAudio() {
                if (!state.audioContext) {
                    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (state.audioContext.state === 'suspended') {
                    state.audioContext.resume();
                }
            }

            function playBeep(frequency = 440, duration = 100, type = 'sine') {
                initAudio();
                const oscillator = state.audioContext.createOscillator();
                const gainNode = state.audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(state.audioContext.destination);
                oscillator.type = type;
                oscillator.frequency.value = frequency;
                gainNode.gain.setValueAtTime(0, state.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, state.audioContext.currentTime + 0.01);
                oscillator.start(state.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, state.audioContext.currentTime + duration / 1000);
                oscillator.stop(state.audioContext.currentTime + duration / 1000);
            }

            // --- AI Workout Generation ---
            function showLoadingSkeleton(btn) {
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
                }
            }
            
            async function fetchAndStartWorkout(promptText, workoutType, btnToLoad) {
                showLoadingSkeleton(btnToLoad);
                
                let routine;
                const lang = state.language;
                const jsonFormat = `{"title": "Creative Name", "totalDurationMinutes": 30, "type": "${workoutType}", "phases": [{"phaseName": "Warm-up", "type": "prep", "durationSeconds": 180, "exerciseName": "Dynamic Warm-up", "howTo": ["Instruction 1", "Instruction 2"], "muscleGroups": ["full body"]}, {"phaseName": "Squats", "type": "work", "durationSeconds": 45, "exerciseName": "Dumbbell Squats", "howTo": ["Instruction 1", "Instruction 2"], "muscleGroups": ["legs", "glutes"]}, {"phaseName": "Rest", "type": "rest", "durationSeconds": 15, "exerciseName": "Rest"}]}`;
                const systemPrompt = `${translations[lang].system_prompt_base} ${jsonFormat}`;

                try {
                    // This is a placeholder for a real API call.
                    // In a real scenario, you would use fetch() to call your AI backend.
                    await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate network delay
                    const mockResponse = {
                        title: workoutType || "Rutina de IA",
                        totalDurationMinutes: 25,
                        phases: [
                            { phaseName: "Calentamiento", type: "prep", durationSeconds: 180, exerciseName: "Saltos de tijera y c√≠rculos de brazos", howTo: ["Realiza saltos de tijera suaves.", "Haz c√≠rculos amplios con los brazos hacia adelante y atr√°s."], muscleGroups: ["full body"] },
                            { phaseName: "Ejercicio Principal 1", type: "work", durationSeconds: 240, exerciseName: "Sentadillas con peso corporal", howTo: ["Pies al ancho de los hombros.", "Baja la cadera manteniendo la espalda recta.", "Sube de forma controlada."], muscleGroups: ["legs", "glutes"] },
                            { phaseName: "Descanso", type: "rest", durationSeconds: 60, exerciseName: "Descanso Activo (caminar)" },
                            { phaseName: "Ejercicio Principal 2", type: "work", durationSeconds: 240, exerciseName: "Flexiones (en rodillas si es necesario)", howTo: ["Manos un poco m√°s anchas que los hombros.", "Baja el pecho hacia el suelo.", "Mant√©n el abdomen contra√≠do."], muscleGroups: ["chest", "arms", "core"] },
                            { phaseName: "Enfriamiento", type: "cooldown", durationSeconds: 180, exerciseName: "Estiramientos suaves", howTo: ["Estira cu√°driceps, isquiotibiales y pecho.", "Mant√©n cada estiramiento por 30 segundos."], muscleGroups: ["full body"] }
                        ]
                    };
                    routine = mockResponse;
                } catch (error) {
                    alert("Error generando rutina: " + error.message);
                    if (btnToLoad) {
                        btnToLoad.disabled = false;
                        btnToLoad.innerHTML = `<i class="fas fa-cogs mr-2"></i> ${translations[lang].ia_prompt_button}`;
                    }
                    return;
                }
                
                state.aiWorkout.routine = routine;
                startAiWorkout();
            }


            // --- AI Workout Execution ---
            function startAiWorkout() {
                if (!state.aiWorkout.routine) return;
                showScreen('workout-screen');
                Object.assign(state.aiWorkout, {
                    currentIndex: 0,
                    isPaused: false,
                    beastModeActivated: false
                });
                dom.workout.beastModeBtn.classList.remove('beast-mode-active');
                dom.workout.title.textContent = state.aiWorkout.routine.title;
                runAiPhase(0);
                updatePlayPauseIcon();
            }

            function runAiPhase(index) {
                if (index >= state.aiWorkout.routine.phases.length) {
                    finishAiWorkout();
                    return;
                }
                const phase = state.aiWorkout.routine.phases[index];
                state.aiWorkout.currentIndex = index;
                state.aiWorkout.currentPhase = phase.type;
                state.aiWorkout.phaseTimeLeft = phase.durationSeconds;
                updateUIForAiPhase(phase);
                if (state.aiWorkout.timerInterval) clearInterval(state.aiWorkout.timerInterval);
                state.aiWorkout.timerInterval = setInterval(updateAiTimer, 1000);
                playBeep(phase.type === 'work' ? 660 : 440, 200);
            }

            function updateUIForAiPhase(phase) {
                const lang = state.language;
                dom.workout.phaseLabel.textContent = translations[lang][`phase_${phase.type}`] || phase.phaseName;
                dom.workout.currentExercise.textContent = phase.exerciseName;
                const nextIndex = state.aiWorkout.currentIndex + 1;
                const nextPhaseData = state.aiWorkout.routine.phases[nextIndex];
                dom.workout.nextExercise.textContent = nextPhaseData ? `${translations[lang].next_exercise_prefix}: ${nextPhaseData.exerciseName || nextPhaseData.phaseName}` : translations[lang].last_exercise_text;
                const phaseType = phase.type || 'prep';
                dom.workout.timerRing.className = `z-10 text-center flex flex-col items-center justify-center w-[calc(100%-40px)] h-[calc(100%-40px)] rounded-full border-8 transition-colors duration-500 bg-dark phase-border-${phaseType}`;
                dom.workout.progressCircle.className = `timer-circle-progress phase-color-${phaseType}`;

                dom.workout.howToSteps.innerHTML = '';
                if (phase.howTo && phase.howTo.length > 0) {
                    phase.howTo.forEach(step => {
                        const li = document.createElement('li');
                        li.textContent = step;
                        dom.workout.howToSteps.appendChild(li);
                    });
                    dom.workout.howToContainer.classList.remove('hidden');
                } else {
                    dom.workout.howToContainer.classList.add('hidden');
                }
            }

            function updateAiTimer() {
                if (state.aiWorkout.isPaused) return;
                if (state.aiWorkout.phaseTimeLeft > 0) state.aiWorkout.phaseTimeLeft--;
                const phaseDuration = state.aiWorkout.routine.phases[state.aiWorkout.currentIndex].durationSeconds;
                const progress = phaseDuration > 0 ? (state.aiWorkout.phaseTimeLeft / phaseDuration) : 0;
                dom.workout.progressCircle.style.strokeDashoffset = 283 * (1 - progress);
                if (state.aiWorkout.phaseTimeLeft <= 0) {
                    nextAiPhase();
                } else if (state.aiWorkout.phaseTimeLeft <= 3 && state.aiWorkout.phaseTimeLeft > 0) {
                    playBeep(523, 150, 'square');
                }
                const minutes = Math.floor(state.aiWorkout.phaseTimeLeft / 60);
                const seconds = state.aiWorkout.phaseTimeLeft % 60;
                dom.workout.timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            function nextAiPhase() {
                runAiPhase(state.aiWorkout.currentIndex + 1);
            }

            function prevAiPhase() {
                if (state.aiWorkout.currentIndex > 0) runAiPhase(state.aiWorkout.currentIndex - 1);
            }

            function handleBeastModeClick() {
                showModal('beast-mode');
            }

            function activateBeastMode() {
                if (state.aiWorkout.beastModeActivated || !state.aiWorkout.routine) return;
                state.aiWorkout.beastModeActivated = true;
                dom.workout.beastModeBtn.classList.add('beast-mode-active');
                const finisher = {
                    phaseName: "BEAST MODE",
                    type: "work",
                    durationSeconds: 60,
                    exerciseName: "Burpees",
                    howTo: ["From standing, drop into a squat.", "Kick your feet back to a plank.", "Do a push-up.", "Jump feet back to squat and explode up."],
                    muscleGroups: ["full body"]
                };
                state.aiWorkout.routine.phases.splice(state.aiWorkout.routine.phases.length - 1, 0, finisher);
                showCoachMessage(translations[state.language].beast_mode_activated_alert);
                hideModal();
            }
            
            function finishAiWorkout() {
                clearInterval(state.aiWorkout.timerInterval);
                playBeep(1046, 500, 'triangle');
                logWorkoutToHistory();
                showScreen('post-workout-screen');
                const title = state.aiWorkout.routine.type === 'Mobility' ? translations[state.language].post_workout_title_calm : translations[state.language].post_workout_title_hard;
                document.getElementById('visualizer-title').textContent = title;
                document.getElementById('visualizer-message').textContent = `¬°Ganaste ${state.aiWorkout.routine.totalDurationMinutes * 5} puntos!`;
                startVisualizer();
            }

            function toggleAiPause() {
                state.aiWorkout.isPaused = !state.aiWorkout.isPaused;
                updatePlayPauseIcon();
            }

            function updatePlayPauseIcon() {
                dom.workout.playPauseBtn.querySelector('i').className = state.aiWorkout.isPaused ? 'fas fa-play ml-1' : 'fas fa-pause';
            }

            // --- Post-Workout Visualizer ---
            let visualizerAnimationId;
            const visualizerCanvas = document.getElementById('visualizer-canvas');
            const visualizerCtx = visualizerCanvas.getContext('2d');

            function startVisualizer() {
                dom.appContainer.style.overflow = 'hidden';
                visualizerCanvas.width = visualizerCanvas.offsetWidth;
                visualizerCanvas.height = visualizerCanvas.offsetHeight;
                visualizerAnimationId = requestAnimationFrame(animateVisualizer);
            }

            function animateVisualizer() {
                visualizerCtx.fillStyle = 'rgba(16, 16, 16, 0.1)';
                visualizerCtx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
                visualizerCtx.fillStyle = `rgba(138, 79, 255, ${Math.random()})`;
                visualizerCtx.beginPath();
                visualizerCtx.arc(Math.random() * visualizerCanvas.width, Math.random() * visualizerCanvas.height, Math.random() * 100, 0, Math.PI * 2);
                visualizerCtx.fill();
                visualizerAnimationId = requestAnimationFrame(animateVisualizer);
            }

            function stopVisualizer() {
                cancelAnimationFrame(visualizerAnimationId);
                dom.appContainer.style.overflowY = 'auto';
            }

            // --- Modal Logic ---
            function showModal(type, data) {
                dom.modals.overlay.classList.remove('hidden');
                dom.modals.beastModeContent.style.display = type === 'beast-mode' ? 'block' : 'none';
                dom.modals.infoContent.style.display = type === 'info' ? 'block' : 'none';
                dom.modals.coachContent.style.display = type === 'coach' ? 'block' : 'none';

                if (type === 'info') {
                    dom.modals.infoTitle.innerHTML = data.title;
                    dom.modals.infoBody.innerHTML = data.body;
                }
                if (type === 'coach') {
                    const lang = state.language;
                    const messages = [translations[lang].coach_message_1, translations[lang].coach_message_2, translations[lang].coach_message_3, translations[lang].coach_message_4, translations[lang].coach_message_5];
                    dom.modals.coachMessage.textContent = data || messages[Math.floor(Math.random() * messages.length)];
                }

                setTimeout(() => dom.modals.contentWrapper.classList.remove('scale-95'), 10);
            }

            function hideModal() {
                dom.modals.contentWrapper.classList.add('scale-95');
                setTimeout(() => dom.modals.overlay.classList.add('hidden'), 300);
            }
            
            function showCoachMessage(message) {
                showModal('coach', message);
            }

            // --- Data & Wellness Modules ---
            function saveAndAnalyzeData() {
                state.userData.weight = dom.data.inputWeight.value || null;
                state.userData.measures = dom.data.inputMeasures.value || null;
                state.userData.sleep = dom.data.inputSleep.value || null;
                state.userData.water = dom.data.inputWater.value || null;
                state.userData.lastPeriodDate = dom.data.lastPeriodDate.value || null;
                
                localStorage.setItem('goatiFitUserData', JSON.stringify(state.userData));
                showCoachMessage("Tus datos han sido guardados y analizados.");
                renderDataScreen();
            }
            
            function renderDataScreen() {
                dom.data.inputWeight.value = state.userData.weight || '';
                dom.data.inputMeasures.value = state.userData.measures || '';
                dom.data.inputSleep.value = state.userData.sleep || '';
                dom.data.inputWater.value = state.userData.water || '';
                dom.data.lastPeriodDate.value = state.userData.lastPeriodDate || '';

                dom.data.energyTracker.querySelectorAll('.mood-btn').forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.value) === state.userData.energy);
                });

                updateMenstrualCycleDisplay();
            }

            function updateMenstrualCycleDisplay() {
                if (state.userData.lastPeriodDate) {
                    const lastDate = new Date(state.userData.lastPeriodDate);
                    const today = new Date();
                    const diffTime = Math.abs(today - lastDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    dom.data.menstrualCycleDisplay.innerHTML = `Est√°s en el <span class="font-bold text-primary">D√≠a ${diffDays}</span> de tu ciclo.`;
                } else {
                    dom.data.menstrualCycleDisplay.textContent = 'Registra la fecha de tu √∫ltimo periodo para empezar.';
                }
            }
            
            function startSleepClock() {
                 if (state.sleep.clockInterval) clearInterval(state.sleep.clockInterval);
                 state.sleep.clockInterval = setInterval(() => {
                    const now = new Date();
                    dom.sleep.clock.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                 }, 1000);
            }

            function stopSleepSound() {
                if (state.sleep.isPlaying) {
                    if (state.sleep.soundNode) {
                        state.sleep.gainNode.gain.linearRampToValueAtTime(0, state.audioContext.currentTime + 1.5);
                        state.sleep.soundNode.stop(state.audioContext.currentTime + 1.5);
                    }
                    if (state.sleep.timerId) clearTimeout(state.sleep.timerId);
                    state.sleep.soundNode = null;
                    state.sleep.isPlaying = false;
                    dom.sleep.toggleBtn.querySelector('i').className = 'fas fa-play mr-2';
                    dom.sleep.toggleBtn.querySelector('span').textContent = translations[state.language].sleep_start_button;
                    dom.sleep.timerIndicator.classList.add('hidden');
                }
            }

            function toggleSleepSound() {
                initAudio();
                const lang = state.language;
                const btn = dom.sleep.toggleBtn;

                if (state.sleep.isPlaying) {
                    stopSleepSound();
                } else {
                    const bufferSize = state.audioContext.sampleRate * 2;
                    const noiseBuffer = state.audioContext.createBuffer(1, bufferSize, state.audioContext.sampleRate);
                    const output = noiseBuffer.getChannelData(0);

                    if (state.sleep.selectedSound === 'brown') {
                        let lastOut = 0.0;
                        for (let i = 0; i < bufferSize; i++) {
                            const white = Math.random() * 2 - 1;
                            output[i] = (lastOut + (0.02 * white)) / 1.02;
                            lastOut = output[i];
                            output[i] *= 3.5;
                        }
                    } else { // Simplified rain/forest
                        for (let i = 0; i < bufferSize; i++) {
                            output[i] = Math.random() * 2 - 1;
                        }
                    }

                    const noiseNode = state.audioContext.createBufferSource();
                    noiseNode.buffer = noiseBuffer;
                    noiseNode.loop = true;

                    const gainNode = state.audioContext.createGain();
                    gainNode.gain.setValueAtTime(0, state.audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.2, state.audioContext.currentTime + 3);
                    noiseNode.connect(gainNode);
                    gainNode.connect(state.audioContext.destination);
                    noiseNode.start(0);

                    state.sleep.soundNode = noiseNode;
                    state.sleep.gainNode = gainNode;
                    state.sleep.isPlaying = true;
                    btn.querySelector('i').className = 'fas fa-stop mr-2';
                    btn.querySelector('span').textContent = translations[lang].sleep_stop_button;

                    const timerDuration = parseInt(dom.sleep.timerSlider.value);
                    if (timerDuration > 0) {
                        state.sleep.timerId = setTimeout(stopSleepSound, timerDuration * 60 * 1000);
                        dom.sleep.timerIndicator.classList.remove('hidden');
                    }
                }
            }

            function toggleBreathingExercise(stop = false) {
                const lang = state.language;
                if (state.wellness.isBreathing || stop) {
                    clearInterval(state.wellness.breathingInterval);
                    state.wellness.isBreathing = false;
                    dom.wellness.startBreathingBtn.innerHTML = `<i class="fas fa-play mr-2"></i><span data-translate-key="wellness_breathing_start">${translations[lang].wellness_breathing_start}</span>`;
                    dom.wellness.breathingInstruction.textContent = '';
                } else {
                    state.wellness.isBreathing = true;
                    dom.wellness.startBreathingBtn.innerHTML = `<i class="fas fa-stop mr-2"></i><span data-translate-key="wellness_breathing_stop">${translations[lang].wellness_breathing_stop}</span>`;
                    const steps = [
                        { instruction: translations[lang].wellness_breathe_in, duration: 4000 }, 
                        { instruction: translations[lang].wellness_breathe_hold, duration: 7000 }, 
                        { instruction: translations[lang].wellness_breathe_out, duration: 8000 }
                    ];
                    let currentStep = -1;
                    const cycle = () => {
                        currentStep = (currentStep + 1) % steps.length;
                        dom.wellness.breathingInstruction.textContent = steps[currentStep].instruction;
                        playBeep(currentStep === 0 ? 523 : 440, 150);
                        state.wellness.breathingInterval = setTimeout(cycle, steps[currentStep].duration);
                    };
                    cycle();
                }
            }

            // --- Progress Module ---
            function logWorkoutToHistory() {
                if (!state.aiWorkout.routine) return;
                const today = new Date().toISOString().split('T')[0];
                const pointsEarned = (state.aiWorkout.routine.totalDurationMinutes || 10) * 5 + (state.aiWorkout.beastModeActivated ? 50 : 0);
                
                state.progress.history.unshift({
                    date: today,
                    title: state.aiWorkout.routine.title,
                    duration: state.aiWorkout.routine.totalDurationMinutes,
                    beastMode: state.aiWorkout.beastModeActivated,
                    muscleGroups: state.aiWorkout.routine.phases.flatMap(p => p.muscleGroups || []).filter((v, i, a) => a.indexOf(v) === i),
                });
                state.progress.points += pointsEarned;

                state.aiWorkout.routine.phases.forEach(phase => {
                    if (phase.muscleGroups) {
                        phase.muscleGroups.forEach(group => {
                            state.progress.muscleGroupsWorked[group] = (state.progress.muscleGroupsWorked[group] || 0) + (phase.durationSeconds || 60);
                        });
                    }
                });

                checkAchievements();
                saveAllData();
                updatePointsDisplay();
            }

            function updatePointsDisplay() {
                dom.dashboard.pointsValue.textContent = state.progress.points;
            }

            function checkAchievements() {
                if (!state.progress.achievements.first_workout) {
                    state.progress.achievements.first_workout = true;
                    showCoachMessage("¬°Felicidades por completar tu primer entrenamiento! Este es el comienzo de algo grande.");
                }
                if (state.aiWorkout.beastModeActivated && !state.progress.achievements.beast_mode) {
                    state.progress.achievements.beast_mode = true;
                    showCoachMessage("¬°Modo Bestia desbloqueado! Has demostrado tu poder.");
                }
            }

            function renderProgressScreen() {
                renderHistory();
                renderAchievements();
                renderWeeklyMetrics();
                renderBodyMap();
            }

            function renderHistory() {
                dom.progress.historyList.innerHTML = '';
                if (state.progress.history.length === 0) {
                    dom.progress.historyList.innerHTML = `<p class="text-text-secondary text-center">${translations[state.language].mission_placeholder}</p>`;
                    return;
                }
                state.progress.history.slice(0, 20).forEach(workout => {
                    const el = document.createElement('div');
                    el.className = 'bg-secondary p-3 rounded-lg flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <p class="font-bold">${workout.title}</p>
                            <p class="text-sm text-text-secondary">${new Date(workout.date).toLocaleDateString(state.language, { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                        </div>
                        <div class="text-right">
                             <p class="font-bold text-primary">${workout.duration} min</p>
                             ${workout.beastMode ? '<i class="fas fa-skull-crossbones text-danger"></i>' : ''}
                        </div>
                    `;
                    dom.progress.historyList.appendChild(el);
                });
            }

            function renderAchievements() {
                dom.progress.achievementsGrid.innerHTML = '';
                const lang = state.language;
                const achievementDefs = {
                    first_workout: { icon: 'fa-shoe-prints', name: translations[lang].achievement_first_workout_name, desc: translations[lang].achievement_first_workout_desc },
                    seven_day_streak: { icon: 'fa-fire', name: translations[lang].achievement_seven_day_streak_name, desc: translations[lang].achievement_seven_day_streak_desc },
                    beast_mode: { icon: 'fa-skull-crossbones', name: translations[lang].achievement_beast_mode_name, desc: translations[lang].achievement_beast_mode_desc },
                    perfect_week: { icon: 'fa-calendar-check', name: translations[lang].achievement_perfect_week_name, desc: translations[lang].achievement_perfect_week_desc },
                };
                for (const key in achievementDefs) {
                    const unlocked = state.progress.achievements[key];
                    const def = achievementDefs[key];
                    const el = document.createElement('div');
                    el.className = `p-2 rounded-lg transition-all ${unlocked ? 'bg-primary text-white' : 'bg-secondary text-text-secondary opacity-50'}`;
                    el.title = def.desc;
                    el.innerHTML = `<i class="fas ${def.icon} text-3xl"></i><p class="text-xs mt-1 font-bold">${def.name}</p>`;
                    dom.progress.achievementsGrid.appendChild(el);
                }
            }
            
            function renderWeeklyMetrics() {
                const weeklyStats = { minutes: 0, routines: 0, calories: 0 };
                const now = new Date();
                const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1))); // Monday as start of week
                startOfWeek.setHours(0, 0, 0, 0);

                state.progress.history.forEach(workout => {
                    const workoutDate = new Date(workout.date + 'T00:00:00');
                    if (workoutDate >= startOfWeek) {
                        weeklyStats.minutes += workout.duration;
                        weeklyStats.routines++;
                        weeklyStats.calories += workout.duration * 8; // Approx. 8 cal/min
                    }
                });

                dom.progress.minutesValue.textContent = weeklyStats.minutes;
                dom.progress.routinesValue.textContent = weeklyStats.routines;
                dom.progress.caloriesValue.textContent = weeklyStats.calories;

                const maxMinutes = 300, maxRoutines = 5, maxCalories = 2400;
                const minutesProgress = Math.min(1, weeklyStats.minutes / maxMinutes);
                const routinesProgress = Math.min(1, weeklyStats.routines / maxRoutines);
                const caloriesProgress = Math.min(1, weeklyStats.calories / maxCalories);
                
                const dashoffset = 340;
                dom.progress.minutesCircle.style.strokeDashoffset = dashoffset * (1 - minutesProgress);
                dom.progress.routinesCircle.style.strokeDashoffset = dashoffset * (1 - routinesProgress);
                dom.progress.caloriesCircle.style.strokeDashoffset = dashoffset * (1 - caloriesProgress);
                
                dom.progress.minutesCircle.style.stroke = minutesProgress >= 1 ? 'var(--success)' : 'var(--primary)';
                dom.progress.routinesCircle.style.stroke = routinesProgress >= 1 ? 'var(--success)' : 'var(--primary)';
                dom.progress.caloriesCircle.style.stroke = caloriesProgress >= 1 ? 'var(--success)' : 'var(--primary)';
            }


            function renderBodyMap() {
                const bodyMapSVG = `
                    <svg id="body-map-front" viewBox="0 0 200 400">
                        <title>Vista Frontal</title>
                        <!-- Head -->
                        <path class="muscle-group" data-muscle="shoulders" d="M86,74 C86,71 88,69 91,69 L109,69 C112,69 114,71 114,74 L114,80 L86,80 Z" />
                        <circle class="muscle-group" data-muscle="shoulders" cx="100" cy="60" r="18" />
                        <!-- Neck -->
                        <path class="muscle-group" data-muscle="shoulders" d="M92,80 L108,80 L105,88 L95,88 Z" />
                        <!-- Chest & Shoulders -->
                        <path class="muscle-group" data-muscle="chest" d="M70,95 C70,90 75,88 80,88 L120,88 C125,88 130,90 130,95 L125,125 L100,145 L75,125 Z" />
                        <path class="muscle-group" data-muscle="shoulders" d="M70,95 L60,105 L65,120 L75,125 Z" />
                        <path class="muscle-group" data-muscle="shoulders" d="M130,95 L140,105 L135,120 L125,125 Z" />
                        <!-- Abs -->
                        <path class="muscle-group" data-muscle="core" d="M80,148 L120,148 L115,190 L85,190 Z" />
                        <!-- Obliques -->
                        <path class="muscle-group" data-muscle="core" d="M75,125 L80,148 L85,190 L78,185 Z" />
                        <path class="muscle-group" data-muscle="core" d="M125,125 L120,148 L115,190 L122,185 Z" />
                        <!-- Arms -->
                        <path class="muscle-group" data-muscle="arms" d="M60,105 L50,115 L45,170 L55,175 L65,120 Z" />
                        <path class="muscle-group" data-muscle="arms" d="M140,105 L150,115 L155,170 L145,175 L135,120 Z" />
                        <!-- Legs (Quads) -->
                        <path class="muscle-group" data-muscle="legs" d="M85,190 L115,190 L120,280 L110,320 L90,320 L80,280 Z" />
                        <!-- Legs (Adductors) -->
                        <path class="muscle-group" data-muscle="legs" d="M90,320 L110,320 L105,350 L95,350 Z" />
                        <!-- Calves -->
                        <path class="muscle-group" data-muscle="legs" d="M85,325 C80,350 85,370 85,370 L95,370 C95,370 90,350 90,325 Z" />
                        <path class="muscle-group" data-muscle="legs" d="M115,325 C120,350 115,370 115,370 L105,370 C105,370 110,350 110,325 Z" />
                    </svg>
                    <svg id="body-map-back" viewBox="0 0 200 400">
                        <title>Vista Trasera</title>
                        <!-- Shoulders (Traps) -->
                        <path class="muscle-group" data-muscle="back" d="M90,80 L110,80 L120,95 L80,95 Z" />
                        <!-- Back (Lats) -->
                        <path class="muscle-group" data-muscle="back" d="M80,95 L120,95 L125,150 L110,160 L90,160 L75,150 Z" />
                        <!-- Back (Lower) -->
                        <path class="muscle-group" data-muscle="back" d="M90,160 L110,160 L105,180 L95,180 Z" />
                        <!-- Glutes -->
                        <path class="muscle-group" data-muscle="glutes" d="M80,180 L120,180 C125,190 125,200 120,210 L80,210 C75,200 75,190 80,180 Z" />
                        <!-- Arms (Triceps) -->
                        <path class="muscle-group" data-muscle="arms" d="M75,100 L65,110 L70,160 L80,155 Z" />
                        <path class="muscle-group" data-muscle="arms" d="M125,100 L135,110 L130,160 L120,155 Z" />
                        <!-- Legs (Hamstrings) -->
                        <path class="muscle-group" data-muscle="legs" d="M80,210 L120,210 L115,310 L85,310 Z" />
                        <!-- Calves -->
                        <path class="muscle-group" data-muscle="legs" d="M85,310 L115,310 L110,360 L90,360 Z" />
                    </svg>
                `;
                dom.progress.bodyMapContainer.innerHTML = bodyMapSVG;

                const muscleColors = {
                    'legs': 'var(--primary)', 'glutes': 'var(--primary-hover)', 'core': 'var(--success)',
                    'chest': 'var(--warning)', 'back': 'var(--danger)', 'arms': 'var(--info)',
                    'shoulders': '#7c8dff', 'full body': 'var(--text-secondary)'
                };
                
                document.querySelectorAll('.muscle-group').forEach(el => {
                    el.style.fill = 'var(--secondary)';
                    el.style.opacity = 0.6;
                });

                const muscleData = state.progress.muscleGroupsWorked;
                let maxWork = 1;
                for (const muscle in muscleData) {
                    if (muscleData[muscle] > maxWork) maxWork = muscleData[muscle];
                }

                for (const muscle in muscleData) {
                    const color = muscleColors[muscle] || muscleColors['full body'];
                    const intensity = Math.min(1, muscleData[muscle] / maxWork);
                    const elements = document.querySelectorAll(`[data-muscle="${muscle}"], [data-muscle="full body"]`);
                    elements.forEach(el => {
                        const isFullBody = el.dataset.muscle === 'full body';
                        el.style.fill = color;
                        el.style.opacity = isFullBody ? intensity * 0.5 + 0.2 : intensity * 0.8 + 0.2;
                    });
                }
            }
            
            // --- Notifications & Alarms ---
            const NotificationManager = {
                async requestPermission() {
                    if (!("Notification" in window)) return false;
                    if (Notification.permission === "granted") return true;
                    if (Notification.permission !== "denied") {
                        const permission = await Notification.requestPermission();
                        return permission === "granted";
                    }
                    return false;
                },
                send(title, body) {
                    this.requestPermission().then(granted => {
                        if (granted) {
                             new Notification(title, { body, icon: 'https://placehold.co/192x192/8a4fff/ffffff?text=GF' });
                        }
                    });
                },
            };

            function renderSettingsScreen() {
                dom.settings.notificationsList.innerHTML = '';
                const lang = state.language;
                Object.keys(state.notifications).forEach(key => {
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center';
                    el.innerHTML = `
                        <span class="font-bold">${translations[lang][`notification_reminder_${key}`]}</span>
                        <label class="switch">
                            <input type="checkbox" class="notification-toggle" data-type="${key}" ${state.notifications[key].enabled ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    `;
                    dom.settings.notificationsList.appendChild(el);
                });
                renderAlarms();
            }

            function renderAlarms() {
                 dom.settings.alarmsList.innerHTML = '';
                 if (state.alarms.length === 0) {
                    dom.settings.alarmsList.innerHTML = `<p class="text-text-secondary text-center">No hay alarmas configuradas.</p>`;
                 }
                 state.alarms.forEach((alarm, index) => {
                    const el = document.createElement('div');
                    el.className = 'bg-secondary p-4 rounded-lg flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <p class="font-bold text-lg">Alarma</p>
                            <p class="text-text-secondary">${alarm.time}</p>
                        </div>
                        <button class="delete-alarm-btn btn btn-danger px-3 py-1 text-xs" data-index="${index}"><i class="fas fa-trash"></i></button>
                    `;
                    dom.settings.alarmsList.appendChild(el);
                 });
            }

            function addAlarm() {
                const time = dom.settings.newAlarmTime.value;
                if (time) {
                    state.alarms.push({ time });
                    state.alarms.sort((a,b) => a.time.localeCompare(b.time));
                    renderAlarms();
                    saveAllData();
                }
            }

            // --- Offline Module & Custom Routines ---
            const offlineWorkouts = [
                { title: "Fuerza Total Sin Equipo", icon: "fa-hand-fist", phases: [{ type: "work", exerciseName: "Flexiones, Sentadillas, Plancha" }], totalDurationMinutes: 20 },
                { title: "Cardio Quema Grasa", icon: "fa-person-running", phases: [{ type: "work", exerciseName: "Jumping Jacks, Burpees, Rodillas altas" }], totalDurationMinutes: 15 },
                { title: "HIIT Extremo 10 Min", icon: "fa-bolt", phases: [{ type: "work", exerciseName: "Sprints, Descansos cortos" }], totalDurationMinutes: 10 },
                { title: "Yoga para Despertar", icon: "fa-sun", phases: [{ type: "work", exerciseName: "Saludo al Sol, Postura del Guerrero" }], totalDurationMinutes: 15 },
                { title: "Movilidad de Cadera y Espalda", icon: "fa-person-walking", phases: [{ type: "work", exerciseName: "C√≠rculos de cadera, Gato-Vaca" }], totalDurationMinutes: 10 },
                { title: "Core de Acero", icon: "fa-fire", phases: [{ type: "work", exerciseName: "Plancha, Crunches, Elevaci√≥n de piernas" }], totalDurationMinutes: 12 },
                { title: "Estiramiento Post-Entreno", icon: "fa-down-left-and-up-right-to-center", phases: [{ type: "work", exerciseName: "Estiramientos est√°ticos largos" }], totalDurationMinutes: 10 },
                { title: "T√°bata de Poder", icon: "fa-stopwatch", phases: [{ type: "work", exerciseName: "20s trabajo, 10s descanso" }], totalDurationMinutes: 4 },
                { title: "Calistenia B√°sica", icon: "fa-bars-progress", phases: [{ type: "work", exerciseName: "Dominadas (asistidas), Fondos, L-Sit" }], totalDurationMinutes: 25 },
                { title: "Full Body con Mancuernas", icon: "fa-dumbbell", phases: [{ type: "work", exerciseName: "Press, Remo, Zancadas" }], totalDurationMinutes: 30 },
                { title: "Recuperaci√≥n Activa", icon: "fa-heart-pulse", phases: [{ type: "work", exerciseName: "Caminata ligera, Estiramientos suaves" }], totalDurationMinutes: 20 },
                { title: "Fuerza de Piernas", icon: "fa-person-booth", phases: [{ type: "work", exerciseName: "Sentadilla b√∫lgara, Peso muerto rumano" }], totalDurationMinutes: 25 },
                { title: "Pecho y Tr√≠ceps", icon: "fa-user-ninja", phases: [{ type: "work", exerciseName: "Press de banca, Fondos en paralelas" }], totalDurationMinutes: 30 },
                { title: "Espalda y B√≠ceps", icon: "fa-user-astronaut", phases: [{ type: "work", exerciseName: "Dominadas, Curl de b√≠ceps" }], totalDurationMinutes: 30 },
                { title: "Hombros de Acero", icon: "fa-user-secret", phases: [{ type: "work", exerciseName: "Press militar, Elevaciones laterales" }], totalDurationMinutes: 20 },
                { title: "Meditaci√≥n Guiada", icon: "fa-brain", phases: [{ type: "cooldown", exerciseName: "Atenci√≥n a la respiraci√≥n" }], totalDurationMinutes: 10 },
                { title: "Cardio de Bajo Impacto", icon: "fa-person-biking", phases: [{ type: "work", exerciseName: "Bicicleta est√°tica, El√≠ptica" }], totalDurationMinutes: 30 },
                { title: "Animal Flow Intro", icon: "fa-paw", phases: [{ type: "work", exerciseName: "Underswitch, Ape, Beast" }], totalDurationMinutes: 15 },
                { title: "Reto de Flexiones", icon: "fa-award", phases: [{ type: "work", exerciseName: "M√°ximas flexiones en 5 series" }], totalDurationMinutes: 10 },
                { title: "Reto de Sentadillas", icon: "fa-trophy", phases: [{ type: "work", exerciseName: "100 sentadillas en el menor tiempo" }], totalDurationMinutes: 10 },
                { title: "Yoga para Dormir", icon: "fa-moon", phases: [{ type: "cooldown", exerciseName: "Posturas relajantes, Torsiones suaves" }], totalDurationMinutes: 15 },
            ];

            function parseCustomRoutine(name, exerciseText) {
                const duration = parseInt(name.match(/\d+/g)?.[0] || 15);
                const phases = exerciseText.split('\n').map(line => {
                    return {
                        phaseName: "Work", type: "work", durationSeconds: 180, exerciseName: line.trim(), howTo: ["Sigue las indicaciones."], muscleGroups: ["full body"]
                    }
                }).filter(p => p.exerciseName);
                return { title: name, totalDurationMinutes: duration, phases: phases, icon: "fa-user-pen", isCustom: true };
            }

            function saveCustomRoutine() {
                const name = dom.offline.newRoutineName.value.trim();
                const exercises = dom.offline.newRoutineExercises.value.trim();

                if (!name || !exercises) {
                    showCoachMessage("Por favor, completa el nombre y los ejercicios de tu rutina.");
                    return;
                }
                const newRoutine = parseCustomRoutine(name, exercises);
                state.userData.customRoutines.push(newRoutine);
                saveAllData();
                showCoachMessage(`¬°Rutina "${name}" guardada con √©xito!`);
                dom.offline.newRoutineName.value = '';
                dom.offline.newRoutineExercises.value = '';
                renderOfflineRoutines();
            }

            function renderOfflineRoutines() {
                const allRoutines = [...offlineWorkouts, ...state.userData.customRoutines];
                dom.offline.routinesList.innerHTML = '';
                allRoutines.forEach(routine => {
                    const el = document.createElement('button');
                    el.className = 'offline-routine-btn btn btn-secondary p-4 rounded-lg flex items-center justify-between w-full text-left';
                    el.dataset.title = routine.title;
                    el.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas ${routine.icon} text-primary text-xl mr-4 w-6 text-center"></i>
                            <span class="font-bold">${routine.title}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-sm text-text-secondary mr-4">${routine.totalDurationMinutes} min</span>
                            <i class="fas fa-play"></i>
                        </div>
                    `;
                    el.addEventListener('click', () => {
                        state.aiWorkout.routine = routine.isCustom ? routine : { ...routine, phases: [{ type: "work", durationSeconds: routine.totalDurationMinutes * 60, exerciseName: routine.title, howTo: [], muscleGroups: ["full body"] }] };
                        startAiWorkout();
                    });
                    dom.offline.routinesList.appendChild(el);
                });
            }

            // --- Local Storage ---
            function saveAllData() {
                const appData = {
                    progress: state.progress,
                    userData: state.userData,
                    alarms: state.alarms,
                    notifications: state.notifications,
                };
                localStorage.setItem('goatiFitDataV3', JSON.stringify(appData));
            }

            function loadAllData() {
                const savedData = localStorage.getItem('goatiFitDataV3');
                if (savedData) {
                    const appData = JSON.parse(savedData);
                    state.progress = { ...state.progress, ...appData.progress };
                    state.userData = { ...state.userData, ...appData.userData };
                    state.alarms = appData.alarms || [];
                    state.notifications = { ...state.notifications, ...appData.notifications };
                }
            }

            // --- Daily Oracle ---
            async function showDailyOracle() {
                const today = new Date().toISOString().split('T')[0];
                const lastOracleDate = localStorage.getItem('goatiFitOracleDate');

                if (today !== lastOracleDate || !state.oracleMessage) {
                    // Simulate API call
                    const messages = ["La fuerza no viene de la capacidad corporal, sino de la voluntad del alma.", "Convierte el 'no puedo' en 'puedo' y los sue√±os en planes.", "Tu √∫nico l√≠mite eres t√∫ mismo."];
                    state.oracleMessage = messages[Math.floor(Math.random() * messages.length)];
                    localStorage.setItem('goatiFitOracleMessage', state.oracleMessage);
                    localStorage.setItem('goatiFitOracleDate', today);
                } else {
                    state.oracleMessage = localStorage.getItem('goatiFitOracleMessage');
                }

                if (state.oracleMessage) {
                    dom.dashboard.oracleMessage.textContent = state.oracleMessage;
                    dom.dashboard.oracleCard.classList.remove('hidden');
                }
            }

            // --- EVENT LISTENERS ---
            document.body.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;

                const id = btn.id;
                if (id === 'generate-btn') {
                    let prompt = dom.dashboard.userPrompt.value;
                    const activeModifier = document.querySelector('.ai-modifier-btn.active');
                    if (activeModifier) prompt += ` (${activeModifier.dataset.modifier})`;
                    if(prompt) fetchAndStartWorkout(prompt, 'Custom', btn);
                } 
                else if (id === 'open-lab-btn') showScreen('lab-screen');
                else if (id === 'open-data-btn') showScreen('data-screen');
                else if (id === 'open-sleep-btn') showScreen('sleep-screen');
                else if (id === 'open-wellness-btn') showScreen('wellness-screen');
                else if (id === 'open-progress-btn') showScreen('progress-screen');
                else if (id === 'open-settings-btn') showScreen('settings-screen');
                else if (id === 'open-offline-btn') showScreen('offline-screen');
                else if (id === 'close-modal-btn' || id === 'close-coach-modal-btn') hideModal();
                else if (id === 'save-data-btn') saveAndAnalyzeData();
                else if (id === 'add-alarm-btn') addAlarm();
                else if (btn.classList.contains('delete-alarm-btn')) {
                    state.alarms.splice(btn.dataset.index, 1);
                    renderAlarms();
                    saveAllData();
                } 
                else if (id === 'toggle-sleep-sound-btn') toggleSleepSound();
                else if (id === 'start-breathing-btn') toggleBreathingExercise();
                else if (id === 'start-ice-bath-btn') {
                    state.aiWorkout.routine = { title: "Terapia de Hielo", totalDurationMinutes: 3, phases: [{ type: "prep", durationSeconds: 30, exerciseName: "Respira Profundo" }, { type: "work", durationSeconds: 180, exerciseName: "Inmersi√≥n Total" }, { type: "cooldown", durationSeconds: 30, exerciseName: "Sal Lentamente" }] };
                    startAiWorkout();
                }
                else if (id === 'sexual-wellness-workout-btn') {
                    fetchAndStartWorkout("rutina de 10 minutos para suelo p√©lvico y core", "Bienestar √çntimo", btn);
                }
                else if (btn.classList.contains('back-to-dashboard-btn')) showScreen('dashboard-screen');
                else if (btn.closest('#timer-type-selection')) {
                    alert("Temporizadores manuales en desarrollo. ¬°Usa las rutinas guiadas!");
                } 
                else if (btn.classList.contains('challenge-btn')) {
                    const challenge = btn.dataset.challenge;
                    const prompt = translations.es[`challenge_${challenge}_prompt`];
                    fetchAndStartWorkout(prompt, btn.querySelector('h3').textContent, btn);
                } 
                else if (id === 'exit-workout-btn') {
                    clearInterval(state.aiWorkout.timerInterval);
                    showScreen('dashboard-screen');
                } 
                else if (id === 'exit-visualizer-btn') {
                    stopVisualizer();
                    showScreen('dashboard-screen');
                } 
                else if (id === 'play-pause-btn') toggleAiPause();
                else if (id === 'next-btn') nextAiPhase();
                else if (id === 'prev-btn') prevAiPhase();
                else if (id === 'beast-mode-btn') handleBeastModeClick();
                else if (id === 'confirm-beast-mode-btn') activateBeastMode();
                else if (id === 'cancel-beast-mode-btn') hideModal();
                else if (id === 'save-custom-routine-btn') saveCustomRoutine();
                else if (btn.classList.contains('info-btn')) {
                    const type = btn.dataset.info;
                    showModal('info', { title: translations.es[`info_${type}_title`], body: `<p>${translations.es[`info_${type}_desc`]}</p>` });
                } 
                else if (btn.classList.contains('sleep-sound-btn')) {
                    dom.sleep.soundBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.sleep.selectedSound = btn.dataset.sound;
                } 
                else if (btn.classList.contains('mood-btn')) {
                    dom.data.energyTracker.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.userData.energy = parseInt(btn.dataset.value);
                } 
                else if (btn.classList.contains('ai-modifier-btn')) {
                    btn.classList.toggle('active');
                }
                else if (btn.classList.contains('mobility-btn')) {
                    const moment = btn.dataset.moment;
                    const prompt = translations.es[`mobility_prompt_${moment}`];
                    fetchAndStartWorkout(prompt, `Movilidad de ${moment}`, btn);
                }
            });
            
            dom.modals.overlay.addEventListener('click', (e) => {
                if (e.target === dom.modals.overlay) hideModal();
            });
            
            dom.settings.notificationsList.addEventListener('change', (e) => {
                if (e.target.classList.contains('notification-toggle')) {
                    state.notifications[e.target.dataset.type].enabled = e.target.checked;
                    saveAllData();
                }
            });

            dom.sleep.timerSlider.addEventListener('input', (e) => {
                dom.sleep.timerValue.textContent = e.target.value > 0 ? `${e.target.value} min` : 'Off';
            });
            
            dom.data.lastPeriodDate.addEventListener('change', updateMenstrualCycleDisplay);

            // --- Initial Setup ---
            function init() {
                loadAllData();
                showScreen('dashboard-screen');
                setLanguage('es');
                updatePointsDisplay();
                showDailyOracle();
            }

            init();
        });
    </script>
</body>

</html>
