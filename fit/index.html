<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>goatiFIT - Tu Entrenador Personal IA de √âlite</title>

    <link rel="icon" href="Logos HD.png" type="image/png">
    
    <meta name="description" content="goatiFIT: Tu entrenador personal de √©lite con IA. Creado por goatify.app para mejorar tu vida con herramientas inteligentes. Rutinas personalizadas, seguimiento de progreso y bienestar.">
    <meta name="keywords" content="goatiFIT, entrenador personal, IA, fitness, gym, entrenamiento, rutinas, bienestar, salud, goati, goatify, Daniel Ortega Corella">
    <meta name="author" content="Daniel Ortega Corella, goatify.app">
    <link rel="canonical" href="https://goatifit.app">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* --- Root Variables for Themes --- */
        :root {
            --primary-glow: rgba(138, 79, 255, 0.7);
            --primary: #8a4fff;
            --primary-hover: #9d6bff;
            --secondary: #1a1a1a;
            --light: #282828;
            --dark: #101010;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --success: #22c55e;
            --warning: #facc15;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg-gradient-start: var(--dark);
            --bg-gradient-end: #1a0f2e;
            --bg-main: var(--dark);
            --bg-card: rgba(26, 26, 26, 0.7);
            --border-color: rgba(138, 79, 255, 0.1);
            --box-shadow-color: rgba(138, 79, 255, 0.05);
            --input-bg: var(--secondary);
        }

        /* Light Theme */
        body.light-theme {
            --primary-glow: rgba(138, 79, 255, 0.4);
            --primary: #8a4fff;
            --primary-hover: #9d6bff;
            --secondary: #f0f0f0;
            --light: #ffffff;
            --dark: #e0e0e0;
            --text-primary: #1a1a1a;
            --text-secondary: #505050;
            --success: #16a34a;
            --warning: #eab308;
            --danger: #dc2626;
            --info: #2563eb;
            --bg-gradient-start: #f5f5f5;
            --bg-gradient-end: #e0e0e0;
            --bg-main: #f5f5f5;
            --bg-card: rgba(255, 255, 255, 0.8);
            --border-color: rgba(138, 79, 255, 0.08);
            --box-shadow-color: rgba(138, 79, 255, 0.03);
            --input-bg: #ffffff;
        }

        /* --- ANIMATIONS --- */
        @keyframes background-pan { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes pulse-neon { 0%, 100% { box-shadow: 0 0 5px 1px var(--danger), 0 0 10px 2px var(--danger); } 50% { box-shadow: 0 0 10px 2px var(--danger), 0 0 20px 5px var(--danger); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes toast-in { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toast-out { from { transform: translateY(0); opacity: 0; } to { transform: translateY(100%); opacity: 0; } }
        @keyframes pulse { 0% { transform: scale(0.9); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.5; } 100% { transform: scale(0.9); opacity: 1; } }
        
        /* Breathing Animations */
        @keyframes calm-breathe-in {
            from { transform: scale(0.8); opacity: 0.6; stroke: var(--info); }
            to { transform: scale(1.2); opacity: 1; stroke: var(--success); }
        }
        @keyframes calm-breathe-out {
            from { transform: scale(1.2); opacity: 1; stroke: var(--success); }
            to { transform: scale(0.8); opacity: 0.6; stroke: var(--info); }
        }
        @keyframes power-breathe-in {
            from { transform: scale(0.7); opacity: 0.8; stroke: #ff00ff; } /* Brighter color, smaller start */
            to { transform: scale(1.3); opacity: 1; stroke: #ff66ff; } /* Larger max scale for power */
        }
        @keyframes power-breathe-out {
            from { transform: scale(1.3); opacity: 1; stroke: #ff66ff; }
            to { transform: scale(0.7); opacity: 0.8; stroke: #ff00ff; }
        }
        @keyframes relax-breathe-in {
            from { transform: scale(0.7); opacity: 0.5; stroke: #6a0dad; } /* Deep purple */
            to { transform: scale(1.3); opacity: 1; stroke: #9932cc; }
        }
        @keyframes relax-breathe-out {
            from { transform: scale(1.3); opacity: 1; stroke: #9932cc; }
            to { transform: scale(0.7); opacity: 0.5; stroke: #6a0dad; }
        }

        /* Anti-Stress Visualizer Animation (More dynamic) */
        @keyframes stress-visualizer-pulse {
            0% { transform: scale(0.9); opacity: 0.7; box-shadow: 0 0 15px rgba(138, 79, 255, 0.6); }
            50% { transform: scale(1.05); opacity: 1; box-shadow: 0 0 30px rgba(138, 79, 255, 1); }
            100% { transform: scale(0.9); opacity: 0.7; box-shadow: 0 0 15px rgba(138, 79, 255, 0.6); }
        }

        /* Progress Circle Glow & Animation */
        @keyframes circle-glow-pulse {
            0%, 100% { filter: drop-shadow(0 0 8px var(--primary-glow)); }
            50% { filter: drop-shadow(0 0 15px var(--primary)); }
        }

        /* --- CORE LAYOUT FIX --- */
        html {
            height: 100%;
        }
        body {
            height: 100vh; /* Full viewport height */
            display: flex;
            flex-direction: column;
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-main);
            background-image: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 50%, var(--bg-gradient-start) 100%);
            background-size: 200% 200%;
            animation: background-pan 15s ease infinite;
            color: var(--text-primary);
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #app-container {
            flex-grow: 1; /* Takes up all available space */
            overflow-y: auto; /* Enables scrolling ONLY for the content area */
            overflow-x: hidden;
            padding-bottom: 100px; /* Space for content above the FIXED nav bar */
        }

        .screen {
            display: none; /* Hide screens by default */
            flex-direction: column;
            width: 100%;
            padding: 1rem; /* Default padding for screens */
            animation: fadeIn 0.5s ease-out;
            will-change: transform, opacity;
            min-height: 100%; /* Ensure screen takes at least full height */
        }
        
        .screen.active {
            display: flex; /* Show only the active screen */
        }

        .screen.fullscreen { 
            padding: 0; 
            height: 100%;
            justify-content: center; 
        }

        /* --- GLOBAL NAVIGATION BAR --- */
        #global-nav-bar {
            position: fixed; /* Always visible at the bottom */
            bottom: 0;
            left: 0;
            right: 0;
            flex-shrink: 0; /* Prevent nav from shrinking */
            z-index: 1000;
            border-top: 1px solid var(--border-color);
        }
        .nav-btn {
            color: var(--text-secondary);
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
        }
        .nav-btn i {
            transition: all 0.2s ease-in-out;
        }
        .nav-btn.active {
            color: var(--primary);
            transform: translateY(-5px) scale(1.05);
        }
        .nav-btn.active i {
             filter: drop-shadow(0 0 8px var(--primary-glow));
        }

        /* --- GENERAL STYLING --- */
        .beast-mode-active { animation: pulse-neon 1.5s infinite; }
        
        .btn {
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:active { transform: scale(0.95); }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--primary-hover));
            color: white;
            box-shadow: 0 4px 20px var(--primary-glow);
        }

        .btn-secondary {
            background-color: var(--light);
            color: var(--text-primary);
            border: 1px solid rgba(128, 128, 128, 0.2);
        }

        .btn-secondary.active,
        .btn-secondary:hover {
            background-color: var(--primary);
            border-color: var(--primary-hover);
            color: white;
            box-shadow: 0 0 15px var(--primary-glow);
        }
        
        .btn-special-glow {
            background: linear-gradient(45deg, #ff2d2d, #ff7b2d);
            color: white;
            box-shadow: 0 0 25px rgba(255, 60, 60, 0.6);
            animation: pulse-neon 2s infinite;
        }

        .glassmorphism {
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 var(--box-shadow-color);
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        textarea, input, select {
            background-color: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid rgba(128, 128, 128, 0.2);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        textarea::placeholder, input::placeholder { color: var(--text-secondary); }

        /* --- CLOCK & TIMER DESIGN IMPROVEMENTS --- */
        .timer-circle-progress {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1s linear;
        }
        
        /* Stop the trembling/pulsing animation on the clock display */
        #timer-tool-display, #workout-timer-display, #sleep-clock {
            animation: none;
            font-variant-numeric: tabular-nums; /* Ensures numbers don't shift width */
        }
        
        /* Workout screen vertical alignment */
        #workout-screen main {
            justify-content: flex-end; /* Pushes content to the bottom */
            padding-bottom: 5vh; /* Adds some space from the bottom */
        }
        
        /* Sleep screen vertical alignment */
        #sleep-screen #sleep-main-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding-bottom: 15vh; /* Push content further down */
        }

        .phase-border-work { border-color: var(--success); }
        .phase-color-work { color: var(--success); }
        .phase-border-rest { border-color: var(--warning); }
        .phase-color-rest { color: var(--warning); }
        .phase-border-prep { border-color: var(--primary); }
        .phase-color-prep { color: var(--primary); }
        .phase-border-cooldown { border-color: var(--info); }
        .phase-color-cooldown { color: var(--info); }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--secondary); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--primary); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: var(--primary-hover); }

        .fade-in { animation: fadeIn 0.6s ease-in-out forwards; opacity: 0; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--light); transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked+.slider { background-color: var(--primary); }
        input:checked+.slider:before { transform: translateX(22px); }

        .mood-btn { transition: all 0.2s ease; }
        .mood-btn.active svg { color: var(--primary); transform: scale(1.2); filter: drop-shadow(0 0 10px var(--primary-glow)); }
        .mood-btn svg { color: var(--text-secondary); }

        .timer-active-indicator { position: absolute; top: 5px; right: 5px; width: 12px; height: 12px; background-color: var(--success); border-radius: 50%; animation: pulse 1.5s infinite; }
        
        .circle-progress-container { 
            position: relative; 
            width: 100%; /* Make it responsive */
            max-width: 120px; /* Max size for larger screens */
            padding-bottom: 100%; /* Aspect ratio 1:1 */
            margin: auto; 
        }
        .circle-progress-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .circle-bg { fill: none; stroke: var(--secondary); stroke-width: 8px; }
        .circle-progress { 
            fill: none; 
            stroke: var(--primary); 
            stroke-width: 8px; 
            stroke-linecap: round; 
            transform: rotate(-90deg); 
            transform-origin: 50% 50%; 
            transition: stroke-dasharray 0.5s, stroke 0.5s, filter 0.5s; 
            filter: drop-shadow(0 0 5px var(--primary-glow)); /* Subtle glow */
            animation: circle-glow-pulse 3s infinite ease-in-out; /* Added glow animation */
        }
        
        /* Removed heartbeat-anim from sleep clock */
        #sleep-clock { animation: none; }

        .muscle-group {
            fill: var(--secondary);
            stroke: var(--text-secondary);
            stroke-width: 0.5;
            transition: fill 0.3s ease, opacity 0.3s ease, transform 0.2s ease;
            opacity: 0.6;
        }
        .muscle-group:hover, .muscle-group.active {
            opacity: 1 !important;
            fill: var(--primary) !important;
            stroke: var(--primary-hover);
            cursor: pointer;
            transform: scale(1.05);
        }

        #tooltip {
            position: fixed;
            display: none;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: bold;
            pointer-events: none;
            z-index: 1000;
            transition: opacity 0.2s;
        }

        #toast-container {
            position: fixed;
            bottom: 100px; /* Adjusted for global nav */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 12px 20px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: toast-in 0.5s forwards, toast-out 0.5s 3.5s forwards;
        }
        .toast.success { background: linear-gradient(45deg, var(--success), #2edc72); }
        .toast.error { background: linear-gradient(45deg, var(--danger), #f86c6c); }
        .toast.info { background: linear-gradient(45deg, var(--primary), var(--primary-hover)); }

        /* Anti-Stress Modal specific styling */
        #anti-stress-modal-content {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, #1a0f2e 50%, var(--bg-gradient-start) 100%);
            background-size: 200% 200%;
            animation: background-pan 15s ease infinite;
            border: none;
            display: flex; /* Ensure flexbox for centering */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%; /* Take full height of modal overlay */
            width: 100%; /* Take full width */
            padding: 2rem; /* Add padding for content */
        }
        #stress-visualizer-canvas { /* Changed from circle to canvas */
            width: 100%;
            max-width: 300px; /* Max size for the visualizer */
            height: 300px;
            margin: 2rem auto;
            border-radius: 50%; /* Keep it circular */
            background-color: transparent; /* Canvas will draw content */
            animation: stress-visualizer-pulse 4s infinite ease-in-out; /* New animation */
            transition: background-color 0.5s ease;
        }
        #stress-instruction {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        /* NEW: Improved Menstrual Tracker Card */
        #menstrual-tracker-card-new {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 105, 180, 0.2);
        }
        #menstrual-tracker-card-new .date-input-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--secondary);
            padding: 0.5rem 1rem;
            border-radius: 12px;
        }
         #menstrual-tracker-card-new input[type="date"] {
            background: transparent;
            border: none;
            color: var(--text-primary);
            flex-grow: 1;
            font-weight: bold;
        }
        #menstrual-tracker-card-new input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        #menstrual-cycle-display-new {
            margin-top: 1.5rem;
            text-align: center;
        }
        #menstrual-cycle-display-new .cycle-day-display {
            font-size: 3rem;
            font-weight: 900;
            color: var(--primary);
            line-height: 1;
        }
        #menstrual-cycle-display-new .cycle-phase-display {
            font-weight: bold;
            color: #ff69b4; /* Hot Pink */
            margin-top: 0.25rem;
        }
        #menstrual-cycle-display-new .phase-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            max-width: 250px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>

<body class="dark-theme">
    <div id="app-container" class="custom-scrollbar">
        <div id="dashboard-screen" class="screen items-center">
            <header class="w-full text-center mb-8 pt-8">
                <div class="flex justify-center items-center gap-4">
                    <img src="https://placehold.co/48x48/8a4fff/ffffff?text=LOGO" alt="Logos HD" class="h-12 w-12 mr-2">
                    <i class="fas fa-dumbbell text-6xl text-primary" style="filter: drop-shadow(0 0 10px var(--primary-glow));"></i>
                    <div>
                        <h1 class="text-5xl font-black" data-translate-key="main_title">goati<span class="text-primary">FIT</span></h1>
                        <p class="text-xl text-text-secondary mt-2" data-translate-key="subtitle">Tu Entrenador de √âlite con IA</p>
                    </div>
                </div>
                <div id="points-display" class="mt-4 glassmorphism inline-block px-4 py-2 rounded-full cursor-pointer">
                    <span class="font-bold text-primary"><i class="fas fa-star"></i> <span id="points-value">0</span> PTS</span>
                </div>
                <div id="daily-missions-display" class="mt-4 glassmorphism inline-block px-4 py-2 rounded-full cursor-pointer bg-red-800/20 border-red-500/30">
                    <span class="font-bold text-red-400"><i class="fas fa-clipboard-check"></i> <span id="missions-completed">0</span>/<span id="missions-total">0</span> Misiones</span>
                </div>
            </header>

            <main class="w-full max-w-4xl space-y-6">
                <a href="https://www.goatify.app" target="_blank" class="btn btn-special-glow w-full p-4 rounded-lg font-bold text-lg fade-in" style="animation-delay: 0.1s;">
                    <i class="fas fa-rocket mr-3"></i> <span>Organiza tu Vida con Goatify</span>
                </a>
                
                <div class="glassmorphism p-6 rounded-2xl fade-in" style="animation-delay: 0.2s;">
                    <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-fire text-primary mr-3"></i><span data-translate-key="mission_title">Tu Misi√≥n de Hoy</span></h2>
                    <div id="workout-of-the-day" class="text-center p-6 bg-secondary rounded-lg">
                        <p class="text-text-secondary" data-translate-key="mission_placeholder">Usa el Laboratorio de Entrenamiento o pide una rutina a la IA para empezar.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glassmorphism p-6 rounded-2xl fade-in" style="animation-delay: 0.4s;">
                        <h2 class="text-2xl font-bold mb-4"><i class="fas fa-comments text-primary mr-3"></i><span data-translate-key="ia_prompt_title">Pide tu Rutina a la IA</span></h2>
                        <textarea id="user-prompt" class="w-full h-24 p-4 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none resize-none" data-translate-key="ia_prompt_placeholder" placeholder="Ej: 'Quiero una rutina de 45 mins en el gimnasio para espalda y b√≠ceps'"></textarea>
                        <div class="flex gap-2 mt-2">
                            <button class="ai-modifier-btn btn btn-secondary flex-1 text-sm" data-modifier="sin equipo" data-original-text-key="ai_modifier_no_equipment" data-original-icon-class="fas fa-ban"><i class="fas fa-ban mr-1"></i> <span data-translate-key="ai_modifier_no_equipment">Sin Equipo</span></button>
                        </div>
                        <button id="generate-btn" class="btn btn-primary btn-glow w-full p-4 rounded-lg font-bold text-lg mt-4" data-original-text-key="ia_prompt_button" data-original-icon-class="fas fa-cogs">
                            <i class="fas fa-cogs mr-2"></i> <span data-translate-key="ia_prompt_button">Crear con IA</span>
                        </button>
                    </div>
                    <div class="glassmorphism p-6 rounded-2xl fade-in" style="animation-delay: 0.6s;">
                        <h2 class="text-2xl font-bold mb-4"><i class="fas fa-flask text-primary mr-3"></i><span data-translate-key="lab_title">Laboratorio de Entrenamiento</span></h2>
                        <p class="text-text-secondary mb-4" data-translate-key="lab_description">Elige un modo de entrenamiento o un desaf√≠o espec√≠fico.</p>
                        <button id="open-lab-btn" class="btn btn-secondary btn-glow w-full p-4 rounded-lg font-bold text-lg mt-4">
                            <i class="fas fa-arrow-right mr-2"></i> <span data-translate-key="lab_button">Ir al Laboratorio</span>
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <div id="lab-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="lab_title">Workout Lab</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl mx-auto">
                <div class="mb-8 fade-in">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="tools_title">Herramientas de Precisi√≥n</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="timer-type-selection">
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="stopwatch" data-original-text-key="tool_stopwatch" data-original-icon-class="fas fa-stopwatch"><i class="fas fa-stopwatch text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_stopwatch">Cron√≥metro</span></button>
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="timer" data-original-text-key="tool_timer" data-original-icon-class="fas fa-hourglass-half"><i class="fas fa-hourglass-half text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_timer">Temporizador</span></button>
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="tabata" data-original-text-key="tool_tabata" data-original-icon-class="fas fa-bolt"><i class="fas fa-bolt text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_tabata">T√°bata</span></button>
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="rounds" data-original-text-key="tool_rounds" data-original-icon-class="fas fa-sync-alt"><i class="fas fa-sync-alt text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_rounds">Rondas</span></button>
                    </div>
                </div>
                <div class="fade-in" style="animation-delay: 0.2s;">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="challenges_title">Desaf√≠os R√°pidos</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button class="challenge-btn btn btn-secondary p-6 rounded-lg text-left" data-challenge="abs" data-original-text-key="challenge_abs_title" data-original-icon-class="üî•">
                            <h3 class="text-xl font-bold text-primary" data-translate-key="challenge_abs_title">üî• Abdomen de Acero</h3>
                            <p class="text-sm text-text-secondary mt-1" data-translate-key="challenge_abs_desc">Un reto r√°pido y brutal de 10 minutos para fortalecer tu core.</p>
                        </button>
                        <button class="challenge-btn btn btn-secondary p-6 rounded-lg text-left" data-challenge="plank" data-original-text-key="challenge_plank_title" data-original-icon-class="‚è≥">
                            <h3 class="text-xl font-bold text-primary" data-translate-key="challenge_plank_title">‚è≥ Plank Challenge</h3>
                            <p class="text-sm text-text-secondary mt-1" data-translate-key="challenge_plank_desc">¬øCu√°nto puedes aguantar? Un test de resistencia en plancha.</p>
                        </button>
                        <button class="challenge-btn btn btn-secondary p-6 rounded-lg text-left" data-challenge="pushups" data-original-text-key="challenge_pushups_title" data-original-icon-class="üí™">
                            <h3 class="text-xl font-bold text-primary" data-translate-key="challenge_pushups_title">üí™ Desaf√≠o de Flexiones</h3>
                            <p class="text-sm text-text-secondary mt-1" data-translate-key="challenge_pushups_desc">M√°ximas flexiones en 5 series. ¬°Apunta a la fatiga muscular!</p>
                        </button>
                        <button class="challenge-btn btn btn-secondary p-6 rounded-lg text-left" data-challenge="pullups" data-original-text-key="challenge_pullups_title" data-original-icon-class="üßó">
                            <h3 class="text-xl font-bold text-primary" data-translate-key="challenge_pullups_title">üßó Desaf√≠o de Barras</h3>
                            <p class="text-sm text-text-secondary mt-1" data-translate-key="challenge_pullups_desc">Un test de fuerza de espalda y b√≠ceps. ¬øCu√°ntas dominadas logras?</p>
                        </button>
                    </div>
                </div>
            </main>
        </div>
        
        <div id="timer-tool-screen" class="screen items-center justify-center">
             <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto absolute top-0 left-1/2 -translate-x-1/2">
                <button class="back-to-lab-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 id="timer-tool-title" class="text-3xl font-black text-primary">Herramienta</h1>
                <div class="w-24 text-2xl font-black">goati<span class="text-primary">FIT</span></div>
            </header>
            <main class="w-full max-w-md flex flex-col items-center justify-center text-center h-full">
                <div id="timer-config-container" class="w-full mb-8">
                    <div id="timer-config" class="hidden w-full space-y-4">
                        <h3 class="text-xl font-bold">Configurar Tiempo</h3>
                        <div class="flex gap-4 justify-center">
                            <input id="timer-minutes" type="number" class="w-24 p-3 text-2xl text-center rounded-lg" placeholder="00" min="0" max="59">
                            <span class="text-4xl font-bold">:</span>
                            <input id="timer-seconds" type="number" class="w-24 p-3 text-2xl text-center rounded-lg" placeholder="00" min="0" max="59">
                        </div>
                    </div>
                    <div id="tabata-config" class="hidden w-full space-y-4">
                        <h3 class="text-xl font-bold">Configurar T√°bata</h3>
                         <div class="grid grid-cols-2 gap-4">
                            <div><label for="tabata-work" class="font-bold">Trabajo (seg)</label><input id="tabata-work" type="number" class="w-full mt-1 p-3 text-center rounded-lg" value="20"></div>
                            <div><label for="tabata-rest" class="font-bold">Descanso (seg)</label><input id="tabata-rest" type="number" class="w-full mt-1 p-3 text-center rounded-lg" value="10"></div>
                            <div class="col-span-2"><label for="tabata-rounds" class="font-bold">Rondas</label><input id="tabata-rounds" type="number" class="w-full mt-1 p-3 text-center rounded-lg" value="8"></div>
                         </div>
                    </div>
                    <div id="rounds-config" class="hidden w-full space-y-4">
                        <h3 class="text-xl font-bold">Configurar Rondas</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="rounds-target" class="font-bold">Rondas Objetivo</label><input id="rounds-target" type="number" class="w-full mt-1 p-3 text-center rounded-lg" placeholder="10"></div>
                            <div><label for="rounds-rest" class="font-bold">Descanso (seg)</label><input id="rounds-rest" type="number" class="w-full mt-1 p-3 text-center rounded-lg" placeholder="60"></div>
                        </div>
                        <p class="text-text-secondary text-sm pt-4">Usa el bot√≥n grande para contar repeticiones manualmente.</p>
                    </div>
                </div>

                <div id="timer-tool-display-area" class="text-center mb-8 flex-grow flex flex-col justify-center items-center">
                    <div id="timer-tool-phase" class="text-3xl font-bold uppercase tracking-widest text-primary mb-2"></div>
                    <div id="timer-tool-display" class="text-8xl md:text-9xl font-black">00:00.00</div>
                    <div id="timer-tool-rounds-display" class="text-2xl font-semibold mt-2"></div>
                    <div id="lap-times-container" class="mt-4 w-full max-h-40 overflow-y-auto custom-scrollbar hidden">
                        <h4 class="text-lg font-bold text-primary mb-2">Vueltas:</h4>
                        <ul id="lap-times-list" class="list-none p-0 m-0 text-sm"></ul>
                    </div>
                </div>
                
                <div id="timer-tool-controls" class="flex gap-4">
                    <button id="timer-tool-start" class="btn btn-primary w-32 p-4 rounded-lg font-bold text-lg"><i class="fas fa-play mr-2"></i> Iniciar</button>
                    <button id="timer-tool-pause" class="btn btn-secondary w-32 p-4 rounded-lg font-bold text-lg hidden"><i class="fas fa-pause mr-2"></i> Pausar</button>
                    <button id="timer-tool-reset" class="btn btn-danger bg-danger w-32 p-4 rounded-lg font-bold text-lg"><i class="fas fa-sync-alt mr-2"></i> Reset</button>
                    <button id="timer-tool-lap" class="btn btn-info bg-info w-32 p-4 rounded-lg font-bold text-lg hidden"><i class="fas fa-flag mr-2"></i> Vuelta</button>
                </div>
                <div id="rounds-counter-control" class="hidden flex flex-col items-center gap-4">
                     <button id="round-counter-btn" class="btn btn-primary rounded-full w-48 h-48 text-6xl font-black">0</button>
                     <button id="round-next-btn" class="btn btn-success bg-success w-48 p-3 rounded-lg font-bold text-lg"><i class="fas fa-forward-step mr-2"></i> Siguiente Ronda</button>
                </div>
            </main>
        </div>

        <div id="workout-screen" class="screen justify-between">
            <header class="w-full flex justify-between items-center flex-shrink-0 pt-4 max-w-2xl mx-auto">
                <h2 id="workout-title" class="text-xl md:text-2xl font-bold truncate"></h2>
                <button id="exit-workout-btn" class="btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-times mr-2"></i> <span data-translate-key="exit_button">Salir</span></button>
            </header>
            <main class="flex flex-col items-center justify-center flex-grow text-center w-full max-w-2xl relative">
                <div id="exercise-info" class="w-full">
                    <p id="current-exercise" class="text-3xl md:text-4xl font-bold"></p>
                    <p id="next-exercise" class="text-lg md:text-xl text-text-secondary mt-2"></p>
                </div>
                <div class="relative w-64 h-64 md:w-80 md:h-80 flex items-center justify-center my-4">
                    <div class="absolute w-full h-full bg-secondary rounded-full opacity-50"></div>
                    <svg class="absolute w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-700" stroke-width="5" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="workout-progress-circle" class="timer-circle-progress" stroke-width="5" stroke-linecap="round" stroke="var(--primary)" fill="transparent" r="45" cx="50" cy="50" transform="rotate(-90 50 50)" />
                    </svg>
                    <div id="workout-timer-ring" class="z-10 text-center flex flex-col items-center justify-center w-[calc(100%-40px)] h-[calc(100%-40px)] rounded-full border-8 border-transparent transition-colors duration-500 bg-dark">
                        <p id="workout-phase-label" class="text-xl md:text-2xl font-bold uppercase tracking-widest"></p>
                        <p id="workout-timer-display" class="text-7xl md:text-8xl font-black"></p>
                    </div>
                </div>
                <div id="how-to-container" class="w-full max-w-md glassmorphism p-4 rounded-lg hidden">
                    <h4 class="text-lg font-bold text-primary mb-2"><i class="fas fa-lightbulb mr-2"></i><span data-translate-key="how_to_title">C√≥mo Hacerlo</span>:</h4>
                    <ol id="how-to-steps" class="text-left list-decimal list-inside space-y-1 text-sm"></ol>
                </div>
            </main>
            <footer class="w-full flex justify-center items-center gap-4 flex-shrink-0 pb-4">
                <button id="prev-btn" class="btn btn-secondary p-4 rounded-full w-16 h-16 text-2xl"><i class="fas fa-backward-step"></i></button>
                <button id="play-pause-btn" class="btn btn-primary btn-glow p-4 rounded-full w-24 h-24 text-4xl"><i class="fas fa-play ml-1"></i></button>
                <button id="next-btn" class="btn btn-secondary p-4 rounded-full w-16 h-16 text-2xl"><i class="fas fa-forward-step"></i></button>
                <button id="beast-mode-btn" class="btn btn-secondary p-4 rounded-full w-16 h-16 text-2xl text-danger border-danger" data-translate-key="beast_mode_button_title" title="Modo Bestia: A√±ade un finisher intenso"><i class="fas fa-skull-crossbones"></i></button>
            </footer>
        </div>

        <div id="post-workout-screen" class="screen fullscreen items-center justify-center text-center bg-gray-900 overflow-hidden">
            <div id="visualizer-canvas-container" class="absolute inset-0 w-full h-full">
                <canvas id="visualizer-canvas" class="w-full h-full"></canvas>
            </div>
            <div class="relative z-10 p-4">
                <h1 id="visualizer-title" class="text-3xl font-bold text-white mb-4"></h1>
                <p id="visualizer-message" class="text-xl text-gray-300"></p>
                <button id="exit-visualizer-btn" class="btn btn-primary mt-8 px-8 py-3 rounded-lg font-bold">
                    <i class="fas fa-check-circle mr-2"></i><span>Terminar</span>
                </button>
            </div>
        </div>

        <div id="offline-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="offline_title">Modo Offline</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl flex-grow mx-auto space-y-6">
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="create_own_title">Crea tu Propia Rutina</h2>
                    <p class="text-text-secondary mb-4" data-translate-key="create_own_desc">Dise√±a tu entrenamiento perfecto y gu√°rdalo para acceder sin conexi√≥n.</p>
                    <div class="space-y-4">
                        <input type="text" id="new-routine-name" class="w-full p-3 rounded-lg" placeholder="Nombre de la rutina (ej: Lunes de Pecho)">
                        <textarea id="new-routine-exercises" class="w-full h-32 p-3 rounded-lg" placeholder="Ejercicios y series (ej: 4x12 Press Banca, 3x15 Aperturas, 4x10 Flexiones)"></textarea>
                        <button id="save-custom-routine-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold"><i class="fas fa-save mr-2"></i> Guardar Rutina</button>
                    </div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="offline_desc">Rutinas sin Conexi√≥n</h2>
                    <p class="text-text-secondary mb-4" data-translate-key="offline_info">Accede a una biblioteca de entrenamientos precargados, perfectos para cuando no tienes internet.</p>
                    <div id="offline-routines-list" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                        </div>
                </div>
            </main>
        </div>

        <div id="data-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="data_title">Mis Datos</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-6">
                    <div class="glassmorphism p-6 rounded-2xl">
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-weight-scale text-primary mr-3"></i>Datos F√≠sicos</h2>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="input-weight" class="font-bold" data-translate-key="data_weight">Peso (kg)</label>
                                    <input id="input-weight" type="number" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="e.g., 75.5">
                                </div>
                                <div>
                                    <label for="input-height" class="font-bold" data-translate-key="data_height">Altura (cm)</label>
                                    <input id="input-height" type="number" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="e.g., 170">
                                </div>
                            </div>
                            <div>
                                <label for="input-bmi" class="font-bold" data-translate-key="data_bmi">IMC</label>
                                <input id="input-bmi" type="text" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="Calculado autom√°ticamente" readonly>
                            </div>
                            <div>
                                <label for="input-sleep" class="font-bold" data-translate-key="data_sleep_hours">Horas de Sue√±o (hoy)</label>
                                <input id="input-sleep" type="number" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="e.g., 7.5">
                            </div>
                             <div>
                                <label class="font-bold" data-translate-key="data_water_liters">Agua (litros hoy)</label>
                                <input id="input-water" type="number" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="e.g., 2.5">
                            </div>
                        </div>
                    </div>
                     <div class="glassmorphism p-6 rounded-2xl">
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-ruler-combined text-primary mr-3"></i>Medidas Corporales (√∫nica vez)</h2>
                        <input id="input-measures" type="text" class="w-full mt-1 p-3 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="cintura:75, b√≠ceps:35">
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="glassmorphism p-6 rounded-2xl">
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-smile text-primary mr-3"></i>Estado de √Ånimo (hoy)</h2>
                        <div id="energy-tracker" class="flex justify-around mt-2">
                            </div>
                    </div>
                </div>
                <div class="md:col-span-2 space-y-6">
                    <button id="save-data-btn" class="btn btn-primary w-full p-4 rounded-lg font-bold text-lg"><i class="fas fa-save mr-2"></i><span data-translate-key="data_save_button">Guardar Datos de Hoy</span></button>
                    <button id="analyze-data-btn" class="btn btn-secondary w-full p-4 rounded-lg font-bold text-lg"><i class="fas fa-brain mr-2"></i><span data-translate-key="data_analyze_button">Analizar Mis Datos con IA</span></button>
                </div>
            </main>
        </div>
        
        <div id="sleep-screen" class="screen fullscreen items-center justify-center text-center bg-gray-900">
            <div class="absolute top-4 right-4">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-times"></i></button>
            </div>
            <div id="sleep-main-content">
                <div class="relative flex items-center justify-center w-64 h-64">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div id="sleep-clock" class="text-6xl font-black"></div>
                    </div>
                    <div class="breathing-circle-anim absolute w-full h-full bg-blue-500/30 rounded-full"></div>
                    <div class="breathing-circle-anim absolute w-3/4 h-3/4 bg-blue-500/40 rounded-full" style="animation-delay: -2s;"></div>
                    <div class="breathing-circle-anim absolute w-1/2 h-1/2 bg-blue-500/50 rounded-full" style="animation-delay: -4s;"></div>
                </div>
                <h1 class="text-3xl font-bold text-white mt-8" data-translate-key="sleep_title">M√≥dulo de Sue√±o</h1>
                <p class="text-gray-300 mt-2" data-translate-key="sleep_desc">Rel√°jate y prep√°rate para un descanso profundo.</p>
                <div class="mt-8 space-y-4 w-full max-w-xs">
                    <div class="flex justify-center gap-4">
                        <button class="sleep-sound-btn btn btn-secondary p-4 rounded-lg" data-sound="brown" title="Ruido Marr√≥n"><i class="fas fa-wind text-2xl"></i></button>
                        <button class="sleep-sound-btn btn btn-secondary p-4 rounded-lg" data-sound="rain" title="Lluvia"><i class="fas fa-cloud-rain text-2xl"></i></button>
                        <button class="sleep-sound-btn btn btn-secondary p-4 rounded-lg" data-sound="forest" title="Bosque"><i class="fas fa-tree text-2xl"></i></button>
                    </div>
                    <div class="relative">
                        <input type="range" id="sleep-timer-slider" min="0" max="120" value="0" class="w-full">
                        <div id="sleep-timer-active-indicator" class="timer-active-indicator hidden"></div>
                    </div>
                    <p class="text-white"><span data-translate-key="sleep_timer_label">Timer</span>: <span id="sleep-timer-value">Off</span></p>
                    <button id="toggle-sleep-sound-btn" class="btn btn-primary w-full p-4 rounded-full font-bold">
                        <i class="fas fa-play mr-2"></i><span data-translate-key="sleep_start_button">Iniciar Sonido</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="wellness-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="wellness_title">Centro de Bienestar</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl flex-grow mx-auto">
                 <div class="grid grid-cols-3 gap-4 md:gap-6">
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="breathing">
                        <i class="fas fa-lungs text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Respiraci√≥n</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="mobility">
                        <i class="fas fa-person-walking text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Movilidad</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="reflection">
                        <i class="fas fa-lightbulb text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Reflexi√≥n</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="stress">
                        <i class="fas fa-brain text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Anti-Estr√©s</span>
                    </button>
                     <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="ice">
                        <i class="fas fa-snowflake text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Terapia Hielo</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="intimate">
                        <i class="fas fa-heart text-4xl mb-2"></i><span class="font-semibold text-center text-sm">B. √çntimo</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="supplements">
                        <i class="fas fa-pills text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Suplementos</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-2xl flex flex-col items-center justify-center aspect-square" data-action="sleep">
                        <i class="fas fa-moon text-4xl mb-2"></i><span class="font-semibold text-center text-sm">Sue√±o</span>
                    </button>
                </div>
            </main>
        </div>
        
        <div id="breathing-screen" class="screen fullscreen items-center justify-center text-center">
             <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto absolute top-0 left-1/2 -translate-x-1/2">
                <button class="back-to-wellness-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="wellness_breathing_title">Respiraci√≥n Guiada</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-md flex flex-col items-center justify-center text-center">
                <div id="breathing-circle" class="relative w-64 h-64 mx-auto my-4 flex items-center justify-center">
                    <svg class="absolute w-full h-full" viewBox="0 0 100 100">
                        <circle id="breathing-visual-circle" stroke-width="5" stroke-linecap="round" stroke="var(--info)" fill="transparent" r="45" cx="50" cy="50" style="transform: scale(0.8); transform-origin: 50% 50%;"></circle>
                    </svg>
                    <i id="breathing-icon" class="fas fa-lungs text-6xl text-white z-10"></i>
                </div>
                <p id="breathing-instruction" class="text-2xl font-bold h-10"></p>
                <div class="flex justify-center gap-4 mt-8">
                    <button id="start-calm-breathing-btn" data-type="calm" class="btn btn-primary px-6 py-3"><i class="fas fa-play mr-2"></i><span data-translate-key="wellness_breathing_calm">Calma 4-7-8</span></button>
                    <button id="start-power-breathing-btn" data-type="power" class="btn btn-secondary px-6 py-3"><i class="fas fa-bolt mr-2"></i><span data-translate-key="wellness_breathing_power">Poder</span></button>
                    <button id="start-relax-breathing-btn" data-type="relax" class="btn btn-secondary px-6 py-3"><i class="fas fa-leaf mr-2"></i><span data-translate-key="wellness_breathing_relax">Relajaci√≥n</span></button>
                </div>
            </main>
        </div>


        <div id="progress-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="progress_title">Mi Progreso</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl flex-grow mx-auto space-y-8">
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-between">
                        <span data-translate-key="progress_weekly_title">Actividad Semanal</span>
                        <button class="info-btn text-primary text-lg" data-info="weekly"><i class="fas fa-info-circle"></i></button>
                    </h2>
                    <div id="weekly-chart" class="flex flex-col sm:flex-row justify-around items-center p-4 text-center space-y-4 sm:space-y-0 sm:space-x-2 md:space-x-4">
                        <div class="flex-1 w-full sm:w-auto">
                            <div class="circle-progress-container">
                                <svg class="circle-progress-svg" viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" class="circle-bg"></circle>
                                    <circle id="minutes-circle" cx="60" cy="60" r="54" class="circle-progress" style="stroke-dasharray: 340; stroke-dashoffset: 340;"></circle>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <p id="total-minutes" class="text-3xl font-black">0</p>
                                    <p class="text-xs md:text-sm text-text-secondary">MINUTOS</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 w-full sm:w-auto">
                            <div class="circle-progress-container">
                                <svg class="circle-progress-svg" viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" class="circle-bg"></circle>
                                    <circle id="routines-circle" cx="60" cy="60" r="54" class="circle-progress" style="stroke-dasharray: 340; stroke-dashoffset: 340;"></circle>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <p id="total-routines" class="text-3xl font-black">0</p>
                                    <p class="text-xs md:text-sm text-text-secondary">RUTINAS</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 w-full sm:w-auto">
                            <div class="circle-progress-container">
                                <svg class="circle-progress-svg" viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" class="circle-bg"></circle>
                                    <circle id="calories-circle" cx="60" cy="60" r="54" class="circle-progress" style="stroke-dasharray: 340; stroke-dashoffset: 340;"></circle>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <p id="total-calories" class="text-3xl font-black">0</p>
                                    <p class="text-xs md:text-sm text-text-secondary">CALOR√çAS</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 w-full sm:w-auto">
                            <div class="circle-progress-container">
                                <svg class="circle-progress-svg" viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" class="circle-bg"></circle>
                                    <circle id="total-workouts-circle" cx="60" cy="60" r="54" class="circle-progress" style="stroke-dasharray: 340; stroke-dashoffset: 340;"></circle>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <p id="total-workouts" class="text-3xl font-black">0</p>
                                    <p class="text-xs md:text-sm text-text-secondary">ENTRENOS</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="glassmorphism p-4 rounded-lg text-center mt-6">
                        <h3 class="text-xl font-bold text-primary mb-2">Racha de Entrenamientos</h3>
                        <p id="workout-streak" class="text-4xl font-black">0 <i class="fas fa-fire text-orange-400"></i></p>
                        <p class="text-sm text-text-secondary">D√≠as consecutivos</p>
                    </div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-gift text-primary mr-3"></i>Recompensas
                    </h2>
                    <div id="rewards-grid" class="space-y-4"></div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-between">
                        <span data-translate-key="body_map_title">M√∫sculos Trabajados</span>
                        <button class="info-btn text-primary text-lg" data-info="bodymap"><i class="fas fa-info-circle"></i></button>
                    </h2>
                    <div id="body-map-container" class="w-full max-w-sm mx-auto relative grid grid-cols-2 gap-4">
                        </div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-between">
                        <span data-translate-key="progress_achievements_title">Logros</span>
                        <button class="info-btn text-primary text-lg" data-info="achievements"><i class="fas fa-info-circle"></i></button>
                    </h2>
                    <div id="achievements-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4 text-center"></div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold" data-translate-key="progress_history_title">Historial de Actividad</h2>
                        <button id="analyze-history-btn" class="btn btn-primary text-sm px-3 py-1"><i class="fas fa-brain mr-2"></i>Analizar</button>
                    </div>
                    <div id="workout-history-list" class="space-y-3 max-h-64 overflow-y-auto custom-scrollbar pr-2"></div>
                </div>
            </main>
        </div>

        <div id="settings-screen" class="screen items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="settings_title">Ajustes</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-md flex-grow mx-auto space-y-6">
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="settings_notifications_title">Notificaciones</h2>
                    <div id="notifications-list" class="space-y-4"></div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold" data-translate-key="settings_alarms_title">Alarmas</h2>
                        <button id="add-alarm-btn" class="btn btn-primary p-2 rounded-lg w-10 h-10"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="alarms-list" class="space-y-3"></div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="settings_theme_title">Tema</h2>
                    <div class="flex justify-between items-center">
                        <span class="font-bold" data-translate-key="settings_theme_label">Modo Oscuro/Claro</span>
                        <label class="switch">
                            <input type="checkbox" id="theme-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="settings_language_title">Idioma</h2>
                    <div class="flex justify-between items-center">
                        <span class="font-bold" data-translate-key="settings_language_label">Seleccionar Idioma</span>
                        <select id="language-select" class="p-2 rounded-lg bg-secondary text-text-primary">
                            <option value="es">Espa√±ol</option>
                            </select>
                    </div>
                </div>
            </main>
        </div>
        
        <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
            <div id="modal-content-wrapper" class="glassmorphism rounded-2xl w-full max-w-lg p-6 relative transform scale-95 transition-transform duration-300">
                <button id="close-modal-btn" class="absolute top-4 right-4 text-text-secondary hover:text-primary text-2xl">&times;</button>
                
                <div id="alarm-modal-content" class="hidden">
                    <h2 id="alarm-modal-title" class="text-2xl font-bold mb-4 text-primary">Nueva Alarma</h2>
                    <div class="space-y-4">
                        <input type="text" id="alarm-name" class="w-full p-3 rounded-lg" placeholder="Nombre (Ej: Tomar agua)">
                        <input type="time" id="alarm-time" class="w-full p-3 rounded-lg">
                        <div>
                            <p class="font-bold mb-2 text-left">Repetir</p>
                            <div id="alarm-day-selector" class="flex justify-between">
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="1">L</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="2">M</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="3">X</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="4">J</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="5">V</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="6">S</button>
                                <button class="day-btn btn btn-secondary rounded-full w-10 h-10" data-day="0">D</button>
                            </div>
                        </div>
                        <button id="save-alarm-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold">Guardar</button>
                    </div>
                </div>
                
                <div id="supplements-modal-content" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-primary">Asistente de Suplementos</h2>
                    <p class="text-text-secondary mb-4">Responde para obtener una recomendaci√≥n de la IA:</p>
                    <div class="space-y-4">
                        <div>
                            <label for="supplement-goal" class="font-bold">¬øCu√°l es tu objetivo principal?</label>
                            <select id="supplement-goal" class="w-full p-3 rounded-lg mt-1">
                                <option>Ganar M√∫sculo</option>
                                <option>P√©rdida de Grasa</option>
                                <option>Rendimiento</option>
                                <option>Salud General</option>
                            </select>
                        </div>
                        <button id="get-supplement-rec-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold">Obtener Recomendaci√≥n</button>
                    </div>
                </div>

                <div id="reflection-modal-content" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-primary">Shadow Tracker: Reflexi√≥n Privada</h2>
                    <div id="reflection-questions" class="space-y-3">
                        </div>
                    <button id="analyze-reflection-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold mt-6">Analizar con IA</button>
                </div>

                <div id="mobility-modal-content" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-primary">Rutinas de Movilidad</h2>
                    <p class="text-text-secondary mb-4">P√≠dele a la IA rutinas cortas para cualquier momento del d√≠a.</p>
                    <div class="grid grid-cols-3 gap-4">
                        <button class="mobility-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center" data-moment="morning">
                            <i class="fas fa-sun text-3xl mb-2 text-warning"></i>
                            <span class="font-bold">Ma√±ana</span>
                        </button>
                        <button class="mobility-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center" data-moment="break">
                            <i class="fas fa-mug-hot text-3xl mb-2 text-info"></i>
                            <span class="font-bold">Descanso</span>
                        </button>
                        <button class="mobility-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center" data-moment="night">
                            <i class="fas fa-moon text-3xl mb-2 text-primary"></i>
                            <span class="font-bold">Noche</span>
                        </button>
                    </div>
                </div>

                <div id="ice-bath-modal-content" class="hidden text-center">
                    <h2 class="text-2xl font-bold mb-2 text-info">Terapia de Hielo</h2>
                    <p class="text-text-secondary mb-4">La exposici√≥n al fr√≠o puede mejorar la recuperaci√≥n y aumentar la energ√≠a.</p>
                    <p class="font-bold">Prep√°rate...</p>
                    <div id="ice-bath-timer" class="text-7xl font-black my-2">00:30</div>
                    <button id="start-ice-bath-timer-btn" class="btn bg-info text-white w-full p-3 rounded-lg font-bold">Iniciar Timer de 30s</button>
                </div>

                <div id="intimate-wellness-modal-content" class="hidden">
                    <h2 class="text-2xl font-bold mb-2 text-danger">Bienestar √çntimo</h2>
                    <p class="text-text-secondary mb-4">Un espacio privado para registrar y entender tu energ√≠a.</p>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center bg-secondary p-3 rounded-lg">
                            <span>¬øActividad √≠ntima hoy?</span>
                             <div class="flex gap-2">
                                <button class="intimate-btn btn btn-secondary px-4 py-1" data-answer="yes">S√≠</button>
                                <button class="intimate-btn btn btn-secondary px-4 py-1 active" data-answer="no">No</button>
                            </div>
                        </div>
                        <div>
                            <label for="desire-level" class="font-bold">Nivel de deseo (1-5)</label>
                            <input type="range" id="desire-level" min="1" max="5" value="3" class="w-full mt-2">
                        </div>
                        <div id="menstrual-tracker-card" class="hidden"></div>
                        
                        <div id="menstrual-tracker-card-new">
                            <h3 class="text-xl font-bold mb-4 flex items-center text-pink-400">
                                <i class="fas fa-venus mr-3"></i><span data-translate-key="menstrual_tracker_title">Ciclo Menstrual</span>
                            </h3>
                            <div class="date-input-group">
                                <label for="last-period-date" class="font-bold text-sm text-text-secondary">√öltimo periodo:</label>
                                <input type="date" id="last-period-date" class="text-sm">
                            </div>
                            <div id="menstrual-cycle-display-new">
                                </div>
                        </div>

                    </div>
                    <button id="analyze-intimate-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold mt-6">Analizar Bienestar con IA</button>
                </div>

                <div id="beast-mode-modal-content" class="hidden text-center text-text-primary">
                    <h2 class="text-2xl font-bold mb-4 text-danger"><i class="fas fa-skull-crossbones mr-2"></i><span data-translate-key="beast_mode_modal_title">Modo Bestia</span></h2>
                    <p class="mb-6" data-translate-key="beast_mode_modal_desc">Esto a√±adir√° un finisher brutal de 60 segundos de Burpees a tu entrenamiento. ¬øAceptas el desaf√≠o?</p>
                    <div class="flex justify-center gap-4">
                        <button id="cancel-beast-mode-btn" class="btn btn-secondary px-6 py-2 font-bold" data-translate-key="cancel_button">Cancelar</button>
                        <button id="confirm-beast-mode-btn" class="btn btn-danger bg-danger px-6 py-2 font-bold" data-translate-key="beast_mode_modal_confirm">¬°Activar!</button>
                    </div>
                </div>
                <div id="info-modal-content" class="hidden text-text-primary">
                    <h2 id="info-modal-title" class="text-2xl font-bold mb-4 text-primary"></h2>
                    <div id="info-modal-body" class="max-h-[70vh] overflow-y-auto pr-4 custom-scrollbar"></div>
                </div>
                <div id="coach-modal-content" class="hidden text-center text-text-primary">
                    <div class="text-5xl mb-4">üêê</div>
                    <h2 class="text-2xl font-bold mb-2 text-primary" data-translate-key="coach_modal_title">Mensaje del Coach</h2>
                    <p id="coach-message" class="mb-6 text-lg"></p>
                    <button id="close-coach-modal-btn" class="btn btn-primary px-8 py-2 font-bold" data-translate-key="coach_modal_close">¬°Entendido!</button>
                </div>
                <div id="oracle-modal-content" class="hidden text-center text-text-primary">
                    <div class="text-5xl mb-4">üîÆ</div>
                    <h2 class="text-2xl font-bold mb-2 text-primary" data-translate-key="oracle_title">Or√°culo Fitness Diario</h2>
                    <p id="oracle-message" class="mb-6 text-lg italic"></p>
                    <button id="close-oracle-modal-btn" class="btn btn-primary px-8 py-2 font-bold" data-translate-key="coach_modal_close">¬°Entendido!</button>
                </div>
                <div id="reward-claimed-modal-content" class="hidden text-center text-text-primary">
                    <div class="text-5xl mb-4">üéÅ</div>
                    <h2 class="text-2xl font-bold mb-2 text-primary" data-translate-key="reward_claimed_title">¬°Recompensa Reclamada!</h2>
                    <p id="reward-claimed-message" class="mb-6 text-lg"></p>
                    <a id="reward-claimed-link" href="#" target="_blank" class="btn btn-primary px-8 py-2 font-bold mb-4 hidden">
                        <i class="fas fa-external-link-alt mr-2"></i><span data-translate-key="reward_claimed_action">Ir al Beneficio</span>
                    </a>
                    <button id="close-reward-claimed-modal-btn" class="btn btn-secondary px-8 py-2 font-bold" data-translate-key="coach_modal_close">Cerrar</button>
                </div>

                <div id="anti-stress-modal-content" class="hidden text-center text-text-primary">
                    <h2 class="text-2xl font-bold mb-4 text-primary">Modo Anti-Estr√©s</h2>
                    <p id="stress-instruction" class="text-lg mb-4">Conc√©ntrate en el movimiento y el sonido para calmar tu mente.</p>
                    <canvas id="stress-visualizer-canvas"></canvas> <button id="toggle-stress-sound-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold mt-4">
                        <i class="fas fa-play mr-2"></i><span>Iniciar Sonido Calmante</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <nav id="global-nav-bar" class="w-full p-2 glassmorphism">
        <div class="grid grid-cols-6 gap-1 text-center text-xs">
            <button class="nav-btn" data-screen="dashboard-screen"><i class="fas fa-home text-2xl"></i><span data-translate-key="nav_dashboard">Inicio</span></button>
            <button class="nav-btn" data-screen="progress-screen"><i class="fas fa-trophy text-2xl"></i><span data-translate-key="nav_progress">Progreso</span></button>
            <button class="nav-btn" data-screen="data-screen"><i class="fas fa-chart-line text-2xl"></i><span data-translate-key="nav_data">Datos</span></button>
            <button class="nav-btn" data-screen="wellness-screen"><i class="fas fa-spa text-2xl"></i><span data-translate-key="nav_wellness">Bienestar</span></button>
            <button class="nav-btn" data-screen="offline-screen"><i class="fas fa-wifi text-2xl"></i><span data-translate-key="nav_offline">Offline</span></button>
            <button class="nav-btn" data-screen="settings-screen"><i class="fas fa-cog text-2xl"></i><span data-translate-key="nav_settings">Ajustes</span></button>
        </div>
    </nav>
    
    <div id="tooltip"></div>
    <div id="toast-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DICTIONARY FOR i18n ---
            const translations = {
                es: {
                    nav_dashboard: "Inicio",
                    main_title: "goati<span class='text-primary'>FIT</span>",
                    subtitle: "Tu Entrenador de √âlite con IA",
                    nav_progress: "Progreso",
                    nav_data: "Datos",
                    nav_wellness: "Bienestar",
                    nav_sleep: "Sue√±o",
                    nav_offline: "Offline",
                    nav_settings: "Ajustes",
                    mission_title: "Tu Misi√≥n de Hoy",
                    mission_placeholder: "Usa el Laboratorio de Entrenamiento o pide una rutina a la IA para empezar.",
                    ia_prompt_title: "Pide tu Rutina a la IA",
                    ia_prompt_placeholder: "Ej: 'Quiero una rutina de 45 mins en el gimnasio para espalda y b√≠ceps'",
                    ia_prompt_button: "Crear con IA",
                    ai_modifier_no_equipment: "Sin Equipo",
                    lab_title: "Laboratorio de Entrenamiento",
                    lab_description: "Elige un modo de entrenamiento o un desaf√≠o espec√≠fico.",
                    lab_button: "Ir al Laboratorio",
                    back_button: "Volver",
                    tools_title: "Herramientas de Precisi√≥n",
                    tool_stopwatch: "Cron√≥metro",
                    tool_timer: "Temporizador",
                    tool_tabata: "T√°bata",
                    tool_rounds: "Rondas",
                    challenges_title: "Desaf√≠os R√°pidos",
                    challenge_abs_title: "üî• Abdomen de Acero",
                    challenge_abs_desc: "Un reto r√°pido y brutal de 10 minutos para fortalecer tu core.",
                    challenge_plank_title: "‚è≥ Plank Challenge",
                    challenge_plank_desc: "¬øCu√°nto puedes aguantar? Un test de resistencia en plancha.",
                    challenge_pushups_title: "üí™ Desaf√≠o de Flexiones",
                    challenge_pushups_desc: "M√°ximas flexiones en 5 series. ¬°Apunta a la fatiga muscular!",
                    challenge_pullups_title: "üßó Desaf√≠o de Barras",
                    challenge_pullups_desc: "Un test de fuerza de espalda y b√≠ceps. ¬øCu√°ntas dominadas logras?",
                    challenge_abs_prompt: "una rutina de 10 minutos para abdomen",
                    challenge_plank_prompt: "una rutina basada en aguantar en plancha el m√°ximo tiempo posible",
                    challenge_pushups_prompt: "una rutina de 5 series de flexiones hasta el fallo",
                    challenge_pullups_prompt: "una rutina de 5 series de dominadas hasta el fallo",
                    exit_button: "Salir",
                    how_to_title: "C√≥mo Hacerlo",
                    beast_mode_button_title: "Modo Bestia: A√±ade un finisher intenso",
                    beast_mode_activated_alert: "¬°MODO BESTIA ACTIVADO! Se ha a√±adido un finisher brutal.",
                    beast_mode_modal_title: "Modo Bestia",
                    beast_mode_modal_desc: "Esto a√±adir√° un finisher brutal de 60 segundos de Burpees a tu entrenamiento. ¬øAceptas el desaf√≠o?",
                    beast_mode_modal_confirm: "¬°Activar!",
                    cancel_button: "Cancelar",
                    next_exercise_prefix: "Siguiente",
                    last_exercise_text: "¬°√öltimo ejercicio!",
                    workout_complete_title: "¬°Completado!",
                    workout_complete_subtitle: "¬°Excelente Trabajo!",
                    post_workout_title_calm: "Buen trabajo. Hoy tu cuerpo agradece la calma.",
                    post_workout_title_hard: "Has dado todo. La fuerza de hoy es el h√°bito de ma√±ana.",
                    phase_prep: "PREP√ÅRATE",
                    phase_work: "TRABAJO",
                    phase_rest: "DESCANSO",
                    phase_cooldown: "ENFRIAMIENTO",
                    generating_routine: "Generando tu rutina de √©lite...",
                    system_prompt_base: `Eres "GoatiFit AI", un entrenador personal de √©lite. Crea una rutina de ejercicios en JSON. NUNCA respondas con texto conversacional, solo el JSON. Para cada fase de 'work', incluye un array "howTo" con 2-4 instrucciones cortas, paso a paso, en espa√±ol. Si el usuario pide "sin equipo", aseg√∫rate de que todos los ejercicios sean de peso corporal. Si el usuario especifica equipo, usa ese equipo. Si el usuario no especifica equipo, asume que tiene acceso a un gimnasio b√°sico. Formato JSON requerido:`,
                    data_title: "Mis Datos",
                    data_input_title: "Registro Diario",
                    data_weight: "Peso (kg)",
                    data_height: "Altura (cm)",
                    data_bmi: "IMC",
                    data_measures: "Medidas",
                    data_energy: "Energ√≠a Hoy",
                    data_sleep_hours: "Horas de Sue√±o",
                    data_water_liters: "Agua (litros)",
                    data_save_button: "Guardar Datos de Hoy",
                    data_analyze_button: "Analizar Mis Datos con IA",
                    history_analysis_title: "An√°lisis del Historial",
                    history_analysis_prompt: "Analiza mi historial de entrenamiento de las √∫ltimas 2 semanas y dame 3 consejos. Enf√≥cate en consistencia, grupos musculares trabajados (¬øhay desbalances?) y sugiere c√≥mo podr√≠a mejorar. S√© directo y motivador. Mi historial (fecha, t√≠tulo, duraci√≥n en min, m√∫sculos):",
                    menstrual_tracker_title: "Ciclo Menstrual",
                    menstrual_phase_menstrual: "Fase Menstrual",
                    menstrual_phase_menstrual_desc: "Energ√≠a baja. Prioriza descanso y ejercicios suaves como yoga o caminatas.",
                    menstrual_phase_follicular: "Fase Folicular",
                    menstrual_phase_follicular_desc: "Energ√≠a en aumento. Buen momento para entrenamientos de fuerza y cardio intenso.",
                    menstrual_phase_ovulation: "Fase de Ovulaci√≥n",
                    menstrual_phase_ovulation_desc: "Pico de energ√≠a. Ideal para entrenamientos de alta intensidad y levantar pesado.",
                    menstrual_phase_luteal: "Fase L√∫tea",
                    menstrual_phase_luteal_desc: "La energ√≠a disminuye. Enf√≥cate en cardio moderado y ejercicios de resistencia.",
                    sleep_title: "M√≥dulo de Sue√±o",
                    sleep_desc: "Rel√°jate y prep√°rate para un descanso profundo.",
                    sleep_start_button: "Iniciar Sonido",
                    sleep_stop_button: "Detener Sonido",
                    sleep_timer_label: "Apagar en",
                    wellness_title: "Centro de Bienestar",
                    wellness_breathing_title: "Respiraci√≥n Guiada",
                    wellness_breathing_calm: "Calma 4-7-8",
                    wellness_breathing_power: "Poder",
                    wellness_breathing_relax: "Relajaci√≥n",
                    wellness_breathe_in: "Inhala...",
                    wellness_breathe_hold: "Sost√©n...",
                    wellness_breathe_out: "Exhala...",
                    mobility_prompt_morning: "una rutina de movilidad de 5 minutos para despertar el cuerpo por la ma√±ana",
                    mobility_prompt_break: "una rutina de estiramiento de 5 minutos para un descanso activo en la oficina",
                    mobility_prompt_night: "una rutina de estiramiento y relajaci√≥n de 5 minutos para antes de dormir",
                    sexual_wellness_tips_prompt: "Dame 3 consejos cortos y pr√°cticos sobre bienestar sexual y conexi√≥n corporal para un atleta.",
                    progress_title: "Mi Progreso",
                    progress_weekly_title: "Actividad Semanal",
                    body_map_title: "M√∫sculos Trabajados",
                    progress_achievements_title: "Logros",
                    progress_history_title: "Historial de Actividad",
                    achievement_first_workout_name: "Primer Paso",
                    achievement_first_workout_desc: "Completa tu primer entrenamiento.",
                    achievement_seven_day_streak_name: "Imparable",
                    achievement_seven_day_streak_desc: "Entrena 7 d√≠as seguidos.",
                    achievement_beast_mode_name: "Modo Bestia",
                    achievement_beast_mode_desc: "Activa y completa un finisher Modo Bestia.",
                    achievement_perfect_week_name: "Semana Perfecta",
                    achievement_perfect_week_desc: "Entrena todos los d√≠as de la semana.",
                    info_weekly_title: "Tu Actividad Semanal",
                    info_weekly_desc: "Este gr√°fico muestra los minutos totales que has entrenado cada d√≠a de la semana actual. ¬°Intenta mantener la constancia para ver c√≥mo crecen las barras!",
                    info_achievements_title: "Tus Logros",
                    info_achievements_desc: "Estos son los hitos que has desbloqueado. Los logros en color est√°n completados, mientras que los grises son tu pr√≥ximo objetivo. ¬°A por ellos!",
                    info_bodymap_title: "Mapa Corporal de M√∫sculos",
                    info_bodymap_desc: "Este mapa te muestra qu√© grupos musculares has trabajado en tus √∫ltimos entrenamientos. El color m√°s intenso indica un mayor volumen de trabajo. ¬°Pasa el rat√≥n por encima para ver el nombre del m√∫sculo!",
                    settings_title: "Ajustes",
                    settings_notifications_title: "Notificaciones",
                    settings_alarms_title: "Alarmas",
                    settings_theme_title: "Tema",
                    settings_theme_label: "Modo Oscuro/Claro",
                    settings_language_title: "Idioma",
                    settings_language_label: "Seleccionar Idioma",
                    notification_reminder_stand: "Recordatorio para levantarse",
                    notification_reminder_water: "Recordatorio para tomar agua",
                    notification_reminder_sleep: "Recordatorio para dormir",
                    notification_reminder_train: "Recordatorio para entrenar",
                    notification_reminder_motivation: "Dosis de motivaci√≥n",
                    coach_modal_title: "Mensaje del Coach",
                    coach_modal_close: "¬°Entendido!",
                    coach_message_1: "¬°El dolor de hoy es la fuerza de ma√±ana! Sigue as√≠.",
                    coach_message_2: "Recuerda, la constancia es m√°s importante que la intensidad. ¬°No te rindas!",
                    coach_message_3: "¬°Has completado otro entrenamiento! Est√°s un paso m√°s cerca de tu meta.",
                    coach_message_4: "Tu cuerpo puede con casi todo. Es a tu mente a la que tienes que convencer.",
                    coach_message_5: "¬°Buen trabajo! No olvides hidratarte y estirar bien.",
                    oracle_title: "Or√°culo Fitness Diario",
                    offline_title: "Modo Offline",
                    offline_desc: "Rutinas sin Conexi√≥n",
                    offline_info: "Accede a una biblioteca de entrenamientos precargados, perfectos para cuando no tienes internet.",
                    create_own_title: "Crea tu Propia Rutina",
                    create_own_desc: "Dise√±a tu entrenamiento perfecto y gu√°rdalo para acceder sin conexi√≥n.",
                    muscle_shoulders: "Hombros",
                    muscle_chest: "Pecho",
                    muscle_biceps: "B√≠ceps",
                    muscle_triceps: "Triceps",
                    muscle_forearms: "Antebrazos",
                    muscle_back: "Espalda",
                    muscle_core: "Core",
                    muscle_glutes: "Gl√∫teos",
                    muscle_quads: "Cu√°driceps",
                    muscle_hamstrings: "Isquiotibiales",
                    muscle_calves: "Pantorrillas",
                    muscle_legs: "Piernas", // Generic fallback
                    muscle_full_body: "Cuerpo Completo",
                    muscle_traps: "Trapecios", // Added Traps
                    reward_claimed_title: "¬°Recompensa Reclamada!",
                    reward_claimed_action: "Ir al Beneficio",
                    reward_near_message: "¬°Est√°s cerca de desbloquear: ",
                    daily_mission_workout: "Completa un entrenamiento",
                    daily_mission_water: "Bebe 2 litros de agua",
                    daily_mission_sleep: "Duerme 7+ horas",
                    daily_mission_reflection: "Haz una reflexi√≥n diaria",
                    daily_mission_breathing: "Haz una sesi√≥n de respiraci√≥n",
                    daily_mission_water_reminder: "¬°Es hora de beber agua!",
                    daily_mission_stand_reminder: "¬°Lev√°ntate y mu√©vete un poco!",
                    daily_mission_train_reminder: "¬°No olvides tu entrenamiento!",
                    daily_mission_sleep_reminder: "¬°Es hora de prepararse para dormir!",
                    daily_mission_motivation_reminder: "¬°Una dosis de motivaci√≥n para tu d√≠a!",
                    total_workouts: "Entrenamientos", // New translation key
                }
            };

            // --- DOM Elements ---
            const dom = {
                appContainer: document.getElementById('app-container'),
                globalNavBar: document.getElementById('global-nav-bar'),
                screens: Array.from(document.querySelectorAll('.screen')).reduce((acc, screen) => {
                    acc[screen.id] = screen;
                    return acc;
                }, {}),
                dashboard: {
                    userPrompt: document.getElementById('user-prompt'),
                    generateBtn: document.getElementById('generate-btn'),
                    workoutOfTheDay: document.getElementById('workout-of-the-day'),
                    openLabBtn: document.getElementById('open-lab-btn'),
                    pointsValue: document.getElementById('points-value'),
                    pointsDisplay: document.getElementById('points-display'),
                    dailyMissionsDisplay: document.getElementById('daily-missions-display'),
                    missionsCompleted: document.getElementById('missions-completed'),
                    missionsTotal: document.getElementById('missions-total'),
                },
                lab: {
                    timerTypeSelection: document.getElementById('timer-type-selection'),
                    challengeBtns: document.querySelectorAll('.challenge-btn'),
                },
                timerTool: {
                    screen: document.getElementById('timer-tool-screen'),
                    title: document.getElementById('timer-tool-title'),
                    displayArea: document.getElementById('timer-tool-display-area'),
                    phase: document.getElementById('timer-tool-phase'),
                    display: document.getElementById('timer-tool-display'),
                    roundsDisplay: document.getElementById('timer-tool-rounds-display'),
                    controls: document.getElementById('timer-tool-controls'),
                    startBtn: document.getElementById('timer-tool-start'),
                    pauseBtn: document.getElementById('timer-tool-pause'),
                    resetBtn: document.getElementById('timer-tool-reset'),
                    lapBtn: document.getElementById('timer-tool-lap'), // New Lap button
                    lapTimesContainer: document.getElementById('lap-times-container'), // New Lap times container
                    lapTimesList: document.getElementById('lap-times-list'), // New Lap times list
                    configContainer: document.getElementById('timer-config-container'),
                    configTimer: document.getElementById('timer-config'),
                    configTabata: document.getElementById('tabata-config'),
                    configRounds: document.getElementById('rounds-config'),
                    roundsCounterControl: document.getElementById('rounds-counter-control'),
                    roundCounterBtn: document.getElementById('round-counter-btn'),
                    roundNextBtn: document.getElementById('round-next-btn'),
                },
                workout: {
                    title: document.getElementById('workout-title'),
                    exitBtn: document.getElementById('exit-workout-btn'),
                    timerRing: document.getElementById('workout-timer-ring'),
                    progressCircle: document.getElementById('workout-progress-circle'),
                    phaseLabel: document.getElementById('workout-phase-label'),
                    timerDisplay: document.getElementById('workout-timer-display'),
                    currentExercise: document.getElementById('current-exercise'),
                    nextExercise: document.getElementById('next-exercise'),
                    howToContainer: document.getElementById('how-to-container'),
                    howToSteps: document.getElementById('how-to-steps'),
                    prevBtn: document.getElementById('prev-btn'),
                    playPauseBtn: document.getElementById('play-pause-btn'),
                    nextBtn: document.getElementById('next-btn'),
                    beastModeBtn: document.getElementById('beast-mode-btn'),
                },
                data: {
                    inputWeight: document.getElementById('input-weight'),
                    inputHeight: document.getElementById('input-height'),
                    inputBMI: document.getElementById('input-bmi'),
                    inputMeasures: document.getElementById('input-measures'),
                    energyTracker: document.getElementById('energy-tracker'),
                    inputSleep: document.getElementById('input-sleep'),
                    inputWater: document.getElementById('input-water'),
                    saveBtn: document.getElementById('save-data-btn'),
                    analyzeDataBtn: document.getElementById('analyze-data-btn'),
                },
                sleep: {
                    toggleBtn: document.getElementById('toggle-sleep-sound-btn'),
                    soundBtns: document.querySelectorAll('.sleep-sound-btn'),
                    timerSlider: document.getElementById('sleep-timer-slider'),
                    timerValue: document.getElementById('sleep-timer-value'),
                    timerIndicator: document.getElementById('sleep-timer-active-indicator'),
                    clock: document.getElementById('sleep-clock'),
                },
                wellness: {
                    startCalmBreathingBtn: document.getElementById('start-calm-breathing-btn'),
                    startPowerBreathingBtn: document.getElementById('start-power-breathing-btn'),
                    startRelaxBreathingBtn: document.getElementById('start-relax-breathing-btn'),
                    breathingInstruction: document.getElementById('breathing-instruction'),
                    breathingVisualCircle: document.getElementById('breathing-visual-circle'),
                },
                progress: {
                    minutesValue: document.getElementById('total-minutes'),
                    routinesValue: document.getElementById('total-routines'),
                    caloriesValue: document.getElementById('total-calories'),
                    minutesCircle: document.getElementById('minutes-circle'),
                    routinesCircle: document.getElementById('routines-circle'),
                    caloriesCircle: document.getElementById('calories-circle'),
                    totalWorkoutsValue: document.getElementById('total-workouts'), // New DOM element
                    totalWorkoutsCircle: document.getElementById('total-workouts-circle'), // New DOM element
                    bodyMapContainer: document.getElementById('body-map-container'),
                    achievementsGrid: document.getElementById('achievements-grid'),
                    historyList: document.getElementById('workout-history-list'),
                    analyzeHistoryBtn: document.getElementById('analyze-history-btn'),
                    rewardsGrid: document.getElementById('rewards-grid'),
                    workoutStreak: document.getElementById('workout-streak'), // New streak display
                },
                settings: {
                    notificationsList: document.getElementById('notifications-list'),
                    alarmsList: document.getElementById('alarms-list'),
                    addAlarmBtn: document.getElementById('add-alarm-btn'),
                    themeToggle: document.getElementById('theme-toggle'),
                    languageSelect: document.getElementById('language-select'),
                },
                offline: {
                    routinesList: document.getElementById('offline-routines-list'),
                    newRoutineName: document.getElementById('new-routine-name'),
                    newRoutineExercises: document.getElementById('new-routine-exercises'),
                    saveCustomRoutineBtn: document.getElementById('save-custom-routine-btn'),
                },
                modals: {
                    overlay: document.getElementById('modal-overlay'),
                    contentWrapper: document.getElementById('modal-content-wrapper'),
                    closeBtn: document.getElementById('close-modal-btn'),
                    alarmContent: document.getElementById('alarm-modal-content'),
                    alarmTitle: document.getElementById('alarm-modal-title'),
                    alarmName: document.getElementById('alarm-name'),
                    alarmTime: document.getElementById('alarm-time'),
                    alarmDaySelector: document.getElementById('alarm-day-selector'),
                    saveAlarmBtn: document.getElementById('save-alarm-btn'),
                    supplementsContent: document.getElementById('supplements-modal-content'),
                    reflectionContent: document.getElementById('reflection-modal-content'),
                    reflectionQuestions: document.getElementById('reflection-questions'),
                    mobilityContent: document.getElementById('mobility-modal-content'),
                    iceBathContent: document.getElementById('ice-bath-modal-content'),
                    iceBathTimer: document.getElementById('ice-bath-timer'),
                    startIceBathTimerBtn: document.getElementById('start-ice-bath-timer-btn'),
                    intimateWellnessContent: document.getElementById('intimate-wellness-modal-content'),
                    lastPeriodDate: document.getElementById('last-period-date'), // Moved here
                    menstrualCycleDisplay: document.getElementById('menstrual-cycle-display-new'), // Changed to new
                    beastModeContent: document.getElementById('beast-mode-modal-content'),
                    confirmBeastModeBtn: document.getElementById('confirm-beast-mode-btn'),
                    cancelBeastModeBtn: document.getElementById('cancel-beast-mode-btn'),
                    infoContent: document.getElementById('info-modal-content'),
                    infoTitle: document.getElementById('info-modal-title'),
                    infoBody: document.getElementById('info-modal-body'),
                    coachContent: document.getElementById('coach-modal-content'),
                    coachMessage: document.getElementById('coach-message'),
                    closeCoachBtn: document.getElementById('close-coach-modal-btn'),
                    oracleContent: document.getElementById('oracle-modal-content'),
                    oracleMessage: document.getElementById('oracle-message'),
                    closeOracleBtn: document.getElementById('close-oracle-modal-btn'),
                    rewardClaimedContent: document.getElementById('reward-claimed-modal-content'),
                    rewardClaimedMessage: document.getElementById('reward-claimed-message'),
                    rewardClaimedLink: document.getElementById('reward-claimed-link'),
                    closeRewardClaimedBtn: document.getElementById('close-reward-claimed-modal-btn'),
                    antiStressContent: document.getElementById('anti-stress-modal-content'), // New anti-stress modal
                    stressVisualizerCanvas: document.getElementById('stress-visualizer-canvas'), // Changed to canvas
                    toggleStressSoundBtn: document.getElementById('toggle-stress-sound-btn'),
                },
                tooltip: document.getElementById('tooltip'),
                toastContainer: document.getElementById('toast-container'),
            };

            // --- Master State Object ---
            let state = {
                currentScreen: 'dashboard-screen',
                language: 'es',
                audioContext: null,
                aiWorkout: { routine: null, currentIndex: 0, currentPhase: 'idle', phaseTimeLeft: 0, isPaused: true, timerInterval: null, beastModeActivated: false },
                sleep: { soundNode: null, gainNode: null, isPlaying: false, selectedSound: 'brown', timerId: null, clockInterval: null },
                wellness: { breathingInterval: null, isBreathing: false, breathingType: 'calm', iceBathInterval: null, stressSound: null, stressSynth: null, isStressSoundPlaying: false, stressVisualizerAnimationId: null, stressVisualizerParticles: [] }, // Added stressVisualizer related properties
                progress: { history: [], achievements: { first_workout: false, seven_day_streak: false, beast_mode: false, perfect_week: false }, points: 0, muscleGroupsWorked: {}, claimedRewards: [], workoutStreak: 0, lastWorkoutDate: null }, // Added workoutStreak and lastWorkoutDate
                userData: { weight: null, height: null, bmi: null, measures: null, energy: null, sleep: null, water: null, lastPeriodDate: null, customRoutines: [], lastWaterReminderHour: null }, // Added lastWaterReminderHour
                notifications: { stand: { enabled: true }, water: { enabled: true }, sleep: { enabled: false }, train: { enabled: false }, motivation: { enabled: true } },
                alarms: [],
                oracleMessage: null,
                timerTool: { type: null, interval: null, startTime: 0, elapsedTime: 0, isRunning: false, duration: 0, tabata: { work: 20, rest: 10, rounds: 8, currentRound: 0, isWorkPhase: true, timeLeft: 0 }, rounds: { count: 0, target: 0, rest: 0, current: 1, restTimerInterval: null }, lapTimes: [] }, // Added lapTimes, restTimerInterval for rounds
                editingAlarmIndex: null,
                theme: 'dark', // 'dark' or 'light'
                dailyMissions: [],
                missionsCompletedToday: 0,
            };

            // --- CORE APP LOGIC ---
            function showScreen(screenId) {
                if (!dom.screens[screenId]) return;
                
                // Hide the currently active screen
                const currentScreenEl = dom.screens[state.currentScreen];
                if (currentScreenEl) currentScreenEl.classList.remove('active');
                
                // Show the new screen
                state.currentScreen = screenId;
                const targetScreen = dom.screens[screenId];
                targetScreen.classList.add('active');
                
                // Scroll content to top
                dom.appContainer.scrollTop = 0;

                // --- Manage Global Nav Bar Visibility based on screen type ---
                const screensWithoutGlobalNav = [
                    'workout-screen', 'post-workout-screen', 'sleep-screen', 
                    'breathing-screen', 'timer-tool-screen'
                ];
                
                // On fullscreen-like screens, we hide the nav. On others, we show it.
                if (screensWithoutGlobalNav.includes(screenId)) {
                    dom.globalNavBar.style.display = 'none';
                } else {
                    dom.globalNavBar.style.display = 'block'; // Or 'grid' if you use that
                }

                // --- Update Active Nav Button ---
                document.querySelectorAll('#global-nav-bar .nav-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.screen === screenId);
                });

                // --- Screen-specific setup/cleanup ---
                stopVisualizer(); // Post-workout visualizer
                stopSleepSound();
                toggleBreathingExercise(true); // Stop breathing exercise
                stopStressSound(); // Stop stress sound when changing screens
                if (state.sleep.clockInterval) clearInterval(state.sleep.clockInterval);
                resetTimerTool();

                if (screenId === 'progress-screen') renderProgressScreen();
                if (screenId === 'data-screen') renderDataScreen();
                if (screenId === 'settings-screen') renderSettingsScreen();
                if (screenId === 'offline-screen') renderOfflineRoutines();
                if (screenId === 'sleep-screen') startSleepClock();
            }

            function setLanguage(lang) {
                state.language = lang;
                document.documentElement.lang = lang;
                dom.settings.languageSelect.value = lang; // Update select element
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    const translation = translations[lang][key];
                    if (translation) {
                        if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') el.placeholder = translation;
                        else if (el.hasAttribute('title')) el.title = translation;
                        else el.innerHTML = translation;
                    }
                });
                // After changing language, re-render components that might depend on it
                updateMenstrualCycleDisplay();
            }
            
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                dom.toastContainer.appendChild(toast);
                setTimeout(() => { toast.remove(); }, 4000);
            }

            function initAudio() {
                if (!state.audioContext) {
                    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (state.audioContext.state === 'suspended') {
                    state.audioContext.resume();
                }
            }

            function playBeep(frequency = 440, duration = 100, type = 'sine') {
                initAudio();
                const oscillator = state.audioContext.createOscillator();
                const gainNode = state.audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(state.audioContext.destination);
                oscillator.type = type;
                oscillator.frequency.value = frequency;
                gainNode.gain.setValueAtTime(0, state.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, state.audioContext.currentTime + 0.01);
                oscillator.start(state.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, state.audioContext.currentTime + duration / 1000);
                oscillator.stop(state.audioContext.currentTime + duration / 1000);
            }

            // --- AI Workout Generation ---
            function showLoadingSkeleton(btn) {
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
                }
            }

            function resetButton(btn, originalTextKey, originalIconClass) {
                if (btn) {
                    btn.disabled = false;
                    const textContent = translations[state.language][originalTextKey];
                    if (originalIconClass.startsWith('fa-')) { // FontAwesome icon
                        btn.innerHTML = `<i class="${originalIconClass} mr-2"></i> <span>${textContent}</span>`;
                    } else { // Emoji or other text-based icon
                        btn.innerHTML = `${originalIconClass} <span>${textContent}</span>`;
                    }
                }
            }
            
            async function fetchAndStartWorkout(promptText, workoutType, btnToLoad) {
                showLoadingSkeleton(btnToLoad);
                
                let routine;
                const lang = state.language;
                // Updated JSON structure to include varied exercise details and howTo
                const jsonFormat = `{"title": "Creative Name", "totalDurationMinutes": 30, "type": "${workoutType}", "phases": [{"phaseName": "Warm-up", "type": "prep", "durationSeconds": 180, "exerciseName": "Dynamic Warm-up", "howTo": ["Instruction 1", "Instruction 2"], "muscleGroups": ["full body"]}, {"phaseName": "Squats", "type": "work", "durationSeconds": 45, "exerciseName": "Dumbbell Squats", "sets": "3", "reps": "10-12", "howTo": ["Instruction 1", "Instruction 2"], "muscleGroups": ["legs", "glutes"]}, {"phaseName": "Rest", "type": "rest", "durationSeconds": 15, "exerciseName": "Rest"}]}`;
                const systemPrompt = `${translations[lang].system_prompt_base} ${jsonFormat}`;

                try {
                    // This is a placeholder for a real API call.
                    await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate network delay
                    let mockResponse;
                    if (promptText.includes("sin equipo")) {
                         mockResponse = {
                            title: "Rutina de Peso Corporal para Principiantes",
                            totalDurationMinutes: 30,
                            phases: [
                                { phaseName: "Calentamiento", type: "prep", durationSeconds: 180, exerciseName: "Movilidad Articular", howTo: ["Rota tobillos, rodillos y caderas.", "Haz c√≠rculos con los brazos hacia adelante y atr√°s."], muscleGroups: ["full_body"] },
                                { phaseName: "Sentadillas", type: "work", durationSeconds: 180, exerciseName: "Sentadillas con Peso Corporal", sets: "3", reps: "15", howTo: ["Pies al ancho de hombros.", "Baja la cadera como si te sentaras.", "Mant√©n la espalda recta y el pecho erguido."], muscleGroups: ["quads", "glutes"] },
                                { phaseName: "Descanso", type: "rest", durationSeconds: 60, exerciseName: "Descanso" },
                                { phaseName: "Flexiones", type: "work", durationSeconds: 180, exerciseName: "Flexiones de Rodillas", sets: "3", reps: "10-12", howTo: ["Apoya rodillas y manos en el suelo.", "Baja el pecho cerca del suelo.", "Empuja hacia arriba controladamente."], muscleGroups: ["chest", "triceps", "shoulders"] },
                                { phaseName: "Descanso", type: "rest", durationSeconds: 60, exerciseName: "Descanso" },
                                { phaseName: "Plancha", type: "work", durationSeconds: 120, exerciseName: "Plancha Abdominal", sets: "3", reps: "30-45s", howTo: ["Ap√≥yate en antebrazos y puntas de pies.", "Mant√©n el cuerpo recto como una tabla.", "Contrae el abdomen y los gl√∫teos."], muscleGroups: ["core"] },
                                { phaseName: "Enfriamiento", type: "cooldown", durationSeconds: 180, exerciseName: "Estiramientos Est√°ticos", howTo: ["Estira cu√°driceps, isquiotibiales y pecho.", "Mant√©n cada estiramiento por 20-30 segundos."], muscleGroups: ["full_body"] }
                            ]
                        };
                    } else if (promptText.includes("espalda y b√≠ceps")) {
                        mockResponse = {
                            title: "Rutina de Espalda y B√≠ceps en Gimnasio",
                            totalDurationMinutes: 45,
                            phases: [
                                { phaseName: "Calentamiento", type: "prep", durationSeconds: 240, exerciseName: "Remo en Polea Baja y Rotaciones de Hombros", howTo: ["5 minutos de remo ligero.", "1 minuto de rotaciones de hombros."], muscleGroups: ["back", "shoulders"] },
                                { phaseName: "Dominadas Asistidas", type: "work", durationSeconds: 300, exerciseName: "Dominadas Asistidas", sets: "4", reps: "8-12", howTo: ["Usa m√°quina asistida o banda.", "Agarre prono, manos un poco m√°s anchas que hombros.", "Sube el pecho hacia la barra, baja controladamente."], muscleGroups: ["back", "biceps"] },
                                { phaseName: "Descanso", type: "rest", durationSeconds: 90, exerciseName: "Descanso" },
                                { phaseName: "Remo con Barra", type: "work", durationSeconds: 300, exerciseName: "Remo con Barra", sets: "3", reps: "10-12", howTo: ["Inclina el torso a 45 grados.", "Remo la barra hacia el ombligo.", "Aprieta los om√≥platos al final."], muscleGroups: ["back", "traps"] },
                                { phaseName: "Descanso", type: "rest", durationSeconds: 90, exerciseName: "Descanso" },
                                { phaseName: "Curl de B√≠ceps", type: "work", durationSeconds: 240, exerciseName: "Curl de B√≠ceps con Mancuernas", sets: "3", reps: "12-15", howTo: ["De pie o sentado, codos pegados al cuerpo.", "Sube las mancuernas contrayendo el b√≠ceps.", "Baja lentamente controlando el movimiento."], muscleGroups: ["biceps", "forearms"] },
                                { phaseName: "Enfriamiento", type: "cooldown", durationSeconds: 240, exerciseName: "Estiramientos de Espalda y B√≠ceps", howTo: ["Estira dorsal ancho y b√≠ceps.", "Mant√©n cada estiramiento por 30 segundos."], muscleGroups: ["back", "biceps"] }
                            ]
                        };
                    } else {
                        // Default mock response for other prompts
                        mockResponse = {
                            title: workoutType || "Rutina de IA",
                            totalDurationMinutes: 25,
                            phases: [
                                { phaseName: "Calentamiento", type: "prep", durationSeconds: 180, exerciseName: "Saltos de tijera y c√≠rculos de brazos", howTo: ["Realiza saltos de tijera suaves.", "Haz c√≠rculos amplios con los brazos hacia adelante y atr√°s."], muscleGroups: ["full_body"] },
                                { phaseName: "Ejercicio Principal 1", type: "work", durationSeconds: 240, exerciseName: "Sentadillas con peso corporal", sets: "3", reps: "15", howTo: ["Pies al ancho de los hombros.", "Baja la cadera manteniendo la espalda recta.", "Sube de forma controlada."], muscleGroups: ["quads", "glutes"] },
                                { phaseName: "Descanso", type: "rest", durationSeconds: 60, exerciseName: "Descanso Activo (caminar)" },
                                { phaseName: "Ejercicio Principal 2", type: "work", durationSeconds: 240, exerciseName: "Flexiones (en rodillas si es necesario)", sets: "3", reps: "10-12", howTo: ["Manos un poco m√°s anchas que los hombros.", "Baja el pecho hacia el suelo.", "Mant√©n el abdomen contra√≠do."], muscleGroups: ["chest", "triceps", "core"] },
                                { phaseName: "Enfriamiento", type: "cooldown", durationSeconds: 180, exerciseName: "Estiramientos suaves", howTo: ["Estira cu√°driceps, isquiotibiales y pecho.", "Mant√©n cada estiramiento por 30 segundos."], muscleGroups: ["full_body"] }
                            ]
                        };
                    }
                    routine = mockResponse;
                    
                    // Reset the specific button that was clicked
                    const originalTextKey = btnToLoad.dataset.originalTextKey;
                    const originalIconClass = btnToLoad.dataset.originalIconClass;
                    if (originalTextKey && originalIconClass) {
                        resetButton(btnToLoad, originalTextKey, originalIconClass);
                    } else {
                        // Fallback for buttons without specific data attributes (e.g., challenges)
                        if (btnToLoad.classList.contains('challenge-btn')) {
                            btnToLoad.innerHTML = `<h3 class="text-xl font-bold text-primary">${btnToLoad.dataset.originalIconClass} <span data-translate-key="${btnToLoad.dataset.originalTextKey}">${translations[state.language][btnToLoad.dataset.originalTextKey]}</span></h3><p class="text-sm text-text-secondary mt-1" data-translate-key="${btnToLoad.dataset.originalTextKey.replace('_title', '_desc')}">${translations[state.language][btnToLoad.dataset.originalTextKey.replace('_title', '_desc')]}</p>`;
                            btnToLoad.disabled = false;
                        } else {
                             resetButton(btnToLoad, 'ia_prompt_button', 'fas fa-cogs'); // Default fallback
                        }
                    }

                } catch (error) {
                    showToast("Error generando rutina: " + error.message, 'error');
                    const originalTextKey = btnToLoad.dataset.originalTextKey;
                    const originalIconClass = btnToLoad.dataset.originalIconClass;
                    if (originalTextKey && originalIconClass) {
                        resetButton(btnToLoad, originalTextKey, originalIconClass);
                    } else {
                        if (btnToLoad.classList.contains('challenge-btn')) {
                            btnToLoad.innerHTML = `<h3 class="text-xl font-bold text-primary">${btnToLoad.dataset.originalIconClass} <span data-translate-key="${btnToLoad.dataset.originalTextKey}">${translations[state.language][btnToLoad.dataset.originalTextKey]}</span></h3><p class="text-sm text-text-secondary mt-1" data-translate-key="${btnToLoad.dataset.originalTextKey.replace('_title', '_desc')}">${translations[state.language][btnToLoad.dataset.originalTextKey.replace('_title', '_desc')]}</p>`;
                            btnToLoad.disabled = false;
                        } else {
                            resetButton(btnToLoad, 'ia_prompt_button', 'fas fa-cogs'); // Default fallback
                        }
                    }
                    return;
                }
                
                state.aiWorkout.routine = routine;
                startAiWorkout();
            }

            async function analyzeHistoryWithAI() {
                if (state.progress.history.length < 3) {
                    showToast("Necesitas al menos 3 actividades registradas para un buen an√°lisis.", 'info');
                    return;
                }

                const historySummary = state.progress.history.slice(0, 15).map(w => 
                    `- ${w.date}: ${w.title} (${w.duration} min). M√∫sculos: ${w.muscleGroups ? w.muscleGroups.join(', ') : 'N/A'}.`
                ).join('\n');
                
                const prompt = `${translations.es.history_analysis_prompt}\n${historySummary}`;
                
                showModal('info', { title: translations.es.history_analysis_title, body: '<div class="text-center"><i class="fas fa-spinner fa-spin text-3xl"></i><p>Analizando...</p></div>' });

                try {
                    // MOCK API CALL
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    const mockAnalysis = `
                        <p>¬°Buen trabajo manteniendo el ritmo! Aqu√≠ tienes un par de observaciones:</p>
                        <ul class="list-disc list-inside space-y-2 mt-4">
                            <li><strong>Consistencia:</strong> Has entrenado 4 de los √∫ltimos 7 d√≠as. ¬°Eso es genial! Intenta no dejar pasar m√°s de 2 d√≠as sin moverte para crear un h√°bito s√≥lido.</li>
                            <li><strong>Balance Muscular:</strong> Se nota un buen trabajo en el tren inferior (piernas y gl√∫teos). Sin embargo, parece que podr√≠as darle un poco m√°s de ca√±a a la espalda, hombros y trapecios para un f√≠sico m√°s equilibrado.</li>
                            <li><strong>Sugerencia:</strong> Prueba a√±adir una rutina de "Espalda, B√≠ceps y Trapecios" o un "HIIT de Hombros" esta semana. ¬°Sigue as√≠, campe√≥n!</li>
                        </ul>
                    `;
                    dom.modals.infoBody.innerHTML = mockAnalysis;
                } catch (error) {
                    dom.modals.infoBody.innerHTML = `<p class="text-danger">Hubo un error al analizar tu historial.</p>`;
                }
            }

            async function analyzeUserDataWithAI() {
                const userData = state.userData;
                const lang = state.language;
                let analysisMessage = `<p>Basado en tus datos, aqu√≠ hay algunos consejos:</p><ul class="list-disc list-inside space-y-2 mt-4">`;

                if (userData.weight && userData.height && userData.bmi) {
                    analysisMessage += `<li><strong>Datos F√≠sicos:</strong> Tu IMC es ${userData.bmi}. Si tu objetivo es ${userData.weight > 70 ? 'perder peso' : 'ganar masa'}, aseg√∫rate de que tu nutrici√≥n est√© alineada con eso.</li>`;
                }
                if (userData.sleep) {
                    analysisMessage += `<li><strong>Sue√±o:</strong> Dormiste ${userData.sleep} horas. ${userData.sleep < 7 ? 'Intenta alcanzar al menos 7-9 horas para una √≥ptima recuperaci√≥n y energ√≠a.' : '¬°Excelente descanso! El sue√±o de calidad es clave para el rendimiento.'}</li>`;
                }
                if (userData.water) {
                    analysisMessage += `<li><strong>Hidrataci√≥n:</strong> Bebiste ${userData.water} litros de agua. ${userData.water < 2 ? 'Aumenta tu ingesta de agua, es vital para el metabolismo y la funci√≥n muscular.' : '¬°Muy buena hidrataci√≥n! Sigue as√≠.'}</li>`;
                }
                if (userData.energy) {
                    const moodText = ['muy bajo', 'bajo', 'neutral', 'bueno', 'excelente'][userData.energy - 1];
                    analysisMessage += `<li><strong>Estado de √Ånimo:</strong> Tu energ√≠a hoy fue ${moodText}. ${userData.energy < 3 ? 'Si te sientes bajo, considera una sesi√≥n de respiraci√≥n o una caminata ligera para mejorar tu √°nimo.' : '¬°Qu√© bien que tu √°nimo est√© alto! Aprovecha esa energ√≠a.'}</li>`;
                }
                if (userData.measures) {
                    analysisMessage += `<li><strong>Medidas:</strong> Tus medidas registradas son: ${userData.measures}. ¬°Sigue monitore√°ndolas para ver tu progreso!</li>`;
                }
                if (userData.lastPeriodDate) {
                    const lastDate = new Date(userData.lastPeriodDate);
                    const today = new Date();
                    const diffTime = Math.abs(today - lastDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    let phase = '';
                    if (diffDays <= 5) { phase = translations.es.menstrual_phase_menstrual; }
                    else if (diffDays <= 13) { phase = translations.es.menstrual_phase_follicular; }
                    else if (diffDays <= 16) { phase = translations.es.menstrual_phase_ovulation; }
                    else { phase = translations.es.menstrual_phase_luteal; }
                    analysisMessage += `<li><strong>Ciclo Menstrual:</strong> Est√°s en el d√≠a ${diffDays} de tu ciclo, fase estimada: ${phase}. Ajusta tu entrenamiento y nutrici√≥n seg√∫n tu fase para optimizar resultados.</li>`;
                }

                analysisMessage += `</ul><p class="mt-4">¬°Sigue registrando tus datos para obtener an√°lisis m√°s precisos!</p>`;

                showModal('info', { title: 'An√°lisis de Datos con IA', body: '<div class="text-center"><i class="fas fa-spinner fa-spin text-3xl"></i><p>Analizando tus datos...</p></div>' });

                try {
                    // MOCK API CALL
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    dom.modals.infoBody.innerHTML = analysisMessage;
                } catch (error) {
                    dom.modals.infoBody.innerHTML = `<p class="text-danger">Hubo un error al analizar tus datos.</p>`;
                }
            }


            // --- AI Workout Execution ---
            function startAiWorkout() {
                if (!state.aiWorkout.routine) return;
                showScreen('workout-screen');
                Object.assign(state.aiWorkout, { currentIndex: 0, isPaused: false, beastModeActivated: false });
                dom.workout.beastModeBtn.classList.remove('beast-mode-active');
                dom.workout.title.textContent = state.aiWorkout.routine.title;
                runAiPhase(0);
                updatePlayPauseIcon();
            }

            function runAiPhase(index) {
                if (index >= state.aiWorkout.routine.phases.length) {
                    finishAiWorkout();
                    return;
                }
                const phase = state.aiWorkout.routine.phases[index];
                state.aiWorkout.currentIndex = index;
                state.aiWorkout.currentPhase = phase.type;
                state.aiWorkout.phaseTimeLeft = phase.durationSeconds;
                updateUIForAiPhase(phase);
                if (state.aiWorkout.timerInterval) clearInterval(state.aiWorkout.timerInterval);
                state.aiWorkout.timerInterval = setInterval(updateAiTimer, 1000);
                playBeep(phase.type === 'work' ? 660 : 440, 200);
            }

            function updateUIForAiPhase(phase) {
                const lang = state.language;
                dom.workout.phaseLabel.textContent = translations[lang][`phase_${phase.type}`] || phase.phaseName;
                dom.workout.currentExercise.textContent = phase.exerciseName;
                // Display sets and reps if available
                if (phase.sets && phase.reps) {
                    dom.workout.currentExercise.textContent += ` (${phase.sets}x${phase.reps})`;
                }

                const nextIndex = state.aiWorkout.currentIndex + 1;
                const nextPhaseData = state.aiWorkout.routine.phases[nextIndex];
                dom.workout.nextExercise.textContent = nextPhaseData ? `${translations[lang].next_exercise_prefix}: ${nextPhaseData.exerciseName || nextPhaseData.phaseName}` : translations[lang].last_exercise_text;
                const phaseType = phase.type || 'prep';
                dom.workout.timerRing.className = `z-10 text-center flex flex-col items-center justify-center w-[calc(100%-40px)] h-[calc(100%-40px)] rounded-full border-8 transition-colors duration-500 bg-dark phase-border-${phaseType}`;
                dom.workout.progressCircle.className = `timer-circle-progress phase-color-${phaseType}`;

                dom.workout.howToSteps.innerHTML = '';
                if (phase.howTo && phase.howTo.length > 0) {
                    phase.howTo.forEach(step => {
                        const li = document.createElement('li');
                        li.textContent = step;
                        dom.workout.howToSteps.appendChild(li);
                    });
                    dom.workout.howToContainer.classList.remove('hidden');
                } else {
                    dom.workout.howToContainer.classList.add('hidden');
                }
            }

            function updateAiTimer() {
                if (state.aiWorkout.isPaused) return;
                if (state.aiWorkout.phaseTimeLeft > 0) state.aiWorkout.phaseTimeLeft--;
                const phaseDuration = state.aiWorkout.routine.phases[state.aiWorkout.currentIndex].durationSeconds;
                const progress = phaseDuration > 0 ? (state.aiWorkout.phaseTimeLeft / phaseDuration) : 0;
                dom.workout.progressCircle.style.strokeDashoffset = 283 * (1 - progress);
                if (state.aiWorkout.phaseTimeLeft <= 0) {
                    nextAiPhase();
                } else if (state.aiWorkout.phaseTimeLeft <= 3 && state.aiWorkout.phaseTimeLeft > 0) {
                    playBeep(523, 150, 'square');
                }
                const minutes = Math.floor(state.aiWorkout.phaseTimeLeft / 60);
                const seconds = state.aiWorkout.phaseTimeLeft % 60;
                dom.workout.timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            function nextAiPhase() { runAiPhase(state.aiWorkout.currentIndex + 1); }
            function prevAiPhase() { if (state.aiWorkout.currentIndex > 0) runAiPhase(state.aiWorkout.currentIndex - 1); }
            function handleBeastModeClick() { showModal('beast-mode'); }

            function activateBeastMode() {
                if (state.aiWorkout.beastModeActivated || !state.aiWorkout.routine) return;
                state.aiWorkout.beastModeActivated = true;
                dom.workout.beastModeBtn.classList.add('beast-mode-active');
                const finisher = {
                    phaseName: "BEAST MODE FINISHER", type: "work", durationSeconds: 60, exerciseName: "Burpees",
                    howTo: ["Desde de pie, baja a una sentadilla.", "Lanza los pies hacia atr√°s a posici√≥n de plancha.", "Haz una flexi√≥n (opcional).", "Salta con los pies de vuelta a sentadilla y explota hacia arriba."],
                    muscleGroups: ["full_body"]
                };
                // Insert finisher before the last phase (cooldown or final rest)
                const lastPhaseIndex = state.aiWorkout.routine.phases.length - 1;
                // Ensure there's always a cooldown or final rest to insert before
                if (state.aiWorkout.routine.phases[lastPhaseIndex].type === 'cooldown' || state.aiWorkout.routine.phases[lastPhaseIndex].type === 'rest') {
                    state.aiWorkout.routine.phases.splice(lastPhaseIndex, 0, finisher);
                } else {
                    state.aiWorkout.routine.phases.push(finisher); // Add at end if no specific cooldown/rest
                }
                
                showToast(translations[state.language].beast_mode_activated_alert, 'info');
                playBeep(770, 300, 'sawtooth'); // More intense sound for beast mode
                // Note: Actual voice output is not supported by current tools. This will display a text message.
                showModal('coach', "¬°Modo Bestia activado! ¬°Vas a destrozarla! ¬°No te detengas!");
                hideModal();
            }
            
            function finishAiWorkout() {
                clearInterval(state.aiWorkout.timerInterval);
                playBeep(1046, 500, 'triangle');
                logActivityToHistory({
                    type: 'workout',
                    title: state.aiWorkout.routine.title,
                    duration: state.aiWorkout.routine.totalDurationMinutes,
                    beastMode: state.aiWorkout.beastModeActivated,
                    muscleGroups: state.aiWorkout.routine.phases.flatMap(p => p.muscleGroups || []).filter((v, i, a) => a.indexOf(v) === i),
                });
                showScreen('post-workout-screen');
                const title = state.aiWorkout.routine.type === 'Mobility' ? translations[state.language].post_workout_title_calm : translations[state.language].post_workout_title_hard;
                document.getElementById('visualizer-title').textContent = title;
                document.getElementById('visualizer-message').textContent = `¬°Ganaste ${state.aiWorkout.routine.totalDurationMinutes * 5} puntos!`;
                startVisualizer();
                checkDailyMissions('workout');
            }

            function toggleAiPause() {
                state.aiWorkout.isPaused = !state.aiWorkout.isPaused;
                updatePlayPauseIcon();
            }

            function updatePlayPauseIcon() {
                dom.workout.playPauseBtn.querySelector('i').className = state.aiWorkout.isPaused ? 'fas fa-play ml-1' : 'fas fa-pause';
            }

            // --- Post-Workout Visualizer ---
            let visualizerAnimationId;
            const visualizerCanvas = document.getElementById('visualizer-canvas');
            const visualizerCtx = visualizerCanvas.getContext('2d');

            function startVisualizer() {
                dom.appContainer.style.overflow = 'hidden';
                visualizerCanvas.width = visualizerCanvas.offsetWidth;
                visualizerCanvas.height = visualizerCanvas.offsetHeight;
                visualizerAnimationId = requestAnimationFrame(animateVisualizer);
            }

            function animateVisualizer() {
                visualizerCtx.fillStyle = 'rgba(16, 16, 16, 0.1)';
                visualizerCtx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
                visualizerCtx.fillStyle = `rgba(138, 79, 255, ${Math.random()})`;
                visualizerCtx.beginPath();
                visualizerCtx.arc(Math.random() * visualizerCanvas.width, Math.random() * visualizerCanvas.height, Math.random() * 100, 0, Math.PI * 2);
                visualizerCtx.fill();
                visualizerAnimationId = requestAnimationFrame(animateVisualizer);
            }

            function stopVisualizer() {
                if (visualizerAnimationId) {
                    cancelAnimationFrame(visualizerAnimationId);
                    visualizerAnimationId = null;
                }
                dom.appContainer.style.overflowY = 'auto';
            }

            // --- Modal Logic ---
            function showModal(type, data) {
                dom.modals.overlay.classList.remove('hidden');
                Object.values(dom.modals.contentWrapper.children).forEach(child => {
                    if (child.id && child.id.endsWith('-modal-content')) child.style.display = 'none';
                });
                
                const contentEl = dom.modals[`${type}Content`] || dom.modals.infoContent;
                contentEl.style.display = 'block';

                if (type === 'info') {
                    dom.modals.infoTitle.innerHTML = data.title;
                    dom.modals.infoBody.innerHTML = data.body;
                } else if (type === 'coach') {
                    const lang = state.language;
                    const messages = [translations[lang].coach_message_1, translations[lang].coach_message_2, translations[lang].coach_message_3, translations[lang].coach_message_4, translations[lang].coach_message_5];
                    dom.modals.coachMessage.textContent = data || messages[Math.floor(Math.random() * messages.length)];
                } else if (type === 'oracle') {
                    dom.modals.oracleMessage.textContent = data;
                } else if (type === 'alarm') {
                    state.editingAlarmIndex = data.index;
                    dom.modals.alarmTitle.textContent = data.index === null ? 'Nueva Alarma' : 'Editar Alarma';
                    dom.modals.alarmName.value = data.alarm ? data.alarm.name : '';
                    dom.modals.alarmTime.value = data.alarm ? data.alarm.time : '07:00';
                    dom.modals.alarmDaySelector.querySelectorAll('.day-btn').forEach((btn, i) => {
                        const dayIndex = btn.dataset.day;
                        const isActive = data.alarm ? data.alarm.days[dayIndex] : false;
                        btn.classList.toggle('active', isActive);
                    });
                } else if (type === 'reflection') {
                    renderReflectionQuestions();
                } else if (type === 'intimateWellness') {
                    // Render menstrual cycle data when intimate wellness modal opens
                    dom.modals.lastPeriodDate.value = state.userData.lastPeriodDate || '';
                    updateMenstrualCycleDisplay();
                } else if (type === 'rewardClaimed') {
                    dom.modals.rewardClaimedMessage.textContent = data.message;
                    if (data.link) {
                        dom.modals.rewardClaimedLink.href = data.link;
                        dom.modals.rewardClaimedLink.classList.remove('hidden');
                    } else {
                        dom.modals.rewardClaimedLink.classList.add('hidden');
                    }
                } else if (type === 'antiStress') {
                    startStressVisualizer(); // Start visualizer for anti-stress
                    startStressSound(); // Start sound for anti-stress
                }

                setTimeout(() => dom.modals.contentWrapper.classList.remove('scale-95'), 10);
            }

            function hideModal() {
                dom.modals.contentWrapper.classList.add('scale-95');
                setTimeout(() => dom.modals.overlay.classList.add('hidden'), 300);
                stopStressVisualizer(); // Ensure stress visualizer stops when modal is closed
                stopStressSound(); // Ensure stress sound stops when modal is closed
            }

            // --- Data & Wellness Modules ---
            function calculateBMI(weightKg, heightCm) {
                if (!weightKg || !heightCm) return null;
                const heightM = heightCm / 100;
                return (weightKg / (heightM * heightM)).toFixed(2);
            }

            function saveAndAnalyzeData() {
                state.userData.weight = dom.data.inputWeight.value || null;
                state.userData.height = dom.data.inputHeight.value || null;
                state.userData.bmi = calculateBMI(parseFloat(state.userData.weight), parseFloat(state.userData.height));
                dom.data.inputBMI.value = state.userData.bmi || ''; // Update BMI display
                state.userData.measures = dom.data.inputMeasures.value || null;
                state.userData.sleep = dom.data.inputSleep.value || null;
                state.userData.water = dom.data.inputWater.value || null;
                state.userData.lastPeriodDate = dom.modals.lastPeriodDate.value || null; // Moved to modal
                
                localStorage.setItem('goatiFitUserData', JSON.stringify(state.userData));
                showToast("Tus datos han sido guardados.", 'success');
                renderDataScreen();
                checkDailyMissions('water');
                checkDailyMissions('sleep');
            }
            
            function renderDataScreen() {
                dom.data.inputWeight.value = state.userData.weight || '';
                dom.data.inputHeight.value = state.userData.height || '';
                dom.data.inputBMI.value = state.userData.bmi || '';
                dom.data.inputMeasures.value = state.userData.measures || '';
                dom.data.inputSleep.value = state.userData.sleep || '';
                dom.data.inputWater.value = state.userData.water || '';

                dom.data.energyTracker.querySelectorAll('.mood-btn').forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.value) === state.userData.energy);
                });
            }

            function updateMenstrualCycleDisplay() {
                if (dom.modals.lastPeriodDate.value) {
                    const lastDate = new Date(dom.modals.lastPeriodDate.value + 'T00:00:00'); // Add time to avoid TZ issues
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // Normalize today's date
                    
                    const diffTime = Math.abs(today - lastDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    
                    let phaseKey = '';
                    if (diffDays <= 5) { phaseKey = 'menstrual_phase_menstrual'; }
                    else if (diffDays <= 13) { phaseKey = 'menstrual_phase_follicular'; }
                    else if (diffDays <= 16) { phaseKey = 'menstrual_phase_ovulation'; }
                    else if (diffDays <= 28) { phaseKey = 'menstrual_phase_luteal'; }
                    else { phaseKey = 'menstrual_phase_menstrual'; } // Default fallback after day 28
                    
                    const phaseName = translations[state.language][phaseKey] || "Fase Desconocida";
                    const phaseDesc = translations[state.language][`${phaseKey}_desc`] || "Consulta a un profesional para m√°s detalles.";

                    dom.modals.menstrualCycleDisplay.innerHTML = `
                        <p class="text-sm text-text-secondary">D√çA DEL CICLO</p>
                        <div class="cycle-day-display">${diffDays}</div>
                        <div class="cycle-phase-display">${phaseName}</div>
                        <p class="phase-description">${phaseDesc}</p>
                    `;
                } else {
                    dom.modals.menstrualCycleDisplay.innerHTML = `
                        <div class="text-center p-4">
                            <i class="fas fa-calendar-alt text-4xl text-text-secondary mb-2"></i>
                            <p class="text-text-secondary">Registra la fecha para empezar el seguimiento de tu ciclo.</p>
                        </div>
                    `;
                }
            }
            
            function startSleepClock() {
                 if (state.sleep.clockInterval) clearInterval(state.sleep.clockInterval);
                 state.sleep.clockInterval = setInterval(() => {
                    const now = new Date();
                    dom.sleep.clock.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                 }, 1000);
            }

            function stopSleepSound() {
                if (state.sleep.isPlaying) {
                    if (state.sleep.soundNode) {
                        state.sleep.gainNode.gain.linearRampToValueAtTime(0, state.audioContext.currentTime + 1.5);
                        state.sleep.soundNode.stop(state.audioContext.currentTime + 1.5);
                    }
                    if (state.sleep.timerId) clearTimeout(state.sleep.timerId);
                    state.sleep.soundNode = null;
                    state.sleep.isPlaying = false;
                    dom.sleep.toggleBtn.querySelector('i').className = 'fas fa-play mr-2';
                    dom.sleep.toggleBtn.querySelector('span').textContent = translations[state.language].sleep_start_button;
                    dom.sleep.timerIndicator.classList.add('hidden');
                }
            }

            function toggleSleepSound() {
                initAudio();
                const lang = state.language;
                const btn = dom.sleep.toggleBtn;

                if (state.sleep.isPlaying) {
                    stopSleepSound();
                } else {
                    const bufferSize = state.audioContext.sampleRate * 2;
                    const noiseBuffer = state.audioContext.createBuffer(1, bufferSize, state.audioContext.sampleRate);
                    const output = noiseBuffer.getChannelData(0);

                    if (state.sleep.selectedSound === 'brown') {
                        let lastOut = 0.0;
                        for (let i = 0; i < bufferSize; i++) {
                            const white = Math.random() * 2 - 1;
                            output[i] = (lastOut + (0.02 * white)) / 1.02;
                            lastOut = output[i];
                            output[i] *= 3.5;
                        }
                    } else { // Simplified rain/forest
                        for (let i = 0; i < bufferSize; i++) {
                            output[i] = Math.random() * 2 - 1;
                        }
                    }

                    const noiseNode = state.audioContext.createBufferSource();
                    noiseNode.buffer = noiseBuffer;
                    noiseNode.loop = true;

                    const gainNode = state.audioContext.createGain();
                    gainNode.gain.setValueAtTime(0, state.audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.2, state.audioContext.currentTime + 3);
                    noiseNode.connect(gainNode);
                    gainNode.connect(state.audioContext.destination);
                    noiseNode.start(0);

                    state.sleep.soundNode = noiseNode;
                    state.sleep.gainNode = gainNode;
                    state.sleep.isPlaying = true;
                    btn.querySelector('i').className = 'fas fa-stop mr-2';
                    btn.querySelector('span').textContent = translations[lang].sleep_stop_button;

                    const timerDuration = parseInt(dom.sleep.timerSlider.value);
                    if (timerDuration > 0) {
                        state.sleep.timerId = setTimeout(stopSleepSound, timerDuration * 60 * 1000);
                        dom.sleep.timerIndicator.classList.remove('hidden');
                    }
                }
            }

            function toggleBreathingExercise(stop = false, type = 'calm') {
                const lang = state.language;
                const calmBtn = dom.wellness.startCalmBreathingBtn;
                const powerBtn = dom.wellness.startPowerBreathingBtn;
                const relaxBtn = dom.wellness.startRelaxBreathingBtn;
                const circle = dom.wellness.breathingVisualCircle;

                if (state.wellness.isBreathing || stop) {
                    clearInterval(state.wellness.breathingInterval);
                    state.wellness.isBreathing = false;
                    calmBtn.innerHTML = `<i class="fas fa-play mr-2"></i><span>${translations[lang].wellness_breathing_calm}</span>`;
                    powerBtn.innerHTML = `<i class="fas fa-bolt mr-2"></i><span>${translations[lang].wellness_breathing_power}</span>`;
                    relaxBtn.innerHTML = `<i class="fas fa-leaf mr-2"></i><span>${translations[lang].wellness_breathing_relax}</span>`;
                    dom.wellness.breathingInstruction.textContent = '';
                    circle.style.animation = '';
                    calmBtn.disabled = false;
                    powerBtn.disabled = false;
                    relaxBtn.disabled = false;
                    if (!stop) {
                        logActivityToHistory({ type: 'breathing', title: `Respiraci√≥n de ${state.wellness.breathingType}`, duration: 1 });
                        checkDailyMissions('breathing');
                    }
                } else {
                    state.wellness.isBreathing = true;
                    state.wellness.breathingType = type;
                    
                    calmBtn.disabled = true;
                    powerBtn.disabled = true;
                    relaxBtn.disabled = true;

                    let steps;
                    let activeBtn;
                    if (type === 'calm') {
                        activeBtn = calmBtn;
                        steps = [
                            { instruction: translations[lang].wellness_breathe_in, duration: 4000, animation: 'calm-breathe-in 4s ease-in-out forwards' }, 
                            { instruction: translations[lang].wellness_breathe_hold, duration: 7000, animation: '' }, 
                            { instruction: translations[lang].wellness_breathe_out, duration: 8000, animation: 'calm-breathe-out 8s ease-in-out forwards' }
                        ];
                    } else if (type === 'power') {
                        activeBtn = powerBtn;
                        steps = [
                            { instruction: translations[lang].wellness_breathe_in, duration: 600, animation: 'power-breathe-in 0.6s ease-in-out forwards' },
                            { instruction: translations[lang].wellness_breathe_out, duration: 600, animation: 'power-breathe-out 0.6s ease-in-out forwards' }
                        ];
                    } else if (type === 'relax') {
                        activeBtn = relaxBtn;
                        steps = [
                            { instruction: translations[lang].wellness_breathe_in, duration: 6000, animation: 'relax-breathe-in 6s ease-in-out forwards' },
                            { instruction: translations[lang].wellness_breathe_hold, duration: 2000, animation: '' },
                            { instruction: translations[lang].wellness_breathe_out, duration: 8000, animation: 'relax-breathe-out 8s ease-in-out forwards' }
                        ];
                    }

                    activeBtn.innerHTML = `<i class="fas fa-stop mr-2"></i><span>Detener</span>`;
                    activeBtn.disabled = false; // Only the active button remains enabled

                    let currentStep = -1;
                    const cycle = () => {
                        currentStep = (currentStep + 1) % steps.length;
                        const step = steps[currentStep];
                        dom.wellness.breathingInstruction.textContent = step.instruction;
                        circle.style.animation = 'none'; // Reset animation
                        void circle.offsetWidth; // Trigger reflow
                        circle.style.animation = step.animation;
                        
                        playBeep(currentStep === 0 ? 523 : 440, 150);
                        state.wellness.breathingInterval = setTimeout(cycle, step.duration);
                    };
                    cycle();
                }
            }

            // --- Anti-Stress Module (New) ---
            let stressVisualizerCtx;
            function startStressVisualizer() {
                const canvas = dom.modals.stressVisualizerCanvas;
                stressVisualizerCtx = canvas.getContext('2d');

                // Set canvas dimensions to match display size for crisp rendering
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;

                // Particle properties
                const particles = [];
                const numParticles = 50;

                for (let i = 0; i < numParticles; i++) {
                    particles.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        radius: Math.random() * 5 + 2, // 2 to 7
                        color: `rgba(138, 79, 255, ${Math.random() * 0.5 + 0.3})`, // Primary color with varying opacity
                        speedX: (Math.random() - 0.5) * 0.5, // Slow movement
                        speedY: (Math.random() - 0.5) * 0.5,
                        alpha: Math.random() * 0.7 + 0.3, // Initial opacity
                        decay: Math.random() * 0.005 + 0.001 // Slow decay
                    });
                }
                state.wellness.stressVisualizerParticles = particles;

                function animateStressVisualizer() {
                    stressVisualizerCtx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

                    for (let i = 0; i < particles.length; i++) {
                        const p = particles[i];

                        // Update position
                        p.x += p.speedX;
                        p.y += p.speedY;
                        p.alpha -= p.decay;

                        // Reset particle if it fades out or goes off screen
                        if (p.alpha <= 0 || p.x < 0 || p.x > canvas.width || p.y < 0 || p.y > canvas.height) {
                            particles[i] = {
                                x: Math.random() * canvas.width,
                                y: Math.random() * canvas.height,
                                radius: Math.random() * 5 + 2,
                                color: `rgba(138, 79, 255, ${Math.random() * 0.5 + 0.3})`,
                                speedX: (Math.random() - 0.5) * 0.5,
                                speedY: (Math.random() - 0.5) * 0.5,
                                alpha: Math.random() * 0.7 + 0.3,
                                decay: Math.random() * 0.005 + 0.001
                            };
                        }

                        // Draw particle
                        stressVisualizerCtx.beginPath();
                        stressVisualizerCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2, false);
                        stressVisualizerCtx.fillStyle = `rgba(138, 79, 255, ${p.alpha})`; // Use primary color with alpha
                        stressVisualizerCtx.fill();
                    }

                    state.wellness.stressVisualizerAnimationId = requestAnimationFrame(animateStressVisualizer);
                }
                state.wellness.stressVisualizerAnimationId = requestAnimationFrame(animateStressVisualizer);
            }

            function stopStressVisualizer() {
                if (state.wellness.stressVisualizerAnimationId) {
                    cancelAnimationFrame(state.wellness.stressVisualizerAnimationId);
                    state.wellness.stressVisualizerAnimationId = null;
                    state.wellness.stressVisualizerParticles = []; // Clear particles
                    if (stressVisualizerCtx) {
                        stressVisualizerCtx.clearRect(0, 0, dom.modals.stressVisualizerCanvas.width, dom.modals.stressVisualizerCanvas.height);
                    }
                }
            }

            function startStressSound() {
                initAudio();
                if (state.wellness.isStressSoundPlaying) return;

                // Create a soft, evolving pad sound
                state.wellness.stressSynth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "sine" },
                    envelope: {
                        attack: 2,
                        decay: 1,
                        sustain: 0.5,
                        release: 3
                    },
                    volume: -25 // Start quietly
                }).toDestination();

                // Play a low, sustained chord that slowly changes
                const notes = ["C2", "G2", "C3", "E3"];
                let currentNoteIndex = 0;

                const playNextNote = () => {
                    if (!state.wellness.isStressSoundPlaying) return; // Stop if sound is off
                    state.wellness.stressSynth.triggerAttackRelease(notes[currentNoteIndex], "4n", Tone.now());
                    currentNoteIndex = (currentNoteIndex + 1) % notes.length;
                };

                // Schedule notes to play every few seconds
                Tone.Transport.scheduleRepeat(playNextNote, "4s");
                Tone.Transport.start();

                state.wellness.isStressSoundPlaying = true;

                dom.modals.toggleStressSoundBtn.querySelector('i').className = 'fas fa-stop mr-2';
                dom.modals.toggleStressSoundBtn.querySelector('span').textContent = 'Detener Sonido Calmante';
            }

            function stopStressSound() {
                if (state.wellness.isStressSoundPlaying && state.wellness.stressSynth) {
                    Tone.Transport.stop(); // Stop the Tone.js transport
                    Tone.Transport.cancel(); // Clear all scheduled events
                    state.wellness.stressSynth.releaseAll(); // Release any held notes
                    state.wellness.stressSynth.dispose(); // Dispose of the synth
                    state.wellness.stressSynth = null;
                    state.wellness.isStressSoundPlaying = false;
                    dom.modals.toggleStressSoundBtn.querySelector('i').className = 'fas fa-play mr-2';
                    dom.modals.toggleStressSoundBtn.querySelector('span').textContent = 'Iniciar Sonido Calmante';
                }
            }

            // --- Progress Module ---
            function logActivityToHistory(activity) {
                const today = new Date().toISOString().split('T')[0];
                const pointsEarned = (activity.duration || 1) * 5 + (activity.beastMode ? 50 : 0);
                
                state.progress.history.unshift({
                    date: today,
                    ...activity
                });
                state.progress.points += pointsEarned;

                if (activity.type === 'workout' && activity.muscleGroups) {
                    activity.muscleGroups.forEach(group => {
                        state.progress.muscleGroupsWorked[group] = (state.progress.muscleGroupsWorked[group] || 0) + (activity.duration * 60);
                    });
                }
                
                // Update workout streak
                if (activity.type === 'workout') {
                    if (state.progress.lastWorkoutDate) {
                        const lastDate = new Date(state.progress.lastWorkoutDate);
                        const todayDate = new Date(today);
                        const diffTime = Math.abs(todayDate - lastDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays === 1) { // Consecutive day
                            state.progress.workoutStreak++;
                        } else if (diffDays > 1) { // Break in streak
                            state.progress.workoutStreak = 1;
                        }
                    } else { // First workout ever
                        state.progress.workoutStreak = 1;
                    }
                    state.progress.lastWorkoutDate = today;
                    checkAchievements(); // Check achievements after workout streak update
                }

                checkRewards(); // Check rewards after logging activity
                saveAllData();
                updatePointsDisplay();
            }

            function updatePointsDisplay() {
                dom.dashboard.pointsValue.textContent = state.progress.points;
            }

            function checkAchievements() {
                if (!state.progress.achievements.first_workout) {
                    state.progress.achievements.first_workout = true;
                    showToast("¬°Logro desbloqueado: Primer Paso!", 'success');
                }
                if (state.aiWorkout.beastModeActivated && !state.progress.achievements.beast_mode) {
                    state.progress.achievements.beast_mode = true;
                    showToast("¬°Logro desbloqueado: Modo Bestia!", 'success');
                }
                if (state.progress.workoutStreak >= 7 && !state.progress.achievements.seven_day_streak) {
                    state.progress.achievements.seven_day_streak = true;
                    showToast("¬°Logro desbloqueado: Imparable (7 d√≠as de racha)!", 'success');
                }
                // Perfect week logic (more complex, requires checking all 7 days had a workout)
                // For simplicity, let's assume a "perfect week" is 5+ workouts in a week for now.
                const today = new Date();
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1)));
                startOfWeek.setHours(0,0,0,0);
                const workoutsThisWeek = state.progress.history.filter(activity => 
                    activity.type === 'workout' && new Date(activity.date + 'T00:00:00') >= startOfWeek
                ).length;
                if (workoutsThisWeek >= 5 && !state.progress.achievements.perfect_week) {
                    state.progress.achievements.perfect_week = true;
                    showToast("¬°Logro desbloqueado: Semana Perfecta!", 'success');
                }
            }

            function checkRewards() {
                const rewards = [
                    { id: 'cine', points: 500, title: "Entrada al Cine", desc: "Cine al aire libre con Pa' la Raza Club.", link: "https://www.palaraza.club/servicios/eventos/cine-al-aire-libre", icon: "fa-film" },
                    { id: 'curso', points: 1500, title: "Curso Gratis", desc: "Certificaci√≥n en el Centro Iberoamericano.", link: "https://www.ibero.education/oferta-acad%C3%A9mica/certificaciones", icon: "fa-graduation-cap" },
                    { id: 'premium_access', points: 10000, title: "Acceso Premium goatiFIT", desc: "Desbloquea funciones exclusivas por 1 mes.", link: "https://www.goatify.app/goatifit-premium", icon: "fa-crown" },
                    { id: 'goatify', points: 30000, title: "Paquete Goatify", desc: "P√°gina web o paquete de app gratis.", link: "https://www.goatify.app/inicio", icon: "fa-rocket" },
                ];

                rewards.forEach(reward => {
                    const isClaimed = state.progress.claimedRewards.includes(reward.id);
                    if (!isClaimed && state.progress.points >= reward.points) {
                        showToast(`¬°Has alcanzado ${reward.points} puntos! Puedes reclamar tu ${reward.title}.`, 'info');
                    } else if (!isClaimed && state.progress.points >= reward.points * 0.8 && state.progress.points < reward.points) {
                        // Notify when 80% of points are reached
                        showToast(`${translations[state.language].reward_near_message} ${reward.title}!`, 'info');
                    }
                });
            }

            function claimReward(rewardId) {
                const reward = [
                    { id: 'cine', points: 500, title: "Entrada al Cine", desc: "Cine al aire libre con Pa' la Raza Club.", link: "https://www.palaraza.club/servicios/eventos/cine-al-aire-libre", icon: "fa-film" },
                    { id: 'curso', points: 1500, title: "Curso Gratis", desc: "Certificaci√≥n en el Centro Iberoamericano.", link: "https://www.ibero.education/oferta-acad%C3%A9mica/certificaciones", icon: "fa-graduation-cap" },
                    { id: 'premium_access', points: 10000, title: "Acceso Premium goatiFIT", desc: "Desbloquea funciones exclusivas por 1 mes.", link: "https://www.goatify.app/goatifit-premium", icon: "fa-crown" },
                    { id: 'goatify', points: 30000, title: "Paquete Goatify", desc: "P√°gina web o paquete de app gratis.", link: "https://www.goatify.app/inicio", icon: "fa-rocket" },
                ].find(r => r.id === rewardId);

                if (reward && state.progress.points >= reward.points && !state.progress.claimedRewards.includes(reward.id)) {
                    state.progress.claimedRewards.push(reward.id);
                    state.progress.points = 0; // Reset points to zero as per user request
                    saveAllData();
                    updatePointsDisplay();
                    renderRewards(); // Re-render rewards to update state

                    showModal('rewardClaimed', {
                        message: `¬°Felicidades! Has reclamado "${reward.title}". Contacta a la empresa para canjear tu beneficio.`,
                        link: reward.link
                    });
                } else if (state.progress.claimedRewards.includes(rewardId)) {
                    showToast("Ya has reclamado esta recompensa.", 'info');
                } else {
                    showToast("No tienes suficientes puntos para reclamar esta recompensa.", 'error');
                }
            }


            function renderProgressScreen() {
                renderHistory();
                renderAchievements();
                renderWeeklyMetrics();
                renderBodyMap();
                renderRewards();
                dom.progress.workoutStreak.textContent = state.progress.workoutStreak;
            }

            function renderHistory() {
                dom.progress.historyList.innerHTML = '';
                if (state.progress.history.length === 0) {
                    dom.progress.historyList.innerHTML = `<p class="text-text-secondary text-center">${translations[state.language].mission_placeholder}</p>`;
                    return;
                }
                const iconMap = {
                    workout: 'fa-dumbbell',
                    breathing: 'fa-lungs',
                    meditation: 'fa-brain',
                    pelvic_floor: 'fa-heart-pulse',
                    ice: 'fa-snowflake',
                    water: 'fa-droplet', // For water intake
                    sleep: 'fa-bed', // For sleep tracking
                    reflection: 'fa-lightbulb', // For reflection
                };
                state.progress.history.slice(0, 20).forEach(activity => {
                    const el = document.createElement('div');
                    el.className = 'bg-secondary p-3 rounded-lg flex justify-between items-center';
                    el.innerHTML = `
                        <div class="flex items-center gap-4">
                            <i class="fas ${iconMap[activity.type] || 'fa-question-circle'} text-primary text-xl"></i>
                            <div>
                                <p class="font-bold">${activity.title}</p>
                                <p class="text-sm text-text-secondary">${new Date(activity.date).toLocaleDateString(state.language, { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                            </div>
                        </div>
                        <div class="text-right">
                             <p class="font-bold text-primary">${activity.duration} min</p>
                             ${activity.beastMode ? '<i class="fas fa-skull-crossbones text-danger"></i>' : ''}
                        </div>
                    `;
                    dom.progress.historyList.appendChild(el);
                });
            }

            function renderAchievements() {
                dom.progress.achievementsGrid.innerHTML = '';
                const lang = state.language;
                const achievementDefs = {
                    first_workout: { icon: 'fa-shoe-prints', name: translations[lang].achievement_first_workout_name, desc: translations[lang].achievement_first_workout_desc },
                    seven_day_streak: { icon: 'fa-fire', name: translations[lang].achievement_seven_day_streak_name, desc: translations[lang].achievement_seven_day_streak_desc },
                    beast_mode: { icon: 'fa-skull-crossbones', name: translations[lang].achievement_beast_mode_name, desc: translations[lang].achievement_beast_mode_desc },
                    perfect_week: { icon: 'fa-calendar-check', name: translations[lang].achievement_perfect_week_name, desc: translations[lang].achievement_perfect_week_desc },
                };
                for (const key in achievementDefs) {
                    const unlocked = state.progress.achievements[key];
                    const def = achievementDefs[key];
                    const el = document.createElement('div');
                    el.className = `p-2 rounded-lg transition-all ${unlocked ? 'bg-primary text-white' : 'bg-secondary text-text-secondary opacity-50'}`;
                    el.title = def.desc;
                    el.innerHTML = `<i class="fas ${def.icon} text-3xl"></i><p class="text-xs mt-1 font-bold">${def.name}</p>`;
                    dom.progress.achievementsGrid.appendChild(el);
                }
            }
            
            function renderWeeklyMetrics() {
                const weeklyStats = { minutes: 0, routines: 0, calories: 0, water: 0, sleep: 0, workouts: 0 }; // Added workouts
                const now = new Date();
                const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1))); // Monday as start of week
                startOfWeek.setHours(0, 0, 0, 0);

                state.progress.history.forEach(activity => {
                    const activityDate = new Date(activity.date + 'T00:00:00');
                    if (activityDate >= startOfWeek) {
                        if (activity.type === 'workout') {
                            weeklyStats.minutes += activity.duration;
                            weeklyStats.routines++;
                            weeklyStats.calories += activity.duration * 8; // Approx. 8 cal/min
                            weeklyStats.workouts++; // Increment workouts
                        } else if (activity.type === 'water') {
                            weeklyStats.water += activity.amount;
                        } else if (activity.type === 'sleep') {
                            weeklyStats.sleep += activity.hours;
                        }
                    }
                });

                dom.progress.minutesValue.textContent = weeklyStats.minutes;
                dom.progress.routinesValue.textContent = weeklyStats.routines;
                dom.progress.caloriesValue.textContent = weeklyStats.calories;
                dom.progress.totalWorkoutsValue.textContent = weeklyStats.workouts; // Update new circle value

                const maxMinutes = 300, maxRoutines = 5, maxCalories = 2400, maxWorkouts = 7; // Max workouts per week
                const minutesProgress = Math.min(1, weeklyStats.minutes / maxMinutes);
                const routinesProgress = Math.min(1, weeklyStats.routines / maxRoutines);
                const caloriesProgress = Math.min(1, weeklyStats.calories / maxCalories);
                const workoutsProgress = Math.min(1, weeklyStats.workouts / maxWorkouts); // New progress

                const dashoffset = 340;
                dom.progress.minutesCircle.style.strokeDashoffset = dashoffset * (1 - minutesProgress);
                dom.progress.routinesCircle.style.strokeDashoffset = dashoffset * (1 - routinesProgress);
                dom.progress.caloriesCircle.style.strokeDashoffset = dashoffset * (1 - caloriesProgress);
                dom.progress.totalWorkoutsCircle.style.strokeDashoffset = dashoffset * (1 - workoutsProgress); // Apply new progress
                
                dom.progress.minutesCircle.style.stroke = minutesProgress >= 1 ? 'var(--success)' : 'var(--primary)';
                dom.progress.routinesCircle.style.stroke = routinesProgress >= 1 ? 'var(--success)' : 'var(--primary)';
                dom.progress.caloriesCircle.style.stroke = caloriesProgress >= 1 ? 'var(--success)' : 'var(--primary)';
                dom.progress.totalWorkoutsCircle.style.stroke = workoutsProgress >= 1 ? 'var(--success)' : 'var(--primary)'; // Apply color for new circle
            }


            function renderBodyMap() {
                const bodyMapSVG = `
                    <svg id="body-map-front" viewBox="0 0 200 400">
                        <title>Vista Frontal</title>
                        <circle cx="100" cy="40" r="20" class="muscle-group" data-muscle="neck"></circle>
                        <path class="muscle-group" data-muscle="shoulders" d="M86,74 C86,71 88,69 91,69 L109,69 C112,69 114,71 114,74 L114,80 L86,80 Z" />
                        <circle class="muscle-group" data-muscle="shoulders" cx="100" cy="60" r="18" />
                        <path class="muscle-group" data-muscle="shoulders" d="M70,95 L60,105 L65,120 L75,125 Z" />
                        <path class="muscle-group" data-muscle="shoulders" d="M130,95 L140,105 L135,120 L125,125 Z" />
                        <path class="muscle-group" data-muscle="chest" d="M70,95 C70,90 75,88 80,88 L120,88 C125,88 130,90 130,95 L125,125 L100,145 L75,125 Z" />
                        <path class="muscle-group" data-muscle="core" d="M80,148 L120,148 L115,190 L85,190 Z" />
                        <path class="muscle-group" data-muscle="core" d="M75,125 L80,148 L85,190 L78,185 Z" />
                        <path class="muscle-group" data-muscle="core" d="M125,125 L120,148 L115,190 L122,185 Z" />
                        <path class="muscle-group" data-muscle="biceps" d="M60,105 L50,115 L55,150 L65,120 Z" />
                        <path class="muscle-group" data-muscle="biceps" d="M140,105 L150,115 L145,150 L135,120 Z" />
                        <path class="muscle-group" data-muscle="forearms" d="M55,150 L50,115 L45,170 L55,175 Z" />
                        <path class="muscle-group" data-muscle="forearms" d="M145,150 L150,115 L155,170 L145,175 Z" />
                        <path class="muscle-group" data-muscle="quads" d="M85,190 L115,190 L120,280 L110,320 L90,320 L80,280 Z" />
                        <path class="muscle-group" data-muscle="quads" d="M90,320 L110,320 L105,350 L95,350 Z" />
                        <path class="muscle-group" data-muscle="calves" d="M85,325 C80,350 85,370 85,370 L95,370 C95,370 90,350 90,325 Z" />
                        <path class="muscle-group" data-muscle="calves" d="M115,325 C120,350 115,370 115,370 L105,370 C105,370 110,350 110,325 Z" />
                        <path class="muscle-group" data-muscle="feet" d="M80,370 L80,380 L95,380 L95,370 Z" />
                        <path class="muscle-group" data-muscle="feet" d="M120,370 L120,380 L105,380 L105,370 Z" />
                    </svg>
                    <svg id="body-map-back" viewBox="0 0 200 400">
                        <title>Vista Trasera</title>
                        <path class="muscle-group" data-muscle="traps" d="M80,70 L120,70 L110,85 L90,85 Z" />
                        <path class="muscle-group" data-muscle="back" d="M90,80 L110,80 L120,95 L80,95 Z" />
                        <path class="muscle-group" data-muscle="back" d="M80,95 L120,95 L125,150 L110,160 L90,160 L75,150 Z" />
                        <path class="muscle-group" data-muscle="back" d="M90,160 L110,160 L105,180 L95,180 Z" />
                        <path class="muscle-group" data-muscle="glutes" d="M80,180 L120,180 C125,190 125,200 120,210 L80,210 C75,200 75,190 80,180 Z" />
                        <path class="muscle-group" data-muscle="triceps" d="M75,100 L65,110 L70,160 L80,155 Z" />
                        <path class="muscle-group" data-muscle="triceps" d="M125,100 L135,110 L130,160 L120,155 Z" />
                        <path class="muscle-group" data-muscle="hamstrings" d="M80,210 L120,210 L115,310 L85,310 Z" />
                        <path class="muscle-group" data-muscle="calves" d="M85,310 L115,310 L110,360 L90,360 Z" />
                        <path class="muscle-group" data-muscle="feet" d="M80,370 L80,380 L95,380 L95,370 Z" />
                        <path class="muscle-group" data-muscle="feet" d="M120,370 L120,380 L105,380 L105,370 Z" />
                    </svg>
                `;
                dom.progress.bodyMapContainer.innerHTML = bodyMapSVG;

                const muscleColors = {
                    'quads': 'var(--primary)', 'hamstrings': 'var(--primary)', 'glutes': 'var(--primary-hover)', 'core': 'var(--success)',
                    'chest': 'var(--warning)', 'back': 'var(--danger)', 'biceps': 'var(--info)', 'triceps': 'var(--info)',
                    'forearms': 'var(--info)', 'shoulders': '#7c8dff', 'calves': '#a0a0a0', 'full_body': 'var(--text-secondary)',
                    'traps': '#ff8c00', // Orange for Traps
                    'neck': '#cccccc',
                    'feet': '#999999',
                };
                
                document.querySelectorAll('.muscle-group').forEach(el => {
                    el.style.fill = 'var(--secondary)';
                    el.style.opacity = 0.6;
                });

                const muscleData = state.progress.muscleGroupsWorked;
                let maxWork = 1;
                for (const muscle in muscleData) { if (muscleData[muscle] > maxWork) maxWork = muscleData[muscle]; }
                for (const muscle in muscleData) {
                    const genericMuscle = ['quads', 'hamstrings'].includes(muscle) ? 'legs' : muscle;
                    const color = muscleColors[muscle] || muscleColors['full_body'];
                    const intensity = Math.min(1, muscleData[muscle] / maxWork);
                    const elements = document.querySelectorAll(`[data-muscle="${muscle}"], [data-muscle="${genericMuscle}"], [data-muscle="full_body"]`);
                    elements.forEach(el => {
                        const isFullBody = el.dataset.muscle === 'full_body';
                        el.style.fill = color;
                        el.style.opacity = isFullBody ? intensity * 0.5 + 0.2 : intensity * 0.8 + 0.2;
                    });
                }
                
                // Add tooltip events
                document.querySelectorAll('.muscle-group').forEach(el => {
                    el.addEventListener('mousemove', e => {
                        const muscleKey = `muscle_${el.dataset.muscle}`;
                        dom.tooltip.textContent = translations.es[muscleKey] || el.dataset.muscle;
                        dom.tooltip.style.left = `${e.clientX + 15}px`;
                        dom.tooltip.style.top = `${e.clientY + 15}px`;
                    });
                    el.addEventListener('mouseover', () => dom.tooltip.style.display = 'block');
                    el.addEventListener('mouseout', () => dom.tooltip.style.display = 'none');
                });
            }

            function renderRewards() {
                const rewards = [
                    { id: 'cine', points: 500, title: "Entrada al Cine", desc: "Cine al aire libre con Pa' la Raza Club.", link: "https://www.palaraza.club/servicios/eventos/cine-al-aire-libre", icon: "fa-film" },
                    { id: 'curso', points: 1500, title: "Curso Gratis", desc: "Certificaci√≥n en el Centro Iberoamericano.", link: "https://www.ibero.education/oferta-acad%C3%A9mica/certificaciones", icon: "fa-graduation-cap" },
                    { id: 'premium_access', points: 10000, title: "Acceso Premium goatiFIT", desc: "Desbloquea funciones exclusivas por 1 mes.", link: "https://www.goatify.app/goatifit-premium", icon: "fa-crown" },
                    { id: 'goatify', points: 30000, title: "Paquete Goatify", desc: "P√°gina web o paquete de app gratis.", link: "https://www.goatify.app/inicio", icon: "fa-rocket" },
                ];
                
                dom.progress.rewardsGrid.innerHTML = '';
                rewards.forEach(reward => {
                    const unlocked = state.progress.points >= reward.points;
                    const claimed = state.progress.claimedRewards.includes(reward.id);
                    const el = document.createElement('div');
                    el.className = `glassmorphism p-4 rounded-lg flex items-center gap-4 transition-all ${unlocked && !claimed ? 'opacity-100' : 'opacity-40'}`;
                    el.innerHTML = `
                        <div class="text-3xl w-12 h-12 flex items-center justify-center rounded-lg bg-secondary ${unlocked && !claimed ? 'text-primary' : ''}">
                            <i class="fas ${reward.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold">${reward.title}</h3>
                            <p class="text-sm text-text-secondary">${reward.desc}</p>
                            <div class="w-full bg-secondary rounded-full h-2.5 mt-2">
                                <div class="bg-primary h-2.5 rounded-full" style="width: ${Math.min(100, (state.progress.points / reward.points) * 100)}%"></div>
                            </div>
                            <p class="text-xs text-right mt-1">${state.progress.points} / ${reward.points} PTS</p>
                        </div>
                        ${unlocked && !claimed ? `<button class="btn btn-primary p-2 w-10 h-10 claim-reward-btn" data-reward-id="${reward.id}">
                            <i class="fas fa-gift"></i>
                        </button>` : claimed ? `<span class="text-success text-sm font-bold">RECLAMADO</span>` : `<a href="${reward.link}" target="_blank" class="btn btn-primary p-2 w-10 h-10 ${unlocked ? '' : 'hidden'}">
                            <i class="fas fa-arrow-right"></i>
                        </a>`}
                    `;
                    dom.progress.rewardsGrid.appendChild(el);
                });
            }
            
            // --- Notifications & Alarms ---
            function renderSettingsScreen() {
                dom.settings.notificationsList.innerHTML = '';
                const lang = state.language;
                Object.keys(state.notifications).forEach(key => {
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center';
                    el.innerHTML = `
                        <span class="font-bold">${translations[lang][`notification_reminder_${key}`]}</span>
                        <label class="switch">
                            <input type="checkbox" class="notification-toggle" data-type="${key}" ${state.notifications[key].enabled ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    `;
                    dom.settings.notificationsList.appendChild(el);
                });
                renderAlarms();
                dom.settings.themeToggle.checked = state.theme === 'dark'; // Set theme toggle state
                dom.settings.languageSelect.value = state.language; // Set language select state
            }

            function renderAlarms() {
                 dom.settings.alarmsList.innerHTML = '';
                 if (state.alarms.length === 0) {
                    dom.settings.alarmsList.innerHTML = `<p class="text-text-secondary text-center">No hay alarmas configuradas.</p>`;
                 }
                 const dayLetters = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];
                 state.alarms.forEach((alarm, index) => {
                    const el = document.createElement('div');
                    el.className = 'bg-secondary p-4 rounded-lg flex justify-between items-center';
                    
                    const daysStr = alarm.days.map((active, i) => active ? `<span class="text-primary font-bold">${dayLetters[i]}</span>` : `<span>${dayLetters[i]}</span>`).join(' ');

                    el.innerHTML = `
                        <div class="flex-grow cursor-pointer" data-index="${index}">
                            <p class="font-bold text-lg">${alarm.name}</p>
                            <p class="text-text-secondary">${alarm.time} - ${daysStr}</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" class="alarm-toggle" data-index="${index}" ${alarm.enabled ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    `;
                    el.querySelector('.flex-grow').addEventListener('click', () => showModal('alarm', { index, alarm }));
                    dom.settings.alarmsList.appendChild(el);
                 });
            }

            function saveAlarm() {
                const name = dom.modals.alarmName.value.trim() || 'Alarma';
                const time = dom.modals.alarmTime.value;
                const days = Array.from(dom.modals.alarmDaySelector.querySelectorAll('.day-btn')).map(btn => btn.classList.contains('active'));

                if (!time) {
                    showToast('Por favor, selecciona una hora.', 'error');
                    return;
                }

                const newAlarm = { name, time, days, enabled: true };

                if (state.editingAlarmIndex === null) {
                    state.alarms.push(newAlarm);
                } else {
                    state.alarms[state.editingAlarmIndex] = newAlarm;
                }
                
                state.alarms.sort((a, b) => a.time.localeCompare(b.time));
                saveAllData();
                renderAlarms();
                hideModal();
                setupAlarmChecks(); // Re-setup alarm checks after saving
            }

            let alarmCheckInterval;
            function setupAlarmChecks() {
                if (alarmCheckInterval) clearInterval(alarmCheckInterval);
                alarmCheckInterval = setInterval(() => {
                    const now = new Date();
                    const currentHour = String(now.getHours()).padStart(2, '0');
                    const currentMinute = String(now.getMinutes()).padStart(2, '0');
                    const currentTime = `${currentHour}:${currentMinute}`;
                    const currentDay = now.getDay(); // 0 for Sunday, 1 for Monday, etc.

                    state.alarms.forEach(alarm => {
                        if (alarm.enabled && alarm.time === currentTime && alarm.days[currentDay]) {
                            playBeep(700, 1000, 'triangle'); // Play a distinct alarm sound
                            showToast(`¬°Alarma: ${alarm.name}!`, 'info');
                            // Optionally, disable alarm after it sounds once, or for the day
                            // alarm.enabled = false; // To make it sound only once
                            // saveAllData();
                            // renderAlarms();
                        }
                    });

                    // Water Reminder (4 times a day)
                    if (state.notifications.water.enabled) {
                        const waterReminderHours = [9, 13, 17, 21]; // 9 AM, 1 PM, 5 PM, 9 PM
                        const currentHourInt = now.getHours();
                        const currentMinuteInt = now.getMinutes();

                        if (waterReminderHours.includes(currentHourInt) && (currentMinuteInt === 0 || currentMinuteInt === 1)) {
                            // Check if already triggered for this hour today
                            const lastTriggeredHour = localStorage.getItem('goatiFitWaterReminderTriggeredHour');
                            const lastTriggeredDate = localStorage.getItem('goatiFitWaterReminderTriggeredDate');
                            const todayDate = new Date().toISOString().split('T')[0];

                            if (lastTriggeredDate !== todayDate || parseInt(lastTriggeredHour) !== currentHourInt) {
                                showToast(translations[state.language].daily_mission_water_reminder, 'info');
                                playBeep(500, 300);
                                localStorage.setItem('goatiFitWaterReminderTriggeredHour', currentHourInt);
                                localStorage.setItem('goatiFitWaterReminderTriggeredDate', todayDate);
                                // Log water activity for daily mission check
                                logActivityToHistory({ type: 'water', title: 'Recordatorio de Agua', duration: 0, amount: 0.5 }); // Log 0.5L per reminder
                                checkDailyMissions('water');
                            }
                        }
                    }

                    // Other general notifications (can be simplified to trigger once per day at certain times)
                    const notificationTimes = {
                        stand: '10:00', // 10 AM
                        train: '18:00', // 6 PM
                        sleep: '22:00', // 10 PM
                        motivation: '08:00' // 8 AM
                    };

                    for (const type in notificationTimes) {
                        if (state.notifications[type].enabled && notificationTimes[type] === currentTime) {
                            // Prevent multiple triggers within the same minute
                            const lastNotificationKey = `lastNotification_${type}_${currentHour}_${currentMinute}`;
                            if (!localStorage.getItem(lastNotificationKey)) {
                                showToast(translations[state.language][`daily_mission_${type}_reminder`], 'info');
                                playBeep(500, 300);
                                localStorage.setItem(lastNotificationKey, 'true');
                                // Clear this flag after a minute to allow next day's trigger
                                setTimeout(() => localStorage.removeItem(lastNotificationKey), 60 * 1000);
                            }
                        }
                    }

                }, 60 * 1000); // Check every minute
            }


            // --- Offline Module & Custom Routines ---
            const offlineWorkouts = [
                { 
                    title: "Fuerza Total Sin Equipo", 
                    icon: "fa-hand-fist", 
                    muscleGroups: ["full_body"], 
                    totalDurationMinutes: 20,
                    phases: [
                        { phaseName: "Calentamiento", type: "prep", durationSeconds: 120, exerciseName: "Movilidad General", howTo: ["Realiza c√≠rculos con brazos y piernas.", "Estira suavemente el cuello y los hombros."], muscleGroups: ["full_body"] },
                        { phaseName: "Sentadillas", type: "work", durationSeconds: 180, exerciseName: "Sentadillas con Peso Corporal", sets: "3", reps: "15", howTo: ["Pies al ancho de hombros.", "Baja la cadera como si te sentaras.", "Mant√©n la espalda recta y el pecho erguido."], muscleGroups: ["quads", "glutes"] },
                        { phaseName: "Descanso", type: "rest", durationSeconds: 30, exerciseName: "Descanso Breve" },
                        { phaseName: "Flexiones", type: "work", durationSeconds: 180, exerciseName: "Flexiones (en rodillas si es necesario)", sets: "3", reps: "10-12", howTo: ["Manos un poco m√°s anchas que los hombros.", "Baja el pecho cerca del suelo.", "Empuja hacia arriba controladamente."], muscleGroups: ["chest", "triceps", "shoulders"] },
                        { phaseName: "Descanso", type: "rest", durationSeconds: 30, exerciseName: "Descanso Breve" },
                        { phaseName: "Plancha", type: "work", durationSeconds: 120, exerciseName: "Plancha Abdominal", sets: "3", reps: "30-45s", howTo: ["Ap√≥yate en antebrazos y puntas de pies.", "Mant√©n el cuerpo recto como una tabla.", "Contrae el abdomen y los gl√∫teos."], muscleGroups: ["core"] },
                        { phaseName: "Enfriamiento", type: "cooldown", durationSeconds: 120, exerciseName: "Estiramientos Post-entrenamiento", howTo: ["Estira los m√∫sculos principales trabajados.", "Mant√©n cada estiramiento por 20 segundos."], muscleGroups: ["full_body"] }
                    ]
                },
                { 
                    title: "Cardio Quema Grasa", 
                    icon: "fa-person-running", 
                    muscleGroups: ["full_body"], 
                    totalDurationMinutes: 15,
                    phases: [
                        { phaseName: "Calentamiento", type: "prep", durationSeconds: 90, exerciseName: "Trote Ligero y Brazos", howTo: ["Trote suave en el sitio.", "C√≠rculos de brazos hacia adelante y atr√°s."], muscleGroups: ["full_body"] },
                        { phaseName: "Saltos de Tijera", type: "work", durationSeconds: 120, exerciseName: "Saltos de Tijera", sets: "4", reps: "30s", howTo: ["Salta abriendo piernas y brazos.", "Mant√©n un ritmo constante."], muscleGroups: ["full_body"] },
                        { phaseName: "Descanso Activo", type: "rest", durationSeconds: 30, exerciseName: "Caminar en el Sitio" },
                        { phaseName: "Rodillas al Pecho", type: "work", durationSeconds: 120, exerciseName: "Rodillas al Pecho (High Knees)", sets: "4", reps: "30s", howTo: ["Levanta las rodillas lo m√°s alto posible.", "Mueve los brazos en coordinaci√≥n."], muscleGroups: ["legs", "core"] },
                        { phaseName: "Descanso Activo", type: "rest", durationSeconds: 30, exerciseName: "Caminar en el Sitio" },
                        { phaseName: "Burpees", type: "work", durationSeconds: 120, exerciseName: "Burpees (sin flexi√≥n)", sets: "4", reps: "20s", howTo: ["Sentadilla, plancha, de pie, salto.", "Mant√©n el ritmo alto."], muscleGroups: ["full_body"] },
                        { phaseName: "Enfriamiento", type: "cooldown", durationSeconds: 90, exerciseName: "Caminata y Estiramientos", howTo: ["Caminata lenta para bajar pulsaciones.", "Estira piernas y torso."], muscleGroups: ["full_body"] }
                    ]
                },
                { title: "Estiramiento Cuerpo Completo", icon: "fa-person-stretching", muscleGroups: ["full_body"], totalDurationMinutes: 10 },
                { title: "HIIT Extremo 10 Min", icon: "fa-bolt", muscleGroups: ["full_body"], totalDurationMinutes: 10 },
                { title: "Yoga para Despertar", icon: "fa-sun", muscleGroups: ["full_body", "core"], totalDurationMinutes: 15 },
                { title: "Movilidad de Cadera y Espalda", icon: "fa-person-walking", muscleGroups: ["glutes", "back"], totalDurationMinutes: 10 },
                { title: "Core de Acero", icon: "fa-fire", muscleGroups: ["core"], totalDurationMinutes: 12 },
                { title: "T√°bata de Poder", icon: "fa-stopwatch", muscleGroups: ["full_body"], totalDurationMinutes: 4 },
                { title: "Calistenia B√°sica", icon: "fa-bars-progress", muscleGroups: ["back", "biceps", "chest", "triceps"], totalDurationMinutes: 25 },
                { title: "Full Body con Mancuernas", icon: "fa-dumbbell", muscleGroups: ["full_body"], totalDurationMinutes: 30 },
                { title: "Recuperaci√≥n Activa", icon: "fa-heart-pulse", muscleGroups: ["full_body"], totalDurationMinutes: 20 },
                { title: "Fuerza de Piernas", icon: "fa-person-booth", muscleGroups: ["quads", "hamstrings", "glutes"], totalDurationMinutes: 25 },
                { title: "Pecho y Tr√≠ceps", icon: "fa-user-ninja", muscleGroups: ["chest", "triceps", "shoulders"], totalDurationMinutes: 30 },
                { title: "Espalda y B√≠ceps", icon: "fa-user-astronaut", muscleGroups: ["back", "biceps", "forearms"], totalDurationMinutes: 30 },
                { title: "Hombros de Acero", icon: "fa-user-secret", muscleGroups: ["shoulders", "triceps"], totalDurationMinutes: 20 },
                { title: "Meditaci√≥n Guiada", icon: "fa-brain", muscleGroups: [], totalDurationMinutes: 10 },
                { title: "Cardio de Bajo Impacto", icon: "fa-person-biking", muscleGroups: ["legs"], totalDurationMinutes: 30 },
                { title: "Animal Flow Intro", icon: "fa-paw", muscleGroups: ["full_body", "core"], totalDurationMinutes: 15 },
                { title: "Reto de Flexiones", icon: "fa-award", muscleGroups: ["chest", "triceps", "shoulders"], totalDurationMinutes: 10 },
                { title: "Reto de Sentadillas", icon: "fa-trophy", muscleGroups: ["quads", "glutes"], totalDurationMinutes: 10 },
                { title: "Yoga para Dormir", icon: "fa-moon", muscleGroups: ["full_body"], totalDurationMinutes: 15 },
                { title: "Fuerza de Agarre", icon: "fa-hand-rock", muscleGroups: ["forearms"], totalDurationMinutes: 10 },
                { title: "Potencia de Salto", icon: "fa-person-running", muscleGroups: ["legs", "glutes", "calves"], totalDurationMinutes: 15 },
                { title: "Movilidad de Hombro", icon: "fa-person-walking-luggage", muscleGroups: ["shoulders", "back"], totalDurationMinutes: 10 },
                { title: "Anti-Joroba", icon: "fa-user-tie", muscleGroups: ["back", "shoulders"], totalDurationMinutes: 12 },
                { title: "Cardio en Silla", icon: "fa-chair", muscleGroups: ["full_body"], totalDurationMinutes: 20 },
                { title: "Poder Isom√©trico", icon: "fa-compress", muscleGroups: ["full_body"], totalDurationMinutes: 15 },
                { title: "Gl√∫teos con Bandas", icon: "fa-circle-nodes", muscleGroups: ["glutes", "legs"], totalDurationMinutes: 20 },
                { title: "Quema-calor√≠as Express", icon: "fa-fire-flame-curved", muscleGroups: ["full_body"], totalDurationMinutes: 7 },
                { title: "Abdomen Inferior", icon: "fa-angles-down", muscleGroups: ["core"], totalDurationMinutes: 10 },
            ];

            function parseCustomRoutine(name, exerciseText) {
                const duration = parseInt(name.match(/\d+/g)?.[0] || 15);
                const phases = exerciseText.split('\n').map(line => {
                    const parts = line.trim().split(',');
                    const exerciseName = parts[0] ? parts[0].trim() : "Ejercicio";
                    const setsReps = parts[1] ? parts[1].trim() : "3x10";
                    const howTo = parts.slice(2).map(s => s.trim()).filter(Boolean); // Get remaining parts as howTo
                    return {
                        phaseName: "Work", 
                        type: "work", 
                        durationSeconds: 180, // Default duration, user can adjust in their mind
                        exerciseName: exerciseName, 
                        sets: setsReps.split('x')[0],
                        reps: setsReps.split('x')[1],
                        howTo: howTo.length > 0 ? howTo : ["Sigue las indicaciones."], 
                        muscleGroups: ["full_body"] // Default, IA would infer better
                    };
                }).filter(p => p.exerciseName);
                return { title: name, totalDurationMinutes: duration, phases: phases, icon: "fa-user-pen", isCustom: true };
            }

            function saveCustomRoutine() {
                const name = dom.offline.newRoutineName.value.trim();
                const exercises = dom.offline.newRoutineExercises.value.trim();

                if (!name || !exercises) {
                    showToast("Por favor, completa el nombre y los ejercicios.", 'error');
                    return;
                }
                const newRoutine = parseCustomRoutine(name, exercises);
                state.userData.customRoutines.push(newRoutine);
                saveAllData();
                showToast(`Rutina "${name}" guardada con √©xito.`, 'success');
                dom.offline.newRoutineName.value = '';
                dom.offline.newRoutineExercises.value = '';
                renderOfflineRoutines();
            }

            function renderOfflineRoutines() {
                const allRoutines = [...offlineWorkouts, ...state.userData.customRoutines];
                dom.offline.routinesList.innerHTML = '';
                allRoutines.forEach(routine => {
                    const el = document.createElement('button');
                    el.className = 'offline-routine-btn btn btn-secondary p-4 rounded-lg flex items-center justify-between w-full text-left';
                    el.dataset.title = routine.title;
                    el.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas ${routine.icon} text-primary text-xl mr-4 w-6 text-center"></i>
                            <span class="font-bold">${routine.title}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-sm text-text-secondary mr-4">${routine.totalDurationMinutes} min</span>
                            <i class="fas fa-play"></i>
                        </div>
                    `;
                    el.addEventListener('click', () => {
                        // Use the detailed phases if available, otherwise create a single phase
                        state.aiWorkout.routine = routine.phases ? routine : { 
                            ...routine, 
                            phases: [{ 
                                type: "work", 
                                durationSeconds: routine.totalDurationMinutes * 60, 
                                exerciseName: routine.title, 
                                howTo: ["Sigue las indicaciones de la pantalla."], 
                                muscleGroups: routine.muscleGroups || ["full_body"] 
                            }] 
                        };
                        startAiWorkout();
                    });
                    dom.offline.routinesList.appendChild(el);
                });
            }
            
            // --- Timer Tool Logic ---
            function openTimerTool(type) {
                state.timerTool.type = type;
                resetTimerTool();
                showScreen('timer-tool-screen');
                dom.timerTool.title.textContent = translations.es[`tool_${type}`];
                
                // Hide all config and controls initially
                Object.values(dom.timerTool.configContainer.children).forEach(c => c.classList.add('hidden'));
                dom.timerTool.controls.classList.add('hidden');
                dom.timerTool.roundsCounterControl.classList.add('hidden');
                dom.timerTool.lapBtn.classList.add('hidden'); 
                dom.timerTool.lapTimesContainer.classList.add('hidden');

                // Show basic controls for stopwatch, timer, tabata
                if (['stopwatch', 'timer', 'tabata'].includes(type)) {
                    dom.timerTool.controls.classList.remove('hidden');
                    dom.timerTool.displayArea.classList.remove('hidden');
                }
                
                // Show specific configs
                if (type === 'timer') dom.timerTool.configTimer.classList.remove('hidden');
                if (type === 'tabata') dom.timerTool.configTabata.classList.remove('hidden');
                if (type === 'rounds') {
                    dom.timerTool.configRounds.classList.remove('hidden');
                    dom.timerTool.roundsCounterControl.classList.remove('hidden');
                    dom.timerTool.controls.classList.add('hidden'); // Hide start/pause for rounds
                }
                if (type === 'stopwatch') { 
                    dom.timerTool.lapBtn.classList.remove('hidden');
                    dom.timerTool.lapTimesContainer.classList.remove('hidden');
                }
            }

            function formatTime(ms, includeMs = true) {
                const totalSeconds = Math.floor(ms / 1000);
                const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                const seconds = (totalSeconds % 60).toString().padStart(2, '0');
                if (!includeMs) return `${minutes}:${seconds}`;
                const milliseconds = Math.floor((ms % 1000) / 10).toString().padStart(2, '0');
                return `${minutes}:${seconds}.${milliseconds}`;
            }

            function timerToolLoop() {
                if (!state.timerTool.isRunning) return;
                const now = Date.now();
                
                if (state.timerTool.type === 'stopwatch') {
                    const elapsedTime = state.timerTool.elapsedTime + (now - state.timerTool.startTime);
                    dom.timerTool.display.textContent = formatTime(elapsedTime);
                } else if (state.timerTool.type === 'timer') {
                    const timeLeft = state.timerTool.duration - (state.timerTool.elapsedTime + (now - state.timerTool.startTime));
                    if (timeLeft <= 0) {
                        dom.timerTool.display.textContent = "00:00";
                        resetTimerTool();
                        playBeep(880, 500);
                        showToast("¬°Tiempo finalizado!", 'success');
                        return;
                    }
                    dom.timerTool.display.textContent = formatTime(timeLeft, false);
                } else if (state.timerTool.type === 'tabata') {
                    const tabata = state.timerTool.tabata;
                    const phaseElapsedTime = now - state.timerTool.startTime;
                    const phaseTimeLeft = tabata.timeLeft - phaseElapsedTime;
                    
                    if (phaseTimeLeft <= 0) {
                        if (tabata.isWorkPhase) { // Work -> Rest
                            tabata.isWorkPhase = false;
                            tabata.timeLeft = tabata.rest * 1000;
                            playBeep(440, 200, 'square');
                        } else { // Rest -> Work (or end)
                            tabata.currentRound++;
                            if (tabata.currentRound > tabata.rounds) {
                                resetTimerTool();
                                showToast("¬°T√°bata completado!", 'success');
                                playBeep(1046, 500, 'triangle');
                                return;
                            }
                            tabata.isWorkPhase = true;
                            tabata.timeLeft = tabata.work * 1000;
                            playBeep(660, 200, 'square');
                        }
                        state.timerTool.startTime = now;
                    }

                    dom.timerTool.phase.textContent = tabata.isWorkPhase ? `TRABAJO` : `DESCANSO`;
                    dom.timerTool.phase.style.color = tabata.isWorkPhase ? 'var(--success)' : 'var(--warning)';
                    dom.timerTool.roundsDisplay.textContent = `Ronda ${tabata.currentRound} / ${tabata.rounds}`;
                    dom.timerTool.display.textContent = formatTime(phaseTimeLeft, false);
                }
                
                state.timerTool.interval = requestAnimationFrame(timerToolLoop);
            }

            function startTimerTool() {
                if (state.timerTool.isRunning) return;

                if (state.timerTool.type === 'timer') {
                    const minutes = parseInt(document.getElementById('timer-minutes').value) || 0;
                    const seconds = parseInt(document.getElementById('timer-seconds').value) || 0;
                    const newDuration = (minutes * 60 + seconds) * 1000;
                    if (newDuration <= 0 && state.timerTool.duration <= 0) {
                        showToast("Por favor, establece una duraci√≥n.", 'error');
                        return;
                    }
                    if (newDuration > 0) state.timerTool.duration = newDuration;
                } else if (state.timerTool.type === 'tabata') {
                    if (!state.timerTool.tabata.currentRound) { // If starting new
                        state.timerTool.tabata.work = parseInt(document.getElementById('tabata-work').value) || 20;
                        state.timerTool.tabata.rest = parseInt(document.getElementById('tabata-rest').value) || 10;
                        state.timerTool.tabata.rounds = parseInt(document.getElementById('tabata-rounds').value) || 8;
                        state.timerTool.tabata.currentRound = 1;
                        state.timerTool.tabata.isWorkPhase = true;
                        state.timerTool.tabata.timeLeft = state.timerTool.tabata.work * 1000;
                        playBeep(660, 200, 'square');
                    }
                }

                state.timerTool.isRunning = true;
                state.timerTool.startTime = Date.now();
                dom.timerTool.startBtn.classList.add('hidden');
                dom.timerTool.pauseBtn.classList.remove('hidden');
                dom.timerTool.configContainer.classList.add('hidden');
                timerToolLoop();
            }

            function pauseTimerTool() {
                if (!state.timerTool.isRunning) return;
                state.timerTool.isRunning = false;
                cancelAnimationFrame(state.timerTool.interval);
                
                const elapsedTime = Date.now() - state.timerTool.startTime;
                if (['stopwatch', 'timer'].includes(state.timerTool.type)) {
                    state.timerTool.elapsedTime += elapsedTime;
                } else if (state.timerTool.type === 'tabata') {
                    state.timerTool.tabata.timeLeft -= elapsedTime;
                }

                dom.timerTool.startBtn.classList.remove('hidden');
                dom.timerTool.pauseBtn.classList.add('hidden');
            }

            function resetTimerTool() {
                state.timerTool.isRunning = false;
                if (state.timerTool.interval) cancelAnimationFrame(state.timerTool.interval);
                if (state.timerTool.rounds.restTimerInterval) clearInterval(state.timerTool.rounds.restTimerInterval); // Clear rounds rest timer
                state.timerTool.elapsedTime = 0;
                state.timerTool.duration = 0;
                state.timerTool.tabata = { work: 20, rest: 10, rounds: 8, currentRound: 0, isWorkPhase: true, timeLeft: 0 };
                state.timerTool.rounds = { count: 0, target: 0, rest: 0, current: 1, restTimerInterval: null };
                state.timerTool.lapTimes = []; // Reset lap times
                dom.timerTool.lapTimesList.innerHTML = ''; // Clear lap times display

                dom.timerTool.configContainer.classList.remove('hidden');
                dom.timerTool.startBtn.classList.remove('hidden');
                dom.timerTool.pauseBtn.classList.add('hidden');
                
                dom.timerTool.phase.textContent = '';
                dom.timerTool.roundsDisplay.textContent = '';
                
                if (state.timerTool.type === 'stopwatch') {
                    dom.timerTool.display.textContent = "00:00.00";
                } else if (['timer', 'tabata'].includes(state.timerTool.type)) {
                    dom.timerTool.display.textContent = "00:00";
                } 
                
                if (state.timerTool.type === 'rounds') {
                    dom.timerTool.roundCounterBtn.textContent = '0';
                    dom.timerTool.roundsDisplay.textContent = `Ronda 1`;
                }
            }

            function recordLap() {
                if (state.timerTool.type !== 'stopwatch' || !state.timerTool.isRunning) return;
                const currentLapTime = state.timerTool.elapsedTime + (Date.now() - state.timerTool.startTime);
                state.timerTool.lapTimes.push(currentLapTime);
                
                const li = document.createElement('li');
                li.textContent = `Vuelta ${state.timerTool.lapTimes.length}: ${formatTime(currentLapTime)}`;
                dom.timerTool.lapTimesList.appendChild(li);
                dom.timerTool.lapTimesList.scrollTop = dom.timerTool.lapTimesList.scrollHeight; // Scroll to bottom
            }

            // --- Daily Missions ---
            function setupDailyMissions() {
                const today = new Date().toISOString().split('T')[0];
                const lastMissionDate = localStorage.getItem('goatiFitLastMissionDate');

                if (today !== lastMissionDate) {
                    // Reset missions for a new day
                    state.dailyMissions = [
                        { id: 'workout', desc: translations.es.daily_mission_workout, completed: false, points: 20 },
                        { id: 'water', desc: translations.es.daily_mission_water, completed: false, points: 10 },
                        { id: 'sleep', desc: translations.es.daily_mission_sleep, completed: false, points: 15 },
                        { id: 'reflection', desc: translations.es.daily_mission_reflection, completed: false, points: 5 },
                        { id: 'breathing', desc: translations.es.daily_mission_breathing, completed: false, points: 5 },
                    ];
                    state.missionsCompletedToday = 0;
                    localStorage.setItem('goatiFitLastMissionDate', today);
                    saveAllData(); // Save new missions
                } else {
                    // Load existing missions
                    const savedMissions = JSON.parse(localStorage.getItem('goatiFitDailyMissions'));
                    if (savedMissions) {
                        state.dailyMissions = savedMissions;
                        state.missionsCompletedToday = state.dailyMissions.filter(m => m.completed).length;
                    }
                }
                updateDailyMissionsDisplay();
            }

            function updateDailyMissionsDisplay() {
                dom.dashboard.missionsCompleted.textContent = state.missionsCompletedToday;
                dom.dashboard.missionsTotal.textContent = state.dailyMissions.length;
                // You could also display the missions themselves in a modal or on the dashboard
            }

            function checkDailyMissions(missionId) {
                const mission = state.dailyMissions.find(m => m.id === missionId);
                if (mission && !mission.completed) {
                    mission.completed = true;
                    state.missionsCompletedToday++;
                    state.progress.points += mission.points;
                    showToast(`¬°Misi√≥n completada: ${mission.desc}! +${mission.points} Pts`, 'success');
                    updatePointsDisplay();
                    updateDailyMissionsDisplay();
                    saveAllData(); // Save updated missions
                }
            }


            // --- Local Storage ---
            function saveAllData() {
                const appData = {
                    progress: state.progress,
                    userData: state.userData,
                    alarms: state.alarms,
                    notifications: state.notifications,
                    theme: state.theme,
                    language: state.language,
                    dailyMissions: state.dailyMissions, // Save daily missions
                    missionsCompletedToday: state.missionsCompletedToday, // Save completed count
                };
                localStorage.setItem('goatiFitDataV8', JSON.stringify(appData));
            }

            function loadAllData() {
                const savedData = localStorage.getItem('goatiFitDataV8');
                if (savedData) {
                    const appData = JSON.parse(savedData);
                    state.progress = { ...state.progress, ...appData.progress };
                    state.userData = { ...state.userData, ...appData.userData };
                    state.alarms = appData.alarms || [];
                    state.notifications = { ...state.notifications, ...appData.notifications };
                    state.theme = appData.theme || 'dark';
                    state.language = appData.language || 'es';
                    state.dailyMissions = appData.dailyMissions || [];
                    state.missionsCompletedToday = appData.missionsCompletedToday || 0;
                }
                // Pre-configure default alarms if none exist
                if (state.alarms.length === 0) {
                    state.alarms = [
                        { name: "Tomar Agua", time: "09:00", days: [false, true, true, true, true, true, false], enabled: true },
                        { name: "Levantarse", time: "07:00", days: [false, true, true, true, true, true, false], enabled: true },
                        { name: "Estirar", time: "12:00", days: [false, true, true, true, true, true, false], enabled: true },
                        { name: "Entrenar", time: "18:00", days: [false, true, true, true, true, true, false], enabled: true },
                        { name: "Dormir", time: "22:00", days: [true, true, true, true, true, true, true], enabled: true },
                    ];
                }
            }

            // --- Daily Oracle ---
            function showDailyOracle() {
                const today = new Date().toISOString().split('T')[0];
                const lastOracleDate = localStorage.getItem('goatiFitOracleDate');

                if (today !== lastOracleDate) {
                    const messages = ["La fuerza no viene de la capacidad corporal, sino de la voluntad del alma.", "Convierte el 'no puedo' en 'puedo' y los sue√±os en planes.", "Tu √∫nico l√≠mite eres t√∫ mismo."];
                    state.oracleMessage = messages[Math.floor(Math.random() * messages.length)];
                    localStorage.setItem('goatiFitOracleMessage', state.oracleMessage);
                    localStorage.setItem('goatiFitOracleDate', today);
                    showModal('oracle', state.oracleMessage);
                }
            }
            
            function renderMoodIcons() {
                const icons = [
                    `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M16 16s-1.5-2-4-2-4 2-4 2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>`,
                    `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M16 16s-1.5-2-4-2-4 2-4 2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>`,
                    `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="15" x2="16" y2="15"></line><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>`,
                    `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>`,
                    `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><path d="M9 9h.01"></path><path d="M15 9h.01"></path></svg>`
                ];
                const container = dom.data.energyTracker;
                container.innerHTML = '';
                icons.forEach((icon, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'mood-btn btn';
                    btn.dataset.value = index + 1;
                    btn.innerHTML = icon;
                    container.appendChild(btn);
                });
            }

            function renderReflectionQuestions() {
                const questions = [
                    "¬øEntrenaste hoy?",
                    "¬øC√≥mo estuvo tu alimentaci√≥n?",
                    "¬øC√≥mo calificas tu descanso?",
                    "¬øC√≥mo te sentiste emocionalmente?",
                    "¬øTuviste excesivo uso de pantallas?",
                    "¬øSientes estr√©s o ansiedad?"
                ];
                const container = dom.modals.reflectionQuestions;
                container.innerHTML = '';
                questions.forEach((q, i) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-secondary p-3 rounded-lg';
                    div.innerHTML = `
                        <span class="flex-1 text-left">${q}</span>
                        <div class="flex gap-2">
                            <button class="reflection-btn btn btn-secondary px-4 py-1" data-question="${i}" data-answer="yes">S√≠</button>
                            <button class="reflection-btn btn btn-secondary px-4 py-1" data-question="${i}" data-answer="no">No</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            function toggleTheme() {
                state.theme = state.theme === 'dark' ? 'light' : 'dark';
                document.body.classList.toggle('light-theme', state.theme === 'light');
                document.body.classList.toggle('dark-theme', state.theme === 'dark');
                saveAllData();
            }

            // --- EVENT LISTENERS ---
            document.body.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;

                const id = btn.id;
                const classList = btn.classList;
                
                if (id === 'generate-btn') {
                    let prompt = dom.dashboard.userPrompt.value;
                    const activeModifier = document.querySelector('.ai-modifier-btn.active');
                    if (activeModifier) prompt += ` (${activeModifier.dataset.modifier})`;
                    if(prompt) fetchAndStartWorkout(prompt, 'Custom', btn);
                } 
                else if (id === 'open-lab-btn') showScreen('lab-screen');
                else if (classList.contains('nav-btn')) showScreen(btn.dataset.screen);
                else if (id === 'close-modal-btn' || id === 'close-coach-modal-btn' || id === 'close-oracle-modal-btn' || id === 'close-reward-claimed-modal-btn') hideModal();
                else if (id === 'save-data-btn') saveAndAnalyzeData();
                else if (id === 'analyze-data-btn') analyzeUserDataWithAI();
                else if (id === 'add-alarm-btn') showModal('alarm', { index: null, alarm: null });
                else if (id === 'save-alarm-btn') saveAlarm();
                else if (classList.contains('day-btn')) btn.classList.toggle('active');
                else if (id === 'toggle-sleep-sound-btn') toggleSleepSound();
                else if (id === 'start-calm-breathing-btn') toggleBreathingExercise(false, 'calm');
                else if (id === 'start-power-breathing-btn') toggleBreathingExercise(false, 'power');
                else if (id === 'start-relax-breathing-btn') toggleBreathingExercise(false, 'relax');
                else if (classList.contains('back-to-dashboard-btn')) showScreen('dashboard-screen');
                else if (classList.contains('back-to-lab-btn')) showScreen('lab-screen');
                else if (classList.contains('back-to-wellness-btn')) showScreen('wellness-screen');
                else if (classList.contains('timer-type-btn')) openTimerTool(btn.dataset.type);
                else if (id === 'timer-tool-start') startTimerTool();
                else if (id === 'timer-tool-pause') pauseTimerTool();
                else if (id === 'timer-tool-reset') resetTimerTool();
                else if (id === 'timer-tool-lap') recordLap(); // New Lap button listener
                else if (id === 'round-counter-btn') {
                    state.timerTool.rounds.count++;
                    btn.textContent = state.timerTool.rounds.count;
                }
                else if (id === 'round-next-btn') {
                    const rounds = state.timerTool.rounds;
                    if (!rounds.target) rounds.target = parseInt(document.getElementById('rounds-target').value) || 0;
                    if (!rounds.rest) rounds.rest = parseInt(document.getElementById('rounds-rest').value) || 0;
                    
                    if (rounds.target > 0 && rounds.current >= rounds.target) {
                        showToast("¬°Objetivo de rondas completado!", 'success');
                        resetTimerTool(); // Reset the timer tool completely
                        return;
                    }
                    
                    rounds.current++;
                    rounds.count = 0;
                    dom.timerTool.roundCounterBtn.textContent = '0';
                    dom.timerTool.roundsDisplay.textContent = `Ronda ${rounds.current}${rounds.target > 0 ? ` / ${rounds.target}` : ''}`;
                    
                    if (rounds.rest > 0) {
                        dom.timerTool.phase.textContent = 'DESCANSO';
                        let restTimeLeft = rounds.rest;
                        dom.timerTool.display.textContent = formatTime(restTimeLeft * 1000, false);
                        playBeep(440, 200); // Beep for rest start
                        
                        // Clear any existing rest timer interval
                        if (rounds.restTimerInterval) clearInterval(rounds.restTimerInterval);

                        rounds.restTimerInterval = setInterval(() => {
                            restTimeLeft--;
                            dom.timerTool.display.textContent = formatTime(restTimeLeft * 1000, false);
                            if (restTimeLeft <= 0) {
                                clearInterval(rounds.restTimerInterval);
                                rounds.restTimerInterval = null;
                                playBeep(660, 500); // Beep for rest end
                                dom.timerTool.phase.textContent = `RONDA`; // Back to round phase
                                dom.timerTool.display.textContent = `00:00`; // Reset display
                            } else if (restTimeLeft <= 3 && restTimeLeft > 0) {
                                playBeep(523, 150, 'square'); // Countdown beeps
                            }
                        }, 1000);
                    } else {
                        dom.timerTool.phase.textContent = `RONDA`;
                        dom.timerTool.display.textContent = `00:00`;
                    }
                }
                else if (classList.contains('challenge-btn')) {
                    const challenge = btn.dataset.challenge;
                    const prompt = translations.es[`challenge_${challenge}_prompt`];
                    fetchAndStartWorkout(prompt, btn.querySelector('h3').textContent.replace(/<[^>]*>/g, '').trim(), btn); // Pass the actual button to reset
                } 
                else if (id === 'exit-workout-btn') {
                    clearInterval(state.aiWorkout.timerInterval);
                    showScreen('dashboard-screen');
                } 
                else if (id === 'exit-visualizer-btn') {
                    stopVisualizer();
                    showScreen('dashboard-screen');
                } 
                else if (id === 'play-pause-btn') toggleAiPause();
                else if (id === 'next-btn') nextAiPhase();
                else if (id === 'prev-btn') prevAiPhase();
                else if (id === 'beast-mode-btn') handleBeastModeClick();
                else if (id === 'confirm-beast-mode-btn') activateBeastMode();
                else if (id === 'cancel-beast-mode-btn') hideModal();
                else if (id === 'save-custom-routine-btn') saveCustomRoutine();
                else if (id === 'analyze-history-btn') analyzeHistoryWithAI();
                else if (classList.contains('info-btn')) {
                    const type = btn.dataset.info;
                    showModal('info', { title: translations.es[`info_${type}_title`], body: `<p>${translations.es[`info_${type}_desc`]}</p>` });
                } 
                else if (classList.contains('sleep-sound-btn')) {
                    dom.sleep.soundBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.sleep.selectedSound = btn.dataset.sound;
                } 
                else if (classList.contains('mood-btn')) {
                    dom.data.energyTracker.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.userData.energy = parseInt(btn.dataset.value);
                } 
                else if (classList.contains('ai-modifier-btn')) {
                    // Ensure only one AI modifier button is active at a time
                    document.querySelectorAll('.ai-modifier-btn').forEach(b => {
                        if (b !== btn) b.classList.remove('active');
                    });
                    btn.classList.toggle('active');
                }
                else if (classList.contains('wellness-btn')) {
                    const action = btn.dataset.action;
                    switch(action) {
                        case 'breathing': showScreen('breathing-screen'); break;
                        case 'mobility': showModal('mobility'); break;
                        case 'reflection': showModal('reflection'); break;
                        case 'stress': showModal('antiStress'); break; // Changed to open new anti-stress modal
                        case 'ice': showModal('iceBath'); break;
                        case 'intimate': showModal('intimateWellness'); break;
                        case 'supplements': showModal('supplements'); break;
                        case 'sleep': showScreen('sleep-screen'); break;
                    }
                }
                else if (classList.contains('reflection-btn')) {
                    const question = btn.dataset.question;
                    const answer = btn.dataset.answer;
                    const parent = btn.parentElement;
                    parent.querySelectorAll('.reflection-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    // Log reflection activity
                    logActivityToHistory({ type: 'reflection', title: `Reflexi√≥n: Pregunta ${parseInt(question) + 1}`, duration: 1 });
                    checkDailyMissions('reflection');
                }
                 else if (classList.contains('intimate-btn')) {
                    const parent = btn.parentElement;
                    parent.querySelectorAll('.intimate-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                }
                else if (id === 'get-supplement-rec-btn') {
                    hideModal();
                    setTimeout(() => showModal('info', {title: 'Recomendaci√≥n de Suplementos', body: 'Basado en tu objetivo, te recomendamos: Prote√≠na Whey para recuperaci√≥n, Creatina para fuerza y un Multivitam√≠nico para soporte general. Consulta a un profesional.'}), 500);
                }
                else if (id === 'analyze-reflection-btn') {
                    hideModal();
                    setTimeout(() => showModal('info', {title: 'An√°lisis de tu D√≠a', body: 'Parece que hoy fue un d√≠a productivo en entrenamiento pero bajo en descanso. Considera una rutina de relajaci√≥n antes de dormir para mejorar la recuperaci√≥n.'}), 500);
                }
                 else if (id === 'analyze-intimate-btn') {
                    hideModal();
                    setTimeout(() => analyzeUserDataWithAI(), 500); // Call the main analyze function
                }
                 else if (id === 'start-ice-bath-timer-btn') {
                    if(state.wellness.iceBathInterval) return;
                    let timeLeft = 30;
                    dom.modals.iceBathTimer.textContent = `00:${String(timeLeft).padStart(2, '0')}`;
                    state.wellness.iceBathInterval = setInterval(() => {
                        timeLeft--;
                        dom.modals.iceBathTimer.textContent = `00:${String(timeLeft).padStart(2, '0')}`;
                        if (timeLeft <= 0) {
                            clearInterval(state.wellness.iceBathInterval);
                            state.wellness.iceBathInterval = null;
                            playBeep(880, 500);
                            hideModal();
                            logActivityToHistory({ type: 'ice', title: "Terapia de Hielo", duration: 1 });
                            showToast("Terapia de hielo registrada.", 'success');
                        }
                    }, 1000);
                }
                 else if (classList.contains('mobility-btn')) {
                    const moment = btn.dataset.moment;
                    const prompt = translations.es[`mobility_prompt_${moment}`];
                    hideModal();
                    fetchAndStartWorkout(prompt, `Movilidad de ${moment}`, btn);
                }
                else if (classList.contains('claim-reward-btn')) {
                    claimReward(btn.dataset.rewardId);
                }
                else if (id === 'toggle-stress-sound-btn') {
                    if (state.wellness.isStressSoundPlaying) {
                        stopStressSound();
                    } else {
                        startStressSound();
                    }
                }
            });
            
            dom.modals.overlay.addEventListener('click', (e) => {
                if (e.target === dom.modals.overlay) hideModal();
            });
            
            dom.settings.notificationsList.addEventListener('change', (e) => {
                if (e.target.classList.contains('notification-toggle')) {
                    state.notifications[e.target.dataset.type].enabled = e.target.checked;
                    saveAllData();
                    showToast('Ajustes de notificaci√≥n guardados.', 'success');
                }
            });

            dom.settings.alarmsList.addEventListener('change', (e) => {
                if (e.target.classList.contains('alarm-toggle')) {
                    const index = e.target.dataset.index;
                    state.alarms[index].enabled = e.target.checked;
                    saveAllData();
                }
            });

            dom.sleep.timerSlider.addEventListener('input', (e) => {
                dom.sleep.timerValue.textContent = e.target.value > 0 ? `${e.target.value} min` : 'Off';
            });
            
            // Event listener for menstrual cycle date input, now in modal
            dom.modals.lastPeriodDate.addEventListener('change', updateMenstrualCycleDisplay);

            // Theme toggle event listener
            dom.settings.themeToggle.addEventListener('change', toggleTheme);

            // Language select event listener
            dom.settings.languageSelect.addEventListener('change', (e) => {
                setLanguage(e.target.value);
                saveAllData(); // Save language preference
            });

            // Points display click listener
            dom.dashboard.pointsDisplay.addEventListener('click', () => {
                showScreen('progress-screen');
            });

            // Calculate BMI on height/weight change
            dom.data.inputWeight.addEventListener('input', () => {
                const weight = parseFloat(dom.data.inputWeight.value);
                const height = parseFloat(dom.data.inputHeight.value);
                dom.data.inputBMI.value = calculateBMI(weight, height) || '';
            });
            dom.data.inputHeight.addEventListener('input', () => {
                const weight = parseFloat(dom.data.inputWeight.value);
                const height = parseFloat(dom.data.inputHeight.value);
                dom.data.inputBMI.value = calculateBMI(weight, height) || '';
            });

            // --- Initial Setup ---
            function init() {
                loadAllData();
                renderMoodIcons();
                setLanguage(state.language); // Set language from loaded state
                document.body.classList.add(state.theme + '-theme'); // Apply loaded theme
                dom.settings.themeToggle.checked = state.theme === 'dark'; // Sync toggle
                updatePointsDisplay();
                setupDailyMissions(); // Setup daily missions
                showScreen('dashboard-screen'); // Set initial screen
                setTimeout(showDailyOracle, 1500); // Show oracle after a small delay
                setupAlarmChecks(); // Start checking alarms
            }

            init();
        });
    </script>
</body>

</html>
