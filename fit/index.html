<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>goatiFIT - Tu Workflow Fit con goatify IA</title>
    <meta name="description" content="goatiFIT es tu entrenador personal de √©lite, parte del ecosistema goatify.app. Usa el workflow fit de goatify IA para generar rutinas personalizadas y alcanzar tus metas de bienestar.">
    <meta name="keywords" content="goatify, goatify.app, goatify IA, workflow fit, fitness, AI trainer, entrenador IA, gym, wellness">
    <meta name="author" content="goatify.app">
    <link rel="canonical" href="https://goatify.app/">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-glow: rgba(138, 79, 255, 0.7);
            --primary: #8a4fff;
            --primary-hover: #9d6bff;
            --secondary: #1a1a1a;
            --light: #282828;
            --dark: #101010;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --success: #22c55e;
            --warning: #facc15;
            --danger: #ef4444;
            --info: #3b82f6;
            --ice-blue: #7DF9FF;
            --ice-glow: rgba(125, 249, 255, 0.7);
            --bg-gradient-start: var(--dark);
            --bg-gradient-end: #1a0f2e;
        }

        body.light-theme {
            --primary-glow: rgba(100, 120, 255, 0.4);
            --primary: #6478ff;
            --primary-hover: #7c8dff;
            --secondary: #f0f2f5;
            --light: #ffffff;
            --dark: #e9eef2;
            --text-primary: #1a1a1a;
            --text-secondary: #555555;
            --success: #16a34a;
            --warning: #f59e0b;
            --danger: #dc2626;
            --info: #2563eb;
            --ice-blue: #00BFFF;
            --ice-glow: rgba(0, 191, 255, 0.4);
            --bg-gradient-start: #fdfdff;
            --bg-gradient-end: #eef2f7;
        }

        @keyframes background-pan { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes pulse-neon { 0%, 100% { box-shadow: 0 0 5px 1px var(--danger), 0 0 10px 2px var(--danger); } 50% { box-shadow: 0 0 10px 2px var(--danger), 0 0 20px 5px var(--danger); } }
        .goat-mode-active { animation: pulse-neon 1.5s infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes emotional-visual-flow { 0% { transform: translate(0, 0) scale(1); opacity: 0.1; } 25% { transform: translate(10px, 20px) scale(1.1); } 50% { transform: translate(-10px, -15px) scale(0.9); opacity: 0.5; } 75% { transform: translate(5px, -5px) scale(1.05); } 100% { transform: translate(0, 0) scale(1); opacity: 0.1; } }

        html { scroll-behavior: smooth; }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--dark); background-image: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 50%, var(--bg-gradient-start) 100%); background-size: 200% 200%; animation: background-pan 15s ease infinite; color: var(--text-primary); overscroll-behavior: none; -webkit-tap-highlight-color: transparent; }
        #app-container { height: 100vh; height: 100dvh; width: 100%; display: flex; flex-direction: column; }
        .screen { flex-grow: 1; transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out; will-change: transform, opacity; display: flex; flex-direction: column; width: 100%; padding: 1rem 1rem 8rem 1rem; overflow-y: auto; }
        .screen.fullscreen { padding: 0; justify-content: center; }
        .screen.hidden { display: none; }

        .btn { transition: all 0.2s ease-in-out; position: relative; overflow: hidden; -webkit-tap-highlight-color: transparent; display: flex; align-items: center; justify-content: center; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:active:not(:disabled) { transform: scale(0.95); }
        .btn-primary { background: linear-gradient(45deg, var(--primary), var(--primary-hover)); color: white; box-shadow: 0 4px 20px var(--primary-glow); }
        .btn-secondary { background-color: var(--light); color: var(--text-primary); border: 1px solid rgba(128,128,128,0.2); }
        .btn-secondary.active, .btn-secondary:hover { background-color: var(--primary); border-color: var(--primary-hover); color: white; box-shadow: 0 0 15px var(--primary-glow); }
        .btn-ice { background: linear-gradient(45deg, var(--ice-blue), #A0FFFF); color: var(--dark); box-shadow: 0 4px 20px var(--ice-glow); }

        .glassmorphism { border: 1px solid rgba(138, 79, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(138, 79, 255, 0.05); }
        body.dark-theme .glassmorphism { background: rgba(26, 26, 26, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        body.light-theme .glassmorphism { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }

        textarea, input, select { background-color: var(--secondary); color: var(--text-primary); border: 1px solid rgba(128,128,128,0.2); border-radius: 0.5rem; padding: 0.75rem; }
        textarea::placeholder, input::placeholder { color: var(--text-secondary); }
        select option { background-color: var(--dark); color: var(--text-primary); }

        .timer-circle-progress { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s linear; }
        .phase-border-work { border-color: var(--success); } .phase-color-work { color: var(--success); }
        .phase-border-rest { border-color: var(--warning); } .phase-color-rest { color: var(--warning); }
        .phase-border-prep { border-color: var(--primary); } .phase-color-prep { color: var(--primary); }
        .phase-border-stress { border-color: var(--ice-blue); } .phase-color-stress { color: var(--ice-blue); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--secondary); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--primary); border-radius: 4px; }
        
        input[type=number] { -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--light); transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        .mood-btn.active { transform: scale(1.2); box-shadow: 0 0 15px var(--primary-glow); border-color: var(--primary); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; padding: 0.5rem 1rem; }
        .bottom-nav-item.active { color: var(--primary); transform: translateY(-5px); }

        /* Fullscreen modal for timers */
        .modal-fullscreen #modal-content-wrapper {
            width: 100%;
            height: 100%;
            max-width: 100vw;
            max-height: 100vh;
            border-radius: 0;
            background: var(--dark);
        }
        .modal-fullscreen #modal-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        .gigantic-timer {
            font-family: 'Roboto Mono', monospace;
            font-size: clamp(2rem, 20vw, 10rem);
            font-weight: 700;
            letter-spacing: -0.05em;
        }
        .gigantic-timer .milliseconds {
            font-size: 0.5em;
            color: var(--text-secondary);
        }
        .body-map-part {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .body-map-part:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }
        #body-map-tooltip {
            position: absolute;
            display: none;
            background-color: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            pointer-events: none;
            z-index: 10;
        }
    </style>
</head>

<body class="dark-theme">

    <div id="app-container">
        <!-- ======================= DASHBOARD SCREEN ========================== -->
        <div id="dashboard-screen" class="screen items-center">
             <header class="w-full text-center mb-8 pt-8">
                <div class="flex justify-between items-center w-full max-w-4xl mx-auto">
                    <button id="theme-toggle-btn" class="btn btn-secondary rounded-full w-12 h-12 text-xl"><i class="fas fa-sun"></i></button>
                    <div class="flex-grow text-center">
                        <h1 class="text-5xl font-black" data-translate-key="main_title">goati<span class="text-primary">FIT</span></h1>
                        <p class="text-lg text-text-secondary mt-1" data-translate-key="subtitle">Tu Entrenador de √âlite con IA</p>
                    </div>
                    <select id="language-select" class="bg-transparent text-text-secondary font-bold border-none focus:outline-none appearance-none">
                         <option value="es" class="bg-dark text-text-primary">ES</option>
                         <option value="en" class="bg-dark text-text-primary">EN</option>
                    </select>
                </div>
                <div id="points-display" class="mt-4 glassmorphism inline-block px-4 py-2 rounded-full">
                    <span class="font-bold text-primary"><i class="fas fa-star"></i> <span id="points-value">0</span> PTS</span>
                </div>
             </header>

             <main class="w-full max-w-2xl space-y-6 flex-grow">
                <div class="glassmorphism p-6 rounded-2xl fade-in">
                    <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-fire text-primary mr-3"></i><span data-translate-key="mission_title">Tu Misi√≥n de Hoy</span></h2>
                    <div id="workout-of-the-day" class="text-center p-6 bg-secondary rounded-lg">
                        <p class="text-text-secondary" data-translate-key="mission_placeholder">Pide una rutina a la IA para empezar.</p>
                    </div>
                </div>
                
                <div class="glassmorphism p-6 rounded-2xl fade-in" style="animation-delay: 0.2s;">
                    <h2 class="text-2xl font-bold mb-4"><i class="fas fa-comments text-primary mr-3"></i><span data-translate-key="ia_prompt_title">Pide tu Rutina a la IA</span></h2>
                     <textarea id="user-prompt" class="w-full h-24 p-4 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none resize-none" data-translate-key="ia_prompt_placeholder" placeholder="Ej: 'Quiero una rutina de 45 mins en el gimnasio para espalda y b√≠ceps'"></textarea>
                     <div class="flex gap-2 mt-2">
                         <button class="ai-modifier-btn btn btn-secondary flex-1 text-sm" data-modifier="sin equipo"><i class="fas fa-ban mr-1"></i> <span data-translate-key="ai_modifier_no_equipment">Sin Equipo</span></button>
                         <button class="ai-modifier-btn btn btn-secondary flex-1 text-sm" data-modifier="con silla y mochila"><i class="fas fa-couch mr-1"></i> <span data-translate-key="ai_modifier_home">En Casa</span></button>
                     </div>
                     <button id="generate-btn" class="btn btn-primary btn-glow w-full p-4 rounded-lg font-bold text-lg mt-4">
                        <i class="fas fa-cogs mr-2"></i> <span data-translate-key="ia_prompt_button">Crear con IA</span>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glassmorphism p-6 rounded-2xl fade-in" style="animation-delay: 0.4s;">
                        <h2 class="text-xl font-bold mb-2"><i class="fas fa-flask text-primary mr-2"></i><span data-translate-key="lab_title">Workout Lab</span></h2>
                        <p class="text-text-secondary mb-3 text-sm" data-translate-key="lab_description">Modos manuales y desaf√≠os.</p>
                         <button id="open-lab-btn" class="btn btn-secondary w-full p-3 rounded-lg font-bold">
                            <i class="fas fa-arrow-right mr-2"></i> <span data-translate-key="lab_button">Ir al Laboratorio</span>
                        </button>
                    </div>
                    <div class="glassmorphism p-6 rounded-2xl fade-in" style="animation-delay: 0.6s;">
                        <h2 class="text-xl font-bold mb-2"><i class="fas fa-users text-primary mr-2"></i><span data-translate-key="partner_title">Entrenamiento D√∫o</span></h2>
                        <p class="text-text-secondary mb-3 text-sm" data-translate-key="partner_desc">Rutinas para dos personas.</p>
                         <button id="open-partner-btn" class="btn btn-secondary w-full p-3 rounded-lg font-bold">
                            <i class="fas fa-arrow-right mr-2"></i> <span data-translate-key="partner_button">Crear Rutina D√∫o</span>
                        </button>
                    </div>
                </div>
             </main>
        </div>

        <!-- ======================= WORKOUT LAB SCREEN ======================== -->
        <div id="lab-screen" class="screen hidden items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="lab_title">Workout Lab</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-4xl flex-grow mx-auto">
                <div class="mb-8 fade-in">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="tools_title">Herramientas de Precisi√≥n</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="timer-type-selection">
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="stopwatch"><i class="fas fa-stopwatch text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_stopwatch">Cron√≥metro</span></button>
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="timer"><i class="fas fa-hourglass-half text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_timer">Temporizador</span></button>
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="tabata"><i class="fas fa-bolt text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_tabata">T√°bata</span></button>
                        <button class="timer-type-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-type="rounds"><i class="fas fa-sync-alt text-4xl mb-2"></i><span class="font-semibold" data-translate-key="tool_rounds">Rondas</span></button>
                    </div>
                </div>
                <div class="fade-in" style="animation-delay: 0.2s;">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="challenges_title">Desaf√≠os R√°pidos</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <button class="challenge-btn btn btn-secondary p-6 rounded-lg text-left" data-challenge="plank">
                            <h3 class="text-xl font-bold text-primary" data-translate-key="challenge_plank_title">‚è≥ Plank Challenge</h3>
                            <p class="text-sm text-text-secondary mt-1" data-translate-key="challenge_plank_desc">Un test de resistencia en plancha.</p>
                        </button>
                         <button class="challenge-btn btn btn-secondary p-6 rounded-lg text-left" data-challenge="pushup">
                            <h3 class="text-xl font-bold text-primary">üí™ Push-up Master</h3>
                            <p class="text-sm text-text-secondary mt-1">Maximiza tus flexiones en 5 minutos.</p>
                        </button>
                        <button class="challenge-btn btn btn-secondary p-6 rounded-lg text-left" data-challenge="burpee">
                            <h3 class="text-xl font-bold text-primary">ü•µ Burpee Blast</h3>
                            <p class="text-sm text-text-secondary mt-1">7 minutos de burpees para una explosi√≥n de cardio.</p>
                        </button>
                        <button class="challenge-btn btn btn-secondary p-6 rounded-lg text-left" data-challenge="pullup">
                            <h3 class="text-xl font-bold text-primary">üèãÔ∏è Dominadas Pro</h3>
                            <p class="text-sm text-text-secondary mt-1">Un reto de fuerza y resistencia en la barra.</p>
                        </button>
                        <button class="challenge-btn btn btn-secondary p-6 rounded-lg text-left" data-challenge="abs">
                            <h3 class="text-xl font-bold text-primary" data-translate-key="challenge_abs_title">üî• Abdomen de Acero</h3>
                            <p class="text-sm text-text-secondary mt-1" data-translate-key="challenge_abs_desc">10 minutos brutales para tu core.</p>
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- ======================= LIVE WORKOUT SCREEN ======================= -->
        <div id="workout-screen" class="screen hidden fullscreen justify-between">
            <header class="w-full flex justify-between items-center flex-shrink-0 pt-4 px-4 max-w-4xl mx-auto z-10">
                <h2 id="workout-title" class="text-xl md:text-2xl font-bold truncate"></h2>
                <button id="exit-workout-btn" class="btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-times mr-2"></i> <span data-translate-key="exit_button">Salir</span></button>
            </header>
            <main class="flex flex-col items-center justify-center flex-grow text-center w-full max-w-2xl relative">
                <div id="exercise-info" class="w-full">
                    <p id="current-exercise" class="text-3xl md:text-4xl font-bold"></p>
                    <p id="next-exercise" class="text-lg md:text-xl text-text-secondary mt-2"></p>
                </div>
                <div class="relative w-64 h-64 md:w-80 md:h-80 flex items-center justify-center my-4">
                    <div class="absolute w-full h-full bg-secondary rounded-full opacity-50"></div>
                    <svg class="absolute w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-700" stroke-width="5" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="workout-progress-circle" class="timer-circle-progress" stroke-width="5" stroke-linecap="round" stroke="var(--primary)" fill="transparent" r="45" cx="50" cy="50" transform="rotate(-90 50 50)" />
                    </svg>
                    <div id="workout-timer-ring" class="z-10 text-center flex flex-col items-center justify-center w-[calc(100%-40px)] h-[calc(100%-40px)] rounded-full border-8 border-transparent transition-colors duration-500 bg-dark">
                        <p id="workout-phase-label" class="text-xl md:text-2xl font-bold uppercase tracking-widest"></p>
                        <p id="workout-timer-display" class="text-7xl md:text-8xl font-black"></p>
                    </div>
                </div>
                <div id="how-to-container" class="w-full max-w-md glassmorphism p-4 rounded-lg hidden">
                    <h4 class="text-lg font-bold text-primary mb-2"><i class="fas fa-lightbulb mr-2"></i><span data-translate-key="how_to_title">C√≥mo Hacerlo</span>:</h4>
                    <ol id="how-to-steps" class="text-left list-decimal list-inside space-y-1 text-sm"></ol>
                </div>
            </main>
            <footer class="w-full flex justify-center items-center gap-4 flex-shrink-0 pb-4 z-10">
                <button id="prev-btn" class="btn btn-secondary p-4 rounded-full w-16 h-16 text-2xl"><i class="fas fa-backward-step"></i></button>
                <button id="play-pause-btn" class="btn btn-primary btn-glow p-4 rounded-full w-24 h-24 text-4xl"><i class="fas fa-play ml-1"></i></button>
                <button id="next-btn" class="btn btn-secondary p-4 rounded-full w-16 h-16 text-2xl"><i class="fas fa-forward-step"></i></button>
                <button id="goat-mode-btn" class="btn btn-secondary p-4 rounded-full w-16 h-16 text-2xl text-danger border-danger" data-translate-key="goat_mode_button_title" title="Modo Cabra Real: Activa frases de un coach de alto rendimiento"><i class="fas fa-skull-crossbones"></i></button>
            </footer>
        </div>

        <!-- ======================= EMOTIONAL VISUALIZER SCREEN ======================= -->
        <div id="emotional-visualizer-screen" class="screen hidden fullscreen items-center justify-center bg-black overflow-hidden">
            <div id="visualizer-container" class="absolute inset-0">
                <!-- Shapes will be injected here by JS -->
            </div>
            <div class="z-10 text-center text-white p-8">
                <p id="visualizer-quote" class="text-2xl lg:text-3xl font-bold opacity-0 transition-opacity duration-1000"></p>
            </div>
        </div>
        
        <!-- ======================== DATA & PROGRESS SCREEN ============================= -->
        <div id="progress-screen" class="screen hidden items-center">
             <header class="w-full flex items-center justify-center mb-8 pt-4 max-w-4xl mx-auto">
                <h1 class="text-3xl font-black text-primary" data-translate-key="progress_title">Mi Progreso</h1>
            </header>
            <main class="w-full max-w-2xl flex-grow mx-auto space-y-8">
                <!-- Weekly Chart -->
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-between">
                        <span data-translate-key="progress_weekly_title">Actividad Semanal</span>
                    </h2>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div id="minutes-circle" class="relative"></div>
                        <div id="workouts-circle" class="relative"></div>
                        <div id="calories-circle" class="relative"></div>
                    </div>
                </div>
                <!-- Body Map -->
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="progress_body_map_title">M√∫sculos Trabajados (√öltimos 7 D√≠as)</h2>
                    <div id="body-map-container" class="relative w-48 h-80 mx-auto">
                        <!-- SVG Body Map will be injected here -->
                    </div>
                    <div id="body-map-tooltip"></div>
                </div>
                <!-- Achievements -->
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center justify-between">
                        <span data-translate-key="progress_achievements_title">Logros</span>
                    </h2>
                    <div id="achievements-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4 text-center"></div>
                </div>
                <!-- History -->
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="progress_history_title">Historial de Entrenamiento</h2>
                    <div id="workout-history-list" class="space-y-3 max-h-64 overflow-y-auto custom-scrollbar pr-2"></div>
                    <button id="analyze-history-btn" class="btn btn-primary w-full p-3 mt-4"><i class="fas fa-magic mr-2"></i><span data-translate-key="analyze_history_button">Analizar Historial con IA</span></button>
                </div>
            </main>
        </div>
        
        <!-- ======================= WELLNESS HUB SCREEN =========================== -->
        <div id="wellness-screen" class="screen hidden items-center">
             <header class="w-full flex items-center justify-center mb-8 pt-4 max-w-4xl mx-auto">
                <h1 class="text-3xl font-black text-primary" data-translate-key="wellness_title">Centro de Bienestar</h1>
            </header>
            <main class="w-full max-w-2xl flex-grow mx-auto space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <button class="wellness-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-modal="breathing">
                        <i class="fas fa-lungs text-4xl mb-2 text-info"></i>
                        <span class="font-semibold text-center" data-translate-key="wellness_breathing_title">Respiraci√≥n Guiada</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-modal="mobility">
                        <i class="fas fa-person-walking text-4xl mb-2 text-success"></i>
                        <span class="font-semibold text-center" data-translate-key="wellness_mobility_title">Rutinas de Movilidad</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-modal="shadow">
                        <i class="fas fa-lightbulb text-4xl mb-2 text-warning"></i>
                        <span class="font-semibold text-center" data-translate-key="wellness_shadow_title">Reflexi√≥n Diaria</span>
                    </button>
                     <button class="wellness-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-modal="stress">
                        <i class="fas fa-brain text-4xl mb-2 text-danger"></i>
                        <span class="font-semibold text-center" data-translate-key="wellness_stress_title">Modo Anti-Estr√©s</span>
                    </button>
                    <button class="wellness-btn btn btn-ice p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-modal="ice">
                        <i class="fas fa-snowflake text-4xl mb-2"></i>
                        <span class="font-semibold text-center" data-translate-key="wellness_ice_title">Terapia de Hielo</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-modal="sexual">
                        <i class="fas fa-heart-pulse text-4xl mb-2 text-pink-500"></i>
                        <span class="font-semibold text-center" data-translate-key="wellness_sexual_title">Bienestar √çntimo</span>
                    </button>
                     <button class="wellness-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-modal="supplements">
                        <i class="fas fa-pills text-4xl mb-2 text-green-400"></i>
                        <span class="font-semibold text-center" data-translate-key="wellness_supplements_title">Gu√≠a de Suplementos</span>
                    </button>
                    <button class="wellness-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center justify-center aspect-square" data-modal="sleep">
                        <i class="fas fa-moon text-4xl mb-2 text-indigo-400"></i>
                        <span class="font-semibold text-center" data-translate-key="sleep_title">M√≥dulo de Sue√±o</span>
                    </button>
                </div>
            </main>
        </div>

        <!-- ======================= SETTINGS SCREEN =========================== -->
        <div id="settings-screen" class="screen hidden items-center">
            <header class="w-full flex items-center justify-center mb-8 pt-4 max-w-4xl mx-auto">
                <h1 class="text-3xl font-black text-primary" data-translate-key="settings_title">Ajustes y Datos</h1>
            </header>
            <main class="w-full max-w-md flex-grow mx-auto space-y-6 custom-scrollbar pr-2">
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="settings_profile_title">Mi Perfil</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="input-weight" class="font-bold" data-translate-key="data_weight">Peso (kg)</label>
                                <input id="input-weight" type="number" class="w-full mt-1" placeholder="e.g., 75.5">
                            </div>
                            <div>
                                <label for="input-height" class="font-bold" data-translate-key="data_height">Altura (cm)</label>
                                <input id="input-height" type="number" class="w-full mt-1" placeholder="e.g., 180">
                            </div>
                        </div>
                        <div>
                            <label for="input-gender" class="font-bold" data-translate-key="data_gender">G√©nero</label>
                            <select id="input-gender" class="w-full mt-1">
                                <option value="male" data-translate-key="gender_male">Masculino</option>
                                <option value="female" data-translate-key="gender_female">Femenino</option>
                            </select>
                        </div>
                        <button id="save-data-btn" class="btn btn-primary w-full p-3 rounded-lg font-bold"><i class="fas fa-save mr-2"></i><span data-translate-key="data_save_button">Guardar Datos</span></button>
                    </div>
                </div>

                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="settings_alarms_title">Alarmas Personalizadas</h2>
                    <div id="alarms-list" class="space-y-3 mb-4"></div>
                    <button id="add-alarm-btn" class="btn btn-secondary w-full p-3 rounded-lg font-bold"><i class="fas fa-plus mr-2"></i><span data-translate-key="settings_add_alarm_button">A√±adir Alarma</span></button>
                </div>

                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="settings_offline_title">Modo Offline</h2>
                    <p class="text-text-secondary mb-4" data-translate-key="settings_offline_desc">Accede a rutinas sin conexi√≥n. Las rutinas se descargar√°n la primera vez que las uses.</p>
                    <button id="offline-access-btn" class="btn btn-secondary w-full p-3 rounded-lg font-bold">
                        <i class="fas fa-download mr-2"></i><span data-translate-key="settings_offline_button">Ver Rutinas Offline</span>
                    </button>
                </div>
            </main>
        </div>
        
        <!-- ======================= PARTNER WORKOUT SCREEN =========================== -->
        <div id="partner-workout-screen" class="screen hidden items-center">
            <header class="w-full flex items-center justify-between mb-8 pt-4 max-w-4xl mx-auto">
                <button class="back-to-dashboard-btn btn btn-secondary px-4 py-2 rounded-lg"><i class="fas fa-arrow-left mr-2"></i> <span data-translate-key="back_button">Volver</span></button>
                <h1 class="text-3xl font-black text-primary" data-translate-key="partner_title">Entrenamiento D√∫o</h1>
                <div class="w-24"></div>
            </header>
            <main class="w-full max-w-md flex-grow mx-auto space-y-6">
                <div class="glassmorphism p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4" data-translate-key="partner_prompt_title">Describe su Entrenamiento</h2>
                    <p class="text-text-secondary mb-4" data-translate-key="partner_prompt_desc">Dile a la IA qu√© tipo de rutina para dos personas quieren. Por ejemplo: 'Una rutina de cardio en casa de 30 minutos sin equipo' o 'Un entrenamiento de fuerza para todo el cuerpo en el gimnasio'.</p>
                    <textarea id="partner-prompt" class="w-full h-32 p-4 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none resize-none"></textarea>
                    <button id="generate-partner-btn" class="btn btn-primary w-full p-3 mt-4 rounded-lg font-bold"><i class="fas fa-users mr-2"></i><span data-translate-key="partner_generate_button">Generar Rutina D√∫o</span></button>
                </div>
            </main>
        </div>

        <!-- ======================= BOTTOM NAVIGATION ======================= -->
        <nav id="bottom-nav-bar" class="bottom-nav">
            <div class="glassmorphism flex justify-around items-center rounded-full p-2 max-w-sm mx-auto">
                <button class="bottom-nav-item flex flex-col items-center text-text-secondary transition-all duration-300 w-16" data-screen="dashboard">
                    <i class="fas fa-home text-xl"></i>
                    <span class="text-xs font-bold mt-1" data-translate-key="nav_home">Inicio</span>
                </button>
                <button class="bottom-nav-item flex flex-col items-center text-text-secondary transition-all duration-300 w-16" data-screen="progress">
                    <i class="fas fa-chart-line text-xl"></i>
                    <span class="text-xs font-bold mt-1" data-translate-key="nav_progress">Progreso</span>
                </button>
                <button class="bottom-nav-item flex flex-col items-center text-text-secondary transition-all duration-300 w-16" data-screen="wellness">
                    <i class="fas fa-spa text-xl"></i>
                    <span class="text-xs font-bold mt-1" data-translate-key="nav_wellness">Bienestar</span>
                </button>
                <button class="bottom-nav-item flex flex-col items-center text-text-secondary transition-all duration-300 w-16" data-screen="settings">
                    <i class="fas fa-cog text-xl"></i>
                    <span class="text-xs font-bold mt-1" data-translate-key="nav_settings">Ajustes</span>
                </button>
            </div>
        </nav>

        <!-- ======================= MODALS ======================= -->
        <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
            <div id="modal-content-wrapper" class="glassmorphism rounded-2xl w-full max-w-lg p-6 relative transform scale-95 transition-transform duration-300 max-h-[90vh] flex flex-col">
                <button id="close-modal-btn" class="absolute top-4 right-4 text-text-secondary hover:text-primary text-2xl z-10">&times;</button>
                <div id="modal-body" class="flex-grow overflow-y-auto custom-scrollbar pr-2">
                    <!-- Content injected by JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DICTIONARY FOR i18n ---
            const translations = {
                es: {
                    // General
                    main_title: "goati<span class='text-primary'>FIT</span>",
                    subtitle: "Tu Entrenador de √âlite con IA",
                    back_button: "Volver",
                    exit_button: "Salir",
                    cancel_button: "Cancelar",
                    start_button: "Iniciar",
                    stop_button: "Parar",
                    pause_button: "Pausa",
                    resume_button: "Seguir",
                    reset_button: "Reiniciar",
                    save_button: "Guardar",
                    lap_button: "Vuelta",
                    
                    // Nav
                    nav_home: "Inicio",
                    nav_progress: "Progreso",
                    nav_wellness: "Bienestar",
                    nav_settings: "Ajustes",

                    // Dashboard
                    mission_title: "Tu Misi√≥n de Hoy",
                    mission_placeholder: "Pide una rutina a la IA para empezar.",
                    ia_prompt_title: "Pide tu Rutina a la IA",
                    ia_prompt_placeholder: "Ej: 'Rutina de 45 mins en gimnasio para espalda y b√≠ceps'",
                    ia_prompt_button: "Crear con IA",
                    ai_modifier_no_equipment: "Sin Equipo",
                    ai_modifier_home: "En Casa",
                    lab_button: "Ir al Laboratorio",
                    partner_title: "Entrenamiento D√∫o",
                    partner_desc: "Rutinas para dos personas.",
                    partner_button: "Crear Rutina D√∫o",

                    // Workout Lab
                    lab_title: "Workout Lab",
                    lab_description: "Modos manuales y desaf√≠os.",
                    tools_title: "Herramientas de Precisi√≥n",
                    tool_stopwatch: "Cron√≥metro",
                    tool_timer: "Temporizador",
                    tool_tabata: "T√°bata",
                    tool_rounds: "Rondas",
                    challenges_title: "Desaf√≠os R√°pidos",
                    challenge_abs_title: "üî• Abdomen de Acero",
                    challenge_abs_desc: "10 minutos brutales para tu core.",
                    challenge_plank_title: "‚è≥ Plank Challenge",
                    challenge_plank_desc: "Un test de resistencia en plancha.",

                    // Live Workout
                    how_to_title: "C√≥mo Hacerlo",
                    goat_mode_button_title: "Modo Cabra Real: Activa frases de un coach de alto rendimiento",
                    goat_mode_on: "Modo Cabra Real: ACTIVADO",
                    goat_mode_off: "Modo Cabra Real: DESACTIVADO",
                    next_exercise_prefix: "Siguiente",
                    last_exercise_text: "¬°√öltimo ejercicio!",
                    workout_complete_title: "¬°Completado!",
                    workout_complete_subtitle: "¬°Excelente Trabajo!",
                    phase_prep: "PREP√ÅRATE",
                    phase_work: "TRABAJO",
                    phase_rest: "DESCANSO",
                    phase_cooldown: "ENFRIAMIENTO",
                    phase_stress: "RESPIRA",
                    
                    // Emotional Visualizer
                    visualizer_quote_1: "Buen trabajo. Hoy tu cuerpo agradece la calma.",
                    visualizer_quote_2: "Has cumplido. La constancia tiene m√°s valor que la motivaci√≥n.",
                    visualizer_quote_3: "Observa tu energ√≠a. Agrad√©cele a tu cuerpo por el esfuerzo.",
                    visualizer_quote_4: "Terminar lo que comienzas es un h√°bito de excelencia.",

                    // Progress Screen
                    progress_title: "Mi Progreso",
                    progress_weekly_title: "Actividad Semanal",
                    progress_minutes: "Minutos",
                    progress_workouts: "Rutinas",
                    progress_calories: "Calor√≠as",
                    progress_body_map_title: "M√∫sculos Trabajados (√öltimos 7 D√≠as)",
                    progress_achievements_title: "Logros",
                    progress_history_title: "Historial de Entrenamiento",
                    analyze_history_button: "Analizar Historial con IA",
                    achievement_first_workout_name: "Primer Paso",
                    achievement_first_workout_desc: "Completa tu primer entrenamiento.",
                    achievement_seven_day_streak_name: "Imparable",
                    achievement_seven_day_streak_desc: "Entrena 7 d√≠as seguidos.",
                    achievement_goat_mode_name: "Modo Cabra",
                    achievement_goat_mode_desc: "Completa una rutina con el Modo Cabra Real activado.",
                    achievement_perfect_week_name: "Semana Perfecta",
                    achievement_perfect_week_desc: "Entrena todos los d√≠as de la semana.",
                    day_short_mon: "Lun", day_short_tue: "Mar", day_short_wed: "Mi√©", day_short_thu: "Jue", day_short_fri: "Vie", day_short_sat: "S√°b", day_short_sun: "Dom",

                    // Wellness Hub
                    wellness_title: "Centro de Bienestar",
                    wellness_breathing_title: "Respiraci√≥n Guiada",
                    wellness_mobility_title: "Rutinas de Movilidad",
                    wellness_shadow_title: "Reflexi√≥n Diaria",
                    wellness_stress_title: "Modo Anti-Estr√©s",
                    wellness_ice_title: "Terapia de Hielo",
                    wellness_sexual_title: "Bienestar √çntimo",
                    wellness_supplements_title: "Gu√≠a de Suplementos",
                    sleep_title: "M√≥dulo de Sue√±o",

                    // Settings & Data
                    settings_title: "Ajustes y Datos",
                    settings_profile_title: "Mi Perfil",
                    data_weight: "Peso (kg)",
                    data_height: "Altura (cm)",
                    data_gender: "G√©nero",
                    gender_male: "Masculino",
                    gender_female: "Femenino",
                    data_save_button: "Guardar Datos",
                    settings_alarms_title: "Alarmas Personalizadas",
                    settings_add_alarm_button: "A√±adir Alarma",
                    settings_offline_title: "Modo Offline",
                    settings_offline_desc: "Accede a rutinas sin conexi√≥n o crea las tuyas.",
                    settings_offline_button: "Gestionar Rutinas Offline",
                    create_offline_routine: "Crear Nueva Rutina",

                    // Modals & Popups
                    oracle_title: "Or√°culo Fitness Diario",
                    oracle_close: "Entendido",
                    coach_modal_title: "Mensaje del Coach",
                    coach_modal_close: "¬°Entendido!",
                    goat_coach_start: "Conc√©ntrate. Hoy es una nueva oportunidad.",
                    goat_coach_during: "Respira, enf√≥cate y da el siguiente paso.",
                    goat_coach_end: "Este es el momento que marca la diferencia.",
                    goat_coach_finish: "Has cumplido. La constancia tiene m√°s valor que la motivaci√≥n.",
                    shadow_tracker_title: "Shadow Tracker: Reflexi√≥n Privada",
                    shadow_q_trained: "¬øEntrenaste hoy?",
                    shadow_q_nutrition: "¬øC√≥mo estuvo tu alimentaci√≥n?",
                    shadow_q_sleep: "¬øC√≥mo calificas tu descanso?",
                    shadow_q_emotion: "¬øC√≥mo te sentiste emocionalmente?",
                    shadow_q_screens: "¬øTuviste excesivo uso de pantallas?",
                    shadow_q_stress: "¬øSientes estr√©s o ansiedad?",
                    shadow_response: "Reconocerlo ya es avanzar. Ma√±ana puedes elegir distinto.",
                    shadow_analyze_button: "Analizar con IA",
                    ice_therapy_title: "Terapia de Hielo",
                    ice_therapy_desc: "La exposici√≥n al fr√≠o puede mejorar la recuperaci√≥n, reducir la inflamaci√≥n y aumentar la energ√≠a. Comienza con duchas fr√≠as de 30 segundos y aumenta gradualmente.",
                    ice_therapy_start_timer: "Iniciar Timer de 30s",
                    supplements_title: "Asistente de Suplementos",
                    sexual_wellness_title: "Bienestar √çntimo",
                    sexual_wellness_desc: "Un espacio privado para registrar y entender tu energ√≠a sexual y ciclo como parte de tu bienestar integral.",
                    sexual_activity_label: "¬øActividad √≠ntima hoy?",
                    sexual_desire_label: "Nivel de deseo (1-5)",
                    analyze_wellness_button: "Analizar Bienestar con IA",
                    alarm_modal_title: "Nueva Alarma",
                    alarm_name_placeholder: "Nombre (Ej: Tomar agua)",
                    alarm_time: "Hora",
                    alarm_days: "Repetir",
                    stress_mode_title: "Rutina Anti-Estr√©s",
                    stress_mode_desc: "Una rutina de 5 minutos para liberar tensi√≥n y calmar la mente.",
                    mobility_modal_title: "Rutinas de Movilidad",
                    mobility_modal_desc: "P√≠dele a la IA rutinas cortas para cualquier momento del d√≠a.",
                    mobility_morning: "Ma√±ana",
                    mobility_break: "Descanso Activo",
                    mobility_night: "Noche",
                    breathing_modal_title: "Respiraci√≥n Guiada",
                    breathing_instruction_in: "Inhala...",
                    breathing_instruction_hold: "Sost√©n...",
                    breathing_instruction_out: "Exhala...",
                    breathing_instruction_fast_in_out: "Inhala, Exhala",
                    breathing_session_complete: "Sesi√≥n completada. Siente la calma.",
                    breathing_mode_calm: "Calma (4-7-8)",
                    breathing_mode_energy: "Energ√≠a (R√°pida)",
                    sleep_modal_title: "M√≥dulo de Sue√±o",
                    sleep_desc: "Rel√°jate y prep√°rate para un descanso profundo.",
                    sleep_start_button: "Iniciar Sonido",
                    sleep_stop_button: "Detener Sonido",
                    sleep_timer_label: "Apagar en",
                    female_cycle_title: "Registro de Ciclo Menstrual",
                    female_cycle_desc: "Registrar el ciclo puede ayudar a la IA a sugerir entrenamientos con la intensidad adecuada, ya que los niveles de energ√≠a y la sensibilidad pueden variar. Esta informaci√≥n es privada.",
                    last_period_date: "Inicio de tu √∫ltimo per√≠odo",
                    cycle_length: "Duraci√≥n promedio del ciclo (d√≠as)",
                    cycle_info_title: "Tu Ciclo Actual",
                    next_period: "Pr√≥ximo Per√≠odo",
                    fertile_window: "Ventana F√©rtil",
                    ovulation_day: "D√≠a de Ovulaci√≥n",
                    yes: "S√≠",
                    no: "No",
                    analysis_modal_title: "An√°lisis de IA",
                    analysis_loading: "Tu coach IA est√° analizando tu progreso...",
                },
                en: {
                    // English translations would go here...
                }
            };

            // --- DOM Elements ---
            const dom = {
                appContainer: document.getElementById('app-container'),
                screens: Array.from(document.querySelectorAll('.screen')).reduce((acc, screen) => {
                    acc[screen.id.replace('-screen', '')] = screen;
                    return acc;
                }, {}),
                dashboard: {
                    userPrompt: document.getElementById('user-prompt'),
                    generateBtn: document.getElementById('generate-btn'),
                    workoutOfTheDay: document.getElementById('workout-of-the-day'),
                    openLabBtn: document.getElementById('open-lab-btn'),
                    openPartnerBtn: document.getElementById('open-partner-btn'),
                    pointsValue: document.getElementById('points-value'),
                },
                lab: {
                    timerTypeSelection: document.getElementById('timer-type-selection'),
                    challengeBtns: document.querySelectorAll('.challenge-btn'),
                },
                workout: {
                    screen: document.getElementById('workout-screen'),
                    title: document.getElementById('workout-title'),
                    exitBtn: document.getElementById('exit-workout-btn'),
                    timerRing: document.getElementById('workout-timer-ring'),
                    progressCircle: document.getElementById('workout-progress-circle'),
                    phaseLabel: document.getElementById('workout-phase-label'),
                    timerDisplay: document.getElementById('workout-timer-display'),
                    currentExercise: document.getElementById('current-exercise'),
                    nextExercise: document.getElementById('next-exercise'),
                    howToContainer: document.getElementById('how-to-container'),
                    howToSteps: document.getElementById('how-to-steps'),
                    prevBtn: document.getElementById('prev-btn'),
                    playPauseBtn: document.getElementById('play-pause-btn'),
                    nextBtn: document.getElementById('next-btn'),
                    goatModeBtn: document.getElementById('goat-mode-btn'),
                },
                emotionalVisualizer: {
                    screen: document.getElementById('emotional-visualizer-screen'),
                    container: document.getElementById('visualizer-container'),
                    quote: document.getElementById('visualizer-quote'),
                },
                progress: {
                    minutesCircle: document.getElementById('minutes-circle'),
                    workoutsCircle: document.getElementById('workouts-circle'),
                    caloriesCircle: document.getElementById('calories-circle'),
                    bodyMapContainer: document.getElementById('body-map-container'),
                    bodyMapTooltip: document.getElementById('body-map-tooltip'),
                    achievementsGrid: document.getElementById('achievements-grid'),
                    historyList: document.getElementById('workout-history-list'),
                    analyzeHistoryBtn: document.getElementById('analyze-history-btn'),
                },
                settings: {
                    inputWeight: document.getElementById('input-weight'),
                    inputHeight: document.getElementById('input-height'),
                    inputGender: document.getElementById('input-gender'),
                    saveDataBtn: document.getElementById('save-data-btn'),
                    alarmsList: document.getElementById('alarms-list'),
                    addAlarmBtn: document.getElementById('add-alarm-btn'),
                    offlineAccessBtn: document.getElementById('offline-access-btn'),
                },
                partner: {
                    prompt: document.getElementById('partner-prompt'),
                    generateBtn: document.getElementById('generate-partner-btn'),
                },
                modals: {
                    overlay: document.getElementById('modal-overlay'),
                    contentWrapper: document.getElementById('modal-content-wrapper'),
                    closeBtn: document.getElementById('close-modal-btn'),
                    body: document.getElementById('modal-body'),
                },
                bottomNav: document.getElementById('bottom-nav-bar'),
                themeToggleBtn: document.getElementById('theme-toggle-btn'),
                languageSelect: document.getElementById('language-select'),
            };

            // --- Master State Object ---
            let state = {
                currentScreen: 'dashboard',
                language: 'es',
                theme: 'dark',
                audioContext: null,
                aiWorkout: { routine: null, currentIndex: 0, currentPhase: 'idle', phaseTimeLeft: 0, isPaused: true, timerInterval: null, goatMode: false },
                sleep: { soundNode: null, gainNode: null, isPlaying: false, selectedSound: 'brown', timerId: null },
                progress: {
                    history: [],
                    achievements: { first_workout: false, seven_day_streak: false, goat_mode: false, perfect_week: false },
                    points: 0,
                    weeklyStats: { minutes: 0, workouts: 0, calories: 0 },
                    workedMuscles: [],
                },
                userData: {
                    weight: null, height: null, gender: 'male',
                    lastOracleDate: null,
                    sexualLog: { date: null, activity: false, desire: 3 },
                    menstrual: { lastPeriodDate: null, cycleLength: 28 },
                },
                alarms: [],
                offlineRoutines: {
                    defaults: [],
                    custom: []
                },
                manualTimer: { type: null, interval: null, totalTime: 0, timeRemaining: 0, startTime: 0, isRunning: false, settings: {}, currentPhase: 'work', currentRound: 1, lapTimes: [] },
                breathing: { interval: null, isRunning: false, timeouts: [], mode: 'calm' },
            };

            // --- CORE APP LOGIC ---
            function showScreen(screenId) {
                const targetScreen = dom.screens[screenId];
                if (!targetScreen) {
                    console.error(`Screen "${screenId}" not found.`);
                    return;
                }
                Object.values(dom.screens).forEach(screen => screen.classList.add('hidden'));
                targetScreen.classList.remove('hidden');
                state.currentScreen = screenId;
                dom.appContainer.scrollTop = 0;

                const isFullScreen = (screenId === 'workout' || screenId === 'emotional-visualizer');
                dom.bottomNav.style.display = isFullScreen ? 'none' : 'block';

                dom.bottomNav.querySelectorAll('.bottom-nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.screen === screenId);
                });

                if (screenId === 'progress') renderProgressScreen();
                if (screenId === 'settings') renderSettingsScreen();
            }

            function setLanguage(lang) {
                state.language = lang;
                document.documentElement.lang = lang;
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    const translation = translations[lang][key];
                    if (translation) {
                        if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') {
                            if (el.placeholder) el.placeholder = translation;
                        }
                        else if (el.hasAttribute('title')) el.title = translation;
                        else el.innerHTML = translation;
                    }
                });
            }

            function toggleTheme() {
                document.body.classList.toggle('light-theme');
                document.body.classList.toggle('dark-theme');
                state.theme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
                dom.themeToggleBtn.querySelector('i').className = state.theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
                saveState();
            }
            
            function initAudio() {
                if (!state.audioContext) {
                    try {
                        state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) {
                        console.error("AudioContext not supported");
                        return;
                    }
                }
                if (state.audioContext.state === 'suspended') {
                    state.audioContext.resume();
                }
            }

            function playSound(type, freq = null) {
                if (!state.audioContext) return;
                initAudio();
                const sounds = {
                    start: { freq: 440, duration: 150, type: 'sine' },
                    stop: { freq: 220, duration: 200, type: 'triangle' },
                    next: { freq: 660, duration: 100, type: 'square' },
                    finish: { freq: 880, duration: 500, type: 'triangle' },
                    coach: { freq: 523, duration: 100, type: 'sine' },
                    tick: { freq: 1000, duration: 50, type: 'sine' }
                };
                const sound = sounds[type];
                if (!sound) return;

                const oscillator = state.audioContext.createOscillator();
                const gainNode = state.audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(state.audioContext.destination);
                oscillator.type = sound.type;
                oscillator.frequency.value = freq || sound.freq;
                gainNode.gain.setValueAtTime(0, state.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, state.audioContext.currentTime + 0.01);
                oscillator.start(state.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, state.audioContext.currentTime + sound.duration / 1000);
                oscillator.stop(state.audioContext.currentTime + sound.duration / 1000);
            }

            // --- Specific Challenge Workouts ---
            const challengeWorkouts = {
                plank: {
                    title: "Plank Challenge", totalDurationMinutes: 5, calories: 50, muscleGroups: ["core", "shoulders"],
                    phases: [
                        { phaseName: "Prep√°rate", type: "prep", durationSeconds: 10, exerciseName: "Posici√≥n de Plancha" },
                        { phaseName: "¬°Aguanta!", type: "work", durationSeconds: 290, exerciseName: "Plancha Isom√©trica" }
                    ]
                },
                burpee: {
                    title: "Burpee Blast", totalDurationMinutes: 7, calories: 150, muscleGroups: ["full-body"],
                    phases: [
                        { phaseName: "Prep√°rate", type: "prep", durationSeconds: 15, exerciseName: "Calentamiento Ligero" },
                        ...Array(7).fill(0).flatMap(() => [
                            { phaseName: "¬°A TOPE!", type: "work", durationSeconds: 45, exerciseName: "Burpees" },
                            { phaseName: "Recupera", type: "rest", durationSeconds: 15, exerciseName: "Descanso Activo" }
                        ]),
                        { phaseName: "Enfriamiento", type: "cooldown", durationSeconds: 25, exerciseName: "Estiramiento" }
                    ]
                },
                pushup: {
                    title: "Push-up Master", totalDurationMinutes: 5, calories: 80, muscleGroups: ["chest", "triceps", "shoulders"],
                     phases: [
                        { phaseName: "Prep√°rate", type: "prep", durationSeconds: 20, exerciseName: "C√≠rculos de Brazos" },
                        ...Array(5).fill(0).flatMap(() => [
                            { phaseName: "Flexiones", type: "work", durationSeconds: 40, exerciseName: "Flexiones (Tu M√°ximo)" },
                            { phaseName: "Descanso", type: "rest", durationSeconds: 20, exerciseName: "Descanso" }
                        ]),
                     ]
                },
                pullup: {
                    title: "Dominadas Pro", totalDurationMinutes: 10, calories: 120, muscleGroups: ["back", "biceps"],
                    phases: [
                        { phaseName: "Calentamiento", type: "prep", durationSeconds: 120, exerciseName: "Colgarse y Scapular Pulls" },
                        ...Array(4).fill(0).flatMap(() => [
                            { phaseName: "Dominadas", type: "work", durationSeconds: 60, exerciseName: "Dominadas (Tu M√°ximo)" },
                            { phaseName: "Descanso", type: "rest", durationSeconds: 60, exerciseName: "Descanso" }
                        ]),
                        { phaseName: "Enfriamiento", type: "cooldown", durationSeconds: 120, exerciseName: "Estiramiento Dorsal" }
                    ]
                },
                abs: {
                    title: "Abdomen de Acero", totalDurationMinutes: 10, calories: 110, muscleGroups: ["core"],
                    phases: [
                        { phaseName: "Prep√°rate", type: "prep", durationSeconds: 10, exerciseName: "Posici√≥n Inicial" },
                        { phaseName: "Crunches", type: "work", durationSeconds: 50, exerciseName: "Crunches" }, { phaseName: "Descanso", type: "rest", durationSeconds: 10, exerciseName: "Descanso" },
                        { phaseName: "Elevaci√≥n de Piernas", type: "work", durationSeconds: 50, exerciseName: "Elevaci√≥n de Piernas" }, { phaseName: "Descanso", type: "rest", durationSeconds: 10, exerciseName: "Descanso" },
                        { phaseName: "Plancha", type: "work", durationSeconds: 50, exerciseName: "Plancha" }, { phaseName: "Descanso", type: "rest", durationSeconds: 10, exerciseName: "Descanso" },
                        { phaseName: "Russian Twists", type: "work", durationSeconds: 50, exerciseName: "Giros Rusos" }, { phaseName: "Descanso", type: "rest", durationSeconds: 10, exerciseName: "Descanso" },
                        ...Array(3).fill(0).flatMap(() => [
                             { phaseName: "Plancha", type: "work", durationSeconds: 50, exerciseName: "Plancha" }, { phaseName: "Descanso", type: "rest", durationSeconds: 10, exerciseName: "Descanso" },
                        ]),
                    ]
                }
            };

            // --- Gemini API Logic (Mocked with more workouts) ---
            const mockWorkouts = [
                { title: "Fuerza de Espalda y B√≠ceps", duration: 45, calories: 350, muscles: ["back", "biceps"], type: "Gimnasio", promptKeywords: ["espalda", "b√≠ceps", "fuerza", "gym", "gimnasio"] },
                { title: "Cardio Intenso en Casa", duration: 30, calories: 400, muscles: ["full-body", "legs"], type: "Casa", promptKeywords: ["cardio", "intenso", "casa", "sin equipo", "correr"] },
                { title: "Tren Superior con Mancuernas", duration: 40, calories: 300, muscles: ["chest", "shoulders", "triceps"], type: "Gimnasio", promptKeywords: ["pecho", "hombros", "tr√≠ceps", "mancuernas"] },
                { title: "Yoga para Flexibilidad", duration: 25, calories: 150, muscles: [], type: "Bienestar", promptKeywords: ["yoga", "flexibilidad", "estirar"] },
                { title: "HIIT Quema Grasa", duration: 20, calories: 350, muscles: ["full-body"], type: "HIIT", promptKeywords: ["hiit", "quemar grasa", "r√°pido"] },
                { title: "Core de Acero", duration: 15, calories: 120, muscles: ["core"], type: "Casa", promptKeywords: ["core", "abdomen", "abs"] },
                { title: "Piernas y Gl√∫teos en Gym", duration: 50, calories: 450, muscles: ["legs", "glutes"], type: "Gimnasio", promptKeywords: ["piernas", "gl√∫teos", "gym"] },
                { title: "Full Body con Bandas", duration: 35, calories: 250, muscles: ["full-body"], type: "Casa", promptKeywords: ["bandas", "resistencia", "full body"] },
                { title: "Boxeo Sombra Cardio", duration: 30, calories: 380, muscles: ["full-body", "shoulders"], type: "Cardio", promptKeywords: ["boxeo", "sombra", "cardio"] },
                { title: "Movilidad Matutina", duration: 10, calories: 50, muscles: [], type: "Bienestar", promptKeywords: ["movilidad", "ma√±ana", "despertar"] },
                { title: "Reto de Plancha Extremo", duration: 5, calories: 60, muscles: ["core", "shoulders"], type: "Reto", promptKeywords: ["plancha", "plank", "reto"] },
                { title: "Cardio en Pareja", duration: 30, calories: 300, muscles: ["full-body"], type: "D√∫o", promptKeywords: ["d√∫o", "pareja", "juntos", "correr"] },
                { title: "Calma y Anti-Estr√©s", duration: 5, calories: 20, muscles: [], type: "Anti-Estr√©s", promptKeywords: ["anti-estr√©s", "calma", "tensi√≥n"] },
                { title: "Empuje de Pecho y Tr√≠ceps", duration: 45, calories: 320, muscles: ["chest", "triceps"], type: "Gimnasio", promptKeywords: ["empuje", "push", "pecho", "tr√≠ceps"] },
                { title: "Cardio de Bajo Impacto", duration: 25, calories: 200, muscles: ["full-body"], type: "Casa", promptKeywords: ["bajo impacto", "rodillas", "sin saltos"] },
                { title: "Fuerza Funcional con Kettlebell", duration: 30, calories: 330, muscles: ["full-body", "core", "glutes"], type: "Gimnasio", promptKeywords: ["kettlebell", "pesa rusa", "funcional"] },
                { title: "Estiramiento Nocturno", duration: 15, calories: 70, muscles: [], type: "Bienestar", promptKeywords: ["noche", "estirar", "dormir"] },
                { title: "Reto de Burpees", duration: 7, calories: 150, muscles: ["full-body"], type: "HIIT", promptKeywords: ["burpee", "reto", "blast"] },
                { title: "Hombros 3D con Mancuernas", duration: 35, calories: 280, muscles: ["shoulders"], type: "Gimnasio", promptKeywords: ["hombros", "deltoides", "3d"] },
                { title: "Baile Fitness", duration: 30, calories: 300, muscles: ["full-body"], type: "Cardio", promptKeywords: ["bailar", "zumba", "fitness"] }
            ];

            function generateMockPhases(workout) {
                const phases = [{ phaseName: "Calentamiento", type: "prep", durationSeconds: 120, exerciseName: "Movilidad Articular" }];
                const numExercises = Math.floor(workout.duration / 5);
                for(let i = 0; i < numExercises; i++) {
                    phases.push({ phaseName: `Ejercicio ${i+1}`, type: "work", durationSeconds: 60, exerciseName: `Principal de ${workout.muscles[0] || 'Full Body'}`});
                    phases.push({ phaseName: "Descanso", type: "rest", durationSeconds: 45, exerciseName: "Descanso" });
                }
                phases.push({ phaseName: "Enfriamiento", type: "cooldown", durationSeconds: 120, exerciseName: "Estiramientos" });
                return phases;
            }

            async function callGeminiAPI(prompt, systemPrompt) {
                console.log("Calling Mock Gemini API with prompt:", prompt);
                const lowerCasePrompt = prompt.toLowerCase();
                
                if (prompt.startsWith("Analiza")) {
                     return new Promise(resolve => {
                        setTimeout(() => {
                            resolve(JSON.stringify({ analysis: "He notado que te enfocas mucho en el tren superior. ¬°Excelente! Para un desarrollo balanceado, te sugiero incorporar una sesi√≥n de piernas y gl√∫teos esta semana. Tambi√©n, tu constancia es buena, ¬°sigue as√≠!" }));
                        }, 1500);
                    });
                }
                 if (prompt.startsWith("Asistente de Suplementos:")) {
                     return new Promise(resolve => {
                        setTimeout(() => {
                            let recommendation = "Basado en tus metas, te recomiendo **Prote√≠na Whey** para la recuperaci√≥n muscular post-entrenamiento. Adicionalmente, la **Creatina** puede darte un impulso en fuerza y rendimiento. Siempre consulta con un profesional.";
                            if(prompt.includes("energ√≠a")){
                                recommendation = "Para un impulso de energ√≠a, considera un **pre-entreno con cafe√≠na**. Para la recuperaci√≥n, la **Prote√≠na Whey** sigue siendo una excelente opci√≥n. Siempre consulta con un profesional.";
                            }
                            resolve(JSON.stringify({ recommendation }));
                        }, 1200);
                    });
                }


                let bestMatch = mockWorkouts[0];
                let maxScore = -1;

                mockWorkouts.forEach(workout => {
                    let currentScore = 0;
                    workout.promptKeywords.forEach(keyword => {
                        if (lowerCasePrompt.includes(keyword)) {
                            currentScore++;
                        }
                    });
                    if (currentScore > maxScore) {
                        maxScore = currentScore;
                        bestMatch = workout;
                    }
                });
                
                if (maxScore === 0) {
                    bestMatch = mockWorkouts[Math.floor(Math.random() * mockWorkouts.length)];
                }

                const mockResponse = {
                    "title": bestMatch.title,
                    "totalDurationMinutes": bestMatch.duration,
                    "calories": bestMatch.calories,
                    "muscleGroups": bestMatch.muscles,
                    "type": bestMatch.type,
                    "phases": generateMockPhases(bestMatch)
                };

                return new Promise(resolve => {
                    setTimeout(() => {
                        resolve(JSON.stringify(mockResponse));
                    }, 1200);
                });
            }

            // --- AI Workout Generation & Execution ---
            async function generateWorkout(promptText, workoutType = 'Custom', startImmediately = true, btnToLoad = null) {
                if (!promptText) { return; } 
                showLoadingSpinner(btnToLoad, true);
                try {
                    const responseText = await callGeminiAPI(promptText, `Eres "GoatiFit AI"...`);
                    const routine = JSON.parse(responseText);
                    state.aiWorkout.routine = routine;
                    if (startImmediately) {
                        hideModal();
                        startAiWorkout();
                    } else {
                       startAiWorkout();
                    }
                } catch (error) {
                    console.error("Error al generar la rutina: ", error);
                } finally {
                    showLoadingSpinner(btnToLoad, false);
                }
            }

            function startAiWorkout() {
                if (!state.aiWorkout.routine) return;
                showScreen('workout');
                Object.assign(state.aiWorkout, { currentIndex: 0, isPaused: false });
                dom.workout.goatModeBtn.classList.toggle('goat-mode-active', state.aiWorkout.goatMode);
                dom.workout.title.textContent = state.aiWorkout.routine.title;
                runAiPhase(0);
                updatePlayPauseIcon();
            }
            
            function runAiPhase(index) {
                if (index >= state.aiWorkout.routine.phases.length) { finishAiWorkout(); return; }
                const phase = state.aiWorkout.routine.phases[index];
                state.aiWorkout.currentIndex = index;
                state.aiWorkout.currentPhase = phase.type;
                state.aiWorkout.phaseTimeLeft = phase.durationSeconds;
                updateUIForAiPhase(phase);
                if (state.aiWorkout.timerInterval) clearInterval(state.aiWorkout.timerInterval);
                state.aiWorkout.timerInterval = setInterval(updateAiTimer, 1000);
                playSound(phase.type === 'work' ? 'start' : 'next');

                if (state.aiWorkout.goatMode) {
                    let messageKey;
                    if (index === 0) messageKey = 'goat_coach_start';
                    else if (index === state.aiWorkout.routine.phases.length - 2) messageKey = 'goat_coach_end';
                    else if (phase.type === 'work') messageKey = 'goat_coach_during';
                    if (messageKey) showCoachMessage(translations[state.language][messageKey]);
                }
            }

            function updateUIForAiPhase(phase) {
                const lang = state.language;
                dom.workout.phaseLabel.textContent = translations[lang][`phase_${phase.type}`] || phase.phaseName;
                dom.workout.currentExercise.textContent = phase.exerciseName;
                const nextIndex = state.aiWorkout.currentIndex + 1;
                const nextPhaseData = state.aiWorkout.routine.phases[nextIndex];
                dom.workout.nextExercise.textContent = nextPhaseData ? `${translations[lang].next_exercise_prefix}: ${nextPhaseData.exerciseName || nextPhaseData.phaseName}` : translations[lang].last_exercise_text;
                const phaseType = phase.type || 'prep';
                dom.workout.timerRing.className = `z-10 text-center flex flex-col items-center justify-center w-[calc(100%-40px)] h-[calc(100%-40px)] rounded-full border-8 transition-colors duration-500 bg-dark phase-border-${phaseType}`;
                dom.workout.progressCircle.className = `timer-circle-progress phase-color-${phaseType}`;
                
                dom.workout.howToSteps.innerHTML = '';
                if(phase.howTo && phase.howTo.length > 0) {
                    phase.howTo.forEach(step => {
                        const li = document.createElement('li');
                        li.textContent = step;
                        dom.workout.howToSteps.appendChild(li);
                    });
                    dom.workout.howToContainer.classList.remove('hidden');
                } else {
                    dom.workout.howToContainer.classList.add('hidden');
                }
                updateAiTimerDisplay();
            }

            function updateAiTimer() {
                if (state.aiWorkout.isPaused) return;
                
                if (state.aiWorkout.phaseTimeLeft <= 0) {
                    nextAiPhase();
                } else {
                    state.aiWorkout.phaseTimeLeft--;
                }
                updateAiTimerDisplay();
            }

             function updateAiTimerDisplay() {
                const phaseDuration = state.aiWorkout.routine.phases[state.aiWorkout.currentIndex].durationSeconds;
                const progress = phaseDuration > 0 ? (state.aiWorkout.phaseTimeLeft / phaseDuration) : 0;
                dom.workout.progressCircle.style.strokeDashoffset = 283 * (1 - progress);
                const minutes = Math.floor(state.aiWorkout.phaseTimeLeft / 60);
                const seconds = state.aiWorkout.phaseTimeLeft % 60;
                dom.workout.timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            function nextAiPhase() { runAiPhase(state.aiWorkout.currentIndex + 1); }
            function prevAiPhase() { if (state.aiWorkout.currentIndex > 0) runAiPhase(state.aiWorkout.currentIndex - 1); }
            
            function finishAiWorkout() {
                clearInterval(state.aiWorkout.timerInterval);
                logWorkoutToHistory();
                playSound('finish');
                startEmotionalVisualizer();
            }

            function toggleAiPause() { state.aiWorkout.isPaused = !state.aiWorkout.isPaused; updatePlayPauseIcon(); }
            function updatePlayPauseIcon() { dom.workout.playPauseBtn.querySelector('i').className = state.aiWorkout.isPaused ? 'fas fa-play ml-1' : 'fas fa-pause'; }
            
            function startEmotionalVisualizer() {
                showScreen('emotional-visualizer');
                const container = dom.emotionalVisualizer.container;
                container.innerHTML = '';
                const colors = ['rgba(138, 79, 255, 0.5)', 'rgba(60, 179, 113, 0.5)', 'rgba(70, 130, 180, 0.5)'];
                for (let i = 0; i < 15; i++) {
                    const shape = document.createElement('div');
                    shape.style.position = 'absolute';
                    shape.style.width = `${Math.random() * 150 + 50}px`;
                    shape.style.height = shape.style.width;
                    shape.style.left = `${Math.random() * 100}%`;
                    shape.style.top = `${Math.random() * 100}%`;
                    shape.style.backgroundColor = colors[i % colors.length];
                    shape.style.borderRadius = '50%';
                    shape.style.animation = `emotional-visual-flow ${Math.random() * 10 + 10}s ease-in-out infinite alternate`;
                    shape.style.animationDelay = `${Math.random() * 5}s`;
                    container.appendChild(shape);
                }

                const lang = state.language;
                const quotes = [translations[lang].visualizer_quote_1, translations[lang].visualizer_quote_2, translations[lang].visualizer_quote_3, translations[lang].visualizer_quote_4];
                dom.emotionalVisualizer.quote.textContent = quotes[Math.floor(Math.random() * quotes.length)];
                setTimeout(() => { dom.emotionalVisualizer.quote.style.opacity = 1; }, 500);

                setTimeout(() => {
                    dom.emotionalVisualizer.quote.style.opacity = 0;
                    if (state.aiWorkout.goatMode) {
                        showCoachMessage(translations[lang].goat_coach_finish);
                    } else {
                        showScreen('dashboard');
                    }
                }, 5000);
            }
            
            // --- Modal System ---
            function showModal(contentHTML, options = {}) {
                const { isFullscreen = false, onOpen = null } = options;
                dom.modals.body.innerHTML = contentHTML;
                dom.modals.overlay.classList.toggle('modal-fullscreen', isFullscreen);
                dom.modals.overlay.classList.remove('hidden');
                setTimeout(() => dom.modals.contentWrapper.classList.remove('scale-95'), 10);
                
                dom.bottomNav.style.display = isFullscreen ? 'none' : 'block';

                if (onOpen && typeof onOpen === 'function') {
                    onOpen();
                }
            }
            function hideModal() {
                dom.modals.contentWrapper.classList.add('scale-95');
                setTimeout(() => {
                    dom.modals.overlay.classList.add('hidden');
                    dom.modals.overlay.classList.remove('modal-fullscreen');
                    if (state.currentScreen !== 'workout') {
                        dom.bottomNav.style.display = 'block';
                    }
                }, 300);
            }
            
            function showCoachMessage(message) {
                const lang = state.language;
                const html = `
                    <div class="text-center text-text-primary">
                        <div class="text-5xl mb-4">üêê</div>
                        <h2 class="text-2xl font-bold mb-2 text-primary">${translations[lang].coach_modal_title}</h2>
                        <p class="mb-6 text-lg">${message}</p>
                        <button class="btn-close-modal btn btn-primary px-8 py-2 font-bold">${translations[lang].coach_modal_close}</button>
                    </div>
                `;
                showModal(html, { onOpen: () => {
                    if (state.currentScreen !== 'workout') {
                         dom.modals.body.querySelector('.btn-close-modal').addEventListener('click', () => {
                            hideModal();
                            showScreen('dashboard');
                         });
                    }
                }});
                playSound('coach');
            }

            async function showOracle() {
                const today = new Date().toISOString().split('T')[0];
                if (state.userData.lastOracleDate === today) return;

                const lang = state.language;
                const messages = [
                    "Hoy prioriza movilidad. Tu cuerpo pide soltura.",
                    "Dormiste poco. Una caminata ligera puede ayudarte a recargar.",
                    "Est√°s progresando. No te aceleres. La constancia es m√°s poderosa que la intensidad.",
                ];
                const message = messages[Math.floor(Math.random() * messages.length)];
                
                const html = `
                    <div class="text-center">
                        <h2 class="text-2xl font-bold mb-4 text-primary">${translations[lang].oracle_title}</h2>
                        <p class="text-lg mb-6">${message}</p>
                        <button class="btn-close-modal btn btn-primary w-full p-3">${translations[lang].oracle_close}</button>
                    </div>
                `;
                showModal(html);
                state.userData.lastOracleDate = today;
                saveState();
            }

            // --- Data, Progress & History ---
            function logWorkoutToHistory() {
                if (!state.aiWorkout.routine) return;
                const today = new Date().toISOString().split('T')[0];
                state.progress.history.unshift({
                    date: today,
                    title: state.aiWorkout.routine.title,
                    duration: state.aiWorkout.routine.totalDurationMinutes,
                    calories: state.aiWorkout.routine.calories || (state.aiWorkout.routine.totalDurationMinutes * 8),
                    muscleGroups: state.aiWorkout.routine.muscleGroups || [],
                    goatMode: state.aiWorkout.goatMode
                });
                state.progress.points += 100;
                if (state.aiWorkout.goatMode) state.progress.points += 50;
                
                checkAchievements();
                saveState();
                updatePointsDisplay();
            }
            
            function updatePointsDisplay() {
                dom.dashboard.pointsValue.textContent = state.progress.points;
            }

            function checkAchievements() {
                if (!state.progress.achievements.first_workout) {
                    state.progress.achievements.first_workout = true;
                }
                if (state.aiWorkout.goatMode && !state.progress.achievements.goat_mode) {
                    state.progress.achievements.goat_mode = true;
                }
            }

            function renderProgressScreen() {
                calculateWeeklyStats();
                renderCircularStats();
                renderBodyMap();
                renderHistory();
                renderAchievements();
            }
            
            function calculateWeeklyStats() {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const recentWorkouts = state.progress.history.filter(w => new Date(w.date) >= oneWeekAgo);
                
                state.progress.weeklyStats.minutes = recentWorkouts.reduce((sum, w) => sum + w.duration, 0);
                state.progress.weeklyStats.workouts = recentWorkouts.length;
                state.progress.weeklyStats.calories = recentWorkouts.reduce((sum, w) => sum + w.calories, 0);
                state.progress.workedMuscles = [...new Set(recentWorkouts.flatMap(w => w.muscleGroups))];
            }
            
            function renderCircularStats() {
                const lang = state.language;
                createCircularProgressBar(dom.progress.minutesCircle, state.progress.weeklyStats.minutes, 210, translations[lang].progress_minutes);
                createCircularProgressBar(dom.progress.workoutsCircle, state.progress.weeklyStats.workouts, 5, translations[lang].progress_workouts);
                createCircularProgressBar(dom.progress.caloriesCircle, state.progress.weeklyStats.calories, 2500, translations[lang].progress_calories);
            }

            function createCircularProgressBar(container, value, target, label) {
                const percentage = Math.min((value / target) * 100, 100);
                const radius = 45;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (percentage / 100) * circumference;

                container.innerHTML = `
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-secondary" stroke-width="8" stroke="currentColor" fill="transparent" r="${radius}" cx="50" cy="50"/>
                        <circle class="text-primary timer-circle-progress transition-all duration-1000" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="${radius}" cx="50" cy="50" transform="rotate(-90 50 50)" style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${circumference};"/>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                        <span class="text-2xl font-black">${value}</span>
                        <span class="text-xs font-bold uppercase">${label}</span>
                    </div>
                `;
                setTimeout(() => { container.querySelector('.timer-circle-progress').style.strokeDashoffset = offset; }, 100);
            }
            
            function renderBodyMap() {
                 const worked = state.progress.workedMuscles;
                 const bodyParts = {
                    shoulders: { name: "Hombros", path: "M13.5,12 C11,11 9,13 9,15 L9,18 L7,18 C7,14 10,10 15,10 S23,14 23,18 L21,18 L21,15 C21,13 19,11 16.5,12", active: worked.includes('shoulders') },
                    chest: { name: "Pectorales", path: "M9,18 L21,18 L21,25 L15,28 L9,25 Z", active: worked.includes('chest') },
                    core: { name: "Core / Abdomen", path: "M9,25 L21,25 L21,34 L9,34 Z", active: worked.includes('core') },
                    biceps: { name: "Brazos", path: "M7,18 L9,18 L9,28 L7,28 Z M21,18 L23,18 L23,28 L21,28 Z", active: worked.includes('biceps') },
                    legs: { name: "Piernas", path: "M10,34 L14,34 L14,48 L10,48 Z M16,34 L20,34 L20,48 L16,48 Z", active: worked.includes('legs') || worked.includes('quads') || worked.includes('glutes') },
                 };
                 dom.progress.bodyMapContainer.innerHTML = `
                    <svg viewBox="0 0 30 60" class="w-full h-full">
                        <circle class="body-map-part" cx="15" cy="7" r="4" fill="var(--light)"/>
                        ${Object.values(bodyParts).map(p => `<g class="body-map-part"><title>${p.name}</title><path d="${p.path}" fill="${p.active ? 'var(--primary)' : 'var(--light)'}" class="transition-colors duration-500" /></g>`).join('')}
                    </svg>
                 `;
            }

            function renderHistory() {
                dom.progress.historyList.innerHTML = '';
                if(state.progress.history.length === 0) {
                    dom.progress.historyList.innerHTML = `<p class="text-text-secondary text-center">${translations[state.language].mission_placeholder}</p>`;
                    return;
                }
                state.progress.history.forEach(workout => {
                    const el = document.createElement('div');
                    el.className = 'bg-secondary p-3 rounded-lg flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <p class="font-bold">${workout.title}</p>
                            <p class="text-sm text-text-secondary">${new Date(workout.date).toLocaleDateString(state.language, { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                        </div>
                        <div class="text-right">
                             <p class="font-bold text-primary">${workout.duration} min / ${workout.calories} kcal</p>
                             ${workout.goatMode ? '<i class="fas fa-skull-crossbones text-danger"></i>' : ''}
                        </div>
                    `;
                    dom.progress.historyList.appendChild(el);
                });
            }
            
            function renderAchievements() {
                dom.progress.achievementsGrid.innerHTML = '';
                const lang = state.language;
                const achievementDefs = {
                    first_workout: { icon: 'fa-shoe-prints', name: translations[lang].achievement_first_workout_name, desc: translations[lang].achievement_first_workout_desc },
                    seven_day_streak: { icon: 'fa-fire', name: translations[lang].achievement_seven_day_streak_name, desc: translations[lang].achievement_seven_day_streak_desc },
                    goat_mode: { icon: 'fa-skull-crossbones', name: translations[lang].achievement_goat_mode_name, desc: translations[lang].achievement_goat_mode_desc },
                    perfect_week: { icon: 'fa-calendar-check', name: translations[lang].achievement_perfect_week_name, desc: translations[lang].achievement_perfect_week_desc },
                };
                for(const key in state.progress.achievements) {
                    const unlocked = state.progress.achievements[key];
                    const def = achievementDefs[key];
                    const el = document.createElement('div');
                    el.className = `p-2 rounded-lg transition-all ${unlocked ? 'bg-primary text-white' : 'bg-secondary text-text-secondary opacity-50'}`;
                    el.title = def.desc;
                    el.innerHTML = `<i class="fas ${def.icon} text-3xl"></i><p class="text-xs mt-1 font-bold">${def.name}</p>`;
                    dom.progress.achievementsGrid.appendChild(el);
                }
            }
            
            function renderSettingsScreen() {
                dom.settings.inputWeight.value = state.userData.weight || '';
                dom.settings.inputHeight.value = state.userData.height || '';
                dom.settings.inputGender.value = state.userData.gender || 'male';
                renderAlarms();
            }

            // --- Local Storage ---
            function saveState() {
                const stateToSave = {
                    theme: state.theme,
                    progress: state.progress,
                    userData: state.userData,
                    alarms: state.alarms,
                    offlineCustomRoutines: state.offlineRoutines.custom,
                };
                localStorage.setItem('goatiFitState_v4', JSON.stringify(stateToSave));
            }
            function loadState() {
                const savedState = localStorage.getItem('goatiFitState_v4');
                if (savedState) {
                    const parsed = JSON.parse(savedState);
                    state.theme = parsed.theme || 'dark';
                    state.progress = { ...state.progress, ...parsed.progress };
                    state.userData = { ...state.userData, ...parsed.userData };
                    state.alarms = parsed.alarms || [];
                    state.offlineRoutines.custom = parsed.offlineCustomRoutines || [];
                }
                 // Always load full default offline routines from code
                state.offlineRoutines.defaults = mockWorkouts.map(w => ({...w, phases: generateMockPhases(w)}));
            }

            // --- Modal Content & Logic ---
            const modalContent = {
                sleep: (lang) => `
                    <h2 class="text-2xl font-bold mb-4 text-primary">${translations[lang].sleep_modal_title}</h2>
                    <p class="text-text-secondary mb-6">${translations[lang].sleep_desc}</p>
                    <div class="flex justify-center gap-4 mb-4">
                        <button class="sleep-sound-btn btn btn-secondary p-4 rounded-lg active" data-sound="brown" title="Ruido Marr√≥n"><i class="fas fa-wind text-2xl"></i></button>
                        <button class="sleep-sound-btn btn btn-secondary p-4 rounded-lg" data-sound="rain" title="Lluvia"><i class="fas fa-cloud-rain text-2xl"></i></button>
                        <button class="sleep-sound-btn btn btn-secondary p-4 rounded-lg" data-sound="forest" title="Bosque"><i class="fas fa-tree text-2xl"></i></button>
                    </div>
                    <input type="range" id="sleep-timer-slider" min="0" max="60" value="0" class="w-full mb-2">
                    <p class="text-white mb-4"><span data-translate-key="sleep_timer_label">${translations[lang].sleep_timer_label}</span>: <span id="sleep-timer-value">Off</span></p>
                    <button id="toggle-sleep-sound-btn" class="btn btn-primary w-full p-4 rounded-full font-bold">
                        <i class="fas fa-play mr-2"></i><span>${translations[lang].sleep_start_button}</span>
                    </button>`,
                supplements: (lang) => `
                    <h2 class="text-2xl font-bold mb-4 text-primary">${translations[lang].supplements_title}</h2>
                    <div class="space-y-4 text-left">
                        <p>Responde para obtener una recomendaci√≥n de la IA:</p>
                        <div>
                            <label class="font-bold">¬øCu√°l es tu objetivo principal?</label>
                            <select id="supp-goal" class="w-full mt-1">
                                <option value="m√∫sculo">Ganar M√∫sculo</option>
                                <option value="energ√≠a">M√°s Energ√≠a</option>
                                <option value="recuperaci√≥n">Mejorar Recuperaci√≥n</option>
                            </select>
                        </div>
                        <button id="get-supp-rec-btn" class="btn btn-primary w-full p-3">Obtener Recomendaci√≥n</button>
                        <div id="supp-result" class="mt-4 p-4 bg-secondary rounded-lg hidden"></div>
                    </div>`,
                ice: (lang) => `
                    <h2 class="text-2xl font-bold mb-4 text-primary">${translations[lang].ice_therapy_title}</h2>
                    <p class="text-text-secondary mb-4">${translations[lang].ice_therapy_desc}</p>
                    <p id="ice-guide-text" class="text-lg font-bold mb-4 h-8">Prep√°rate...</p>
                    <div id="ice-timer-display" class="text-6xl font-black mb-4">00:30</div>
                    <button id="start-ice-timer-btn" class="btn btn-ice w-full p-3 font-bold">${translations[lang].ice_therapy_start_timer}</button>`,
                shadow: (lang) => `
                    <h2 class="text-2xl font-bold mb-4 text-warning">${translations[lang].shadow_tracker_title}</h2>
                    <div id="shadow-questions" class="space-y-4 text-left">
                        ${['trained', 'nutrition', 'sleep', 'emotion', 'screens', 'stress'].map(q => `<div class="flex justify-between items-center"><label>${translations[lang][`shadow_q_${q}`]}</label><div class="flex gap-2" data-question="${q}"><button class="shadow-answer-btn btn btn-secondary px-4 py-1" data-answer="yes">S√≠</button><button class="shadow-answer-btn btn btn-secondary px-4 py-1" data-answer="no">No</button></div></div>`).join('')}
                    </div>
                    <button id="analyze-shadow-btn" class="btn btn-primary w-full p-3 mt-6">${translations[lang].shadow_analyze_button}</button>
                    <div id="shadow-analysis-result" class="mt-4 text-sm text-text-secondary"></div>`,
                alarms: (lang) => `
                    <h2 class="text-2xl font-bold mb-4 text-primary">${translations[lang].alarm_modal_title}</h2>
                    <div class="space-y-4">
                        <input type="text" id="alarm-name-input" class="w-full" placeholder="${translations[lang].alarm_name_placeholder}">
                        <input type="time" id="alarm-time-input" class="w-full">
                        <div class="text-center"><label>${translations[lang].alarm_days}</label><div class="flex justify-center gap-1 mt-2">${['L','M','X','J','V','S','D'].map(d => `<button class="day-toggle btn btn-secondary rounded-full w-8 h-8 text-xs">${d}</button>`).join('')}</div></div>
                        <button id="save-alarm-btn" class="btn btn-primary w-full p-3">${translations[lang].save_button}</button>
                    </div>`,
                mobility: (lang) => `
                    <h2 class="text-2xl font-bold mb-4 text-primary">${translations[lang].mobility_modal_title}</h2>
                    <p class="text-text-secondary mb-6">${translations[lang].mobility_modal_desc}</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button class="mobility-gen-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center" data-moment="morning"><i class="fas fa-sun text-3xl mb-2 text-warning"></i><span class="font-bold">${translations[lang].mobility_morning}</span></button>
                        <button class="mobility-gen-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center" data-moment="break"><i class="fas fa-mug-hot text-3xl mb-2 text-info"></i><span class="font-bold">${translations[lang].mobility_break}</span></button>
                        <button class="mobility-gen-btn btn btn-secondary p-4 rounded-lg flex flex-col items-center" data-moment="night"><i class="fas fa-moon text-3xl mb-2 text-primary"></i><span class="font-bold">${translations[lang].mobility_night}</span></button>
                    </div>`,
                breathing: (lang) => `
                    <h2 class="text-2xl font-bold mb-4 text-primary">${translations[lang].breathing_modal_title}</h2>
                    <div class="flex justify-center gap-4 mb-4">
                        <button class="breathing-mode-btn btn btn-secondary active" data-mode="calm">${translations[lang].breathing_mode_calm}</button>
                        <button class="breathing-mode-btn btn btn-secondary" data-mode="energy">${translations[lang].breathing_mode_energy}</button>
                    </div>
                    <div class="relative w-48 h-48 mx-auto my-4 flex items-center justify-center">
                        <div id="breathing-circle-animator" class="absolute w-full h-full bg-info/30 rounded-full" style="transition: transform 4s ease-in-out, background-color 4s ease-in-out;"></div>
                        <i class="fas fa-lungs text-5xl text-white z-10"></i>
                    </div>
                    <p id="breathing-instruction" class="text-xl font-bold h-8 text-center">Elige un modo y presiona Iniciar</p>
                    <button id="start-breathing-btn" class="btn btn-primary mt-4 px-6 py-2"><i class="fas fa-play mr-2"></i><span>${translations[lang].start_button}</span></button>`,
                offline: (lang) => `
                    <h2 class="text-2xl font-bold mb-4 text-primary">${translations[lang].settings_offline_title}</h2>
                    <p class="text-text-secondary mb-6">${translations[lang].settings_offline_desc}</p>
                    <button id="create-offline-routine-btn" class="btn btn-primary w-full p-3 mb-4">${translations[lang].create_offline_routine}</button>
                    <div id="offline-routines-list" class="space-y-3"></div>`,
                stopwatch: (lang) => `
                    <div class="flex flex-col items-center justify-center h-full w-full">
                        <h2 class="text-2xl font-bold mb-4 text-primary">${translations[lang].tool_stopwatch}</h2>
                        <div class="gigantic-timer" id="manual-timer-display">00:00<span class="milliseconds">.00</span></div>
                        <div id="laps-container" class="w-full max-w-xs text-sm mt-4 max-h-48 overflow-y-auto custom-scrollbar"></div>
                        <div class="w-full flex justify-center items-center gap-4 mt-8">
                            <button id="manual-timer-secondary-btn" class="btn btn-secondary p-4 rounded-full w-24 h-24 text-xl font-bold" disabled><span>${translations[lang].reset_button}</span></button>
                            <button id="manual-timer-primary-btn" class="btn btn-primary btn-glow p-4 rounded-full w-24 h-24 text-xl font-bold"><span>${translations[lang].start_button}</span></button>
                        </div>
                    </div>`,
                timer: (lang) => `
                    <div class="flex flex-col items-center justify-center h-full w-full">
                        <h2 class="text-2xl font-bold mb-4 text-primary">${translations[lang].tool_timer}</h2>
                        <div id="timer-input-container" class="flex items-center justify-center gap-2">
                            <button class="time-adjust-btn btn btn-secondary" data-unit="minutes" data-amount="-1"><i class="fas fa-minus"></i></button>
                            <input type="number" id="timer-minutes-input" class="w-24 text-center text-5xl bg-transparent border-b-2" min="0" max="99" value="10">
                            <button class="time-adjust-btn btn btn-secondary" data-unit="minutes" data-amount="1"><i class="fas fa-plus"></i></button>
                            <span class="text-5xl">:</span>
                            <button class="time-adjust-btn btn btn-secondary" data-unit="seconds" data-amount="-1"><i class="fas fa-minus"></i></button>
                            <input type="number" id="timer-seconds-input" class="w-24 text-center text-5xl bg-transparent border-b-2" min="0" max="59" value="0">
                            <button class="time-adjust-btn btn btn-secondary" data-unit="seconds" data-amount="1"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="gigantic-timer hidden" id="manual-timer-display">10:00</div>
                        <div class="w-full flex justify-center items-center gap-4 mt-8">
                            <button id="manual-timer-secondary-btn" class="btn btn-secondary p-4 rounded-full w-24 h-24 text-xl font-bold" disabled><span>${translations[lang].reset_button}</span></button>
                            <button id="manual-timer-primary-btn" class="btn btn-primary btn-glow p-4 rounded-full w-24 h-24 text-xl font-bold"><span>${translations[lang].start_button}</span></button>
                        </div>
                    </div>`,
                tabata: (lang) => `
                     <div class="flex flex-col items-center justify-center h-full w-full">
                        <h2 class="text-2xl font-bold mb-4 text-primary">${translations[lang].tool_tabata}</h2>
                        <div id="tabata-setup" class="space-y-4 mb-4">
                            <div><label>Work (s):</label> <input type="number" id="tabata-work" value="20" class="w-20 text-center"></div>
                            <div><label>Rest (s):</label> <input type="number" id="tabata-rest" value="10" class="w-20 text-center"></div>
                            <div><label>Rounds:</label> <input type="number" id="tabata-rounds" value="8" class="w-20 text-center"></div>
                        </div>
                        <div id="tabata-display" class="hidden text-center">
                            <p id="tabata-phase-label" class="text-3xl font-bold uppercase"></p>
                            <div class="gigantic-timer" id="manual-timer-display">00:20</div>
                             <p id="tabata-round-counter" class="text-xl">Round 1 / 8</p>
                        </div>
                        <div class="w-full flex justify-center items-center gap-4 mt-8">
                             <button id="manual-timer-secondary-btn" class="btn btn-secondary p-4 rounded-full w-24 h-24 text-xl font-bold" disabled><span>${translations[lang].reset_button}</span></button>
                            <button id="manual-timer-primary-btn" class="btn btn-primary btn-glow p-4 rounded-full w-24 h-24 text-xl font-bold"><span>${translations[lang].start_button}</span></button>
                        </div>
                    </div>`,
                 rounds: (lang) => `
                     <div class="flex flex-col items-center justify-center h-full w-full">
                        <h2 class="text-2xl font-bold mb-4 text-primary">${translations[lang].tool_rounds}</h2>
                        <div id="rounds-setup" class="space-y-4 mb-4">
                            <div><label>Rounds:</label> <input type="number" id="rounds-count" value="5" class="w-20 text-center"></div>
                            <div><label>Time/Round (m:s):</label> <input type="number" id="rounds-minutes" value="3" class="w-16 text-center">:<input type="number" id="rounds-seconds" value="00" class="w-16 text-center"></div>
                        </div>
                        <div id="rounds-display" class="hidden text-center">
                            <p id="rounds-phase-label" class="text-3xl font-bold uppercase">ROUND 1</p>
                            <div class="gigantic-timer" id="manual-timer-display">03:00</div>
                        </div>
                        <div class="w-full flex justify-center items-center gap-4 mt-8">
                             <button id="manual-timer-secondary-btn" class="btn btn-secondary p-4 rounded-full w-24 h-24 text-xl font-bold" disabled><span>${translations[lang].reset_button}</span></button>
                            <button id="manual-timer-primary-btn" class="btn btn-primary btn-glow p-4 rounded-full w-24 h-24 text-xl font-bold"><span>${translations[lang].start_button}</span></button>
                        </div>
                    </div>`,
                sexual: (lang) => `
                    <h2 class="text-2xl font-bold mb-4 text-primary">${translations[lang].sexual_wellness_title}</h2>
                    <p class="text-text-secondary mb-6">${translations[lang].sexual_wellness_desc}</p>
                    
                    <div class="glassmorphism p-4 rounded-lg mb-4">
                         <div class="flex justify-between items-center mb-2">
                            <label class="font-bold">${translations[lang].sexual_activity_label}</label>
                            <div class="flex gap-2">
                                <button class="sexual-log-btn btn btn-secondary px-4 py-1" data-type="activity" data-value="true">${translations[lang].yes}</button>
                                <button class="sexual-log-btn btn btn-secondary px-4 py-1 active" data-type="activity" data-value="false">${translations[lang].no}</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="font-bold">${translations[lang].sexual_desire_label}</label>
                            <input type="range" id="desire-slider" min="1" max="5" value="3" class="w-1/2">
                        </div>
                    </div>
                    
                    <div id="female-cycle-container" class="glassmorphism p-4 rounded-lg mb-6 ${state.userData.gender === 'female' ? '' : 'hidden'}">
                        <h3 class="font-bold text-lg mb-2">${translations[lang].female_cycle_title}</h3>
                        <p class="text-sm text-text-secondary mb-3">${translations[lang].female_cycle_desc}</p>
                        <div class="space-y-3">
                            <div>
                                <label for="last-period-date" class="font-bold">${translations[lang].last_period_date}</label>
                                <input type="date" id="last-period-date" class="w-full mt-1">
                            </div>
                            <div>
                                <label for="cycle-length" class="font-bold">${translations[lang].cycle_length}</label>
                                <input type="number" id="cycle-length" value="28" class="w-full mt-1">
                            </div>
                        </div>
                        <div id="cycle-info" class="mt-4 text-sm space-y-1"></div>
                    </div>

                    <button id="analyze-wellness-btn" class="btn btn-primary w-full p-3">${translations[lang].analyze_wellness_button}</button>
                `,
                analysis: (lang, content) => `
                    <h2 class="text-2xl font-bold mb-4 text-primary">${translations[lang].analysis_modal_title}</h2>
                    <div class="text-text-primary text-left">${content}</div>
                `
            };

            function toggleBreathingExercise(btn) {
                const lang = state.language;
                const icon = btn.querySelector('i');
                const text = btn.querySelector('span');
                const instructionEl = dom.modals.body.querySelector('#breathing-instruction');
                const circleEl = dom.modals.body.querySelector('#breathing-circle-animator');

                const stopBreathing = () => {
                    state.breathing.isRunning = false;
                    state.breathing.timeouts.forEach(clearTimeout);
                    state.breathing.timeouts = [];
                    if(state.breathing.interval) clearInterval(state.breathing.interval);
                    icon.className = 'fas fa-play mr-2';
                    text.textContent = translations[lang].start_button;
                    circleEl.style.transform = 'scale(1)';
                    circleEl.style.backgroundColor = 'rgba(59, 130, 246, 0.3)';
                    circleEl.style.transitionDuration = '2s';
                };

                if (state.breathing.isRunning) {
                    stopBreathing();
                    instructionEl.textContent = 'Pausado';
                } else {
                    state.breathing.isRunning = true;
                    icon.className = 'fas fa-stop mr-2';
                    text.textContent = translations[lang].stop_button;
                    
                    const mode = state.breathing.mode;
                    let cycle;

                    if (mode === 'calm') {
                        circleEl.style.transitionDuration = '4s';
                        cycle = () => {
                            if (!state.breathing.isRunning) return;
                            instructionEl.textContent = translations[lang].breathing_instruction_in;
                            circleEl.style.transform = 'scale(2.0)';
                            circleEl.style.backgroundColor = 'rgba(138, 79, 255, 0.5)';
                            playSound('tick', 300);
                            state.breathing.timeouts.push(setTimeout(() => {
                                if (!state.breathing.isRunning) return;
                                instructionEl.textContent = translations[lang].breathing_instruction_hold;
                                playSound('tick', 400);
                                state.breathing.timeouts.push(setTimeout(() => {
                                    if (!state.breathing.isRunning) return;
                                    instructionEl.textContent = translations[lang].breathing_instruction_out;
                                    circleEl.style.transform = 'scale(1)';
                                    circleEl.style.backgroundColor = 'rgba(59, 130, 246, 0.3)';
                                    playSound('tick', 200);
                                }, 7000));
                            }, 4000));
                        };
                    } else { // energy mode
                         circleEl.style.transitionDuration = '0.5s';
                         cycle = () => {
                            if (!state.breathing.isRunning) return;
                            instructionEl.textContent = translations[lang].breathing_instruction_fast_in_out;
                            circleEl.style.transform = 'scale(2.0)';
                            circleEl.style.backgroundColor = 'rgba(239, 68, 68, 0.5)';
                            playSound('tick', 600);
                            state.breathing.timeouts.push(setTimeout(() => {
                                if (!state.breathing.isRunning) return;
                                circleEl.style.transform = 'scale(1)';
                                circleEl.style.backgroundColor = 'rgba(59, 130, 246, 0.3)';
                                playSound('tick', 500);
                            }, 500));
                         };
                    }

                    cycle();
                    const cycleTime = mode === 'calm' ? 19000 : 1000;
                    state.breathing.interval = setInterval(cycle, cycleTime);
                    
                    // Stop after 2 minutes
                    state.breathing.timeouts.push(setTimeout(() => {
                        if (state.breathing.isRunning) {
                            stopBreathing();
                            instructionEl.textContent = translations[lang].breathing_session_complete;
                            playSound('finish');
                        }
                    }, 120000));
                }
            }
            
            // --- EVENT LISTENERS ---
            document.body.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;

                const id = btn.id;
                
                if (id === 'generate-btn') generateWorkout(dom.dashboard.userPrompt.value, 'Custom', true, btn);
                if (id === 'generate-partner-btn') generateWorkout(dom.partner.prompt.value, 'D√∫o', true, btn);
                
                if (btn.classList.contains('bottom-nav-item')) showScreen(btn.dataset.screen);
                if (btn.classList.contains('back-to-dashboard-btn')) showScreen('dashboard');
                if (id === 'open-lab-btn') showScreen('lab');
                if (id === 'open-partner-btn') showScreen('partner-workout');

                if (id === 'exit-workout-btn') { clearInterval(state.aiWorkout.timerInterval); showScreen('dashboard'); }
                if (id === 'play-pause-btn') toggleAiPause();
                if (id === 'next-btn') nextAiPhase();
                if (id === 'prev-btn') prevAiPhase();
                if (id === 'goat-mode-btn') {
                    state.aiWorkout.goatMode = !state.aiWorkout.goatMode;
                    btn.classList.toggle('goat-mode-active', state.aiWorkout.goatMode);
                }

                if (id === 'save-data-btn') {
                    state.userData.weight = dom.settings.inputWeight.value || null;
                    state.userData.height = dom.settings.inputHeight.value || null;
                    state.userData.gender = dom.settings.inputGender.value || 'male';
                    saveState();
                    renderSettingsScreen();
                }
                
                if (id === 'add-alarm-btn') showModal(modalContent.alarms(state.language));
                if (id === 'offline-access-btn') { showModal(modalContent.offline(state.language)); renderOfflineRoutines(); }

                if (btn.classList.contains('wellness-btn')) {
                    const modalType = btn.dataset.modal;
                    if (modalType === 'stress') {
                        generateWorkout(translations[state.language].stress_mode_desc, 'Anti-Estr√©s', true, btn);
                    } else if (modalContent[modalType]) {
                        showModal(modalContent[modalType](state.language));
                    }
                }
                
                if (id === 'close-modal-btn' || btn.classList.contains('btn-close-modal')) {
                    if (state.manualTimer.isRunning) {
                        clearInterval(state.manualTimer.interval);
                        state.manualTimer.isRunning = false;
                    }
                    if (state.breathing.isRunning) {
                         toggleBreathingExercise(dom.modals.body.querySelector('#start-breathing-btn'));
                    }
                    hideModal();
                }

                if (btn.classList.contains('timer-type-btn')) { 
                    state.manualTimer.type = btn.dataset.type;
                    showModal(modalContent[state.manualTimer.type](state.language), { isFullscreen: true }); 
                }
                if (btn.classList.contains('challenge-btn')) {
                    const challenge = btn.dataset.challenge;
                    if (challengeWorkouts[challenge]) {
                        state.aiWorkout.routine = challengeWorkouts[challenge];
                        startAiWorkout();
                    }
                }
                if (id === 'analyze-history-btn') { analyzeHistory(btn); }
            });

            dom.modals.overlay.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;

                if (btn.id === 'toggle-sleep-sound-btn') toggleSleepSound();
                if (btn.classList.contains('sleep-sound-btn')) {
                    dom.modals.body.querySelectorAll('.sleep-sound-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.sleep.selectedSound = btn.dataset.sound;
                }
                if (btn.id === 'start-ice-timer-btn') startIceTimer(btn);
                if (btn.id === 'save-alarm-btn') saveAlarm();
                if (btn.classList.contains('day-toggle')) btn.classList.toggle('active');
                if (btn.classList.contains('mobility-gen-btn')) {
                    const moment = btn.dataset.moment;
                    const prompt = `una rutina de movilidad de 5 minutos para ${moment}`;
                    generateWorkout(prompt, `Movilidad ${moment}`, true, btn);
                }
                if (btn.id === 'start-breathing-btn') { toggleBreathingExercise(btn); }
                if (btn.classList.contains('breathing-mode-btn')) {
                    if (state.breathing.isRunning) return;
                    dom.modals.body.querySelectorAll('.breathing-mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.breathing.mode = btn.dataset.mode;
                }
                 if (btn.classList.contains('shadow-answer-btn')) {
                    const question = btn.parentElement.dataset.question;
                    btn.parentElement.querySelectorAll('.shadow-answer-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                }
                if(btn.id === 'analyze-shadow-btn') { analyzeShadowLog(); }
                if(btn.classList.contains('offline-routine-btn')) {
                    const index = parseInt(btn.dataset.index, 10);
                    const type = btn.dataset.type;
                    state.aiWorkout.routine = state.offlineRoutines[type][index];
                    hideModal();
                    startAiWorkout();
                }
                if(btn.id === 'manual-timer-primary-btn') { handleManualTimerPrimaryClick(); }
                if(btn.id === 'manual-timer-secondary-btn') { handleManualTimerSecondaryClick(); }
                if(btn.classList.contains('time-adjust-btn')) {
                    const unit = btn.dataset.unit;
                    const amount = parseInt(btn.dataset.amount, 10);
                    const input = dom.modals.body.querySelector(`#timer-${unit}-input`);
                    let currentValue = parseInt(input.value, 10);
                    currentValue = Math.max(0, Math.min(unit === 'seconds' ? 59 : 99, currentValue + amount));
                    input.value = currentValue;
                }
                if(btn.classList.contains('sexual-log-btn')) {
                    const type = btn.dataset.type;
                    const value = btn.dataset.value === 'true';
                    state.userData.sexualLog[type] = value;
                    btn.parentElement.querySelectorAll('.sexual-log-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    saveState();
                }
                 if(btn.id === 'get-supp-rec-btn') { getSupplementRec(btn); }
                 if(btn.id === 'analyze-wellness-btn') { analyzeWellness(btn); }
                 if(btn.id === 'create-offline-routine-btn') { showOfflineCreator(); }
            });

            dom.modals.overlay.addEventListener('input', (e) => {
                if (e.target.id === 'sleep-timer-slider') {
                    const slider = e.target;
                    const valueDisplay = dom.modals.body.querySelector('#sleep-timer-value');
                    if(valueDisplay) { valueDisplay.textContent = slider.value > 0 ? `${slider.value} min` : 'Off'; }
                }
                 if (e.target.id === 'desire-slider') {
                    state.userData.sexualLog.desire = e.target.value;
                    saveState();
                }
                 if (e.target.id === 'last-period-date' || e.target.id === 'cycle-length') {
                    state.userData.menstrual.lastPeriodDate = dom.modals.body.querySelector('#last-period-date').value;
                    state.userData.menstrual.cycleLength = dom.modals.body.querySelector('#cycle-length').value || 28;
                    renderCycleInfo();
                    saveState();
                }
            });

            dom.languageSelect.addEventListener('change', (e) => setLanguage(e.target.value));
            dom.settings.inputGender.addEventListener('change', (e) => {
                state.userData.gender = e.target.value;
            });

            function showLoadingSpinner(btn, isLoading) {
                if (!btn) return;
                if (isLoading) {
                    btn.disabled = true;
                    btn.dataset.originalHtml = btn.innerHTML;
                    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
                } else {
                    btn.disabled = false;
                    if(btn.dataset.originalHtml) btn.innerHTML = btn.dataset.originalHtml;
                }
            }
            
            function renderAlarms() {
                dom.settings.alarmsList.innerHTML = state.alarms.map((alarm, index) => `
                    <div class="bg-secondary p-3 rounded-lg flex justify-between items-center">
                        <div>
                            <p class="font-bold">${alarm.name}</p>
                            <p class="text-sm text-text-secondary">${alarm.time} - ${alarm.days.join(', ')}</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" data-alarm-index="${index}" ${alarm.enabled ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </div>
                `).join('');
            }

            // --- MANUAL TIMERS LOGIC ---
            function formatTime(ms) {
                const totalSeconds = Math.floor(ms / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                const milliseconds = Math.floor((ms % 1000) / 10);
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}<span class="milliseconds">.${String(milliseconds).padStart(2, '0')}</span>`;
            }
            function formatSeconds(s) {
                const minutes = Math.floor(s / 60);
                const seconds = s % 60;
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            function handleManualTimerPrimaryClick() {
                const timer = state.manualTimer;
                const primaryBtn = dom.modals.body.querySelector('#manual-timer-primary-btn span');
                const secondaryBtn = dom.modals.body.querySelector('#manual-timer-secondary-btn');
                const lang = state.language;

                if (timer.isRunning) { // Pause
                    timer.isRunning = false;
                    clearInterval(timer.interval);
                    primaryBtn.textContent = translations[lang].resume_button;
                    secondaryBtn.querySelector('span').textContent = translations[lang].reset_button;
                    secondaryBtn.disabled = false;
                } else { // Start or Resume
                    if (timer.timeRemaining <= 0 || timer.totalTime === 0) { // Fresh start
                        if (timer.type === 'timer') {
                            const mins = parseInt(dom.modals.body.querySelector('#timer-minutes-input').value) || 0;
                            const secs = parseInt(dom.modals.body.querySelector('#timer-seconds-input').value) || 0;
                            timer.totalTime = (mins * 60 + secs) * 1000;
                            if (timer.totalTime <= 0) return;
                            timer.timeRemaining = timer.totalTime;
                            dom.modals.body.querySelector('#timer-input-container').classList.add('hidden');
                            dom.modals.body.querySelector('#manual-timer-display').classList.remove('hidden');
                        } else if (timer.type === 'tabata' || timer.type === 'rounds') {
                            setupComplexTimer();
                        } else if (timer.type === 'stopwatch') {
                            timer.totalTime = Infinity;
                            timer.timeRemaining = 0;
                        }
                    }
                    
                    timer.isRunning = true;
                    timer.startTime = Date.now() - (timer.type === 'stopwatch' ? timer.timeRemaining : (timer.totalTime - timer.timeRemaining));
                    
                    updateManualTimer(); 
                    timer.interval = setInterval(updateManualTimer, timer.type === 'stopwatch' ? 10 : 1000);
                    
                    primaryBtn.textContent = translations[lang].pause_button;
                    secondaryBtn.disabled = false;
                    if (timer.type === 'stopwatch') {
                        secondaryBtn.querySelector('span').textContent = translations[lang].lap_button;
                    } else {
                        secondaryBtn.querySelector('span').textContent = translations[lang].reset_button;
                    }
                }
            }

            function handleManualTimerSecondaryClick() {
                const timer = state.manualTimer;
                const lang = state.language;
                if (timer.isRunning && timer.type === 'stopwatch') { // Lap
                    const lapTime = Date.now() - timer.startTime;
                    timer.lapTimes.unshift(lapTime);
                    const lapsContainer = dom.modals.body.querySelector('#laps-container');
                    lapsContainer.innerHTML = timer.lapTimes.map((lap, i) => `<div class="flex justify-between p-1 border-b border-gray-700"><span>Lap ${timer.lapTimes.length - i}</span><span>${formatTime(lap)}</span></div>`).join('');
                } else { // Reset
                    clearInterval(timer.interval);
                    Object.assign(timer, { isRunning: false, timeRemaining: 0, totalTime: 0, lapTimes: [], currentPhase: 'work', currentRound: 1 });
                    
                    const display = dom.modals.body.querySelector('#manual-timer-display');
                    if (timer.type === 'stopwatch') {
                        display.innerHTML = formatTime(0);
                        dom.modals.body.querySelector('#laps-container').innerHTML = '';
                    } else {
                        display.innerHTML = formatSeconds(0);
                    }
                    
                    if (timer.type === 'timer') {
                        dom.modals.body.querySelector('#timer-input-container').classList.remove('hidden');
                        display.classList.add('hidden');
                    } else if (timer.type === 'tabata' || timer.type === 'rounds') {
                        dom.modals.body.querySelector(`#${timer.type}-setup`).classList.remove('hidden');
                        dom.modals.body.querySelector(`#${timer.type}-display`).classList.add('hidden');
                    }
                    dom.modals.body.querySelector('#manual-timer-primary-btn span').textContent = translations[lang].start_button;
                    dom.modals.body.querySelector('#manual-timer-secondary-btn').disabled = true;
                }
            }
            
            function updateManualTimer() {
                const timer = state.manualTimer;
                const display = dom.modals.body.querySelector('#manual-timer-display');
                if (!display) {
                    clearInterval(timer.interval);
                    return;
                }
                if (timer.type === 'stopwatch') {
                    const elapsedTime = Date.now() - timer.startTime;
                    timer.timeRemaining = elapsedTime;
                    display.innerHTML = formatTime(elapsedTime);
                } else { 
                    const elapsedTime = Date.now() - timer.startTime;
                    timer.timeRemaining = timer.totalTime - elapsedTime;
                    if (timer.timeRemaining <= 0) {
                        timer.timeRemaining = 0;
                        display.innerHTML = formatSeconds(0);
                        clearInterval(timer.interval);
                        timer.isRunning = false;
                        playSound('finish');
                        if (timer.type === 'tabata' || timer.type === 'rounds') {
                            advanceComplexTimer();
                        } else {
                             dom.modals.body.querySelector('#manual-timer-primary-btn span').textContent = translations.es.start_button;
                        }
                    } else {
                       display.innerHTML = formatSeconds(Math.ceil(timer.timeRemaining / 1000));
                    }
                }
            }

            function setupComplexTimer() {
                const timer = state.manualTimer;
                const setupEl = dom.modals.body.querySelector(`#${timer.type}-setup`);
                const displayEl = dom.modals.body.querySelector(`#${timer.type}-display`);
                setupEl.classList.add('hidden');
                displayEl.classList.remove('hidden');

                if(timer.type === 'tabata') {
                    timer.settings = {
                        work: parseInt(dom.modals.body.querySelector('#tabata-work').value) || 20,
                        rest: parseInt(dom.modals.body.querySelector('#tabata-rest').value) || 10,
                        rounds: parseInt(dom.modals.body.querySelector('#tabata-rounds').value) || 8,
                    };
                    timer.totalTime = timer.settings.work * 1000;
                    dom.modals.body.querySelector('#tabata-phase-label').textContent = 'WORK';
                    dom.modals.body.querySelector('#tabata-round-counter').textContent = `Round ${timer.currentRound} / ${timer.settings.rounds}`;
                } else if (timer.type === 'rounds') {
                     timer.settings = {
                        minutes: parseInt(dom.modals.body.querySelector('#rounds-minutes').value) || 3,
                        seconds: parseInt(dom.modals.body.querySelector('#rounds-seconds').value) || 0,
                        count: parseInt(dom.modals.body.querySelector('#rounds-count').value) || 5,
                    };
                    timer.totalTime = (timer.settings.minutes * 60 + timer.settings.seconds) * 1000;
                    dom.modals.body.querySelector('#rounds-phase-label').textContent = `ROUND ${timer.currentRound}`;
                }
                timer.timeRemaining = timer.totalTime;
                dom.modals.body.querySelector('#manual-timer-display').innerHTML = formatSeconds(Math.ceil(timer.timeRemaining / 1000));
            }

            function advanceComplexTimer() {
                const timer = state.manualTimer;
                if (timer.type === 'tabata') {
                    if (timer.currentPhase === 'work') {
                        timer.currentPhase = 'rest';
                        timer.totalTime = timer.settings.rest * 1000;
                        dom.modals.body.querySelector('#tabata-phase-label').textContent = 'REST';
                        playSound('next');
                    } else { // rest ends
                        timer.currentRound++;
                        if (timer.currentRound > timer.settings.rounds) {
                            handleManualTimerSecondaryClick(); // Reset
                            return;
                        }
                        timer.currentPhase = 'work';
                        timer.totalTime = timer.settings.work * 1000;
                        dom.modals.body.querySelector('#tabata-phase-label').textContent = 'WORK';
                        dom.modals.body.querySelector('#tabata-round-counter').textContent = `Round ${timer.currentRound} / ${timer.settings.rounds}`;
                        playSound('start');
                    }
                } else if (timer.type === 'rounds') {
                    timer.currentRound++;
                    if (timer.currentRound > timer.settings.count) {
                        handleManualTimerSecondaryClick(); // Reset
                        return;
                    }
                    timer.totalTime = (timer.settings.minutes * 60 + timer.settings.seconds) * 1000;
                    dom.modals.body.querySelector('#rounds-phase-label').textContent = `ROUND ${timer.currentRound}`;
                    playSound('start');
                }
                timer.timeRemaining = timer.totalTime;
                timer.startTime = Date.now();
                timer.isRunning = true;
                timer.interval = setInterval(updateManualTimer, 1000);
            }

            async function analyzeHistory(btn) {
                const lang = state.language;
                showModal(modalContent.analysis(lang, `<p>${translations[lang].analysis_loading}</p>`), { onOpen: () => {
                    showLoadingSpinner(dom.modals.body, true);
                }});
                
                try {
                    const prompt = `Analiza este historial de entrenamiento en JSON: ${JSON.stringify(state.progress.history)}. Dame 3 consejos para mejorar.`;
                    const responseText = await callGeminiAPI(prompt, "Eres un coach de IA.");
                    const result = JSON.parse(responseText);
                    showModal(modalContent.analysis(lang, `<p>${result.analysis.replace(/\n/g, '<br>')}</p>`));
                } catch (e) {
                    console.error("Error analyzing history", e);
                    showModal(modalContent.analysis(lang, `<p>Hubo un error al analizar tu historial.</p>`));
                }
            }
            
            function renderOfflineRoutines() {
                const listEl = dom.modals.body.querySelector('#offline-routines-list');
                if (!listEl) return;
                const defaultsHTML = state.offlineRoutines.defaults.map((routine, index) => `
                    <button class="offline-routine-btn btn btn-secondary w-full text-left p-4 rounded-lg" data-type="defaults" data-index="${index}">
                        <p class="font-bold">${routine.title}</p>
                        <p class="text-sm text-text-secondary">${routine.duration} min | ${routine.muscles.join(', ') || 'Full Body'}</p>
                    </button>
                `).join('');
                 const customHTML = state.offlineRoutines.custom.map((routine, index) => `
                    <button class="offline-routine-btn btn btn-secondary w-full text-left p-4 rounded-lg" data-type="custom" data-index="${index}">
                        <p class="font-bold">‚≠ê ${routine.title}</p>
                        <p class="text-sm text-text-secondary">${routine.duration} min | Creada por ti</p>
                    </button>
                `).join('');
                listEl.innerHTML = customHTML + defaultsHTML;
            }

            // --- Initial Setup ---
            function init() {
                loadState();
                setLanguage(state.language);
                dom.languageSelect.value = state.language;
                if (state.theme === 'light') {
                    document.body.classList.add('light-theme');
                    document.body.classList.remove('dark-theme');
                } else {
                    document.body.classList.add('dark-theme');
                    document.body.classList.remove('light-theme');
                }
                dom.themeToggleBtn.querySelector('i').className = state.theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
                
                showScreen('dashboard');
                updatePointsDisplay();
                
                if (!localStorage.getItem('goatiFitState_v4')) {
                    state.alarms = [
                        { name: "Hora de tomar agua", time: "10:00", days: ["L","M","X","J","V"], enabled: true },
                        { name: "Pausa activa", time: "15:00", days: ["L","M","X","J","V"], enabled: true },
                        { name: "Ir a dormir", time: "22:30", days: ["L","M","X","J","V","S","D"], enabled: true },
                    ];
                    saveState();
                }

                setTimeout(showOracle, 2000);
            }

            init();
        });
    </script>
</body>
</html>
