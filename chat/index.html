<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Goatify IA</title>
    <link rel="icon" type="image/png" href="./Logos HD.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/locale/es.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/plugin/localizedFormat.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/plugin/isoWeek.js"></script>
    
    <style>
        :root {
            --bg-dark: #121212;
            --bg-medium: #1e1e1e;
            --bg-light: #2c2c2c;
            --primary: #8a4fff;
            --primary-hover: #7b46e6;
            --text-light: #e0e0e0;
            --text-medium: #b3b3b3;
            --border-color: #3a3a3a;
            --gold-color: #FFD700;
            --urgent-color: #ef4444;
            --danger-color: #dc2626;

            --light-bg-dark: #f7f7f8;
            --light-bg-medium: #ffffff;
            --light-bg-light: #f0f0f0;
            --light-primary: #7c40e6;
            --light-primary-hover: #6a37d3;
            --light-text-dark: #1f2937;
            --light-text-medium: #6b7280;
            --light-border-color: #e5e7eb;

            --base-font-size: 15px; /* Reduced font size for desktop */
        }

        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: var(--base-font-size);
        }

        .dark-theme {
            --current-bg-dark: var(--bg-dark);
            --current-bg-medium: var(--bg-medium);
            --current-bg-light: var(--bg-light);
            --current-primary: var(--primary);
            --current-primary-hover: var(--primary-hover);
            --current-text-light: var(--text-light);
            --current-text-medium: var(--text-medium);
            --current-border-color: var(--border-color);
            background-color: var(--current-bg-dark);
            color: var(--text-light);
        }

        .light-theme {
            --current-bg-dark: var(--light-bg-dark);
            --current-bg-medium: var(--light-bg-medium);
            --current-bg-light: var(--light-bg-light);
            --current-primary: var(--light-primary);
            --current-primary-hover: var(--light-primary-hover);
            --current-text-light: var(--light-text-dark);
            --current-text-medium: var(--light-text-medium);
            --current-border-color: var(--light-border-color);
            background-color: var(--light-bg-dark);
            color: var(--light-text-dark);
        }
        
        /* --- Sidebar Refactor --- */
        #sidebar { background-color: var(--current-bg-dark); border-right: 1px solid var(--current-border-color); height: 100vh; transition: width 0.3s ease, padding 0.3s ease; z-index: 40; width: 288px; }
        #sidebar.collapsed { width: 0; padding: 0; overflow: hidden; border-right: none;}
        #sidebar.collapsed > * { display: none; }
        
        #sidebar-inner-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        #sidebar-top-static {
            flex-shrink: 0;
            padding: 0.75rem;
            border-bottom: 1px solid var(--current-border-color);
        }

        #sidebar-bottom-scrollable {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
        }
        
        #sidebar-bottom-scrollable > .flex-grow {
            flex-grow: 1;
        }

        #user-section {
            margin-top: auto; /* Pushes to the bottom */
            padding-top: 0.75rem;
            border-top: 1px solid var(--current-border-color);
        }

        #logo-section {
           padding-top: 0.75rem;
           margin-top: 0.5rem;
        }

        @media (max-width: 767px) {
            #sidebar {
                transform: translateX(-100%);
                position: fixed;
                top: 0;
                left: 0;
                width: 288px; /* Fixed width when open on mobile */
            }
            #sidebar.is-open {
                transform: translateX(0);
            }
            /* Make fonts smaller on mobile */
            body { --base-font-size: 13.5px; }
            button, .btn-primary { 
                padding-top: 0.4rem; padding-bottom: 0.4rem; 
                padding-left: 0.75rem; padding-right: 0.75rem;
                font-size: 0.8rem;
            }
            .text-lg { font-size: 1rem; }
            .text-xl { font-size: 1.1rem; }
            .text-2xl { font-size: 1.2rem; }
            .text-3xl { font-size: 1.4rem; }
        }


        #main-chat-area, .modal-content { background-color: var(--current-bg-medium); }
        .chat-bubble-bot, .bg-input, #pdf-preview-container, .chat-item, .project-header, #user-menu-popup, #services-menu, .pro-controls-bg { background-color: var(--current-bg-light); }
        .border-themed { border-color: var(--current-border-color); }
        .chat-bubble-user { background-color: var(--current-primary); color: white; }
        .btn-primary { background-color: var(--current-primary); color: white; }
        .btn-primary:hover { background-color: var(--current-primary-hover); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .plan-card-highlight { border-color: var(--current-primary); box-shadow: 0 0 15px rgba(138, 79, 255, 0.3); }
        .placeholder-themed::placeholder { color: var(--current-text-medium); }
        .text-primary { color: var(--current-primary); }
        .glowing-mic { animation: pulse 1.s infinite; color: var(--primary) !important; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(138, 79, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0); }
        }

        .project .project-content { display: none; }
        .project.open .project-content { display: block; }
        .project.open .project-arrow { transform: rotate(90deg); }
        .project-header.drag-over { background-color: var(--current-primary); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        #app-container { height: 100vh; height: -webkit-fill-available; }
        #pricing-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .chat-item.selected-for-delete { background-color: var(--primary) !important; color: white; }
        
        .model-selector-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .model-selector-wrapper select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
            padding-right: 2.5rem;
            height: 32px;
            font-size: 0.875rem;
            line-height: 1.25rem;
            border: none;
            outline: none;
            cursor: pointer;
            min-width: 120px;
            background-color: transparent;
        }
         .model-selector-wrapper i {
            position: absolute;
            right: 0.5rem;
            pointer-events: none;
        }

        .pro-controls-bg {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.375rem;
            border-radius: 0.5rem;
            overflow: hidden; 
            width: 100%;
            gap: 0.5rem;
        }

        #pro-controls-left, #pro-controls-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        #pro-controls-left {
            flex-grow: 1;
            min-width: 0;
        }

        #pro-controls-right {
            flex-shrink: 0;
        }
        
        .workflow-content { display: none; }
        .workflow-category.open .workflow-content { display: block; }
        .workflow-category.open .workflow-arrow { transform: rotate(90deg); }
        .plan-card { background-color: var(--current-bg-light); }
        #pdf-preview-container { padding: 0.5rem; }
        
        @keyframes sweep {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(200%) skewX(-15deg); }
        }
        .cool-light-effect { position: relative; overflow: hidden; }
        .cool-light-effect::before {
            content: '';
            position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(138, 79, 255, 0.25) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-150%) skewX(-15deg); transition: transform 0.8s ease;
            pointer-events: none;
        }
        .cool-light-effect:hover::before { animation: sweep 2s infinite linear; }

        .input-wrapper { border: 2px solid transparent; transition: box-shadow 0.3s ease, border-color 0.3s ease; }
        .input-wrapper:focus-within { box-shadow: 0 0 10px 0px rgba(138, 79, 255, 0.5); border-color: var(--current-primary-hover); }

        #chat-title {
            color: var(--primary);
            font-weight: 700;
            transition: color 0.3s ease;
        }
        #chat-title-wrapper:hover #chat-title {
            color: var(--primary-hover);
        }
        
        #chat-title-wrapper {
            position: relative;
            padding-left: 24px;
        }
        #chat-title-wrapper .edit-icon,
        #mobile-chat-title-wrapper .edit-icon {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            opacity: 1;
            transition: transform 0.2s ease;
        }
        #chat-title-wrapper:hover .edit-icon,
        #mobile-chat-title-wrapper:hover .edit-icon {
            transform: translateY(-50%) scale(1.1);
        }
        #motivation-btn-header {
            margin-left: 0.5rem; /* Space between title and brain icon */
        }

        .btn-disabled { background-color: #3a3a3a !important; color: #888 !important; cursor: not-allowed !important; border-color: #3a3a3a !important;}

        .chat-item.selected-chat {
            background-color: var(--current-primary);
            color: white !important;
        }
        .chat-item.selected-chat .text-sm {
            color: white !important;
        }
        .light-theme .chat-item {
            color: var(--light-text-dark);
        }

        /* Calendar styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day {
            padding: 2px;
            border-radius: 4px;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            transition: background-color 0.2s ease, border 0.2s ease;
            position: relative;
            border: 2px solid transparent;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .calendar-day-number {
            font-weight: bold;
            font-size: 0.8rem;
            margin: 4px;
            align-self: flex-start;
        }
        .calendar-day-tasks {
            flex-grow: 1;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 0 2px 2px 2px;
        }
        .calendar-day-task {
            font-size: 0.65rem;
            padding: 2px 4px;
            border-radius: 4px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
            position: relative;
        }
        .calendar-day-task .delete-task-icon {
            display: none;
            position: absolute;
            right: 1px;
            top: 1px;
            color: white;
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 14px;
            height: 14px;
            font-size: 8px;
            line-height: 14px;
            text-align: center;
        }
        .calendar-day-task:hover .delete-task-icon {
            display: block;
        }

        .calendar-day:hover {
            background-color: var(--current-bg-light);
        }
        .calendar-day.current-month {
            color: var(--current-text-light);
        }
        .calendar-day.other-month {
            color: var(--current-text-medium);
            opacity: 0.5;
        }
        .calendar-day.today .calendar-day-number {
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 2px;
        }
        .task-dots-container {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
        }
        .task-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-item-completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .notification-bell-icon {
            position: relative;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7em;
            line-height: 1;
            min-width: 18px;
            text-align: center;
        }
        
        .calendar-view-toggle, .project-view-controls {
            display: flex;
            gap: 0.5rem;
            background-color: var(--current-bg-dark);
            padding: 0.25rem;
            border-radius: 8px;
            width: 100%;
        }

        .calendar-view-toggle button, .project-view-controls button {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            font-weight: 600;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
            white-space: nowrap; /* Prevents text wrapping */
        }
        .calendar-view-toggle button.active, .project-view-controls button.active {
            background-color: var(--current-primary);
            color: white;
            box-shadow: 0 0 8px rgba(138, 79, 255, 0.4);
        }
        .calendar-view-toggle button:hover:not(.active), .project-view-controls button:hover:not(.active) {
            background-color: var(--current-bg-medium);
        }
        .dark-theme .project-view-controls button:not(.active) {
            color: var(--current-text-light);
        }
        .light-theme .project-view-controls button:not(.active) {
            color: var(--current-text-dark);
        }

        #month-view-container, #day-view-container {
            display: block;
        }
        #week-view-container, #day-view-container {
            display: none;
        }
        #week-view-container, #day-view-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--current-border-color);
            border-radius: 8px;
            padding: 10px;
        }
        .week-day-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--current-border-color);
        }
        .week-day-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .week-day-section h5 {
            font-weight: 700;
            color: var(--current-primary);
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .week-day-section .task-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 0;
        }
        
        .day-view-timeline {
            position: relative;
        }
        .day-view-hour {
            display: flex;
            border-top: 1px solid var(--current-border-color);
        }
        .day-view-hour-label {
            width: 60px;
            flex-shrink: 0;
            text-align: right;
            padding-right: 10px;
            font-size: 0.75rem;
            color: var(--current-text-medium);
        }
        .day-view-hour-content {
            flex-grow: 1;
            border-left: 1px solid var(--current-border-color);
            padding: 5px;
            min-height: 40px;
            position: relative;
        }
        .add-task-to-time-btn {
            position: absolute;
            right: 5px;
            top: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .day-view-hour-content:hover .add-task-to-time-btn {
            opacity: 1;
        }

        /* Project & Financial Management View Styles */
        #project-management-view, #financial-assistant-view {
            display: flex;
            flex-direction: column; 
            gap: 1rem;
            height: 100%;
            position: absolute; /* Changed for view switching */
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--current-bg-medium);
        }
        
        #project-board-container, #financial-tools-container {
            flex: 1; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0; 
        }
        #project-chat-container, #financial-chat-container {
            display: flex;
            flex-direction: column;
            border-top: 1px solid var(--current-border-color);
            padding-top: 1rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
            background-color: var(--current-bg-medium);
        }
        #project-chat-container.collapsed, #financial-chat-container.collapsed {
            flex-grow: 0;
            flex-basis: auto;
            height: 50px !important;
        }
        #project-chat-container.collapsed .project-chat-body,
        #financial-chat-container.collapsed .financial-chat-body {
            display: none;
        }
        #project-chat-toggle i, #financial-chat-toggle i {
            transition: transform 0.3s ease;
        }
        #project-chat-container:not(.collapsed) #project-chat-toggle i,
        #financial-chat-container:not(.collapsed) #financial-chat-toggle i {
            transform: rotate(180deg);
        }

        #project-chat-messages, #financial-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        #kanban-view {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 1rem;
            overflow: hidden; 
            flex-grow: 1;
        }

        .kanban-column {
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-width: 0; /* Allow columns to shrink */
        }
        .kanban-column-title {
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--current-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-cards {
            flex-grow: 1;
            min-height: 100px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .kanban-card {
            background-color: var(--current-bg-medium);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            border-left: 4px solid var(--current-primary);
            position: relative;
        }
        .kanban-card .delete-task-icon {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
            color: var(--current-text-medium);
            background-color: var(--current-bg-light);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            line-height: 18px;
            text-align: center;
            transition: all 0.2s ease;
        }
        .kanban-card .delete-task-icon:hover {
            background-color: var(--danger-color);
            color: white;
            transform: scale(1.1);
        }
        .kanban-card:hover .delete-task-icon {
            display: block;
        }
        .kanban-card.urgent {
            border-left-color: var(--urgent-color);
        }
        .kanban-card:active {
            cursor: grabbing;
            background-color: var(--primary);
        }
        .kanban-card p {
            font-weight: 500;
            padding-right: 20px; /* Space for delete icon */
        }
        .kanban-card .card-footer {
            font-size: 0.75rem;
            color: var(--current-text-medium);
            margin-top: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-cards.drag-over {
            border: 2px dashed var(--current-primary);
            background-color: rgba(138, 79, 255, 0.1);
        }
        
        /* List View Styles */
        #list-view {
            overflow: hidden; /* Changed */
            flex-grow: 1;
            display: flex; 
            flex-direction: column; 
        }
        .list-view-header {
            display: grid;
            grid-template-columns: 1fr 100px 80px 120px 40px;
            gap: 1rem;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid var(--current-border-color);
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--current-text-medium);
            flex-shrink: 0; 
        }
        .list-view-content {
             overflow-y: auto; 
             flex-grow: 1; 
        }
        .list-view-task {
            display: grid;
            grid-template-columns: 1fr 100px 80px 120px 40px;
            gap: 1rem;
            align-items: center;
            padding: 0.25rem 1rem; /* Reduced padding */
            border-bottom: 1px solid var(--current-border-color);
        }
        .list-view-task:hover {
            background-color: var(--current-bg-light);
        }
        .list-view-task.task-item-completed .task-content-list {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .task-content-list.urgent {
            font-weight: 600;
            color: var(--urgent-color);
        }
        .task-content-list input {
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
        }
        .task-content-list input:focus {
             background-color: var(--current-bg-dark);
        }
        .priority-cell {
            text-align: center;
            cursor: pointer;
        }
        
        .task-labels {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .task-label {
            padding: 2px 8px;
            font-size: 0.7rem;
            border-radius: 12px;
            font-weight: 600;
        }
        #project-tag-filter-container {
            position: relative;
        }
        #tag-filter-dropdown {
            position: absolute;
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Gamification Styles */
        #gamification-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .gamification-tabs { border-bottom: 2px solid var(--current-border-color); }
        .gamification-tab { padding: 0.75rem 1rem; font-weight: 600; color: var(--current-text-medium); cursor: pointer; border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; }
        .gamification-tab.active { color: var(--current-primary); border-color: var(--current-primary); }
        .xp-bar-bg { background-color: var(--current-bg-light); }
        .xp-bar-fill { background-color: var(--current-primary); transition: width 0.5s ease-out; }
        .level-badge { background-color: var(--current-primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; }
        .streak-day { background-color: var(--current-bg-light); border: 2px solid var(--current-border-color); transition: all 0.2s ease; }
        .streak-day.active { border-color: var(--current-primary); transform: scale(1.05); box-shadow: 0 0 10px rgba(138, 79, 255, 0.5); }
        .streak-day.completed { background-color: var(--current-primary); color: white; border-color: var(--current-primary); }
        .streak-day .fa-gift { color: var(--gold-color); }
        .mission-item.completed { opacity: 0.5; text-decoration: line-through; }
        .mission-item.completed .btn-primary { background-color: #4CAF50; cursor: default; }
        .achievement-badge { border: 2px solid var(--current-border-color); filter: grayscale(100%); opacity: 0.6; transition: all 0.3s ease; }
        .achievement-badge.unlocked { border-color: var(--gold-color); filter: grayscale(0%); opacity: 1; box-shadow: 0 0 15px var(--gold-color); }
        .achievement-badge.unlocked .fa-medal { color: var(--gold-color); }
        .text-gold { color: var(--gold-color); }

        /* Pricing Modal Enhancements */
        .plan-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .plan-details.open {
            max-height: 500px; /* Adjust as needed */
        }
        .plan-feature-list {
            list-style-position: inside;
        }
        .plan-feature-list li {
            padding-left: 1em;
            text-indent: -1em;
        }
        .plan-feature-list .fa-check-circle {
            color: var(--primary);
        }

        /* NEW Financial Assistant Styles */
        #financial-tools-container {
             padding: 1rem;
             gap: 1rem;
             overflow-y: auto;
        }
        .finance-section {
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
        }
        .finance-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        .finance-section-header h3 {
            font-size: 1.125rem;
            font-weight: 700;
        }
        .finance-category {
            margin-top: 1rem;
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
        }
        .finance-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .finance-category-header .finance-category-name-input {
            background: transparent;
            border: none;
            outline: none;
            font-weight: bold;
            width: 70%;
            color: var(--current-text-light);
        }
        .finance-category-content {
            padding: 0.75rem;
        }
        .finance-item-row {
            display: grid;
            grid-template-columns: 1fr 100px 40px;
            gap: 0.75rem;
            align-items: center;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--current-border-color);
        }
        .finance-item-row:last-child {
            border-bottom: none;
        }
        .finance-item-row input {
            background: transparent;
            border: none;
            padding: 0.25rem;
            width: 100%;
            outline: none;
            color: var(--current-text-light);
        }
        .finance-item-row input:focus {
            background-color: var(--current-bg-dark);
            border-radius: 4px;
        }
        .finance-summary {
            background-color: var(--current-bg-light);
            border-radius: 0.5rem;
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            text-align: center;
        }
        .finance-summary h4 {
            font-size: 0.8rem;
            color: var(--current-text-medium);
        }
        .finance-summary p {
            font-size: 1.25rem;
            font-weight: 700;
        }
        #total-income { color: #22c55e; }
        #total-expenses { color: #ef4444; }


        /* In-app notification */
        #in-app-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-200%);
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            padding: 1rem;
            border-radius: 0.75rem;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            border: 1px solid var(--current-border-color);
            max-width: 90%;
            width: 400px;
            opacity: 0;
            pointer-events: none;
        }
        #in-app-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        #in-app-notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        #in-app-notification-header h4 {
            font-weight: bold;
        }


        /* Desktop specific styles */
        @media (min-width: 768px) {
            #services-menu {
                opacity: 0;
                visibility: hidden;
                transform: scale(0.95) translateY(-10px);
                transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
            }
            #services-menu.show {
                opacity: 1;
                visibility: visible;
                transform: scale(1) translateY(0);
            }
            #project-management-view, #financial-assistant-view {
                display: flex; /* This is crucial for desktop view */
                flex-direction: row; 
            }
            #project-chat-container, #financial-chat-container {
                display: flex; /* This is crucial for desktop view */
                border-left: 1px solid var(--current-border-color);
                border-top: none;
                padding-left: 1rem;
                padding-top: 0;
                height: 100%;
                flex-basis: 40%;
                flex-shrink: 0;
            }
            #project-chat-container.collapsed, #financial-chat-container.collapsed {
                flex-basis: 50px;
                height: 100% !important;
            }
            #project-chat-container-header, #financial-chat-header { cursor: pointer; }

            #project-chat-container.collapsed .project-chat-body,
            #project-chat-container.collapsed #project-chat-container-header h3,
            #financial-chat-container.collapsed .financial-chat-body,
            #financial-chat-container.collapsed #financial-chat-header h3 {
                display: none;
            }
            #project-chat-container.collapsed #project-chat-toggle,
            #financial-chat-container.collapsed #financial-chat-toggle {
                transform: rotate(90deg);
                justify-content: center;
            }
            #project-chat-container.collapsed #project-chat-toggle i,
            #financial-chat-container.collapsed #financial-chat-toggle i {
                 transform: rotate(180deg);
            }
        }
        
        /* Mobile specific adjustments */
        @media (max-width: 767px) {
             #mobile-chat-title-wrapper .edit-icon {
                left: -10px;
            }
            #calendar-modal {
                padding: 0.5rem;
                max-width: 98vw;
                max-height: 95vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            #calendar-modal > div:not(:first-child) {
                overflow-y: auto;
            }

            .header-right-icons {
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 0; /* Adjust gap for more icons */
            }
            .header-right-icons > * {
                padding: 0.3rem; /* Reduce padding to fit more icons */
            }
            #chat-title-wrapper {
                flex-grow: 1;
                flex-shrink: 1;
                min-width: 0;
            }
            #main-header-content {
                display: flex;
                align-items: center;
                justify-content: space-between;
                width: 100%;
                gap: 0.5rem;
            }

            #project-chat-container, #financial-chat-container {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 50px; /* Collapsed height */
                overflow: hidden;
                border-top: 1px solid var(--current-border-color);
                z-index: 10;
                transition: height 0.3s ease;
                /* This part is important, it ensures content doesn't get cut */
                max-height: calc(100vh - 120px); /* Adjust 120px to account for header/etc */
            }
            #project-chat-container:not(.collapsed),
            #financial-chat-container:not(.collapsed) {
                 height: 100%; /* Expanded height */
            }
            #project-chat-container .project-chat-body,
            #financial-chat-container .financial-chat-body {
                height: calc(100% - 50px); /* Adjust based on header height */
                display: flex;
                flex-direction: column;
            }

            /* Kanban mobile fix: no horizontal scroll */
            #kanban-view {
                grid-template-columns: repeat(3, 1fr);
                overflow-x: hidden; 
                gap: 0.25rem; 
                padding-bottom: 50px;
            }
            .kanban-column {
                min-width: 0; /* Allow columns to shrink */
                padding: 0.4rem;
            }
            .kanban-column-title { font-size: 0.7rem; }
            .kanban-card { padding: 0.4rem; }
            .kanban-card p { font-weight: normal; font-size: 0.7rem; }

            #list-view-mobile {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                 padding-bottom: 50px; /* Space for the collapsed chat */
                 overflow-y: auto; /* Ensure vertical scrolling */
                 flex-grow: 1;
            }
            .list-view-task-mobile { background-color: var(--current-bg-light); padding: 0.75rem; border-radius: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
            .list-view-task-mobile-header { display: flex; align-items: flex-start; gap: 0.75rem; }
            .list-view-task-mobile-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--current-border-color); padding-top: 0.5rem; font-size: 0.75rem; gap: 0.5rem; }
            .list-view-task-mobile-footer .task-date-time-inputs { display: flex; gap: 0.25rem; }
            .list-view-task-mobile-footer input { max-width: 100px; }


            #services-menu {
                position: fixed; /* Changed to fixed for better mobile positioning */
                opacity: 0;
                visibility: hidden;
                transform: scale(0.95) translateY(-10px);
                transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
                width: 90vw;
                max-width: 320px;
                top: 60px;
                right: 10px;
                max-height: calc(100vh - 80px); /* Ensures it stays within viewport */
                overflow-y: auto;
                z-index: 50; /* Ensure it's on top */
            }
            #services-menu.show {
                opacity: 1;
                visibility: visible;
                transform: scale(1) translateY(0);
            }
            
            .calendar-view-toggle button { padding: 6px 4px; font-size: 0.75rem; }
            .project-view-controls { width: fit-content; flex-grow: 0; }
            .project-view-controls button { padding: 6px 8px; font-size: 0.75rem; flex-grow: 0; }
            
            #gamification-modal .modal-content { padding: 1rem; }
            #gamification-modal h2 { font-size: 1.25rem; }
            .streak-day { padding: 0.5rem; font-size: 0.7rem; }
            .streak-day .text-2xl { font-size: 1.25rem; margin-top: 0.25rem; margin-bottom: 0.25rem; }
            .mission-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .mission-item .btn-primary { padding: 0.25rem 0.5rem; font-size: 0.75rem; align-self: flex-end; }
            #achievements-container { gap: 0.5rem; }
            .achievement-badge { padding: 0.5rem; font-size: 0.7rem; }
            .achievement-badge .fa-3x { font-size: 1.75em; }

            /* Mobile Image Preview Fix */
            #file-preview-area {
                max-height: 80px;
                overflow: hidden;
            }
            #image-preview-container #image-preview {
                max-height: 50px;
                width: auto;
            }
        }
        
        /* Mobile Landscape */
        @media (max-height: 500px) and (orientation: landscape) {
            #sidebar.is-open {
                transform: translateX(0);
            }
            #sidebar.is-open > div {
                 overflow-y: auto;
                 height: 100%;
            }
            #main-chat-area, #project-management-view, #financial-assistant-view {
                overflow-y: auto; /* Allow scrolling */
            }
            #chat-messages {
                padding: 0.5rem;
                flex-grow: 1; /* Allow it to take up space */
            }
            #kanban-view {
                grid-template-columns: repeat(3, minmax(250px, 1fr));
                overflow-x: auto;
            }
            .modal-content { max-height: 95vh; overflow-y: auto; }
            #input-area { padding: 0.5rem; flex-shrink: 0; }
            .pro-controls-bg { padding: 0.25rem; }
            #msg { height: 3rem !important; max-height: 3rem; }
        }

        /* Motivation Modal Animation */
        @keyframes flash-effect {
            0%, 100% { 
                opacity: 1;
                text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            }
            50% { 
                opacity: 0.8;
                text-shadow: 0 0 20px rgba(255, 215, 0, 1);
            }
        }
        #motivation-quote.flash {
            animation: flash-effect 1.5s ease-in-out;
            font-weight: bold; /* Make quote bold */
        }
        #motivation-modal h3 {
            font-weight: normal; /* Remove bold from title */
        }
    </style>
</head>
<body class="w-screen overflow-x-hidden dark-theme">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script type="text/javascript">
        if (window.netlifyIdentity) {
            netlifyIdentity.init();
        }
    </script>

    <div id="loading-overlay" class="fixed inset-0 bg-bg-dark bg-opacity-95 flex flex-col items-center justify-center z-[100] transition-opacity duration-300">
        <img src="./Logos HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mb-6 animate-pulse" onerror="this.onerror=null;this.src='https://placehold.co/96x96/121212/e0e0e0?text=LOGO';">
        <div class="text-text-light text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3 text-lg font-semibold" data-translate-key="initializing">Inicializando...</p>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden opacity-0 pointer-events-none"></div>

    <div id="app-container" class="flex w-full relative opacity-0 transition-opacity duration-300">
        <aside id="sidebar" class="flex-shrink-0 flex flex-col transition-transform duration-300 md:translate-x-0 h-full">
            <div id="sidebar-inner-container">
                <div id="sidebar-top-static">
                    <h3 class="text-xs font-semibold uppercase text-text-medium mb-2 px-2" data-translate-key="workflows">Workflows</h3>
                    <div id="workflows-container" class="space-y-1">
                        <div class="workflow-category">
                            <div id="project-workflow-header" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                 <i class="fas fa-tasks w-6 mr-2 text-purple-400"></i>
                                <span class="text-sm font-bold" data-translate-key="wf_pm">Dirección de Proyectos</span>
                            </div>
                         </div>
                        <div class="workflow-category">
                            <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                 <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-brain w-6 mr-2 text-teal-400"></i>
                                <span class="text-sm font-bold">Asistente Experto</span>
                            </div>
                             <div class="workflow-content pl-4 pt-1 space-y-1">
                                <button data-workflow="decision-lab" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Laboratorio de Decisiones</button>
                                <button data-workflow="financial-assistant" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Asistente Financiero</button>
                                <button data-workflow="conflict-resolution" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Resolución de Conflictos</button>
                             </div>
                        </div>
                        <div class="workflow-category">
                            <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                 <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-share-alt w-6 mr-2 text-pink-400"></i>
                                <span class="text-sm font-bold" data-translate-key="wf_social">Potenciador de Redes Sociales</span>
                             </div>
                            <div class="workflow-content pl-4 pt-1 space-y-1">
                                <button data-workflow="create-full-post" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_1">Crear un Post Completo</button>
                                 <button data-workflow="persuasive-copy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_2">Redacción de Copys</button>
                                <button data-workflow="post-ideas" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_3">Lluvia de Ideas para Posts</button>
                                 <button data-workflow="brand-strategy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_4">Definir Estrategia de Marca</button>
                            </div>
                        </div>
                         <div class="workflow-category">
                            <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                 <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-chart-pie w-6 mr-2 text-blue-400"></i>
                                <span class="text-sm font-bold" data-translate-key="wf_business">Análisis de Negocio</span>
                            </div>
                             <div class="workflow-content pl-4 pt-1 space-y-1">
                                <button data-workflow="competitor-analysis" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_1">Análisis de tu Competencia</button>
                                 <button data-workflow="buyer-persona" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_2">Definir mi Cliente Ideal</button>
                                <button data-workflow="brand-names" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_3">Lluvia de Nombres para Marca</button>
                             </div>
                        </div>
                        <div class="workflow-category">
                            <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                 <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-headset w-6 mr-2 text-green-400"></i>
                                <span class="text-sm font-bold" data-translate-key="wf_sales">Comunicación y Ventas</span>
                             </div>
                            <div class="workflow-content pl-4 pt-1 space-y-1">
                                <button data-workflow="sales-assistant" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_1">Asistente de Ventas 24/7</button>
                                <button data-workflow="email-writing" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_2">Redacción de Email</button>
                                <button data-workflow="design-web" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_3">Diseño Web</button>
                                 <button data-workflow="social-skills" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_4">Mejorar Habilidades Sociales</button>
                            </div>
                         </div>
                        <div class="workflow-category">
                            <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                 <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-language w-6 mr-2 text-red-400"></i>
                                <span class="text-sm font-bold">English Teacher</span>
                            </div>
                               <div class="workflow-content pl-4 pt-1 space-y-1">
                                <button data-workflow="english-teacher-translate" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_1">Traducir/Corregir Texto</button>
                                 <button data-workflow="english-teacher-vocabulary" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_2">Aprender Vocabulario Nuevo</button>
                                <button data-workflow="english-teacher-practice" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_3">Practicar Conversación</button>
                             </div>
                        </div>
                    </div>
                </div>

                <div id="sidebar-bottom-scrollable">
                    <div id="sidebar-main-content">
                        <div class="flex flex-col space-y-2 my-4">
                            <button id="new-chat-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-plus mr-2"></i><span data-translate-key="new_chat">Nuevo Chat</span></button>
                            <button id="new-folder-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg bg-input"><i class="fas fa-folder-plus mr-2"></i><span data-translate-key="new_folder">Nueva Carpeta</span></button>
                        </div>
                        
                        <div class="flex-grow">
                            <div class="border-t border-b border-themed my-3 py-3">
                                 <button id="select-chats-btn" class="w-full text-sm p-2 rounded hover:bg-light flex items-center justify-center">
                                    <i class="fas fa-tasks mr-2"></i><span data-translate-key="select_chats">Seleccionar Múltiples Chats</span>
                                </button>
                             </div>
                            <div id="delete-mode-controls" class="hidden flex space-x-2 mb-2 px-2">
                                <button id="delete-selected-btn" class="flex-1 flex items-center justify-center font-semibold p-2 rounded-lg bg-red-600 text-white disabled:opacity-50" disabled><i class="fas fa-trash-alt mr-2"></i><span data-translate-key="delete">Borrar</span></button>
                                 <button id="cancel-select-mode-btn" class="p-2 rounded-lg bg-gray-600 text-white"><i class="fas fa-times"></i></button>
                            </div>
                            <div id="sidebar-content" class="pr-1 space-y-1"></div>
                        </div>
                   </div>

                    <div id="user-section">
                        <div id="login-view" class="hidden">
                            <button id="login-btn" class="w-full flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-sign-in-alt mr-2"></i><span data-translate-key="login">Iniciar Sesión</span></button>
                        </div>
                         <div id="user-menu-view" class="hidden relative">
                            <button id="user-menu-btn" class="w-full flex items-center text-left p-2 rounded-lg hover:bg-light transition-colors">
                                <span id="user-email" class="flex-grow truncate text-sm font-semibold"></span>
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <div id="user-menu-popup" class="absolute bottom-full left-0 w-full mb-2 rounded-lg p-2 border border-themed shadow-lg hidden">
                                <button id="settings-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-cog w-6 mr-2"></i><span data-translate-key="settings">Configuración</span></button>
                                 <button id="logout-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-sign-out-alt w-6 mr-2"></i><span data-translate-key="logout">Cerrar Sesión</span></button>
                            </div>
                        </div>
                    </div>

                    <div id="logo-section">
                        <div id="logo-space" class="w-24 h-24 rounded-lg mx-auto flex-shrink-0 flex items-center justify-center overflow-hidden bg-input">
                            <img src="./Logos HD.png" alt="Goatify Logo" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <main id="main-chat-area" class="flex-1 flex flex-col h-full overflow-hidden">
            <header class="flex items-center justify-between p-3 md:p-4 border-b border-themed flex-shrink-0 relative">
                <div id="main-header-content" class="flex items-center justify-between w-full">
                    <div class="flex items-center flex-shrink-0">
                        <button id="menu-toggle" class="md:hidden text-xl p-2"><i class="fas fa-bars"></i></button>
                        <button id="sidebar-toggle-desktop" class="hidden md:block text-xl p-2 mr-2"><i class="fas fa-angle-left"></i></button>
                        <button id="new-chat-icon-btn" title="Nuevo Chat" class="text-xl p-2 hover:opacity-80 transition-opacity md:hidden"><i class="fas fa-plus-circle text-primary"></i></button>
                    </div>

                    <div id="chat-title-wrapper" class="hidden sm:flex items-center group cursor-pointer mx-2 flex-1 min-w-0" title="Renombrar Chat">
                        <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                        <h1 id="chat-title" class="text-lg font-semibold truncate">Goatify IA</h1>
                        <button id="motivation-btn-header" title="Motivación Diaria" class="text-yellow-400 hover:text-yellow-300 p-2 transition-colors"><i class="fas fa-lightbulb text-xl"></i></button>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <button id="calendar-btn" title="Mi Calendario y Tareas" class="text-sky-400 hover:text-sky-300 p-2 transition-colors notification-bell-icon">
                            <i class="fas fa-calendar-days text-xl"></i>
                            <span id="notification-badge" class="notification-badge hidden">0</span>
                        </button>
                        <div id="message-counter" class="text-xs font-mono whitespace-nowrap mx-2 flex items-center gap-1"></div>
                    </div>

                    <div class="flex items-center space-x-1 sm:space-x-2 header-right-icons">
                        <button id="gamification-btn" title="Mi Ascensión" class="text-xl p-2 hover:opacity-80 transition-opacity text-gold">
                            <i class="fas fa-trophy"></i>
                        </button>
                        <button id="services-menu-btn" title="Potenciar mi Negocio" class="relative text-xl p-2 hover:opacity-80 transition-opacity flex items-center gap-2">
                            <i class="fas fa-rocket text-primary"></i>
                            <span class="text-sm font-semibold text-primary hidden md:inline" data-translate-key="solutions">Soluciones</span>
                        </button>
                        <button id="theme-toggle" title="Cambiar Tema" class="text-xl p-2"><i class="fas fa-moon" id="theme-icon"></i></button>
                    </div>
                </div>
                 <div id="services-menu" class="absolute top-full right-4 mt-2 w-80 rounded-xl shadow-lg border border-themed z-30 p-4 origin-top-right">
                    <h4 class="font-bold text-lg mb-1 text-text-light" data-translate-key="ally_title">Somos tu Aliado Estratégico</h4>
                    <p class="text-sm text-text-medium mb-4" data-translate-key="ally_desc">Goatify no es solo un chat. Somos una IA personalizada con un equipo de expertos listos para ayudarte a escalar tu negocio.</p>
                    <ul class="space-y-3">
                        <li><a id="sol-web" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Páginas Web que Convierten</p><p class="text-sm text-text-medium">Transformamos tus ideas en webs y tiendas online diseñadas para vender.</p></a></li>
                         <li><a id="sol-auto" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Ventas en Piloto Automático</p><p class="text-sm text-text-medium">Implementamos sistemas de IA para automatizar tus ventas y procesos clave.</p></a></li>
                        <li><a id="sol-social" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Avatares para Redes Sociales</p><p class="text-sm text-text-medium">Creamos avatares hiperrealistas con IA y estrategias de contenido que captan la atención.</p></a></li>
                         <li><a id="sol-consult" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Escala tu Empresa con IA</p><p class="text-sm text-text-medium">Obtén consultoría experta para integrar la IA en el ADN de tu negocio.</p></a></li>
                    </ul>
                </div>
            </header>
            <div class="block sm:hidden text-center py-1.5 border-b border-themed bg-current-bg-dark shadow-sm flex-shrink-0">
                <div id="mobile-chat-title-wrapper" class="flex items-center justify-center group cursor-pointer px-4 relative" title="Renombrar Chat">
                    <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                    <h2 id="mobile-chat-title" class="text-sm font-semibold truncate">Goatify IA</h2>
                    <button id="motivation-btn-mobile" title="Motivación Diaria" class="text-yellow-400 hover:text-yellow-300 p-2 transition-colors"><i class="fas fa-lightbulb text-lg"></i></button>
                </div>
             </div>
            
            <div id="view-container" class="flex-1 overflow-hidden relative">
                <div id="chat-messages" class="h-full overflow-y-auto p-3 sm:p-6">
                    <div class="flex justify-center items-center h-full" id="initial-message-container">
                        <div id="welcome-message-wrapper" class="text-center text-text-medium">
                            <img src="./Logos HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                            <h2 class="text-3xl font-bold text-text-light">Goatify IA</h2>
                            <div id="personalized-welcome" class="hidden"><p class="text-lg mt-1"><span data-translate-key="welcome_user">¡Hola, </span><span id="user-name"></span><span data-translate-key="welcome_user_2">! Hoy es un gran día para crear algo increíble.</span></p></div>
                            <div id="generic-welcome" class="hidden"><p class="text-xl" data-translate-key="welcome_guest">¿Cómo puedo ayudarte hoy?</p></div>
                        </div>
                    </div>
                </div>
                
                <div id="financial-assistant-view" class="hidden h-full"></div>
                
                 <div id="project-management-view" class="hidden p-4 h-full">
                    <div id="project-board-container" class="flex flex-col h-full">
                        <div class="flex flex-wrap justify-between items-center mb-4 flex-shrink-0 gap-2">
                            <h2 id="project-view-title" class="text-2xl font-bold">Nombre del Proyecto</h2>
                             <div id="project-tag-filter-container" class="relative">
                                <button id="tag-filter-btn" class="p-2 rounded-md bg-input text-sm"><i class="fas fa-tag mr-1"></i> Filtrar</button>
                                <div id="tag-filter-dropdown" class="hidden absolute right-0 mt-1 p-2 rounded-md shadow-lg w-48"></div>
                             </div>
                        </div>
                         <div class="flex items-center space-x-2 project-view-controls mb-4 flex-shrink-0">
                            <span class="text-sm text-text-medium hidden sm:inline">Vistas:</span>
                             <button id="view-toggle-kanban" class="px-3 py-1 text-sm rounded-md">Kanban</button>
                            <button id="view-toggle-list" class="px-3 py-1 text-sm rounded-md">Lista</button>
                            <button id="add-task-list-view-btn" title="Añadir Tarea" class="hidden ml-auto p-2 rounded-md bg-primary text-white"><i class="fas fa-plus"></i></button>
                            <button id="project-calendar-btn" title="Calendario del Proyecto" class="text-sky-400 hover:text-sky-300 p-2 transition-colors ml-auto"><i class="fas fa-calendar-alt text-xl"></i></button>
                        </div>
                         <div id="kanban-view" class="hidden flex-1">
                            </div>
                        <div id="list-view" class="hidden flex-1 flex-col">
                        </div>
                        <div id="list-view-mobile" class="hidden flex-1 overflow-y-auto">
                        </div>
                    </div>
                    <div id="project-chat-container" class="collapsed">
                         <div id="project-chat-container-header" class="flex justify-between items-center cursor-pointer p-2">
                            <h3 class="text-lg font-semibold text-primary">Asistente del Proyecto</h3>
                            <button id="project-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-up"></i></button>
                        </div>
                         <div class="project-chat-body hidden">
                            <div id="project-chat-messages" class="chat-bubble-bot"></div>
                            <div id="project-input-area" class="mt-auto pt-2">
                                 <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                                     <div class="flex items-center space-x-2">
                                        <label for="project-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1">Modelo:</label>
                                         <div class="model-selector-wrapper">
                                            <select id="project-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                                 <option value="gpt-4o-mini">Asistente de Proyectos</option>
                                                <option value="gpt-3.5-turbo-1106">General (Turbo)</option>
                                                <option value="sonar">Búsqueda Web</option>
                                             </select>
                                        </div>
                                     </div>
                                </div>
                                 <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                     <textarea id="project-msg" placeholder="Deja que Goatify organice tu proyecto..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm"></textarea>
                                    <button id="project-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
                <div id="input-area" class="p-2 sm:p-4 border-t border-themed flex-shrink-0">
                <div id="file-preview-area" class="mb-2 space-y-2 px-1 sm:px-0">
                     <div id="image-preview-container" class="hidden relative w-full flex items-center gap-2 bg-current-bg-light p-2 rounded-lg">
                        <img id="image-preview" src="#" alt="Image Preview" class="rounded-lg">
                        <span id="image-name" class="text-xs text-text-medium truncate flex-grow"></span>
                         <button id="clear-image-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none flex-shrink-0">&times;</button>
                    </div>
                    <div id="pdf-preview-container" class="hidden relative">
                        <i class="fas fa-file-pdf text-red-500 text-xl"></i>
                         <div class="flex-grow min-w-0">
                            <p id="pdf-name" class="font-medium truncate"></p>
                            <p id="pdf-status" class="text-xxs font-mono"></p>
                         </div>
                        <button id="clear-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                </div>
                <div class="pro-controls-bg rounded-lg p-1 cool-light-effect">
                    <div id="pro-controls-left">
                        <label for="model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1" data-translate-key="model">Modelo:</label>
                        <div class="model-selector-wrapper">
                            <select id="model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                <option value="gpt-3.5-turbo-1106" data-translate-key="model_general">Chat</option>
                                <option value="sonar" data-translate-key="model_web">Búsqueda Web</option>
                            </select>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                    <div id="pro-controls-right">
                        <div id="voice-selector-container" class="hidden items-center space-x-2">
                            <label for="voice-selector" class="font-medium text-xs text-text-medium" data-translate-key="voice">Voz:</label>
                            <div class="model-selector-wrapper">
                                <select id="voice-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light w-24"></select>
                            </div>
                        </div>
                        <div id="action-buttons-container" class="flex items-center">
                            <button id="image-gen-btn" title="Crear Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fas fa-paint-brush text-lg"></i></button>
                            <button id="pdf-upload-btn" title="Subir PDF" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-file-pdf text-lg"></i></button>
                            <button id="image-upload-btn" title="Subir Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-image text-lg"></i></button>
                        </div>
                    </div>
                 </div>
                <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                    <input type="file" id="pdf-upload" accept=".pdf,application/pdf" class="hidden"><input type="file" id="image-upload" accept="image/*" class="hidden">
                    <button id="mic-btn" title="Activar Micrófono" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-microphone text-xl"></i></button>
                     <button id="tts-toggle" title="Activar/Desactivar Voz" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-volume-mute text-xl"></i></button>
                    <textarea id="msg" placeholder="Escribe tu mensaje..." class="flex-1 bg-transparent p-2 h-12 max-h-32 resize-none outline-none placeholder-themed" rows="1" data-translate-key="placeholder_main"></textarea>
                    <button id="send" title="Enviar" class="p-2 sm:p-4 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i id="send-icon" class="fa fa-paper-plane text-xl"></i></button>
                 </div>
                <div id="contextual-footer" class="text-center text-xs text-text-medium mt-2 px-2 h-4"></div>
            </div>
        </main>
    </div>

    <div id="in-app-notification">
        <div id="in-app-notification-header">
            <h4 id="in-app-notification-title"></h4>
            <button id="in-app-notification-close" class="text-text-medium hover:text-text-light text-2xl leading-none">&times;</button>
        </div>
        <p id="in-app-notification-body"></p>
    </div>

    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <div id="modal-body" class="mb-4 text-text-medium text-sm"></div>
            <div id="modal-buttons-container" class="flex justify-end space-x-2">
                 </div>
        </div>
    </div>

    <div id="motivation-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative text-center">
            <i class="fas fa-lightbulb text-4xl text-yellow-400 mb-4"></i>
            <h3 class="text-2xl mb-4">Dosis de Motivación</h3>
            <p id="motivation-quote" class="text-lg text-text-light mb-6 min-h-[50px]"></p>
            <div class="flex items-center justify-center mb-6">
                <label for="motivation-toggle" class="flex items-center cursor-pointer">
                    <span class="mr-3 text-text-light font-medium">
                        Notificaciones periódicas
                    </span>
                    <div class="relative">
                        <input type="checkbox" id="motivation-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                    </div>
                </label>
            </div>
            <button id="close-motivation-modal" class="btn-primary px-6 py-2 rounded-lg"></button>
        </div>
    </div>
    
    <div id="pricing-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-5xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-6">
                <h2 class="text-3xl md:text-4xl font-extrabold text-center flex-grow" data-translate-key="plans_title">Planes Goatify</h2>
                 <button id="close-pricing-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="modal-content-body flex-grow overflow-y-auto px-2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-text-light">
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">Free</h3>
                        <p class="text-5xl font-extrabold my-3">$0</p>
                        <p class="text-sm text-text-medium mb-4" data-translate-key="plan_free_sub">Para Siempre</p>
                         <ul class="text-sm space-y-2 mb-4 text-left">
                            <li><i class="fas fa-check-circle mr-2"></i>15 Créditos/día</li>
                            <li><i class="fas fa-check-circle mr-2"></i>Acceso a Modelos Básicos</li>
                             <li><i class="fas fa-check-circle mr-2"></i>Workflows Limitados</li>
                        </ul>
                        <button id="free-plan-button" class="mt-auto w-full p-3 rounded-lg font-semibold border-2 border-primary text-primary hover:bg-primary hover:text-white transition-colors" data-translate-key="plan_free_cta">Tu Plan Actual</button>
                     </div>
                    <div class="plan-card border-2 rounded-xl p-6 flex flex-col bg-current-bg-dark plan-card-highlight">
                        <h3 class="text-2xl font-bold">GOAT <span class="text-primary">BOOST</span></h3>
                         <p class="text-5xl font-extrabold my-3">$7<span class="text-lg font-medium text-text-medium">/mes</span></p>
                        <button class="w-full p-2 text-sm rounded-lg font-semibold border border-primary text-primary hover:bg-primary hover:text-white transition-colors mb-4 plan-details-toggle">Ver Detalles</button>
                        <div class="plan-details text-sm text-left">
                             <ul class="space-y-2 mb-4 plan-feature-list">
                                <li><i class="fas fa-check-circle mr-2"></i><strong>100 Créditos/día</strong></li>
                                <li><i class="fas fa-check-circle mr-2"></i>Acceso a <strong>todos los modelos de IA</strong></li>
                                 <li><i class="fas fa-check-circle mr-2"></i>Acceso a <strong>todos los Workflows</strong></li>
                                <li><i class="fas fa-check-circle mr-2"></i>Soporte Prioritario</li>
                            </ul>
                         </div>
                        <button data-plan="boost" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_boost_cta">Obtener Boost</button>
                    </div>
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">GOAT <span class="text-primary">PRO</span></h3>
                        <p class="text-5xl font-extrabold my-3">$17<span class="text-lg font-medium text-text-medium">/mes</span></p>
                         <button class="w-full p-2 text-sm rounded-lg font-semibold border border-primary text-primary hover:bg-primary hover:text-white transition-colors mb-4 plan-details-toggle">Ver Detalles</button>
                        <div class="plan-details text-sm text-left">
                            <ul class="space-y-2 mb-4 plan-feature-list">
                                 <li><i class="fas fa-check-circle mr-2"></i><strong>Créditos Ilimitados</strong></li>
                                <li><i class="fas fa-check-circle mr-2"></i>Todo lo del plan BOOST</li>
                                <li><i class="fas fa-check-circle mr-2 text-gold"></i><strong>¡Te construimos tu Página Web!</strong></li>
                                 <li><i class="fas fa-check-circle mr-2"></i>Consultoría de IA</li>
                                <li><i class="fas fa-check-circle mr-2"></i>Acceso a Guías Premium</li>
                            </ul>
                         </div>
                        <button data-plan="pro" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_pro_cta">Quiero mi Plan Pro + Web</button>
                    </div>
                </div>
             </div>
        </div>
    </div>

    <div id="html-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4"><div class="modal-content rounded-2xl w-full h-full max-w-4xl p-2 md:p-4 relative flex flex-col"><h3 class="text-lg font-bold" data-translate-key="preview">Vista Previa</h3><button id="close-html-preview-modal" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button></div><iframe id="html-preview-iframe" class="w-full flex-grow h-full border-2 border-themed rounded-lg bg-white"></iframe></div>
    
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-lg p-6 relative">
             <h3 class="text-lg font-bold mb-4" data-translate-key="settings">Configuración</h3>
            <div class="space-y-4 text-sm max-h-[70vh] overflow-y-auto pr-2">
                <div>
                    <p class="font-semibold" data-translate-key="settings_email">Correo Electrónico:</p>
                    <p id="settings-user-email" class="text-text-medium"></p>
                 </div>
                <div>
                    <p class="font-semibold" data-translate-key="settings_plan">Plan de Suscripción:</p>
                    <p id="settings-user-plan" class="text-text-medium"></p>
                    <button id="settings-upgrade-plan-btn" class="text-primary hover:underline mt-1 text-xs" data-translate-key="upgrade_plan">Mejorar Plan</button>
                 </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_fontsize">Tamaño de Letra:</p>
                    <input type="range" id="font-size-slider" min="14" max="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg dark:bg-gray-700">
                    <span id="font-size-value" class="text-xs text-text-medium">15px</span>
                </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_theme">Personalización:</p>
                    <button id="settings-theme-toggle" class="flex items-center p-2 rounded hover:bg-medium w-full text-left">
                         <i class="fas fa-moon mr-2" id="settings-theme-icon"></i>
                        <span data-translate-key="settings_dark_mode">Modo Oscuro</span>
                    </button>
                </div>
                <div>
                     <div class="flex items-center justify-between">
                        <p class="font-semibold" data-translate-key="settings_notifications">Notificaciones de Tareas:</p>
                        <label for="notifications-toggle" class="inline-flex relative items-center cursor-pointer">
                            <input type="checkbox" id="notifications-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                 </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_lang">Idioma:</p>
                    <select id="language-selector" class="w-full p-2 rounded bg-input border border-themed">
                         <option value="es">Español</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="border-t border-themed pt-4 mt-4">
                     <h4 class="font-semibold mb-2" data-translate-key="settings_integrations">Integraciones</h4>
                     <div class="space-y-2">
                        <button id="connect-google-calendar-btn" class="w-full bg-input p-2 rounded-lg flex items-center justify-start text-left hover:bg-light transition-colors">
                             <i class="fab fa-google mr-3 text-red-500 fa-lg"></i>
                            <div>
                                <span class="font-semibold">Google Calendar</span>
                                 <p class="text-xs text-text-medium">Sincroniza tus tareas y eventos.</p>
                            </div>
                        </button>
                        </div>
                </div>
                <div>
                    <button id="connect-whatsapp-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center mb-2">
                         <i class="fab fa-whatsapp mr-2"></i><span data-translate-key="settings_whatsapp">Conectarse a WhatsApp</span>
                    </button>
                    <a href="https://calendly.com/goatify" target="_blank" id="schedule-meeting-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar-alt mr-2"></i><span data-translate-key="settings_schedule_meeting">Agendar Reunión</span>
                     </a>
                </div>
            </div>
            <button id="close-settings-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>

    <div id="calendar-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div id="calendar-modal" class="modal-content rounded-lg w-full max-w-4xl p-6 relative">
             <h3 class="text-lg font-bold mb-4" data-translate-key="calendar_my_calendar">Mi Calendario y Tareas</h3>
            <div class="calendar-view-toggle mb-4">
                <button id="day-view-btn" data-translate-key="calendar_day_view">Vista de Día</button>
                <button id="week-view-btn" data-translate-key="calendar_week_view">Vista de Semana</button>
                <button id="month-view-btn" class="active" data-translate-key="calendar_month_view">Vista de Mes</button>
             </div>

            <div id="day-view-container">
                 <div class="calendar-header">
                    <button id="prev-day" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-day-display" class="text-xl font-semibold"></h4>
                     <button id="next-day" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="day-view-timeline"></div>
            </div>

            <div id="week-view-container">
                <div class="calendar-header">
                     <button id="prev-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-week-range" class="text-xl font-semibold"></h4>
                    <button id="next-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                 <div id="week-days-content"></div>
            </div>

            <div id="month-view-container">
                <div class="calendar-header">
                    <button id="prev-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-month-year" class="text-xl font-semibold"></h4>
                     <button id="next-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid mb-4">
                    <div class="font-bold text-primary" data-translate-key="calendar_mon">Lun</div>
                     <div class="font-bold text-primary" data-translate-key="calendar_tue">Mar</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_wed">Mié</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_thu">Jue</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_fri">Vie</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_sat">Sáb</div>
                     <div class="font-bold text-primary" data-translate-key="calendar_sun">Dom</div>
                </div>
                <div id="calendar-days-grid" class="calendar-grid"></div>
            </div>

            <div class="mt-6 border-t border-themed pt-4">
                <button id="add-task-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i><span data-translate-key="calendar_add_task_btn">Añadir Tarea</span>
                </button>
            </div>

            <button id="close-calendar-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>

    <div id="gamification-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-4">
                <h2 class="text-3xl font-extrabold text-gold">
                    <i class="fas fa-trophy mr-2"></i>La Ascensión del G.O.A.T.
                </h2>
                <button id="close-gamification-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>
            
            <div class="p-4 bg-input rounded-lg mb-4 flex-shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <span id="gamification-level-name" class="font-bold text-xl text-text-light">Nivel 1: Iniciador Digital</span>
                    <div class="text-right">
                        <span id="gamification-xp" class="font-bold text-primary">0 / 100 XP</span>
                         <p id="gamification-credits" class="text-sm text-gold font-semibold"><i class="fas fa-coins mr-1"></i>0 Créditos</p>
                    </div>
                </div>
                <div class="w-full xp-bar-bg rounded-full h-4">
                    <div id="gamification-xp-bar" class="xp-bar-fill h-4 rounded-full" style="width: 0%;"></div>
                 </div>
            </div>

            <div class="flex-grow overflow-hidden flex flex-col">
                <div class="flex-shrink-0 gamification-tabs flex items-center space-x-2">
                    <button class="gamification-tab active" data-tab="racha">Racha Diaria</button>
                     <button class="gamification-tab" data-tab="misiones">Misiones</button>
                    <button class="gamification-tab" data-tab="logros">Logros</button>
                    <button id="gamification-rules-btn" class="ml-auto text-sm text-text-medium hover:text-primary"><i class="fas fa-circle-question mr-1"></i> Reglas</button>
                </div>

                <div class="flex-grow overflow-y-auto pt-4">
                     <div id="gamification-tab-racha" class="gamification-tab-content space-y-4">
                        <p class="text-center text-text-medium">Mantén tu racha para ganar XP, créditos y un cofre especial el día 7.</p>
                         <div id="daily-streak-container" class="grid grid-cols-7 gap-2 md:gap-4 text-center">
                            </div>
                    </div>
                     <div id="gamification-tab-misiones" class="gamification-tab-content hidden space-y-3">
                        </div>
                     <div id="gamification-tab-logros" class="gamification-tab-content hidden">
                        <div id="achievements-container" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                           </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="gamification-rules-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-[60] p-4">
         <div class="modal-content rounded-lg w-full max-w-2xl p-6 relative">
            <h3 class="text-lg font-bold mb-4 text-gold"><i class="fas fa-scroll mr-2"></i>Reglas de "La Ascensión del GOAT"</h3>
            <div class="space-y-4 text-text-medium text-sm max-h-[70vh] overflow-y-auto pr-2">
                <p>¡Bienvenido a tu viaje para convertirte en un G.O.A.T. (Greatest Of All Time) del emprendimiento digital! La lógica es simple: cuanto más usas la plataforma de forma estratégica, más recompensas obtienes.</p>
                <div>
                    <h4 class="font-semibold text-text-light mt-3">1. Puntos de Experiencia (XP) vs. Créditos de Recompensa (🪙)</h4>
                    <p>Existen dos tipos de recompensas:</p>
                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li><strong>Puntos de Experiencia (XP):</strong> Miden tu progreso y maestría. El XP <strong class="text-primary">nunca se gasta</strong>, solo se acumula para que subas de nivel y desbloquees nuevos títulos.</li>
                        <li><strong>Créditos de Recompensa (🪙):</strong> Son una <strong class="text-gold">reserva de créditos utilizables</strong> que ganas al completar misiones y rachas. Cuando se agotan los créditos diarios de tu plan, el sistema usará automáticamente estos créditos de recompensa para que puedas seguir trabajando.</li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-semibold text-text-light mt-3">2. Cómo Subir de Nivel</h4>
                    <p>Acumula suficiente XP para ascender de nivel. Cada nivel representa una nueva etapa en tu dominio del marketing y los negocios con IA.</p>
                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li>Nivel 1: <strong>Iniciador Digital</strong></li>
                        <li>Nivel 2: <strong>Creador de Contenido</strong></li>
                         <li>Nivel 3: <strong>Estratega de Marketing</strong></li>
                        <li>Nivel 4: <strong>CEO Digital</strong></li>
                        <li>Nivel 5: <strong>G.O.A.T.</strong></li>
                    </ul>
                </div>
                  <div>
                    <h4 class="font-semibold text-text-light mt-3">3. Cómo Ganar Recompensas</h4>
                     <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li><strong>Racha Diaria:</strong> Cada día consecutivo que entras te da XP y Créditos de Recompensa.</li>
                        <li><strong>Cofre GOAT (Día 7):</strong> ¡Tu gran recompensa semanal por 7 días de racha! Puede contener una gran cantidad de créditos, <strong>cupones de descuento</strong> para nuestros servicios de implementación (páginas web, automatizaciones) o incluso una <strong>asesoría estratégica GRATIS</strong>.</li>
                        <li><strong>Misiones y Logros:</strong> La forma más rápida de ganar grandes bonificaciones de XP y Créditos. Completa tareas específicas para acelerar tu ascenso.</li>
                    </ul>
                </div>
                 <p class="font-bold text-center mt-4 text-lg text-primary">¡Cada acción cuenta en tu camino a la cima! ¡A por ello!</p>
            </div>
            <button id="close-gamification-rules-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        window.addEventListener('DOMContentLoaded', () => {
            dayjs.extend(window.dayjs_plugin_localizedFormat);
            dayjs.extend(window.dayjs_plugin_isoWeek);
             
            const translations = {
                es: {
                    initializing: "Inicializando...", new_chat: "Nuevo Chat", new_folder: "Nueva Carpeta",
                    web_offer: "🚀 ¡Lanza tu Negocio, te regalamos una pg web Gratis con tu suscripcion!",
                     upgrade_plan: "Mejorar Plan", free_guides: "Guías de IA Gratis", workflows: "Workflows",
                    wf_pm: "Dirección de Proyectos", wf_pm_1: "Crear Tablero de Proyecto",
                    wf_social: "Potenciador de Redes Sociales", wf_social_1: "Crear un Post Completo", wf_social_2: "Redacción de Copys",
                     wf_social_3: "Lluvia de Ideas para Posts", wf_social_4: "Definir Estrategia de Marca",
                    wf_business: "Análisis de Negocio", wf_business_1: "Análisis de tu Competencia", wf_business_2: "Definir mi Cliente Ideal",
                    wf_business_3: "Lluvia de Nombres para Marca", wf_sales: "Comunicación y Ventas", wf_sales_1: "Asistente de Ventas 24/7",
                     wf_sales_2: "Redacción de Email", wf_sales_3: "Diseño Web", wf_sales_4: "Mejorar Habilidades Sociales",
                    wf_eng_1: "Traducir/Corregir Texto",
                    wf_eng_2: "Aprender Vocabulario Nuevo", wf_eng_3: "Practicar Conversación", select_chats: "Seleccionar Múltiples Chats",
                    delete: "Borrar", login: "Iniciar Sesión", settings: "Configuración", logout: "Cerrar Sesión",
                     solutions: "Soluciones", ally_title: "Somos tu Aliado Estratégico",
                    ally_desc: "Goatify no es solo un chat. Somos una IA personalizada con un equipo de expertos listos para ayudarte a escalar tu negocio.",
                    welcome_user: "¡Hola, ", welcome_user_2: "! Hoy es un gran día para crear algo increíble.",
                    welcome_guest: "¿Cómo puedo ayudarte hoy?", model: "Modelo:", model_general: "GOAT X",
                    model_web: "Búsqueda Web", voice: "Voz:", placeholder_main: "Escribe tu mensaje...", cancel: "Cancelar",
                    confirm: "Confirmar", plans_title: "Planes Goatify", plan_free_sub: "Para Siempre", plan_free_cta: "Empezar Gratis",
                     plan_boost_cta: "Obtener Boost", plan_pro_cta: "Quiero mi Plan Pro + Web",
                    preview: "Vista Previa", settings_email: "Correo Electrónico:", settings_plan: "Plan de Suscripción:",
                    settings_fontsize: "Tamaño de Letra:", settings_theme: "Personalización:", settings_dark_mode: "Modo Oscuro",
                     settings_lang: "Idioma:", settings_whatsapp: "Conectarse a WhatsApp", current_plan: "Tu Plan Actual",
                    settings_notifications: "Notificaciones de Tareas:", settings_schedule_meeting: "Agendar Reunión",
                    settings_integrations: "Integraciones",
                    calendar_today: "Hoy", calendar_this_week: "Esta Semana", calendar_mon: "Lun", calendar_tue: "Mar", calendar_wed: "Mié",
                     calendar_thu: "Jue", calendar_fri: "Vie", calendar_sat: "Sáb", calendar_sun: "Dom",
                    calendar_no_tasks: "No hay tareas para este día.", calendar_add_task_placeholder: "Añadir nueva tarea personal...",
                    calendar_add_task_btn: "Añadir Tarea", calendar_my_calendar: "Mi Calendario y Tareas",
                    calendar_day_view: "Vista de Día", calendar_month_view: "Vista de Mes", calendar_week_view: "Vista de Semana",
                    notification_task_due: "Es hora de: ", notification_title: "Goatify IA - ¡Hora de tu Tarea!",
                    tasks_for: "Tareas para", add_task_for: "Añadir Tarea para",
                    delete_task_confirm_title: "Confirmar Eliminación", delete_task_confirm_body: "¿Estás seguro de que quieres eliminar esta tarea?",
                    delete_btn: "Eliminar",
                },
                en: {
                     initializing: "Initializing...", new_chat: "New Chat", new_folder: "New Folder",
                    web_offer: "🚀 Launch your Business, get a free website with your subscription!",
                    upgrade_plan: "Upgrade Plan", free_guides: "Free AI Guides", workflows: "Workflows",
                     wf_pm: "Project Management", wf_pm_1: "Create Project Board",
                    wf_social: "Social Media Booster", wf_social_1: "Create a Full Post", wf_social_2: "Copywriting",
                    wf_social_3: "Brainstorm Post Ideas", wf_social_4: "Define Brand Strategy",
                    wf_business: "Business Analysis", wf_business_1: "Analyze your Competition", wf_business_2: "Define my Ideal Customer",
                     wf_business_3: "Brainstorm Brand Names", wf_sales: "Communication & Sales", wf_sales_1: "24/7 Sales Assistant",
                    wf_sales_2: "Email Writing", wf_sales_3: "Web Design", wf_sales_4: "Improve Social Skills",
                    wf_eng_1: "Translate/Correct Text",
                    wf_eng_2: "Learn New Vocabulary", wf_eng_3: "Practice Conversation", select_chats: "Select Multiple Chats",
                    delete: "Delete", login: "Login", settings: "Settings", logout: "Logout",
                    solutions: "Solutions", ally_title: "We are your Strategic Ally",
                    ally_desc: "Goatify is not just a chat. We are a custom IA with a team of experts ready to help you scale your business.",
                    welcome_user: "Hello, ", welcome_user_2: "! Today is a great day to create something amazing.",
                    welcome_guest: "How can I help you today?", model: "Model:", model_general: "GOAT X",
                    model_web: "Web Search", voice: "Voice:", placeholder_main: "Type your message...", cancel: "Cancel",
                    confirm: "Confirm", plans_title: "Goatify Plans", plan_free_sub: "Forever", plan_free_cta: "Get Started for Free",
                    plan_boost_cta: "Get Boost", plan_pro_cta: "Get Pro Plan + Web",
                    preview: "Preview", settings_email: "Email Address:", settings_plan: "Subscription Plan:",
                    settings_fontsize: "Font Size:", settings_theme: "Personalization:", settings_dark_mode: "Dark Mode",
                     settings_lang: "Language:", settings_whatsapp: "Connect to WhatsApp", current_plan: "Current Plan",
                    settings_notifications: "Task Notifications:", settings_schedule_meeting: "Schedule Meeting",
                    settings_integrations: "Integrations",
                    calendar_today: "Today", calendar_this_week: "This Week", calendar_mon: "Mon", calendar_tue: "Tue", calendar_wed: "Wed",
                     calendar_thu: "Thu", calendar_fri: "Fri", calendar_sat: "Sat", calendar_sun: "Sun",
                    calendar_no_tasks: "No tasks for this day.", calendar_add_task_placeholder: "Add new personal task...",
                    calendar_add_task_btn: "Add Task", calendar_my_calendar: "My Calendar & Tasks",
                    calendar_day_view: "Day View", calendar_month_view: "Month View", calendar_week_view: "Week View",
                     notification_task_due: "Time for: ", notification_title: "Goatify IA - Task Due!",
                    tasks_for: "Tasks for", add_task_for: "Add Task for",
                    delete_task_confirm_title: "Confirm Deletion", delete_task_confirm_body: "Are you sure you want to delete this task?",
                    delete_btn: "Delete",
                }
            };
            const GUEST_CREDIT_LIMIT = 15;
            const FREE_PLAN_CREDIT_LIMIT = 15;
            const BOOST_PLAN_CREDIT_LIMIT = 100;
            const MOTIVATIONAL_MESSAGES = [
                "Eres una persona increíble, ¡nunca lo dudes!",
                "Hoy es tu día para brillar. ¡Ve por ello!",
                "Tu potencial es infinito. ¡Puedes lograr lo que te propongas!",
                "La rompes todos los días, ¡sigue así!",
                "Confía en tu proceso. Estás construyendo algo grandioso.",
                "Cada paso que das te acerca a tu meta. ¡No te detengas!",
                "Tu energía es contagiosa. ¡Ilumina el mundo!",
                "Puedes con todo y más. ¡Cree en ti!"
            ];
            const MOTIVATIONAL_BUTTON_TEXTS = [
                "¡Vamos a darle!",
                "¡Listo!",
                "¡Perfecto!",
                "¡Sí, yo puedo!",
                "¡A por todas!",
                "¡Entendido!"
            ];

            const COSTS = { GENERAL: 1, SEARCH: 1, NEBULA: 2, COPYWRITING: 2, IMAGE: 5 };
            let state = { chats: {}, projects: {}, structure: [], calendar: {} };
            let gamificationState = {};
            let currentChatId = null, currentUser = null, speechOn = false, availableVoices = [], selectedVoice = null, isRecognizing = false, selectedImageBase64 = null, selectedPdfText = null;
            let micWasOnBeforeSpeaking = false;
            let modalResolve = null;
            let isSelectModeActive = false;
            let chatsToDelete = new Set();
            
            let notificationsEnabled = localStorage.getItem('goatify-notifications-enabled') === null ? true : localStorage.getItem('goatify-notifications-enabled') === 'true';
            let motivationEnabled = localStorage.getItem('goatify-motivation-enabled') === null ? true : localStorage.getItem('goatify-motivation-enabled') === 'true';

            let selectedCalendarDate = dayjs();
            let currentCalendarView = 'month';
            let activeTagFilter = null;
            let motivationInterval = null;
            const dom = {};
            
            const fullDom = {
                appContainer: document.getElementById('app-container'),
                msgInput: document.getElementById('msg'), sendBtn: document.getElementById('send'),
                inputArea: document.getElementById('input-area'),
                messageCounterEl: document.getElementById('message-counter'), 
                upgradePlanContainer: document.getElementById('upgrade-plan-container'),
                 upgradePlanBtn: document.getElementById('upgrade-plan-btn'),
                newChatBtn: document.getElementById('new-chat-btn'), newFolderBtn: document.getElementById('new-folder-btn'),
                pricingModal: document.getElementById('pricing-modal'), closePricingModalBtn: document.getElementById('close-pricing-modal'),
                genericModal: document.getElementById('generic-modal'), 
                viewContainer: document.getElementById('view-container'),
                chatMessages: document.getElementById('chat-messages'),
                chatTitle: document.getElementById('chat-title'), mobileChatTitle: document.getElementById('mobile-chat-title'),
                 chatTitleWrapper: document.getElementById('chat-title-wrapper'), mobileChatTitleWrapper: document.getElementById('mobile-chat-title-wrapper'),
                initialMessageContainer: document.getElementById('initial-message-container'), themeToggle: document.getElementById('theme-toggle'), themeIcon: document.getElementById('theme-icon'),
                micBtn: document.getElementById('mic-btn'), ttsToggle: document.getElementById('tts-toggle'), 
                modelSelector: document.getElementById('model-selector'),
                actionButtonsContainer: document.getElementById('action-buttons-container'),
                imageUploadBtn: document.getElementById('image-upload-btn'), imageUploadInput: document.getElementById('image-upload'),
                imagePreviewContainer: document.getElementById('image-preview-container'), imagePreview: document.getElementById('image-preview'),
                 clearImageBtn: document.getElementById('clear-image-btn'), pdfUploadBtn: document.getElementById('pdf-upload-btn'), pdfUploadInput: document.getElementById('pdf-upload'),
                pdfPreviewContainer: document.getElementById('pdf-preview-container'), pdfNameEl: document.getElementById('pdf-name'), pdfStatusEl: document.getElementById('pdf-status'), clearPdfBtn: document.getElementById('clear-pdf-btn'),
                sidebar: document.getElementById('sidebar'), menuToggle: document.getElementById('menu-toggle'), sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarContent: document.getElementById('sidebar-content'), loginView: document.getElementById('login-view'), userMenuView: document.getElementById('user-menu-view'),
                loginBtn: document.getElementById('login-btn'), userMenuBtn: document.getElementById('user-menu-btn'), userMenuPopup: document.getElementById('user-menu-popup'), userEmail: document.getElementById('user-email'),
                 logoutBtn: document.getElementById('logout-btn'),
                workflowsContainer: document.getElementById('workflows-container'),
                personalizedWelcome: document.getElementById('personalized-welcome'), genericWelcome: document.getElementById('generic-welcome'), userName: document.getElementById('user-name'),
                loadingOverlay: document.getElementById('loading-overlay'), htmlPreviewModal: document.getElementById('html-preview-modal'),
                closeHtmlPreviewModalBtn: document.getElementById('close-html-preview-modal'), htmlPreviewIframe: document.getElementById('html-preview-iframe'),
                 voiceSelector: document.getElementById('voice-selector'), 
                 voiceSelectorContainer: document.getElementById('voice-selector-container'),
                selectChatsBtn: document.getElementById('select-chats-btn'), deleteModeControls: document.getElementById('delete-mode-controls'),
                deleteSelectedBtn: document.getElementById('delete-selected-btn'), cancelSelectModeBtn: document.getElementById('cancel-select-mode-btn'),
                imageGenBtn: document.getElementById('image-gen-btn'), servicesMenuBtn: document.getElementById('services-menu-btn'), servicesMenu: document.getElementById('services-menu'),
                contextualFooter: document.getElementById('contextual-footer'),
                newChatIconBtn: document.getElementById('new-chat-icon-btn'), settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'), closeSettingsModal: document.getElementById('close-settings-modal'),
                settingsUserEmail: document.getElementById('settings-user-email'), settingsUserPlan: document.getElementById('settings-user-plan'),
                settingsUpgradePlanBtn: document.getElementById('settings-upgrade-plan-btn'), fontSizeSlider: document.getElementById('font-size-slider'),
                 fontSizeValue: document.getElementById('font-size-value'), settingsThemeToggle: document.getElementById('settings-theme-toggle'),
                settingsThemeIcon: document.getElementById('settings-theme-icon'), languageSelector: document.getElementById('language-selector'),
                connectWhatsappBtn: document.getElementById('connect-whatsapp-btn'), scheduleMeetingBtn: document.getElementById('schedule-meeting-btn'), freePlanButton: document.getElementById('free-plan-button'),
                notificationsToggle: document.getElementById('notifications-toggle'),
                projectWorkflowHeader: document.getElementById('project-workflow-header'),
                sidebarToggleDesktop: document.getElementById('sidebar-toggle-desktop'),
                 mainChatArea: document.getElementById('main-chat-area'),

                // Calendar elements
                calendarModalOverlay: document.getElementById('calendar-modal-overlay'),
                calendarModal: document.getElementById('calendar-modal'),
                calendarBtn: document.getElementById('calendar-btn'),
                closeCalendarModal: document.getElementById('close-calendar-modal'),
                 prevMonthBtn: document.getElementById('prev-month'), nextMonthBtn: document.getElementById('next-month'),
                currentMonthYear: document.getElementById('current-month-year'), calendarDaysGrid: document.getElementById('calendar-days-grid'),
                addTaskBtn: document.getElementById('add-task-btn'),
                notificationBadge: document.getElementById('notification-badge'),
                inAppNotification: document.getElementById('in-app-notification'), 
                inAppNotificationTitle: document.getElementById('in-app-notification-title'),
                inAppNotificationBody: document.getElementById('in-app-notification-body'),
                inAppNotificationClose: document.getElementById('in-app-notification-close'),
                 monthViewContainer: document.getElementById('month-view-container'), weekViewContainer: document.getElementById('week-view-container'),
                dayViewContainer: document.getElementById('day-view-container'),
                monthViewBtn: document.getElementById('month-view-btn'), weekViewBtn: document.getElementById('week-view-btn'), dayViewBtn: document.getElementById('day-view-btn'),
                prevWeekBtn: document.getElementById('prev-week'), nextWeekBtn: document.getElementById('next-week'),
                currentWeekRange: document.getElementById('current-week-range'), weekDaysContent: document.getElementById('week-days-content'),
                 prevDayBtn: document.getElementById('prev-day'), nextDayBtn: document.getElementById('next-day'),
                currentDayDisplay: document.getElementById('current-day-display'), dayViewTimeline: document.getElementById('day-view-timeline'),

                // Project Management elements
                projectManagementView: document.getElementById('project-management-view'),
                projectBoardContainer: document.getElementById('project-board-container'),
                projectChatContainer: document.getElementById('project-chat-container'),
                 projectChatToggle: document.getElementById('project-chat-toggle'),
                 projectChatHeader: document.getElementById('project-chat-container-header'),
                projectViewTitle: document.getElementById('project-view-title'),
                kanbanView: document.getElementById('kanban-view'),
                listView: document.getElementById('list-view'),
                listViewMobile: document.getElementById('list-view-mobile'),
                viewToggleKanban: document.getElementById('view-toggle-kanban'),
                 viewToggleList: document.getElementById('view-toggle-list'),
                addTaskListViewBtn: document.getElementById('add-task-list-view-btn'),
                projectChatMessages: document.getElementById('project-chat-messages'),
                projectMsgInput: document.getElementById('project-msg'),
                projectSendBtn: document.getElementById('project-send'),
                projectCalendarBtn: document.getElementById('project-calendar-btn'),
                tagFilterBtn: document.getElementById('tag-filter-btn'),
                 tagFilterDropdown: document.getElementById('tag-filter-dropdown'),

                // Financial Assistant
                financialAssistantView: document.getElementById('financial-assistant-view'),

                // Gamification Elements
                gamificationBtn: document.getElementById('gamification-btn'),
                gamificationModal: document.getElementById('gamification-modal'),
                closeGamificationModal: document.getElementById('close-gamification-modal'),
                gamificationLevelName: document.getElementById('gamification-level-name'),
                 gamificationXp: document.getElementById('gamification-xp'),
                gamificationCredits: document.getElementById('gamification-credits'),
                gamificationXpBar: document.getElementById('gamification-xp-bar'),
                dailyStreakContainer: document.getElementById('daily-streak-container'),
                missionsContainer: document.getElementById('gamification-tab-misiones'),
                 achievementsContainer: document.getElementById('achievements-container'),
                gamificationRulesBtn: document.getElementById('gamification-rules-btn'),
                gamificationRulesModal: document.getElementById('gamification-rules-modal'),
                closeGamificationRulesModal: document.getElementById('close-gamification-rules-modal'),

                // Motivation Elements
                motivationBtnHeader: document.getElementById('motivation-btn-header'),
                motivationBtnMobile: document.getElementById('motivation-btn-mobile'),
                motivationModal: document.getElementById('motivation-modal'),
                motivationQuote: document.getElementById('motivation-quote'),
                motivationToggle: document.getElementById('motivation-toggle'),
                closeMotivationModal: document.getElementById('close-motivation-modal'),
            };
            Object.assign(dom, fullDom);

            // --- GAMIFICATION CONFIG ---
            const XP_FOR_LEVEL = [0, 250, 750, 2000, 5000, Infinity]; 
            const LEVEL_NAMES = ["Iniciador Digital", "Creador de Contenido", "Estratega de Marketing", "CEO Digital", "G.O.A.T."];
            const MISSIONS = {
                'brand-strategy': { id: 'brand-strategy', text: 'Define tu primera estrategia de marca', xp: 50, credits: 15, workflow: 'brand-strategy' },
                'competitor-analysis': { id: 'competitor-analysis', text: 'Espía a la competencia por primera vez', xp: 50, credits: 15, workflow: 'competitor-analysis' },
                'week-organized': { id: 'week-organized', text: 'Crea una tarea para cada día de la semana', xp: 75, credits: 25, condition: checkWeekOrganized },
                'project-created': { id: 'project-created', text: 'Crea tu primer proyecto y añade 3 tareas', xp: 100, credits: 30, condition: (chatId) => checkProjectCreated(chatId, 3) },
                'image-generated': { id: 'image-generated', text: 'Genera tu primera imagen con IA', xp: 40, credits: 10, action: 'generateImage' },
                'english-practice': { id: 'english-practice', text: 'Practica tu conversación en inglés', xp: 30, credits: 10, workflow: 'english-teacher-practice' },
                'social-skills': { id: 'social-skills', text: 'Mejora tus habilidades sociales con un consejo de IA', xp: 30, credits: 10, workflow: 'social-skills' },
                'conflict-resolution': { id: 'conflict-resolution', text: 'Analiza tu primer conflicto con IA', xp: 40, credits: 15, workflow: 'conflict-resolution' },
                'decision-lab': { id: 'decision-lab', text: 'Usa el Laboratorio de Decisiones', xp: 50, credits: 20, workflow: 'decision-lab' },
            };
            const ACHIEVEMENTS = {
                'streak-30': { id: 'streak-30', title: 'Consistencia', description: 'Mantén la racha diaria por 30 días.', icon: 'fa-calendar-check', xp: 500, credits: 250 },
                'project-master': { id: 'project-master', title: 'Project Master', description: 'Completa 10 proyectos.', icon: 'fa-sitemap', xp: 1000, credits: 0, reward: '50% de descuento en consultoría de automatización.' },
                'influencer': { id: 'influencer', title: 'Influencer', description: 'Genera 50 publicaciones para redes sociales.', icon: 'fa-bullhorn', xp: 750, credits: 0, reward: 'Un mes de GOAT Boost gratis.' },
            };
            // --- END GAMIFICATION CONFIG ---

            function setLanguage(lang) {
                const translationData = translations[lang];
                if (!translationData) return;
                dayjs.locale(lang);
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    if (translationData[key]) {
                        if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') {
                             if(el.placeholder) el.placeholder = translationData[key];
                        } else {
                             const icon = el.querySelector('i');
                            if (icon && el.childNodes.length > 1 && !el.classList.contains('notification-bell-icon')) {
                                const textNode = document.createTextNode(' ' + translationData[key]);
                                el.innerHTML = '';
                                el.appendChild(icon);
                                el.appendChild(textNode);
                             } else {
                                el.textContent = translationData[key];
                            }
                        }
                     }
                });
                document.documentElement.lang = lang;
                localStorage.setItem('goatify-lang', lang);
                renderCalendarView();
            }
            
            function updateContextualFooter(workflowKey) {
                if (!dom.contextualFooter) return;
                const workflowTexts = {
                    'create-full-post': 'Modo Redes Sociales: Define tu red social y tema para un post completo.',
                    'persuasive-copy': 'Modo Copywriter: Dime qué vendes y para dónde es el texto.',
                    'brand-strategy': 'Modo Estratega: Dime el nombre y rubro de tu negocio para empezar.',
                     'competitor-analysis': 'Modo Analista: Pega la URL de tu competencia para investigarla.',
                    'sales-assistant': 'Modo Asistente de Ventas: Pega el mensaje de tu cliente para responder.',
                    'english-teacher-practice': 'Practice mode: Let\'s talk. How was your day?',
                    'design-web': 'Modo Diseñador Web: Describe el componente visual y lo crearé en HTML.',
                    'project-management': 'Modo Director de Proyectos: Describe tu proyecto para crear tareas en el tablero.',
                    'conflict-resolution': 'Modo Mediador: Describe la situación de conflicto para encontrar una solución.',
                    'decision-lab': 'Modo Estratega: Describe la decisión que enfrentas y tus opciones.',
                    'financial-assistant': 'Modo Financiero: Usa la tabla para registrar transacciones. Pídeme análisis en el chat.',
                };
                const currentChat = state.chats[currentChatId];
                const key = workflowKey || (currentChat ? currentChat.workflow : null);
                dom.contextualFooter.textContent = workflowTexts[key] || 'Tu copiloto de IA para hacer crecer tu negocio.';
            }

            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            function showModal({ title, body, confirmText = 'Confirmar', cancelText = 'Cancelar', showCancel = true, showConfirm = true, extraButtons = [], dangerConfirm = false }) {
                const modalTitle = dom.genericModal.querySelector('#modal-title');
                const modalBody = dom.genericModal.querySelector('#modal-body');
                const modalButtonsContainer = dom.genericModal.querySelector('#modal-buttons-container');
                
                modalTitle.innerHTML = title; 
                modalBody.innerHTML = body;
                
                let buttonsHTML = '';
                extraButtons.forEach(btn => {
                    buttonsHTML += `<button id="${btn.id}" class="${btn.classes || 'px-4 py-2 rounded bg-gray-500 text-white'}">${btn.text}</button>`;
                });
                if (showCancel) {
                    buttonsHTML += `<button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded">${cancelText}</button>`;
                }
                if (showConfirm) {
                    const confirmClasses = dangerConfirm ? 'btn-danger' : 'btn-primary';
                    buttonsHTML += `<button id="modal-confirm" class="px-4 py-2 rounded text-white ${confirmClasses}">${confirmText}</button>`;
                }
                modalButtonsContainer.innerHTML = buttonsHTML;

                if (showConfirm) {
                    dom.genericModal.querySelector('#modal-confirm').addEventListener('click', (e) => {
                        const inputs = modalBody.querySelectorAll('input, textarea, select');
                        const data = {};
                        inputs.forEach(input => {
                            data[input.id] = input.type === 'checkbox' ? input.checked : input.value;
                        });
                        // Allow button's own action to proceed if it exists
                        const confirmBtn = e.currentTarget;
                        if (!confirmBtn.dataset.hasAction) {
                            hideModal({ confirmed: true, data });
                        }
                    }, { once: true });
                }

                if (showCancel) {
                    dom.genericModal.querySelector('#modal-cancel').addEventListener('click', () => hideModal({ confirmed: false }), { once: true });
                }
                extraButtons.forEach(btn => {
                    const btnEl = dom.genericModal.querySelector(`#${btn.id}`);
                    btnEl.addEventListener('click', (e) => {
                         btn.action(e, modalBody);
                    });
                });
                
                dom.genericModal.classList.remove('hidden');
                dom.genericModal.classList.add('flex');
                
                return new Promise(resolve => { modalResolve = resolve; });
            }
            function hideModal(resolveWith = null) { if(modalResolve) { modalResolve(resolveWith); modalResolve = null; } dom.genericModal.classList.add('hidden'); dom.genericModal.classList.remove('flex');  }
            
            function showPricingModal() { 
                dom.pricingModal.classList.remove('hidden');
                dom.pricingModal.classList.add('flex'); 
                setTimeout(() => { dom.pricingModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
                
                const lang = localStorage.getItem('goatify-lang') || 'es';
                const isFree = !currentUser || (currentUser.app_metadata?.plan || 'free') === 'free';
                
                if (isFree) {
                    dom.freePlanButton.textContent = translations[lang].current_plan;
                    dom.freePlanButton.disabled = true;
                    dom.freePlanButton.classList.add('btn-disabled');
                } else {
                    dom.freePlanButton.textContent = translations[lang].plan_free_cta;
                    dom.freePlanButton.disabled = false;
                    dom.freePlanButton.classList.remove('btn-disabled');
                }
            }
            function hidePricingModal() { dom.pricingModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => { dom.pricingModal.classList.add('hidden'); dom.pricingModal.classList.remove('flex'); }, 300); }

            function showSettingsModal() {
                dom.settingsModal.classList.remove('hidden');
                dom.settingsModal.classList.add('flex');
                if (currentUser) {
                    dom.settingsUserEmail.textContent = currentUser.email;
                    const userPlan = currentUser.app_metadata?.plan || 'free';
                    dom.settingsUserPlan.textContent = userPlan.charAt(0).toUpperCase() + userPlan.slice(1);
                    dom.settingsUpgradePlanBtn.classList.toggle('hidden', userPlan !== 'free');
                } else {
                    dom.settingsUserEmail.textContent = 'Not logged in';
                    dom.settingsUserPlan.textContent = 'Free (Guest)';
                    dom.settingsUpgradePlanBtn.classList.remove('hidden');
                }
                dom.fontSizeSlider.value = parseInt(getComputedStyle(document.body).getPropertyValue('--base-font-size')) || 15;
                dom.fontSizeValue.textContent = `${dom.fontSizeSlider.value}px`;
                dom.settingsThemeIcon.className = `fas fa-${document.body.classList.contains('dark-theme') ? 'moon' : 'sun'} mr-2`;
                dom.languageSelector.value = localStorage.getItem('goatify-lang') || 'es';
                dom.notificationsToggle.checked = notificationsEnabled;
            }

            function hideSettingsModal() {
                dom.settingsModal.classList.add('hidden');
                dom.settingsModal.classList.remove('flex');
            }

            function showInAppNotification(title, body, duration = 5000) {
                dom.inAppNotificationTitle.innerHTML = title;
                dom.inAppNotificationBody.innerHTML = body;
                dom.inAppNotification.classList.add('show');

                const close = () => {
                    dom.inAppNotification.classList.remove('show');
                };

                const timer = setTimeout(close, duration);
                
                const closeBtn = dom.inAppNotification.querySelector('#in-app-notification-close');
                const clickHandler = () => {
                    clearTimeout(timer);
                    close();
                    closeBtn.removeEventListener('click', clickHandler);
                };
                closeBtn.addEventListener('click', clickHandler, { once: true });
            }

            function showCalendarModal() {
                dom.calendarModalOverlay.classList.remove('hidden');
                dom.calendarModalOverlay.classList.add('flex');
                if (!currentCalendarView) currentCalendarView = 'month'; 
                renderCalendarView();
            }

            function hideCalendarModal() {
                dom.calendarModalOverlay.classList.add('hidden');
                dom.calendarModalOverlay.classList.remove('flex');
            }function renderMonthView() {
                dom.calendarDaysGrid.innerHTML = '';
                dom.currentMonthYear.textContent = selectedCalendarDate.format('MMMM YYYY');
                const startDay = selectedCalendarDate.startOf('month').startOf('isoWeek');

                for (let i = 0; i < 42; i++) {
                    const day = startDay.add(i, 'day');
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.dataset.date = day.format('YYYY-MM-DD');

                    dayEl.innerHTML = `<span class="calendar-day-number">${day.date()}</span><div class="calendar-day-tasks"></div>`;

                    if (day.month() === selectedCalendarDate.month()) {
                        dayEl.classList.add('current-month');
                    } else {
                        dayEl.classList.add('other-month');
                    }
                    if (day.isSame(dayjs(), 'day')) {
                        dayEl.classList.add('today');
                    }

                    const tasksContainer = dayEl.querySelector('.calendar-day-tasks');
                    const tasksForDay = getTasksForDay(day.format('YYYY-MM-DD'));
                    tasksForDay.slice(0, 3).forEach(task => { // Limit to 3 tasks to avoid clutter
                        const taskEl = document.createElement('div');
                        taskEl.className = 'calendar-day-task';
                        taskEl.textContent = task.text;
                        taskEl.style.backgroundColor = getLabelColor(task.source === 'Personal' ? 'Personal' : (task.labels && task.labels[0] ? task.labels[0] : 'default'));
                        taskEl.draggable = true;
                        taskEl.dataset.taskId = task.id;
                        taskEl.dataset.taskSource = task.source;
                        taskEl.innerHTML = `
                            ${task.text}
                            <i class="fas fa-times delete-task-icon" data-task-id="${task.id}" data-task-source="${task.source}"></i>
                        `;
                        tasksContainer.appendChild(taskEl);
                    });

                    dayEl.addEventListener('click', (e) => {
                        if(e.target.classList.contains('delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(e.target.dataset.taskId);
                        } else if(e.target === e.currentTarget || e.target.classList.contains('calendar-day-tasks')) {
                             editCalendarTask(null, day.format('YYYY-MM-DD'));
                        } else if(e.target.closest('.calendar-day-task')) {
                            const taskEl = e.target.closest('.calendar-day-task');
                            handleTaskClick(taskEl.dataset.taskId, taskEl.dataset.taskSource);
                        }
                    });
                    dayEl.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    dayEl.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    dayEl.addEventListener('drop', handleCalendarDrop);
                    tasksContainer.querySelectorAll('.calendar-day-task').forEach(t => t.addEventListener('dragstart', handleCalendarDragStart));
                    tasksContainer.querySelectorAll('.calendar-day-task').forEach(t => t.addEventListener('touchstart', handleTouchStart, {passive: false}));

                    dom.calendarDaysGrid.appendChild(dayEl);
                }
            }
            
            function renderWeekView() {
                dom.weekDaysContent.innerHTML = '';
                let startOfWeek = selectedCalendarDate.startOf('isoWeek');

                const endOfWeek = startOfWeek.add(6, 'day');
                dom.currentWeekRange.textContent = `${startOfWeek.format('D MMM')} - ${endOfWeek.format('D MMM, YYYY')}`;

                for (let i = 0; i < 7; i++) {
                    const day = startOfWeek.add(i, 'day');
                    const dayKey = day.format('YYYY-MM-DD');
                    const tasks = getTasksForDay(dayKey);
                    const lang = localStorage.getItem('goatify-lang') || 'es';
                    const displayDate = day.format('dddd, D MMM');
                    const daySection = document.createElement('div');
                    daySection.className = 'week-day-section';
                    daySection.dataset.date = dayKey;

                    daySection.innerHTML = `
                        <h5>
                            <span>${displayDate}</span>
                            <button class="add-task-to-day-btn text-lg hover:text-primary" data-date="${dayKey}">+</button>
                        </h5>
                        <div class="space-y-1">
                            ${tasks.length === 0 ? `<p class="text-xs text-text-medium italic">${translations[lang].calendar_no_tasks}</p>` : ''}
                            ${tasks.map((task) => {
                                const isPersonal = task.source === 'Personal';
                                return `
                                <div class="task-item flex items-center gap-2 cursor-pointer ${task.completed ? 'task-item-completed' : ''}" 
                                     draggable="true" data-task-id="${task.id}" data-task-source="${task.source}">
                                     <input type="checkbox" class="task-checkbox flex-shrink-0" data-task-id="${task.id}" ${task.completed ? 'checked' : ''}>
                                    <span class="flex-grow">${task.text} ${task.time ? `(${task.time})` : ''} <span class="text-xs text-primary">(${task.source})</span></span>
                                    <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            `}).join('')}
                        </div>
                     `;
                    dom.weekDaysContent.appendChild(daySection);
                    daySection.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    daySection.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    daySection.addEventListener('drop', handleCalendarDrop);
                    daySection.addEventListener('click', (e) => {
                         if(e.target === e.currentTarget || e.target.classList.contains('space-y-1')) {
                            editCalendarTask(null, dayKey);
                        }
                    });
                }

                dom.weekDaysContent.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        updateTaskStatus(e.currentTarget.dataset.taskId, { completed: e.currentTarget.checked });
                    });
                 });

                dom.weekDaysContent.querySelectorAll('.task-item').forEach(item => {
                    item.addEventListener('dragstart', handleCalendarDragStart);
                    item.addEventListener('touchstart', handleTouchStart, {passive: false});
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(item.dataset.taskId);
                            return;
                        }
                        if (e.target.type === 'checkbox') return;
                        handleTaskClick(item.dataset.taskId, item.dataset.taskSource);
                     });
                });
                dom.weekDaysContent.querySelectorAll('.add-task-to-day-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const date = e.currentTarget.dataset.date;
                        editCalendarTask(null, date);
                    });
                });
            }

            function renderDayView() {
                dom.currentDayDisplay.textContent = selectedCalendarDate.format('dddd, D [de] MMMM');
                dom.dayViewTimeline.innerHTML = '';
                const tasksForDay = getTasksForDay(selectedCalendarDate.format('YYYY-MM-DD'));
                
                for (let hour = 0; hour < 24; hour++) {
                    const hourEl = document.createElement('div');
                    hourEl.className = 'day-view-hour';
                    const hourLabel = (hour < 10 ? '0' : '') + hour + ':00';
                    hourEl.dataset.time = hourLabel.substring(0,2); // "09"
                    const tasksInHour = tasksForDay.filter(t => t.time && t.time.startsWith((hour < 10 ? '0' : '') + hour));
                    hourEl.innerHTML = `
                        <div class="day-view-hour-label">${hourLabel}</div>
                        <div class="day-view-hour-content" data-time="${hourLabel}" data-date="${selectedCalendarDate.format('YYYY-MM-DD')}">
                            ${tasksInHour.map(task => {
                                return `
                                 <div class="task-item flex items-center gap-2 p-1 rounded-md ${task.completed ? 'bg-green-900/50 text-gray-400 line-through' : 'bg-input'} text-sm" 
                                    draggable="true" data-task-id="${task.id}" data-task-source="${task.source}">
                                    <input type="checkbox" class="task-checkbox flex-shrink-0" data-task-id="${task.id}" ${task.completed ? 'checked' : ''}>
                                     <span class="flex-grow cursor-pointer"><strong>${task.time}:</strong> ${task.text} <span class="text-xs text-primary">(${task.source})</span></span>
                                     <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1"><i class="fas fa-trash-alt"></i></button>
                                </div>
                                `
                            }).join('')}
                             <button class="add-task-to-time-btn text-lg hover:text-primary" data-date="${selectedCalendarDate.format('YYYY-MM-DD')}" data-time="${hourLabel}">+</button>
                        </div>
                    `;
                    dom.dayViewTimeline.appendChild(hourEl);

                    const hourContent = hourEl.querySelector('.day-view-hour-content');
                    hourContent.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    hourContent.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    hourContent.addEventListener('drop', handleCalendarDrop);
                     hourContent.addEventListener('click', (e) => {
                         if(e.target === e.currentTarget) {
                            editCalendarTask(null, selectedCalendarDate.format('YYYY-MM-DD'), e.currentTarget.dataset.time);
                        }
                    });
                }
                dom.dayViewTimeline.querySelectorAll('.add-task-to-time-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const date = e.currentTarget.dataset.date;
                         const time = e.currentTarget.dataset.time;
                        editCalendarTask(null, date, time);
                    });
                });
                dom.dayViewTimeline.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        updateTaskStatus(e.currentTarget.dataset.taskId, { completed: e.currentTarget.checked });
                    });
                });
                dom.dayViewTimeline.querySelectorAll('.task-item').forEach(item => {
                    item.addEventListener('dragstart', handleCalendarDragStart);
                    item.addEventListener('touchstart', handleTouchStart, {passive: false});
                    item.addEventListener('click', (e) => {
                         if (e.target.closest('.delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(item.dataset.taskId);
                            return;
                        }
                        if (e.target.type === 'checkbox') return;
                        handleTaskClick(item.dataset.taskId, item.dataset.taskSource);
                    });
                 });
            }

            function handleTaskClick(taskId, taskSource) {
                 if (taskSource === 'Personal') {
                    editCalendarTask(taskId);
                } else {
                    const projectChat = Object.values(state.chats).find(c => c.projectData && c.projectData.title === taskSource);
                    if (projectChat) {
                        editProjectTask(projectChat.id, taskId);
                    }
                }
            }
            
            let draggedCalendarTaskId = null;
            function handleCalendarDragStart(e) {
                const target = e.target.closest('[draggable="true"]');
                if (!target) return;
                draggedCalendarTaskId = target.dataset.taskId;
                e.dataTransfer.setData('text/plain', draggedCalendarTaskId);
                e.dataTransfer.effectAllowed = 'move';
            }
            
            function handleCalendarDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.style.backgroundColor = '';
                const taskId = e.dataTransfer.getData('text/plain');
                if (!taskId) return;

                const dropZone = e.currentTarget;
                const newDate = dropZone.dataset.date;
                let newTime = dropZone.dataset.time || findTask(taskId)?.task?.time || null; 
                
                if (newTime && newTime.length === 2) {
                   const originalTask = findTask(taskId)?.task;
                   const originalMinutes = originalTask?.time?.substring(3,5) || '00';
                   newTime = `${newTime}:${originalMinutes}`;
                }
                
                const updates = { date: newDate, time: newTime };
                updateTaskStatus(taskId, updates);
            }

            let touchDragElement = null, ghostElement = null;
            function handleTouchStart(e) {
                if (e.touches.length !== 1) return;
                const target = e.target.closest('[draggable="true"]');
                if (!target) return;
                
                touchDragElement = target;
                
                ghostElement = touchDragElement.cloneNode(true);
                ghostElement.style.position = 'absolute';
                ghostElement.style.zIndex = '1000';
                ghostElement.style.opacity = '0.7';
                ghostElement.style.pointerEvents = 'none';
                ghostElement.style.width = `${touchDragElement.offsetWidth}px`;
                document.body.appendChild(ghostElement);
                
                const touch = e.touches[0];
                ghostElement.style.left = `${touch.pageX - ghostElement.offsetWidth / 2}px`;
                ghostElement.style.top = `${touch.pageY - ghostElement.offsetHeight / 2}px`;

                document.addEventListener('touchmove', handleTouchMove, {passive: false});
                document.addEventListener('touchend', handleTouchEnd);
            }
            function handleTouchMove(e) {
                if (e.touches.length !== 1 || !ghostElement) return;
                e.preventDefault();
                const touch = e.touches[0];
                ghostElement.style.left = `${touch.pageX - ghostElement.offsetWidth / 2}px`;
                ghostElement.style.top = `${touch.pageY - ghostElement.offsetHeight / 2}px`;
            }
            function handleTouchEnd(e) {
                if (!ghostElement) return;
                
                ghostElement.style.display = 'none';
                const dropTarget = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
                ghostElement.remove();
                
                if (dropTarget) {
                    const dropZone = dropTarget.closest('.calendar-day, .week-day-section, .day-view-hour-content, .kanban-cards, .list-view-column-mobile');
                    if(dropZone) {
                        const taskId = touchDragElement.dataset.taskId;
                        if (dropZone.classList.contains('kanban-cards')) {
                            const chatId = currentChatId;
                            const columnId = dropZone.dataset.columnId;
                            moveTask(chatId, taskId, columnId);
                        } else if(dropZone.classList.contains('list-view-column-mobile')) {
                            const chatId = currentChatId;
                            const columnId = dropZone.dataset.columnId;
                            moveTask(chatId, taskId, columnId);
                        }
                        else {
                            const newDate = dropZone.dataset.date;
                            let newTime = dropZone.dataset.time || findTask(taskId)?.task?.time || null;
                            if (newTime && newTime.length === 2) {
                                const originalTask = findTask(taskId)?.task;
                                const originalMinutes = originalTask?.time?.substring(3,5) || '00';
                                newTime = `${newTime}:${originalMinutes}`;
                            }
                            updateTaskStatus(taskId, { date: newDate, time: newTime });
                        }
                    }
                }
                
                touchDragElement = null; ghostElement = null;
                document.removeEventListener('touchmove', handleTouchMove);
                document.removeEventListener('touchend', handleTouchEnd);
            }
            // --- End Touch Drag Simulation ---

            function findTask(taskId) {
                if (!taskId) return null;
                if (taskId.startsWith('cal-')) {
                    for (const dayKey in state.calendar) {
                        const taskIndex = (state.calendar[dayKey] || []).findIndex(t => t.id === taskId);
                        if (taskIndex > -1) {
                            return { type: 'personal', task: state.calendar[dayKey][taskIndex], dayKey, taskIndex };
                        }
                    }
                } else if (taskId.startsWith('proj-')) {
                    for (const chat of Object.values(state.chats)) {
                        if (chat.projectData && chat.projectData.columns) {
                            for (const column of chat.projectData.columns) {
                                const taskIndex = (column.tasks || []).findIndex(t => t.id === taskId);
                                if (taskIndex > -1) {
                                     return { type: 'project', task: column.tasks[taskIndex], chat, column, taskIndex };
                                }
                            }
                        }
                    }
                }
                return null;
            }

            function updateTaskStatus(taskId, updates) {
                const found = findTask(taskId);
                if (!found) return;

                if (found.type === 'personal') {
                    const { task, dayKey } = found;
                    const oldDate = dayKey;
                    const newDate = updates.date || oldDate;
                    
                    if (oldDate !== newDate) {
                        const taskIndex = state.calendar[oldDate].findIndex(t => t.id === taskId);
                        const [taskToMove] = state.calendar[oldDate].splice(taskIndex, 1);
                        if(state.calendar[oldDate].length === 0) delete state.calendar[oldDate];
                        
                        if (!state.calendar[newDate]) state.calendar[newDate] = [];
                        Object.assign(taskToMove, updates);
                        delete taskToMove.date;
                        state.calendar[newDate].push(taskToMove);
                    } else {
                        delete updates.date;
                        Object.assign(task, updates);
                    }
                } 
                else if (found.type === 'project') {
                    const { task, chat } = found;
                    const originalCompleted = task.completed;
                    Object.assign(task, updates);

                    if (updates.completed !== undefined && updates.completed !== originalCompleted) {
                        let sourceColumn, taskIndex;
                        for(const col of chat.projectData.columns){
                            const idx = (col.tasks || []).findIndex(t => t.id === taskId);
                            if(idx > -1){
                                sourceColumn = col;
                                taskIndex = idx;
                                break;
                            }
                        }

                        if (sourceColumn) {
                            const [taskToMove] = sourceColumn.tasks.splice(taskIndex, 1);
                            if (task.completed) {
                                const doneColumn = chat.projectData.columns.find(c => c.id === 'done');
                                if (doneColumn && sourceColumn.id !== 'done') doneColumn.tasks.push(taskToMove);
                                else sourceColumn.tasks.push(taskToMove); // remain if already in done
                            } else {
                                const todoColumn = chat.projectData.columns.find(c => c.id === 'todo');
                                if (todoColumn && sourceColumn.id === 'done') todoColumn.tasks.push(taskToMove);
                                else sourceColumn.tasks.push(taskToMove);
                            }
                        }
                    }
                }

                saveState();
                if (dom.calendarModalOverlay.classList.contains('flex')) {
                    renderCalendarView();
                }
                if (dom.projectManagementView.style.display === 'flex') {
                    renderProjectBoard(currentChatId);
                }
            }


            function getTasksForDay(dayKey) {
                const calendarTasks = (state.calendar[dayKey] || []).map(t => ({...t, text: t.content, source: 'Personal'}));
                const projectTasks = [];
                Object.values(state.chats).forEach(chat => {
                    if (chat.projectData && chat.projectData.columns) {
                        chat.projectData.columns.forEach(column => {
                            (column.tasks || []).forEach(task => {
                                 if (task.dueDate === dayKey) {
                                    projectTasks.push({...task, source: chat.projectData.title, text: task.content});
                                }
                             });
                        });
                    }
                });
                return [...calendarTasks, ...projectTasks].sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
            }

            function updateNotificationBadge() {
                 let pendingNotifications = 0;
                const now = dayjs();
                Object.keys(state.calendar).forEach(dayKey => {
                    const tasksForDay = getTasksForDay(dayKey);
                    tasksForDay.forEach(task => {
                         if (!task.completed) {
                            if (task.time) {
                                const taskDateTime = dayjs(`${dayKey}T${task.time}`);
                                if (taskDateTime.isBefore(now)) {
                                     pendingNotifications++;
                                }
                            } else {
                                const taskDate = dayjs(dayKey);
                                if (taskDate.isBefore(now, 'day') || taskDate.isSame(now, 'day')) {
                                    pendingNotifications++;
                                }
                            }
                         }
                    });
                });
                
                const badgeContent = pendingNotifications > 0 ? pendingNotifications : '';
                const isHidden = pendingNotifications === 0;

                dom.notificationBadge.textContent = badgeContent;
                dom.notificationBadge.classList.toggle('hidden', isHidden);
            }

            function checkAndNotifyTasks() {
                if (!notificationsEnabled) return;
                const now = dayjs();
                const todayKey = now.format('YYYY-MM-DD');
                const currentHourMinute = now.format('HH:mm');
                const allTasksToday = getTasksForDay(todayKey);
                allTasksToday.forEach(task => {
                    if (!task.completed && task.time === currentHourMinute && !task.notifiedThisMinute) {
                        const lang = localStorage.getItem('goatify-lang') || 'es';
                        const notificationTitle = translations[lang].notification_title;
                        const notificationBody = `${translations[lang].notification_task_due} ${task.text} (${task.time})`;
                        
                        showInAppNotification(
                            `<i class="fas fa-bell animate-tada text-yellow-400 mr-2"></i> ${notificationTitle}`,
                            `<p class="text-md">${notificationBody}</p>`
                        );

                        if (Notification.permission === "granted") {
                            new Notification(notificationTitle, {
                                 body: notificationBody,
                                icon: './Logos HD.png'
                            });
                        }
                        
                        updateTaskNotifiedFlag(task.id, true);
                    }
                });
                allTasksToday.forEach(task => {
                    if (task.notifiedThisMinute && task.time !== currentHourMinute) {
                        updateTaskNotifiedFlag(task.id, false);
                    }
                });
                saveState();
                updateNotificationBadge();
            }

            function updateTaskNotifiedFlag(taskId, isNotified) {
                const found = findTask(taskId);
                if (found) {
                    found.task.notifiedThisMinute = isNotified;
                }
            }


            function renderCalendarView() {
                 dom.dayViewContainer.style.display = currentCalendarView === 'day' ? 'block' : 'none';
                dom.weekViewContainer.style.display = currentCalendarView === 'week' ? 'block' : 'none';
                dom.monthViewContainer.style.display = currentCalendarView === 'month' ? 'block' : 'none';
                
                dom.dayViewBtn.classList.toggle('active', currentCalendarView === 'day');
                dom.weekViewBtn.classList.toggle('active', currentCalendarView === 'week');
                dom.monthViewBtn.classList.toggle('active', currentCalendarView === 'month');

                if (currentCalendarView === 'day') renderDayView();
                if (currentCalendarView === 'week') renderWeekView();
                if (currentCalendarView === 'month') renderMonthView();
            }

            setInterval(checkAndNotifyTasks, 10 * 1000);
            if ("Notification" in window) {
                if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                    Notification.requestPermission();
                }
            } else {
                console.warn("Browser does not support desktop notifications.");
            }

            function speak(text) { 
                if (!speechOn || !('speechSynthesis' in window) || !text) return;
                speechSynthesis.cancel();
                micWasOnBeforeSpeaking = isRecognizing;
                if (isRecognizing) { recognition.stop(); }
                const cleanText = text.replace(/<[^>]*>/g, '').replace(/[*_`#~[\]()🔍]|(-{3,})/g, '');
                const utterance = new SpeechSynthesisUtterance(cleanText); 
                if (selectedVoice) { utterance.voice = selectedVoice;
                }
                utterance.rate = 1.15;
                utterance.onend = () => {
                    if (micWasOnBeforeSpeaking) {
                        if (recognition && !isRecognizing) {
                            try { recognition.start(); } catch(e) { console.error("Error restarting recognition:", e); }
                        }
                        micWasOnBeforeSpeaking = false;
                    }
                    toggleVoiceSelectorVisibility(false);
                };
                utterance.onerror = (e) => {
                    console.error('Speech synthesis error:', e);
                    if (micWasOnBeforeSpeaking) {
                        if (recognition && !isRecognizing) {
                           try { recognition.start(); } catch(e) { console.error("Error restarting recognition on error:", e); }
                        }
                        micWasOnBeforeSpeaking = false;
                    }
                     toggleVoiceSelectorVisibility(false);
                }
                speechSynthesis.speak(utterance);
            }

            function populateVoiceList() {
                const setVoices = () => {
                    if (typeof speechSynthesis === 'undefined') { return; }
                    availableVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('es-') || v.lang.startsWith('en-'));
                    const preferredVoices = [ "Microsoft Sabina Online (Natural) - Spanish (Mexico)", "Paulina", "Google español de Estados Unidos", "Google español" ];
                    availableVoices.sort((a, b) => {
                        let aIdx = preferredVoices.indexOf(a.name); let bIdx = preferredVoices.indexOf(b.name);
                        if (aIdx === -1) aIdx = Infinity; if (bIdx === -1) bIdx = Infinity;
                        if (aIdx !== bIdx) return aIdx - bIdx;
                        return a.name.localeCompare(b.name);
                    });
                    
                    if (availableVoices.length > 0) {
                        dom.voiceSelector.innerHTML = '';
                        availableVoices.forEach(voice => {
                            const option = document.createElement('option');
                            const displayName = voice.name.replace('Microsoft', '').replace('Online (Natural) -', '').replace('Google', '').replace('Spanish (Mexico)','Mex').trim();
                            option.textContent = `${displayName || voice.lang} (${voice.lang})`;
                            option.value = voice.name;
                            dom.voiceSelector.appendChild(option);
                        });
                        selectedVoice = availableVoices[0];
                        if (selectedVoice) dom.voiceSelector.value = selectedVoice.name;
                    }
                }
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = setVoices;
                }
                setVoices();
            }

            function getModelForRequest(workflow, hasFile, isProjectChat) {
                if (isProjectChat) {
                    return document.getElementById('project-model-selector').value;
                }
                 if(workflow === 'financial-assistant') {
                    return 'gpt-4o-mini';
                }
                if (workflow === "design-web") return "gpt-4o-mini";
                if (hasFile) return "gpt-4o-mini";
                return dom.modelSelector.value;
            }

            async function getAIResponse(prompt, history, image, pdf, model, workflow, userName, financialData = null) {
                const name = (userName || '').split(' ')[0];
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }
                const body = { 
                    prompt, history, model,
                    workflow, userName: name, title,
                    imageData: image, pdfText: pdf, 
                    financialData,
                 };
                try {
                    const response = await fetch('/.netlify/functions/get-ai-response', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(body),
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({details: 'Error desconocido en el servidor'}));
                        console.error("Backend Error:", errorData);
                        throw new Error(errorData.details || `Error del servidor: ${response.status}.`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("Fetch Error:", error);
                    throw error;
                }
            }
            
            function getCreditCount() {
                const plan = currentUser?.app_metadata?.plan || 'free';
                let limit = GUEST_CREDIT_LIMIT;
                if (plan === 'free') limit = FREE_PLAN_CREDIT_LIMIT;
                if (plan === 'boost') limit = BOOST_PLAN_CREDIT_LIMIT;
                if (plan === 'pro') limit = Infinity;

                const usageData = JSON.parse(localStorage.getItem(`usage_${currentUser?.id || 'guest'}`)) || { count: 0, date: '' };
                const today = dayjs().format('YYYY-MM-DD');

                if (usageData.date !== today) {
                    return { remaining: limit, limit: limit }; // Full credits for the new day
                }
                
                return { remaining: Math.max(0, limit - usageData.count), limit: limit };
            }
            
            function spendCredits(cost) {
                const plan = currentUser?.app_metadata?.plan || 'free';
                if (plan === 'pro') return true;

                const usageKey = `usage_${currentUser?.id || 'guest'}`;
                const today = dayjs().format('YYYY-MM-DD');
                let usageData = JSON.parse(localStorage.getItem(usageKey)) || { count: 0, date: '' };

                if (usageData.date !== today) {
                    usageData = { count: 0, date: today };
                }

                const { remaining } = getCreditCount();
                const totalCredits = remaining + (gamificationState.credits || 0);

                if (totalCredits >= cost) {
                    if (remaining >= cost) {
                        usageData.count += cost;
                        localStorage.setItem(usageKey, JSON.stringify(usageData));
                    } else {
                        const neededFromGamification = cost - remaining;
                        usageData.count += remaining;
                        localStorage.setItem(usageKey, JSON.stringify(usageData));
                        gamificationState.credits -= neededFromGamification;
                        saveGamificationState();
                    }
                    updateCreditCounter();
                    return true;
                }

                // Not enough credits from any source
                if (!currentUser) {
                    // Guest user ran out of credits
                    showModal({ 
                        title: 'Créditos Agotados', 
                        body: 'Has utilizado todos tus créditos de invitado. Inicia sesión para obtener 15 créditos diarios, ¡gratis!', 
                        confirmText: 'Iniciar Sesión',
                        showCancel: true
                    }).then(res => {
                        if (res.confirmed) {
                            netlifyIdentity.open('login');
                        }
                    });
                } else {
                    // Logged-in user on free plan ran out
                    showModal({ 
                        title: 'Créditos Insuficientes', 
                        body: 'No tienes suficientes créditos de tu plan ni créditos de recompensa. Mejora tu plan para continuar.', 
                        confirmText: 'Mejorar Plan',
                        showCancel: true
                    }).then(res => { 
                        if (res.confirmed) {
                            showPricingModal(); 
                        }
                    });
                }
                return false;
            }

            async function loadStateForUser() {
                if (!currentUser) {
                    const saved = localStorage.getItem('guestState');
                    state = saved ? JSON.parse(saved).state : { chats: {}, projects: {}, structure: [], calendar: {} };
                    currentChatId = saved ? JSON.parse(saved).currentChatId : null;
                } else {
                     try {
                        const response = await fetch('/.netlify/functions/load-chats', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId: currentUser.id }),
                        });
                        if (!response.ok) { throw new Error(`Server error: ${response.status}`); }
                        const dbState = await response.json();
                        state = dbState.state || { chats: {}, projects: {}, structure: [], calendar: {} };
                        currentChatId = dbState.currentChatId;
                    } catch (error) {
                        console.error("Could not load from DB, falling back to localStorage:", error);
                        const saved = localStorage.getItem(`goatbotState_${currentUser.id}`);
                        const parsed = saved ? JSON.parse(saved) : {};
                        state = parsed.state || { chats: {}, projects: {}, structure: [], calendar: {} };
                        currentChatId = parsed.currentChatId;
                    }
                }
                state.calendar = state.calendar || {};
                state.projects = state.projects || {};
                state.chats = state.chats || {};
                state.structure = state.structure || [];
                loadGamificationState();
                renderSidebar();
                selectChat(currentChatId);
            }

            async function saveState() {
                const stateData = { state, currentChatId };
                if (!currentUser) {
                    try { localStorage.setItem('guestState', JSON.stringify(stateData)); } 
                    catch (e) { console.error("Guest localStorage is full.", e); }
                    return;
                }
                try {
                    await fetch('/.netlify/functions/save-chats', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: currentUser.id, stateToSave: stateData }),
                    });
                } catch (error) { console.error("Failed to save state to DB:", error); }
            }

            function updateUserUI() {
                if (currentUser) {
                    dom.loginView.classList.add('hidden');
                    dom.userMenuView.classList.remove('hidden');
                    dom.genericWelcome.classList.add('hidden');
                    dom.personalizedWelcome.classList.remove('hidden');
                    const userName = currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.email.split('@')[0];
                    dom.userEmail.textContent = currentUser.user_metadata?.full_name || currentUser.email;
                    dom.userName.textContent = userName;
                    dom.upgradePlanContainer.classList.toggle('hidden', (currentUser.app_metadata?.plan || 'free') !== 'free');
                } else {
                    dom.loginView.classList.remove('hidden');
                    dom.userMenuView.classList.add('hidden');
                    dom.genericWelcome.classList.remove('hidden');
                    dom.personalizedWelcome.classList.add('hidden');
                    dom.upgradePlanContainer.classList.add('hidden');
                }
                updateCreditCounter();
            }

            function updateCreditCounter() {
                const { remaining, limit } = getCreditCount();
                const gamCredits = gamificationState.credits || 0;
                let displayLimit = limit === Infinity ? '∞' : limit;
                
                dom.messageCounterEl.innerHTML = `
                    <span class="hidden sm:inline-block">${remaining}/${displayLimit}</span>
                    <i class="fas fa-coins text-gold ml-2 mr-1" title="Créditos de Recompensa"></i>
                    <span>${gamCredits}</span>
                `;
            }

            function setTheme(isDark) { 
                document.body.className = 'w-screen overflow-x-hidden';
                document.body.classList.add(isDark ? 'dark-theme' : 'light-theme');
                dom.themeIcon.className = `fas fa-${isDark ? 'sun' : 'moon'}`; 
                if (dom.settingsThemeIcon) dom.settingsThemeIcon.className = `fas fa-${isDark ? 'moon' : 'sun'} mr-2`;
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            }

            function toggleSidebar(show) {
                const sidebar = dom.sidebar;
                if (show) {
                    sidebar.classList.add('is-open');
                    dom.sidebarOverlay.classList.remove('opacity-0', 'pointer-events-none');
                } else {
                    sidebar.classList.remove('is-open');
                    dom.sidebarOverlay.classList.add('opacity-0', 'pointer-events-none');
                }
            }
            
            function createNewChat(options = {}) {
                const id = 'chat-' + crypto.randomUUID();
                const name = currentUser ? (currentUser.user_metadata.full_name?.split(' ')[0] || 'Tú') : 'viajero';
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }
                const initialMessages = options.initialMessages ||
                [{ 
                    role: 'assistant', 
                    content: `Saludos, ${title}. Soy Goatify IA, aquí para servirte. Cada idea tuya es una estrella a punto de nacer. ¿En qué universo nos sumergimos hoy?` 
                }];
                state.chats[id] = { 
                    id, 
                    title: options.title || "Conversación Cósmica", 
                    messages: initialMessages,
                    workflow: options.workflow || null,
                    model: options.model || 'gpt-3.5-turbo-1106'
                }; 
                state.structure.unshift(id); 
                selectChat(id); 
                saveState();
                renderSidebar(); 
                dom.modelSelector.value = options.model || 'gpt-3.5-turbo-1106';
                if (window.innerWidth < 768) toggleSidebar(false);
                
                const chatType = options.title || 'chat';
                showInAppNotification("Éxito", `Has creado un nuevo ${chatType}.`, 3000);

                return id;
            }

            function selectChat(chatId) { 
                if (isSelectModeActive) return;
                if (!chatId || !state.chats[chatId]) { resetChatView(); return; } 
                currentChatId = chatId;
                const chat = state.chats[chatId]; 

                dom.chatMessages.style.display = 'none';
                dom.projectManagementView.style.display = 'none';
                dom.financialAssistantView.style.display = 'none';
                dom.inputArea.style.display = 'none'; 

                if (chat.workflow === 'project-management') {
                    dom.projectManagementView.style.display = 'flex';
                    renderProjectView(chatId);
                } else if (chat.workflow === 'financial-assistant') {
                    dom.financialAssistantView.style.display = 'flex';
                    renderFinancialAssistant(chatId);
                }
                else {
                    dom.chatMessages.style.display = 'block';
                    dom.inputArea.style.display = 'block';
                    dom.chatMessages.innerHTML = ''; 
                    chat.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, msg.image, index, dom.chatMessages));
                    dom.initialMessageContainer.style.display = 'none';
                }

                dom.chatTitle.textContent = chat.title;
                dom.mobileChatTitle.textContent = chat.title;
                dom.modelSelector.value = chat.model || 'gpt-3.5-turbo-1106';
                updateActiveChatHighlight(); 
                saveState();
                updateContextualFooter(chat.workflow);
                if (window.innerWidth < 768) toggleSidebar(false);
            }

            function resetChatView() { 
                currentChatId = null;
                dom.chatTitle.textContent = "Goatify IA";
                dom.mobileChatTitle.textContent = "Goatify IA";

                dom.chatMessages.style.display = 'block';
                dom.inputArea.style.display = 'block';
                dom.projectManagementView.style.display = 'none';
                dom.financialAssistantView.style.display = 'none';

                dom.chatMessages.innerHTML = '';
                dom.initialMessageContainer.style.display = 'flex'; 
                updateUserUI(); 
                updateActiveChatHighlight(); 
                dom.modelSelector.value = 'gpt-3.5-turbo-1106';
                updateContextualFooter(null);
            }

            function addMessageToUI(role, content, imageSrc, messageIndex, container) {
                if (!container) return null;
                const wrapper = document.createElement('div');
                wrapper.className = `chat-bubble-wrapper group flex items-start gap-2 my-2 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const bubble = document.createElement('div');
                bubble.className = `p-3 md:p-4 rounded-xl max-w-lg md:max-w-xl ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot'}`;
                if (imageSrc) {
                    const img = document.createElement('img');
                    img.src = imageSrc;
                    img.className = 'rounded-lg mb-2 max-w-full h-auto';
                    bubble.appendChild(img);
                }
                const contentDiv = document.createElement('div');
                contentDiv.className = 'markdown-content';
                contentDiv.innerHTML = content === '…' ? `<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .2s;"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .4s;"></div></div>` : marked.parse(content || "");
                bubble.appendChild(contentDiv);

                if (role === 'user' && container === dom.chatMessages) {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'p-1 text-text-medium opacity-100 transition-opacity';
                    editBtn.innerHTML = '<i class="fas fa-pencil-alt fa-xs"></i>';
                    editBtn.title = 'Editar mensaje';
                    editBtn.onclick = (e) => { e.stopPropagation(); handleEditMessage(messageIndex); };
                    wrapper.insertBefore(editBtn, wrapper.firstChild);
                }
                
                if (role === 'assistant' && /<\/?[a-z][\s\S]*>/i.test(content)) {
                    const previewButton = document.createElement('button');
                    previewButton.innerHTML = '<i class="fas fa-eye mr-2"></i>Vista Previa';
                    previewButton.className = 'btn-primary text-xs font-semibold px-3 py-1 rounded-md mt-3';
                    previewButton.addEventListener('click', () => {
                        const match = content.match(/```html\n([\s\S]*?)```/);
                        const htmlToPreview = match ? match[1] : content;
                        dom.htmlPreviewIframe.srcdoc = htmlToPreview;
                         dom.htmlPreviewModal.classList.remove('hidden');
                        dom.htmlPreviewModal.classList.add('flex');
                    });
                    bubble.appendChild(previewButton);
                }

                wrapper.appendChild(bubble); 
                container.appendChild(wrapper);
                container.scrollTop = container.scrollHeight;
                return bubble;
            }
            
            async function handleEditMessage(index) {
                const chat = state.chats[currentChatId];
                if (!chat || !chat.messages[index]) return;
                const originalContent = chat.messages[index].content;
                const result = await showModal({ 
                    title: 'Editar Mensaje', 
                    body: `<textarea id="edit-msg-textarea" class="w-full p-2 rounded bg-input border border-themed h-28">${originalContent}</textarea>`,
                    confirmText: 'Guardar Cambios'
                 });
                if (result.confirmed && result.data['edit-msg-textarea'] && result.data['edit-msg-textarea'].trim() !== originalContent.trim()) {
                    chat.messages[index].content = result.data['edit-msg-textarea'].trim();
                    await saveState();
                    selectChat(currentChatId);
                }
            }

            function updateMessageInUI(bubble, content, imageSrc, container) {
                const newBubble = addMessageToUI('assistant', content, imageSrc, null, container);
                if (bubble && bubble.parentElement) {
                    bubble.parentElement.replaceWith(newBubble.parentElement);
                }
            }
            
            function renderSidebar() { 
                dom.sidebarContent.innerHTML = '';
                const frag = document.createDocumentFragment(); 
                (state.structure || []).forEach(id => { 
                    if (id.startsWith('project-')) {
                        frag.appendChild(createProjectElement(id));
                    } else if (id.startsWith('chat-')) {
                          frag.appendChild(createChatItemElement(id));
                    }
                });
                dom.sidebarContent.appendChild(frag); 
                updateActiveChatHighlight(); 
            }
            function createChatItemElement(id, isSubItem = false) { 
                const chat = state.chats[id];
                if (!chat) return document.createDocumentFragment(); 
                const item = document.createElement('div'); 
                item.className = `chat-item group flex items-center justify-between p-2 rounded-md cursor-pointer ${isSubItem ? 'pl-5' : ''}`; item.dataset.id = id; 
                if (isSelectModeActive) {
                    item.draggable = false;
                    const isSelected = chatsToDelete.has(id);
                    item.innerHTML = `<i class="far ${isSelected ? 'fa-check-square' : 'fa-square'} mr-2 text-primary"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span>`;
                    if (isSelected) item.classList.add('selected-for-delete');
                    item.addEventListener('click', () => {
                        if (chatsToDelete.has(id)) {
                            chatsToDelete.delete(id);
                            item.querySelector('i').classList.replace('fa-check-square', 'fa-square');
                             item.classList.remove('selected-for-delete');
                        } else {
                            chatsToDelete.add(id);
                            item.querySelector('i').classList.replace('fa-square', 'fa-check-square');
                            item.classList.add('selected-for-delete');
                        }
                        dom.deleteSelectedBtn.disabled = chatsToDelete.size === 0;
                    });
                } else {
                    item.draggable = true;
                    item.innerHTML = `<i class="far fa-comment-dots mr-2"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span><div class="chat-item-actions flex-shrink-0"><button class="rename-btn text-text-medium hover:text-primary p-1"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-text-medium hover:text-red-500 p-1"><i class="fas fa-trash-alt fa-xs"></i></button></div>`;
                    item.addEventListener('click', e => { if (!e.target.closest('.chat-item-actions')) selectChat(id); }); 
                    item.addEventListener('dragstart', e => handleDragStart(e, id)); item.querySelector('.rename-btn').addEventListener('click', () => renameItem('chat', id));
                    item.querySelector('.delete-btn').addEventListener('click', () => deleteItem('chat', id));
                }
                return item;
            }
            function createProjectElement(id) {
                const project = state.projects[id];
                if (!project) return document.createDocumentFragment();
                const div = document.createElement('div'); div.className = 'project'; div.dataset.id = id;
                const header = document.createElement('div');
                header.className = 'project-header group flex items-center p-2 rounded-md cursor-pointer';
                header.innerHTML = `<i class="fas fa-chevron-right project-arrow mr-2 transition-transform"></i><i class="fas fa-folder mr-2 text-yellow-500"></i><span class="flex-grow truncate text-sm font-bold">${project.title}</span><div class="chat-item-actions flex-shrink-0"><button class="rename-btn text-text-medium hover:text-primary p-1"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-text-medium hover:text-red-500 p-1"><i class="fas fa-trash-alt fa-xs"></i></button></div>`;
                const content = document.createElement('div'); content.className = 'project-content pl-2 pt-1 space-y-1';
                (project.chatIds || []).forEach(chatId => content.appendChild(createChatItemElement(chatId, true)));
                div.append(header, content);
                header.addEventListener('click', e => { if (!e.target.closest('.chat-item-actions')) div.classList.toggle('open'); });
                header.addEventListener('dragover', e => handleDragOver(e, header));
                header.addEventListener('dragleave', e => handleDragLeave(e, header));
                header.addEventListener('drop', e => handleDrop(e, id, header));
                header.querySelector('.rename-btn').addEventListener('click', () => renameItem('project', id));
                header.querySelector('.delete-btn').addEventListener('click', () => deleteItem('project', id));
                return div;
            }
            let draggedItemId = null;
            function handleDragStart(e, id) { draggedItemId = id; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', id); } function handleDragOver(e, el) { e.preventDefault(); el.classList.add('drag-over');
            } function handleDragLeave(e, el) { el.classList.remove('drag-over'); }
            function handleDrop(e, targetProjectId, targetElement) {
                e.preventDefault();
                if (targetElement) targetElement.classList.remove('drag-over');
                const sourceChatId = e.dataTransfer.getData('text/plain');
                if (!sourceChatId || !sourceChatId.startsWith('chat-') || targetProjectId === sourceChatId) return;
                state.structure = state.structure.filter(id => id !== sourceChatId); 
                Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(id => id !== sourceChatId) });
                if(state.projects[targetProjectId]){ 
                    if(!state.projects[targetProjectId].chatIds) state.projects[targetProjectId].chatIds = [];
                    state.projects[targetProjectId].chatIds.unshift(sourceChatId); 
                } 
                saveState(); renderSidebar();
            }
            async function renameItem(type, id) {
                const item = type === 'chat' ? state.chats[id] : state.projects[id];
                if(!item) return;
                const result = await showModal({ 
                    title: `Renombrar ${type === 'chat' ? 'Conversación' : 'Proyecto'}`, 
                    body: `<input type="text" id="rename-input" class="w-full p-2 rounded bg-input border border-themed" value="${item.title}">`,
                    confirmText: 'Renombrar'
                 });
                if (result.confirmed && result.data['rename-input'] && result.data['rename-input'].trim()) {
                    item.title = result.data['rename-input'].trim();
                    if (type === 'chat' && currentChatId === id) {
                        dom.chatTitle.textContent = item.title;
                        if (dom.mobileChatTitle) dom.mobileChatTitle.textContent = item.title;
                        if(state.chats[id].workflow === 'project-management') {
                            state.chats[id].projectData.title = item.title;
                            dom.projectViewTitle.textContent = item.title;
                        }
                    }
                    saveState();
                    renderSidebar();
                }
            }
            async function deleteItem(type, id) { const item = type === 'chat' ? state.chats[id] : state.projects[id]; const confResult = await showModal({ title: `Eliminar ${item.title}?`, body: 'Esta acción no se puede deshacer.', confirmText: 'Eliminar', dangerConfirm: true });
            if (confResult.confirmed) { state.structure = state.structure.filter(i => i !== id);
            if (type === 'project') { (item.chatIds || []).forEach(cid => delete state.chats[cid]); delete state.projects[id]; } else { delete state.chats[id];
            Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(cid => cid !== id)});
            } if(currentChatId === id || (type === 'project' && (item.chatIds || []).includes(currentChatId))) resetChatView(); saveState(); renderSidebar();
            } }
            
            function updateActiveChatHighlight() { 
                document.querySelectorAll('.chat-item').forEach(item => {
                    if (item.dataset.id === currentChatId) {
                        item.classList.add('selected-chat');
                     } else {
                        item.classList.remove('selected-chat');
                    }
                });
            }

            function clearImageData() { dom.imageUploadInput.value = ''; dom.imagePreviewContainer.classList.add('hidden'); selectedImageBase64 = null; }
            function clearPdfData() { dom.pdfUploadInput.value = ''; dom.pdfPreviewContainer.classList.add('hidden'); selectedPdfText = null; }
            function hasFile() { return selectedImageBase64 || selectedPdfText; }
            async function sendMessage(forceSend = false, spokenMessage = null, { isProjectChat = false, isFinancialChat = false } = {}) {
                let inputEl;
                if (isProjectChat) {
                    inputEl = document.getElementById('project-msg');
                } else if (isFinancialChat) {
                    inputEl = document.getElementById('financial-msg');
                } else {
                    inputEl = dom.msgInput;
                }
                const userMessage = spokenMessage || inputEl.value.trim();
                if (!userMessage && !selectedImageBase64 && !selectedPdfText) return;
                
                let chatIdToUpdate = currentChatId || createNewChat({});
                const currentChat = state.chats[chatIdToUpdate];
                if (!currentChat) return;
                
                let messageContainer, financialData = null;
                if (isProjectChat) {
                    messageContainer = dom.projectChatMessages;
                } else if (isFinancialChat) {
                    messageContainer = document.getElementById('financial-chat-messages');
                    financialData = currentChat.financialData;
                } else {
                    messageContainer = dom.chatMessages;
                }
                
                let modelToUse = getModelForRequest(currentChat.workflow, hasFile(), isProjectChat);
                const webSearchTriggers = ['busca', 'investiga', 'en internet', 'tiempo real', 'qué día es hoy', 'qué fecha es hoy', 'cuál es el precio de', 'quién es', 'qué es', 'noticias sobre'];
                const requiresWebSearch = webSearchTriggers.some(trigger => userMessage.toLowerCase().startsWith(trigger));
                if (requiresWebSearch && !hasFile() && !currentChat.workflow) { modelToUse = 'sonar';
                }
                
                let cost = COSTS.GENERAL;
                if(currentChat.workflow) cost = COSTS.COPYWRITING;
                if(modelToUse === 'sonar') cost = COSTS.SEARCH;
                if(hasFile()) cost = COSTS.NEBULA;

                if (!spendCredits(cost)) {
                    return;
                }

                if(currentChat.title === 'Conversación Cósmica' && userMessage.length > 5 && !isProjectChat && !isFinancialChat) {
                    currentChat.title = userMessage.split(' ').slice(0, 4).join(' ');
                    renderSidebar();
                }

                const [image, pdf] = [selectedImageBase64, selectedPdfText];
                currentChat.messages.push({ role: 'user', content: userMessage, image, pdfText: pdf });
                addMessageToUI('user', userMessage, image, currentChat.messages.length - 1, messageContainer);
                const thinkingBubble = addMessageToUI('assistant', '…', null, null, messageContainer);
                inputEl.value = '';
                inputEl.style.height = 'auto'; clearImageData(); clearPdfData();
                try {
                    const userNameForCall = currentUser ? (currentUser.user_metadata.full_name || currentUser.email) : 'viajero';
                    const responseData = await getAIResponse(userMessage, currentChat.messages.slice(0, -1), image, pdf, modelToUse, currentChat.workflow, userNameForCall, financialData);
                    
                    updateCreditCounter();
                    currentChat.messages.push({ role: 'assistant', content: responseData.reply });
                    updateMessageInUI(thinkingBubble, responseData.reply, null, messageContainer);
                    speak(responseData.reply);

                    if (currentChat.workflow) {
                        completeMission(currentChat.workflow, chatIdToUpdate);
                    }

                    if (currentChat.workflow === 'project-management' && responseData.projectUpdate && responseData.projectUpdate.tasks) {
                        const todoColumn = currentChat.projectData.columns.find(c => c.id === 'todo');
                        if (todoColumn) {
                            responseData.projectUpdate.tasks.forEach(task => {
                                if (!todoColumn.tasks) todoColumn.tasks = [];
                                 todoColumn.tasks.push({ id: `proj-${crypto.randomUUID()}`, content: task.content, completed: false, labels: task.labels || [], urgent: false });
                            });
                        }
                        renderProjectBoard(chatIdToUpdate);
                    }
                    
                    saveState();
                } catch (error) {
                    updateMessageInUI(thinkingBubble, `❌ **Error de Conexión**<br><small>${error.message || 'No se pudo conectar al servidor.'}</small>`, null, messageContainer);
                }
            }
            async function generateImage() {
                const result = await showModal({ title: 'Crear Imagen', body: 'Describe la imagen que quieres crear:<br><input type="text" id="img-prompt" class="w-full p-2 rounded bg-input border border-themed mt-2" placeholder="Ej: Un astronauta en un caballo cósmico">', confirmText: 'Generar' });
                if (!result.confirmed || !result.data['img-prompt']) return;
                
                if (!spendCredits(COSTS.IMAGE)) {
                    return;
                }
                
                let chatIdToUpdate = currentChatId || createNewChat({});
                const currentChat = state.chats[chatIdToUpdate];
                currentChat.messages.push({ role: 'user', content: `Generar imagen: "${result.data['img-prompt']}"` });
                addMessageToUI('user', `Generar imagen: "${result.data['img-prompt']}"`, null, currentChat.messages.length - 1, dom.chatMessages);
                const thinkingBubble = addMessageToUI('assistant', 'Creando tu visión con DALL·E 3...', null, null, dom.chatMessages);
                try {
                    const response = await fetch('/.netlify/functions/generate-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ prompt: result.data['img-prompt'], model: 'dall-e-3' })
                    });
                    if (!response.ok) { throw new Error((await response.json()).error || 'Error del servidor'); }
                    const { imageData } = await response.json();
                    const imageContent = `¡Aquí está tu creación, Jefe/a!`;
                    currentChat.messages.push({ role: 'assistant', content: imageContent, image: imageData });
                    updateMessageInUI(thinkingBubble, imageContent, imageData, dom.chatMessages);
                    completeMission('image-generated');
                    saveState();
                } catch (error) {
                    updateMessageInUI(thinkingBubble, `❌ **Error al crear la imagen:**<br><small>${error.message}</small>`, null, dom.chatMessages);
                }
            }
            function toggleSelectMode(active) {
                isSelectModeActive = active;
                dom.selectChatsBtn.classList.toggle('hidden', active);
                dom.deleteModeControls.classList.toggle('hidden', !active);
                if (!active) {
                    chatsToDelete.clear();
                    dom.deleteSelectedBtn.disabled = true;
                }
                renderSidebar();
            }

            function setupModalClickOutside(modalElement, hideFunction) {
                if (!modalElement) return;
                modalElement.addEventListener('click', (e) => {
                    if (e.target === modalElement) {
                        hideFunction();
                    }
                });
            }

            function toggleVoiceSelectorVisibility(show) {
                dom.voiceSelectorContainer.classList.toggle('hidden', !show);
                dom.actionButtonsContainer.classList.toggle('hidden', show);
            }

            function showMotivationModal() {
                dom.motivationModal.classList.remove('hidden');
                dom.motivationModal.classList.add('flex');
                
                const quoteEl = dom.motivationQuote;
                const closeBtn = dom.closeMotivationModal;

                const randomIndex = Math.floor(Math.random() * MOTIVATIONAL_MESSAGES.length);
                quoteEl.textContent = MOTIVATIONAL_MESSAGES[randomIndex];

                const randomButtonIndex = Math.floor(Math.random() * MOTIVATIONAL_BUTTON_TEXTS.length);
                closeBtn.textContent = MOTIVATIONAL_BUTTON_TEXTS[randomButtonIndex];
                
                quoteEl.classList.remove('flash');
                void quoteEl.offsetWidth; // Trigger reflow to restart animation
                quoteEl.classList.add('flash');

                dom.motivationToggle.checked = motivationEnabled;
            }

            function hideMotivationModal() {
                dom.motivationModal.classList.add('hidden');
                dom.motivationModal.classList.remove('flex');
            }

            function setupMotivationInterval() {
                if (motivationInterval) clearInterval(motivationInterval);
                if (!motivationEnabled) return;

                const notificationTimes = ['08:00', '11:00', '14:00', '17:00'];
                let lastNotifiedHour = -1;

                motivationInterval = setInterval(() => {
                    if (!motivationEnabled) {
                        clearInterval(motivationInterval);
                        return;
                    }
                    const now = dayjs();
                    const currentTime = now.format('HH:mm');
                    const currentHour = now.hour();

                    if (notificationTimes.includes(currentTime) && currentHour !== lastNotifiedHour) {
                        lastNotifiedHour = currentHour;
                        const randomIndex = Math.floor(Math.random() * MOTIVATIONAL_MESSAGES.length);
                        const message = MOTIVATIONAL_MESSAGES[randomIndex];
                        showInAppNotification(
                            `<i class="fas fa-lightbulb text-yellow-400 mr-2"></i> ¡Dosis de Motivación!`,
                            `<p class="text-md">${message}</p>`
                        );
                    }
                }, 60000); 
            }

            function setupEventListeners() {
                dom.inAppNotificationClose?.addEventListener('click', () => {
                    dom.inAppNotification.classList.remove('show');
                });

                const motivationClickHandler = () => showMotivationModal();
                dom.motivationBtnHeader?.addEventListener('click', motivationClickHandler);
                dom.motivationBtnMobile?.addEventListener('click', motivationClickHandler);

                dom.closeMotivationModal?.addEventListener('click', hideMotivationModal);
                dom.motivationToggle?.addEventListener('change', () => {
                    motivationEnabled = dom.motivationToggle.checked;
                    localStorage.setItem('goatify-motivation-enabled', motivationEnabled);
                    if(motivationEnabled) {
                        setupMotivationInterval();
                    } else {
                        if(motivationInterval) clearInterval(motivationInterval);
                    }
                });

                dom.sendBtn?.addEventListener('click', () => sendMessage(false, null, {}));
                dom.projectSendBtn?.addEventListener('click', () => sendMessage(false, null, {isProjectChat: true}));

                const setupInput = (input, options = {}) => {
                    input?.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                             sendMessage(false, null, options);
                        }
                    });
                    input?.addEventListener('input', () => {
                        input.style.height = 'auto';
                        input.style.height = (input.scrollHeight) + 'px';
                    });
                };
                setupInput(dom.msgInput);
                setupInput(dom.projectMsgInput, {isProjectChat: true});

                const newChatHandler = () => {
                    createNewChat();
                };
                dom.newChatBtn?.addEventListener('click', newChatHandler);
                dom.newChatIconBtn?.addEventListener('click', newChatHandler);
                
                dom.newFolderBtn?.addEventListener('click', async () => { const result = await showModal({ title: 'Crear Nueva Carpeta', body: '<input type="text" id="project-name" class="w-full p-2 rounded bg-input border border-themed" placeholder="Nombre de la Carpeta...">', confirmText: 'Crear' }); if (result.confirmed && result.data['project-name'].trim()) { const id = 'project-' + crypto.randomUUID(); state.projects[id] = { id, title: result.data['project-name'].trim(), chatIds: [] }; state.structure.unshift(id); saveState(); renderSidebar(); } });
                dom.upgradePlanBtn?.addEventListener('click', showPricingModal);
                dom.closePricingModalBtn?.addEventListener('click', hidePricingModal);
                dom.themeToggle?.addEventListener('click', () => setTheme(!document.body.classList.contains('dark-theme')));
                dom.loginBtn?.addEventListener('click', () => netlifyIdentity.open('login'));
                dom.sidebarToggleDesktop?.addEventListener('click', () => {
                    const icon = dom.sidebarToggleDesktop.querySelector('i');
                    dom.sidebar.classList.toggle('collapsed');
                    icon.classList.toggle('fa-angle-left');
                    icon.classList.toggle('fa-angle-right');
                 });

                dom.chatTitleWrapper?.addEventListener('click', (e) => { if(!e.target.closest('#motivation-btn-header') && currentChatId) renameItem('chat', currentChatId); });
                dom.mobileChatTitleWrapper?.addEventListener('click', (e) => { if(!e.target.closest('#motivation-btn-mobile') && currentChatId) renameItem('chat', currentChatId); });
                dom.imageGenBtn?.addEventListener('click', generateImage);
                dom.pdfUploadBtn?.addEventListener('click', () => dom.pdfUploadInput.click());
                dom.imageUploadBtn?.addEventListener('click', () => dom.imageUploadInput.click());
                if (SR && dom.micBtn) {
                    recognition = new SR();
                    recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'es-ES';
                    recognition.onstart = () => { isRecognizing = true; dom.micBtn.classList.add('glowing-mic'); toggleVoiceSelectorVisibility(true);};
                    recognition.onend = () => { isRecognizing = false; dom.micBtn.classList.remove('glowing-mic'); if (!speechSynthesis.speaking) toggleVoiceSelectorVisibility(false); };
                    recognition.onerror = (e) => { console.error("Speech recognition error", e); isRecognizing = false; dom.micBtn.classList.remove('glowing-mic'); toggleVoiceSelectorVisibility(false); };
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        const currentChat = state.chats[currentChatId];
                        const options = {};
                        if(currentChat?.workflow === 'project-management') options.isProjectChat = true;
                        if(currentChat?.workflow === 'financial-assistant') options.isFinancialChat = true;

                        if(transcript) {
                            let activeInput = dom.msgInput;
                            if (options.isProjectChat) activeInput = document.getElementById('project-msg');
                            else if (options.isFinancialChat) activeInput = document.getElementById('financial-msg');

                            activeInput.value = transcript; 
                            sendMessage(false, null, options);
                        }
                    };
                    dom.micBtn.addEventListener('click', () => {
                        if(isRecognizing) { recognition.stop(); } 
                        else { if (speechSynthesis.speaking) { speechSynthesis.cancel(); } try { recognition.start(); } catch(e) {console.error("Could not start recognition", e)} }
                    });
                } else { if(dom.micBtn) dom.micBtn.style.display = 'none'; }
                
                dom.ttsToggle?.addEventListener('click', () => {
                    speechOn = !speechOn;
                    const icon = dom.ttsToggle.querySelector('i');
                     icon.classList.toggle('fa-volume-high', speechOn);
                    icon.classList.toggle('fa-volume-mute', !speechOn);
                    if (!speechOn) {
                        speechSynthesis.cancel();
                    }
                 });

                dom.modelSelector?.addEventListener('change', () => {});
                
                dom.clearImageBtn?.addEventListener('click', clearImageData);
                dom.clearPdfBtn?.addEventListener('click', clearPdfData);
                dom.imageUploadInput?.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { clearPdfData(); const reader = new FileReader(); reader.onload = (ev) => { selectedImageBase64 = ev.target.result; dom.imagePreview.src = selectedImageBase64; dom.imagePreviewContainer.classList.remove('hidden'); dom.imageName.textContent = e.target.files[0].name; }; reader.readAsDataURL(e.target.files[0]); } });
                dom.pdfUploadInput?.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file || file.type !== 'application/pdf') return; clearImageData(); dom.pdfNameEl.textContent = file.name; dom.pdfStatusEl.textContent = 'Leyendo...'; dom.pdfPreviewContainer.classList.remove('hidden'); const reader = new FileReader(); reader.onload = async (ev) => { dom.pdfStatusEl.textContent = 'Procesando...'; try { const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(ev.target.result) }).promise; let text = ''; for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const content = await page.getTextContent(); text += content.items.map(item => item.str).join(' ') + '\n'; } selectedPdfText = text; dom.pdfStatusEl.textContent = `✅ Listo (${pdf.numPages} pág.)`; } catch (err) { console.error("Error al procesar el PDF:", err); dom.pdfStatusEl.textContent = '❌ Error al leer PDF.'; selectedPdfText = null; setTimeout(clearPdfData, 2000); } }; reader.readAsArrayBuffer(file); });
                dom.menuToggle?.addEventListener('click', (e) => { e.stopPropagation(); toggleSidebar(true); });
                dom.sidebarOverlay?.addEventListener('click', () => toggleSidebar(false));
                dom.userMenuBtn?.addEventListener('click', (e) => { e.stopPropagation(); dom.userMenuPopup.classList.toggle('hidden'); });
                dom.logoutBtn?.addEventListener('click', () => { netlifyIdentity.logout(); dom.userMenuPopup.classList.add('hidden');});
                
                const workflowConfigs = {
                    'project-management': { title: "Proyecto", workflow: 'project-management', initialMessages: [{ role: 'assistant', content: '¡Excelente! Vamos a estructurar este proyecto como un profesional. Para empezar, **¿cuál es el objetivo final y medible que quieres alcanzar con este proyecto?** Descríbelo y luego definiremos los entregables clave.' }] },
                    'create-full-post': { title: "Post para Redes", workflow: 'create-full-post', initialMessages: [{ role: 'assistant', content: '¡Claro! Vamos a crear un post increíble. ¿Para qué red social lo necesitas (Instagram, Facebook, LinkedIn, etc.)?' }] },
                    'persuasive-copy': { title: "Copy Persuasivo", workflow: 'persuasive-copy', initialMessages: [{ role: 'assistant', content: 'Estoy listo para redactar textos que vendan. ¿Para qué necesitas este copy? (ej: Anuncio de Facebook, Post de Venta, Descripción de Producto)' }] },
                    'post-ideas': { title: "Lluvia de Ideas", workflow: 'post-ideas', initialMessages: [{ role: 'assistant', content: '¡Acabemos con el bloqueo creativo! Dime un tema y te daré 7 ideas de contenido excelentes.' }] },
                    'brand-strategy': { title: "Estratega de Marca", workflow: 'brand-strategy', initialMessages: [{ role: 'assistant', content: 'Definamos el corazón de tu marca. ¿Cuál es el nombre de tu negocio y a qué se dedica?' }] },
                    'competitor-analysis': { title: "Análisis de Competencia", workflow: 'competitor-analysis', model: 'sonar', initialMessages: [{ role: 'assistant', content: "Estoy listo para analizar a tu competencia usando el buscador web. Por favor, pega la URL (dirección web) de la página que quieres que investigue para entregarte un análisis DAFO simplificado." }] },
                    'buyer-persona': { title: "Cliente Ideal", workflow: 'buyer-persona', initialMessages: [{ role: 'assistant', content: "Vamos a definir a tu cliente ideal (Buyer Persona). Describe tu producto o servicio, y te haré preguntas para construir el perfil detallado paso a paso." }] },
                    'brand-names': { title: "Nombres para Marca", workflow: 'brand-names', initialMessages: [{ role: 'assistant', content: "¡Excelente! Busquemos un nombre increíble. Describe brevemente tu idea de negocio, tu público y el estilo que buscas (ej. moderno, clásico, divertido) para generar nombres y slogans." }] },
                    'sales-assistant': { title: "Asistente de Ventas", workflow: 'sales-assistant', initialMessages: [{ role: 'assistant', content: 'Para ayudarte a cerrar esa venta, pega aquí el mensaje de tu cliente.' }] },
                    'email-writing': { title: "Redactor de Emails", workflow: 'email-writing', initialMessages: [{ role: 'assistant', content: 'Creemos un email que convierta. ¿Cuál es el objetivo principal de este correo?' }] },
                    'english-teacher-translate': { title: "Traductor de Inglés", workflow: 'english-teacher-translate', initialMessages: [{ role: 'assistant', content: 'Of course! Please provide the text you want me to translate or correct.' }] },
                    'english-teacher-vocabulary': { title: "Creador de Vocabulario", workflow: 'english-teacher-vocabulary', initialMessages: [{ role: 'assistant', content: 'Excellent! Let\'s learn some new vocabulary. What topic are you interested in? (e.g., "business negotiations", "travel")' }] },
                    'english-teacher-practice': { title: "Práctica de Inglés", workflow: 'english-teacher-practice', initialMessages: [{ role: 'assistant', content: 'Great! Let\'s practice our conversation. So, tell me about your day.' }] },
                    'social-skills': { title: "Consejero Social", workflow: 'social-skills', initialMessages: [{ role: 'assistant', content: 'Las habilidades sociales son clave. ¿En qué situación te gustaría mejorar tu comunicación? (Ej: una reunión de networking, una conversación difícil, etc.)' }] },
                    'design-web': { title: "Diseñador Web", workflow: 'design-web', model: 'gpt-4o-mini', initialMessages: [{ role: 'assistant', content: 'Estoy listo para diseñar con código. Describe la página o componente que quieres crear, y lo programaré para ti.' }] },
                    'conflict-resolution': { title: "Mediador de Conflictos", workflow: 'conflict-resolution', initialMessages: [{ role: 'assistant', content: 'Entiendo. Las situaciones difíciles requieren una comunicación clara. Por favor, describe el conflicto objetivamente: ¿quiénes están involucrados y cuál es el punto principal de desacuerdo?' }] },
                    'decision-lab': { title: "Laboratorio de Decisiones", workflow: 'decision-lab', initialMessages: [{ role: 'assistant', content: 'Bienvenido al Laboratorio de Decisiones. Recuerda que una decisión puede cambiar el rumbo de tu vida. Para ayudarte a analizar tu situación, por favor, dime: ¿Cuál es la decisión que necesitas tomar y qué opciones estás considerando?' }] },
                    'financial-assistant': { title: "Asistente Financiero", workflow: 'financial-assistant', initialMessages: [{ role: 'assistant', content: '¡Vamos a organizar tus finanzas! Utiliza la tabla de arriba para añadir tus ingresos y gastos. Luego, puedes hacerme preguntas aquí sobre tus finanzas, como por ejemplo: "¿En qué categoría estoy gastando más?" o "Proyecta mis ahorros para los próximos 6 meses".' }] },
                };
                dom.projectWorkflowHeader.addEventListener('click', () => {
                    createNewChat(workflowConfigs['project-management']);
                });
                document.querySelectorAll('[data-workflow]').forEach(button => {
                    button.addEventListener('click', () => {
                        const workflowKey = button.dataset.workflow;
                        const config = workflowConfigs[workflowKey];
                         if (config) {
                            createNewChat({
                                 title: config.title,
                                workflow: config.workflow,
                                model: config.model,
                                 initialMessages: config.initialMessages
                            });
                        }
                    });
                });
                
                dom.workflowsContainer.addEventListener('click', e => { 
                    const header = e.target.closest('.workflow-header'); 
                    if (header && header.id !== 'project-workflow-header') { 
                        const category = header.closest('.workflow-category'); 
                         if (category) category.classList.toggle('open'); 
                    } 
                });
            }
        });
    </script>
</body>
</html>
