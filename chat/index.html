<!DOCTYPE html>
<html data-theme="light" lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<title>Goatify IA v8 — Suite de Negocios Personalizada</title>
<!-- SEO Meta Tags -->
<meta content="Goatify IA v8 es tu sistema operativo de negocios que se adapta a tu industria. Personaliza tu espacio de trabajo para marketing, e-commerce, y más." name="description"/>
<meta content="project management, crm, business os, collaboration, ai chat, cronopost, goatify ia, personalized workspace" name="keywords"/>
<meta content="Goatify" name="author"/>
<!-- Open Graph Meta Tags -->
<meta content="Goatify IA v8 — Suite de Negocios Personalizada" property="og:title"/>
<meta content="website" property="og:type"/>
<meta content="La nueva era de la productividad. Goatify IA v8 personaliza tus proyectos, tareas y herramientas según tu tipo de negocio desde el inicio." property="og:description"/>
<meta content="#f6f7fb" name="theme-color"/>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --bg:#0b0f19; --surface:#0f172a; --muted:#1e293b; --line:#334155;
    --text:#e2e8f0; --sub:#94a3b8; --brand:#a78bfa; --brand2:#8b5cf6; --accent:#38bdf8;
    --danger:#f87171; --warn:#fbbf24; --success:#22c55e; --info:#60a5fa;
    --shadow:0 20px 60px rgba(0,0,0,.45);
    --radius:12px; --xs:10px; --sm:12px; --md:13.5px; --lg:15.5px; --xl:18px;
    --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  [data-theme="light"]{
    --bg:#f8fafc; --surface:#ffffff; --muted:#f1f5f9; --line:#e2e8f0;
    --text:#0f172a; --sub:#64748b; --brand:#6d28d9; --brand2:#8b5cf6; --accent:#0ea5e9;
    --shadow:0 10px 25px rgba(15, 23, 42,.08);
  }
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
  *{box-sizing:border-box; transition: background .15s ease, color .15s ease, border-color .15s ease, transform .15s ease, box-shadow .15s ease}
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font: var(--md)/1.5 var(--font-sans);}
  a{color:var(--brand);text-decoration:none}
  .container{display:grid;grid-template-columns:280px 1fr;min-height:100%}
  aside{border-right:1px solid var(--line);background:var(--surface);padding:10px;position:relative;z-index:30; display: flex; flex-direction: column;}
  header.app{position:sticky;top:0;z-index:40;background:color-mix(in hsl, var(--surface) 85%, transparent);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);padding:8px 10px;display:flex;gap:10px;align-items:center}
  .brand{display:flex;gap:8px;align-items:center;font-weight:800; font-size: var(--lg);}
  .badge{padding:2px 8px;border-radius:999px;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;font-size:var(--xs)}
  .btn{border-radius:var(--radius);border:1px solid var(--line);background:var(--surface);color:var(--text);padding:8px 12px;cursor:pointer;display:inline-flex;gap:8px;align-items:center; font-weight: 600; white-space: nowrap;}
  .btn:hover{transform:translateY(-1px); border-color: var(--brand); box-shadow: var(--shadow);} .btn:active{transform:none; box-shadow: none;}
  .btn.btn-sm { padding: 4px 8px; font-size: var(--sm); }
  .btn-primary{border:none;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff}
  .btn-ghost{background:transparent; border-color: transparent; box-shadow: none;}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border:1px solid transparent;border-radius:999px;background:var(--muted); cursor: pointer;}
  .chip:hover { border-color: var(--brand); }
  input,select,textarea{border:1px solid var(--line);border-radius:10px;background:var(--muted);color:var(--text);padding:8px 12px;outline:none; width: 100%;}
  input:focus, select:focus, textarea:focus { border-color: var(--brand); background: var(--surface); box-shadow: 0 0 0 3px color-mix(in hsl, var(--brand) 20%, transparent); }
  .projList{display:flex;flex-direction:column;gap:6px}
  .navBtn{display:flex;gap:10px;align-items:center;border:1px solid transparent;border-radius:10px;background:transparent;padding:10px;cursor:pointer; font-weight: 500; color: var(--text)}
  .navBtn:hover{background:var(--muted);}
  .navBtn.active {background: var(--brand); color: #fff; font-weight: 700;}
  .projItem { display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 10px; border: 1px solid transparent; cursor: pointer; }
  .projItem .proj-actions { display: none; margin-left: auto;}
  .projItem:hover .proj-actions { display: flex; }
  .projItem.active { background: color-mix(in hsl, var(--brand) 15%, transparent); border-color: var(--brand); font-weight: 600; }
  .proj-color-dot { width: 12px; height: 12px; border-radius: 50%; }
  .panel{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);margin:10px;overflow:hidden; animation: fadeIn .3s ease;}
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}
  .section{padding:16px;border-top:1px solid var(--line);}
  .card{border:1px solid var(--line);border-radius:12px;background:var(--muted);padding:16px}
  .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
  .stat-card { background: var(--surface); padding: 16px; border-radius: var(--radius); }
  .stat-card h4 { margin: 0 0 8px 0; color: var(--sub); }
  .stat-card p { margin: 0; font-size: var(--xl); font-weight: 700; }
  .empty-state { text-align: center; padding: 40px; color: var(--sub); }
  .empty-state i { margin-bottom: 12px; }
  /* Tabs */
  .tabs{display:flex;gap:6px;padding:12px;border-bottom:1px solid var(--line); flex-wrap: wrap;}
  .tab{all:unset;cursor:pointer;padding:8px 14px;border:1px solid var(--line);border-radius:999px;background:var(--muted); font-weight: 600;}
  .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
  /* Board */
  .board{display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:10px;padding:10px}
  .col{background:var(--muted);border:1px solid var(--line);border-radius:12px;min-height:220px;padding:8px}
  .col.dragover { outline: 2px dashed var(--brand); background: color-mix(in hsl, var(--brand) 10%, transparent); }
  .task{background:var(--surface);border:1px solid var(--line);border-radius:10px;padding:12px;margin:8px 4px;cursor:grab;box-shadow:var(--shadow)}
  /* Calendars */
  #cpCalendarContainer { background: var(--surface); border-radius: var(--radius); padding: 10px; border: 1px solid var(--line); }
  .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
  .day { min-height: 140px; border: 1px solid var(--line); border-radius: 10px; background: var(--surface); padding: 6px; display: flex; flex-direction: column; gap: 4px; }
  .day:hover { background: var(--muted); }
  .cp-post { font-size: 12px; background: var(--surface); border-radius: 8px; padding: 4px 6px; cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,.05); border-left: 3px solid var(--brand); margin-bottom: 4px; }
  /* Hub Profesional */
  .profile-card .profile-header { height: 100px; background: var(--surface); border-radius: var(--radius) var(--radius) 0 0; transition: background .3s ease; }
  .profile-card .avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--surface); box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: -50px auto 10px; cursor: pointer; }
  /* Notes & Drawing */
  .note-editor-wrapper { display: grid; grid-template-columns: 1fr 300px; gap: 10px; align-items: start;}
  #noteEditor { min-height: 60vh; max-height: 60vh; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--line); padding: 12px; overflow-y: auto; }
  #drawingCanvas { border: 1px solid var(--line); border-radius: var(--radius); cursor: crosshair; }
  /* Chat IA & Global Chat */
  .chat-log { display: flex; flex-direction: column; height: 55vh; overflow: auto; border: 1px solid var(--line); border-radius: var(--radius); padding: 10px; background: var(--muted); }
  .chat-log .msg { display: flex; gap: 10px; margin-bottom: 12px; max-width: 85%; align-items: flex-end; }
  .chat-log .msg.mine { align-self: flex-end; flex-direction: row-reverse; }
  .chat-log .msg-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
  .chat-log .msg-content { display: flex; flex-direction: column; }
  .chat-log .msg-who { font-size: var(--sm); font-weight: 600; margin-bottom: 4px; color: var(--sub); }
  .chat-log .msg-body { background: var(--surface); padding: 8px 12px; border-radius: 12px; }
  .chat-log .msg.mine .msg-content { align-items: flex-end; }
  .chat-log .msg.mine .msg-body { background: var(--brand); color: #fff; }
  /* Job Board */
  .job-card { background: var(--surface); border: 1px solid var(--line); border-left: 4px solid var(--accent); border-radius: 12px; padding: 16px; margin-bottom: 10px; cursor: pointer; }
  .job-card:hover { border-color: var(--accent); box-shadow: var(--shadow); transform: translateY(-2px); }
  .job-card .job-title { font-weight: 700; font-size: var(--lg); }
  .job-card .job-company { color: var(--sub); }
  .job-card-details { display: none; margin-top: 16px; border-top: 1px solid var(--line); padding-top: 16px; white-space: pre-wrap; }
  /* Monetization Assistant */
  .monet-card {
    background: var(--surface); border: 1px solid var(--line); border-radius: var(--radius);
    padding: 20px; text-align: center; cursor: pointer;
    transition: transform .2s, box-shadow .2s;
  }
  .monet-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); border-color: var(--brand); }
  .monet-card i { color: var(--brand); }
  .monet-card h4 { margin: 10px 0 5px 0; }
  .monet-card p { font-size: var(--sm); color: var(--sub); margin: 0; }
  #monetModuleModal h4 { color: var(--brand2); margin-top: 1.5em; margin-bottom: 0.5em; }
  #monetModuleModal ul { padding-left: 20px; }
  #monetModuleModal .tip { background: color-mix(in hsl, var(--warn) 15%, transparent); border-left: 3px solid var(--warn); padding: 12px; margin: 1em 0; border-radius: 8px;}
  /* Modals & Toasts */
  dialog { border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); max-width: 600px; padding: 0; overflow: hidden; }
  dialog[open] { animation: fadeIn .2s ease; }
  dialog::backdrop { background: rgba(0,0,0,.5); backdrop-filter: blur(4px); }
  #toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 999px; z-index: 100; font-weight: 600; box-shadow: var(--shadow); opacity: 0; transition: opacity .3s, bottom .3s; }
  #toast.show { opacity: 1; bottom: 30px; }
  /* Mobile */
  @media (max-width: 1180px){ .container{grid-template-columns:1fr} aside{position:fixed;inset:0;transform:translateX(-101%);transition:.2s ease;z-index:99} body.aside-open aside{transform:translateX(0)} }
  
  @media (max-width: 768px) {
    /* Stack grid layouts that have a sidebar-like column */
    .hub-grid, #cronopost-grid, .gchat-grid, .note-editor-wrapper, .board {
        grid-template-columns: 1fr;
    }
    /* Make header more compact */
    header.app .btn span, header.app .chip span#wallet-amount, header.app .chip span#intis-amount {
        display: none; /* Hide text on chips/buttons */
    }
    header.app .btn, header.app .chip {
        padding: 8px; /* Adjust padding for icon-only */
    }
    header.app .brand .badge {
        display: none; /* Hide version badge */
    }
    .tabs {
        padding: 8px;
    }
    .tab {
        padding: 6px 12px;
        font-size: var(--sm);
    }
    #project-header-right {
         flex-wrap: wrap;
         justify-content: flex-end;
         gap: 4px;
    }
    dialog {
        width: calc(100vw - 30px);
        max-width: 95%;
    }
  }

</style>
</head>
<body>
<header class="app">
<button class="btn btn-ghost" id="menuBtn"><i data-lucide="menu"></i></button>
<div class="brand">Goatify <span style="color:var(--brand)">IA</span> <span class="badge">v8.0</span></div>
<div class="spacer"></div>
<button class="btn" id="aiAssistantBtn"><i data-lucide="bot"></i> <span>Asistente IA</span></button>
<div class="chip" id="walletChip" title="Ver Billetera"><i data-lucide="wallet"></i> <span id="wallet-amount">$0</span></div>
<div class="chip" id="intisChip" title="Tus Intis (puntos de gamificación)"><i data-lucide="sparkles"></i> <span id="intis-amount">0</span></div>
<div class="chip" id="creditsChip" title="Haz clic para ver los beneficios de la membresía"><i data-lucide="star"></i> <span id="credits-amount">100 créditos</span></div>
<button class="btn btn-ghost" id="themeBtn"><i data-lucide="sun"></i></button>
<button class="btn btn-ghost" id="tourBtn" title="Iniciar Tour Guiado"><i data-lucide="help-circle"></i></button>
</header>
<div class="container">
<aside>
<div>
<div class="search row"><i data-lucide="search"></i><input id="q" placeholder="Buscar en todo…"/></div>
<div class="row" style="padding: 10px 0;"><b>Proyectos</b><span class="spacer"></span><button class="btn" id="newProject"><i data-lucide="plus"></i> Nuevo</button></div>
<div class="projList" id="projList"></div>
</div>
<div class="spacer" style="min-height: 20px;"></div>
<div>
<hr style="border-color:var(--line); margin: 10px 0;"/>
<div id="nav-list" class="projList">
<a class="navBtn" data-nav="cronopost" href="#cronopost"><i data-lucide="calendar-days"></i> CronoPOST</a>
<a class="navBtn" data-nav="hub" href="#hub"><i data-lucide="globe-2"></i> Hub Profesional</a>
<a class="navBtn" data-nav="gchat" href="#gchat"><i data-lucide="messages-square"></i> Chat Global</a>
<a class="navBtn" data-nav="monet" href="#monet"><i data-lucide="dollar-sign"></i> Asistente de Monetización</a>
<a class="navBtn" data-nav="mindset" href="#mindset"><i data-lucide="brain-circuit"></i> Mindset y Motivación</a>
<a class="navBtn" data-nav="settings" href="#settings"><i data-lucide="settings"></i> Ajustes</a>
</div>
</div>
</aside>
<main id="main">
<!-- PROJECT SHELL -->
<section class="panel" id="projectShell" style="display:none">
<div class="tabs">
    <button class="tab active" data-ptab="overview">Overview</button>
    <button class="tab" data-ptab="tasks">Tareas</button>
    <button class="tab" data-ptab="calendar">Calendario</button>
    <button class="tab" data-ptab="notes">Notas y Dibujos</button>
    <button class="tab" data-ptab="tables">Tablas</button>
    <button class="tab" data-ptab="files">Archivos</button>
    <button class="tab" data-ptab="chat">Chat IA</button>
    <button class="tab" data-ptab="finance">Finanzas</button>
    <div class="spacer"></div>
    <div id="project-header-right" class="row">
        <div class="chip" id="projectNameChip">Proyecto</div>
        <button class="btn btn-sm" id="addFolder"><i data-lucide="folder-plus"></i></button>
        <select id="folderSel" class="btn-sm"></select>
        <button class="btn btn-primary btn-sm" id="quickAdd"><i data-lucide="plus"></i> Nueva Tarea</button>
    </div>
</div>

<!-- OVERVIEW -->
<div id="p-tab-overview" style="padding:16px; display:block;">
    <div id="ovr" class="overview-grid"></div>
</div>

<!-- TASKS -->
<div id="p-tab-tasks" style="display:none;">
    <div class="board" id="kanban"></div>
</div>

<!-- CALENDAR -->
<div id="p-tab-calendar" style="display:none; padding:10px;">
    <div class="row"><b>Calendario del proyecto</b><span class="spacer"></span><button class="btn" id="prevM"><i data-lucide="chevron-left"></i></button><div class="chip" id="monthLbl">Mes</div><button class="btn" id="nextM"><i data-lucide="chevron-right"></i></button></div>
    <div class="calendar" id="calGrid" style="margin-top:10px;"></div>
</div>

<!-- NOTES -->
<div id="p-tab-notes" style="display:none; padding:10px">
    <div class="note-editor-wrapper">
        <div class="card" style="padding:8px;">
            <div class="row" style="margin-bottom:8px; padding: 4px; flex-wrap: wrap;">
                <button class="btn btn-sm" data-cmd="bold"><b>B</b></button>
                <button class="btn btn-sm" data-cmd="italic"><i>I</i></button>
                <button class="btn btn-sm" data-cmd="underline"><u>U</u></button>
                <button class="btn btn-sm" data-cmd="insertUnorderedList">•</button>
                <button class="btn btn-sm" data-cmd="insertOrderedList">1.</button>
                <button class="btn btn-sm" data-cmd="formatBlock" data-value="h2">H2</button>
                <button class="btn btn-sm" data-cmd="formatBlock" data-value="h3">H3</button>
                <span class="spacer"></span>
                <button class="btn btn-sm" id="exportNotePDF"><i data-lucide="file-down"></i> PDF</button>
            </div>
            <div id="noteEditor" contenteditable="true"></div>
        </div>
        <div>
            <div class="card">
                <div class="row"><b>Notas</b><span class="spacer"></span><button class="btn btn-sm" id="newNote"><i data-lucide="plus"></i></button></div>
                <div id="noteList" style="margin-top:8px; max-height: 20vh; overflow-y: auto;"></div>
            </div>
            <div class="card" style="margin-top:10px">
                <div class="row"><b>Lienzo</b><span class="spacer"></span><button class="btn btn-sm" id="clearCanvasBtn"><i data-lucide="eraser"></i></button></div>
                <div class="row" style="margin: 8px 0;"><input type="color" id="canvasColorPicker"><input type="range" id="canvasStrokeSlider" min="1" max="20" value="3"></div>
                <canvas id="drawingCanvas" width="250" height="180"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- TABLES -->
<div id="p-tab-tables" style="display:none; padding:10px;">
    <div class="row"><b>Tablas</b><span class="spacer"></span><button class="btn" id="newSheet"><i data-lucide="plus-square"></i> Tabla</button><button class="btn" id="addCol"><i data-lucide="plus"></i> Columna</button><button class="btn" id="addRow"><i data-lucide="plus"></i> Fila</button><button class="btn" id="exportCSV">CSV</button></div>
    <div class="section" id="sheetWrap" style="overflow:auto; margin-top:10px;"></div>
</div>

<!-- FILES -->
<div id="p-tab-files" style="display:none;padding:10px">
    <div class="row"><b>Archivos</b><span class="spacer"></span><label class="btn btn-primary"><i data-lucide="upload"></i> Subir Archivos<input id="fileInput" multiple type="file" style="display: none;"/></label></div>
    <div id="fileList" style="margin-top:10px" class="row"></div>
</div>

<!-- CHAT IA -->
<div id="p-tab-chat" style="display:none">
    <div class="gchat-grid" style="padding:10px;">
        <div>
            <div class="card">
                <div class="row"><b>Hilos de Chat</b><span class="spacer"></span><button class="btn btn-sm" id="newChat"><i data-lucide="plus"></i></button></div>
                <div id="chatList" style="margin-top:8px"></div>
            </div>
        </div>
        <div class="card" style="display:flex; flex-direction:column;">
            <div class="row" style="border-bottom: 1px solid var(--line); padding-bottom: 8px; margin-bottom: 8px;">
                <b>Modelo IA:</b>
                <button class="btn btn-sm active" data-model="normal" id="modelBtnNormal">Normal</button>
                <button class="btn btn-sm" data-model="web" id="modelBtnWeb">Búsqueda Web</button>
                <span class="spacer"></span>
                <button class="btn btn-sm" id="chatToTasks"><i data-lucide="list-plus"></i> Crear Tarea</button>
            </div>
            <div id="chatLog" class="chat-log" style="flex:1;"></div>
            <div class="row" style="padding-top:10px;">
                <input class="spacer" id="chatMsg" placeholder="Habla con la IA de tu proyecto…"/>
                <button class="btn btn-primary" id="sendMsg"><i data-lucide="send"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- FINANZAS -->
<div id="p-tab-finance" style="display:none; padding:10px;">
    <div class="row"><b>Finanzas del Proyecto</b><span class="spacer"></span><button class="btn btn-primary" id="finNew"><i data-lucide="plus"></i> Movimiento</button><button class="btn" id="finExport">CSV</button></div>
    <div class="overview-grid" style="padding: 10px 0;">
        <div class="stat-card"><h4>Ingresos Totales</h4><p id="finIn" style="color: var(--success);">0</p></div>
        <div class="stat-card"><h4>Egresos Totales</h4><p id="finOut" style="color: var(--danger);">0</p></div>
        <div class="stat-card"><h4>Balance Neto</h4><p id="finBal">0</p></div>
    </div>
    <div style="padding: 10px 0;">
        <table id="finTable" style="width:100%; border-collapse: collapse;">
            <thead><tr><th style="text-align: left; padding: 8px;">Fecha</th><th style="text-align: left; padding: 8px;">Tipo</th><th style="text-align: right; padding: 8px;">Monto</th><th style="text-align: left; padding: 8px;">Categoría</th><th style="text-align: left; padding: 8px;">Nota</th><th></th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
</section>
<!-- CRONOPOST, HUB, ETC. -->
<section class="panel" id="cronopost" style="display:none;">
    <div class="row" style="padding:12px; border-bottom: 1px solid var(--line);">
        <b>CronoPOST</b>
        <div class="chip">Proyecto:</div>
        <select id="cpProjectSelect" class="btn-sm"></select>
        <span class="spacer"></span>
        <button class="btn" id="cpPrevM"><i data-lucide="chevron-left"></i></button>
        <div class="chip" id="cpMonthLbl" style="min-width: 150px; justify-content: center;">Mes</div>
        <button class="btn" id="cpNextM"><i data-lucide="chevron-right"></i></button>
    </div>
    <div id="cronopost-grid" style="display:grid; grid-template-columns: 1fr 320px; gap: 10px; padding: 10px;">
        <div id="cpCalendarContainer">
            <div class="calendar" id="cpCalendar"></div>
        </div>
        <div id="cpIdeas">
            <div class="card">
                <div class="row"><b>💡 Banco de Ideas</b><span class="spacer"></span><button class="btn btn-primary btn-sm" id="cpGenAIIdeas"><i data-lucide="sparkles"></i> IA</button></div>
                <div id="cpIdeasList" style="max-height: 50vh; overflow-y: auto; padding-right: 5px; margin: 10px 0;"></div>
                <input id="cpNewIdeaInput" placeholder="Escribe una nueva idea..." style="margin-bottom: 8px;">
                <button class="btn" id="cpAddIdeaBtn" style="width: 100%;">+ Añadir Idea</button>
            </div>
        </div>
    </div>
</section>
<section class="panel" id="hub" style="display:none; padding: 10px;">
    <div class="hub-grid" style="display:grid; grid-template-columns: 360px 1fr; gap: 10px;">
    <div class="profile-card" style="background:var(--surface); border-radius:var(--radius); border:1px solid var(--line);">
        <div class="profile-header"></div>
        <div class="avatar-wrapper" style="padding: 0 20px;">
             <img alt="avatar" class="avatar" id="avatar" src="https://placehold.co/100x100/dde2ed/0b132a?text=TÚ"/>
             <input type="file" id="avatarInput" accept="image/*" style="display:none;">
        </div>
        <div style="padding: 0 20px 20px;">
            <h3 id="pNombreDisplay" style="margin: 0; display:inline-block; cursor:pointer;">Tu Nombre</h3>
            <p id="pRoleDisplay" class="sub" style="margin: 4px 0 10px; cursor:pointer;">Tu Rol Profesional</p>
            <p id="pBioDisplay" class="sub" style="font-size: var(--sm); cursor:pointer;">Tu biografía profesional. Habla sobre tu experiencia, tus habilidades y lo que buscas.</p>
            <div id="pSocialsDisplay" class="row"></div>
            <hr style="border-color:var(--line);"/>
            <b>Editar Perfil</b>
            <input id="pNombre" placeholder="Tu nombre" style="margin-top: 8px;"/>
            <input id="pRole" placeholder="Rol (Ej: Frontend Developer)" style="margin: 8px 0;"/>
            <textarea id="pBio" placeholder="Bio corta" rows="3" style="margin-bottom: 8px;"></textarea>
            <div class="row"><input id="pSocialLinkedin" placeholder="URL LinkedIn"/><input id="pSocialTwitter" placeholder="URL Twitter"/></div>
            <button class="btn btn-primary" id="savePerfil" style="width:100%; margin-top:10px;">Guardar Perfil</button>
        </div>
    </div>
    <div>
        <div class="tabs" style="padding:0; border-bottom:none; margin-bottom:10px;">
            <button class="tab active" data-htab="market">Mercado de Servicios</button>
            <button class="tab" data-htab="jobs">Bolsa de Empleos</button>
        </div>
        <div id="h-htab-market">
            <div class="card" style="margin-bottom: 10px;">
              <b>Publicar un nuevo producto o servicio</b>
              <div class="row"><input id="mkName" placeholder="Nombre"/><input id="mkPrice" placeholder="Precio (Ej: 500)" type="number"/></div>
              <textarea id="mkDesc" placeholder="Describe tu servicio..." rows="2" style="width:100%; margin: 8px 0;"></textarea>
              <button class="btn btn-primary" id="addMK">Publicar en Mercado</button>
            </div>
            <div id="mkList" style="max-height: 60vh; overflow-y:auto; padding: 5px;"></div>
        </div>
        <div id="h-htab-jobs" style="display:none;">
             <div class="card" style="margin-bottom: 10px;">
              <b>Publicar una nueva oferta de empleo</b>
              <div class="row" style="gap: 8px; margin-top: 8px;">
                <input id="jobTitle" placeholder="Título del Puesto" style="flex: 2;"/>
                <input id="jobCompany" placeholder="Empresa" style="flex: 1;"/>
              </div>
              <div class="row" style="gap: 8px; margin-top: 8px;">
                <input id="jobLocation" placeholder="Ubicación (Ej: Remoto)" style="flex: 1;"/>
                <input id="jobPay" placeholder="Salario (Ej: $2000/mes)" style="flex: 1;"/>
                <select id="jobType" style="flex: 1;">
                    <option>Tiempo Completo</option>
                    <option>Medio Tiempo</option>
                    <option>Por Proyecto</option>
                    <option>Freelance</option>
                </select>
              </div>
              <textarea id="jobDesc" placeholder="Descripción del puesto, requisitos, beneficios..." rows="4" style="width:100%; margin: 8px 0;"></textarea>
              <button class="btn btn-primary" id="addJob">Publicar Empleo</button>
            </div>
            <div class="row" style="padding: 0 5px; margin-bottom: 10px;">
                <i data-lucide="search" style="color: var(--sub);"></i>
                <input id="jobSearchInput" placeholder="Buscar empleos por título o empresa..." style="border:none; background: transparent; padding-left: 0;">
            </div>
            <div id="jobsList" style="max-height: 60vh; overflow-y:auto; padding: 5px;"></div>
        </div>
    </div>
</div>
</section>
<section class="panel" id="gchat" style="display:none">
    <div class="gchat-grid" style="display: grid; grid-template-columns: 260px 1fr; gap: 10px; padding: 10px; height: calc(100vh - 70px);">
        <div class="card" style="display:flex; flex-direction: column;">
            <b>Usuarios Conectados</b>
            <div id="gUserList" class="user-list" style="margin-top:8px; flex:1; overflow-y:auto;"></div>
        </div>
        <div class="card" style="display:flex; flex-direction:column;">
            <h3 id="gChatHeader" style="margin: 0 0 10px 0;">Chat Global: #general</h3>
            <div id="gChatLog" class="chat-log" style="flex:1;"></div>
            <div class="row" style="padding-top:10px;"><input class="spacer" id="gChatMsg" placeholder="Escribe un mensaje..."/><button class="btn btn-primary" id="sendGChat"><i data-lucide="send"></i></button></div>
        </div>
    </div>
</section>
<section class="panel" id="monet" style="display:none; padding: 10px;">
    <div class="card" style="text-align: center; background: linear-gradient(145deg, color-mix(in hsl, var(--brand) 85%, black), color-mix(in hsl, var(--accent) 85%, black)); color: white;">
        <h2 style="margin:0;">Asistente de Monetización Quantum Pro</h2>
        <p style="opacity: 0.8;">Transforma tus ideas en ingresos. Selecciona un módulo para empezar.</p>
    </div>
    <div id="monet-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; margin-top: 10px;">
    </div>
</section>
<section class="panel" id="mindset" style="display:none; padding: 10px;">
    <div class="card" style="text-align:center;">
        <h3>Tu Dosis Diaria de Inspiración</h3>
        <p class="sub" id="mindsetQuote">"El éxito es la suma de pequeños esfuerzos repetidos día tras día."</p>
        <div class="row" style="margin-top: 16px; justify-content:center;">
            <label for="mindset-freq">Frecuencia de Notificaciones:</label>
            <select id="mindset-freq">
                <option value="off">Desactivado</option>
                <option value="hourly">Cada hora</option>
                <option value="thrice">3 veces al día</option>
                <option value="daily">Diariamente</option>
            </select>
            <button class="btn btn-primary" id="saveMindset">Guardar</button>
        </div>
    </div>
</section>
<section class="panel" id="settings" style="display:none;padding:10px">
<div class="card">
<b>Ajustes de la Aplicación</b>
<div class="row" style="margin-top:8px"><button class="btn" id="btnExport">Exportar Datos (.json)</button><label class="btn">Importar Datos<input type="file" accept="application/json" id="btnImport" style="display:none;"/></label><button class="btn" id="resetApp" style="background:var(--danger); color:white;">Reset Total</button></div>
<div class="section tip"><i data-lucide="database"></i> Todo se guarda offline en tu navegador (localStorage). Para colaborar, se necesita una base de datos como Firebase.</div>
</div>
</section>
<!-- MODALS -->
<dialog id="industryModal">
    <div style="padding: 24px; text-align: center;">
        <i data-lucide="briefcase" width="48" height="48" style="color: var(--brand);"></i>
        <h2 style="margin-top: 10px;">¡Bienvenido a Goatify IA!</h2>
        <p class="sub">Para empezar, personalicemos tu espacio de trabajo. ¿Cuál es tu industria o tipo de negocio?</p>
        <div class="card" style="text-align: left;">
             <label for="industrySelect">Selecciona tu Industria:</label>
             <select id="industrySelect" style="width: 100%; margin: 12px 0;">
                <option value="agency">Agencia de Marketing / Servicios</option>
                <option value="ecommerce">E-commerce / Tienda Online</option>
                <option value="creator">Creador de Contenido / Marca Personal</option>
                <option value="generic">Otro / General</option>
            </select>
            <button class="btn btn-primary" id="loadIndustryBtn" style="width: 100%;">Personalizar y Empezar</button>
        </div>
    </div>
</dialog>
<dialog id="newProjectModal">
    <div style="padding: 24px;">
        <h3 style="margin-top:0">Crear Nuevo Proyecto</h3>
        <p class="sub">Dale un nombre y un color a tu nuevo espacio de trabajo.</p>
        <input id="newProjectName" placeholder="Ej: Lanzamiento de App Móvil" style="margin-bottom: 12px;"/>
        <div class="row"><label for="newProjectColor">Color del Proyecto:</label><input type="color" id="newProjectColor" value="#a78bfa"/></div>
        <div class="row" style="margin-top: 24px;">
            <button class="btn" onclick="$('#newProjectModal').close()">Cancelar</button>
            <span class="spacer"></span>
            <button class="btn btn-primary" id="newProjectCreate">Crear Proyecto</button>
        </div>
    </div>
</dialog>
<dialog id="creditsModal">
    <div style="padding: 24px; text-align: center;">
        <button onclick="$('#creditsModal').close()" class="btn btn-ghost" style="position:absolute; top:10px; right:10px;"><i data-lucide="x"></i></button>
        <h2 style="margin-top: 0;">🚀 Desbloquea tu Potencial con Goatify PRO</h2>
        <p class="sub">La versión gratuita te da 100 créditos para probar las funciones de IA. Cuando se acaben, ciertas acciones estarán limitadas.</p>
        <div class="card" style="text-align: left; background: color-mix(in hsl, var(--brand) 8%, transparent); border-left: 4px solid var(--brand);">
            <h3 style="margin-top:0;">Membresía PRO - $4 USD / mes</h3>
            <ul id="pricingList" style="padding-left: 20px;"></ul>
        </div>
        <button class="btn btn-primary" style="width: 100%; margin-top: 16px; padding: 12px;">Obtener Goatify PRO</button>
    </div>
</dialog>
<dialog id="aiAssistantModal">
    <div style="padding: 24px; display: flex; flex-direction: column; height: 80vh;">
         <div class="row">
            <h3 style="margin-top:0"><i data-lucide="bot"></i> Asistente de Goatify</h3>
            <span class="spacer"></span>
            <button onclick="$('#aiAssistantModal').close()" class="btn btn-ghost"><i data-lucide="x"></i></button>
        </div>
        <p class="sub">Soy tu guía. Pregúntame algo o usa los botones para empezar.</p>
        <div id="assistantChatLog" class="chat-log" style="flex:1; margin: 10px 0;"></div>
        <div id="assistantQuickBtns" class="row" style="padding: 10px 0; justify-content: center; flex-wrap: wrap; gap: 8px;"></div>
        <div class="row">
            <input class="spacer" id="assistantChatInput" placeholder="Haz una pregunta..."/>
            <button class="btn btn-primary" id="sendAssistantChat"><i data-lucide="send"></i></button>
        </div>
    </div>
</dialog>
<dialog id="videoCallModal">
    <div style="padding: 24px; text-align: center;">
        <h3 id="videoCallTitle">Llamando a...</h3>
        <p class="sub">Esperando que acepte la llamada.</p>
        <div style="width: 120px; height: 120px; border-radius: 50%; background: var(--muted); margin: 20px auto; display:flex; align-items:center; justify-content:center;"><i data-lucide="video" size="48"></i></div>
        <button class="btn" style="background:var(--danger); color:white;" onclick="$('#videoCallModal').close()">Cancelar Llamada</button>
    </div>
</dialog>
<dialog id="monetModuleModal">
    <div style="padding: 24px; display: flex; flex-direction: column; max-height: 85vh;">
         <div class="row">
            <h3 id="monetModuleTitle" style="margin-top:0; color: var(--brand);"></h3>
            <span class="spacer"></span>
            <button onclick="$('#monetModuleModal').close()" class="btn btn-ghost"><i data-lucide="x"></i></button>
        </div>
        <div id="monetModuleContent" style="overflow-y: auto; padding-right: 10px;"></div>
    </div>
</dialog>
<dialog id="walletModal">
    <div style="padding: 24px; display: flex; flex-direction: column; max-height: 85vh;">
        <div class="row">
            <h3 style="margin-top:0"><i data-lucide="wallet"></i> Billetera General</h3>
            <span class="spacer"></span>
            <button onclick="$('#walletModal').close()" class="btn btn-ghost"><i data-lucide="x"></i></button>
        </div>
        <p class="sub">Registra aquí todos los ingresos y egresos de tus proyectos para tener un control financiero centralizado.</p>
        <div class="card" style="margin: 10px 0;">
            <div class="row"><input id="wMonto" placeholder="Monto" type="number" step="0.01"/><select id="wTipo"><option>Ingreso</option><option>Egreso</option></select></div>
            <div class="row" style="margin-top:8px"><input id="wCat" placeholder="Categoría" class="spacer"/><input id="wNota" placeholder="Nota" class="spacer"/></div>
            <button class="btn btn-primary" id="wAdd" style="width:100%; margin-top:8px;">+ Añadir Movimiento</button>
        </div>
        <div style="overflow-y: auto; padding-right: 10px;">
            <table style="width:100%;">
                <thead><tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Cat</th><th>Nota</th><th></th></tr></thead>
                <tbody id="wBody"></tbody>
            </table>
        </div>
    </div>
</dialog>
<dialog id="intisModal">
     <div style="padding: 24px; text-align: center;">
        <button onclick="$('#intisModal').close()" class="btn btn-ghost" style="position:absolute; top:10px; right:10px;"><i data-lucide="x"></i></button>
        <i data-lucide="sparkles" width="48" height="48" style="color: var(--brand);"></i>
        <h2 style="margin-top: 10px;">¿Qué son los Intis? ✨</h2>
        <p class="sub">Los Intis son nuestra moneda de gamificación, diseñada para fomentar una economía circular y colaborativa dentro de Goatify.</p>
        <div class="card" style="text-align: left;">
            <h4 style="margin-top:0">¿Cómo ganas Intis?</h4>
            <ul style="padding-left: 20px;">
                <li>🚀 Creando un nuevo proyecto.</li>
                <li>✅ Completando tareas.</li>
                <li>🤝 Publicando en el Hub Profesional (empleos y servicios).</li>
                <li>💬 Participando en el Chat Global.</li>
            </ul>
             <h4 style="margin-top:1em;">¿Para qué sirven?</h4>
             <p>Actualmente, los Intis sirven para medir tu progreso y participación. En el futuro, podrás usarlos para canjear recompensas, acceder a funciones exclusivas y realizar transacciones dentro del mercado.</p>
        </div>
    </div>
</dialog>
<!-- TOAST NOTIFICATION -->
<div id="toast" class="info"></div>
</main>
</div>
<script>
// ====== State ======
var S = {};
const initialState = {
  version:'8.0',
  userProfile: { industry: null },
  projects: [],
  activeProject: null,
  activeNav: 'hub',
  folders: {},
  tasks: {},
  notes: {},
  chats: {},
  tables: {},
  files: {},
  fin: {},
  cronopost: { posts: {}, ideas: {} },
  hub: { 
    perfil: { id:'u_me', nombre:'Tu Nombre', rol:'Emprendedor Digital', bio:'¡Listo para conquistar el mundo digital!', avatar: null, socials: {linkedin:'', twitter:''}},
    market:[],
    jobs:[],
    users: [ // Simulated users for collaboration
        {id: 'u_ana', nombre: 'Ana', rol: 'Diseñadora UX', online: true, avatar: 'https://placehold.co/100x100/f87171/ffffff?text=A'},
        {id: 'u_carlos', nombre: 'Carlos', rol: 'Copywriter', online: false, avatar: 'https://placehold.co/100x100/38bdf8/ffffff?text=C'},
        {id: 'u_elena', nombre: 'Elena', rol: 'Project Manager', online: true, avatar: 'https://placehold.co/100x100/22c55e/ffffff?text=E'},
    ]
  },
  gchat: { messages:{'general': []}, dms: {}, activeChat: 'general' },
  monet: {},
  mindset: { frequency: 'daily' },
  wallet: { movs: [] },
  intis: 0,
  assistant: { history: [] },
  credits: 100,
};

function save(){ 
    try {
        localStorage.setItem('goatify_v8', JSON.stringify(S)); 
        syncHeader();
    } catch(e) {
        console.error("Error saving to localStorage", e);
        showToast("Error: Los datos son demasiado grandes para guardar localmente.", "warn");
    }
}
function load(){
  const raw = localStorage.getItem('goatify_v8');
  S = raw ? JSON.parse(raw) : JSON.parse(JSON.stringify(initialState));
  // Ensure backward compatibility or state structure
  if (!S.userProfile) S.userProfile = { industry: null };
  if (!S.hub || !S.hub.users) S.hub = initialState.hub;
  if (!S.hub.jobs) S.hub.jobs = [];
  if (!S.gchat) S.gchat = initialState.gchat;
  if (!S.wallet) S.wallet = { movs: [] };
  if (!S.intis) S.intis = 0;
  if (!S.assistant) S.assistant = { history: [] };
  syncHeader();
}
function syncHeader(){
  const walletBalance = (S.wallet.movs || []).reduce((acc, mov) => acc + (mov.tipo === 'Ingreso' ? mov.monto : -mov.monto), 0);
  $('#wallet-amount').textContent = `$${walletBalance.toFixed(2)}`;
  $('#intis-amount').textContent = S.intis;
  $('#credits-amount').textContent = S.credits > 0 ? `${S.credits} créditos` : 'Agotados';
}
function useCredits(amount) {
    if (S.credits <= 0) {
        showToast("Créditos agotados. ¡Actualiza a PRO!", "warn");
        $('#creditsModal').showModal();
        return false;
    }
    S.credits -= amount;
    save();
    return true;
}
function addIntis(points, reason) {
    S.intis += points;
    save();
    showToast(`+${points} Intis ✨ (${reason})`, 'info');
}

// ====== Helpers ======
const $ = sel=>document.querySelector(sel);
const $$ = sel=>Array.from(document.querySelectorAll(sel));
function el(tag, attrs={}, ...kids){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='dataset'){ Object.entries(v).forEach(([dk,dv])=>e.dataset[dk]=dv); }
    else if(k==='html'){ e.innerHTML = v; }
    else if(k==='textContent'){ e.textContent = v; }
    else if(k.startsWith('on')) { e[k] = v; }
    else e.setAttribute(k,v);
  });
  kids.forEach(k=>{ if(k) e.append(k); });
  return e;
}
function fmtDate(d){ const dt = new Date(d); return dt.toLocaleString(); }
function csv(rows){ return rows.map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n'); }
function download(filename, text){
  const a = el('a',{href:URL.createObjectURL(new Blob([text],{type:'text/plain'})), download:filename});
  document.body.appendChild(a); a.click(); a.remove();
}
let toastTimeout;
function showToast(message, type = 'info') {
    const toast = $('#toast');
    if (!toast) return;
    toast.textContent = message;
    toast.className = '';
    toast.classList.add(type, 'show');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 3000);
}
const colorPalette = ["#ef4444", "#f97316", "#eab308", "#84cc16", "#22c55e", "#14b8a6", "#06b6d4", "#3b82f6", "#8b5cf6", "#d946ef", "#ec4899"];
function getRandomColor() { return colorPalette[Math.floor(Math.random() * colorPalette.length)]; }

// ====== UI: Navigation & Core ======
function renderAside(){
  const list = $('#projList'); list.innerHTML='';
  S.projects.forEach(p=>{
    const item = el('div',{class:'projItem', dataset: {id: p.id}, onclick: ()=> openProject(p.id)},
        el('div', {class:'proj-color-dot', style:`background-color:${p.color}`}),
        el('span',{textContent:p.name, style:'flex:1'}),
    );
    if (p.id === S.activeProject) item.classList.add('active');
    list.appendChild(item);
  });
  $$('.navBtn[data-nav]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.nav === S.activeNav && !S.activeProject);
  });
}
function show(sectionId){
  $$('main > section').forEach(s => s.style.display = 'none');
  const s = $('#'+sectionId);  
  if(s) s.style.display='block';
  S.activeNav = sectionId;
  S.activeProject = null;
  save();
  renderAside();
  document.body.classList.remove('aside-open');
}
function openProject(id){
  S.activeProject = id;
  S.activeNav = null;
  save();
  $$('main > section').forEach(s => s.style.display = 'none');
  $('#projectShell').style.display='block';
  const p = S.projects.find(x=>x.id===id);
  $('#projectNameChip').textContent = p?.name || 'Proyecto';
  $('#projectNameChip').style.borderLeft = `3px solid ${p?.color || 'var(--brand)'}`;

  const folderSel = $('#folderSel');
  folderSel.innerHTML = '';
  (S.folders[id] || ['General']).forEach(f => folderSel.append(el('option', {textContent: f})));

  renderAside();
  renderProject();
  $('#projectShell .tabs .tab[data-ptab="overview"]')?.click();
}
function renderProject() {
    renderOverview();
    renderTasks();
    renderCalendar();
    renderNotes();
    renderTables();
    renderFiles();
    renderProjectChat();
    renderFin();
}

// ====== Projects CRUD ======
function createNewProject() {
    const name = $('#newProjectName').value.trim();
    if(!name) { showToast('Ingresa un nombre para el proyecto.', 'warn'); return; }
    const id = 'p' + Date.now();
    const color = $('#newProjectColor').value;
    S.projects.push({id, name, color});
    S.folders[id]=['General'];
    S.tasks[id]=[]; 
    S.notes[id]={list:[], active:null, bodies:{}, drawings:{}}; 
    S.chats[id]={threads:[], messages:{}, activeThread: null, model: 'normal'};
    S.tables[id]={cols:['Col 1'], rows:[]};
    S.files[id]=[];
    S.fin[id]={rows:[]};
    S.cronopost.posts[id] = {}; 
    S.cronopost.ideas[id] = [];
    addIntis(50, 'Proyecto nuevo');
    showToast('Proyecto creado!', 'success');
    save();  
    renderAside();  
    openProject(id);
    $('#newProjectName').value = '';
    $('#newProjectModal').close();
}

// ====== PROJECT SUB-MODULES ======
let calRef=new Date();

function renderOverview(){
    const id = S.activeProject; if(!id) return;
    const wrap = $('#ovr'); wrap.innerHTML = '';
    const tasks = S.tasks[id] || [];
    const finance = S.fin[id] || {rows:[]};
    const notes = S.notes[id]?.list || [];
    const files = S.files[id] || [];

    // --- Stats Grid ---
    const statsGrid = el('div', { class: 'overview-grid' });
    const createStatCard = (title, value, icon, color) => {
        return el('div', { class: 'stat-card', style: 'display:flex; align-items:center; gap:12px;' },
            el('div', { style: `padding:10px; border-radius:50%; background:color-mix(in hsl, ${color} 15%, transparent); color:${color}`}, el('i', {'data-lucide': icon})),
            el('div', {},
                el('h4', { textContent: title, style:'margin:0; font-size:var(--sm)' }),
                el('p', { textContent: value, style:'margin:0; font-size:var(--lg)' })
            )
        );
    };

    const done = tasks.filter(x => x.status === 'Hecho').length;
    const totalTasks = tasks.length;
    const progress = totalTasks > 0 ? Math.round(done / totalTasks * 100) : 0;
    const sumIn = finance.rows.reduce((a, b) => a + (b.tipo === 'Ingreso' ? Number(b.monto) : 0), 0);
    const sumOut = finance.rows.reduce((a, b) => a + (b.tipo === 'Egreso' ? Number(b.monto) : 0), 0);

    statsGrid.append(createStatCard('Progreso de Tareas', `${progress}%`, 'check-circle', 'var(--brand)'));
    statsGrid.append(createStatCard('Tareas Pendientes', `${totalTasks - done}`, 'list-todo', 'var(--warn)'));
    statsGrid.append(createStatCard('Balance Neto', `$${(sumIn - sumOut).toFixed(2)}`, 'scale', 'var(--success)'));
    statsGrid.append(createStatCard('Archivos y Notas', `${files.length + notes.length}`, 'file-text', 'var(--accent)'));
    wrap.append(statsGrid);

    // --- Recent Activity ---
    const activityWrapper = el('div', { class: 'card', style: 'margin-top: 16px; background:var(--surface)' });
    const activityHeader = el('h3', {textContent: 'Actividad Reciente', style: 'padding:16px; margin:0; border-bottom: 1px solid var(--line);'});
    const activityList = el('div', { id: 'recentActivityList', style:'max-height: 300px; overflow-y: auto; padding: 8px;'});
    
    // Combine different activities and sort by a pseudo-date
    const allActivities = [
        ...tasks.map(t => ({...t, type: 'task', date: t.id.substring(1)})),
        ...finance.rows.map(f => ({...f, type: 'fin', date: new Date(f.fecha).getTime()})),
    ].sort((a, b) => b.date - a.date).slice(0, 10);

    if (allActivities.length > 0) {
        allActivities.forEach(item => {
            let icon, text, detail;
            if (item.type === 'task') {
                icon = item.status === 'Hecho' ? 'check-circle' : 'plus-circle';
                text = `Tarea "${item.title}"`;
                detail = `marcada como ${item.status}`;
            } else if (item.type === 'fin') {
                icon = item.tipo === 'Ingreso' ? 'arrow-down-circle' : 'arrow-up-circle';
                text = `Movimiento de $${item.monto}`;
                detail = `en ${item.cat}`;
            }
            activityList.append(el('div', { style: 'padding: 8px 16px; display:flex; align-items:center; gap:10px; border-bottom: 1px solid var(--muted)' },
                el('i', {'data-lucide': icon, style:`color: ${item.tipo === 'Ingreso' ? 'var(--success)' : 'var(--sub)'}`}),
                el('span', {textContent: text}),
                el('span', {class:'spacer'}),
                el('span', {class:'sub', style:'font-size:var(--sm)', textContent: detail})
            ));
        });
    } else {
        activityList.innerHTML = `<div class="empty-state" style="padding:20px;">No hay actividad reciente.</div>`;
    }
    activityWrapper.append(activityHeader, activityList);
    wrap.append(activityWrapper);

    lucide.createIcons();
}


// --- TASKS (Kanban) ---
function renderTasks(){
  const id=S.activeProject; if(!id) return;
  const tasks=S.tasks[id]||[];
  const cols=['Backlog','En curso','Bloqueado','Hecho'];
  const board=$('#kanban'); board.innerHTML='';
  cols.forEach(c=>{
    const colEl=el('div',{class:'col',dataset:{status:c}},
      el('div',{class:'row', style:'padding:8px;'}, el('b',{textContent:c}), el('span',{class:'spacer'}), el('span', {class:'chip', textContent: tasks.filter(t=>t.status===c).length}))
    );
    tasks.filter(t=>t.status===c).forEach(t=>{
      const taskEl=el('div',{class:'task',draggable:'true', style:'border-left: 3px solid ' + (S.projects.find(p=>p.id===id)?.color || 'var(--brand)')},
        el('div',{ contentEditable: true, textContent:t.title, onblur: (e) => { t.title = e.target.textContent; save(); } }),
        el('div', {class:'row', style:'margin-top:8px;'},
            el('span', {class:'spacer'}),
            el('button', {class:'btn btn-ghost btn-sm', onclick:()=>deleteTask(t.id)}, el('i',{'data-lucide':'trash-2', 'width':14}))
        )
      );
      taskEl.ondragstart=e=>e.dataTransfer.setData('text/plain',t.id);
      colEl.appendChild(taskEl);
    });
    colEl.ondragover=e=>{e.preventDefault(); colEl.classList.add('dragover');};
    colEl.ondragleave=()=>colEl.classList.remove('dragover');
    colEl.ondrop=e=>{
      colEl.classList.remove('dragover');
      const tid=e.dataTransfer.getData('text'); const t=tasks.find(x=>x.id===tid);
      if (t) { 
        t.status=c; 
        if(c==='Hecho') addIntis(10, 'Tarea completada');
        save(); renderTasks(); 
      }
    };
    board.appendChild(colEl);
  });
  lucide.createIcons();
}
function quickAddTask() {
    const id=S.activeProject; if(!id) return;
    const title = prompt("Nueva tarea:", "");
    if (!title) return;
    S.tasks[id].push({id:'t'+Date.now(), title, status:'Backlog'});
    addIntis(5, 'Tarea creada');
    save(); renderTasks(); renderOverview();
}
function deleteTask(taskId) {
    if (!confirm('¿Eliminar esta tarea?')) return;
    const id = S.activeProject;
    S.tasks[id] = S.tasks[id].filter(t => t.id !== taskId);
    save(); renderTasks(); renderOverview();
}

// --- CALENDAR ---
function renderCalendar(){
  const id=S.activeProject; if(!id) return;
  $('#monthLbl').textContent = calRef.toLocaleString('es', {month:'long', year:'numeric'});
  const grid=$('#calGrid'); grid.innerHTML='';
  const monthGrid = (ref=new Date()) => {
      const y=ref.getFullYear(), m=ref.getMonth();
      const first=new Date(y,m,1);
      const start = new Date(first); start.setDate(1-((first.getDay()+6)%7));
      const days=[]; let cur=new Date(start);
      while(days.length < 42){ days.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
      return days;
  }
  monthGrid(calRef).forEach(d=>{
    const day=el('div',{class:'day'});
    if(d.getMonth() !== calRef.getMonth()) day.style.opacity = .4;
    day.append(el('div',{class:'sub', textContent:d.getDate()}));
    (S.tasks[id]||[]).filter(t=>t.due && new Date(t.due).toDateString()===d.toDateString()).forEach(t=>{
      day.append(el('div',{class:'cp-post',textContent:t.title}));
    });
    grid.append(day);
  });
}

// --- NOTES & DRAWING ---
let currentDrawingNoteId = null;
function renderNotes(){
    const id=S.activeProject; if(!id) return;
    const N=S.notes[id];
    const list=$('#noteList'); list.innerHTML='';
    N.list.forEach(n=>{
        const it=el('div',{class:'projItem', textContent:n.title, onclick:()=>{N.active=n.id; save(); renderNotes();}});
        if(n.id===N.active) it.classList.add('active');
        list.append(it);
    });
    if(!N.active && N.list.length > 0) N.active=N.list[0].id;
    const editor = $('#noteEditor');
    editor.innerHTML = (N.active? (N.bodies[N.active]||'') : 'Selecciona o crea una nota.');
    editor.oninput=()=>{ if(N.active){ N.bodies[N.active]=editor.innerHTML; save(); } };
    
    if (N.active && N.active !== currentDrawingNoteId) {
        initDrawingCanvas(N.active);
        currentDrawingNoteId = N.active;
    }
}
function initDrawingCanvas(noteId) {
    const canvas = $('#drawingCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    if (S.notes[S.activeProject].drawings[noteId]) {
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0);
        img.src = S.notes[S.activeProject].drawings[noteId];
    } else {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    const start = (e) => { drawing = true; draw(e); };
    const end = () => {
        drawing = false;
        ctx.beginPath();
        S.notes[S.activeProject].drawings[noteId] = canvas.toDataURL();
        save();
    };
    const draw = (e) => {
        if (!drawing) return;
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const y = (e.clientY || e.touches[0].clientY) - rect.top;
        ctx.lineWidth = $('#canvasStrokeSlider').value;
        ctx.lineCap = 'round';
        ctx.strokeStyle = $('#canvasColorPicker').value;
        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
    };

    canvas.onmousedown = start; canvas.onmouseup = end; canvas.onmousemove = draw;
    canvas.ontouchstart = start; canvas.ontouchend = end; canvas.ontouchmove = draw;
}
function exportNote(format) {
    const id = S.activeProject; const noteId = S.notes[id]?.active;
    if (!noteId) return showToast("Selecciona una nota para exportar.", "warn");
    const title = S.notes[id].list.find(n => n.id === noteId)?.title || "Nota";
    const content = S.notes[id].bodies[noteId] || "";

    if (format === 'pdf') {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.text(title, 10, 10);
        doc.html(content, { callback: (doc) => { doc.save(`${title}.pdf`); }, x: 10, y: 20, width: 180, windowWidth: 800 });
    }
}
// --- TABLES, FILES, FINANCE ---
function renderTables(){
  const id=S.activeProject; if(!id) return;
  const wrap=$('#sheetWrap'); wrap.innerHTML='';
  const T=S.tables[id];
  if (!T || !T.cols || T.cols.length === 0) {
      wrap.innerHTML = `<div class="empty-state"><i data-lucide="table-2" width="48" height="48"></i><h4>No hay tablas.</h4><p>Crea una para empezar a organizar datos.</p></div>`;
      lucide.createIcons();
      return;
  }
  const tbl=el('table',{style:'width:100%; border-collapse: collapse;'});
  const thead=el('thead',{}, el('tr',{}, ...T.cols.map(c=>el('th',{textContent:c, style:'border: 1px solid var(--line); padding: 8px;'}))));
  const tbody=el('tbody',{});
  (T.rows || []).forEach(r=>{
    const tr=el('tr',{}, ...T.cols.map((c,ci)=>el('td',{style:'border: 1px solid var(--line); padding: 0;'}, el('input',{value:r[ci]||'', style:'border:none; background:transparent; padding: 8px; width: 100%;', onchange:(e)=>{r[ci]=e.target.value; save();}}))));
    tbody.appendChild(tr);
  });
  tbl.append(thead,tbody);
  wrap.append(tbl);
}
function renderFiles(){
  const id=S.activeProject; if(!id) return;
  const L=S.files[id]||[]; const wrap=$('#fileList'); wrap.innerHTML='';
  if (L.length === 0) {
      wrap.innerHTML = `<div class="empty-state" style="width:100%"><i data-lucide="file-up" width="48" height="48"></i><h4>No hay archivos.</h4><p>Sube documentos, imágenes, etc.</p></div>`;
      lucide.createIcons();
      return;
  }
  L.forEach((f,idx)=>{
      const fileChip = el('div', {class:'chip'},  
        el('a',{href:f.url,download:f.name, textContent:f.name}),
        el('button', {class: 'btn btn-ghost btn-sm', onclick:()=>{ L.splice(idx,1); save(); renderFiles(); renderOverview(); }}, el('i', {'data-lucide':'trash-2', width:14}))
      );
      wrap.append(fileChip);
  });
  lucide.createIcons();
}
function renderFin(){
  const id=S.activeProject; if(!id) return;
  const F=S.fin[id]; const tbody=$('#finTable tbody'); tbody.innerHTML='';
  (F.rows || []).forEach((r,i)=>{
    const tr=el('tr',{}, 
        el('td',{textContent:fmtDate(r.fecha), style:'padding:8px'}), 
        el('td',{textContent:r.tipo, style:'padding:8px'}), 
        el('td',{textContent:'$'+Number(r.monto).toFixed(2), style:'text-align:right; padding:8px'}), 
        el('td',{textContent:r.cat, style:'padding:8px'}), 
        el('td',{textContent:r.nota, style:'padding:8px'}),
        el('td',{}, el('button',{class:'btn btn-ghost btn-sm',onclick:()=>{F.rows.splice(i,1); save(); renderFin(); renderOverview();}}, el('i',{'data-lucide':'trash-2', width:14})))
    );
    tbody.appendChild(tr);
  });
  const sumIn=F.rows.reduce((a,b)=>a+(b.tipo==='Ingreso' ? Number(b.monto) : 0),0);
  const sumOut=F.rows.reduce((a,b)=>a+(b.tipo==='Egreso' ? Number(b.monto) : 0),0);
  $('#finIn').textContent='$'+sumIn.toFixed(2);
  $('#finOut').textContent='$'+sumOut.toFixed(2);
  $('#finBal').textContent='$'+(sumIn-sumOut).toFixed(2);
  lucide.createIcons();
}

// --- CHAT IA (Unchanged) ---
function renderProjectChat() {
    const pid = S.activeProject; if (!pid) return;
    const C = S.chats[pid];
    const list = $('#chatList'); list.innerHTML = '';
    C.threads.forEach(th => {
        const it = el('div', { class: 'projItem', dataset: { id: th.id }, textContent: th.title, onclick: () => { C.activeThread = th.id; save(); renderProjectChat(); } });
        if (th.id === C.activeThread) it.classList.add('active');
        list.append(it);
    });

    if (!C.activeThread && C.threads.length > 0) C.activeThread = C.threads[0].id;
    $$('[data-model]').forEach(b => b.classList.toggle('active', C.model === b.dataset.model));
    const log = $('#chatLog'); log.innerHTML = '';
    if (C.activeThread) {
        (C.messages[C.activeThread] || []).forEach(m => {
            const body = el('div', {class:'msg-body', textContent: m.text});
            if (m.who === 'IA' && m.type === 'web') body.classList.add('ia-web-result');
            const div = el('div', {class:'msg'}, el('small', {class:'sub', textContent:`${m.who} • ${new Date(m.at).toLocaleTimeString()}`}), body);
            log.append(div);
        });
        log.scrollTop = log.scrollHeight;
    }
}
function sendProjectChatMessage() {
    const pid = S.activeProject; if (!pid || !S.chats[pid].activeThread) return;
    const msg = $('#chatMsg').value.trim(); if (!msg) return;
    if (!useCredits(1)) return;
    const C = S.chats[pid];
    const threadId = C.activeThread;
    if (!C.messages[threadId]) C.messages[threadId] = [];
    C.messages[threadId].push({ who: 'Tú', at: new Date(), text: msg });
    $('#chatMsg').value = '';
    renderProjectChat();
    setTimeout(() => {
        const model = C.model;
        let responseText = `Como modelo de IA, mi sugerencia para "${msg}" sería dividirlo en tareas más pequeñas.`;
        if (model === 'web') {
            responseText = `[Búsqueda Web] Para "${msg}", los resultados sugieren enfocarse en marketing de contenidos.`;
        }
        C.messages[threadId].push({ who: 'IA', at: new Date(), text: responseText, type: model });
        save();
        renderProjectChat();
    }, 1500);
}


// ====== GLOBAL MODULES ======
// --- CRONOPOST ---
let cpRef = new Date();
function renderCronoPOST() {
    const sel = $('#cpProjectSelect');
    const currentSelection = sel.value; // Preserve selection
    sel.innerHTML = '';
    sel.append(el('option', { value: 'all', textContent: 'Todos los Proyectos' }));
    S.projects.forEach(p => sel.append(el('option', { value: p.id, textContent: p.name })));
    sel.value = S.projects.find(p => p.id === currentSelection) ? currentSelection : 'all'; // Restore or default to 'all'

    const activeProjectId = sel.value;

    $('#cpMonthLbl').textContent = cpRef.toLocaleString('es', { month: 'long', year: 'numeric' });
    const calendarEl = $('#cpCalendar');
    calendarEl.innerHTML = '';

    // Add day headers
    const headerRow = el('div',{class:'calendar-header', style:'display:contents;'});
    ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'].forEach(day => {
        headerRow.append(el('div', { class: 'day-header', textContent: day, style: 'text-align:center; font-weight: 600; color: var(--sub); padding-bottom: 8px; font-size: var(--sm);' }));
    });
    calendarEl.append(headerRow);

    const monthGrid = (ref = new Date()) => {
        const y = ref.getFullYear(), m = ref.getMonth();
        const first = new Date(y, m, 1);
        const start = new Date(first);
        start.setDate(1 - ((first.getDay() + 6) % 7)); // Start on Monday
        const days = [];
        let cur = new Date(start);
        while (days.length < 35) { // 5 weeks for a cleaner look
            days.push(new Date(cur));
            cur.setDate(cur.getDate() + 1);
        }
        return days;
    };

    const projectsToShow = activeProjectId === 'all'
        ? S.projects
        : S.projects.filter(p => p.id === activeProjectId);

    monthGrid(cpRef).forEach(d => {
        const dateKey = d.toDateString();
        const dayEl = el('div', { class: 'day', dataset: { date: dateKey } });
        if(d.getMonth() !== cpRef.getMonth()) dayEl.style.opacity = .5;

        const dayNumber = el('div', { class:'day-number', textContent: d.getDate(), style: 'font-weight: 500; color: var(--sub); margin-bottom: 4px; text-align: right; font-size: var(--sm);' });
        dayEl.append(dayNumber);

        projectsToShow.forEach(proj => {
            const posts = S.cronopost.posts[proj.id] || {};
            (posts[dateKey] || []).forEach(p => {
                const postEl = el('div', {
                    class: 'cp-post',
                    textContent: p.title,
                    title: `${proj.name}: ${p.title}`, // Tooltip
                    style: `border-left-color:${proj.color}; background: color-mix(in hsl, ${proj.color} 15%, transparent);`
                });
                dayEl.append(postEl);
            });
        });

        dayEl.ondragover = (e) => { e.preventDefault(); dayEl.style.background = 'var(--muted)'; };
        dayEl.ondragleave = (e) => { dayEl.style.background = 'var(--surface)'; };
        dayEl.ondrop = (e) => {
            e.preventDefault();
            dayEl.style.background = 'var(--surface)';
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const dateKey = dayEl.dataset.date;
            const projectId = $('#cpProjectSelect').value;

            if (data.type === 'idea' && projectId !== 'all') {
                if (!S.cronopost.posts[projectId]) S.cronopost.posts[projectId] = {};
                if (!S.cronopost.posts[projectId][dateKey]) S.cronopost.posts[projectId][dateKey] = [];
                S.cronopost.posts[projectId][dateKey].push({ id: 'post' + Date.now(), title: data.title });
                S.cronopost.ideas[projectId] = S.cronopost.ideas[projectId].filter(i => i.id !== data.id);
                save();
                renderCronoPOST();
                showToast(`'${data.title}' agendado!`, 'success');
            } else {
                showToast('Selecciona un proyecto específico para agendar ideas.', 'warn');
            }
        };
        calendarEl.append(dayEl);
    });

    const ideasList = $('#cpIdeasList');
    ideasList.innerHTML = '';
    const ideasContainer = $('#cpIdeas');
    if (activeProjectId !== 'all') {
        ideasContainer.style.opacity = 1;
        const ideas = S.cronopost.ideas[activeProjectId] || [];
        if (ideas.length === 0) {
             ideasList.innerHTML = `<div class="empty-state" style="padding: 10px; font-size: var(--sm);">Añade tu primera idea para este proyecto.</div>`;
        } else {
            ideas.forEach(idea => {
                const ideaEl = el('div', { class: 'cp-post', draggable: 'true', textContent: idea.title });
                ideaEl.ondragstart = (e) => {
                    e.dataTransfer.setData('text/plain', JSON.stringify({type: 'idea', id: idea.id, title: idea.title}));
                };
                ideasList.append(ideaEl);
            });
        }
    } else {
         ideasList.innerHTML = `<div class="empty-state" style="padding: 10px; font-size: var(--sm);">Selecciona un proyecto para ver y añadir ideas.</div>`;
         ideasContainer.style.opacity = 0.6;
    }
}
// --- HUB PROFESIONAL ---
function renderHub() {
    const P = S.hub.perfil;
    $('#avatar').src = P.avatar || 'https://placehold.co/100x100/dde2ed/0b132a?text=TÚ';
    $('#pNombreDisplay').textContent = P.nombre;
    $('#pRoleDisplay').textContent = P.rol;
    $('#pBioDisplay').textContent = P.bio;
    $('#pNombre').value = P.nombre;
    $('#pRole').value = P.rol;
    $('#pBio').value = P.bio;
    $('#pSocialLinkedin').value = P.socials?.linkedin || '';
    $('#pSocialTwitter').value = P.socials?.twitter || '';
    const socialsEl = $('#pSocialsDisplay'); socialsEl.innerHTML = '';
    if(P.socials?.linkedin) socialsEl.append(el('a', {href: P.socials.linkedin, target:'_blank'}, el('i', {'data-lucide':'linkedin'})));
    if(P.socials?.twitter) socialsEl.append(el('a', {href: P.socials.twitter, target:'_blank'}, el('i', {'data-lucide':'twitter'})));
    const mkList = $('#mkList'); mkList.innerHTML = '';
    S.hub.market.forEach(item => {
        mkList.append(el('div', {class: 'card', style:'margin-bottom:10px;'},
            el('div', {class:'row'}, el('b', {textContent: item.name}), el('span', {class:'spacer'}), el('span', {class:'chip', textContent: `$${item.price}`})),
            el('p', {class:'sub', textContent:item.desc}),
            el('div', {class:'row'}, el('span',{class:'spacer'}),
                el('button', {class:'btn btn-sm btn-ghost', onclick:()=>editMarketItem(item.id)}, el('i',{'data-lucide':'edit-3', width:16})),
                el('button', {class:'btn btn-sm btn-ghost', onclick:()=>deleteMarketItem(item.id)}, el('i',{'data-lucide':'trash-2', width:16}))
            )
        ));
    });
    renderJobs();
    lucide.createIcons();
}

function renderJobs(){
    const list = $('#jobsList');
    list.innerHTML = '';
    const searchTerm = $('#jobSearchInput').value.toLowerCase();
    const jobs = S.hub.jobs.filter(j => j.title.toLowerCase().includes(searchTerm) || j.company.toLowerCase().includes(searchTerm));

    if (jobs.length === 0) {
        list.innerHTML = `<div class="empty-state"><i data-lucide="search-x" width="48" height="48"></i><h4>No hay ofertas de empleo</h4><p>No hay ofertas que coincidan con tu búsqueda.</p></div>`;
        lucide.createIcons();
        return;
    }

    jobs.forEach(job => {
        const card = el('div', {class: 'job-card'},
            el('div', {class:'row'},
                el('div', {},
                    el('div', {class: 'job-title', textContent: job.title}),
                    el('div', {class: 'job-company', textContent: `${job.company} • ${job.location}`})
                ),
                el('span', {class: 'spacer'}),
                el('div', {},
                    el('div', {class:'chip', textContent: job.type}),
                    el('div', {style:'text-align:right; margin-top: 4px; font-weight: 600;', textContent: job.pay})
                )
            ),
            el('div', {class: 'job-card-details'}, el('p', {textContent: job.desc}))
        );
        card.onclick = () => {
            const details = card.querySelector('.job-card-details');
            details.style.display = details.style.display === 'block' ? 'none' : 'block';
        };
        list.append(card);
    });
}

function addJob() {
    const job = {
        id: 'j' + Date.now(),
        title: $('#jobTitle').value.trim(),
        company: $('#jobCompany').value.trim(),
        location: $('#jobLocation').value.trim(),
        pay: $('#jobPay').value.trim(),
        type: $('#jobType').value,
        desc: $('#jobDesc').value.trim(),
        authorId: 'u_me'
    };
    if (!job.title || !job.company) return showToast('El título y la empresa son obligatorios.', 'warn');
    S.hub.jobs.unshift(job);
    addIntis(20, 'Empleo publicado');
    save();
    renderJobs();
    showToast('Oferta de empleo publicada', 'success');
    ['#jobTitle', '#jobCompany', '#jobLocation', '#jobPay', '#jobDesc'].forEach(s => $(s).value = '');
}

function saveProfile() {
    S.hub.perfil.nombre = $('#pNombre').value; S.hub.perfil.rol = $('#pRole').value; S.hub.perfil.bio = $('#pBio').value;
    S.hub.perfil.socials.linkedin = $('#pSocialLinkedin').value; S.hub.perfil.socials.twitter = $('#pSocialTwitter').value;
    save(); renderHub(); showToast("Perfil actualizado", "success");
}
function handleAvatarUpload(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => { S.hub.perfil.avatar = event.target.result; save(); renderHub(); };
    reader.readAsDataURL(file);
}
function editMarketItem(id) {
    const item = S.hub.market.find(i => i.id === id); if (!item) return;
    const newName = prompt("Nuevo nombre:", item.name); const newPrice = prompt("Nuevo precio:", item.price);
    if (newName) item.name = newName; if (newPrice) item.price = Number(newPrice);
    save(); renderHub();
}
function deleteMarketItem(id) {
    if (confirm("¿Eliminar este servicio del mercado?")) { S.hub.market = S.hub.market.filter(i => i.id !== id); save(); renderHub(); }
}
// --- GLOBAL CHAT ---
function renderGChat() {
    const allUsers = [S.hub.perfil, ...S.hub.users];
    const userList = $('#gUserList'); userList.innerHTML = '';

    const generalChannel = el('div', {class: 'projItem', onclick: ()=> openDirectMessage('general')}, el('i', {'data-lucide': 'hash'}), el('span', {textContent: 'general'}));
    if (S.gchat.activeChat === 'general') generalChannel.classList.add('active');
    userList.append(generalChannel);

    allUsers.filter(u => u.id !== 'u_me').forEach(u => {
        const dmKey = ['u_me', u.id].sort().join('-');
        const userEl = el('div', {class: 'projItem', dataset: {userid: u.id}, onclick: ()=> openDirectMessage(u.id)},
            el('div', {class:'presence-dot', style:`background:${u.online ? 'var(--success)' : 'var(--sub)'}`}),
            el('span', {textContent: u.nombre})
        );
        if (S.gchat.activeChat === dmKey) userEl.classList.add('active');
        userList.append(userEl);
    });

    const log = $('#gChatLog'); log.innerHTML = '';
    let messages = [];
    let activeChatName = "Chat";

    if (S.gchat.activeChat === 'general') {
        activeChatName = "# general";
        messages = S.gchat.messages.general || [];
        if (messages.length === 0) {
             messages.push({senderId: 'system', at: new Date(), text: '¡Bienvenido al chat global! Sé respetuoso y colabora.'});
        }
    } else {
        const otherUserId = S.gchat.activeChat.replace('u_me','').replace('-','');
        const otherUser = allUsers.find(u => u.id === otherUserId);
        if(otherUser) {
            activeChatName = `Chat con ${otherUser.nombre}`;
            $('#gChatHeader').innerHTML = `Chat con ${otherUser.nombre} <button class="btn btn-sm" id="videoCallBtn"><i data-lucide="video"></i></button>`;
            $('#videoCallBtn').onclick = () => {
                $('#videoCallTitle').textContent = `Llamando a ${otherUser.nombre}...`;
                $('#videoCallModal').showModal();
            };
        }
        messages = S.gchat.dms[S.gchat.activeChat] || [];
    }
    $('#gChatHeader').textContent = activeChatName;
    
    messages.forEach(m => {
        const sender = allUsers.find(u => u.id === m.senderId) || {nombre: 'Sistema', avatar: 'https://placehold.co/40x40/a78bfa/ffffff?text=S'};
        const isMine = m.senderId === 'u_me';
        
        const msgEl = el('div', {class: 'msg' + (isMine ? ' mine' : '') },
            el('img', {src: sender.avatar, class: 'msg-avatar'}),
            el('div', {class: 'msg-content'},
                el('div', {class: 'msg-who', textContent: isMine ? 'Tú' : sender.nombre}),
                el('div', {class: 'msg-body', textContent: m.text})
            )
        );
        log.append(msgEl);
    });
    
    log.scrollTop = log.scrollHeight;
    lucide.createIcons();
}
function openDirectMessage(userId) {
    S.gchat.activeChat = (userId === 'general' || userId === 'u_me') ? 'general' : ['u_me', userId].sort().join('-');
    save(); renderGChat();
}
function sendGChatMessage() {
    const msg = $('#gChatMsg').value.trim(); if (!msg) return;
    const message = { senderId: 'u_me', at: new Date(), text: msg };
    if (S.gchat.activeChat === 'general') { 
        if(!S.gchat.messages.general) S.gchat.messages.general = [];
        S.gchat.messages.general.push(message);
    } else { 
        if (!S.gchat.dms[S.gchat.activeChat]) S.gchat.dms[S.gchat.activeChat] = []; 
        S.gchat.dms[S.gchat.activeChat].push(message); 
    }
    addIntis(2, 'Mensaje en chat');
    save(); renderGChat(); $('#gChatMsg').value = '';
}
// --- MONETIZATION & MINDSET ---
const monetizationModules = {
    oferta: {
        icon: 'gem', title: 'Ofertas Irresistibles', desc: 'Estructura productos que tus clientes no puedan rechazar.',
        content: `<h4>El Principio de la Transformación</h4>
<p>Una oferta irresistible no es sobre tu producto, es sobre la <strong>transformación</strong> que vendes. Debes llevar a tu cliente de un "Estado A" (con un problema doloroso) a un "Estado B" (con el problema resuelto y aspiraciones cumplidas).</p>
<h4>Componentes Clave de tu Oferta:</h4>
<ul>
    <li><strong>Resultado Específico y Deseado:</strong> ¿Qué logrará exactamente tu cliente? (Ej: "Lanza tu podcast profesional en 30 días", no "Aprende a hacer podcasts").</li>
    <li><strong>Bonos de Alto Valor:</strong> Añade extras que complementen la oferta principal, resuelvan problemas secundarios y eliminen barreras. (Ej: Plantillas de guiones, checklist técnico, acceso a comunidad privada).</li>
    <li><strong>Garantía Sólida (Inversión de Riesgo):</strong> Reduce el riesgo a cero para el comprador. (Ej: "Si no consigues tus primeros 100 oyentes en 60 días, te devolvemos tu dinero y te damos $50 extra por tu tiempo").</li>
    <li><strong>Urgencia y Escasez:</strong> Motiva la acción inmediata. (Ej: "Disponible solo para las primeras 20 personas" o "El precio sube permanentemente el viernes").</li>
</ul>
<div class="tip"><strong>Tip Profesional:</strong> Nombra tu oferta basándote en el resultado. "El Sistema Podcast Launchpad 30" suena mucho más valioso y concreto que "Curso de Podcasting".</div>`
    },
    contenido: {
        icon: 'megaphone', title: 'Marketing de Contenidos', desc: 'Atrae a tu cliente ideal creando contenido de valor.',
        content: `<h4>La Estrategia del "Dar Primero"</h4>
<p>El marketing de contenidos se basa en atraer clientes en lugar de perseguirlos. Lo haces ofreciendo valor por adelantado, posicionándote como una autoridad en tu nicho.</p>
<h4>Pasos para una Estrategia Exitosa:</h4>
<ul>
    <li><strong>Define tu Pilar de Contenido:</strong> Elige un tema central en el que eres experto y que resuelve el problema principal de tu audiencia.</li>
    <li><strong>Elige UN Formato y UN Canal Principal:</strong> ¿Videos en YouTube? ¿Hilos en Twitter/X? ¿Artículos de blog? Domina un formato y un canal antes de expandirte.</li>
    <li><strong>Crea "Contenido Solución":</strong> Cada pieza de contenido debe resolver un micro-problema de tu audiencia. Educa, entretiene o inspira, pero siempre aporta valor.</li>
    <li><strong>Llamada a la Acción (CTA):</strong> Al final de tu contenido, invita a la audiencia a dar el siguiente paso. (Ej: "Descarga mi guía gratuita sobre X", "Suscríbete para más tips").</li>
</ul>
<div class="tip"><strong>Tip Profesional:</strong> Crea una pieza de contenido larga y de alto valor (ej. un video de YouTube de 20 min) y luego "recíclala" en piezas más pequeñas para otras redes (clips para Reels/TikTok, frases para Twitter, etc.).</div>`
    },
    suscripcion: {
        icon: 'calendar-check', title: 'Modelos de Suscripción', desc: 'Crea ingresos recurrentes y una comunidad fiel.',
        content: `<h4>El Poder del Ingreso Predecible</h4>
<p>Los modelos de suscripción transforman tu negocio de transacciones únicas a relaciones a largo plazo, dándote un flujo de caja estable y predecible.</p>
<h4>Tipos de Modelos Populares:</h4>
<ul>
    <li><strong>Comunidad Privada:</strong> Acceso a un grupo (Discord, Slack, etc.), networking, sesiones en vivo y contenido exclusivo. Ideal para coaches y educadores.</li>
    <li><strong>Software como Servicio (SaaS):</strong> Ofreces una herramienta o software por una cuota mensual/anual. Es el modelo más escalable.</li>
    <li><strong>Producto como Servicio (PaaS):</strong> Ofreces un servicio "hecho para ti" de forma ilimitada por una cuota fija. (Ej: Diseño gráfico, edición de video, desarrollo web ilimitado).</li>
    <li><strong>Caja de Suscripción:</strong> Envío recurrente de productos físicos. (Ej: Café de especialidad, productos de belleza, libros).</li>
</ul>
<div class="tip"><strong>Tip Profesional:</strong> Empieza con una "Oferta Fundacional" a un precio más bajo para tus primeros miembros. Ellos te darán feedback valioso y se convertirán en tus mayores evangelizadores.</div>`
    },
     embudos: {
        icon: 'filter', title: 'Embudos de Venta', desc: 'Diseña el viaje de un extraño a un cliente leal.',
        content: `<h4>¿Qué es un Embudo de Ventas?</h4>
<p>Es el proceso paso a paso que guía a tus clientes potenciales hacia la compra. En lugar de una tienda con mil opciones, un embudo ofrece un camino claro hacia una única acción.</p>
<h4>Fases de un Embudo Básico:</h4>
<ol>
    <li><strong>Tráfico (ToFu - Top of Funnel):</strong> ¿Cómo te descubren? A través de redes sociales, anuncios, SEO, etc.</li>
    <li><strong>Captación (MoFu - Middle of Funnel):</strong> Ofreces un "Lead Magnet" (imán de prospectos), como un ebook o webinar gratuito, a cambio del correo electrónico del usuario.</li>
    <li><strong>Venta (BoFu - Bottom of Funnel):</strong> Una vez que tienes su contacto, presentas tu oferta principal a través de una página de ventas y una secuencia de correos electrónicos.</li>
    <li><strong>Fidelización:</strong> Después de la compra, sigues aportando valor para que se conviertan en clientes recurrentes.</li>
</ol>
<div class="tip"><strong>Tip Profesional:</strong> El dinero está en el seguimiento. La mayoría de las ventas no ocurren en el primer contacto. Una secuencia de 5-7 correos automáticos después de que alguien descarga tu lead magnet puede multiplicar tus conversiones.</div>`
    }
};

function renderMonetAssistant() {
    const grid = $('#monet-grid');
    grid.innerHTML = '';
    for (const key in monetizationModules) {
        const module = monetizationModules[key];
        const card = el('div', {class: 'monet-card', onclick: () => openMonetModule(key)},
            el('i', {'data-lucide': module.icon, width: 40, height: 40}),
            el('h4', {textContent: module.title}),
            el('p', {textContent: module.desc})
        );
        grid.append(card);
    }
    lucide.createIcons();
}

function openMonetModule(key) {
    const module = monetizationModules[key];
    if (!module) return;
    $('#monetModuleTitle').textContent = module.title;
    $('#monetModuleContent').innerHTML = module.content;
    $('#monetModuleModal').showModal();
    lucide.createIcons();
}

function setupMindset() {
    $('#mindset-freq').value = S.mindset.frequency;
    const quotes = ["El éxito es la suma de pequeños esfuerzos repetidos día tras día.", "La creatividad es la inteligencia divirtiéndose."];
    $('#mindsetQuote').textContent = quotes[Math.floor(Math.random()*quotes.length)];
}

// --- Wallet & Intis ---
function renderWallet() {
    const tbody = $('#wBody');
    tbody.innerHTML = '';
    (S.wallet.movs || []).forEach((mov, i) => {
        const tr = el('tr', {},
            el('td', {textContent: fmtDate(mov.fecha)}),
            el('td', {textContent: mov.tipo, style: `color: ${mov.tipo === 'Ingreso' ? 'var(--success)' : 'var(--danger)'}`}),
            el('td', {textContent: `$${mov.monto.toFixed(2)}`}),
            el('td', {textContent: mov.cat}),
            el('td', {textContent: mov.nota}),
            el('td', {}, el('button', {class: 'btn btn-ghost btn-sm', onclick: () => { S.wallet.movs.splice(i, 1); save(); renderWallet(); }}, el('i', {'data-lucide': 'trash-2', width: 14})))
        );
        tbody.prepend(tr);
    });
    lucide.createIcons();
}
function addWalletTransaction() {
    const monto = parseFloat($('#wMonto').value);
    if (!monto || monto <= 0) return showToast('Por favor, ingresa un monto válido.', 'warn');
    const newMov = {
        fecha: new Date().toISOString(),
        tipo: $('#wTipo').value,
        monto: monto,
        cat: $('#wCat').value.trim() || 'General',
        nota: $('#wNota').value.trim()
    };
    S.wallet.movs.push(newMov);
    addIntis(5, 'Movimiento en billetera');
    save();
    renderWallet();
    $('#wMonto').value = '';
    $('#wCat').value = '';
    $('#wNota').value = '';
}

// --- AI Assistant ---
const assistantKB = {
    'tarea': "Para crear una tarea, ve a un proyecto, selecciona la pestaña 'Tareas' y haz clic en el botón '+ Nueva Tarea'. También puedes escribir algo como 'Crear tarea para llamar al cliente mañana' y lo haré por ti.",
    'proyecto': "Puedes crear un nuevo proyecto desde el panel lateral izquierdo, haciendo clic en el botón '+ Nuevo'. ¡Cada proyecto es un espacio de trabajo independiente para tus ideas!",
    'cronopost': "CronoPOST es tu calendario de contenidos. Te permite planificar tus publicaciones en redes sociales. Selecciona un proyecto, añade ideas en el 'Banco de Ideas' y arrástralas al calendario para agendarlas.",
    'billetera': "La Billetera te ayuda a llevar un registro de tus ingresos y egresos de forma sencilla. Haz clic en el balance en la parte superior derecha para añadir transacciones y ver tu historial.",
    'intis': "Los Intis son puntos que ganas por ser activo en la plataforma. Sirven para medir tu progreso. ¡En el futuro podrás usarlos para obtener beneficios!",
    'gracias': "¡De nada! Estoy aquí para ayudarte a sacar el máximo provecho de Goatify. ¿En qué más puedo ayudarte?",
    'default': "No he entendido muy bien tu pregunta. Intenta preguntarme algo como '¿Cómo creo una tarea?' o '¿Para qué sirve el CronoPOST?'."
};

function renderAssistantChat() {
    const log = $('#assistantChatLog');
    log.innerHTML = '';
    if (S.assistant.history.length === 0) {
        S.assistant.history.push({ who: 'IA', text: "¡Hola! Soy tu asistente en Goatify. ¿En qué te puedo ayudar hoy?" });
    }
    S.assistant.history.forEach(msg => {
        const isMine = msg.who === 'Tú';
        const msgEl = el('div', {class: 'msg' + (isMine ? ' mine' : '')},
            el('img', {src: isMine ? S.hub.perfil.avatar || 'https://placehold.co/40x40/dde2ed/0b132a?text=TÚ' : 'https://placehold.co/40x40/a78bfa/ffffff?text=IA', class: 'msg-avatar'}),
            el('div', {class: 'msg-content'},
                el('div', {class: 'msg-who', textContent: msg.who}),
                el('div', {class: 'msg-body', textContent: msg.text})
            )
        );
        log.append(msgEl);
    });
    
    const quickBtns = $('#assistantQuickBtns');
    quickBtns.innerHTML = '';
    const commonQuestions = ['¿Cómo creo una tarea?', '¿Para qué sirve CronoPOST?', 'Háblame de la billetera'];
    commonQuestions.forEach(q => {
        const btn = el('button', {class: 'btn btn-sm', textContent: q, onclick: () => {
            $('#assistantChatInput').value = q;
            sendAssistantChatMessage();
        }});
        quickBtns.append(btn);
    });

    log.scrollTop = log.scrollHeight;
}
function sendAssistantChatMessage() {
    const input = $('#assistantChatInput');
    const msg = input.value.trim();
    if (!msg) return;

    S.assistant.history.push({ who: 'Tú', text: msg });
    renderAssistantChat();
    input.value = '';

    setTimeout(() => {
        let response = assistantKB.default;
        const msgLc = msg.toLowerCase();
        for (const key in assistantKB) {
            if (msgLc.includes(key)) {
                response = assistantKB[key];
                break;
            }
        }
        S.assistant.history.push({ who: 'IA', text: response });
        save();
        renderAssistantChat();
    }, 800);
}

// ====== Onboarding ======
const industryTemplates = {
    agency: {
        projects: [{id: 'p_agency_1', name: 'Cliente Tech Solutions', color: '#3b82f6'}],
        tasks: {'p_agency_1': [
            {id:'t_a1', title:'Reunión de kickoff con cliente', status:'Hecho'},
            {id:'t_a2', title:'Definir KPIs de la campaña', status:'En curso'},
            {id:'t_a3', title:'Enviar propuesta de diseño', status:'Backlog'}
        ]},
        notes: {'p_agency_1': {list: [{id:'n_a1', title: 'Minuta Kickoff'}], active:'n_a1', bodies:{'n_a1':'<p><strong>Puntos clave:</strong> Foco en Aumento de Leads.</p>'}, drawings:{}}},
    },
    ecommerce: {
        projects: [{id: 'p_ecom_1', name: 'Lanzamiento Colección Otoño', color: '#16a34a'}],
        tasks: {'p_ecom_1': [
             {id:'t_e1', title:'Sesión de fotos de producto', status:'En curso'},
             {id:'t_e2', title:'Actualizar banners de la web', status:'Backlog'},
             {id:'t_e3', title:'Preparar campaña de email marketing', status:'Backlog'}
        ]},
        notes: {'p_ecom_1': {list: [{id:'n_e1', title: 'Ideas para Campaña'}], active:'n_e1', bodies:{'n_e1':'<p>Foco en colores cálidos y confort.</p>'}, drawings:{}}},
    },
    creator: {
        projects: [{id: 'p_creator_1', name: 'Contenido YouTube Q4', color: '#ef4444'}],
        tasks: {'p_creator_1': [
            {id:'t_c1', title:'Grabar video sobre "5 Errores Comunes"', status:'En curso'},
            {id:'t_c2', title:'Escribir guion para colaboración con @usuario', status:'Backlog'},
            {id:'t_c3', title:'Investigar temas para videos de Diciembre', status:'Backlog'}
        ]},
        cronopost: { ideas: {'p_creator_1': [{id:'i_c1', title: 'Detrás de cámaras de mi último video'}]}},
    }
};
function loadIndustryTemplate(industry) {
    const template = industryTemplates[industry] || {};
    
    // Merge template data into state
    S.projects = template.projects || [];
    S.tasks = template.tasks || {};
    S.notes = template.notes || {};
    if (template.cronopost) {
        S.cronopost.ideas = template.cronopost.ideas || {};
    }

    // Initialize data for new projects
    S.projects.forEach(p => {
        const id = p.id;
        if (!S.folders[id]) S.folders[id] = ['General'];
        if (!S.chats[id]) S.chats[id] = {threads:[], messages:{}, activeThread: null, model: 'normal'};
        if (!S.tables[id]) S.tables[id] = {cols:[], rows:[]};
        if (!S.files[id]) S.files[id] = [];
        if (!S.fin[id]) S.fin[id] = {rows:[]};
        if (!S.cronopost.posts[id]) S.cronopost.posts[id] = {};
        if (!S.cronopost.ideas[id]) S.cronopost.ideas[id] = [];
    });

    S.userProfile.industry = industry;
    addIntis(100, `Plantilla ${industry} cargada`);
    save();
    showToast(`¡Bienvenido! Tu espacio de trabajo para ${industry} está listo.`, 'success');
    
    // Reload UI
    renderAside();
    if(S.projects.length > 0) {
        openProject(S.projects[0].id);
    } else {
        show('hub');
    }
}


// ====== INIT & EVENT LISTENERS ======
function init(){
  load();
  lucide.createIcons();
  
  if (!S.userProfile || !S.userProfile.industry) {
    $('#industryModal').showModal();
    lucide.createIcons();
  }

  const handleNav = (hash) => {
    const view = hash.replace('#', '');
    if (view && $(`[data-nav="${view}"]`)) { show(view); } 
    else { S.projects.length > 0 ? openProject(S.projects[0].id) : show('hub'); }
  };
  $('#nav-list').addEventListener('click', (e) => {
      const link = e.target.closest('a.navBtn');
      if (link && link.dataset.nav) {
          e.preventDefault(); const view = link.dataset.nav;
          history.pushState({view}, '', `#${view}`); show(view);
      }
  });
  handleNav(window.location.hash);
  renderAside();
  renderCronoPOST(); renderHub(); renderGChat(); renderMonetAssistant(); setupMindset();
}

// --- General Listeners ---
$('#loadIndustryBtn').onclick = () => {
    const industry = $('#industrySelect').value;
    loadIndustryTemplate(industry);
    $('#industryModal').close();
};
$('#newProject').onclick = () => { $('#newProjectModal').showModal(); };
$('#newProjectCreate').onclick = createNewProject;
$('#creditsChip').onclick = () => { 
    const prices = { PEN: 15.00, COP: 16000, MXN: 70.00, USD: 4.00 };
    $('#pricingList').innerHTML = `<li>🇵🇪 S/ ${prices.PEN.toFixed(2)}</li><li>🇨🇴 $ ${prices.COP.toLocaleString('es-CO')}</li><li>🇲🇽 $ ${prices.MXN.toFixed(2)}</li><li>🇺🇸 $ ${prices.USD.toFixed(2)}</li>`;
    $('#creditsModal').showModal(); 
};
$('#themeBtn').onclick=()=>{ 
    const h=document.documentElement; const newTheme = h.getAttribute('data-theme')==='light'?'dark':'light'; 
    h.setAttribute('data-theme', newTheme);
    $('#themeBtn').innerHTML = newTheme === 'light' ? '<i data-lucide="sun"></i>' : '<i data-lucide="moon"></i>';
    lucide.createIcons();
};
$('#menuBtn').onclick=()=>document.body.classList.toggle('aside-open');
$('#aiAssistantBtn').onclick = () => { renderAssistantChat(); $('#aiAssistantModal').showModal(); };
$('#sendAssistantChat').onclick = sendAssistantChatMessage;
$('#assistantChatInput').addEventListener('keydown', e => { if (e.key === 'Enter') sendAssistantChatMessage(); });
$('#walletChip').onclick = () => { renderWallet(); $('#walletModal').showModal(); };
$('#intisChip').onclick = () => { $('#intisModal').showModal(); lucide.createIcons(); };
$('#wAdd').onclick = addWalletTransaction;
$('#resetApp').onclick=()=>{ if(confirm('¿BORRAR TODO?')) { localStorage.removeItem('goatify_v8'); window.location.reload();} };
// --- Project Listeners ---
wireTabs('#projectShell', 'ptab', 'p-tab');
$('#quickAdd').onclick = quickAddTask;
$('#addFolder').onclick=()=>{ const id=S.activeProject; if(!id)return; const name=prompt('Nombre de la subcarpeta:'); if(name) { S.folders[id].push(name); save(); openProject(id); }};
$('#prevM').onclick=()=>{calRef.setMonth(calRef.getMonth()-1); renderCalendar();};
$('#nextM').onclick=()=>{calRef.setMonth(calRef.getMonth()+1); renderCalendar();};
$('#newNote').onclick=()=>{ const id=S.activeProject; if(!id) return; const t=prompt('Título de la nota'); if(!t) return; const nid='n'+Date.now(); S.notes[id].list.push({id:nid,title:t}); S.notes[id].active=nid; S.notes[id].bodies[nid]=''; save(); renderNotes();};
$$('#p-tab-notes [data-cmd]').forEach(btn=>btn.onclick=()=>document.execCommand(btn.dataset.cmd, false, btn.dataset.value || null));
$('#clearCanvasBtn').onclick=()=>{ const id=S.activeProject; if(!id||!S.notes[id].active)return; delete S.notes[id].drawings[S.notes[id].active]; save(); renderNotes(); };
$('#exportNotePDF').onclick = () => exportNote('pdf');
$('#fileInput').onchange=(e)=>{ const id=S.activeProject; if(!id) return; for(const f of e.target.files){ S.files[id].push({name:f.name,url:URL.createObjectURL(f), size:f.size}); } addIntis(5, 'Archivo subido'); save(); renderFiles(); renderOverview();};
$('#newChat').onclick=()=>{ const id=S.activeProject; if(!id)return; const t=prompt('Nuevo hilo de Chat:'); if(t) {S.chats[id].threads.push({id:'c'+Date.now(), title:t}); S.chats[id].activeThread = 'c'+Date.now(); save(); renderProjectChat();}};
$$('[data-model]').forEach(b=>b.onclick=()=>{const id=S.activeProject; if(!id)return; S.chats[id].model=b.dataset.model; save(); renderProjectChat();});
$('#sendMsg').onclick = sendProjectChatMessage;
$('#chatMsg').addEventListener('keydown', e => { if (e.key === 'Enter') sendProjectChatMessage(); });
$('#chatToTasks').onclick=()=>{ const id=S.activeProject; const C=S.chats[id]; if(!C?.activeThread) return; const lastMsg = C.messages[C.activeThread]?.filter(m=>m.who==='IA').pop(); if(!lastMsg) return showToast('No hay respuesta de IA para convertir.','warn'); S.tasks[id].push({id:'t'+Date.now(), title: lastMsg.text.substring(0, 50) + "...", status:'Backlog'}); save(); renderTasks(); showToast('Tarea creada desde el chat.','success');};
$('#newSheet').onclick=()=>{ const id=S.activeProject; if(!id) return; S.tables[id]={cols:['Título','Notas'], rows:[['','']]}; save(); renderTables();};
$('#addCol').onclick=()=>{ const id=S.activeProject; if(!id) return; const T=S.tables[id]; const name=prompt('Nombre de columna'); if(!name) return; T.cols.push(name); T.rows.forEach(r=>r.push('')); save(); renderTables();};
$('#addRow').onclick=()=>{ const id=S.activeProject; if(!id) return; const T=S.tables[id]; T.rows.push(new Array(T.cols.length).fill('')); save(); renderTables();};
$('#exportCSV').onclick=()=>{ const id=S.activeProject; if(!id) return; const T=S.tables[id]; download(`tabla.csv`, csv([T.cols, ...T.rows]));};
$('#finNew').onclick=()=>{
  const id=S.activeProject; if(!id) return; const F=S.fin[id];
  const tipo=prompt('Ingreso/Egreso','Ingreso'); const monto=Number(prompt('Monto','0')); const cat=prompt('Categoría','General'); const nota=prompt('Nota','');
  if(!monto) return; F.rows.push({fecha:new Date(), tipo, monto, cat, nota}); save(); renderFin(); renderOverview();
};
$('#finExport').onclick=()=>{ const id=S.activeProject; if(!id) return; const F=S.fin[id]; download(`finanzas.csv`, csv([['Fecha','Tipo','Monto','Cat','Nota'], ...F.rows.map(r=>[r.fecha,r.tipo,r.monto,r.cat,r.nota])]));};
// --- Global Module Listeners ---
$('#cpProjectSelect').onchange = renderCronoPOST;
$('#cpPrevM').onclick = () => { cpRef.setMonth(cpRef.getMonth() - 1); renderCronoPOST(); };
$('#cpNextM').onclick = () => { cpRef.setMonth(cpRef.getMonth() + 1); renderCronoPOST(); };
$('#cpAddIdeaBtn').onclick = () => {
    const activeProjectId = $('#cpProjectSelect').value; 
    if (!activeProjectId || activeProjectId === 'all') {
        showToast('Por favor, selecciona un proyecto específico para añadir una idea.', 'warn');
        return;
    }
    const title = $('#cpNewIdeaInput').value.trim(); if (!title) return;
    if(!S.cronopost.ideas[activeProjectId]) S.cronopost.ideas[activeProjectId] = [];
    S.cronopost.ideas[activeProjectId].push({ id: 'i' + Date.now(), title });
    addIntis(5, 'Idea de contenido');
    save(); renderCronoPOST(); $('#cpNewIdeaInput').value = '';
};
wireTabs('#hub', 'htab', 'h-htab');
$('#avatar').onclick = () => $('#avatarInput').click();
$('#avatarInput').onchange = handleAvatarUpload;
$('#savePerfil').onclick = saveProfile;
$('#addMK').onclick = () => {
    const name = $('#mkName').value; if (!name) return;
    S.hub.market.push({id:'m'+Date.now(), name, price:Number($('#mkPrice').value||0), desc:$('#mkDesc').value});
    addIntis(20, 'Servicio publicado');
    save(); renderHub();
    ['#mkName', '#mkPrice', '#mkDesc'].forEach(s => $(s).value = '');
};
$('#addJob').onclick = addJob;
$('#jobSearchInput').oninput = renderJobs;
$('#sendGChat').onclick = sendGChatMessage;
$('#gChatMsg').addEventListener('keydown', e => { if (e.key === 'Enter') sendGChatMessage(); });
$('#saveMindset').onclick=()=>{ S.mindset.frequency = $('#mindset-freq').value; save(); showToast('Ajustes de Mindset guardados.','success');};

function wireTabs(scopeSelector, prefix, contentPrefix){
  const root=$(scopeSelector); if (!root) return;
  root.querySelectorAll(`.tabs .tab[data-${prefix}]`).forEach(btn=>{
    btn.addEventListener('click',()=>{
      root.querySelectorAll(`.tabs .tab[data-${prefix}]`).forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset[prefix];
      root.querySelectorAll(`[id^="${contentPrefix}-"]`).forEach(p=>p.style.display='none');
      const pane = root.querySelector(`#${contentPrefix}-${target}`);
      if(pane) pane.style.display='block';
    });
  });
}

init();
</script>
</body>
</html>

