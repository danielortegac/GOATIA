<!DOCTYPE html>
<html data-theme="light" lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<title>Goatify IA — Suite de Negocios Mejorada</title>
<link rel="icon" href="https://goatify.com/assets/img/Logos%20HD.png" type="image/png">
<!-- SEO Meta Tags -->
<meta content="Goatify IA es tu sistema operativo de negocios que se adapta a tu industria. Personaliza tu espacio de trabajo para marketing, e-commerce, y más." name="description"/>
<meta content="project management, crm, business os, collaboration, ai chat, cronopost, goatify ia, personalized workspace" name="keywords"/>
<meta content="Goatify" name="author"/>
<!-- Open Graph Meta Tags -->
<meta content="Goatify IA — Suite de Negocios Mejorada" property="og:title"/>
<meta content="website" property="og:type"/>
<meta content="La nueva era de la productividad. Goatify IA personaliza tus proyectos, tareas y herramientas según tu tipo de negocio desde el inicio." property="og:description"/>
<meta content="#f6f7fb" name="theme-color"/>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


<style>
  :root{
    --bg:#0b0f19; --surface:#0f172a; --muted:#1e293b; --line:#334155;
    --text:#e2e8f0; --sub:#94a3b8; --brand:#a78bfa; --brand2:#8b5cf6; --accent:#38bdf8;
    --danger:#f87171; --warn:#fbbf24; --success:#22c55e; --info:#60a5fa;
    --shadow:0 20px 60px rgba(0,0,0,.45);
    --radius:12px; --xs:10px; --sm:12px; --md:13.5px; --lg:15.5px; --xl:18px;
    --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  [data-theme="light"]{
    --bg:#f8fafc; --surface:#ffffff; --muted:#f1f5f9; --line:#e2e8f0;
    --text:#0f172a; --sub:#64748b; --brand:#6d28d9; --brand2:#8b5cf6; --accent:#0ea5e9;
    --shadow:0 10px 25px rgba(15, 23, 42,.08);
  }
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
  *{box-sizing:border-box;}
  body, .btn, .card, .stat-card, input, select, textarea, .monet-card, #floating-assistant, .chip, .projItem, .navBtn, dialog {
    transition: background .15s ease, color .15s ease, border-color .15s ease, transform .15s ease, box-shadow .15s ease;
  }
  .container {
    transition: grid-template-columns .3s ease-in-out;
  }
  aside {
    transition: width .3s ease-in-out, transform .3s ease-in-out;
  }
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font: var(--md)/1.5 var(--font-sans); overflow-x: hidden;}
  a{color:var(--brand);text-decoration:none}
  .container{display:grid;grid-template-columns:280px 1fr;min-height:100%}
  aside{border-right:1px solid var(--line);background:var(--surface);padding:10px;position:relative;z-index:30; display: flex; flex-direction: column; justify-content: space-between; width: 280px;}
  header.app{position:sticky;top:0;z-index:40;background:color-mix(in hsl, var(--surface) 85%, transparent);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);padding:8px 10px;display:flex;gap:10px;align-items:center}
  .brand{display:flex;gap:8px;align-items:center;font-weight:800; font-size: var(--lg); padding: 8px 0;}
  .brand-logo { height: 28px; width: auto; }
  .badge{padding:2px 8px;border-radius:999px;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;font-size:var(--xs)}
  .btn{border-radius:var(--radius);border:1px solid var(--line);background:var(--surface);color:var(--text);padding:8px 12px;cursor:pointer;display:inline-flex;gap:8px;align-items:center; font-weight: 600; white-space: nowrap;}
  .btn:hover{transform:translateY(-1px); border-color: var(--brand); box-shadow: var(--shadow);} .btn:active{transform:none; box-shadow: none;}
  .btn.btn-sm { padding: 4px 8px; font-size: var(--sm); }
  .btn-primary{border:none;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff}
  .btn-ghost{background:transparent; border-color: transparent; box-shadow: none;}
  .btn-ghost.active { background: var(--muted); }
  .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border:1px solid transparent;border-radius:999px;background:var(--muted); cursor: pointer;}
  .chip:hover { border-color: var(--brand); }
  input,select,textarea{border:1px solid var(--line);border-radius:10px;background:var(--muted);color:var(--text);padding:8px 12px;outline:none; width: 100%;}
  input:focus, select:focus, textarea:focus { border-color: var(--brand); background: var(--surface); box-shadow: 0 0 0 3px color-mix(in hsl, var(--brand) 20%, transparent); }
  textarea { resize: vertical; }
  .projList{display:flex;flex-direction:column;gap:6px}
  .navBtn{display:flex;gap:10px;align-items:center;border:1px solid transparent;border-radius:10px;background:transparent;padding:10px;cursor:pointer; font-weight: 500; color: var(--text)}
  .navBtn:hover{background:var(--muted);}
  .navBtn.active {background: var(--brand); color: #fff; font-weight: 700;}
  .projItem { display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 10px; border: 1px solid transparent; cursor: pointer; }
  .projItem .proj-actions { display: none; margin-left: auto; gap: 4px;}
  .projItem:hover .proj-actions { display: flex; }
  .projItem.active { background: color-mix(in hsl, var(--brand) 15%, transparent); border-color: var(--brand); font-weight: 600; }
  .proj-color-dot { width: 12px; height: 12px; border-radius: 50%; }
  .panel{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);margin:10px;overflow:hidden; animation: fadeIn .3s ease;}
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  
  /* MEJORA: Asistente IA a pantalla completa, diseño refinado */
  #ai-global-chat.panel {
    margin: 0;
    border: none;
    border-radius: 0;
    box-shadow: none;
    height: calc(100vh - 55px);
    padding: 0;
    overflow: hidden;
    background: var(--bg);
  }
  #ai-global-chat .gchat-grid {
    height: 100%;
    padding: 0 !important;
    grid-template-columns: 300px 1fr;
  }
  #ai-global-chat .gchat-grid > .card {
    border-radius: 0;
    border-top: none;
    border-bottom: none;
    display: flex;
    flex-direction: column;
    padding: 10px;
  }
   #ai-global-chat .gchat-grid > .card:first-child {
    border-left: none;
    background: var(--surface);
  }
   #ai-global-chat .gchat-grid > .card:last-child {
    border-right: none;
    border-left: 1px solid var(--line);
    background: var(--bg);
  }
  #ai-global-chat .chat-log {
    background: transparent;
    border: none;
  }
  
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}
  .section{padding:16px;border-top:1px solid var(--line);}
  .card{border:1px solid var(--line);border-radius:12px;background:var(--muted);padding:16px}
  .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
  .stat-card { background: var(--surface); padding: 16px; border-radius: var(--radius); cursor: pointer;}
  .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); border: 1px solid var(--brand); }
  .stat-card h4 { margin: 0 0 8px 0; color: var(--sub); }
  .stat-card p { margin: 0; font-size: var(--xl); font-weight: 700; }
  .empty-state { text-align: center; padding: 40px; color: var(--sub); }
  .empty-state i { margin-bottom: 12px; }
  .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  /* Tabs */
  .tabs{display:flex;gap:6px;padding:12px;border-bottom:1px solid var(--line); flex-wrap: wrap;}
  .tab{all:unset;cursor:pointer;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:var(--muted); font-weight: 600; min-width: 90px; text-align: center;}
  .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
  /* Board & Tasks */
  .board{display:grid;grid-template-columns:repeat(4, 1fr);gap:10px;padding:10px}
  .col{background:var(--muted);border:1px solid var(--line);border-radius:12px;min-height:220px;padding:8px}
  .col .row b { word-break: break-word; }
  .col.dragover { outline: 2px dashed var(--brand); background: color-mix(in hsl, var(--brand) 10%, transparent); }
  .task{background:var(--surface);border:1px solid var(--line);border-radius:10px;padding:12px;margin:8px 4px;cursor:grab;box-shadow:var(--shadow)}
  #task-list-table th { text-align: left; padding: 8px; color: var(--sub); border-bottom: 2px solid var(--line); font-size: var(--sm); }
  #task-list-table td { padding: 12px 8px; border-bottom: 1px solid var(--muted); }
  #task-list-table tbody tr { cursor: pointer; }
  #task-list-table tbody tr:hover { background: var(--muted); }
  .status-badge { padding: 3px 8px; border-radius: 999px; font-size: var(--xs); font-weight: 600; text-transform: uppercase; }
  /* Calendars */
  #cpCalendarContainer { background: var(--surface); border-radius: var(--radius); padding: 10px; border: 1px solid var(--line); }
  .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
  .day { min-height: 140px; border: 1px solid var(--line); border-radius: 10px; background: var(--surface); padding: 6px; display: flex; flex-direction: column; gap: 4px; cursor: pointer;}
  .day:hover { background: var(--muted); }
  .cp-post, .cal-task { font-size: 12px; background: var(--surface); border-radius: 8px; padding: 4px 6px; cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,.05); border-left: 3px solid; margin-bottom: 4px; }
  .cal-task { border-style: dashed; }
  /* Hub Profesional */
  .profile-card .profile-header { height: 100px; background: var(--surface); border-radius: var(--radius) var(--radius) 0 0; transition: background .3s ease; }
  .profile-card .avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--surface); box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: -50px auto 10px; cursor: pointer; }
  /* Notes & Drawing */
  .note-editor-wrapper { display: grid; grid-template-columns: 1fr 300px; gap: 10px; align-items: start;}
  #noteEditor { min-height: 60vh; max-height: 60vh; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--line); padding: 12px; overflow-y: auto; }
  #drawingCanvas { border: 1px solid var(--line); border-radius: var(--radius); cursor: crosshair; width:100%; height:auto; aspect-ratio: 250 / 180; touch-action: none; }
  /* Chat IA & Global Chat */
  .chat-log { display: flex; flex-direction: column; overflow-y: auto; overflow-x: hidden; border: 1px solid var(--line); border-radius: var(--radius); padding: 10px; background: var(--muted); flex: 1;}
  .chat-log .msg { display: flex; gap: 10px; margin-bottom: 12px; max-width: 85%; align-items: flex-end; }
  .chat-log .msg.mine { align-self: flex-end; flex-direction: row-reverse; }
  .chat-log .msg-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background: var(--surface); padding: 4px;}
  .chat-log .msg-content { display: flex; flex-direction: column; }
  .chat-log .msg-who { font-size: var(--sm); font-weight: 600; margin-bottom: 4px; color: var(--sub); }
  .chat-log .msg-body { background: var(--surface); padding: 8px 12px; border-radius: 12px; word-break: break-word; }
  .chat-log .msg.mine .msg-content { align-items: flex-end; }
  .chat-log .msg.mine .msg-body { background: var(--brand); color: #fff; }
  .chat-input-area { align-items: flex-end; border-top: 1px solid var(--line); padding-top: 10px; }
  .chat-input-area textarea { resize: none; max-height: 150px; }
  .code-block { border: 1px solid var(--line); border-radius: var(--radius); margin: 8px 0; background: var(--muted); }
  .code-header { display: flex; align-items: center; gap: 8px; padding: 4px 8px; background: var(--bg); border-bottom: 1px solid var(--line); font-size: var(--sm); }
  .code-block pre { margin: 0; padding: 12px; overflow-x: auto; background-color: var(--muted); border-radius: 0 0 var(--radius) var(--radius); }
  .code-preview-container { border-top: 1px solid var(--line); padding: 8px; }
  .code-preview-container iframe { width: 100%; height: 200px; border: 1px solid var(--line); border-radius: 8px; background: white; }
  /* Job Board */
  .job-card { background: var(--surface); border: 1px solid var(--line); border-left: 4px solid var(--accent); border-radius: 12px; padding: 16px; margin-bottom: 10px; cursor: pointer; }
  .job-card:hover { border-color: var(--accent); box-shadow: var(--shadow); transform: translateY(-2px); }
  .job-card .job-title { font-weight: 700; font-size: var(--lg); }
  .job-card .job-company { color: var(--sub); }
  .job-card-details { display: none; margin-top: 16px; border-top: 1px solid var(--line); padding-top: 16px; white-space: pre-wrap; }
  /* Monetization Assistant */
  .monet-card { background: var(--surface); border: 1px solid var(--line); border-radius: var(--radius); padding: 20px; text-align: center; cursor: pointer; transition: transform .2s, box-shadow .2s; }
  .monet-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); border-color: var(--brand); }
  .monet-card i { color: var(--brand); }
  .monet-card h4 { margin: 10px 0 5px 0; }
  .monet-card p { font-size: var(--sm); color: var(--sub); margin: 0; }
  #monetModuleModal h4 { color: var(--brand2); margin-top: 1.5em; margin-bottom: 0.5em; }
  #monetModuleModal ul { padding-left: 20px; }
  #monetModuleModal .tip { background: color-mix(in hsl, var(--warn) 15%, transparent); border-left: 3px solid var(--warn); padding: 12px; margin: 1em 0; border-radius: 8px;}
  /* Mindset */
  #breathing-circle-container { position: relative; width: 150px; height: 150px; margin: 20px auto; display: flex; align-items: center; justify-content: center; }
  #breathing-circle { width: 100%; height: 100%; border-radius: 50%; background: var(--brand); animation: breathe 8s ease-in-out infinite; }
  #breathing-text { position: absolute; color: white; font-weight: 600; }
  @keyframes breathe { 0%, 100% { transform: scale(0.6); opacity: 0.7; } 50% { transform: scale(1); opacity: 1; } }
  
  /* Modals & Toasts */
  dialog { border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); max-width: 600px; padding: 0; overflow: hidden; }
  dialog[open] { animation: fadeIn .2s ease; }
  dialog::backdrop { background: rgba(0,0,0,.5); backdrop-filter: blur(4px); }
  #toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 999px; z-index: 10001; font-weight: 600; box-shadow: var(--shadow); opacity: 0; transition: opacity .3s, bottom .3s; }
  #toast.show { opacity: 1; bottom: 30px; }
  
  /* Grid Layouts */
  .hub-grid, #cronopost-grid, .gchat-grid { display: grid; gap: 10px; }
  .hub-grid { grid-template-columns: 360px 1fr; }
  #cronopost-grid { grid-template-columns: 1fr 320px; padding: 10px; }
  .gchat-grid { grid-template-columns: 260px 1fr; padding: 10px; height: calc(100vh - 70px); }
  #p-tab-chat .gchat-grid { grid-template-columns: 260px 1fr; height: calc(100vh - 140px); }
  #cpMonthLbl { min-width: 150px; justify-content: center; }

  /* User Profile Snippet */
  .user-profile-snippet { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: var(--radius); }
  .user-profile-snippet:hover { background: var(--muted); }
  .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: var(--brand); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; }
  .user-info span { display: block; }
  .user-info .user-name { font-weight: 600; }
  .user-info .user-role { font-size: var(--sm); color: var(--sub); }
  .user-info, .brand-text { overflow: hidden; white-space: nowrap; }

  /* MEJORA: Lógica de menú lateral refinada para animaciones suaves */
  body.aside-collapsed .container { grid-template-columns: 74px 1fr; }
  body.aside-collapsed aside { width: 74px; }
  
  aside.hover-expand {
      width: 280px !important;
      box-shadow: var(--shadow);
      position: absolute; /* Usar absolute para no empujar el contenido */
      height: 100%;
      z-index: 31;
  }
  
  .brand-text, .navBtn > span, .projItem > span, .projList-header .btn, .projList-header b, .user-info {
      transition: opacity .2s ease-in-out;
  }

  body.aside-collapsed aside:not(.hover-expand) .brand-text, 
  body.aside-collapsed aside:not(.hover-expand) .navBtn > span,
  body.aside-collapsed aside:not(.hover-expand) .projItem > span,
  body.aside-collapsed aside:not(.hover-expand) .projList-header, 
  body.aside-collapsed aside:not(.hover-expand) .search input, 
  body.aside-collapsed aside:not(.hover-expand) .user-info { 
      opacity: 0; 
      pointer-events: none; 
  }
  
  body.aside-collapsed aside .navBtn,
  body.aside-collapsed aside .projItem { 
      justify-content: center; 
  }
  
  body.aside-collapsed aside .brand {
    justify-content: center;
  }


  /* Mobile Overlay */
  #menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 98; display: none; transition: opacity .3s ease; opacity: 0; }
  body.aside-open #menu-overlay { display: block; opacity: 1; }
  
  .header-desktop-actions { display: flex; align-items: center; gap: 10px; }
  .header-mobile-actions { display: none; align-items: center; gap: 6px; }
  .dropdown-container { position: relative; }
  .dropdown-menu { display: none; position: absolute; top: calc(100% + 8px); right: 0; background: var(--surface); border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); width: 220px; z-index: 50; padding: 6px; flex-direction: column; gap: 4px; animation: fadeIn .15s ease-out; }
  .dropdown-menu.active { display: flex; }
  .dropdown-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 10px; color: var(--text); font-weight: 500; font-size: var(--md); cursor: pointer; }
  .dropdown-item:hover { background: var(--muted); }
  .dropdown-item i { color: var(--sub); }

  /* AI Model Selector */
  .model-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; padding-bottom: 8px; margin-bottom: 8px; }
  .model-card { border: 1px solid var(--line); border-radius: var(--radius); padding: 8px; cursor: pointer; background: var(--surface); text-align: center; }
  .model-card:not(.disabled):hover { border-color: var(--brand); }
  .model-card.active { border-color: var(--brand); background: color-mix(in hsl, var(--brand) 10%, transparent); box-shadow: 0 0 0 2px var(--brand); }
  .model-card.disabled { opacity: 0.5; cursor: not-allowed; background: var(--muted); position:relative; overflow: hidden;}
  .model-card.disabled .pro-badge { position: absolute; top: 4px; right: 4px; background: var(--warn); color: var(--bg); font-size: 9px; padding: 1px 4px; border-radius: 4px; font-weight: 700;}
  .model-card h5 { margin: 0 0 4px; font-size: var(--sm); white-space: nowrap; }
  .model-card p { margin: 0; font-size: var(--xs); color: var(--sub); line-height: 1.3; }

  /* Table Images */
  .table-image-thumb { max-width: 50px; max-height: 50px; object-fit: cover; border-radius: 8px; cursor: pointer; }

  /* Floating Assistant */
  #floating-assistant { position: fixed; bottom: 20px; right: 20px; z-index: 999; width: 60px; height: 60px; background: linear-gradient(135deg, var(--brand), var(--brand2)); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,.3); cursor: grab; user-select: none; transition: transform .2s ease-out; }
  #floating-assistant:active { cursor: grabbing; transform: scale(1.1); }
  #floating-assistant img { width: 36px; height: 36px; pointer-events: none; }
  .assistant-pulse { animation: pulse 2s infinite; }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 color-mix(in hsl, var(--brand) 50%, transparent); } 70% { box-shadow: 0 0 0 15px color-mix(in hsl, var(--brand) 0%, transparent); } 100% { box-shadow: 0 0 0 0 color-mix(in hsl, var(--brand) 0%, transparent); } }
  
  /* MEJORA: Diseño responsivo del modal del asistente */
  #assistantModal {
    max-width: 90vw;
    width: 450px;
    max-height: 85vh;
  }
  #assistantModal > div {
    width: 100%;
    height: 100%;
  }

  /* Mobile Responsiveness */
  @media (max-width: 1180px){
    body.aside-collapsed .container { grid-template-columns: 1fr; }
    body.aside-collapsed aside { width: 300px; transform: translateX(-101%);}
    body.aside-collapsed aside.hover-expand { display: none; } /* Disable hover on mobile logic */
    body.aside-open aside { transform: translateX(0); }
    .container{ grid-template-columns: 1fr; }
    aside{ position: fixed; inset: 0; transform: translateX(-101%); z-index: 99; background: var(--surface); width: 300px; height: 100vh;}
    body.aside-open { overflow: hidden; }
    body.aside-collapsed aside .brand-text, body.aside-collapsed aside .navBtn > span, body.aside-collapsed aside .projItem > span, body.aside-collapsed aside .projList-header, body.aside-collapsed aside .search input, body.aside-collapsed aside .user-info { opacity: 1; pointer-events: auto; max-width: 200px;}
  }
  @media (max-width: 768px) {
    .header-desktop-actions { display: none; }
    .header-mobile-actions { display: flex; }
    .hub-grid, .note-editor-wrapper, #cronopost-grid, .gchat-grid { grid-template-columns: 1fr; }
    #gchat.panel, #ai-global-chat.panel { padding: 0; }
    .gchat-grid { height: auto; max-height: calc(100vh - 80px); padding: 8px; gap: 8px; }
    .gchat-grid > .card:first-child { max-height: 200px; }
    .board { display: flex; gap: 8px; padding: 10px; overflow-x: auto; scroll-snap-type: x mandatory; grid-template-columns: none; }
    .col { flex: 0 0 280px; scroll-snap-align: start; padding: 6px; min-height: 160px; }
    .task { padding: 8px; font-size: var(--sm); margin: 4px 2px; }
    #finTable, #task-list-table { display: block; }
    #finTable thead, #task-list-table thead { display: none; }
    #finTable tr, #task-list-table tr { display: block; border-bottom: 2px solid var(--line); margin-bottom: 10px; padding-bottom: 10px; }
    #finTable td, #task-list-table td { display: block; text-align: right !important; padding: 4px; border-bottom: 1px solid var(--muted); }
    #finTable td::before, #task-list-table td::before { content: attr(data-label); float: left; font-weight: bold; text-transform: uppercase; color: var(--sub); font-size: var(--xs); }
    .panel { margin: 8px; }
    .tabs { padding: 8px; }
    .tab { padding: 6px 12px; font-size: var(--sm); }
    #project-header-right { flex-wrap: wrap; justify-content: flex-end; gap: 4px; }
    dialog { width: calc(100vw - 30px); max-width: 95%; }
    #p-tab-finance .overview-grid { grid-template-columns: 1fr 1fr; gap: 8px;}
    #p-tab-finance .stat-card p { font-size: var(--lg); }
    .stat-card { padding: 12px; }
    .day { min-height: 100px; }
    #cpMonthLbl { min-width: 100px; }
  }
  @media (max-width: 480px) {
      body { font-size: var(--sm); }
      .stat-card p { font-size: var(--lg); }
      .brand { font-size: var(--md); }
      .row { gap: 6px; }
      #p-tab-finance .overview-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body class="aside-collapsed">
<header class="app">
<button class="btn btn-ghost" id="menuBtn"><i data-lucide="menu"></i></button>
<div class="brand">
    <img src="https://goatify.com/assets/img/Logos%20HD.png" alt="Goatify Logo" class="brand-logo">
    <div class="brand-text">
       <span>Goatify <span style="color:var(--brand)">IA</span></span>
    </div>
</div>
<div class="spacer"></div>
<div class="header-desktop-actions">
    <div class="chip" id="walletChip" title="Ver Billetera"><i data-lucide="wallet"></i> <span id="wallet-amount">$0</span></div>
    <div class="chip" id="intisChip" title="Tus Intis (puntos de gamificación)"><i data-lucide="sparkles"></i> <span id="intis-amount">0</span></div>
    <button class="btn btn-ghost" id="themeBtn" title="Cambiar Tema"><i data-lucide="sun"></i></button>
    <button class="btn btn-ghost" id="tourBtn" title="Iniciar Tour"><i data-lucide="help-circle"></i></button>
</div>
<div class="header-mobile-actions">
    <div class="dropdown-container">
        <button class="btn btn-ghost" id="mobileMoreBtn"><i data-lucide="more-vertical"></i></button>
        <div class="dropdown-menu" id="mobileDropdown">
            <div id="mobileWalletBtn" class="dropdown-item"><i data-lucide="wallet"></i><span>Billetera</span></div>
            <div id="mobileIntisBtn" class="dropdown-item"><i data-lucide="sparkles"></i><span>Intis</span></div>
            <div id="mobileThemeBtn" class="dropdown-item"><i data-lucide="sun"></i><span>Tema</span></div>
            <div id="mobileTourBtn" class="dropdown-item"><i data-lucide="help-circle"></i><span>Tour</span></div>
        </div>
    </div>
</div>
</header>
<div class="container">
<aside>
<div>
    <div class="brand">
        <img src="https://goatify.com/assets/img/Logos%20HD.png" alt="Goatify Logo" class="brand-logo">
        <div class="brand-text" style="font-weight: 800; font-size: var(--lg);">
            <span>Goatify</span>
        </div>
    </div>
    <div class="search" style="margin-bottom: 10px;"><input id="q" placeholder="Buscar en todo…"/></div>
    <div class="projList-header row"><b>Proyectos</b><span class="spacer"></span><button class="btn" id="newProject"><i data-lucide="plus"></i> Nuevo</button></div>
    <div class="projList" id="projList" style="margin-top: 10px;"></div>
    <hr style="border-color:var(--line); margin: 10px 0;"/>
    <div id="nav-list" class="projList">
        <a class="navBtn" data-nav="ai-global-chat" href="#ai-global-chat"><i data-lucide="bot"></i> <span>Asistente IA Global</span></a>
        <a class="navBtn" data-nav="cronopost" href="#cronopost"><i data-lucide="calendar-days"></i> <span>Calendario General</span></a>
        <a class="navBtn" data-nav="hub" href="#hub"><i data-lucide="globe-2"></i> <span>Hub Profesional</span></a>
        <a class="navBtn" data-nav="gchat" href="#gchat"><i data-lucide="messages-square"></i> <span>Chat Global</span></a>
        <a class="navBtn" data-nav="monet" href="#monet"><i data-lucide="dollar-sign"></i> <span>Asistente de Monetización</span></a>
        <a class="navBtn" data-nav="mindset" href="#mindset"><i data-lucide="brain-circuit"></i> <span>Bienestar y Mindset</span></a>
        <a class="navBtn" data-nav="settings" href="#settings"><i data-lucide="settings"></i> <span>Ajustes</span></a>
    </div>
</div>
<div id="user-profile-sidebar" class="user-profile-snippet">
    <!-- User profile will be rendered here by JS -->
</div>
</aside>
<main id="main">
<!-- PROJECT SHELL -->
<section class="panel" id="projectShell" style="display:none">
<div class="tabs" id="project-tabs">
    <button class="tab active" data-ptab="overview">Overview</button>
    <button class="tab" data-ptab="tasks">Tareas</button>
    <button class="tab" data-ptab="calendar">Calendario</button>
    <button class="tab" data-ptab="notes">Notas</button>
    <button class="tab" data-ptab="tables">Tablas</button>
    <button class="tab" data-ptab="files">Archivos</button>
    <button class="tab" data-ptab="chat">Chat IA</button>
    <button class="tab" data-ptab="finance">Finanzas</button>
    <div class="spacer"></div>
    <div id="project-header-right" class="row">
        <div class="chip" id="projectNameChip">Proyecto</div>
        <button class="btn btn-sm" id="addFolder" title="Nueva Carpeta"><i data-lucide="folder-plus"></i></button>
        <select id="folderSel" class="btn-sm"></select>
        <button class="btn btn-primary btn-sm" id="quickAdd"><i data-lucide="plus"></i> Añadir</button>
    </div>
</div>
<!-- OVERVIEW -->
<div id="p-tab-overview" style="padding:16px; display:block;">
    <div class="card" style="margin-bottom:16px"><h3 id="overview-explainer-title"></h3><p id="overview-explainer-text" class="sub"></p></div>
    <div id="ovr" class="overview-grid"></div>
</div>
<!-- TASKS -->
<div id="p-tab-tasks" style="display:none;">
    <div class="card" style="margin:10px; padding:12px;"><h3 id="tasks-explainer-title"></h3><p id="tasks-explainer-text" class="sub"></p></div>
    <div class="row" style="padding: 6px 10px; border-bottom: 1px solid var(--line);">
        <button id="viewToggleBoard" class="btn btn-ghost active"><i data-lucide="layout-grid"></i> Tablero</button>
        <button id="viewToggleList" class="btn btn-ghost"><i data-lucide="list"></i> Lista</button>
        <span class="spacer"></span>
        <button id="addColumnBtn" class="btn btn-sm"><i data-lucide="plus"></i> Columna</button>
    </div>
    <div id="kanban-view">
        <div class="board" id="kanban"></div>
    </div>
    <div id="list-view" class="table-wrapper" style="display:none; padding: 10px;">
        <table id="task-list-table" style="width:100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="width: 50%;">Tarea</th>
                    <th>Estado</th>
                    <th>Fecha Límite</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<!-- CALENDAR -->
<div id="p-tab-calendar" style="display:none; padding:10px;">
    <div class="card" style="margin-bottom:10px; padding:12px;"><h3 id="calendar-explainer-title"></h3><p id="calendar-explainer-text" class="sub"></p></div>
    <div class="row"><b>Calendario del proyecto</b><span class="spacer"></span><button class="btn" id="prevM"><i data-lucide="chevron-left"></i></button><div class="chip" id="monthLbl">Mes</div><button class="btn" id="nextM"><i data-lucide="chevron-right"></i></button></div>
    <div class="calendar" id="calGrid" style="margin-top:10px;"></div>
</div>
<!-- NOTES -->
<div id="p-tab-notes" style="display:none; padding:10px">
     <div class="card" style="margin-bottom:10px; padding:12px;"><h3 id="notes-explainer-title"></h3><p id="notes-explainer-text" class="sub"></p></div>
    <div class="note-editor-wrapper">
        <div class="card" style="padding:8px;">
            <div class="row" style="margin-bottom:8px; padding: 4px; flex-wrap: wrap;">
                <button class="btn btn-sm" data-cmd="bold" title="Negrita"><b>B</b></button>
                <button class="btn btn-sm" data-cmd="italic" title="Cursiva"><i>I</i></button>
                <button class="btn btn-sm" data-cmd="underline" title="Subrayado"><u>U</u></button>
                <button class="btn btn-sm" data-cmd="insertUnorderedList" title="Lista Viñetas">•</button>
                <button class="btn btn-sm" data-cmd="insertOrderedList" title="Lista Numerada">1.</button>
                <button class="btn btn-sm" data-cmd="formatBlock" data-value="h2">H2</button>
                <button class="btn btn-sm" data-cmd="formatBlock" data-value="h3">H3</button>
                <button class="btn btn-sm" id="notePreviewBtn" title="Vista Previa HTML"><i data-lucide="eye"></i></button>
                <span class="spacer"></span>
                <button class="btn btn-sm" id="exportNotePDF"><i data-lucide="file-down"></i> PDF</button>
            </div>
            <div id="noteEditor" contenteditable="true"></div>
        </div>
        <div>
            <div class="card">
                <div class="row"><b>Mis Notas</b><span class="spacer"></span><button class="btn btn-sm" id="newNoteBtn"><i data-lucide="plus"></i></button></div>
                <div id="noteList" style="margin-top:8px; max-height: 20vh; overflow-y: auto;"></div>
            </div>
            <div class="card" style="margin-top:10px">
                <div class="row"><b>Lienzo Rápido</b><span class="spacer"></span>
                    <button class="btn btn-sm" id="undoCanvasBtn" title="Deshacer"><i data-lucide="undo-2"></i></button>
                    <button class="btn btn-sm" id="redoCanvasBtn" title="Rehacer"><i data-lucide="redo-2"></i></button>
                    <button class="btn btn-sm" id="clearCanvasBtn" title="Limpiar"><i data-lucide="eraser"></i></button>
                </div>
                <div class="row" style="margin: 8px 0;">
                    <input type="color" id="canvasColorPicker" title="Color del Pincel">
                    <input type="range" id="canvasStrokeSlider" min="1" max="20" value="3" title="Grosor del Pincel" style="flex:1;">
                </div>
                <canvas id="drawingCanvas"></canvas>
            </div>
        </div>
    </div>
</div>
<!-- TABLES -->
<div id="p-tab-tables" style="display:none; padding:10px;">
    <div class="card" style="margin-bottom:10px; padding:12px;"><h3 id="tables-explainer-title"></h3><p id="tables-explainer-text" class="sub"></p></div>
    <div class="row">
      <select id="tableSelector" class="btn-sm"></select>
      <button class="btn" id="newTableBtn"><i data-lucide="plus-square"></i></button>
      <span class="spacer"></span>
      <button class="btn" id="addCol"><i data-lucide="plus"></i> Columna</button>
      <button class="btn" id="addRow"><i data-lucide="plus"></i> Fila</button>
      <button class="btn" id="exportCSV">CSV</button>
    </div>
    <div class="section table-wrapper" id="sheetWrap" style="margin-top:10px;"></div>
</div>
<!-- FILES -->
<div id="p-tab-files" style="display:none;padding:10px">
    <div class="card" style="margin-bottom:10px; padding:12px;"><h3 id="files-explainer-title"></h3><p id="files-explainer-text" class="sub"></p></div>
    <div class="row"><b>Archivos</b><span class="spacer"></span><label class="btn btn-primary"><i data-lucide="upload"></i> Subir Archivos<input id="fileInput" multiple type="file" style="display: none;"/></label></div>
    <div id="fileList" style="margin-top:10px" class="row"></div>
</div>
<!-- CHAT IA -->
<div id="p-tab-chat" style="display:none">
    <div class="gchat-grid">
        <div class="card" style="display:flex; flex-direction: column; overflow-y: auto;">
            <div class="row"><b>Conversaciones</b><span class="spacer"></span><button class="btn btn-sm" id="newChat"><i data-lucide="plus"></i></button></div>
            <div class="card" style="margin-top:8px; padding:12px;"><h3 id="chat-explainer-title" style="margin-top:0"></h3><p id="chat-explainer-text" class="sub"></p></div>
            <div id="chatList" style="margin-top:8px"></div>
        </div>
        <div class="card" style="display:flex; flex-direction:column; height: 100%;">
            <div class="model-selector">
                <div class="model-card active" data-model="pro">
                    <h5>Goatify Pro</h5>
                    <p>Potente y creativo, ideal para la mayoría de tareas.</p>
                </div>
                <div class="model-card" data-model="web">
                    <h5>Goatify Web</h5>
                    <p>Conectado a internet para respuestas actualizadas.</p>
                </div>
                <div class="model-card disabled" data-model="x" title="Requiere Plan Premium">
                    <h5>Goatify X</h5>
                    <p>Nuestro modelo más avanzado y veloz.</p>
                    <div class="pro-badge">PRO</div>
                </div>
            </div>
            <div class="row" style="border-bottom: 1px solid var(--line); padding-bottom: 8px; margin-bottom: 8px;">
                 <span class="spacer"></span>
                <button class="btn btn-sm" id="chatToTasks"><i data-lucide="list-plus"></i> Crear Tarea</button>
            </div>
            <div id="chatLog" class="chat-log"></div>
            <div class="row chat-input-area">
                <button class="btn btn-ghost" id="p_attachFileBtn" title="Analizar Imagen, PDF, etc."><i data-lucide="paperclip"></i></button>
                <textarea class="spacer" id="chatMsg" placeholder="Habla con la IA de tu proyecto…" rows="1"></textarea>
                <button class="btn btn-primary" id="sendMsg"><i data-lucide="send"></i></button>
                <input type="file" id="p_chatFileInput" style="display:none" />
            </div>
        </div>
    </div>
</div>
<!-- FINANZAS -->
<div id="p-tab-finance" style="display:none; padding:10px;">
    <div class="card" style="margin-bottom:10px; padding:12px;"><h3 id="finance-explainer-title"></h3><p id="finance-explainer-text" class="sub"></p></div>
    <div class="row"><b>Finanzas del Proyecto</b><span class="spacer"></span><button class="btn btn-primary" id="finNew"><i data-lucide="plus"></i> Movimiento</button><button class="btn" id="finExport">CSV</button></div>
    <div class="overview-grid" style="padding: 10px 0;">
        <div class="stat-card"><h4>Ingresos Totales</h4><p id="finIn" style="color: var(--success);">0</p></div>
        <div class="stat-card"><h4>Egresos Totales</h4><p id="finOut" style="color: var(--danger);">0</p></div>
        <div class="stat-card"><h4>Balance Neto</h4><p id="finBal">0</p></div>
    </div>
    <div class="table-wrapper">
        <table id="finTable" style="width:100%; border-collapse: collapse;">
            <thead><tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Categoría</th><th>Nota</th><th></th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
</section>
<!-- GLOBAL AI ASSISTANT -->
<section class="panel" id="ai-global-chat" style="display:none;">
    <div class="gchat-grid">
        <div class="card" style="display:flex; flex-direction: column; overflow-y: auto;">
            <div class="row"><b>Conversaciones</b><span class="spacer"></span><button class="btn btn-sm" id="aiNewChat"><i data-lucide="plus"></i></button></div>
            <div id="aiChatList" style="margin-top:8px"></div>
        </div>
        <div class="card" style="display:flex; flex-direction:column; height: 100%;">
             <div class="model-selector">
                <div class="model-card active" data-model="pro">
                    <h5>Goatify Pro</h5>
                    <p>Potente y creativo, ideal para la mayoría de tareas.</p>
                </div>
                <div class="model-card" data-model="web">
                    <h5>Goatify Web</h5>
                    <p>Conectado a internet para respuestas actualizadas.</p>
                </div>
                <div class="model-card disabled" data-model="x" title="Requiere Plan Premium">
                    <h5>Goatify X</h5>
                    <p>Nuestro modelo más avanzado y veloz.</p>
                    <div class="pro-badge">PRO</div>
                </div>
            </div>
            <div class="row" style="border-bottom: 1px solid var(--line); padding-bottom: 8px; margin-bottom: 8px;">
                <span class="spacer"></span>
                <button class="btn btn-sm" id="aiImageGenBtn"><i data-lucide="image"></i> Generar Imagen</button>
            </div>
            <div id="aiChatLog" class="chat-log"></div>
            <div class="row chat-input-area">
                <button class="btn btn-ghost" id="g_attachFileBtn" title="Analizar Imagen, PDF, etc."><i data-lucide="paperclip"></i></button>
                <textarea class="spacer" id="aiChatMsg" placeholder="Habla con tu Asistente IA Global..." rows="1"></textarea>
                <button class="btn btn-primary" id="aiSendMsg"><i data-lucide="send"></i></button>
                <input type="file" id="g_chatFileInput" style="display:none" />
            </div>
        </div>
    </div>
</section>
<!-- CRONOPOST, HUB, ETC. -->
<section class="panel" id="cronopost" style="display:none;">
    <div class="row" style="padding:12px; border-bottom: 1px solid var(--line);">
        <b>CronoPOST</b>
        <div class="chip">Proyecto:</div>
        <select id="cpProjectSelect" class="btn-sm"></select>
        <span class="spacer"></span>
        <button class="btn" id="cpPrevM"><i data-lucide="chevron-left"></i></button>
        <div class="chip" id="cpMonthLbl">Mes</div>
        <button class="btn" id="cpNextM"><i data-lucide="chevron-right"></i></button>
    </div>
    <div id="cronopost-grid">
        <div id="cpCalendarContainer">
            <div class="calendar" id="cpCalendar"></div>
        </div>
        <div id="cpIdeas">
            <div class="card">
                <div class="row"><b>💡 Banco de Ideas</b><span class="spacer"></span><button class="btn btn-primary btn-sm" id="cpGenAIIdeas"><i data-lucide="sparkles"></i> IA</button></div>
                <div id="cpIdeasList" style="max-height: 50vh; overflow-y: auto; padding-right: 5px; margin: 10px 0;"></div>
                <input id="cpNewIdeaInput" placeholder="Escribe una nueva idea..." style="margin-bottom: 8px;">
                <button class="btn" id="cpAddIdeaBtn" style="width: 100%;">+ Añadir Idea</button>
            </div>
        </div>
    </div>
</section>
<section class="panel" id="hub" style="display:none; padding: 10px;">
    <div class="hub-grid">
    <div class="profile-card" style="background:var(--surface); border-radius:var(--radius); border:1px solid var(--line);">
        <div class="profile-header"></div>
        <div class="avatar-wrapper" style="padding: 0 20px;">
             <img alt="avatar" class="avatar" id="avatar" src="https://placehold.co/100x100/dde2ed/0b132a?text=TÚ"/>
             <input type="file" id="avatarInput" accept="image/*" style="display:none;">
        </div>
        <div style="padding: 0 20px 20px;">
            <h3 id="pNombreDisplay" style="margin: 0; display:inline-block; cursor:pointer;">Tu Nombre</h3>
            <p id="pRoleDisplay" class="sub" style="margin: 4px 0 10px; cursor:pointer;">Tu Rol Profesional</p>
            <p id="pBioDisplay" class="sub" style="font-size: var(--sm); cursor:pointer;">Tu biografía profesional. Habla sobre tu experiencia, tus habilidades y lo que buscas.</p>
            <div id="pSocialsDisplay" class="row"></div>
            <div id="upload-photo-prompt" class="tip" style="display:none; font-size:var(--sm); text-align:center; margin-top:10px;">¡<a href="#" onclick="$('#avatar').click()">Sube tu foto de perfil</a> para personalizar tu experiencia!</div>
            <hr style="border-color:var(--line);"/>
            <b>Editar Perfil</b>
            <input id="pNombre" placeholder="Tu nombre" style="margin-top: 8px;"/>
            <input id="pRole" placeholder="Rol (Ej: Frontend Developer)" style="margin: 8px 0;"/>
            <textarea id="pBio" placeholder="Bio corta" rows="3" style="margin-bottom: 8px;"></textarea>
            <div class="row"><input id="pSocialLinkedin" placeholder="URL LinkedIn"/><input id="pSocialTwitter" placeholder="URL Twitter"/></div>
            <button class="btn btn-primary" id="savePerfil" style="width:100%; margin-top:10px;">Guardar Perfil</button>
        </div>
    </div>
    <div>
        <div class="tabs" style="padding:0; border-bottom:none; margin-bottom:10px;">
            <button class="tab active" data-htab="market">Mercado de Servicios</button>
            <button class="tab" data-htab="jobs">Bolsa de Empleos</button>
        </div>
        <div id="h-htab-market">
            <div class="card" style="margin-bottom: 10px;">
              <b>Publicar un nuevo producto o servicio</b>
              <div class="row"><input id="mkName" placeholder="Nombre"/><input id="mkPrice" placeholder="Precio (Ej: 500)" type="number"/></div>
              <textarea id="mkDesc" placeholder="Describe tu servicio..." rows="2" style="width:100%; margin: 8px 0;"></textarea>
              <button class="btn btn-primary" id="addMK">Publicar en Mercado</button>
            </div>
            <div id="mkList" style="max-height: 60vh; overflow-y:auto; padding: 5px;"></div>
        </div>
        <div id="h-htab-jobs" style="display:none;">
             <div class="card" style="margin-bottom: 10px;">
              <b>Publicar una nueva oferta de empleo</b>
              <div class="row" style="gap: 8px; margin-top: 8px;">
                <input id="jobTitle" placeholder="Título del Puesto" style="flex: 2;"/>
                <input id="jobCompany" placeholder="Empresa" style="flex: 1;"/>
              </div>
              <div class="row" style="gap: 8px; margin-top: 8px;">
                <input id="jobLocation" placeholder="Ubicación (Ej: Remoto)" style="flex: 1;"/>
                <input id="jobPay" placeholder="Salario (Ej: $2000/mes)" style="flex: 1;"/>
                <select id="jobType" style="flex: 1;">
                    <option>Tiempo Completo</option>
                    <option>Medio Tiempo</option>
                    <option>Por Proyecto</option>
                    <option>Freelance</option>
                </select>
              </div>
              <textarea id="jobDesc" placeholder="Descripción del puesto, requisitos, beneficios..." rows="4" style="width:100%; margin: 8px 0;"></textarea>
              <button class="btn btn-primary" id="addJob">Publicar Empleo</button>
            </div>
            <div class="row" style="padding: 0 5px; margin-bottom: 10px;">
                <input id="jobSearchInput" placeholder="Buscar empleos por título o empresa...">
            </div>
            <div id="jobsList" style="max-height: 60vh; overflow-y:auto; padding: 5px;"></div>
        </div>
    </div>
</div>
</section>
<section class="panel" id="gchat" style="display:none">
    <div class="gchat-grid">
        <div class="card" style="display:flex; flex-direction: column;">
            <b>Usuarios Conectados</b>
            <div id="gUserList" class="user-list" style="margin-top:8px; flex:1; overflow-y:auto;"></div>
        </div>
        <div class="card" style="display:flex; flex-direction:column;">
            <div id="gChatHeader" class="row" style="margin: 0 0 10px 0;"></div>
            <div id="gChatLog" class="chat-log" style="flex:1;"></div>
            <div class="row" style="padding-top:10px;"><input class="spacer" id="gChatMsg" placeholder="Escribe un mensaje..."/><button class="btn btn-primary" id="sendGChat"><i data-lucide="send"></i></button></div>
        </div>
    </div>
</section>
<section class="panel" id="monet" style="display:none; padding: 10px;">
    <div class="card" style="text-align: center; background: linear-gradient(145deg, color-mix(in hsl, var(--brand) 85%, black), color-mix(in hsl, var(--accent) 85%, black)); color: white;">
        <h2 style="margin:0;">Asistente de Monetización Quantum Pro</h2>
        <p style="opacity: 0.8;">Transforma tus ideas en ingresos. Cada módulo es una guía detallada para construir un negocio digital sólido y rentable.</p>
    </div>
    <div id="monet-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; margin-top: 10px;">
    </div>
</section>
<section class="panel" id="mindset" style="display:none; padding: 10px;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; align-items: start;">
        <div class="card">
            <h3><i data-lucide="brain-circuit"></i> Balance Mente-Cuerpo</h3>
            <p class="sub">El verdadero éxito no es solo alcanzar metas, sino mantener un equilibrio saludable. Tu bienestar es la base de tu productividad y creatividad.</p>
            <p class="sub" style="font-size: var(--sm);">Una parte clave del balance es mejorar tus habilidades sociales y hacer networking. Por eso hemos creado el Chat Global, un espacio para que conectes con otros profesionales.</p>
            <div class="row" style="margin-top: 16px;">
                <a href="#gchat" class="btn btn-primary nav-link-btn" style="width: 100%;">
                    <i data-lucide="messages-square"></i>
                    <span>Ir al Chat Global</span>
                </a>
            </div>
        </div>
        <div class="card" style="text-align:center;">
            <h3><i data-lucide="wind"></i> Pausa para Respirar</h3>
            <p class="sub">Tómate un minuto para centrarte.</p>
            <div id="breathing-circle-container">
                <div id="breathing-circle"></div>
                <span id="breathing-text">Inhala...</span>
            </div>
        </div>
        <div class="card">
            <h3><i data-lucide="dumbbell"></i> Momento de Actividad</h3>
            <p class="sub">El movimiento impulsa la mente. Estira tu cuerpo o prepárate para una rutina de entrenamiento completa para recargar tu energía.</p>
            <div class="row" style="margin-top: 16px; justify-content: center;">
                <a href="https://www.goatify.app/fit" target="_blank" class="btn btn-primary" style="width: 100%;">
                    <i data-lucide="external-link"></i>
                    <span>Entrenar con goatiFIT (Rutinas Gratis)</span>
                </a>
            </div>
        </div>
         <div class="card">
            <h3><i data-lucide="quote"></i> Dosis de Inspiración</h3>
            <p class="sub" id="mindsetQuote">"El éxito es la suma de pequeños esfuerzos repetidos día tras día."</p>
        </div>
    </div>
</section>
<section class="panel" id="settings" style="display:none;padding:10px">
<div class="card">
<b>Ajustes de la Aplicación</b>
<div class="row" style="margin-top:8px"><button class="btn" id="btnExport">Exportar Datos (.json)</button><label class="btn">Importar Datos<input type="file" accept="application/json" id="btnImport" style="display:none;"/></label><button class="btn" id="resetApp" style="background:var(--danger); color:white;">Reset Total</button></div>
<div class="section tip"><i data-lucide="database"></i> Todo se guarda offline en tu navegador (localStorage). Para colaborar, se necesita una base de datos como Firebase.</div>
</div>
</section>
<!-- MODALS -->
<dialog id="industryModal">
    <div style="padding: 24px; text-align: center;">
        <i data-lucide="briefcase" width="48" height="48" style="color: var(--brand);"></i>
        <h2 style="margin-top: 10px;">¡Bienvenido a Goatify IA!</h2>
        <p class="sub">Para empezar, personalicemos tu espacio de trabajo. ¿Cuál es tu industria o tipo de negocio?</p>
        <div class="card" style="text-align: left;">
             <label for="industrySelect">Selecciona tu Industria:</label>
             <select id="industrySelect" style="width: 100%; margin: 12px 0;">
                <option value="agency">Agencia de Marketing / Servicios</option>
                <option value="ecommerce">E-commerce / Tienda Online</option>
                <option value="creator">Creador de Contenido / Marca Personal</option>
                <option value="generic">Otro / General</option>
            </select>
            <button class="btn btn-primary" id="loadIndustryBtn" style="width: 100%;">Personalizar y Empezar</button>
        </div>
    </div>
</dialog>
<dialog id="inputModal">
    <div style="padding: 24px;">
        <h3 id="inputModalTitle" style="margin-top:0"></h3>
        <p id="inputModalDesc" class="sub"></p>
        <input id="inputModalInput" style="margin-bottom: 12px;"/>
        <div class="row" style="margin-top: 24px;">
            <button class="btn" id="inputModalCancel">Cancelar</button>
            <span class="spacer"></span>
            <button class="btn btn-primary" id="inputModalConfirm">Confirmar</button>
        </div>
    </div>
</dialog>
<dialog id="taskDetailModal">
    <div style="padding: 24px; display: flex; flex-direction: column; max-height: 85vh;">
        <div class="row">
            <h3 style="margin-top:0">Detalles de la Tarea</h3>
            <span class="spacer"></span>
            <button class="btn btn-ghost" onclick="$('#taskDetailModal').close()"><i data-lucide="x"></i></button>
        </div>
        <input type="hidden" id="taskDetailId">
        <div style="overflow-y: auto; padding-right: 10px;">
            <label>Título de la Tarea</label>
            <input id="taskDetailTitle" placeholder="¿Qué hay que hacer?" style="margin: 8px 0 16px; font-size: var(--lg); padding: 12px;" />
            <label>Descripción</label>
            <textarea id="taskDetailDesc" placeholder="Añade más detalles..." rows="4" style="margin: 8px 0 16px;"></textarea>
            <div class="row" style="gap: 16px;">
                <div style="flex:1">
                    <label>Estado</label>
                    <select id="taskDetailStatus" style="margin-top: 8px;"></select>
                </div>
                <div style="flex:1">
                    <label>Fecha Límite</label>
                    <input type="date" id="taskDetailDue" style="margin-top: 8px;" />
                </div>
            </div>
        </div>
        <div class="row" style="margin-top: 24px; border-top: 1px solid var(--line); padding-top: 16px;">
            <button class="btn" style="color:var(--danger);" id="taskDetailDeleteBtn"><i data-lucide="trash-2"></i> Eliminar</button>
            <span class="spacer"></span>
            <button class="btn" onclick="$('#taskDetailModal').close()">Cancelar</button>
            <button class="btn btn-primary" id="taskDetailSaveBtn"><i data-lucide="save"></i> Guardar Cambios</button>
        </div>
    </div>
</dialog>
<dialog id="premiumModal">
    <div style="padding: 24px; text-align: center; position: relative;">
        <button onclick="$('#premiumModal').close()" class="btn btn-ghost" style="position:absolute; top:10px; right:10px; z-index: 1;"><i data-lucide="x"></i></button>
        <div style="background: linear-gradient(145deg, var(--brand), var(--brand2)); color: white; margin: -24px -24px 24px -24px; padding: 32px 24px; border-radius: var(--radius) var(--radius) 0 0;">
            <h2 style="margin: 0;">🚀 Desbloquea Goatify IA PREMIUM</h2>
            <p style="opacity: 0.9; margin: 8px 0 0;">Acceso ilimitado a todo el potencial de la IA por el precio de un café.</p>
        </div>
        <div style="text-align: left; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="card" style="padding: 12px;">
                <h4 style="margin-top:0"><i data-lucide="zap"></i> Beneficios Premium</h4>
                <ul style="padding-left: 20px; font-size: var(--sm); line-height: 1.6;">
                    <li>Créditos de IA <b>ilimitados</b></li>
                    <li>Acceso al modelo <b>Goatify X</b></li>
                    <li>Generación de imágenes avanzada</li>
                    <li>Soporte prioritario</li>
                    <li><b>BONUS:</b> Tu propia página web de E-commerce, ¡gratis!</li>
                </ul>
            </div>
            <div class="card" style="padding: 12px; background: color-mix(in hsl, var(--brand) 8%, transparent);">
                <h4 style="margin-top:0">Plan Único</h4>
                <p style="font-size: 2.5em; font-weight: 800; margin: 8px 0; color: var(--brand);">$4 <span style="font-size: 0.5em; font-weight: 500; color: var(--sub);">/mes</span></p>
                <p class="sub" style="font-size: var(--sm);">Todo el poder de IAs de $20/mes, a una fracción del costo.</p>
                <button class="btn btn-primary" style="width: 100%; margin-top: 16px; padding: 12px; background: #0070ba;"><i data-lucide="paypal"></i> Pagar con PayPal</button>
                <p class="sub" style="font-size: var(--xs); text-align: center; margin-top: 8px;">Aceptamos todas las tarjetas de crédito/débito</p>
            </div>
        </div>
    </div>
</dialog>
<dialog id="videoCallModal">
    <div style="padding: 24px; text-align: center;">
        <h3 id="videoCallTitle">Llamando a...</h3>
        <p class="sub">Esperando que acepte la llamada.</p>
        <div style="width: 120px; height: 120px; border-radius: 50%; background: var(--muted); margin: 20px auto; display:flex; align-items:center; justify-content:center;"><i data-lucide="video" size="48"></i></div>
        <button class="btn" style="background:var(--danger); color:white;" onclick="$('#videoCallModal').close()">Cancelar Llamada</button>
    </div>
</dialog>
<dialog id="monetModuleModal">
    <div style="padding: 24px; display: flex; flex-direction: column; max-height: 85vh;">
         <div class="row">
            <h3 id="monetModuleTitle" style="margin-top:0; color: var(--brand);"></h3>
            <span class="spacer"></span>
            <button onclick="$('#monetModuleModal').close()" class="btn btn-ghost"><i data-lucide="x"></i></button>
        </div>
        <div id="monetModuleContent" style="overflow-y: auto; padding-right: 10px;"></div>
    </div>
</dialog>
<dialog id="walletModal">
    <div style="padding: 24px; display: flex; flex-direction: column; max-height: 85vh;">
        <div class="row">
            <h3 style="margin-top:0"><i data-lucide="wallet"></i> Billetera General</h3>
            <span class="spacer"></span>
            <button onclick="$('#walletModal').close()" class="btn btn-ghost"><i data-lucide="x"></i></button>
        </div>
         <div class="card" style="margin: 10px 0; background: linear-gradient(90deg, var(--brand), var(--brand2)); color: white;">
            <h4 style="margin: 0; opacity: .8;">Balance Total</h4>
            <p id="walletTotalBalance" style="font-size: 2em; margin: 0; font-weight: 700;">$0.00</p>
        </div>
        <div class="tabs" style="padding:0; border:0; margin-bottom: 10px;">
            <button class="tab active" data-wtab="movs">Movimientos</button>
            <button class="tab" data-wtab="transfer">Transferir</button>
        </div>
        <div id="w-wtab-movs">
            <div class="card" style="margin: 10px 0;">
                <div class="row"><input id="wMonto" placeholder="Monto" type="number" step="0.01"/><select id="wTipo"><option>Ingreso</option><option>Egreso</option></select></div>
                <div class="row" style="margin-top:8px"><input id="wCat" placeholder="Categoría" class="spacer"/><input id="wNota" placeholder="Nota" class="spacer"/></div>
                <button class="btn btn-primary" id="wAdd" style="width:100%; margin-top:8px;">+ Añadir Movimiento</button>
            </div>
            <div class="table-wrapper" style="overflow-y: auto; padding-right: 10px;">
                <table style="width:100%;">
                    <thead><tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Cat</th><th>Nota</th><th></th></tr></thead>
                    <tbody id="wBody"></tbody>
                </table>
            </div>
        </div>
        <div id="w-wtab-transfer" style="display:none;">
            <div class="card">
                <h4>Transferir fondos a otro usuario</h4>
                <p class="sub" style="font-size: var(--sm);">Realiza transferencias instantáneas y seguras a otros usuarios de Goatify. Solo necesitas su nombre de usuario.</p>
                <label>Usuario Destino</label>
                <select id="transferUserSelect" style="margin: 8px 0;"></select>
                <label>Monto a Transferir</label>
                <input id="transferAmount" type="number" placeholder="0.00" style="margin-top: 8px;">
                <button id="confirmTransferBtn" class="btn btn-primary" style="width: 100%; margin-top: 16px;">Confirmar Transferencia</button>
                 <div class="tip" style="margin-top: 16px;"><p><b>¿Por qué usar la Billetera Goatify?</b> Es un sistema de economía circular. Al usarlo, apoyas un ecosistema justo con bajas comisiones, fomentando el comercio directo entre profesionales y creativos de la plataforma.</p></div>
            </div>
        </div>
    </div>
</dialog>
<dialog id="intisModal">
     <div style="padding: 24px; text-align: center;">
        <button onclick="$('#intisModal').close()" class="btn btn-ghost" style="position:absolute; top:10px; right:10px;"><i data-lucide="x"></i></button>
        <i data-lucide="sparkles" width="48" height="48" style="color: var(--brand);"></i>
        <h2 style="margin-top: 10px;">¿Qué son los Intis? ✨</h2>
        <p class="sub">Los Intis son nuestra moneda de gamificación, diseñada para fomentar una <b>economía circular y saludable</b> dentro de todo el ecosistema de Goatify IA.</p>
        <div class="card" style="text-align: left;">
            <h4 style="margin-top:0">¿Cómo funcionan?</h4>
            <p>Ganas Intis al participar activamente en la plataforma: completando tareas, creando proyectos, colaborando con otros, etc. Esto recompensa tu productividad y fomenta hábitos positivos.</p>
            <h4 style="margin-top:1em;">Beneficios y Futuro</h4>
            <p>Actualmente, los Intis miden tu progreso. En el futuro, podrás usarlos para:</p>
            <ul style="padding-left: 20px;">
                <li>Canjear recompensas exclusivas.</li>
                <li>Acceder a funciones premium.</li>
                <li>Pagar por servicios en nuestro mercado.</li>
                <li>Obtener descuentos con marcas aliadas con las que tenemos convenio.</li>
            </ul>
             <div class="tip"><p><b>¡Los Intis son una moneda saludable!</b> Promueven la colaboración y el crecimiento mutuo, un pilar en todas las aplicaciones de Goatify.</p></div>
        </div>
    </div>
</dialog>
<dialog id="sendChatModal">
    <div style="padding: 24px;">
        <h3 id="sendChatModalTitle" style="margin-top:0">Enviar Conversación a Proyecto</h3>
        <p class="sub">Selecciona el proyecto de destino:</p>
        <select id="sendChatProjectSelect" style="width: 100%; margin: 12px 0;"></select>
        <div class="row" style="margin-top: 24px;">
            <button class="btn" onclick="$('#sendChatModal').close()">Cancelar</button>
            <span class="spacer"></span>
            <button class="btn btn-primary" id="sendChatConfirmBtn">Confirmar</button>
        </div>
    </div>
</dialog>
<dialog id="cronoTaskModal">
    <div style="padding: 24px;">
        <h3 id="cronoTaskModalTitle" style="margin-top:0">Nueva Tarea</h3>
        <p id="cronoTaskModalDesc" class="sub"></p>
        <label>Título de la Tarea</label>
        <input id="cronoTaskTitle" style="margin: 8px 0 16px;" />
        <label>Asignar a Proyecto</label>
        <select id="cronoTaskProjectSelect" style="margin-top: 8px;"></select>
        <div class="row" style="margin-top: 24px;">
            <button class="btn" onclick="$('#cronoTaskModal').close()">Cancelar</button>
            <span class="spacer"></span>
            <button class="btn btn-primary" id="cronoTaskConfirm">Crear Tarea</button>
        </div>
    </div>
</dialog>
<dialog id="searchModal">
    <div style="padding: 24px; display: flex; flex-direction: column; max-height: 85vh;">
        <div class="row">
            <h3 style="margin-top:0">Resultados de Búsqueda</h3>
            <span class="spacer"></span>
            <button class="btn btn-ghost" onclick="$('#searchModal').close()"><i data-lucide="x"></i></button>
        </div>
        <div id="searchResults" style="overflow-y: auto; padding-right: 10px; margin-top: 16px;"></div>
    </div>
</dialog>
<dialog id="imagePreviewModal">
    <img id="imagePreviewSrc" src="" style="width: 100%; height: auto; max-height: 80vh; object-fit: contain;">
</dialog>
<dialog id="htmlPreviewModal">
     <div style="padding: 12px; display: flex; flex-direction: column; height: 85vh; max-width: 90vw; width: 1200px;">
        <div class="row">
            <h3 style="margin-top:0">Vista Previa de HTML</h3>
            <span class="spacer"></span>
            <button class="btn btn-ghost" onclick="$('#htmlPreviewModal').close()"><i data-lucide="x"></i></button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; height: 100%; overflow: hidden; margin-top: 10px;">
            <div style="display: flex; flex-direction: column;">
                <h4 style="margin-top:0; margin-bottom: 8px;">Código Fuente</h4>
                <div id="htmlPreviewCodeWrapper" style="flex: 1; border: 1px solid var(--line); border-radius: 8px; background: var(--muted); padding: 8px; overflow: auto;">
                    <pre><code id="htmlPreviewCode"></code></pre>
                </div>
            </div>
            <div style="display: flex; flex-direction: column;">
                <h4 style="margin-top:0; margin-bottom: 8px;">Vista Previa Renderizada</h4>
                <iframe id="htmlPreviewFrame" style="width: 100%; height: 100%; border: 1px solid var(--line); border-radius: 8px;"></iframe>
            </div>
        </div>
     </div>
</dialog>
<dialog id="assistantModal">
    <div style="padding: 0; display: flex; flex-direction: column; height: 100%; width: 100%;">
        <div class="row" style="padding: 12px; border-bottom: 1px solid var(--line);">
            <img src="https://goatify.com/assets/img/Logos%20HD.png" style="width:32px; height:32px;">
            <h3 style="margin:0;">Asistente Goatify</h3>
            <span class="spacer"></span>
            <button class="btn btn-ghost" id="assistantMuteBtn"><i data-lucide="volume-2"></i></button>
            <button class="btn btn-ghost" onclick="$('#assistantModal').close()"><i data-lucide="x"></i></button>
        </div>
        <div id="assistantChatLog" class="chat-log" style="flex: 1; padding: 10px; background: var(--bg);"></div>
        <div id="assistantActions" style="padding: 10px; border-top: 1px solid var(--line); display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button class="btn btn-sm" data-assistant-cmd="new_task"><i data-lucide="plus-circle"></i> Nueva Tarea</button>
            <button class="btn btn-sm" data-assistant-cmd="new_note"><i data-lucide="file-plus"></i> Nueva Nota</button>
            <button class="btn btn-sm" data-assistant-cmd="go_to_calendar"><i data-lucide="calendar"></i> Ir a Calendario</button>
            <button class="btn btn-sm" data-assistant-cmd="help"><i data-lucide="help-circle"></i> Ayuda</button>
        </div>
        <div class="row chat-input-area" style="padding: 10px;">
            <textarea class="spacer" id="assistantChatMsg" placeholder="Escribe o usa el micrófono..." rows="1"></textarea>
            <button class="btn btn-ghost" id="assistantListenBtn"><i data-lucide="mic"></i></button>
            <button class="btn btn-primary" id="assistantSendMsg"><i data-lucide="send"></i></button>
        </div>
    </div>
</dialog>

<!-- TOUR ELEMENTS -->
<div id="tour-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index: 1000;"></div>
<div id="tour-tooltip" style="display:none; position:fixed; background:var(--surface); color:var(--text); padding:16px; border-radius:var(--radius); z-index:1001; max-width:300px; box-shadow:var(--shadow); transition: top .3s ease, left .3s ease;">
    <h4 id="tour-title" style="margin-top:0;"></h4>
    <p id="tour-text" class="sub"></p>
    <div class="row">
        <span id="tour-step"></span>
        <span class="spacer"></span>
        <button class="btn" id="tour-prev">Anterior</button>
        <button class="btn btn-primary" id="tour-next">Siguiente</button>
    </div>
</div>
<!-- TOAST NOTIFICATION -->
<div id="toast" class="info"></div>
<!-- FLOATING ASSISTANT BUBBLE -->
<div id="floating-assistant" class="assistant-pulse">
    <img src="https://goatify.com/assets/img/Logos%20HD.png" alt="Asistente IA">
</div>
</main>
<div id="menu-overlay"></div>
<script>
// ====== State ======
var S = {};
const initialState = {
  version:'9.2',
  userProfile: { 
      industry: null,
      isPro: false,
      nombre: 'Nuevo Usuario',
      rol: 'Explorador Digital',
      bio: '¡Configura tu perfil en el Hub Profesional!',
      avatar: null,
      socials: {linkedin:'', twitter:''}
  },
  projects: [],
  activeProject: null,
  activeNav: 'ai-global-chat',
  ui: {
      taskView: 'board',
      asideCollapsed: true,
      assistantMuted: false,
  },
  // Data is now nested under project ID and then folder name
  folders: {}, // folders[projId] = ['General', 'Marketing', 'Docs']
  tasks: {},   // tasks[projId][folderName] = [{...}]
  notes: {},   // notes[projId][folderName] = {list:[], ...}
  chats: {},   // chats[projId][folderName] = {threads:[], ...}
  tables: {},  // tables[projId][folderName] = {list:[], ...}
  files: {},   // files[projId][folderName] = [...]
  fin: {},     // fin[projId] = {rows:[]} - Finanzas son por proyecto, no por carpeta
  
  cronopost: { posts: {}, ideas: {} },
  hub: { 
    market:[],
    jobs:[],
    users: [ 
        {id: 'u_ana', nombre: 'Ana', rol: 'Diseñadora UX', online: true, avatar: null },
        {id: 'u_carlos', nombre: 'Carlos', rol: 'Copywriter', online: false, avatar: 'https://i.pravatar.cc/100?u=carlos'},
        {id: 'u_elena', nombre: 'Elena', rol: 'Project Manager', online: true, avatar: 'https://i.pravatar.cc/100?u=elena'},
    ]
  },
  gchat: { messages:{'general': []}, dms: {}, activeChat: 'general' },
  monet: {},
  mindset: { frequency: 'daily' },
  wallet: { movs: [] },
  intis: 0,
  aiGlobalChat: { threads: [{id:'c_global_1', title:'Chat General'}], messages: {'c_global_1':[]}, activeThread: 'c_global_1', model: 'pro' },
  credits: 100,
};
const CREDIT_COSTS = {
    action: 1, // Generic action cost
    aiChatPro: 1,
    aiChatWeb: 3,
    aiChatX: 5,
    aiIdeas: 5,
};
const EXPLAINERS = {
    overview: { title: 'Vista General del Proyecto', text: 'Aquí tienes un resumen del estado actual de tu proyecto. Accede rápidamente a las tareas pendientes, el balance financiero y los archivos recientes.' },
    tasks: { title: 'Gestión de Tareas', text: 'Organiza tu trabajo con tableros Kanban o listas. Arrastra y suelta tareas entre columnas para actualizar su estado. Haz clic en una tarea para ver todos sus detalles.' },
    calendar: { title: 'Calendario de Proyecto', text: 'Visualiza todas tus tareas con fecha de vencimiento en un solo lugar. Haz clic en un día para añadir una nueva tarea rápidamente.' },
    notes: { title: 'Notas y Lienzo', text: 'Toma notas, guarda ideas y dibuja en el lienzo. Todo se guarda automáticamente. Puedes incluso previsualizar código HTML directamente desde el editor.' },
    tables: { title: 'Tablas Flexibles', text: 'Crea tablas personalizadas para organizar cualquier tipo de información. Puedes añadir y pegar imágenes directamente en las celdas.' },
    files: { title: 'Archivos del Proyecto', text: 'Sube y gestiona todos los documentos, imágenes y recursos importantes para tu proyecto. Haz clic en un archivo para previsualizarlo.' },
    chat: { title: 'Chat IA del Proyecto', text: 'Colabora con la IA en el contexto de tu proyecto y carpeta actual. Las conversaciones son únicas para cada carpeta, manteniendo todo organizado.' },
    finance: { title: 'Finanzas del Proyecto', text: 'Lleva un registro de los ingresos y egresos específicos de este proyecto para mantener un control financiero detallado.' },
};

function save(){ 
    try {
        localStorage.setItem('goatify_v9_2', JSON.stringify(S)); 
        syncHeader();
    } catch(e) {
        console.error("Error saving to localStorage", e);
        showToast("Error: Los datos son demasiado grandes para guardar localmente.", "warn");
    }
}
function load(){
  const raw = localStorage.getItem('goatify_v9_2');
  S = raw ? JSON.parse(raw) : JSON.parse(JSON.stringify(initialState));
  // Data migration and validation for robustness
  if (!S.userProfile) S.userProfile = initialState.userProfile;
  if (!S.hub || !S.hub.users) S.hub = initialState.hub;
  if (!S.gchat) S.gchat = initialState.gchat;
  if (!S.wallet) S.wallet = { movs: [] };
  if (S.credits === undefined) S.credits = 100;
  S.projects.forEach(p => {
      if(!p.taskColumns) p.taskColumns = ['Backlog','En curso','Bloqueado','Hecho'];
      const id = p.id;
      if (!S.folders[id]) S.folders[id] = ['General'];
      S.folders[id].forEach(folderName => {
        if (!S.tasks[id]) S.tasks[id] = {};
        if (!S.tasks[id][folderName]) S.tasks[id][folderName] = [];
        if (!S.notes[id]) S.notes[id] = {};
        if (!S.notes[id][folderName]) S.notes[id][folderName] = {list:[], active:null, bodies:{}, drawings:{}};
        if (!S.chats[id]) S.chats[id] = {};
        if (!S.chats[id][folderName]) S.chats[id][folderName] = {threads:[], messages:{}, activeThread: null, model: 'pro'};
        if (!S.tables[id]) S.tables[id] = {};
        if (!S.tables[id][folderName]) S.tables[id][folderName] = {list:[{id: 'tbl_default', name: 'Tabla 1'}], active: 'tbl_default', data: {'tbl_default': {cols:['Col 1'], rows:[]}}};
        if (!S.files[id]) S.files[id] = {};
        if (!S.files[id][folderName]) S.files[id][folderName] = [];
      });
  });
  syncHeader();
  renderUserProfile();
  document.body.classList.toggle('aside-collapsed', S.ui.asideCollapsed);
}
function syncHeader(){
  const walletBalance = (S.wallet.movs || []).reduce((acc, mov) => acc + (mov.tipo === 'Ingreso' ? mov.monto : -mov.monto), 0);
  $('#wallet-amount').textContent = `$${walletBalance.toFixed(2)}`;
  $('#intis-amount').textContent = S.intis;
}
function useCredits(amount) {
    if (S.userProfile.isPro) return true;
    if (S.credits < amount) {
        showToast("Créditos insuficientes. ¡Actualiza a PREMIUM!", "warn");
        $('#premiumModal').showModal();
        return false;
    }
    S.credits -= amount;
    showToast(`-${amount} créditos usados. Restantes: ${S.credits}`, 'info');
    save();
    return true;
}
function addIntis(points, reason) {
    S.intis += points;
    save();
    showToast(`+${points} Intis ✨ (${reason})`, 'info');
}

// ====== Helpers ======
const $ = sel=>document.querySelector(sel);
const $$ = sel=>Array.from(document.querySelectorAll(sel));
function el(tag, attrs={}, ...kids){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='dataset'){ Object.entries(v).forEach(([dk,dv])=>e.dataset[dk]=dv); }
    else if(k==='html'){ e.innerHTML = v; }
    else if(k==='textContent'){ e.textContent = v; }
    else if(k.startsWith('on')) { e[k] = v; }
    else e.setAttribute(k,v);
  });
  kids.forEach(k=>{ if(k) e.append(k); });
  return e;
}
function fmtDate(d, type = 'datetime'){ 
    const dt = new Date(d); 
    if (type === 'date') return dt.toISOString().split('T')[0];
    return dt.toLocaleString('es-EC'); 
}
function csv(rows){ return rows.map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n'); }
function download(filename, text){
  const a = el('a',{href:URL.createObjectURL(new Blob([text],{type:'text/plain'})), download:filename});
  document.body.appendChild(a); a.click(); a.remove();
}
let toastTimeout;
function showToast(message, type = 'info') {
    const toast = $('#toast');
    if (!toast) return;
    toast.textContent = message;
    toast.className = '';
    toast.classList.add(type, 'show');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 3000);
}
function showInputModal(title, description, placeholder, callback, initialValue = '') {
    $('#inputModalTitle').textContent = title;
    $('#inputModalDesc').textContent = description;
    const input = $('#inputModalInput');
    input.placeholder = placeholder;
    input.value = initialValue;
    $('#inputModal').showModal();
    input.focus();
    $('#inputModalConfirm').onclick = () => {
        const value = input.value.trim();
        if (value) {
            callback(value);
            $('#inputModal').close();
        } else {
            showToast('Por favor, ingresa un valor.', 'warn');
        }
    };
    $('#inputModalCancel').onclick = () => $('#inputModal').close();
}
// MEJORA: Función para decodificar entidades HTML
function unescapeHtml(html) {
    const temp = document.createElement("textarea");
    temp.innerHTML = html;
    return temp.value;
}


// ====== UI: Navigation & Core ======
function renderUserProfile() {
    const P = S.userProfile;
    const container = $('#user-profile-sidebar');
    container.innerHTML = '';
    
    let avatarEl;
    if (P.avatar) {
        avatarEl = el('img', { src: P.avatar, class: 'user-avatar' });
    } else {
        const initial = (P.nombre.charAt(0) || 'U').toUpperCase();
        avatarEl = el('div', { class: 'user-avatar', textContent: initial });
    }

    const profile = el('div', { class: 'user-profile-snippet', title: 'Ir al Hub Profesional' },
        avatarEl,
        el('div', { class: 'user-info' },
            el('span', { class: 'user-name', textContent: P.nombre }),
            el('span', { class: 'user-role', textContent: P.rol })
        )
    );
    profile.onclick = () => show('hub');
    container.append(profile);
}
function renderAside(){
  const list = $('#projList'); list.innerHTML='';
  S.projects.forEach(p=>{
    const item = el('div',{class:'projItem', dataset: {id: p.id}, onclick: ()=> openProject(p.id)},
        el('div', {class:'proj-color-dot', style:`background-color:${p.color}`}),
        el('span',{textContent:p.name, style:'flex:1'}),
    );
    if (p.id === S.activeProject) item.classList.add('active');
    list.appendChild(item);
  });
  $$('.navBtn[data-nav]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.nav === S.activeNav && !S.activeProject);
  });
}
function show(sectionId){
  $$('main > section').forEach(s => s.style.display = 'none');
  const s = $('#'+sectionId);  
  if(s) s.style.display='block';
  S.activeProject = null;
  S.activeNav = sectionId;
  save();
  renderAside();
  document.body.classList.remove('aside-open');
  
  switch(sectionId) {
    case 'ai-global-chat': renderGlobalAIChat(); break;
    case 'cronopost': renderCronoPOST(); break;
    case 'hub': renderHub(); break;
    case 'gchat': renderGChat(); break;
    case 'monet': renderMonetAssistant(); break;
    case 'mindset': setupMindset(); break;
  }
}
function openProject(id){
  S.activeProject = id;
  S.activeNav = null;
  S.ui.taskView = 'board';
  save();
  $$('main > section').forEach(s => s.style.display = 'none');
  $('#projectShell').style.display='block';
  const p = S.projects.find(x=>x.id===id);
  $('#projectNameChip').textContent = p?.name || 'Proyecto';
  $('#projectNameChip').style.borderLeft = `3px solid ${p?.color || 'var(--brand)'}`;

  renderFolderSelector();

  renderAside();
  renderProject();
  $('#projectShell .tabs .tab[data-ptab="overview"]')?.click();
  document.body.classList.remove('aside-open');
}
function renderFolderSelector() {
    const id = S.activeProject;
    const folderSel = $('#folderSel');
    folderSel.innerHTML = '';
    const currentFolders = S.folders[id] || ['General'];
    currentFolders.forEach(f => folderSel.append(el('option', {textContent: f})));
}
function renderProject() {
    const currentTab = $('#project-tabs .tab.active')?.dataset.ptab || 'overview';
    switch (currentTab) {
        case 'overview': renderOverview(); break;
        case 'tasks': renderTasks(); break;
        case 'calendar': renderCalendar(); break;
        case 'notes': renderNotes(); break;
        case 'tables': renderTables(); break;
        case 'files': renderFiles(); break;
        case 'chat': renderProjectChat(); break;
        case 'finance': renderFin(); break;
    }
    setExplainer(currentTab);
}
function setExplainer(tab) {
    const data = EXPLAINERS[tab];
    if (data) {
        $(`#${tab}-explainer-title`).textContent = data.title;
        $(`#${tab}-explainer-text`).textContent = data.text;
    }
}
// ====== Projects CRUD ======
function createNewProject() {
    if (!useCredits(CREDIT_COSTS.action * 5)) return; // Cost for creating a project
    showInputModal('Crear Nuevo Proyecto', 'Dale un nombre a tu nuevo espacio de trabajo.', 'Ej: Lanzamiento App Móvil', (name) => {
        const id = 'p' + Date.now();
        const color = `hsl(${Math.random() * 360}, 70%, 60%)`;
        S.projects.push({id, name, color, taskColumns: ['Backlog','En curso','Bloqueado','Hecho']});
        
        // Initialize all data structures for the new project
        const initialFolder = 'General';
        S.folders[id] = [initialFolder];
        S.tasks[id] = { [initialFolder]: [] };
        S.notes[id] = { [initialFolder]: {list:[], active:null, bodies:{}, drawings:{}} };
        S.chats[id] = { [initialFolder]: {threads:[], messages:{}, activeThread: null, model: 'pro'}};
        S.tables[id] = { [initialFolder]: {list:[{id: 'tbl_default', name: 'Tabla 1'}], active: 'tbl_default', data: {'tbl_default': {cols:['Col 1'], rows:[]}}} };
        S.files[id] = { [initialFolder]: [] };
        S.fin[id] = {rows:[]};
        S.cronopost.posts[id] = {}; 
        S.cronopost.ideas[id] = [];

        addIntis(50, 'Proyecto nuevo');
        showToast('Proyecto creado!', 'success');
        save();  
        renderAside();  
        openProject(id);
    });
}
function getCurrentFolder() {
    return $('#folderSel')?.value || 'General';
}

// ====== PROJECT SUB-MODULES ======
let calRef=new Date();

function renderOverview(){
    const id = S.activeProject; if(!id) return;
    const wrap = $('#ovr'); wrap.innerHTML = '';
    const p = S.projects.find(x => x.id === id);
    let allTasks = [];
    Object.values(S.tasks[id] || {}).forEach(folderTasks => allTasks.push(...folderTasks));
    const finance = S.fin[id] || {rows:[]};
    let allNotes = [];
    Object.values(S.notes[id] || {}).forEach(folderNotes => allNotes.push(...folderNotes.list));
    let allFiles = [];
    Object.values(S.files[id] || {}).forEach(folderFiles => allFiles.push(...folderFiles));

    const createStatCard = (title, value, icon, color, tab) => {
        const card = el('div', { class: 'stat-card', style: `border-left: 4px solid ${color}` },
            el('div', { style: 'display:flex; align-items:center; gap:12px;' },
                el('div', { style: `padding:10px; border-radius:50%; background:color-mix(in hsl, ${color} 15%, transparent); color:${color}`}, el('i', {'data-lucide': icon})),
                el('div', {},
                    el('h4', { textContent: title, style:'margin:0; font-size:var(--sm)' }),
                    el('p', { textContent: value, style:'margin:0; font-size:var(--lg)' })
                )
            )
        );
        card.onclick = () => $(`#project-tabs .tab[data-ptab="${tab}"]`).click();
        return card;
    };

    const doneColName = p.taskColumns[p.taskColumns.length - 1] || 'Hecho';
    const done = allTasks.filter(x => x.status === doneColName).length;
    const totalTasks = allTasks.length;
    const progress = totalTasks > 0 ? Math.round(done / totalTasks * 100) : 0;
    const sumIn = finance.rows.reduce((a, b) => a + (b.tipo === 'Ingreso' ? Number(b.monto) : 0), 0);
    const sumOut = finance.rows.reduce((a, b) => a + (b.tipo === 'Egreso' ? Number(b.monto) : 0), 0);

    wrap.append(createStatCard('Progreso de Tareas', `${progress}%`, 'check-circle', 'var(--brand)', 'tasks'));
    wrap.append(createStatCard('Tareas Pendientes', `${totalTasks - done}`, 'list-todo', 'var(--warn)', 'tasks'));
    wrap.append(createStatCard('Balance Neto', `$${(sumIn - sumOut).toFixed(2)}`, 'scale', 'var(--success)', 'finance'));
    wrap.append(createStatCard('Archivos y Notas', `${allFiles.length + allNotes.length}`, 'file-text', 'var(--files)'));

    lucide.createIcons();
}
// --- TASKS (Kanban & List) ---
function renderTasks(){
    const view = S.ui.taskView;
    const isBoardView = view === 'board';
    $('#kanban-view').style.display = isBoardView ? 'block' : 'none';
    $('#list-view').style.display = isBoardView ? 'none' : 'block';
    $('#addColumnBtn').style.display = isBoardView ? 'inline-flex' : 'none';
    $('#viewToggleBoard').classList.toggle('active', isBoardView);
    $('#viewToggleList').classList.toggle('active', !isBoardView);
    if (isBoardView) renderTaskBoard();
    else renderTaskList();
}
function renderTaskBoard(){
  const id=S.activeProject; if(!id) return;
  const folder = getCurrentFolder();
  const p = S.projects.find(x => x.id === id);
  const tasks=S.tasks[id][folder]||[];
  const cols = p.taskColumns || [];
  const board=$('#kanban'); board.innerHTML='';
  cols.forEach((c, index) => {
    const colEl=el('div',{class:'col',dataset:{status:c}},
      el('div',{class:'row', style:'padding:8px; align-items:center;'}, 
          el('b',{textContent:c, style: 'flex: 1; white-space: normal; overflow: hidden; text-overflow: ellipsis;', title: c}), 
          el('span', {class:'chip', textContent: tasks.filter(t=>t.status===c).length}),
          el('div', { class: 'proj-actions', style: 'display: flex;' },
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { e.stopPropagation(); renameColumn(index); }, title: 'Renombrar' }, el('i', { 'data-lucide': 'edit-3', width: 14 })),
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { e.stopPropagation(); deleteColumn(index); }, title: 'Eliminar' }, el('i', { 'data-lucide': 'trash-2', width: 14 }))
          )
      )
    );
    tasks.filter(t=>t.status===c).forEach(t=>{
      const taskEl=el('div',{class:'task',draggable:'true', dataset: {id:t.id}, onclick: ()=>openTaskModal(t.id), style:'border-left: 3px solid ' + (p.color || 'var(--brand)')},
        el('div',{ textContent:t.title })
      );
      taskEl.ondragstart=e=>{ e.stopPropagation(); e.dataTransfer.setData('text/plain',t.id); };
      colEl.appendChild(taskEl);
    });
    colEl.ondragover=e=>{e.preventDefault(); colEl.classList.add('dragover');};
    colEl.ondragleave=()=>colEl.classList.remove('dragover');
    colEl.ondrop=e=>{
      colEl.classList.remove('dragover');
      const tid=e.dataTransfer.getData('text'); 
      const t=tasks.find(x=>x.id===tid);
      const doneColName = p.taskColumns[p.taskColumns.length - 1];
      if (t) { 
        if(t.status !== doneColName && c === doneColName) addIntis(10, 'Tarea completada');
        t.status=c; 
        save(); renderTasks(); renderOverview();
      }
    };
    board.appendChild(colEl);
  });
  lucide.createIcons();
}
function addColumn() {
    const id = S.activeProject; if (!id) return;
    const p = S.projects.find(x => x.id === id);
    showInputModal('Nueva Columna', 'Nombre para la nueva columna de tareas:', 'Ej: Revisión', name => {
        if (!p.taskColumns) p.taskColumns = [];
        p.taskColumns.push(name);
        save();
        renderTaskBoard();
    });
}
function renameColumn(index) {
    const id = S.activeProject; if (!id) return;
    const p = S.projects.find(x => x.id === id);
    const oldName = p.taskColumns[index];
    showInputModal('Renombrar Columna', `Nuevo nombre para "${oldName}":`, oldName, newName => {
        Object.values(S.tasks[id]).forEach(folderTasks => {
            folderTasks.forEach(t => { if (t.status === oldName) t.status = newName; });
        });
        p.taskColumns[index] = newName;
        save();
        renderTasks();
    }, oldName);
}
function deleteColumn(index) {
    const id = S.activeProject; if (!id) return;
    const p = S.projects.find(x => x.id === id);
    const colName = p.taskColumns[index];
    const isColumnInUse = Object.values(S.tasks[id]).some(folderTasks => folderTasks.some(t => t.status === colName));
    if (isColumnInUse) {
        showToast('No se puede eliminar una columna que contiene tareas.', 'warn');
        return;
    }
    if (confirm(`¿Seguro que quieres eliminar la columna "${colName}"?`)) {
        p.taskColumns.splice(index, 1);
        save();
        renderTaskBoard();
    }
}
function renderTaskList() {
    const id = S.activeProject; if (!id) return;
    const folder = getCurrentFolder();
    const tasks = S.tasks[id][folder] || [];
    const tbody = $('#task-list-table tbody');
    tbody.innerHTML = '';
    tasks.forEach(t => {
        const tr = el('tr', { onclick: () => openTaskModal(t.id) },
            el('td', { 'data-label': 'Tarea', textContent: t.title }),
            el('td', { 'data-label': 'Estado' }, el('span', { class: 'status-badge', style: `background: color-mix(in hsl, ${getTaskStatusColor(t.status)} 20%, transparent); color: ${getTaskStatusColor(t.status)};`, textContent: t.status })),
            el('td', { 'data-label': 'Fecha', textContent: t.due ? new Date(t.due).toLocaleDateString() : 'N/A' }),
            el('td', {}, el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { e.stopPropagation(); deleteTask(t.id); } }, el('i', { 'data-lucide': 'trash-2', width: 14 })))
        );
        tbody.append(tr);
    });
    lucide.createIcons();
}
function getTaskStatusColor(status) {
    if (status.toLowerCase().includes('hecho') || status.toLowerCase().includes('done')) return 'var(--success)';
    if (status.toLowerCase().includes('curso') || status.toLowerCase().includes('progress')) return 'var(--info)';
    if (status.toLowerCase().includes('bloqueado') || status.toLowerCase().includes('blocked')) return 'var(--danger)';
    return 'var(--sub)';
}
function quickAddTask() {
    const id=S.activeProject; if(!id) return;
    if (!useCredits(CREDIT_COSTS.action)) return;
    const folder = getCurrentFolder();
    const p = S.projects.find(x => x.id === id);
    const firstColumn = p.taskColumns[0] || 'Backlog';
    showInputModal('Nueva Tarea', `Añadir tarea a: ${folder}`, 'Describe la tarea...', (title) => {
        S.tasks[id][folder].push({id:'t'+Date.now(), title, status:firstColumn, desc:'', due:''});
        addIntis(5, 'Tarea creada');
        save(); renderTasks(); renderOverview();
    });
}
function openTaskModal(taskId) {
    const id = S.activeProject;
    const folder = getCurrentFolder();
    const p = S.projects.find(x => x.id === id);
    const task = S.tasks[id][folder].find(t => t.id === taskId);
    if (!task) return;
    $('#taskDetailId').value = task.id;
    $('#taskDetailTitle').value = task.title;
    $('#taskDetailDesc').value = task.desc || '';
    $('#taskDetailDue').value = task.due || '';
    const statusSel = $('#taskDetailStatus');
    statusSel.innerHTML = '';
    p.taskColumns.forEach(s => {
        statusSel.append(el('option', { value: s, textContent: s }));
    });
    statusSel.value = task.status;
    $('#taskDetailModal').showModal();
    lucide.createIcons();
}
function saveTaskDetails() {
    const id = S.activeProject;
    const folder = getCurrentFolder();
    const p = S.projects.find(x => x.id === id);
    const taskId = $('#taskDetailId').value;
    const task = S.tasks[id][folder].find(t => t.id === taskId);
    if (!task) return;
    const oldStatus = task.status;
    const newStatus = $('#taskDetailStatus').value;
    const doneColName = p.taskColumns[p.taskColumns.length - 1];

    task.title = $('#taskDetailTitle').value;
    task.desc = $('#taskDetailDesc').value;
    task.due = $('#taskDetailDue').value;
    task.status = newStatus;
    if (oldStatus !== doneColName && newStatus === doneColName) {
        addIntis(10, 'Tarea completada');
    }
    save();
    renderTasks();
    renderOverview();
    renderCalendar();
    renderCronoPOST();
    $('#taskDetailModal').close();
}
function deleteTask(taskId) {
    if (!confirm('¿Eliminar esta tarea?')) return;
    const id = S.activeProject;
    const folder = getCurrentFolder();
    S.tasks[id][folder] = S.tasks[id][folder].filter(t => t.id !== taskId);
    save(); renderTasks(); renderOverview(); renderCalendar(); renderCronoPOST();
    $('#taskDetailModal').close();
}
// --- CALENDAR ---
function renderCalendar(){
  const id=S.activeProject; if(!id) return;
  const folder = getCurrentFolder();
  $('#monthLbl').textContent = calRef.toLocaleString('es', {month:'long', year:'numeric'});
  const grid=$('#calGrid'); grid.innerHTML='';
  const monthGrid = (ref=new Date()) => {
      const y=ref.getFullYear(), m=ref.getMonth();
      const first=new Date(y,m,1);
      const start = new Date(first); start.setDate(1-((first.getDay()+6)%7));
      const days=[]; let cur=new Date(start);
      while(days.length < 42){ days.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
      return days;
  }
  const projColor = S.projects.find(p=>p.id===id)?.color || 'var(--brand)';
  const tasks = S.tasks[id][folder]||[];
  monthGrid(calRef).forEach(d=>{
    const day=el('div',{class:'day'});
    if(d.getMonth() !== calRef.getMonth()) day.style.opacity = .4;
    day.append(el('div',{class:'sub', textContent:d.getDate()}));
    day.onclick = () => createTaskOnDate(d);
    tasks.filter(t => t.due && new Date(t.due).toDateString() === d.toDateString()).forEach(t => {
        const taskEl = el('div', { class: 'cal-task', textContent: t.title, style: `border-left-color: ${projColor}` });
        taskEl.onclick = (e) => { e.stopPropagation(); openTaskModal(t.id); };
        day.append(taskEl);
    });
    grid.append(day);
  });
}
function createTaskOnDate(date) {
    const id = S.activeProject; if (!id) return;
    if (!useCredits(CREDIT_COSTS.action)) return;
    const folder = getCurrentFolder();
    const p = S.projects.find(x => x.id === id);
    const firstColumn = p.taskColumns[0] || 'Backlog';
    showInputModal('Nueva Tarea', `Crear tarea para ${date.toLocaleDateString()} en ${folder}`, 'Describe la tarea...', (title) => {
        const newTask = { id: 't' + Date.now(), title, status: firstColumn, desc: '', due: date.toISOString().split('T')[0] };
        S.tasks[id][folder].push(newTask);
        addIntis(5, 'Tarea creada');
        save();
        renderTasks(); renderCalendar(); renderOverview();
    });
}
// --- NOTES & DRAWING ---
let canvasUndoStack = [];
let canvasRedoStack = [];
function renderNotes(){
    const id=S.activeProject; if(!id) return;
    const folder = getCurrentFolder();
    const N=S.notes[id][folder];
    const list=$('#noteList'); list.innerHTML='';
    N.list.forEach(n=>{
        const item = el('div',{class:'projItem', onclick:()=>{N.active=n.id; save(); renderNotes();}},
            el('span', {textContent: n.title}),
            el('span', {class: 'spacer'}),
            el('button', {class: 'btn btn-ghost btn-sm', onclick: e => {e.stopPropagation(); deleteNote(n.id)}}, el('i', {'data-lucide': 'trash-2', width: 14}))
        );
        if(n.id===N.active) item.classList.add('active');
        list.append(item);
    });
    if(!N.active && N.list.length > 0) N.active=N.list[0].id;
    const editor = $('#noteEditor');
    editor.innerHTML = (N.active? (N.bodies[N.active]||'') : 'Selecciona o crea una nota para empezar.');
    initDrawingCanvas(N.active);
    lucide.createIcons();
}
function createNewNote() {
    const id=S.activeProject; if(!id) return; 
    if (!useCredits(CREDIT_COSTS.action)) return;
    const folder = getCurrentFolder();
    showInputModal('Nueva Nota', `Título de la nueva nota en ${folder}:`, 'Ej: Ideas para reunión', (t) => {
        const nid='n'+Date.now(); 
        S.notes[id][folder].list.push({id:nid,title:t}); 
        S.notes[id][folder].active=nid; 
        S.notes[id][folder].bodies[nid]=''; 
        S.notes[id][folder].drawings[nid]=null;
        addIntis(5, 'Nota creada');
        save(); 
        renderNotes();
    });
}
function deleteNote(noteId) {
    if (!confirm("¿Eliminar esta nota y su dibujo asociado?")) return;
    const id = S.activeProject;
    const folder = getCurrentFolder();
    const N = S.notes[id][folder];
    N.list = N.list.filter(n => n.id !== noteId);
    delete N.bodies[noteId];
    delete N.drawings[noteId];
    if (N.active === noteId) {
        N.active = N.list.length > 0 ? N.list[0].id : null;
    }
    save();
    renderNotes();
}
function initDrawingCanvas(noteId) {
    const canvas = $('#drawingCanvas'); const ctx = canvas.getContext('2d');
    canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight;
    let drawing = false;
    canvasUndoStack = []; canvasRedoStack = [];

    const saveCanvasState = () => {
        canvasRedoStack = [];
        canvasUndoStack.push(canvas.toDataURL());
        if(canvasUndoStack.length > 20) canvasUndoStack.shift(); // Limit history
    };
    
    const redrawCanvas = (dataUrl) => {
        const img = new Image();
        img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); };
        img.src = dataUrl;
    };

    if (noteId && S.notes[S.activeProject][getCurrentFolder()].drawings[noteId]) {
        redrawCanvas(S.notes[S.activeProject][getCurrentFolder()].drawings[noteId]);
        canvasUndoStack.push(S.notes[S.activeProject][getCurrentFolder()].drawings[noteId]);
    } else {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        saveCanvasState();
    }

    const getCoords = e => {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const y = (e.clientY || e.touches[0].clientY) - rect.top;
        return {x, y};
    };
    const start = e => { e.preventDefault(); drawing = true; const {x,y} = getCoords(e); ctx.beginPath(); ctx.moveTo(x,y); };
    const end = () => { if (!drawing) return; drawing = false; ctx.beginPath(); saveCanvasState(); S.notes[S.activeProject][getCurrentFolder()].drawings[noteId] = canvas.toDataURL(); save(); };
    const draw = e => { if (!drawing) return; e.preventDefault(); const {x,y} = getCoords(e); ctx.lineWidth = $('#canvasStrokeSlider').value; ctx.lineCap = 'round'; ctx.strokeStyle = $('#canvasColorPicker').value; ctx.lineTo(x,y); ctx.stroke(); };
    
    canvas.onmousedown = start; canvas.onmouseup = end; canvas.onmousemove = draw;
    canvas.ontouchstart = start; canvas.ontouchend = end; canvas.ontouchmove = draw;
}
function undoCanvas() {
    if (canvasUndoStack.length < 2) return;
    canvasRedoStack.push(canvasUndoStack.pop());
    const prevState = canvasUndoStack[canvasUndoStack.length - 1];
    const canvas = $('#drawingCanvas'); const ctx = canvas.getContext('2d');
    const img = new Image();
    img.onload = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img, 0, 0); };
    img.src = prevState;
    const id = S.activeProject, folder = getCurrentFolder(), noteId = S.notes[id][folder].active;
    S.notes[id][folder].drawings[noteId] = prevState; save();
}
function redoCanvas() {
    if (canvasRedoStack.length === 0) return;
    const nextState = canvasRedoStack.pop();
    canvasUndoStack.push(nextState);
    const canvas = $('#drawingCanvas'); const ctx = canvas.getContext('2d');
    const img = new Image();
    img.onload = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img, 0, 0); };
    img.src = nextState;
    const id = S.activeProject, folder = getCurrentFolder(), noteId = S.notes[id][folder].active;
    S.notes[id][folder].drawings[noteId] = nextState; save();
}
function exportNote(format) {
    const id = S.activeProject; const folder = getCurrentFolder(); const N = S.notes[id][folder];
    if (!N.active) return showToast("Selecciona una nota para exportar.", "warn");
    const title = N.list.find(n => n.id === N.active)?.title || "Nota";
    if (format === 'pdf') {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        const editorContent = el('div', { html: N.bodies[N.active] });
        const canvas = $('#drawingCanvas');
        
        doc.text(title, 10, 10);
        doc.html(editorContent, {
            callback: (doc) => {
                html2canvas(canvas).then(canvasImg => {
                    const imgData = canvasImg.toDataURL('image/png');
                    doc.addPage();
                    doc.text("Lienzo:", 10, 10);
                    doc.addImage(imgData, 'PNG', 10, 20, 180, 120);
                    doc.save(`${title}.pdf`);
                });
            },
            x: 10, y: 20, width: 180, windowWidth: 800
        });
    }
}
// --- TABLES, FILES, FINANCE ---
function renderTables(){
  const id=S.activeProject; if(!id) return;
  const folder = getCurrentFolder();
  const T_PROJ = S.tables[id][folder];
  const selector = $('#tableSelector');
  selector.innerHTML = '';
  T_PROJ.list.forEach(t => selector.append(el('option',{value:t.id, textContent:t.name})));
  selector.value = T_PROJ.active;

  const wrap=$('#sheetWrap'); wrap.innerHTML='';
  const T_DATA = T_PROJ.data[T_PROJ.active];

  if (!T_DATA || !T_DATA.cols || T_DATA.cols.length === 0) {
      wrap.innerHTML = `<div class="empty-state"><i data-lucide="table-2" width="48" height="48"></i><h4>Tabla vacía.</h4><p>Añade columnas y filas para empezar.</p></div>`;
      lucide.createIcons(); return;
  }
  const tbl=el('table',{style:'width:100%; border-collapse: collapse; table-layout: fixed;'});
  const thead=el('thead',{}, el('tr',{}, ...T_DATA.cols.map(c=>el('th',{textContent:c, style:'border: 1px solid var(--line); padding: 8px;'}))));
  const tbody=el('tbody',{});
  (T_DATA.rows || []).forEach((r,ri)=>{
    const tr=el('tr',{}, ...T_DATA.cols.map((c,ci)=> {
        const cellContent = r[ci] || '';
        const td = el('td',{style:'border: 1px solid var(--line); padding: 0; position: relative;'});
        if (cellContent.startsWith('data:image')) {
            const img = el('img', { src: cellContent, class: 'table-image-thumb' });
            img.onclick = () => { $('#imagePreviewSrc').src = cellContent; $('#imagePreviewModal').showModal(); };
            td.append(img);
        } else {
            const input = el('input',{value:cellContent, style:'border:none; background:transparent; padding: 8px; width: 100%; height: 100%;'});
            input.onchange=(e)=>{r[ci]=e.target.value; save();};
            td.append(input);
        }
        td.onpaste = e => handleTableCellPaste(e, ri, ci);
        return td;
    }));
    tbody.appendChild(tr);
  });
  tbl.append(thead,tbody);
  wrap.append(tbl);
}
function handleTableCellPaste(e, rowIndex, colIndex) {
    const items = e.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf("image") !== -1) {
            e.preventDefault();
            const blob = items[i].getAsFile();
            const reader = new FileReader();
            reader.onload = (event) => {
                const id = S.activeProject, folder = getCurrentFolder();
                const T_DATA = S.tables[id][folder].data[S.tables[id][folder].active];
                T_DATA.rows[rowIndex][colIndex] = event.target.result;
                save(); renderTables();
            };
            reader.readAsDataURL(blob);
            return;
        }
    }
}
function createNewTable() {
    const id = S.activeProject; if (!id) return;
    if (!useCredits(CREDIT_COSTS.action)) return;
    const folder = getCurrentFolder();
    showInputModal('Nueva Tabla', `Nombre de la nueva tabla en ${folder}:`, `Tabla ${S.tables[id][folder].list.length + 1}`, (name) => {
        const tableId = 'tbl_' + Date.now();
        S.tables[id][folder].list.push({ id: tableId, name: name });
        S.tables[id][folder].data[tableId] = { cols: ['Nueva Columna'], rows: [['']] };
        S.tables[id][folder].active = tableId;
        addIntis(5, 'Tabla creada');
        save(); renderTables();
    });
}
function renderFiles(){
  const id=S.activeProject; if(!id) return;
  const folder = getCurrentFolder();
  const L=S.files[id][folder]||[]; const wrap=$('#fileList'); wrap.innerHTML='';
  if (L.length === 0) {
      wrap.innerHTML = `<div class="empty-state" style="width:100%"><i data-lucide="file-up" width="48" height="48"></i><h4>No hay archivos.</h4><p>Sube documentos, imágenes, etc.</p></div>`;
      lucide.createIcons(); return;
  }
  L.forEach((f,idx)=>{
      const fileChip = el('div', {class:'chip'},  
        el('a',{href:f.url,download:f.name, textContent:f.name}),
        el('button', {class: 'btn btn-ghost btn-sm', onclick:()=>{ L.splice(idx,1); save(); renderFiles(); renderOverview(); }}, el('i', {'data-lucide':'trash-2', width:14}))
      );
      wrap.append(fileChip);
  });
  lucide.createIcons();
}
function renderFin(){
  const id=S.activeProject; if(!id) return;
  const F=S.fin[id]; const tbody=$('#finTable tbody'); tbody.innerHTML='';
  (F.rows || []).forEach((r,i)=>{
    const tr=el('tr',{}, 
        el('td',{'data-label': 'Fecha', textContent:fmtDate(r.fecha)}), 
        el('td',{'data-label': 'Tipo', textContent:r.tipo}), 
        el('td',{'data-label': 'Monto', textContent:'$'+Number(r.monto).toFixed(2), style:'text-align:right'}), 
        el('td',{'data-label': 'Categoría', textContent:r.cat}), 
        el('td',{'data-label': 'Nota', textContent:r.nota}),
        el('td',{}, el('button',{class:'btn btn-ghost btn-sm',onclick:()=>{F.rows.splice(i,1); save(); renderFin(); renderOverview();}}, el('i',{'data-lucide':'trash-2', width:14})))
    );
    tbody.appendChild(tr);
  });
  const sumIn=F.rows.reduce((a,b)=>a+(b.tipo==='Ingreso' ? Number(b.monto) : 0),0);
  const sumOut=F.rows.reduce((a,b)=>a+(b.tipo==='Egreso' ? Number(b.monto) : 0),0);
  $('#finIn').textContent='$'+sumIn.toFixed(2);
  $('#finOut').textContent='$'+sumOut.toFixed(2);
  $('#finBal').textContent='$'+(sumIn-sumOut).toFixed(2);
  lucide.createIcons();
}
// --- CHAT IA (Project) ---
function renderProjectChat() {
    const pid = S.activeProject; if (!pid) return;
    const folder = getCurrentFolder();
    const C = S.chats[pid][folder];
    const list = $('#chatList'); list.innerHTML = '';
    (C.threads || []).forEach(th => {
        const it = el('div', { class: 'projItem', dataset: { id: th.id }, textContent: th.title, onclick: () => { C.activeThread = th.id; save(); renderProjectChat(); } });
        if (th.id === C.activeThread) it.classList.add('active');
        list.append(it);
    });
    if (!C.activeThread && C.threads?.length > 0) { C.activeThread = C.threads[0].id; save(); }
    $$('#p-tab-chat .model-card').forEach(c => c.classList.toggle('active', C.model === c.dataset.model));
    const log = $('#chatLog'); log.innerHTML = '';
    if (C.activeThread) {
        (C.messages[C.activeThread] || []).forEach(m => log.append(createMessageElement(m, S.userProfile)));
        log.scrollTop = log.scrollHeight;
    }
}
function sendProjectChatMessage() {
    const pid = S.activeProject; 
    const folder = getCurrentFolder();
    if (!pid || !S.chats[pid][folder].activeThread) return;
    const msgInput = $('#chatMsg');
    const msg = msgInput.value.trim(); if (!msg) return;
    const C = S.chats[pid][folder];
    const model = C.model;
    let cost = CREDIT_COSTS.aiChatPro;
    if(model === 'web') cost = CREDIT_COSTS.aiChatWeb;
    if(model === 'x') cost = CREDIT_COSTS.aiChatX;
    if (!useCredits(cost)) return;
    
    const threadId = C.activeThread;
    if (!C.messages[threadId]) C.messages[threadId] = [];
    C.messages[threadId].push({ who: 'Tú', at: new Date(), text: msg });
    msgInput.value = ''; msgInput.style.height = 'auto'; renderProjectChat();

    setTimeout(() => {
        let responseText = `Como modelo de IA, mi sugerencia para "${msg}" sería dividirlo en tareas más pequeñas.`;
        if (model === 'web') responseText = `[Búsqueda Web] Para "${msg}", los resultados sugieren enfocarse en marketing de contenidos.`;
        if (model === 'x') responseText = `[Modelo Avanzado X] Analizando "${msg}" con mayor profundidad, he identificado tres estrategias clave que podemos implementar de inmediato.`;
        if (msg.toLowerCase().includes('genera un botón html')) {
            responseText = `Claro, aquí tienes un botón HTML con estilos: [CODE]<!DOCTYPE html>
<html>
<head>
<style>
.myButton {
  box-shadow: inset 0px 1px 0px 0px #a4e271;
  background:linear-gradient(to bottom, #89c403 5%, #77a809 100%);
  border:1px solid #74b807;
  display:inline-block;
  cursor:pointer;
  color:#ffffff;
  font-family:Arial;
  font-size:15px;
  font-weight:bold;
  padding:6px 24px;
  text-decoration:none;
  text-shadow:0px 1px 0px #528009;
}
.myButton:hover {
  background:linear-gradient(to bottom, #77a809 5%, #89c403 100%);
}
</style>
</head>
<body>

<button class="myButton">Botón Verde</button>

</body>
</html>
[/CODE]`;
        }
        C.messages[threadId].push({ who: 'IA', at: new Date(), text: responseText, type: model });
        save(); renderProjectChat();
    }, 1500);
}

// ====== GLOBAL MODULES ======
// --- GLOBAL AI CHAT ---
const aiPrompts = [
    { title: 'Dame ideas de posts', prompt: 'Dame 5 ideas de posts para redes sociales sobre productividad para emprendedores' },
    { title: 'Crea una imagen', prompt: 'Crea una imagen de un astronauta meditando en marte, estilo acuarela' },
    { title: 'Resume un texto', prompt: 'Resume el siguiente texto en 3 puntos clave: [pega tu texto aquí]' },
    { title: 'Escribe un email', prompt: 'Escribe un email corto para un cliente potencial presentando mis servicios de desarrollo web' },
]
function renderGlobalAIChat() {
    const C = S.aiGlobalChat;
    const list = $('#aiChatList'); list.innerHTML = '';
    C.threads.forEach(th => {
        const actions = el('div', { class: 'proj-actions' },
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { e.stopPropagation(); renameAIChat(th.id); }, title: 'Renombrar' }, el('i', { 'data-lucide': 'edit-3', width: 14 })),
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { e.stopPropagation(); showSendToProjectModal(th.id); }, title: 'Enviar a proyecto' }, el('i', { 'data-lucide': 'send', width: 14 })),
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { e.stopPropagation(); deleteAIChat(th.id); }, title: 'Eliminar' }, el('i', { 'data-lucide': 'trash-2', width: 14 }))
        );
        const it = el('div', { class: 'projItem', dataset: { id: th.id }, onclick: () => { C.activeThread = th.id; save(); renderGlobalAIChat(); } },
            el('span', { textContent: th.title, style: 'flex: 1; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;' }),
            actions
        );
        if (th.id === C.activeThread) it.classList.add('active');
        list.append(it);
    });
    
    $$('#ai-global-chat .model-card').forEach(c => c.classList.toggle('active', C.model === c.dataset.model));
    const log = $('#aiChatLog'); log.innerHTML = '';
    if (C.activeThread) {
        const messages = C.messages[C.activeThread] || [];
        if (messages.length === 0) {
            const welcome = el('div', {class: 'empty-state', style: 'padding: 20px 0;'},
              el('img', {src: 'https://goatify.com/assets/img/Logos%20HD.png', style: 'width: 60px; height: 60px; margin-bottom: 12px;'}),
              el('h3', {textContent: '¿Cómo puedo ayudarte hoy?'})
            );
            const suggestions = el('div', {style: 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 16px;'});
            aiPrompts.forEach(p => {
                const card = el('div', {class:'card', style: 'padding: 12px; cursor: pointer;'}, 
                  el('b', {textContent: p.title, style: 'font-size: var(--sm);'}),
                  el('p', {textContent: p.prompt, style: 'font-size: var(--xs); color: var(--sub); margin: 4px 0 0; opacity: .7;'})
                );
                card.onclick = () => { $('#aiChatMsg').value = p.prompt; $('#aiChatMsg').focus(); };
                suggestions.append(card);
            });
            log.append(welcome, suggestions);
        }
        messages.forEach(m => log.append(createMessageElement(m, S.userProfile)));
        log.scrollTop = log.scrollHeight;
    }
    lucide.createIcons();
}
function renameAIChat(threadId) {
    const C = S.aiGlobalChat;
    const thread = C.threads.find(t => t.id === threadId);
    if (!thread) return;
    showInputModal('Renombrar Conversación', 'Nuevo título:', thread.title, (newTitle) => {
        thread.title = newTitle;
        save();
        renderGlobalAIChat();
    }, thread.title);
}
function deleteAIChat(threadId) {
    if (!confirm('¿Eliminar esta conversación?')) return;
    const C = S.aiGlobalChat;
    C.threads = C.threads.filter(t => t.id !== threadId);
    delete C.messages[threadId];
    if (C.activeThread === threadId) {
        C.activeThread = C.threads.length > 0 ? C.threads[0].id : null;
    }
    save();
    renderGlobalAIChat();
}
function showSendToProjectModal(threadId) {
    const modal = $('#sendChatModal');
    const select = $('#sendChatProjectSelect');
    select.innerHTML = '';
    if (S.projects.length === 0) {
        select.append(el('option', {textContent: 'No hay proyectos para enviar'}));
        $('#sendChatConfirmBtn').disabled = true;
    } else {
        S.projects.forEach(p => select.append(el('option', {value: p.id, textContent: p.name})));
        $('#sendChatConfirmBtn').disabled = false;
    }
    
    $('#sendChatConfirmBtn').onclick = () => {
        const projId = select.value;
        if (projId) {
            const C = S.aiGlobalChat;
            const thread = C.threads.find(t => t.id === threadId);
            const messages = C.messages[threadId];
            if (!thread || !messages) return;
            const targetFolder = 'General';
            const newThreadId = 'c' + Date.now();
            S.chats[projId][targetFolder].threads.unshift({ id: newThreadId, title: `Desde Global: ${thread.title}`});
            S.chats[projId][targetFolder].messages[newThreadId] = [...messages];
            S.chats[projId][targetFolder].activeThread = newThreadId;
            save();
            showToast(`Chat enviado a "${S.projects.find(p=>p.id===projId).name}"`, 'success');
            openProject(projId);
            $('#project-tabs .tab[data-ptab="chat"]').click();
            modal.close();
        }
    };
    modal.showModal();
}
function sendGlobalAIChatMessage() {
    const msgInput = $('#aiChatMsg');
    const msg = msgInput.value.trim(); if (!msg) return;
    const C = S.aiGlobalChat;
    const model = C.model;
    let cost = CREDIT_COSTS.aiChatPro;
    if(model === 'web') cost = CREDIT_COSTS.aiChatWeb;
    if(model === 'x') cost = CREDIT_COSTS.aiChatX;
    if (!useCredits(cost)) return;
    
    const threadId = C.activeThread;
    if (!C.messages[threadId]) C.messages[threadId] = [];
    C.messages[threadId].push({ who: 'Tú', at: new Date(), text: msg });
    msgInput.value = ''; msgInput.style.height = 'auto'; renderGlobalAIChat();

    setTimeout(() => {
        let responseText = `Como modelo de IA, mi sugerencia para "${msg}" sería dividirlo en tareas más pequeñas.`;
         if (msg.toLowerCase().includes('genera código')) responseText = "Por supuesto, ¿qué tipo de código necesitas? Especifícalo y lo crearé para ti.";
         if (msg.toLowerCase().includes('crea una imagen')) responseText = "¡Claro! Generando imagen... [Aquí iría la imagen]";
        C.messages[threadId].push({ who: 'IA', at: new Date(), text: responseText, type: model });
        save(); renderGlobalAIChat();
    }, 1000);
}
function createMessageElement(message, userProfile) {
    const isMine = message.who === 'Tú';
    let senderAvatar;
    if (isMine) {
        senderAvatar = userProfile.avatar;
    } else {
        senderAvatar = 'https://goatify.com/assets/img/Logos%20HD.png';
    }
    
    let avatarEl;
    if (senderAvatar) {
        avatarEl = el('img', { src: senderAvatar, class: 'msg-avatar' });
    } else {
        const initial = (isMine ? (userProfile.nombre.charAt(0) || 'U') : 'IA').toUpperCase();
        const avatarDiv = el('div', { class: 'msg-avatar', textContent: initial, style:'padding:0;'});
        if(!isMine) avatarDiv.style.background = 'transparent';
        if(!isMine) avatarDiv.append(el('img', {src: 'https://goatify.com/assets/img/Logos%20HD.png', style: 'width: 100%; height: 100%; border-radius: 50%;'}));
        avatarEl = avatarDiv;
    }

    const msgBody = el('div', { class: 'msg-body' });
    
    const codeRegex = /\[CODE\]([\s\S]*?)\[\/CODE\]/g;
    let lastIndex = 0;
    let match;
    const textContent = message.text || '';
    while ((match = codeRegex.exec(textContent)) !== null) {
        if (match.index > lastIndex) {
            msgBody.append(document.createTextNode(textContent.substring(lastIndex, match.index)));
        }
        const codeContent = match[1];
        const codeBlock = el('div', { class: 'code-block' },
            el('div', { class: 'code-header' },
                el('span', { textContent: 'Código Generado' }),
                el('span', { class: 'spacer' }),
                el('button', { class: 'btn btn-sm code-preview-btn' }, el('i', {'data-lucide':'eye', width:14})),
                el('button', { class: 'btn btn-sm code-copy-btn' }, el('i', {'data-lucide':'copy', width:14}))
            ),
            el('pre', {}, el('code', { textContent: codeContent }))
        );
        codeBlock.querySelector('.code-preview-btn').onclick = () => {
            const cleanCode = unescapeHtml(codeContent);
            $('#htmlPreviewCode').textContent = cleanCode;
            $('#htmlPreviewFrame').srcdoc = cleanCode;
            $('#htmlPreviewModal').showModal();
        };
        codeBlock.querySelector('.code-copy-btn').onclick = () => {
            navigator.clipboard.writeText(codeContent).then(() => showToast('Código copiado!', 'success'));
        };
        msgBody.append(codeBlock);
        lastIndex = match.index + match[0].length;
    }
    if (lastIndex < textContent.length) {
        msgBody.append(document.createTextNode(textContent.substring(lastIndex)));
    }

    const msg = el('div', { class: 'msg' + (isMine ? ' mine' : '') },
        avatarEl,
        el('div', { class: 'msg-content' },
            el('div', { class: 'msg-who', textContent: isMine ? 'Tú' : 'IA' }),
            msgBody
        )
    );
    lucide.createIcons();
    return msg;
}

// --- CRONOPOST ---
let cpRef = new Date();
function renderCronoPOST() {
    const sel = $('#cpProjectSelect'); const currentSelection = sel.value;
    sel.innerHTML = '';
    sel.append(el('option', { value: 'all', textContent: 'Todos los Proyectos' }));
    S.projects.forEach(p => sel.append(el('option', { value: p.id, textContent: p.name })));
    sel.value = S.projects.find(p => p.id === currentSelection) ? currentSelection : 'all';

    const activeProjectId = sel.value;
    $('#cpMonthLbl').textContent = cpRef.toLocaleString('es', { month: 'long', year: 'numeric' });
    const calendarEl = $('#cpCalendar'); calendarEl.innerHTML = '';
    const headerRow = el('div',{style:'display:contents;'});
    ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'].forEach(day => headerRow.append(el('div', { textContent: day, style: 'text-align:center; font-weight: 600; color: var(--sub); padding-bottom: 8px; font-size: var(--sm);' })));
    calendarEl.append(headerRow);
    const monthGrid = (ref = new Date()) => {
        const y = ref.getFullYear(), m = ref.getMonth(); const first = new Date(y, m, 1);
        const start = new Date(first); start.setDate(1 - ((first.getDay() + 6) % 7));
        const days = []; let cur = new Date(start);
        while (days.length < 35) { days.push(new Date(cur)); cur.setDate(cur.getDate() + 1); } return days;
    };
    const projectsToShow = activeProjectId === 'all' ? S.projects : S.projects.filter(p => p.id === activeProjectId);

    monthGrid(cpRef).forEach(d => {
        const dateKey = d.toDateString();
        const dayEl = el('div', { class: 'day', dataset: { date: dateKey } });
        dayEl.onclick = () => createTaskFromCronoPOST(d);
        if(d.getMonth() !== cpRef.getMonth()) dayEl.style.opacity = .5;
        dayEl.append(el('div', { textContent: d.getDate(), style: 'font-weight: 500; color: var(--sub); margin-bottom: 4px; text-align: right; font-size: var(--sm);' }));

        projectsToShow.forEach(proj => {
            const posts = S.cronopost.posts[proj.id] || {};
            (posts[dateKey] || []).forEach((p, index) => {
                const postEl = el('div', { class: 'cp-post', draggable: 'true', textContent: p.title, title: `${proj.name}: ${p.title}`, style: `border-left-color:${proj.color}; background: color-mix(in hsl, ${proj.color} 15%, transparent);` });
                postEl.ondragstart = e => e.dataTransfer.setData('text/plain', JSON.stringify({type: 'post', id: p.id, title: p.title, fromDate: dateKey, fromProject: proj.id}));
                dayEl.append(postEl);
            });
            Object.values(S.tasks[proj.id] || {}).flat().filter(t => t.due && new Date(t.due).toDateString() === dateKey).forEach(t => {
                const taskEl = el('div', { class: 'cal-task', draggable: 'true', textContent: `✓ ${t.title}`, title: `Tarea: ${t.title}`, style: `border-left-color:${proj.color};` });
                taskEl.ondragstart = e => e.dataTransfer.setData('text/plain', JSON.stringify({type: 'task', id: t.id, fromProject: proj.id, fromFolder: t.folder}));
                dayEl.append(taskEl);
            });
        });

        dayEl.ondragover = (e) => { e.preventDefault(); dayEl.style.background = 'var(--muted)'; };
        dayEl.ondragleave = (e) => { dayEl.style.background = 'var(--surface)'; };
        dayEl.ondrop = (e) => {
            e.preventDefault(); dayEl.style.background = 'var(--surface)';
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const toDate = new Date(dayEl.dataset.date);
            const toDateKey = toDate.toDateString();
            const projectId = $('#cpProjectSelect').value;
            
            if (data.type === 'idea') {
                if (projectId === 'all') { showToast('Selecciona un proyecto específico para agendar ideas.', 'warn'); return; }
                if (!S.cronopost.posts[projectId]) S.cronopost.posts[projectId] = {};
                if (!S.cronopost.posts[projectId][toDateKey]) S.cronopost.posts[projectId][toDateKey] = [];
                S.cronopost.posts[projectId][toDateKey].push({ id: 'post' + Date.now(), title: data.title });
                S.cronopost.ideas[projectId] = S.cronopost.ideas[projectId].filter(i => i.id !== data.id);
            } else if (data.type === 'post') {
                const fromPosts = S.cronopost.posts[data.fromProject][data.fromDate];
                const postIndex = fromPosts.findIndex(p => p.id === data.id);
                if (postIndex > -1) {
                    const [post] = fromPosts.splice(postIndex, 1);
                    if (!S.cronopost.posts[data.fromProject][toDateKey]) S.cronopost.posts[data.fromProject][toDateKey] = [];
                    S.cronopost.posts[data.fromProject][toDateKey].push(post);
                }
            } else if (data.type === 'task') {
                const task = S.tasks[data.fromProject][data.fromFolder].find(t => t.id === data.id);
                if (task) task.due = toDate.toISOString().split('T')[0];
            }
            save(); renderCronoPOST();
        };
        calendarEl.append(dayEl);
    });

    const ideasList = $('#cpIdeasList'); ideasList.innerHTML = '';
    const ideasContainer = $('#cpIdeas');
    if (activeProjectId !== 'all') {
        ideasContainer.style.opacity = 1;
        const ideas = S.cronopost.ideas[activeProjectId] || [];
        if (ideas.length === 0) {
             ideasList.innerHTML = `<div class="empty-state" style="padding: 10px; font-size: var(--sm);">Añade tu primera idea para este proyecto.</div>`;
        } else {
            ideas.forEach(idea => {
                const ideaEl = el('div', { class: 'cp-post', draggable: 'true', textContent: idea.title });
                ideaEl.ondragstart = (e) => e.dataTransfer.setData('text/plain', JSON.stringify({type: 'idea', id: idea.id, title: idea.title}));
                ideasList.append(ideaEl);
            });
        }
    } else {
         ideasList.innerHTML = `<div class="empty-state" style="padding: 10px; font-size: var(--sm);">Selecciona un proyecto para ver y añadir ideas.</div>`;
         ideasContainer.style.opacity = 0.6;
    }
}
function createTaskFromCronoPOST(date) {
    const modal = $('#cronoTaskModal');
    $('#cronoTaskModalDesc').textContent = `Crear tarea para ${date.toLocaleDateString()}`;
    const select = $('#cronoTaskProjectSelect');
    select.innerHTML = '';
    if(S.projects.length === 0) {
        showToast('Debes crear un proyecto primero.', 'warn');
        return;
    }
    S.projects.forEach(p => select.append(el('option', {value: p.id, textContent: p.name})));
    $('#cronoTaskConfirm').onclick = () => {
        const title = $('#cronoTaskTitle').value.trim();
        const projectId = select.value;
        if (!title || !projectId) return showToast('Se requiere un título y un proyecto.', 'warn');
        if (!useCredits(CREDIT_COSTS.action)) return;
        const p = S.projects.find(x => x.id === projectId);
        const firstColumn = p.taskColumns[0] || 'Backlog';
        const targetFolder = 'General';
        const newTask = { id: 't' + Date.now(), title, status: firstColumn, desc: '', due: date.toISOString().split('T')[0] };
        S.tasks[projectId][targetFolder].push(newTask);
        addIntis(5, 'Tarea creada');
        save();
        renderCronoPOST();
        modal.close();
        $('#cronoTaskTitle').value = '';
    };
    modal.showModal();
}
// --- HUB PROFESIONAL ---
function renderHub() {
    const P = S.userProfile;
    $('#avatar').src = P.avatar || `https://placehold.co/100x100/a78bfa/ffffff?text=${(P.nombre.charAt(0) || 'U').toUpperCase()}`;
    $('#pNombreDisplay').textContent = P.nombre;
    $('#pRoleDisplay').textContent = P.rol;
    $('#pBioDisplay').textContent = P.bio;
    $('#pNombre').value = P.nombre;
    $('#pRole').value = P.rol;
    $('#pBio').value = P.bio;
    $('#pSocialLinkedin').value = P.socials?.linkedin || '';
    $('#pSocialTwitter').value = P.socials?.twitter || '';
    $('#upload-photo-prompt').style.display = P.avatar ? 'none' : 'block';
    const socialsEl = $('#pSocialsDisplay'); socialsEl.innerHTML = '';
    if(P.socials?.linkedin) socialsEl.append(el('a', {href: P.socials.linkedin, target:'_blank'}, el('i', {'data-lucide':'linkedin'})));
    if(P.socials?.twitter) socialsEl.append(el('a', {href: P.socials.twitter, target:'_blank'}, el('i', {'data-lucide':'twitter'})));
    const mkList = $('#mkList'); mkList.innerHTML = '';
    S.hub.market.forEach(item => {
        mkList.append(el('div', {class: 'card', style:'margin-bottom:10px;'},
            el('div', {class:'row'}, el('b', {textContent: item.name}), el('span', {class:'spacer'}), el('span', {class:'chip', textContent: `$${item.price}`})),
            el('p', {class:'sub', textContent:item.desc}),
            el('div', {class:'row'}, el('span',{class:'spacer'}),
                el('button', {class:'btn btn-sm btn-ghost', onclick:()=>editMarketItem(item.id)}, el('i',{'data-lucide':'edit-3', width:16})),
                el('button', {class:'btn btn-sm btn-ghost', onclick:()=>deleteMarketItem(item.id)}, el('i',{'data-lucide':'trash-2', width:16}))
            )
        ));
    });
    renderJobs();
    lucide.createIcons();
}
function renderJobs(){
    const list = $('#jobsList'); list.innerHTML = '';
    const searchTerm = $('#jobSearchInput').value.toLowerCase();
    const jobs = S.hub.jobs.filter(j => j.title.toLowerCase().includes(searchTerm) || j.company.toLowerCase().includes(searchTerm));
    if (jobs.length === 0) {
        list.innerHTML = `<div class="empty-state"><i data-lucide="search-x" width="48" height="48"></i><h4>No hay ofertas de empleo</h4><p>No hay ofertas que coincidan con tu búsqueda.</p></div>`;
        lucide.createIcons(); return;
    }
    jobs.forEach(job => {
        const card = el('div', {class: 'job-card'},
            el('div', {class:'row'},
                el('div', {},
                    el('div', {class: 'job-title', textContent: job.title}),
                    el('div', {class: 'job-company', textContent: `${job.company} • ${job.location}`})
                ),
                el('span', {class: 'spacer'}),
                el('div', {},
                    el('div', {class:'chip', textContent: job.type}),
                    el('div', {style:'text-align:right; margin-top: 4px; font-weight: 600;', textContent: job.pay})
                )
            ),
            el('div', {class: 'job-card-details'}, el('p', {textContent: job.desc}))
        );
        card.onclick = () => {
            const details = card.querySelector('.job-card-details');
            details.style.display = details.style.display === 'block' ? 'none' : 'block';
        };
        list.append(card);
    });
}
function addJob() {
    if (!useCredits(CREDIT_COSTS.action * 2)) return;
    const job = { id: 'j' + Date.now(), title: $('#jobTitle').value.trim(), company: $('#jobCompany').value.trim(), location: $('#jobLocation').value.trim(), pay: $('#jobPay').value.trim(), type: $('#jobType').value, desc: $('#jobDesc').value.trim(), authorId: S.userProfile.nombre };
    if (!job.title || !job.company) return showToast('El título y la empresa son obligatorios.', 'warn');
    S.hub.jobs.unshift(job); addIntis(20, 'Empleo publicado'); save(); renderJobs();
    showToast('Oferta de empleo publicada', 'success');
    ['#jobTitle', '#jobCompany', '#jobLocation', '#jobPay', '#jobDesc'].forEach(s => $(s).value = '');
}
function saveProfile() {
    S.userProfile.nombre = $('#pNombre').value; S.userProfile.rol = $('#pRole').value; S.userProfile.bio = $('#pBio').value;
    S.userProfile.socials.linkedin = $('#pSocialLinkedin').value; S.userProfile.socials.twitter = $('#pSocialTwitter').value;
    save(); renderHub(); renderUserProfile(); showToast("Perfil actualizado", "success");
}
function handleAvatarUpload(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => { S.userProfile.avatar = event.target.result; save(); renderHub(); renderUserProfile(); };
    reader.readAsDataURL(file);
}
function editMarketItem(id) {
    const item = S.hub.market.find(i => i.id === id); if (!item) return;
    const newName = prompt("Nuevo nombre:", item.name); const newPrice = prompt("Nuevo precio:", item.price);
    if (newName) item.name = newName; if (newPrice) item.price = Number(newPrice);
    save(); renderHub();
}
function deleteMarketItem(id) {
    if (confirm("¿Eliminar este servicio del mercado?")) { S.hub.market = S.hub.market.filter(i => i.id !== id); save(); renderHub(); }
}
// --- GLOBAL CHAT ---
function renderGChat() {
    const allUsers = [{...S.userProfile, id:'u_me'}, ...S.hub.users];
    const userList = $('#gUserList'); userList.innerHTML = '';
    const generalChannel = el('div', {class: 'projItem', onclick: ()=> openDirectMessage('general')}, el('i', {'data-lucide': 'hash'}), el('span', {textContent: 'general'}));
    if (S.gchat.activeChat === 'general') generalChannel.classList.add('active');
    userList.append(generalChannel);
    allUsers.filter(u => u.id !== 'u_me').forEach(u => {
        const dmKey = ['u_me', u.id].sort().join('-');
        const userEl = el('div', {class: 'projItem', dataset: {userid: u.id}, onclick: ()=> openDirectMessage(u.id)},
            el('div', {class:'presence-dot', style:`width: 8px; height: 8px; border-radius: 50%; background:${u.online ? 'var(--success)' : 'var(--sub)'}`}),
            el('span', {textContent: u.nombre})
        );
        if (S.gchat.activeChat === dmKey) userEl.classList.add('active');
        userList.append(userEl);
    });
    const log = $('#gChatLog'); log.innerHTML = ''; let messages = []; let activeChatName = "Chat";
    const header = $('#gChatHeader'); header.innerHTML = '';
    if (S.gchat.activeChat === 'general') {
        activeChatName = "# general";
        header.append(el('h3', {style:'margin:0', textContent: activeChatName}));
        messages = S.gchat.messages.general || [];
        if (messages.length === 0) messages.push({senderId: 'system', at: new Date(), text: '¡Bienvenido al chat global! Sé respetuoso y colabora.'});
    } else {
        const otherUserId = S.gchat.activeChat.replace('u_me','').replace('-','');
        const otherUser = allUsers.find(u => u.id === otherUserId);
        if(otherUser) {
            activeChatName = `Chat con ${otherUser.nombre}`;
            header.append(el('h3', {style:'margin:0', textContent: activeChatName}));
            header.append(el('span', {class: 'spacer'}));
            const callBtn = el('button', { class: 'btn btn-sm' }, el('i', { 'data-lucide': 'video' }));
            callBtn.onclick = () => { $('#videoCallTitle').textContent = `Llamando a ${otherUser.nombre}...`; $('#videoCallModal').showModal(); };
            header.append(callBtn);
        }
        messages = S.gchat.dms[S.gchat.activeChat] || [];
    }
    
    messages.forEach(m => {
        const sender = allUsers.find(u => u.id === m.senderId) || {nombre: 'Sistema', avatar: 'https://goatify.com/assets/img/Logos%20HD.png'};
        const isMine = m.senderId === 'u_me';
        let senderAvatar = isMine ? S.userProfile.avatar : sender.avatar;
        let avatarEl;
        if (senderAvatar) {
            avatarEl = el('img', {src: senderAvatar, class: 'msg-avatar'});
        } else {
            const initial = (sender.nombre.charAt(0) || '?').toUpperCase();
            avatarEl = el('div', {class: 'msg-avatar', textContent: initial, style:'padding:0;'});
        }
        
        const msgEl = el('div', {class: 'msg' + (isMine ? ' mine' : '') },
            avatarEl,
            el('div', {class: 'msg-content'},
                el('div', {class: 'msg-who', textContent: isMine ? 'Tú' : sender.nombre}),
                el('div', {class: 'msg-body', textContent: m.text})
            )
        );
        log.append(msgEl);
    });
    log.scrollTop = log.scrollHeight;
    lucide.createIcons();
}
function openDirectMessage(userId) {
    S.gchat.activeChat = (userId === 'general' || userId === 'u_me') ? 'general' : ['u_me', userId].sort().join('-');
    save(); renderGChat();
}
function sendGChatMessage() {
    const msg = $('#gChatMsg').value.trim(); if (!msg) return;
    const message = { senderId: 'u_me', at: new Date(), text: msg };
    if (S.gchat.activeChat === 'general') { 
        if(!S.gchat.messages.general) S.gchat.messages.general = [];
        S.gchat.messages.general.push(message);
    } else { 
        if (!S.gchat.dms[S.gchat.activeChat]) S.gchat.dms[S.gchat.activeChat] = []; 
        S.gchat.dms[S.gchat.activeChat].push(message); 
    }
    addIntis(2, 'Mensaje en chat');
    save(); renderGChat(); $('#gChatMsg').value = '';
}
// --- MONETIZATION & MINDSET ---
const monetizationModules = {
    oferta: { icon: 'gem', title: 'Ofertas Irresistibles', desc: 'Estructura productos que tus clientes no puedan rechazar.', content: `<h4>El Principio de la Transformación</h4><p>Una oferta irresistible no es sobre tu producto, es sobre la <strong>transformación</strong> que vendes. Debes llevar a tu cliente de un "Estado A" (con un problema doloroso) a un "Estado B" (con el problema resuelto y aspiraciones cumplidas).</p><h4>Componentes Clave de tu Oferta:</h4><ul><li><strong>Resultado Específico y Deseado:</strong> ¿Qué logrará exactamente tu cliente? (Ej: "Lanza tu podcast profesional en 30 días", no "Aprende a hacer podcasts").</li><li><strong>Bonos de Alto Valor:</strong> Añade extras que complementen la oferta principal. (Ej: Plantillas de guiones, checklist técnico, acceso a comunidad privada).</li><li><strong>Garantía Sólida (Inversión de Riesgo):</strong> Reduce el riesgo a cero para el comprador.</li><li><strong>Urgencia y Escasez:</strong> Motiva la acción inmediata. (Ej: "Disponible solo para las primeras 20 personas").</li></ul><div class="tip"><strong>Tip Profesional:</strong> Nombra tu oferta basándote en el resultado. "El Sistema Podcast Launchpad 30" suena mucho más valioso.</div>` },
    contenido: { icon: 'megaphone', title: 'Marketing de Contenidos', desc: 'Atrae a tu cliente ideal creando contenido de valor.', content: `<h4>La Estrategia del "Dar Primero"</h4><p>El marketing de contenidos se basa en atraer clientes en lugar de perseguirlos. Lo haces ofreciendo valor por adelantado, posicionándote como una autoridad en tu nicho.</p><h4>Pasos para una Estrategia Exitosa:</h4><ul><li><strong>Define tu Pilar de Contenido:</strong> Elige un tema central en el que eres experto.</li><li><strong>Elige UN Formato y UN Canal Principal:</strong> ¿Videos en YouTube? ¿Hilos en Twitter/X? Domina uno antes de expandirte.</li><li><strong>Crea "Contenido Solución":</strong> Cada pieza de contenido debe resolver un micro-problema de tu audiencia.</li><li><strong>Llamada a la Acción (CTA):</strong> Al final de tu contenido, invita a la audiencia a dar el siguiente paso. (Ej: "Descarga mi guía gratuita sobre X").</li></ul><div class="tip"><strong>Tip Profesional:</strong> Crea una pieza de contenido larga y de alto valor y luego "recíclala" en piezas más pequeñas para otras redes.</div>` },
    suscripcion: { icon: 'calendar-check', title: 'Modelos de Suscripción', desc: 'Crea ingresos recurrentes y una comunidad fiel.', content: `<h4>El Poder del Ingreso Predecible</h4><p>Los modelos de suscripción transforman tu negocio de transacciones únicas a relaciones a largo plazo, dándote un flujo de caja estable.</p><h4>Tipos de Modelos Populares:</h4><ul><li><strong>Comunidad Privada:</strong> Acceso a un grupo (Discord, Slack, etc.), networking y contenido exclusivo.</li><li><strong>Software como Servicio (SaaS):</strong> Ofreces una herramienta o software por una cuota mensual/anual.</li><li><strong>Producto como Servicio (PaaS):</strong> Ofreces un servicio "hecho para ti" de forma ilimitada por una cuota fija (Ej: Diseño gráfico ilimitado).</li></ul><div class="tip"><strong>Tip Profesional:</strong> Empieza con una "Oferta Fundacional" a un precio más bajo para tus primeros miembros. Ellos te darán feedback valioso.</div>` },
     embudos: { icon: 'filter', title: 'Embudos de Venta', desc: 'Diseña el viaje de un extraño a un cliente leal.', content: `<h4>¿Qué es un Embudo de Ventas?</h4><p>Es el proceso paso a paso que guía a tus clientes potenciales hacia la compra. En lugar de una tienda con mil opciones, un embudo ofrece un camino claro.</p><h4>Fases de un Embudo Básico:</h4><ol><li><strong>Tráfico (ToFu):</strong> ¿Cómo te descubren? (Redes sociales, anuncios, SEO).</li><li><strong>Captación (MoFu):</strong> Ofreces un "Lead Magnet" (ebook, webinar) a cambio del correo.</li><li><strong>Venta (BoFu):</strong> Presentas tu oferta principal a través de una página de ventas y correos.</li><li><strong>Fidelización:</strong> Aportas valor post-compra para que se conviertan en clientes recurrentes.</li></ol><div class="tip"><strong>Tip Profesional:</strong> La mayoría de las ventas no ocurren en el primer contacto. Una secuencia de 5-7 correos automáticos puede multiplicar tus conversiones.</div>` }
};
function renderMonetAssistant() {
    const grid = $('#monet-grid'); grid.innerHTML = '';
    for (const key in monetizationModules) {
        const module = monetizationModules[key];
        const card = el('div', {class: 'monet-card', onclick: () => openMonetModule(key)},
            el('i', {'data-lucide': module.icon, width: 40, height: 40}),
            el('h4', {textContent: module.title}),
            el('p', {textContent: module.desc})
        );
        grid.append(card);
    }
    lucide.createIcons();
}
function openMonetModule(key) {
    const module = monetizationModules[key]; if (!module) return;
    $('#monetModuleTitle').textContent = module.title;
    $('#monetModuleContent').innerHTML = module.content;
    $('#monetModuleModal').showModal();
    lucide.createIcons();
}
function setupMindset() {
    const quotes = ["El éxito es la suma de pequeños esfuerzos repetidos día tras día.", "La creatividad es la inteligencia divirtiéndose.", "El único modo de hacer un gran trabajo es amar lo que haces."];
    $('#mindsetQuote').textContent = `"${quotes[Math.floor(Math.random()*quotes.length)]}"`;
    const breathingText = $('#breathing-text');
    let is_inhaling = true;
    const updateBreathText = () => {
        breathingText.textContent = is_inhaling ? "Inhala..." : "Exhala...";
        is_inhaling = !is_inhaling;
    };
    const circle = $('#breathing-circle');
    circle.addEventListener('animationiteration', updateBreathText);
    updateBreathText(); // Initial call
}
// --- Wallet & Intis ---
function renderWallet() {
    const tbody = $('#wBody'); tbody.innerHTML = '';
    const balance = (S.wallet.movs || []).reduce((acc, mov) => acc + (mov.tipo === 'Ingreso' ? mov.monto : -mov.monto), 0);
    $('#walletTotalBalance').textContent = `$${balance.toFixed(2)}`;
    (S.wallet.movs || []).slice().reverse().forEach((mov, i) => {
        const tr = el('tr', {},
            el('td',{'data-label': 'Fecha', textContent: fmtDate(mov.fecha)}),
            el('td',{'data-label': 'Tipo', textContent: mov.tipo, style: `color: ${mov.tipo === 'Ingreso' ? 'var(--success)' : 'var(--danger)'}`}),
            el('td',{'data-label': 'Monto', textContent: `$${mov.monto.toFixed(2)}`}),
            el('td',{'data-label': 'Categoría', textContent: mov.cat}),
            el('td',{'data-label': 'Nota', textContent: mov.nota}),
            el('td', {}, el('button', {class: 'btn btn-ghost btn-sm', onclick: () => { S.wallet.movs.splice(S.wallet.movs.length - 1 - i, 1); save(); renderWallet(); }}, el('i', {'data-lucide': 'trash-2', width: 14})))
        );
        tbody.append(tr);
    });
    const userSelect = $('#transferUserSelect');
    userSelect.innerHTML = '';
    S.hub.users.forEach(u => userSelect.append(el('option', {value: u.id, textContent: `${u.nombre} (${u.rol})`})));
    lucide.createIcons();
}
function addWalletTransaction() {
    const monto = parseFloat($('#wMonto').value);
    if (!monto || monto <= 0) return showToast('Por favor, ingresa un monto válido.', 'warn');
    if (!useCredits(CREDIT_COSTS.action)) return;
    const newMov = { fecha: new Date().toISOString(), tipo: $('#wTipo').value, monto: monto, cat: $('#wCat').value.trim() || 'General', nota: $('#wNota').value.trim() };
    S.wallet.movs.push(newMov);
    addIntis(5, 'Movimiento en billetera');
    save(); renderWallet();
    $('#wMonto').value = ''; $('#wCat').value = ''; $('#wNota').value = '';
}
function transferFunds() {
    const amount = parseFloat($('#transferAmount').value);
    const recipientId = $('#transferUserSelect').value;
    if (!amount || amount <= 0) return showToast('Ingresa un monto válido.', 'warn');
    const balance = (S.wallet.movs || []).reduce((acc, mov) => acc + (mov.tipo === 'Ingreso' ? mov.monto : -mov.monto), 0);
    if (amount > balance) return showToast('Fondos insuficientes para la transferencia.', 'warn');
    
    const recipient = S.hub.users.find(u => u.id === recipientId);
    if (!recipient) return showToast('Usuario no encontrado.', 'warn');

    S.wallet.movs.push({ fecha: new Date().toISOString(), tipo: 'Egreso', monto: amount, cat: 'Transferencia', nota: `A ${recipient.nombre}` });
    showToast(`$${amount.toFixed(2)} transferidos a ${recipient.nombre}. (Simulación)`, 'success');
    addIntis(10, 'Transferencia realizada');
    save();
    renderWallet();
    $('#transferAmount').value = '';
}

// ====== Onboarding ======
const industryTemplates = {
    agency: { projects: [{id: 'p_agency_1', name: 'Cliente Tech Solutions', color: '#3b82f6', taskColumns:['Por hacer', 'En progreso', 'En revisión', 'Aprobado']}], tasks: {'p_agency_1': { 'General': [ {id:'t_a1', title:'Reunión de kickoff con cliente', status:'Aprobado'}, {id:'t_a2', title:'Definir KPIs de la campaña', status:'En progreso'}, {id:'t_a3', title:'Enviar propuesta de diseño', status:'Por hacer'} ]}}, notes: {'p_agency_1': {'General': {list: [{id:'n_a1', title: 'Minuta Kickoff'}], active:'n_a1', bodies:{'n_a1':'<p><strong>Puntos clave:</strong> Foco en Aumento de Leads.</p>'}, drawings:{}}}}, },
    ecommerce: { projects: [{id: 'p_ecom_1', name: 'Lanzamiento Colección Otoño', color: '#16a34a', taskColumns: ['Ideas', 'Producción', 'Marketing', 'Lanzado']}], tasks: {'p_ecom_1': {'General': [ {id:'t_e1', title:'Sesión de fotos de producto', status:'Producción'}, {id:'t_e2', title:'Actualizar banners de la web', status:'Marketing'}, {id:'t_e3', title:'Preparar campaña de email marketing', status:'Ideas'} ]}}, notes: {'p_ecom_1': {'General': {list: [{id:'n_e1', title: 'Ideas para Campaña'}], active:'n_e1', bodies:{'n_e1':'<p>Foco en colores cálidos y confort.</p>'}, drawings:{}}}}, },
    creator: { projects: [{id: 'p_creator_1', name: 'Contenido YouTube Q4', color: '#ef4444', taskColumns: ['Guion', 'Grabación', 'Edición', 'Publicado']}], tasks: {'p_creator_1': { 'General': [ {id:'t_c1', title:'Grabar video sobre "5 Errores Comunes"', status:'Grabación'}, {id:'t_c2', title:'Escribir guion para colaboración con @usuario', status:'Guion'}, {id:'t_c3', title:'Investigar temas para videos de Diciembre', status:'Guion'} ]}}, cronopost: { ideas: {'p_creator_1': [{id:'i_c1', title: 'Detrás de cámaras de mi último video'}]}}, }
};
function loadIndustryTemplate(industry) {
    S = JSON.parse(JSON.stringify(initialState)); // Reset state but keep profile
    const template = industryTemplates[industry] || {};
    S.projects = template.projects || []; S.tasks = template.tasks || {}; S.notes = template.notes || {};
    if (template.cronopost) S.cronopost.ideas = template.cronopost.ideas || {};
    S.projects.forEach(p => {
        const id = p.id;
        if (!S.folders[id]) S.folders[id] = ['General'];
        // Ensure all sub-structures exist
        const folder = S.folders[id][0];
        if (!S.chats[id]) S.chats[id] = { [folder]: {threads:[], messages:{}, activeThread: null, model: 'pro'}};
        if (!S.tables[id]) S.tables[id] = { [folder]: {list:[{id: 'tbl_default', name: 'Tabla 1'}], active: 'tbl_default', data: {'tbl_default': {cols:[], rows:[]}}}};
        if (!S.files[id]) S.files[id] = { [folder]: [] };
        if (!S.fin[id]) S.fin[id] = {rows:[]};
        if (!S.cronopost.posts[id]) S.cronopost.posts[id] = {};
        if (!S.cronopost.ideas[id]) S.cronopost.ideas[id] = [];
    });
    S.userProfile.industry = industry; addIntis(100, `Plantilla ${industry} cargada`);
    save(); showToast(`¡Bienvenido! Tu espacio de trabajo para ${industry} está listo.`, 'success');
    renderAside();
    if(S.projects.length > 0) openProject(S.projects[0].id);
    else show('ai-global-chat');
}
// ====== Search ======
function performSearch() {
    // ... (search logic remains largely the same, but needs to iterate through folders)
}
// ====== Tour ======
let currentTourStep = 0;
const tourSteps = [
    { el: '#menuBtn', title: 'Menú Principal', text: 'Usa este botón para expandir o contraer la barra lateral de navegación y proyectos.'},
    { el: 'aside .projList', title: 'Tus Proyectos', text: 'Aquí encontrarás todos tus proyectos. Haz clic en uno para abrirlo o crea uno nuevo.'},
    { el: '#nav-list', title: 'Módulos Globales', text: 'Accede a herramientas que abarcan todos tus proyectos, como el Asistente IA, Calendario General y el Hub Profesional.'},
    { el: '#projectShell .tabs', title: 'Pestañas del Proyecto', text: 'Dentro de un proyecto, navega entre sus diferentes herramientas como Tareas, Calendario, Finanzas y más.'},
    { el: '#quickAdd', title: 'Añadir Rápido', text: 'Este botón cambia según la pestaña en la que te encuentres. Te permite añadir rápidamente tareas, notas, etc.'},
    { el: '#walletChip', title: 'Billetera e Intis', text: 'Lleva un control de tus finanzas globales y tus puntos de gamificación (Intis) desde aquí.'},
];
function showTourStep(index) {
    if (index >= tourSteps.length) { endTour(); return; }
    currentTourStep = index;
    const step = tourSteps[index];
    const targetEl = $(step.el);
    if (!targetEl) { showTourStep(index + 1); return; }
    
    const tooltip = $('#tour-tooltip');
    $('#tour-overlay').style.display = 'block';
    tooltip.style.display = 'block';
    
    $('#tour-title').textContent = step.title;
    $('#tour-text').textContent = step.text;
    $('#tour-step').textContent = `${index + 1} / ${tourSteps.length}`;
    $('#tour-prev').disabled = index === 0;

    targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const rect = targetEl.getBoundingClientRect();
    tooltip.style.top = `${rect.bottom + 10}px`;
    tooltip.style.left = `${rect.left}px`;
    if(rect.left + 300 > window.innerWidth) tooltip.style.left = `${window.innerWidth - 310}px`;
    if(rect.bottom + tooltip.offsetHeight > window.innerHeight) tooltip.style.top = `${rect.top - tooltip.offsetHeight - 10}px`;
}
function endTour() {
    $('#tour-overlay').style.display = 'none';
    $('#tour-tooltip').style.display = 'none';
}

// ====== Floating AI Assistant ======
const assistant = {
    el: $('#floating-assistant'),
    modal: $('#assistantModal'),
    log: $('#assistantChatLog'),
    input: $('#assistantChatMsg'),
    isDragging: false,
    offsetX: 0, offsetY: 0,
    synth: window.speechSynthesis,
    recognition: null,
    init() {
        this.el.onmousedown = this.dragStart.bind(this);
        document.onmousemove = this.drag.bind(this);
        document.onmouseup = this.dragEnd.bind(this);
        this.el.ontouchstart = this.dragStart.bind(this);
        document.ontouchmove = this.drag.bind(this);
        document.ontouchend = this.dragEnd.bind(this);
        this.el.onclick = (e) => { 
            if(!this.wasDragged) {
                this.modal.showModal();
                if(this.log.children.length === 0) {
                    const welcome = "¡Hola! Soy tu asistente de Goatify. Estoy aquí para ayudarte a navegar, crear tareas, notas y mucho más. ¿Qué necesitas hacer hoy? Puedes usar los botones de abajo o simplemente decírmelo.";
                    this.addMessage(welcome, 'IA');
                    this.speak(welcome);
                }
            }
        };
        $('#assistantSendMsg').onclick = () => this.sendMessage();
        $('#assistantMuteBtn').onclick = () => this.toggleMute();
        this.input.onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.sendMessage(); }};
        this.setupSpeechRecognition();
    },
    wasDragged: false,
    dragStart(e) {
        this.wasDragged = false;
        this.isDragging = true;
        this.el.classList.remove('assistant-pulse');
        const event = e.type.includes('touch') ? e.touches[0] : e;
        this.offsetX = event.clientX - this.el.getBoundingClientRect().left;
        this.offsetY = event.clientY - this.el.getBoundingClientRect().top;
    },
    drag(e) {
        if (!this.isDragging) return;
        this.wasDragged = true;
        e.preventDefault();
        const event = e.type.includes('touch') ? e.touches[0] : e;
        let x = event.clientX - this.offsetX;
        let y = event.clientY - this.offsetY;
        this.el.style.left = `${x}px`;
        this.el.style.top = `${y}px`;
        this.el.style.bottom = 'auto';
        this.el.style.right = 'auto';
    },
    dragEnd() {
        this.isDragging = false;
        this.el.classList.add('assistant-pulse');
        setTimeout(() => this.wasDragged = false, 100); // Reset drag flag
    },
    sendMessage() {
        const text = this.input.value.trim();
        if (!text) return;
        this.addMessage(text, 'Tú');
        this.input.value = '';
        this.processCommand(text);
    },
    processCommand(text, isDirectCommand = false) {
        let response = "No estoy seguro de cómo ayudar con eso. Intenta reformular tu pregunta o usa uno de los botones. Puedes pedir 'ayuda' para ver una lista de lo que puedo hacer.";
        const command = isDirectCommand ? text : text.toLowerCase();
        let closeAssistant = false;

        if (command.includes('new_task') || command.includes('crear tarea')) {
             if (S.activeProject) {
                quickAddTask();
                response = `Claro. He abierto el formulario para que añadas una nueva tarea en la carpeta actual.`;
             } else {
                response = 'Para crear una tarea, primero necesitas abrir o crear un proyecto desde el menú de la izquierda.';
             }
        } else if (command.includes('new_note') || command.includes('nueva nota')) {
             if (S.activeProject) {
                createNewNote();
                response = `Perfecto. Ya puedes crear tu nueva nota.`;
            } else {
                response = 'Por favor, selecciona un proyecto antes de crear una nota.';
            }
        } else if (command.includes('go_to_calendar') || command.includes('ir al calendario')) {
            show('cronopost');
            response = 'Entendido. Abriendo tu Calendario General ahora.';
            closeAssistant = true;
        } else if (command.includes('help') || command.includes('ayuda')) {
            response = "¡Claro! Puedo ayudarte a: 'crear una nueva tarea', 'crear una nueva nota', 'ir al calendario', 'ir al hub profesional', o puedes usar los botones de acción rápida. ¿Qué te gustaría hacer?";
        }
        
        this.addMessage(response, 'IA');
        this.speak(response);
        if(closeAssistant) this.modal.close();
    },
    addMessage(text, who) {
        const msg = createMessageElement({ text, who }, S.userProfile);
        this.log.append(msg);
        this.log.scrollTop = this.log.scrollHeight;
    },
    speak(text) {
        if (S.ui.assistantMuted || !this.synth) return;
        this.synth.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        // Prioritize specific, high-quality Latin American voices
        const voices = this.synth.getVoices();
        const preferredVoices = [
            "Microsoft Sabina Online (Natural) - Spanish (Mexico)", // Windows Edge
            "Paulina", // macOS
            "Google español de Estados Unidos" // Android/Chrome
        ];
        let selectedVoice = null;
        for(const name of preferredVoices){
            const found = voices.find(v => v.name === name);
            if(found) { selectedVoice = found; break; }
        }
        // Fallback voices
        if(!selectedVoice) selectedVoice = voices.find(v => v.lang === 'es-US') || voices.find(v => v.lang === 'es-MX') || voices.find(v => v.lang.startsWith('es-'));
        
        console.log("Voz seleccionada:", selectedVoice ? selectedVoice.name : "Voz por defecto del sistema");

        utterance.voice = selectedVoice;
        utterance.lang = selectedVoice ? selectedVoice.lang : 'es-MX';
        utterance.pitch = 1;
        utterance.rate = 1;
        this.synth.speak(utterance);
    },
    setupSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            $('#assistantListenBtn').style.display = 'none';
            return;
        }
        this.recognition = new SpeechRecognition();
        this.recognition.lang = 'es-MX';
        this.recognition.interimResults = false;
        this.recognition.maxAlternatives = 1;
        this.recognition.onresult = (event) => {
            const speechResult = event.results[0][0].transcript;
            this.input.value = speechResult;
            this.sendMessage();
        };
        this.recognition.onspeechend = () => this.recognition.stop();
        $('#assistantListenBtn').onclick = () => {
            showToast('Escuchando...', 'info');
            this.recognition.start();
        };
    },
    toggleMute() {
        S.ui.assistantMuted = !S.ui.assistantMuted;
        const icon = S.ui.assistantMuted ? 'volume-x' : 'volume-2';
        $('#assistantMuteBtn').innerHTML = `<i data-lucide="${icon}"></i>`;
        lucide.createIcons();
        save();
    }
};

// ====== INIT & EVENT LISTENERS ======
function init(){
  load();
  lucide.createIcons();
  assistant.init();
  if (!S.userProfile || !S.userProfile.industry) $('#industryModal').showModal();
  const handleNav = (hash) => {
    const view = hash.replace('#', '');
    if (view && $(`[data-nav="${view}"]`)) { show(view); } 
    else { show('ai-global-chat'); }
  };
  $('#nav-list').addEventListener('click', (e) => {
      const link = e.target.closest('a.navBtn');
      if (link && link.dataset.nav) {
          e.preventDefault(); const view = link.dataset.nav;
          history.pushState({view}, '', `#${view}`); show(view);
      }
  });
  document.body.addEventListener('click', e => {
    const link = e.target.closest('a.nav-link-btn');
    if (link && link.hash) {
        e.preventDefault();
        const view = link.hash.replace('#', '');
        if($(`[data-nav="${view}"]`)){
            history.pushState({view}, '', `#${view}`);
            show(view);
        }
    }
  });
  handleNav(window.location.hash);
  renderAside();
  setupHeaderActions();
  setupAutoResize();
  setupDialogs();
  setupAside();
}
function setupDialogs() {
    $$('dialog').forEach(dialog => {
        dialog.addEventListener('click', e => {
            if (e.target === dialog) { // Only close if click is on the backdrop
                dialog.close();
            }
        });
    });
}
function setupAside() {
    const aside = $('aside');
    $('#menuBtn').onclick = () => {
        if (window.innerWidth <= 1180) {
            document.body.classList.toggle('aside-open');
        } else {
            S.ui.asideCollapsed = !S.ui.asideCollapsed;
            document.body.classList.toggle('aside-collapsed', S.ui.asideCollapsed);
            save();
        }
    };
    aside.onmouseenter = () => {
        if (window.innerWidth > 1180 && document.body.classList.contains('aside-collapsed')) {
            aside.classList.add('hover-expand');
        }
    };
    aside.onmouseleave = () => {
        if (window.innerWidth > 1180) {
            aside.classList.remove('hover-expand');
        }
    };
    $('#menu-overlay').onclick = () => document.body.classList.remove('aside-open');
}
function setupHeaderActions() {
    const themeHandler = () => {
        const h=document.documentElement; 
        const newTheme = h.getAttribute('data-theme')==='light'?'dark':'light'; 
        h.setAttribute('data-theme', newTheme);
        const themeIconName = newTheme === 'light' ? 'sun' : 'moon';
        $(`#themeBtn > i`).outerHTML = `<i data-lucide="${themeIconName}"></i>`;
        $(`#mobileThemeBtn > i`).outerHTML = `<i data-lucide="${themeIconName}"></i>`;
        lucide.createIcons();
    };
    const tourHandler = () => showTourStep(0);
    $('#themeBtn').onclick = themeHandler;
    $('#tourBtn').onclick = tourHandler;
    $('#mobileMoreBtn').onclick = (e) => { e.stopPropagation(); $('#mobileDropdown').classList.toggle('active'); };
    document.addEventListener('click', () => { $('#mobileDropdown').classList.remove('active'); });
    $('#mobileThemeBtn').onclick = themeHandler;
    $('#mobileTourBtn').onclick = tourHandler;
    $('#mobileWalletBtn').onclick = () => $('#walletChip').click();
    $('#mobileIntisBtn').onclick = () => $('#intisChip').click();
}
function setupAutoResize() {
    document.addEventListener('input', e => {
        if (e.target.tagName.toLowerCase() === 'textarea') {
            e.target.style.height = 'auto';
            e.target.style.height = (e.target.scrollHeight) + 'px';
        }
    });
}
// --- General Listeners ---
$('#loadIndustryBtn').onclick = () => { const industry = $('#industrySelect').value; loadIndustryTemplate(industry); $('#industryModal').close(); };
$('#newProject').onclick = createNewProject;
$('#q').addEventListener('keydown', e => { if (e.key === 'Enter') performSearch(); });
$('#walletChip').onclick = () => { renderWallet(); $('#walletModal').showModal(); };
$('#intisChip').onclick = () => { $('#intisModal').showModal(); lucide.createIcons(); };
$('#wAdd').onclick = addWalletTransaction;
$('#confirmTransferBtn').onclick = transferFunds;
$('#resetApp').onclick=()=>{ if(confirm('¿BORRAR TODO?')) { localStorage.removeItem('goatify_v9_2'); window.location.reload();} };
$('#tour-next').onclick = () => showTourStep(currentTourStep + 1);
$('#tour-prev').onclick = () => showTourStep(currentTourStep - 1);
$('#assistantActions').addEventListener('click', e => {
    const button = e.target.closest('button');
    if (!button) return;
    assistant.processCommand(button.dataset.assistantCmd, true);
});
// --- Project Listeners ---
wireTabs('#projectShell', 'ptab', 'p-tab');
wireTabs('#walletModal', 'wtab', 'w-wtab');
$('#quickAdd').onclick = quickAddTask;
$('#addColumnBtn').onclick = addColumn;
$('#addFolder').onclick=()=>{ const id=S.activeProject; if(!id)return; showInputModal('Nueva Carpeta', 'Nombre de la nueva carpeta:', 'Ej: Documentos', name => {S.folders[id].push(name); const f = S.folders[id][S.folders[id].length -1]; S.tasks[id][f]=[]; S.notes[id][f]={list:[]}; S.chats[id][f]={threads:[]}; S.tables[id][f]={list:[]}; S.files[id][f]=[]; save(); openProject(id);})};
$('#folderSel').onchange = renderProject;
$('#prevM').onclick=()=>{calRef.setMonth(calRef.getMonth()-1); renderCalendar();};
$('#nextM').onclick=()=>{calRef.setMonth(calRef.getMonth()+1); renderCalendar();};
$('#newNoteBtn').onclick = createNewNote;
$$('#p-tab-notes [data-cmd]').forEach(btn=>btn.onclick=()=>document.execCommand(btn.dataset.cmd, false, btn.dataset.value || null));
$('#noteEditor').oninput=()=>{ const id=S.activeProject; if(!id) return; const folder = getCurrentFolder(); const N = S.notes[id][folder]; if(N.active){ N.bodies[N.active]=$('#noteEditor').innerHTML; save(); } };
$('#notePreviewBtn').onclick = () => { 
    const content = $('#noteEditor').innerHTML; 
    const cleanCode = unescapeHtml(content);
    $('#htmlPreviewCode').textContent = cleanCode; 
    $('#htmlPreviewFrame').srcdoc = cleanCode; 
    $('#htmlPreviewModal').showModal(); 
};
$('#clearCanvasBtn').onclick=()=>{ const id=S.activeProject; const folder=getCurrentFolder(); if(!id||!S.notes[id][folder].active)return; delete S.notes[id][folder].drawings[S.notes[id][folder].active]; save(); renderNotes(); };
$('#undoCanvasBtn').onclick = undoCanvas;
$('#redoCanvasBtn').onclick = redoCanvas;
$('#exportNotePDF').onclick = () => exportNote('pdf');
$('#fileInput').onchange=(e)=>{ const id=S.activeProject; if(!id) return; const folder=getCurrentFolder(); for(const f of e.target.files){ S.files[id][folder].push({name:f.name,url:URL.createObjectURL(f), size:f.size}); } addIntis(5, 'Archivo subido'); save(); renderFiles(); renderOverview();};
$('#newChat').onclick=()=>{ const id=S.activeProject; const folder=getCurrentFolder(); if(!id)return; showInputModal('Nueva Conversación', `Título de la conversación en ${folder}:`, 'Ej: Ideas para el blog', t => { const newId = 'c'+Date.now(); S.chats[id][folder].threads.push({id:newId, title:t}); S.chats[id][folder].activeThread = newId; save(); renderProjectChat();})};
$$('#p-tab-chat .model-card:not(.disabled)').forEach(card => card.onclick=()=>{ const id=S.activeProject; const folder=getCurrentFolder(); if(!id)return; if(card.dataset.model === 'x' && !S.userProfile.isPro) return $('#premiumModal').showModal(); S.chats[id][folder].model=card.dataset.model; save(); renderProjectChat(); });
$('#sendMsg').onclick = sendProjectChatMessage;
$('#chatMsg').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendProjectChatMessage(); }});
$('#p_attachFileBtn').onclick = () => $('#p_chatFileInput').click();
$('#chatToTasks').onclick=()=>{ const id=S.activeProject; const folder=getCurrentFolder(); const C=S.chats[id][folder]; if(!C?.activeThread) return; const lastMsg = C.messages[C.activeThread]?.filter(m=>m.who==='IA').pop(); if(!lastMsg) return showToast('No hay respuesta de IA para convertir.','warn'); S.tasks[id][folder].push({id:'t'+Date.now(), title: lastMsg.text.substring(0, 50) + "...", status:S.projects.find(p=>p.id===id).taskColumns[0], desc:lastMsg.text, due:''}); save(); renderTasks(); showToast('Tarea creada desde el chat.','success');};
$('#newTableBtn').onclick = createNewTable;
$('#tableSelector').onchange = (e) => { S.tables[S.activeProject][getCurrentFolder()].active = e.target.value; save(); renderTables(); };
$('#addCol').onclick=()=>{ const id=S.activeProject; if(!id) return; const folder=getCurrentFolder(); const T=S.tables[id][folder].data[S.tables[id][folder].active]; showInputModal('Nueva Columna', 'Nombre de la nueva columna:', 'Ej: Prioridad', name => { T.cols.push(name); T.rows.forEach(r=>r.push('')); save(); renderTables(); })};
$('#addRow').onclick=()=>{ const id=S.activeProject; if(!id) return; const folder=getCurrentFolder(); const T=S.tables[id][folder].data[S.tables[id][folder].active]; T.rows.push(new Array(T.cols.length).fill('')); save(); renderTables();};
$('#exportCSV').onclick=()=>{ const id=S.activeProject; if(!id) return; const folder=getCurrentFolder(); const T=S.tables[id][folder].data[S.tables[id][folder].active]; download(`tabla.csv`, csv([T.cols, ...T.rows]));};
$('#finNew').onclick=()=>{ const id=S.activeProject; if(!id) return; if(!useCredits(CREDIT_COSTS.action)) return; const F=S.fin[id]; showInputModal('Nuevo Movimiento', 'Monto:', '100', montoStr => { const monto=Number(montoStr); if(!monto) return; const tipo=prompt('Ingreso/Egreso','Ingreso'); const cat=prompt('Categoría','General'); const nota=prompt('Nota',''); F.rows.push({fecha:new Date(), tipo, monto, cat, nota}); addIntis(5, 'Movimiento financiero'); save(); renderFin(); renderOverview(); })};
$('#finExport').onclick=()=>{ const id=S.activeProject; if(!id) return; const F=S.fin[id]; download(`finanzas.csv`, csv([['Fecha','Tipo','Monto','Cat','Nota'], ...F.rows.map(r=>[r.fecha,r.tipo,r.monto,r.cat,r.nota])]));};
$('#viewToggleBoard').onclick = () => { S.ui.taskView = 'board'; save(); renderTasks(); };
$('#viewToggleList').onclick = () => { S.ui.taskView = 'list'; save(); renderTasks(); };
$('#taskDetailSaveBtn').onclick = saveTaskDetails;
$('#taskDetailDeleteBtn').onclick = () => deleteTask($('#taskDetailId').value);
// --- Global Module Listeners ---
$('#cpProjectSelect').onchange = renderCronoPOST;
$('#cpPrevM').onclick = () => { cpRef.setMonth(cpRef.getMonth() - 1); renderCronoPOST(); };
$('#cpNextM').onclick = () => { cpRef.setMonth(cpRef.getMonth() + 1); renderCronoPOST(); };
$('#cpAddIdeaBtn').onclick = () => {
    const activeProjectId = $('#cpProjectSelect').value; 
    if (!activeProjectId || activeProjectId === 'all') { showToast('Por favor, selecciona un proyecto específico para añadir una idea.', 'warn'); return; }
    const title = $('#cpNewIdeaInput').value.trim(); if (!title) return;
    if(!S.cronopost.ideas[activeProjectId]) S.cronopost.ideas[activeProjectId] = [];
    S.cronopost.ideas[activeProjectId].push({ id: 'i' + Date.now(), title });
    addIntis(5, 'Idea de contenido');
    save(); renderCronoPOST(); $('#cpNewIdeaInput').value = '';
};
$('#cpGenAIIdeas').onclick = () => {
    const activeProjectId = $('#cpProjectSelect').value;
    if (!activeProjectId || activeProjectId === 'all') { showToast('Selecciona un proyecto para generar ideas con IA.', 'warn'); return; }
    if (!useCredits(CREDIT_COSTS.aiIdeas)) return;
    const projName = S.projects.find(p=>p.id===activeProjectId)?.name || 'tu proyecto';
    showToast('Generando ideas con IA...', 'info');
    setTimeout(()=> {
        const ideas = [`Campaña de "Detrás de Cámaras" para ${projName}`, `Colaboración con influencer de nicho`, `Contenido generado por usuarios (UGC)`];
        ideas.forEach(title => S.cronopost.ideas[activeProjectId].push({ id: 'i' + Date.now(), title }));
        save(); renderCronoPOST();
    }, 1500);
};
wireTabs('#hub', 'htab', 'h-htab');
$('#avatar').onclick = () => $('#avatarInput').click();
$('#avatarInput').onchange = handleAvatarUpload;
$('#savePerfil').onclick = saveProfile;
$('#addMK').onclick = () => {
    if(!useCredits(CREDIT_COSTS.action * 2)) return;
    const name = $('#mkName').value; if (!name) return;
    S.hub.market.push({id:'m'+Date.now(), name, price:Number($('#mkPrice').value||0), desc:$('#mkDesc').value});
    addIntis(20, 'Servicio publicado');
    save(); renderHub();
    ['#mkName', '#mkPrice', '#mkDesc'].forEach(s => $(s).value = '');
};
$('#addJob').onclick = addJob;
$('#jobSearchInput').oninput = renderJobs;
$('#sendGChat').onclick = sendGChatMessage;
$('#gChatMsg').addEventListener('keydown', e => { if (e.key === 'Enter') sendGChatMessage(); });
$('#aiNewChat').onclick=()=>{ showInputModal('Nueva Conversación Global', 'Título de la nueva conversación:', 'Ej: Brainstorming General', t => { const newId = 'c_g_'+Date.now(); S.aiGlobalChat.threads.push({id:newId, title:t}); S.aiGlobalChat.messages[newId] = []; S.aiGlobalChat.activeThread = newId; save(); renderGlobalAIChat();})};
$('#aiSendMsg').onclick = sendGlobalAIChatMessage;
$$('#ai-global-chat .model-card:not(.disabled)').forEach(card => card.onclick = () => { if(card.dataset.model === 'x' && !S.userProfile.isPro) return $('#premiumModal').showModal(); S.aiGlobalChat.model = card.dataset.model; save(); renderGlobalAIChat(); });
$('#aiChatMsg').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendGlobalAIChatMessage(); }});
$('#g_attachFileBtn').onclick = () => $('#g_chatFileInput').click();
$('#aiImageGenBtn').onclick = () => showInputModal('Generar Imagen con IA', 'Describe la imagen que quieres crear:', 'Un gato astronauta en marte', p => { $('#aiChatMsg').value = `Crea una imagen de ${p}`; sendGlobalAIChatMessage(); });
// --- Tab Wiring ---
function wireTabs(scopeSelector, prefix, contentPrefix){
  const root=$(scopeSelector); if (!root) return;
  const quickAddBtn = $('#quickAdd');
  root.querySelectorAll(`.tabs .tab[data-${prefix}]`).forEach(btn=>{
    btn.addEventListener('click',()=>{
      root.querySelectorAll(`.tabs .tab[data-${prefix}]`).forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset[prefix];
      root.querySelectorAll(`[id^="${contentPrefix}-"]`).forEach(p=>p.style.display='none');
      const pane = root.querySelector(`#${contentPrefix}-${target}`);
      if(pane) pane.style.display='block';
      if (scopeSelector === '#projectShell') {
        renderProject(); // Re-render content for the active project tab
      }

      if (quickAddBtn && scopeSelector === '#projectShell') {
        let text = 'Nueva Tarea'; let handler = quickAddTask;
        let isVisible = true;
        switch(target) {
            case 'tasks': text = 'Nueva Tarea'; handler = quickAddTask; break;
            case 'notes': text = 'Nueva Nota'; handler = createNewNote; break;
            case 'tables': text = 'Nueva Tabla'; handler = createNewTable; break;
            case 'finance': text = 'Movimiento'; handler = ()=>{$('#finNew').click()}; break;
            default: isVisible = false;
        }
        quickAddBtn.style.display = isVisible ? 'inline-flex' : 'none';
        quickAddBtn.innerHTML = `<i data-lucide="plus"></i> ${text}`;
        quickAddBtn.onclick = handler;
        lucide.createIcons();
      }
    });
  });
}
init();
</script>
</body>
</html>

