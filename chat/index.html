<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#101010">
    <link rel="manifest" href="manifest.json">
    <title>Goatify IA - Tu Aliado Estrat√©gico en Productividad y Negocios con IA</title>
    <link rel="icon" type="image/png" href="./Logos HD.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/locale/es.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/plugin/localizedFormat.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/plugin/isoWeek.js"></script>

    <style>
        :root {
            --bg-dark: #101010;
            --bg-medium: #1a1a1a;
            --bg-light: #282828;
            --primary: #8a4fff;
            --primary-hover: #7b46e6;
            --text-light: #e5e5e5;
            --text-medium: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
            --gold-color: #FFD700;
            --urgent-color: #ef4444;
            --danger-color: #dc2626;

            --light-bg-dark: #f9f9f9;
            --light-bg-medium: #ffffff;
            --light-bg-light: #f1f1f1;
            --light-primary: #7c40e6;
            --light-primary-hover: #6a37d3;
            --light-text-dark: #1f2937;
            --light-text-medium: #6b7280;
            --light-border-color: rgba(0, 0, 0, 0.09);

            --base-font-size: 14px; /* Made font size slightly smaller */
        }

        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: var(--base-font-size);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .dark-theme {
            --current-bg-dark: var(--bg-dark);
            --current-bg-medium: var(--bg-medium);
            --current-bg-light: var(--bg-light);
            --current-primary: var(--primary);
            --current-primary-hover: var(--primary-hover);
            --current-text-light: var(--text-light);
            --current-text-medium: var(--text-medium);
            --current-border-color: var(--border-color);
            background-color: var(--current-bg-dark);
            color: var(--text-light);
        }

        .light-theme {
            --current-bg-dark: var(--light-bg-dark);
            --current-bg-medium: var(--light-bg-medium);
            --current-bg-light: var(--light-bg-light);
            --current-primary: var(--light-primary);
            --current-primary-hover: var(--light-primary-hover);
            --current-text-light: var(--light-text-dark);
            --current-text-medium: var(--light-text-medium);
            --current-border-color: var(--light-border-color);
            background-color: var(--light-bg-dark);
            color: var(--light-text-dark);
        }

        #sidebar {
            background-color: var(--current-bg-dark);
            border-right: 1px solid var(--current-border-color);
            height: 100vh;
            transition: width 0.3s ease, transform 0.3s ease;
            z-index: 40;
            position: relative;
            display: flex; /* Ensure flex column layout for sidebar content */
            flex-direction: column;
        }
        #sidebar.collapsed {
            width: 80px; /* Adjusted collapsed width to show logo/icon */
            padding: 0;
            overflow: hidden;
        }
        #sidebar.collapsed > *:not(#sidebar-toggle-arrow, #sidebar-header, #sidebar-bottom-fixed, #workflows-container, #actions-category, #user-section) { /* Hide most content when collapsed */
            display: none;
        }
        #sidebar.collapsed #sidebar-header {
            padding-bottom: 0;
            border-bottom: none;
        }
        #sidebar.collapsed #sidebar-top-actions,
        #sidebar.collapsed #sidebar-scrollable-content .flex-grow,
        #sidebar.collapsed #sidebar-footer {
            display: none;
        }

        #sidebar.collapsed #workflows-container .workflow-header .text-sm,
        #sidebar.collapsed #actions-category .actions-header .text-sm,
        #sidebar.collapsed #sidebar-bottom-fixed #user-menu-view span,
        #sidebar.collapsed #sidebar-bottom-fixed #user-menu-view .fas.fa-ellipsis-h
         {
            display: none;
        }
        #sidebar.collapsed .workflow-header,
        #sidebar.collapsed .actions-header,
        #sidebar.collapsed #sidebar-bottom-fixed #user-menu-btn
         {
            justify-content: center;
        }
        #sidebar.collapsed .workflow-header i,
        #sidebar.collapsed .actions-header i,
        #sidebar.collapsed #sidebar-bottom-fixed #user-menu-btn img,
        #sidebar.collapsed #sidebar-bottom-fixed #user-menu-btn i.fa-cog {
            margin-right: 0 !important;
            margin-left: 0 !important;
        }
        #sidebar.collapsed #sidebar-bottom-fixed #user-menu-btn i.fa-cog { /* Ensure settings icon is visible and centered */
            display: block;
        }

        #sidebar-toggle-arrow {
            position: absolute;
            top: 12px; /* Position at the top right */
            right: -12px;
            transform: translateY(0%) rotate(0deg); /* No vertical translation initially, arrow points left initially (expanded state) */
            background-color: var(--current-bg-dark);
            border: 1px solid var(--current-border-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: none; /* Hidden by default, shown on desktop */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 45;
            transition: transform 0.3s ease, left 0.3s ease, right 0.3s ease, top 0.3s ease; /* Added top to transition */
        }
        #sidebar:not(.collapsed) #sidebar-toggle-arrow {
            right: -12px; /* Keep it on the right side when expanded */
            transform: translateY(0%) rotate(0deg); /* Arrow points left when expanded */
        }


        #sidebar-header, #sidebar-bottom-fixed {
            flex-shrink: 0;
            padding: 0.75rem;
        }
        #sidebar-header { border-bottom: 1px solid var(--current-border-color); }
        #sidebar-bottom-fixed { border-top: 1px solid var(--current-border-color); }

        #sidebar-scrollable-content {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
        }
        #sidebar-content-main {
            flex-grow: 1;
        }
        #sidebar-footer {
            flex-shrink: 0;
            margin-top: auto;
            padding-top: 1rem;
        }


        @media (max-width: 767px) {
            #sidebar {
                transform: translateX(-100%);
                position: fixed;
                top: 0;
                left: 0;
                width: 288px;
            }
            #sidebar.is-open {
                transform: translateX(0);
            }
            #sidebar, #sidebar > .flex {
                height: 100vh;
                height: -webkit-fill-available;
            }
            body { --base-font-size: 13.5px; }
            button, .btn-primary {
                padding-top: 0.4rem; padding-bottom: 0.4rem;
                padding-left: 0.75rem; padding-right: 0.75rem;
                font-size: 0.8rem;
            }
            .text-lg { font-size: 1rem; }
            .text-xl { font-size: 1.1rem; }
            .text-2xl { font-size: 1.2rem; }
            .text-3xl { font-size: 1.4rem; }
            #app-container {
                max-height: calc(100vh - 10px);
            }
             #sidebar.collapsed { /* On mobile, when explicitly collapsed by menu button, should hide completely */
                width: 0;
                padding: 0;
                overflow: hidden;
                border-right: none;
            }
            #sidebar.collapsed > * { /* Hide all content when fully collapsed on mobile */
                display: none;
            }
            #sidebar.collapsed #sidebar-toggle-arrow { /* Hide sidebar toggle arrow on mobile */
                display: none;
            }
        }


        #main-chat-area, .modal-content { background-color: var(--current-bg-medium); }
        .chat-bubble-bot, .bg-input, #pdf-preview-container, .chat-item, .project-header, #user-menu-popup, #services-menu { background-color: var(--current-bg-light); }
        .border-themed { border-color: var(--current-border-color); }
        .chat-bubble-user { background-color: var(--current-primary); color: white; }
        .btn-primary { background-color: var(--current-primary); color: white; }
        .btn-primary:hover { background-color: var(--current-primary-hover); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .plan-card-highlight { border-color: var(--current-primary); box-shadow: 0 0 15px rgba(138, 79, 255, 0.3); }
        .placeholder-themed::placeholder { color: var(--current-text-medium); }
        .text-primary, .workflow-header i:not(.workflow-arrow) { color: var(--current-primary) !important; }
        .glowing-mic { animation: pulse 1.5s infinite; color: var(--primary) !important; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(138, 79, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0); }
        }

        .project .project-content { display: none; }
        .project.open > .project-content { display: block; }
        .project.open > .project-header .project-arrow { transform: rotate(90deg); }
        .project-header.drag-over { background-color: var(--current-primary); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        #app-container { height: 100vh; height: -webkit-fill-available; }
        #pricing-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .chat-item.selected-for-delete { background-color: var(--primary) !important; color: white; }

        .model-selector-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .model-selector-wrapper select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
            padding-right: 1.5rem; /* Adjusted for smaller arrow space */
            height: 28px; /* Adjusted height */
            font-size: 0.8rem; /* Adjusted font size */
            line-height: 1.25rem;
            border: none;
            outline: none;
            cursor: pointer;
            min-width: 100px; /* Adjusted min-width */
            background-color: transparent;
        }
         .model-selector-wrapper i {
            position: absolute;
            right: 0.25rem; /* Adjusted position */
            pointer-events: none;
            font-size: 0.6rem; /* Smaller arrow */
        }

        /* Desktop specific styles for input area */
        @media (min-width: 768px) {
            #input-area {
                display: flex;
                flex-direction: column; /* Stack vertically on desktop */
                align-items: flex-start; /* Align items to start */
            }
            #input-area-model-row { /* New ID for the top row (model + tools) */
                display: flex;
                flex-direction: row; /* Horizontal layout for model and file buttons */
                align-items: center;
                justify-content: space-between;
                background-color: var(--current-bg-light);
                padding: 0.25rem 0.5rem; /* Reduced padding */
                border-radius: 0.75rem;
                margin-bottom: 0.75rem;
                width: 100%;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            #model-and-voice-controls { /* New container for model and voice selectors */
                display: flex;
                align-items: center;
                gap: 0.75rem;
                flex-grow: 1;
            }
            #input-area-chat-row { /* New ID for the chat input and mic/send buttons */
                display: flex;
                flex-direction: row; /* Keep horizontal for input row */
                align-items: center;
                background-color: var(--current-bg-light);
                border-radius: 0.75rem;
                padding: 0.5rem;
                width: 100%;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
        }

        /* Mobile specific adjustments to maintain stacked layout */
        @media (max-width: 767px) {
            #input-area-model-row {
                display: flex;
                flex-direction: column; /* Stack vertically on mobile */
                align-items: flex-start;
                background-color: var(--current-bg-light);
                padding: 0.5rem;
                border-radius: 0.75rem;
                margin-bottom: 0.75rem;
                width: 100%;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            #model-and-voice-controls {
                 width: 100%; /* Make model selector take full width */
                 margin-bottom: 0.5rem; /* Add space below model selector */
                 flex-direction: column;
                 align-items: flex-start;
            }
             #model-and-voice-controls .model-selector-wrapper {
                 width: 100%;
             }
            #input-area-model-row .action-buttons-container {
                width: 100%; /* Make action buttons take full width */
                justify-content: space-around; /* Distribute buttons */
            }
            #input-area-chat-row {
                display: flex;
                flex-direction: row; /* Keep horizontal for input row */
                align-items: center;
                background-color: var(--current-bg-light);
                border-radius: 0.75rem;
                padding: 0.5rem;
                width: 100%;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
        }

        #input-area-model-row .model-selector-wrapper {
            flex-grow: 1;
            min-width: 0;
        }
        #input-area-model-row .action-buttons-container {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        #input-area-chat-row .input-wrapper {
            background-color: transparent;
            padding: 0;
        }


        .workflow-category.open .workflow-content, .actions-category.open .actions-content, .folders-category.open .folders-content { display: block; }
        .workflow-category.open .workflow-arrow, .actions-category.open .actions-arrow, .folders-category.open .folder-arrow { transform: rotate(90deg); }
        .workflow-content, .actions-content, .folders-content { display: none; }

        .plan-card { background-color: var(--current-bg-light); }
        #pdf-preview-container { padding: 0.5rem; }

        @keyframes sweep {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(200%) skewX(-15deg); }
        }
        .cool-light-effect { position: relative; overflow: hidden; }
        .cool-light-effect::before {
            content: '';
            position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(138, 79, 255, 0.25) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-150%) skewX(-15deg); transition: transform 0.8s ease;
            pointer-events: none;
        }
        .cool-light-effect:hover::before { animation: sweep 2s infinite linear; }

        .input-wrapper { border: 1px solid transparent; transition: box-shadow 0.3s ease, border-color 0.3s ease; }
        .input-wrapper:focus-within { box-shadow: 0 0 10px 0px rgba(138, 79, 255, 0.5); border-color: var(--current-primary-hover); }

        #chat-title {
            color: var(--primary);
            font-weight: 700;
            transition: color 0.3s ease;
        }
        #desktop-chat-title-wrapper:hover #chat-title {
            color: var(--primary-hover);
        }

        #desktop-chat-title-wrapper {
            position: relative;
            cursor: pointer;
        }
        #desktop-chat-title-wrapper .edit-icon {
            opacity: 0;
            transition: opacity 0.2s;
            margin-right: 8px;
        }
        #desktop-chat-title-wrapper:hover .edit-icon {
            opacity: 1;
        }
        #mobile-chat-title-wrapper .edit-icon {
            margin-right: 8px;
        }

        .btn-disabled { background-color: #3a3a3a !important; color: #888 !important; cursor: not-allowed !important; border-color: #3a3a3a !important;}

        .chat-item.selected-chat {
            background-color: var(--current-primary);
            color: white !important;
        }
        .chat-item.selected-chat .text-sm {
            color: white !important;
        }
        .light-theme .chat-item {
            color: var(--light-text-dark);
        }

        /* Calendar styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day {
            padding: 2px;
            border-radius: 4px;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            transition: background-color 0.2s ease, border 0.2s ease;
            position: relative;
            border: 2px solid transparent;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .calendar-day-number {
            font-weight: bold;
            font-size: 0.8rem;
            margin: 4px;
            align-self: flex-start;
        }
        .calendar-day-tasks {
            flex-grow: 1;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 0 2px 2px 2px;
        }
        .calendar-day-task {
            font-size: 0.65rem;
            padding: 2px 4px;
            border-radius: 4px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
            position: relative;
        }
        .calendar-day-task .delete-task-icon {
            display: none;
            position: absolute;
            right: 1px;
            top: 1px;
            color: white;
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 14px;
            height: 14px;
            font-size: 8px;
            line-height: 14px;
            text-align: center;
        }
        .calendar-day-task:hover .delete-task-icon {
            display: block;
        }

        .calendar-day:hover {
            background-color: var(--current-bg-light);
        }
        .calendar-day.current-month {
            color: var(--current-text-light);
        }
        .calendar-day.other-month {
            color: var(--current-text-medium);
            opacity: 0.5;
        }
        .calendar-day.today .calendar-day-number {
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 2px;
        }
        .task-dots-container {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
        }
        .task-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-item-completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .notification-bell-icon {
            position: relative;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7em;
            line-height: 1;
            min-width: 18px;
            text-align: center;
        }

        .calendar-view-toggle, .project-view-controls {
            display: flex;
            gap: 0.5rem;
            background-color: var(--current-bg-dark);
            padding: 0.25rem;
            border-radius: 8px;
            width: 100%;
        }

        .calendar-view-toggle button, .project-view-controls button {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            font-weight: 600;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
            white-space: nowrap; /* Prevents text wrapping */
        }
        .calendar-view-toggle button.active, .project-view-controls button.active {
            background-color: var(--current-primary);
            color: white;
            box-shadow: 0 0 8px rgba(138, 79, 255, 0.4);
        }
        .calendar-view-toggle button:hover:not(.active), .project-view-controls button:hover:not(.active) {
            background-color: var(--current-bg-medium);
        }
        .dark-theme .project-view-controls button:not(.active) {
            color: var(--current-text-light);
        }
        .light-theme .project-view-controls button:not(.active) {
            color: var(--current-text-dark);
        }

        #month-view-container, #day-view-container {
            display: block;
        }
        #week-view-container, #day-view-container {
            display: none;
        }
        #week-view-container, #day-view-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--current-border-color);
            border-radius: 8px;
            padding: 10px;
        }
        .week-day-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--current-border-color);
        }
        .week-day-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .week-day-section h5 {
            font-weight: 700;
            color: var(--current-primary);
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .week-day-section .task-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 0;
        }

        .day-view-timeline {
            position: relative;
        }
        .day-view-hour {
            display: flex;
            border-top: 1px solid var(--current-border-color);
        }
        .day-view-hour-label {
            width: 60px;
            flex-shrink: 0;
            text-align: right;
            padding-right: 10px;
            font-size: 0.75rem;
            color: var(--current-text-medium);
        }
        .day-view-hour-content {
            flex-grow: 1;
            border-left: 1px solid var(--current-border-color);
            padding: 5px;
            min-height: 40px;
            position: relative;
        }
        .add-task-to-time-btn {
            position: absolute;
            right: 5px;
            top: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .day-view-hour-content:hover .add-task-to-time-btn {
            opacity: 1;
        }

        /* Project, Financial & Notepad View Styles */
        #project-management-view, #financial-assistant-view, #notepad-view-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: 100%;
            position: relative;
            flex: 1;
            overflow: hidden;
        }

        #project-board-container, #financial-tools-container, #notepad-editor-and-chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        #project-chat-container, #financial-chat-container, #notepad-chat-container {
            display: flex;
            flex-direction: column;
            border-top: 1px solid var(--current-border-color);
            padding-top: 1rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
            background-color: var(--current-bg-medium);
        }
        #project-chat-container.collapsed, #financial-chat-container.collapsed, #notepad-chat-container.collapsed {
            flex-grow: 0;
            flex-basis: auto;
            height: 50px !important;
        }

        #project-chat-container .project-chat-body,
        #financial-chat-container .financial-chat-body,
        #notepad-chat-container .notepad-chat-body {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        #project-chat-container.collapsed .project-chat-body,
        #financial-chat-container.collapsed .financial-chat-body,
        #notepad-chat-container.collapsed .notepad-chat-body {
            display: none;
        }

        #project-chat-toggle i, #financial-chat-toggle i, #notepad-chat-toggle i {
            transition: transform 0.3s ease;
        }
        #project-chat-container:not(.collapsed) #project-chat-toggle i,
        #financial-chat-container:not(.collapsed) #financial-chat-toggle i,
        #notepad-chat-container:not(.collapsed) #notepad-chat-toggle i {
            transform: rotate(180deg);
        }

        #project-chat-messages, #financial-chat-messages, #notepad-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        #kanban-view {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            overflow: hidden;
            flex-grow: 1;
        }

        .kanban-column {
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-width: 0; /* Allow columns to shrink */
        }
        .kanban-column-title {
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--current-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-cards {
            flex-grow: 1;
            min-height: 100px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .kanban-card {
            background-color: var(--current-bg-medium);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            border-left: 4px solid var(--current-primary);
            position: relative;
        }
        .kanban-card .delete-task-icon {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
            color: var(--current-text-medium);
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            line-height: 18px;
            text-align: center;
        }
        .kanban-card .delete-task-icon:hover {
            background-color: var(--danger-color);
            color: white;
            transform: scale(1.1);
        }
        .kanban-card:hover .delete-task-icon {
            display: block;
        }
        .kanban-card.urgent {
            border-left-color: var(--urgent-color);
        }
        .kanban-card:active {
            cursor: grabbing;
            background-color: var(--primary);
        }
        .kanban-card p {
            font-weight: 500;
            padding-right: 20px; /* Space for delete icon */
        }
        .kanban-card .card-footer {
            font-size: 0.75rem;
            color: var(--current-text-medium);
            margin-top: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-cards.drag-over {
            border: 2px dashed var(--current-primary);
            background-color: rgba(138, 79, 255, 0.1);
        }

        /* List View Styles */
        #list-view {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-grow: 1;
        }
        .list-view-header {
            display: grid;
            grid-template-columns: 1fr 150px 80px 120px 40px;
            gap: 1rem;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid var(--current-border-color);
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--current-text-medium);
            flex-shrink: 0;
        }
        .list-view-content {
             overflow-y: auto;
             flex-grow: 1;
        }
        .list-view-task {
            display: grid;
            grid-template-columns: 1fr 150px 80px 120px 40px;
            gap: 1rem;
            align-items: center;
            padding: 0.25rem 1rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        .list-view-task input[type="date"], .list-view-task input[type="time"] {
                background: transparent;
                border: none;
                border-radius: 4px;
                padding: 2px 4px;
                font-size: 0.8rem;
                width: auto;
                color: var(--current-text-light);
                color-scheme: dark;
        }
        .light-theme .list-view-task input { color-scheme: light; color: var(--light-text-dark); }
        .list-view-task:hover {
            background-color: var(--current-bg-light);
        }
        .list-view-task.task-item-completed .task-content-list {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .task-content-list.urgent {
            font-weight: 600;
            color: var(--urgent-color);
        }
        .task-content-list input {
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
        }
        .task-content-list input:focus {
             background-color: var(--current-bg-dark);
        }
        .priority-cell {
            text-align: center;
            cursor: pointer;
        }

        .task-labels {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .task-label {
            padding: 2px 8px;
            font-size: 0.7rem;
            border-radius: 12px;
            font-weight: 600;
        }
        #project-tag-filter-container {
            position: relative;
        }
        #tag-filter-dropdown {
            position: absolute;
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Gamification Styles */
        #gamification-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .gamification-tabs { border-bottom: 2px solid var(--current-border-color); }
        .gamification-tab { padding: 0.75rem 1rem; font-weight: 600; color: var(--current-text-medium); cursor: pointer; border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; }
        .gamification-tab.active { color: var(--current-primary); border-color: var(--current-primary); }
        .xp-bar-bg { background-color: var(--current-bg-light); }
        .xp-bar-fill { background-color: var(--current-primary); transition: width 0.5s ease-out; }
        .level-badge { background-color: var(--current-primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; }
        .streak-day { background-color: var(--current-bg-light); border: 2px solid var(--current-border-color); transition: all 0.2s ease; }
        .streak-day.active { border-color: var(--current-primary); transform: scale(1.05); box-shadow: 0 0 10px rgba(138, 79, 255, 0.5); }
        .streak-day.completed { background-color: var(--current-primary); color: white; border-color: var(--current-primary); }
        .streak-day .fa-gift { color: var(--gold-color); }
        .mission-item.completed { opacity: 0.5; text-decoration: line-through; }
        .mission-item.completed .btn-primary { background-color: #4CAF50; cursor: default; }
        .achievement-badge { border: 2px solid var(--current-border-color); filter: grayscale(100%); opacity: 0.6; transition: all 0.3s ease; }
        .achievement-badge.unlocked { border-color: var(--gold-color); filter: grayscale(0%); opacity: 1; box-shadow: 0 0 15px var(--gold-color); }
        .achievement-badge.unlocked .fa-medal { color: var(--gold-color); }
        .text-gold { color: var(--gold-color); }

        /* Pricing Modal Enhancements */
        .plan-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .plan-details.open {
            max-height: 500px; /* Adjust as needed */
        }
        .plan-feature-list {
            list-style-position: inside;
        }
        .plan-feature-list li {
            padding-left: 1em;
            text-indent: -1em;
        }
        .plan-feature-list .fa-check-circle {
            color: var(--primary);
        }

        /* NEW Financial Assistant Styles */
        #financial-tools-container {
             padding: 1rem;
             gap: 1rem;
             overflow-y: auto;
        }
        .finance-section {
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
        }
        .finance-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        .finance-section-header h3 {
            font-size: 1.125rem;
            font-weight: 700;
        }
        .finance-category {
            margin-top: 1rem;
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
        }
        .finance-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .finance-category-header .finance-category-name-input {
            background: transparent;
            border: none;
            outline: none;
            font-weight: bold;
            width: 70%;
            color: var(--current-text-light);
        }
        .finance-category-content {
            padding: 0.75rem;
        }
        .finance-item-row {
            display: grid;
            grid-template-columns: 1fr 100px 40px;
            gap: 0.75rem;
            align-items: center;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--current-border-color);
        }
        .finance-item-row:last-child {
            border-bottom: none;
        }
        .finance-item-row input {
            background: transparent;
            border: none;
            padding: 0.25rem;
            width: 100%;
            outline: none;
            color: var(--current-text-light);
        }
        .finance-item-row input:focus {
            background-color: var(--current-bg-dark);
            border-radius: 4px;
        }
        .finance-summary {
            background-color: var(--current-bg-light);
            border-radius: 0.5rem;
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            text-align: center;
        }
        .finance-summary h4 {
            font-size: 0.8rem;
            color: var(--current-text-medium);
        }
        .finance-summary p {
            font-size: 1.25rem;
            font-weight: 700;
        }
        #total-income { color: #22c55e; }
        #total-expenses { color: #ef4444; }

        /* Notepad View */
        #notepad-view-container {
            display: none; /* Hidden by default */
            padding: 0; /* No padding on main container */
            flex-direction: column; /* Organiza el toolbar y el resto verticalmente */
        }

        #notes-list-panel {
            flex-shrink: 0; /* El panel no debe encogerse */
            padding: 0.5rem;
            border-bottom: 1px solid var(--current-border-color);
        }

        #notepad-editor-and-chat-container {
            display: flex;
            flex-direction: row;
            flex-grow: 1;
            gap: 1rem;
            padding: 1rem;
            min-height: 0;
        }
        #notes-list {
            display: none; /* La lista interna ya no es necesaria aqu√≠ */
        }
        .note-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background-color: var(--current-bg-medium);
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
            display: block; /* Asegurarse de que las etiquetas 'a' se comporten como bloques */
            color: var(--current-text-light); /* Heredar color de texto */
            text-decoration: none; /* Quitar subrayado de los links */
        }
        .note-item:hover {
            background-color: var(--current-bg-dark);
            border-left-color: var(--current-primary-hover);
        }
        .note-item.active {
            background-color: var(--current-primary);
            color: white !important;
            font-weight: bold;
            border-left-color: var(--gold-color);
        }
        .note-item.active * {
            color: white !important;
        }
        #note-editor-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        #note-editor-toolbar {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--current-border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            background-color: var(--current-bg-medium);
        }
         #note-editor-toolbar button, .drawing-tool {
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.375rem;
            padding: 0.4rem 0.6rem;
            transition: all 0.2s ease;
        }
         #note-editor-toolbar button:hover, .drawing-tool:hover {
            background-color: var(--current-bg-dark);
            border-color: var(--current-primary);
        }
        #note-editor-toolbar button.active {
            background-color: var(--current-primary);
            color: white;
            border-color: var(--current-primary);
        }
        .drawing-tool[type="color"] {
             padding: 0.2rem;
             min-width: 36px;
             height: 36px;
        }
        #note-title-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            outline: none;
            font-size: 1.1rem; /* Reduced font size */
            font-weight: bold;
            padding: 0.5rem 0.75rem; /* Reduced padding */
            border-bottom: 1px solid var(--current-border-color);
        }
        #note-content-area {
            position: relative;
            flex-grow: 1;
        }
        #note-content-editor {
            flex-grow: 1;
            width: 100%;
            height: 100%;
            background-color: transparent;
            color: var(--current-text-light);
            border: none;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            resize: none;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap; /* Ensure line breaks are respected */
        }
        #note-content-editor:focus-within {
            box-shadow: none;
        }
        .checklist-item {
            display: flex;
            align-items: flex-start; /* Align items to the top for multi-line text */
            gap: 0.75rem; /* Space between checkbox and text */
            margin: 0.5rem 0;
        }
        .checklist-item input[type="checkbox"] {
            width: 1.15em;
            height: 1.15em;
            accent-color: var(--current-primary);
            cursor: pointer;
            flex-shrink: 0; /* Prevent checkbox from shrinking */
            margin-top: 0.2em; /* Adjust vertical alignment of checkbox */
        }
        .checklist-item-text {
            flex-grow: 1;
            outline: none;
            min-height: 1.15em; /* Ensure text area has minimum height */
            padding-top: 0.2em; /* Align text with checkbox visually */
            padding-bottom: 0.2em;
            word-wrap: break-word; /* Allow text to wrap within the span */
        }
        .checklist-item-text[data-checked="true"] {
            text-decoration: line-through;
            opacity: 0.6;
        }
        #note-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--light-bg-medium); /* Or a translucent background for dark theme */
            cursor: crosshair;
            touch-action: none; /* Prevents browser gestures like scroll/zoom on canvas for better touch drawing */
        }
        #notes-list-toggle {
            position: absolute;
            top: 12px; /* Adjusted to match sidebar toggle */
            right: -12px; /* Half of width to position it outside */
            transform: translateY(0%) rotate(0deg); /* Initial state when expanded */
            background-color: var(--current-bg-dark);
            border: 1px solid var(--current-border-color);
            border-radius: 50%;
            padding: 4px;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.3s ease;
        }
        #notes-list-panel:not(.collapsed) #notes-list-toggle {
            transform: translateY(0%) rotate(0deg); /* Arrow points left when list is open */
        }
        #notes-list-panel.collapsed #notes-list-toggle {
            transform: translateY(0%) rotate(180deg); /* Arrow points right when list is collapsed */
        }
        /* New styles for text editor controls */
        .text-editor-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .text-editor-controls button {
            padding: 0.4rem 0.6rem;
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            cursor: pointer;
        }
        .text-editor-controls button:hover {
            background-color: var(--current-bg-dark);
            border-color: var(--current-primary);
        }
        .text-editor-controls button.active {
            background-color: var(--current-primary);
            color: white;
            border-color: var(--current-primary);
        }
        .drawing-tool.active {
            background-color: var(--current-primary);
            color: white;
            border-color: var(--current-primary);
        }


        /* In-app notification */
        #in-app-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-200%);
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            padding: 1rem;
            border-radius: 0.75rem;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            border: 1px solid var(--current-border-color);
            max-width: 90%;
            width: 400px;
            opacity: 0;
            pointer-events: none;
            cursor: pointer;
        }
        #in-app-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        #in-app-notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        #in-app-notification-header h4 {
            font-weight: bold;
        }

        @keyframes glowing {
            0% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px var(--primary), 0 0 20px var(--primary); }
            50% { text-shadow: 0 0 10px #fff, 0 0 20px var(--primary), 0 0 30px var(--primary), 0 0 40px var(--primary); }
            100% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px var(--primary), 0 0 20px var(--primary); }
        }

        .task-notification-content .glowing-text {
            animation: glowing 1.5s ease-in-out infinite;
        }


        /* Desktop specific styles */
        @media (min-width: 768px) {
            #sidebar-toggle-arrow {
                display: flex;
            }
            #sidebar.collapsed {
                width: 80px;
            }
            #sidebar:not(.collapsed) {
                width: 288px;
            }

            #services-menu {
                opacity: 0;
                visibility: hidden;
                transform: scale(0.95) translateY(-10px);
                transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
            }
            #services-menu.show {
                opacity: 1;
                visibility: visible;
                transform: scale(1) translateY(0);
            }
            #project-management-view, #financial-assistant-view {
                display: flex;
                flex-direction: row;
            }
             #notepad-editor-and-chat-container {
                flex-direction: row;
            }

            #notes-list-toggle {
                display: block; /* Show toggle on desktop */
            }


            #project-chat-container, #financial-chat-container, #notepad-chat-container {
                display: flex;
                border-left: 1px solid var(--current-border-color);
                border-top: none;
                padding-left: 1rem;
                padding-top: 0;
                height: 100%;
                flex-basis: 40%;
                flex-shrink: 0;
                flex-direction: column;
            }
            #project-chat-container.collapsed, #financial-chat-container.collapsed, #notepad-chat-container.collapsed {
                flex-basis: 50px;
                height: 100% !important;
            }
            #project-chat-container-header, #financial-chat-header, #notepad-chat-header { cursor: pointer; }

            #project-chat-container.collapsed .project-chat-body,
            #project-chat-container.collapsed #project-chat-container-header h3,
            #financial-chat-container.collapsed .financial-chat-body,
            #financial-chat-container.collapsed #financial-chat-header h3,
            #notepad-chat-container.collapsed .notepad-chat-body,
            #notepad-chat-container.collapsed #notepad-chat-header h3 {
                display: none;
            }

            #project-chat-container.collapsed #project-chat-toggle,
            #financial-chat-container.collapsed #financial-chat-toggle,
            #notepad-chat-container.collapsed #notepad-chat-toggle {
                transform: rotate(90deg);
                justify-content: center;
            }
            #project-chat-container.collapsed #project-chat-toggle i,
            #financial-chat-container.collapsed #financial-chat-toggle i,
            #notepad-chat-container.collapsed #notepad-chat-toggle i {
                 transform: rotate(180deg);
            }
        }

        /* Mobile specific adjustments */
        @media (max-width: 767px) {
            #mobile-chat-title-wrapper .edit-icon, #mobile-chat-title-wrapper #motivation-btn-mobile {
                display: inline-block;
            }
             #desktop-chat-title-wrapper .edit-icon, #desktop-chat-title-wrapper #motivation-btn-header {
                display: none;
            }
            #calendar-modal {
                padding: 0.5rem;
                max-width: 98vw;
                max-height: 95vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            #calendar-modal > div:not(:first-child) {
                overflow-y: auto;
            }

            .header-left-icons {
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 0;
            }
             .header-left-icons > * {
                padding: 0.3rem;
            }
            .header-right-icons {
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 0;
            }
            .header-right-icons > * {
                padding: 0.3rem;
            }
            #desktop-chat-title-wrapper { display: none; }
            #main-header-content {
                display: flex;
                align-items: center;
                justify-content: space-between;
                width: 100%;
                gap: 0.5rem;
            }
            #main-header-content > * {
                flex-basis: 33.33%;
            }
            #main-header-content .header-left-icons { justify-content: flex-start; }
            #main-header-content .header-right-icons { justify-content: flex-end; }
            #main-header-content #message-counter-wrapper { text-align: center; }


             #file-preview-area {
                display: none; /* Only show when there is a file */
             }
             #image-preview-container {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                max-height: 45px;
                flex-shrink: 1;
            }
            #image-preview {
                max-height: 45px;
                width: auto;
                border-radius: 0.25rem;
            }
            #input-area {
                display: flex;
                flex-direction: column;
            }

            /* Mobile chat containers */
            #project-chat-container, #financial-chat-container, #notepad-chat-container {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 50px;
                overflow: hidden;
                border-top: 1px solid var(--current-border-color);
                z-index: 10;
                transition: height 0.3s ease;
                max-height: calc(100vh - 120px);
            }
            #project-chat-container:not(.collapsed),
            #financial-chat-container:not(.collapsed),
            #notepad-chat-container:not(.collapsed) {
                 height: 100%;
            }
            #project-chat-container .project-chat-body,
            #financial-chat-container .financial-chat-body,
            #notepad-chat-container .notepad-chat-body {
                height: calc(100% - 50px);
                display: flex;
                flex-direction: column;
            }

            #kanban-view {
                grid-template-columns: repeat(3, 1fr);
                overflow-y: auto;
                overflow-x: hidden;
                gap: 0.4rem;
                padding-bottom: 50px;
            }
            .kanban-column {
                min-width: 0;
                padding: 0.4rem;
            }
            .kanban-column-title { font-size: 0.7rem; }
            .kanban-card { padding: 0.4rem; }
            .kanban-card p { font-weight: normal; font-size: 0.7rem; }

            #list-view-mobile {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                 padding-bottom: 50px;
                 overflow-y: auto;
                 flex-grow: 1;
            }
            .list-view-task-mobile { background-color: var(--current-bg-light); padding: 0.75rem; border-radius: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
            .list-view-task-mobile-header { display: flex; align-items: flex-start; gap: 0.75rem; }
            .list-view-task-mobile-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--current-border-color); padding-top: 0.5rem; font-size: 0.75rem; }
            .list-view-task-mobile-footer input[type="time"], .list-view-task-mobile-footer input[type="date"] {
                background: var(--current-bg-dark);
                border: none;
                border-radius: 4px;
                padding: 2px 4px;
                font-size: 0.7rem;
                width: auto;
                color-scheme: dark;
            }
            .light-theme .list-view-task-mobile-footer input[type="time"], .light-theme .list-view-task-mobile-footer input[type="date"] {
                 color-scheme: light;
            }

            /* Notepad Mobile Optimization */
            #notepad-view-container {
                flex-direction: column;
                padding: 0;
                height: 100%;
            }
            #notepad-editor-and-chat-container {
                flex-direction: column;
                padding: 0.5rem;
                height: 100%;
                gap: 0.5rem;
            }
            #notepad-view-container.mobile-editor-active #notes-list-panel {
                display: none;
            }
            #notepad-view-container:not(.mobile-editor-active) #notepad-editor-and-chat-container {
                display: none;
            }
            #notes-list-panel {
                width: 100%;
                height: auto; /* Ajustar altura autom√°ticamente */
                border-radius: 0;
            }
            #note-editor-panel {
                height: 100%;
            }
            #note-back-btn {
                display: inline-block; /* Show back button on mobile */
            }
            #notepad-chat-container {
                position: relative;
                height: 100% !important; /* Full height on mobile */
                max-height: 100% !important;
            }
            #notepad-chat-container:not(.collapsed) {
                 height: 100% !important; /* Forces full height when not collapsed */
                 max-height: 100% !important;
            }
            #notepad-chat-container .notepad-chat-body {
                height: calc(100% - 50px) !important; /* Adjusted to take full remaining height */
            }


            #services-menu {
                position: fixed;
                opacity: 0;
                visibility: hidden;
                transform: scale(0.95) translateY(-10px);
                transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
                width: 90vw;
                max-width: 320px;
                top: 60px;
                right: 10px;
                max-height: calc(100vh - 80px);
                overflow-y: auto;
                z-index: 50;
            }
            #services-menu.show {
                opacity: 1;
                visibility: visible;
                transform: scale(1) translateY(0);
            }

            .calendar-view-toggle button { padding: 6px 4px; font-size: 0.75rem; }
            .project-view-controls { width: fit-content; flex-grow: 0; }
            .project-view-controls button { padding: 6px 8px; font-size: 0.75rem; flex-grow: 0; }

            #gamification-modal .modal-content { padding: 1rem; }
            #gamification-modal h2 { font-size: 1.25rem; }
            .streak-day .text-lg { font-size: 0.8rem; }
            .streak-day .text-2xl { font-size: 1.1rem; }
            .streak-day .text-xs { font-size: 0.6rem; }
            .mission-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .mission-item .btn-primary { padding: 0.25rem 0.5rem; font-size: 0.75rem; align-self: flex-end; }
            #achievements-container { gap: 0.5rem; }
            .achievement-badge { padding: 0.5rem; font-size: 0.7rem; }
            .achievement-badge .fa-3x { font-size: 1.75em; }

            /* Mobile chat item icons always visible */
            .chat-item .chat-item-actions {
                opacity: 1 !important;
            }
            #notes-list-panel.collapsed #notes-list-toggle { /* Hide notepad toggle on mobile, regardless of state */
                display: none;
            }
        }

        /* Mobile Landscape */
        @media (max-height: 500px) and (orientation: landscape) {
            #sidebar.is-open #sidebar-scrollable-content {
                 overflow-y: auto;
                 height: 100%;
            }
            #main-chat-area, #project-management-view, #financial-assistant-view, #notepad-view-container {
                overflow-y: auto;
            }
            #chat-messages {
                padding: 0.5rem;
                flex-grow: 1;
            }
            #kanban-view {
                grid-template-columns: repeat(3, minmax(250px, 1fr));
                overflow-x: auto;
            }
            .modal-content { max-height: 95vh; overflow-y: auto; }
            #input-area { padding: 0.5rem; flex-shrink: 0; }
            .pro-controls-bg { padding: 0.25rem; }
            #msg { height: 3rem !important; max-height: 3rem; }
        }

        /* Motivation Modal Shimmer Effect */
        #motivation-quote.shimmer-text {
            position: relative;
            overflow: hidden;
        }
        #motivation-quote.shimmer-text::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            animation: shimmer 2.5s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes shimmer {
            0% { transform: translateX(-150%) skewX(-15deg); }
            100% { transform: translateX(250%) skewX(-15deg); }
        }

        .dark-theme #message-counter-wrapper span {
            color: white;
        }

        .light-theme #message-counter-wrapper span {
            color: black;
        }
        .speaker-icon {
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 8px;
            display: inline-block;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .speaker-icon:hover {
            opacity: 1;
        }
        /* Make chat items links for right-click functionality */
        .chat-item, .note-item {
            display: block;
            text-decoration: none;
        }
        .chat-item, a.chat-item:hover, .note-item, a.note-item:hover {
            color: var(--current-text-light);
        }
        .light-theme .chat-item, .light-theme a.chat-item:hover, .light-theme .note-item, .light-theme a.note-item:hover {
            color: var(--light-text-dark);
        }
        /* New style for add to folder dropdown */
        .add-to-folder-dropdown {
            position: absolute;
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            min-width: 150px;
        }
        .add-to-folder-dropdown button {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            text-align: left;
            transition: background-color 0.2s ease;
        }
        .add-to-folder-dropdown button:hover {
            background-color: var(--current-bg-medium);
        }

        /* HTML Preview Modal Styles */
        #html-preview-modal .modal-content {
            padding: 0;
            width: 90%; /* Adjust width */
            max-width: 900px; /* Max width */
            height: 90%; /* Adjust height */
            max-height: 600px; /* Max height */
        }
        #html-preview-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--current-border-color);
            background-color: var(--current-bg-light);
            border-radius: 0.75rem 0.75rem 0 0;
        }
        #html-preview-modal .modal-header h3 {
            margin: 0;
        }
        #html-preview-modal .modal-header button {
            background: none;
            border: none;
            color: var(--current-text-light);
            font-size: 1.5rem;
            cursor: pointer;
        }
        #html-preview-iframe {
            flex-grow: 1;
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }
        #preview-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background-color: var(--current-bg-light);
            border-radius: 0 0 0.75rem 0.75rem;
            border-top: 1px solid var(--current-border-color);
        }
        
        #contextual-footer {
            text-align: center;
        }

    </style>
    <meta name="description" content="Goatify IA es tu copiloto estrat√©gico, una inteligencia artificial avanzada que combina direcci√≥n de proyectos, asistente financiero, y herramientas creativas √∫nicas en el mercado para potenciar tu negocio y productividad.">
    <meta name="keywords" content="Goatify IA, inteligencia artificial, direcci√≥n de proyectos, asistente financiero, productividad, automatizaci√≥n de ventas, estrategias de marketing, creaci√≥n de contenido, SEO, herramientas de IA, negocio digital">
    <meta name="author" content="Goatify IA Team">
    <meta property="og:title" content="Goatify IA - Tu Aliado Estrat√©gico en Productividad y Negocios con IA">
    <meta property="og:description" content="Goatify IA es tu copiloto estrat√©gico, una inteligencia artificial avanzada que combina direcci√≥n de proyectos, asistente financiero, y herramientas creativas √∫nicas en el mercado para potenciar tu negocio y productividad.">
    <meta property="og:image" content="./Logos HD.png">
    <meta property="og:url" content="https://www.goatify.app">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Goatify IA - Tu Aliado Estrat√©gico en Productividad y Negocios con IA">
    <meta name="twitter:description" content="Goatify IA es tu copiloto estrat√©gico, una inteligencia artificial avanzada que combina direcci√≥n de proyectos, asistente financiero, y herramientas creativas √∫nicas en el mercado para potenciar tu negocio y productividad.">
    <meta name="twitter:image" content="./Logos HD.png">
</head>
<body class="w-screen overflow-x-hidden dark-theme">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script type="text/javascript">
        if (window.netlifyIdentity) {
            netlifyIdentity.init();
        }
    </script>
    <div id="loading-overlay" class="fixed inset-0 bg-bg-dark bg-opacity-95 flex flex-col items-center justify-center z-[100] transition-opacity duration-300">
        <img src="./Logos HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mb-6 animate-pulse" onerror="this.onerror=null;this.src='https://placehold.co/96x96/121212/e0e0e0?text=LOGO';">
        <div class="text-text-light text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3 text-lg font-semibold" data-translate-key="initializing">Inicializando...</p>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden opacity-0 pointer-events-none"></div>

    <div id="app-container" class="flex w-full relative opacity-0 transition-opacity duration-300">
        <aside id="sidebar" class="w-72 flex-shrink-0 flex flex-col transition-transform duration-300 md:translate-x-0 h-full">

            <div id="sidebar-header">
                <div id="logo-space" class="w-16 h-16 rounded-lg mx-auto flex-shrink-0 flex items-center justify-center overflow-hidden cursor-pointer">
                    <img src="./Logos HD.png" alt="Goatify Logo" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                </div>
            </div>

            <div class="flex-shrink-0 px-4 pt-2 pb-4 border-b border-themed">
                 <div class="mb-4">
                    <h3 class="text-xs font-semibold uppercase text-text-medium mb-2 px-2" data-translate-key="workflows">Workflows</h3>
                    <div id="sidebar-top-actions" class="space-y-2">
                        <button data-workflow="project-management" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                            <i class="fas fa-tasks w-6 mr-2"></i>
                           <span class="text-sm font-bold" data-translate-key="wf_pm">Asistente de Proyectos</span>
                       </button>
                       <button data-workflow="financial-assistant" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                            <i class="fas fa-wallet w-6 mr-2"></i>
                           <span class="text-sm font-bold" data-translate-key="wf_financial">Asistente Financiero</span>
                       </button>
                        <button data-workflow="notepad-app" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                            <i class="fas fa-book-open w-6 mr-2"></i>
                           <span class="text-sm font-bold" data-translate-key="wf_notepad">Bloc de Notas</span>
                       </button>
                   </div>
                </div>
            </div>

            <div id="sidebar-scrollable-content">
                <div id="sidebar-content-main" class="flex flex-col">
                    <div class="flex-grow">
                        <div class="mb-4">
                             <div id="workflows-container" class="space-y-1">
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-brain w-6 mr-2"></i>
                                        <span class="text-sm font-bold" data-translate-key="wf_expert">Asistente Experto</span>
                                    </div>
                                     <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="decision-lab" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_expert_1">Laboratorio de Decisiones</button>
                                        <button data-workflow="conflict-resolution" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_expert_2">Resoluci√≥n de Conflictos</button>
                                     </div>
                                </div>
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-share-alt w-6 mr-2"></i>
                                        <span class="text-sm font-bold" data-translate-key="wf_social">Potenciador de Redes Sociales</span>
                                     </div>
                                    <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="create-full-post" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_1">Crear un Post Completo</button>
                                         <button data-workflow="persuasive-copy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_2">Redacci√≥n de Copys</button>
                                        <button data-workflow="post-ideas" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_3">Lluvia de Ideas para Posts</button>
                                         <button data-workflow="brand-strategy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_4">Definir Estrategia de Marca</button>
                                    </div>
                                </div>
                                 <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-chart-pie w-6 mr-2"></i>
                                        <span class="text-sm font-bold" data-translate-key="wf_business">An√°lisis de Negocio</span>
                                    </div>
                                     <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="competitor-analysis" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_1">An√°lisis de tu Competencia</button>
                                         <button data-workflow="buyer-persona" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_2">Definir mi Cliente Ideal</button>
                                        <button data-workflow="brand-names" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_3">Lluvia de Nombres para Marca</button>
                                     </div>
                                </div>
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-headset w-6 mr-2"></i>
                                        <span class="text-sm font-bold" data-translate-key="wf_sales">Comunicaci√≥n y Ventas</span>
                                     </div>
                                    <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="sales-assistant" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_1">Ventas para tu Negocio</button>
                                        <button data-workflow="email-writing" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_2">Redacci√≥n de Email</button>
                                        <button data-workflow="design-web" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_3">Dise√±o Web</button>
                                         <button data-workflow="social-skills" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_4">Mejorar Habilidades Sociales</button>
                                    </div>
                                 </div>
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-language w-6 mr-2"></i>
                                        <span class="text-sm font-bold" data-translate-key="wf_english_teacher">English Teacher</span>
                                    </div>
                                       <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="english-teacher-translate" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_1">Traducir/Corregir Texto</button>
                                         <button data-workflow="english-teacher-vocabulary" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_2">Aprender Vocabulario Nuevo</button>
                                        <button data-workflow="english-teacher-practice" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_3">Practicar Conversaci√≥n</button>
                                     </div>
                                </div>
                            </div>
                        </div>

                        <div id="actions-category" class="actions-category border-t border-themed pt-4 open">
                            <div class="actions-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                <i class="fas fa-chevron-right actions-arrow mr-2 transition-transform text-xs"></i>
                                <span class="text-sm font-bold" data-translate-key="quick_actions">Acciones R√°pidas</span>
                            </div>
                            <div class="actions-content pl-4 pt-2 space-y-2 block">
                                <button id="new-chat-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors w-full"><i class="fas fa-plus mr-2"></i><span data-translate-key="new_chat">Nuevo Chat</span></button>
                                <button id="new-folder-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg bg-input w-full"><i class="fas fa-folder-plus mr-2"></i><span data-translate-key="new_folder">Nueva Carpeta</span></button>
                            </div>
                        </div>

                        <div class="folders-category border-t border-themed pt-4 open">
                            <div class="folders-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                <i class="fas fa-chevron-right folder-arrow mr-2 transition-transform text-xs"></i>
                                <span class="text-sm font-bold" data-translate-key="my_projects">Mis Proyectos</span>
                                <button id="add-project-folder-btn" title="Nueva Carpeta de Proyectos" class="ml-2 text-primary hover:text-primary-hover"><i class="fas fa-plus-circle"></i></button>
                            </div>
                            <div id="folders-container" class="folders-content pl-4 pt-2 space-y-1"></div>
                        </div>

                        <div class="border-t border-themed pt-2 mt-4">
                             <button id="select-chats-btn" class="w-full text-sm p-2 rounded hover:bg-light flex items-center justify-center">
                                <i class="fas fa-tasks mr-2"></i><span data-translate-key="select_chats">Seleccionar M√∫ltiples Chats</span>
                            </button>
                         </div>
                        <div id="delete-mode-controls" class="hidden flex space-x-2 my-2">
                            <button id="delete-selected-btn" class="flex-1 flex items-center justify-center font-semibold p-2 rounded-lg bg-red-600 text-white disabled:opacity-50" disabled><i class="fas fa-trash-alt mr-2"></i><span data-translate-key="delete">Borrar</span></button>
                             <button id="cancel-select-mode-btn" class="p-2 rounded-lg bg-gray-600 text-white"><i class="fas fa-times"></i></button>
                        </div>
                        <div id="sidebar-content" class="pr-1 space-y-1"></div>
                    </div>
                </div>

                <div id="sidebar-footer">
                    <div class="flex flex-col space-y-2 border-t border-themed pt-4">
                        <button id="web-launch-offer-btn" class="w-full text-left font-semibold text-sm p-3 rounded-lg btn-primary transition-colors animate-pulse" data-translate-key="web_offer">
                           üöÄ ¬°Lanza tu Negocio, te regalamos una pg web Gratis con tu suscripcion!
                        </button>
                        <div id="upgrade-plan-container" class="hidden text-center p-2 bg-yellow-400 rounded-lg">
                            <button id="upgrade-plan-btn" class="text-xs font-semibold text-black hover:text-gray-800">
                                <i class="fas fa-rocket mr-1"></i>
                               <span data-translate-key="upgrade_plan">Mejorar Plan</span>
                            </button>
                        </div>
                        <div class="text-center p-2 bg-input rounded-lg">
                            <a href="#" id="free-guides-link" class="text-xs font-semibold text-primary hover:underline">
                                <i class="fas fa-book-open mr-1"></i>
                               <span data-translate-key="free_guides">Gu√≠as de IA Gratis</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sidebar-bottom-fixed">
                 <div id="user-section">
                    <div id="login-view" class="hidden">
                        <button id="login-btn" class="w-full flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-sign-in-alt mr-2"></i><span data-translate-key="login">Iniciar Sesi√≥n</span></button>
                    </div>
                     <div id="user-menu-view" class="hidden relative">
                        <button id="user-menu-btn" class="w-full flex items-center text-left p-2 rounded-lg hover:bg-light transition-colors">
                            <span id="user-email" class="flex-grow truncate text-sm font-semibold"></span>
                            <i id="user-settings-icon" class="fas fa-cog text-text-medium hover:text-primary cursor-pointer ml-2"></i>
                        </button>
                        <div id="user-menu-popup" class="absolute bottom-full left-0 w-full mb-2 rounded-lg p-2 border border-themed shadow-lg hidden">
                            <button id="settings-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-cog w-6 mr-2"></i><span data-translate-key="settings">Configuraci√≥n</span></button>
                             <button id="logout-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-sign-out-alt w-6 mr-2"></i><span data-translate-key="logout">Cerrar Sesi√≥n</span></button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="sidebar-toggle-arrow">
                <i class="fas fa-chevron-left"></i> </div>
        </aside>

        <main id="main-chat-area" class="flex-1 flex flex-col h-full overflow-hidden">
            <header class="flex items-center justify-between p-3 md:p-4 border-b border-themed flex-shrink-0 relative">
                <div id="main-header-content" class="flex items-center justify-between w-full">
                    <div class="flex items-center flex-shrink-0 header-left-icons">
                        <button id="menu-toggle" class="md:hidden text-xl p-2"><i class="fas fa-bars"></i></button>
                        <button id="new-chat-icon-btn" title="Nuevo Chat" class="text-xl p-1 hover:opacity-80 transition-opacity"><i class="fas fa-plus-circle text-primary"></i></button>
                        <button id="new-folder-icon-btn" title="Nueva Carpeta" class="text-xl p-1 hover:opacity-80 transition-opacity"><i class="fas fa-folder-plus text-primary"></i></button>
                    </div>

                    <div id="desktop-chat-title-wrapper" class="hidden sm:flex items-center justify-center group cursor-pointer mx-2 flex-1 min-w-0" title="Renombrar Chat">
                        <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                        <h1 id="chat-title" class="text-lg font-semibold truncate">Goatify IA</h1>
                        <button id="motivation-btn-header" title="Motivaci√≥n Diaria" class="text-yellow-400 hover:text-yellow-300 p-2 transition-colors ml-2"><i class="fas fa-lightbulb text-xl"></i></button>
                        <button id="calendar-btn" title="Mi Calendario y Tareas" class="text-sky-400 hover:text-sky-300 p-1 transition-colors notification-bell-icon">
                            <i class="fas fa-calendar-days text-lg"></i>
                            <span id="notification-badge" class="notification-badge hidden">0</span>
                        </button>
                    </div>

                    <div class="flex items-center space-x-1 sm:space-x-2 header-right-icons">
                        <div id="message-counter-wrapper" class="flex items-center space-x-2 text-xs font-mono whitespace-nowrap block mx-2 cursor-pointer">
                             <div id="plan-credits-info" class="flex items-center">
                                <i class="fas fa-trophy text-primary mr-1 text-base"></i> <span id="plan-credits-display">0/0</span>
                            </div>
                            <div id="reward-credits-info" class="flex items-center">
                                <i class="fas fa-coins text-gold ml-2 mr-1 text-base"></i> <span id="reward-credits-display">0</span>
                            </div>
                        </div>
                        <button id="services-menu-btn" title="Potenciar mi Negocio" class="relative text-xl p-1 hover:opacity-80 transition-opacity flex items-center gap-2">
                            <i class="fas fa-rocket text-primary"></i>
                            <span class="text-sm font-semibold text-primary hidden md:inline" data-translate-key="solutions">Soluciones</span>
                        </button>
                        <button id="theme-toggle" title="Cambiar Tema" class="text-xl p-1"><i class="fas fa-moon" id="theme-icon"></i></button>
                    </div>
                </div>
                 <div id="services-menu" class="absolute top-full right-4 mt-2 w-80 rounded-xl shadow-lg border border-themed z-30 p-4 origin-top-right">
                    <h4 class="font-bold text-lg mb-1 text-text-light" data-translate-key="ally_title">Somos tu Aliado Estrat√©gico</h4>
                    <p class="text-sm text-text-medium mb-4" data-translate-key="ally_desc">Goatify no es solo un chat. Somos una IA personalizada con un equipo de expertos listos para ayudarte a escalar tu negocio.</p>
                    <ul class="space-y-3">
                        <li><a id="sol-web" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">P√°ginas Web que Convierten</p><p class="text-sm text-text-medium">Transformamos tus ideas en webs y tiendas online dise√±adas para vender.</p></a></li>
                         <li><a id="sol-auto" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Ventas en Piloto Autom√°tico</p><p class="text-sm text-text-medium">Implementamos sistemas de IA para automatizar tus ventas y procesos clave.</p></a></li>
                        <li><a id="sol-social" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Avatares para Redes Sociales</p><p class="text-sm text-text-medium">Creamos avatares hiperrealistas con IA y estrategias de contenido que captan la atenci√≥n.</p></a></li>
                         <li><a id="sol-consult" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Escala tu Empresa con IA</p><p class="text-sm text-text-medium">Obt√©n consultor√≠a experta para integrar la IA en el ADN de tu negocio.</p></a></li>
                    </ul>
                </div>
            </header>
            <div class="block sm:hidden text-center py-1.5 border-b border-themed bg-current-bg-dark shadow-sm flex-shrink-0">
                <div id="mobile-chat-title-wrapper" class="flex items-center justify-center group cursor-pointer px-4 relative" title="Renombrar Chat">
                    <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                    <h2 id="mobile-chat-title" class="text-sm font-semibold truncate">Goatify IA</h2>
                    <button id="motivation-btn-mobile" title="Motivaci√≥n Diaria" class="text-yellow-400 hover:text-yellow-300 p-2 transition-colors"><i class="fas fa-lightbulb text-lg"></i></button>
                    <button id="calendar-btn-mobile" title="Mi Calendario y Tareas" class="text-sky-400 hover:text-sky-300 p-1 transition-colors notification-bell-icon">
                        <i class="fas fa-calendar-days text-lg"></i>
                        <span id="notification-badge-mobile" class="notification-badge hidden">0</span>
                    </button>
                </div>
             </div>

            <div id="view-container" class="flex-1 overflow-hidden relative">
                <div id="chat-messages" class="h-full overflow-y-auto p-3 sm:p-6">
                    <div class="flex justify-center items-center h-full" id="initial-message-container">
                        <div id="welcome-message-wrapper" class="text-center text-text-medium">
                            <img src="./Logos HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                            <h2 class="text-3xl font-bold text-text-light">Goatify IA</h2>
                            <div id="personalized-welcome" class="hidden"><p class="text-lg mt-1"><span data-translate-key="welcome_user">¬°Hola, </span><span id="user-name"></span><span data-translate-key="welcome_user_2">! Hoy es un gran d√≠a para crear algo incre√≠ble.</span></p></div>
                            <div id="generic-welcome" class="hidden"><p class="text-xl" data-translate-key="welcome_guest">¬øC√≥mo puedo ayudarte hoy?</p></div>
                        </div>
                    </div>
                </div>

                <div id="notepad-view-container" class="hidden">
                    <div id="notes-list-panel">
                        <div id="notes-list-header" class="flex items-center gap-2">
                            <button id="add-new-note-btn" class="w-full btn-primary text-sm flex items-center justify-center gap-2"><i class="fas fa-file-alt"></i><span data-translate-key="new_note">Nueva Nota</span></button>
                            <button id="add-new-drawing-btn" class="p-2 bg-input rounded-md" title="Nuevo Dibujo" data-translate-key="new_drawing_title"><i class="fas fa-paint-brush"></i></button>
                        </div>
                    </div>
                    <div id="notepad-editor-and-chat-container">
                        <div id="note-editor-panel">
                             <div id="note-editor-toolbar">
                                <button id="note-back-btn" title="Volver a la lista" class="p-2 hidden mr-2" data-translate-key="back_to_list"><i class="fas fa-arrow-left"></i></button>
                                <input id="note-title-input" type="text" placeholder="T√≠tulo de la nota..." data-translate-key="note_title_placeholder">
                                <div id="text-tools" class="flex items-center gap-2 ml-auto">
                                    <div class="text-editor-controls">
                                        <button id="bold-btn" title="Negrita" data-translate-key="bold_text"><i class="fas fa-bold"></i></button>
                                        <button id="italic-btn" title="Cursiva" data-translate-key="italic_text"><i class="fas fa-italic"></i></button>
                                        <button id="underline-btn" title="Subrayar" data-translate-key="underline_text"><i class="fas fa-underline"></i></button>
                                        <select id="font-family-selector" class="rounded-md py-1 px-2 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                            <option value="Montserrat, sans-serif">Montserrat</option>
                                            <option value="Arial, sans-serif">Arial</option>
                                            <option value="Verdana, sans-serif">Verdana</option>
                                            <option value="Georgia, serif">Georgia</option>
                                            <option value="Courier New, monospace">Courier New</option>
                                        </select>
                                    </div>
                                    <button id="add-checklist-item-btn" title="A√±adir Checklist" data-translate-key="add_checklist"><i class="fas fa-check-square"></i></button>
                                </div>
                                <div id="drawing-tools" class="hidden items-center gap-2">
                                    <button id="tool-pencil" class="drawing-tool active" title="L√°piz" data-translate-key="tool_pencil"><i class="fas fa-pencil-alt"></i></button>
                                    <button id="tool-eraser" class="drawing-tool" title="Borrador" data-translate-key="tool_eraser"><i class="fas fa-eraser"></i></button>
                                    <button id="tool-line" class="drawing-tool" title="L√≠nea" data-translate-key="drawing_tool_line"><i class="fas fa-slash"></i></button>
                                    <button id="tool-rect" class="drawing-tool" title="Rect√°ngulo" data-translate-key="drawing_tool_rect"><i class="fas fa-square"></i></button>
                                    <button id="tool-circle" class="drawing-tool" title="C√≠rculo" data-translate-key="drawing_tool_circle"><i class="fas fa-circle"></i></button>
                                    <input type="color" id="drawing-color" class="drawing-tool" title="Color" value="#000000" data-translate-key="drawing_color"> <input type="range" id="drawing-line-width" class="drawing-tool" min="1" max="50" value="3" title="Grosor" data-translate-key="drawing_thickness">
                                    <button id="clear-canvas-btn" class="drawing-tool" title="Limpiar todo" data-translate-key="clear_all"><i class="fas fa-trash-alt"></i></button>
                                    <button id="undo-drawing-btn" class="drawing-tool" title="Deshacer" data-translate-key="undo_drawing"><i class="fas fa-undo"></i></button>
                                    <button id="redo-drawing-btn" class="drawing-tool" title="Rehacer" data-translate-key="redo_drawing"><i class="fas fa-redo"></i></button>
                                </div>
                                <button id="share-note-btn" title="Compartir / Colaborar" class="p-2 ml-2" data-translate-key="share_note_btn"><i class="fas fa-user-plus"></i></button>
                                <button id="delete-note-btn" title="Eliminar Nota" class="p-2 text-red-500 hover:text-red-400 transition-colors" data-translate-key="delete_note_btn"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <div id="note-content-area" class="relative flex-grow">
                                <div id="note-content-editor" contenteditable="true" class="h-full"></div>
                                <canvas id="note-canvas" class="absolute top-0 left-0 hidden"></canvas>
                            </div>
                        </div>
                        <div id="notepad-chat-container" class="hidden md:flex">
                            <div id="notepad-chat-header" class="flex justify-between items-center cursor-pointer p-2">
                                <h3 class="text-lg font-semibold text-primary" data-translate-key="writing_assistant">Asistente de Redacci√≥n</h3>
                                <button id="notepad-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-up"></i></button>
                            </div>
                            <div class="notepad-chat-body">
                                <div id="notepad-chat-messages" class="chat-bubble-bot"></div>
                                <div class="mt-auto pt-2">
                                    <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                                        <div class="flex items-center space-x-2">
                                           <label for="notepad-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1" data-translate-key="model">Modelo:</label>
                                            <div class="model-selector-wrapper">
                                               <select id="notepad-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                                    <option value="gpt-3.5-turbo-1106" data-translate-key="model_general">GOAT X</option>
                                                    <option value="sonar" data-translate-key="model_web">B√∫squeda Web</option>
                                                    <option value="gpt-4o" class="goat-x-pro-model">GOAT X PRO</option>
                                                </select>
                                                 <i class="fas fa-chevron-down text-xs"></i>
                                           </div>
                                        </div>
                                   </div>
                                    <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                        <textarea id="notepad-msg" placeholder="Pide ideas, res√∫menes, o correcciones..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm" data-translate-key="notepad_placeholder"></textarea>
                                        <button id="notepad-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="financial-assistant-view" class="hidden h-full"></div>

                <div id="project-management-view" class="hidden p-4 h-full">
                    <div id="project-board-container" class="flex flex-col h-full">
                        <div class="flex flex-wrap justify-between items-center mb-4 flex-shrink-0 gap-2">
                            <h2 id="project-view-title" class="text-2xl font-bold">Nombre del Proyecto</h2>
                             <div id="project-tag-filter-container" class="relative">
                                <button id="tag-filter-btn" class="p-2 rounded-md bg-input text-sm"><i class="fas fa-tag mr-1"></i> <span data-translate-key="filter_tags">Filtrar</span></button>
                                <div id="tag-filter-dropdown" class="hidden absolute right-0 mt-1 p-2 rounded-md shadow-lg w-48"></div>
                             </div>
                        </div>
                         <div class="flex items-center space-x-2 project-view-controls mb-4 flex-shrink-0">
                            <span class="text-sm text-text-medium hidden sm:inline" data-translate-key="views">Vistas:</span>
                             <button id="view-toggle-kanban" class="px-3 py-1 text-sm rounded-md" data-translate-key="kanban">Kanban</button>
                            <button id="view-toggle-list" class="px-3 py-1 text-sm rounded-md" data-translate-key="list">Lista</button>
                            <button id="add-task-list-view-btn" title="A√±adir Tarea" class="hidden ml-auto p-2 rounded-md bg-primary text-white" data-translate-key="add_task_btn_short"><i class="fas fa-plus"></i></button>
                            <button id="project-calendar-btn" title="Calendario del Proyecto" class="text-sky-400 hover:text-sky-300 p-2 transition-colors ml-auto" data-translate-key="project_calendar_title"><i class="fas fa-calendar-alt text-xl"></i></button>
                        </div>
                         <div id="kanban-view" class="hidden flex-1">
                            </div>
                        <div id="list-view" class="hidden flex-1 flex-col">
                        </div>
                        <div id="list-view-mobile" class="hidden flex-1 overflow-y-auto">
                        </div>
                    </div>
                    <div id="project-chat-container">
                         <div id="project-chat-container-header" class="flex justify-between items-center cursor-pointer p-2">
                            <h3 class="text-lg font-semibold text-primary" data-translate-key="project_assistant">Asistente del Proyecto</h3>
                            <button id="project-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-up"></i></button>
                        </div>
                         <div class="project-chat-body">
                            <div id="project-chat-messages" class="chat-bubble-bot"></div>
                            <div id="project-input-area" class="mt-auto pt-2">
                                 <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                                     <div class="flex items-center space-x-2">
                                        <label for="project-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1" data-translate-key="model">Modelo:</label>
                                         <div class="model-selector-wrapper">
                                            <select id="project-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                                <option value="gpt-3.5-turbo-1106" data-translate-key="model_general">GOAT X</option>
                                                <option value="sonar" data-translate-key="model_web">B√∫squeda Web</option>
                                                <option value="gpt-4o" class="goat-x-pro-model">GOAT X PRO</option>
                                             </select>
                                              <i class="fas fa-chevron-down text-xs"></i>
                                        </div>
                                     </div>
                                </div>
                                 <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                     <textarea id="project-msg" placeholder="Deja que Goatify organice tu proyecto..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm" data-translate-key="project_chat_placeholder"></textarea>
                                    <button id="project-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="input-area" class="p-2 sm:p-4 border-t border-themed flex-shrink-0">
                <div id="file-preview-area" class="mb-2 space-y-2 px-1 sm:px-0">
                     <div id="image-preview-container" class="hidden relative">
                        <img id="image-preview" src="#" alt="Image Preview">
                        <span id="image-name" class="text-xs text-text-medium truncate flex-grow"></span>
                         <button id="clear-image-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                    <div id="pdf-preview-container" class="hidden relative">
                        <i class="fas fa-file-pdf text-red-500 text-xl"></i>
                         <div class="flex-grow min-w-0">
                            <p id="pdf-name" class="font-medium truncate"></p>
                            <p id="pdf-status" class="text-xxs font-mono"></p>
                         </div>
                        <button id="clear-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                </div>
                <div id="input-area-model-row" class="cool-light-effect">
                    <div id="model-and-voice-controls">
                        <div class="flex items-center">
                            <label for="model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1" data-translate-key="model">Modelo:</label>
                            <div class="model-selector-wrapper">
                                <select id="model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                    <option value="gpt-3.5-turbo-1106" data-translate-key="model_general">Chat</option>
                                    <option value="sonar" data-translate-key="model_web">B√∫squeda Web</option>
                                    <option value="gpt-4o" class="goat-x-pro-model">GOAT X PRO</option>
                                </select>
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                        <div id="voice-selector-container" class="flex items-center space-x-2">
                            <label for="voice-selector" class="font-medium text-xs text-text-medium" data-translate-key="voice">Voz:</label>
                            <div class="model-selector-wrapper">
                                <select id="voice-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light w-24"></select>
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons-container">
                        <button id="image-gen-btn" title="Crear Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium" data-translate-key="create_image_title"><i class="fas fa-paint-brush text-lg"></i></button>
                        <button id="pdf-upload-btn" title="Subir PDF" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium" data-translate-key="upload_pdf_title"><i class="fa fa-file-pdf text-lg"></i></button>
                        <button id="image-upload-btn" title="Subir Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium" data-translate-key="upload_image_title"><i class="fa fa-image text-lg"></i></button>
                    </div>
                </div>
                <div id="input-area-chat-row" class="relative input-wrapper">
                    <input type="file" id="pdf-upload" accept=".pdf,application/pdf" class="hidden"><input type="file" id="image-upload" accept="image/*" class="hidden">
                    <button id="mic-btn" title="Activar Micr√≥fono" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium" data-translate-key="activate_mic"><i class="fa fa-microphone text-xl"></i></button>
                     <button id="tts-toggle" title="Activar/Desactivar Voz" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium" data-translate-key="toggle_voice"><i class="fa fa-volume-mute text-xl"></i></button>
                    <textarea id="msg" placeholder="Escribe tu mensaje..." class="flex-1 bg-transparent p-2 h-12 max-h-32 resize-none outline-none placeholder-themed" rows="1" data-translate-key="placeholder_main"></textarea>
                    <button id="send" title="Enviar" class="p-2 sm:p-4 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i id="send-icon" class="fa fa-paper-plane text-xl"></i></button>
                 </div>
                <div id="contextual-footer" class="text-center text-xs text-text-medium mt-2 px-2 h-4"></div>
            </div>
        </main>
    </div>
    <div id="in-app-notification">
        <div id="in-app-notification-header">
            <h4 id="in-app-notification-title"></h4>
            <button id="in-app-notification-close" class="text-text-medium hover:text-text-light text-2xl leading-none">&times;</button>
        </div>
        <p id="in-app-notification-body"></p>
    </div>

    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <div id="modal-body" class="mb-4 text-text-medium text-sm"></div>
            <div id="modal-buttons-container" class="flex justify-end space-x-2">
                 </div>
        </div>
    </div>

    <div id="motivation-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative text-center">
            <i class="fas fa-lightbulb text-4xl text-yellow-400 mb-4"></i>
            <h3 id="motivation-title" class="text-2xl mb-4" data-translate-key="motivation_title">Dosis de Motivaci√≥n</h3>
            <p id="motivation-quote" class="text-lg text-text-light mb-6 min-h-[50px]"></p>
            <div class="flex items-center justify-center mb-6">
                <label for="motivation-toggle" class="flex items-center cursor-pointer">
                    <span class="mr-3 text-text-light font-medium" data-translate-key="motivation_notifications">
                        Notificaciones peri√≥dicas
                    </span>
                    <div class="relative">
                        <input type="checkbox" id="motivation-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                    </div>
                </label>
            </div>
            <button id="close-motivation-modal" class="btn-primary px-6 py-2 rounded-lg" data-translate-key="understood_btn">¬°Entendido!</button>
        </div>
    </div>

    <div id="pricing-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-5xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-6">
                <h2 class="text-3xl md:text-4xl font-extrabold text-center flex-grow" data-translate-key="plans_title">Planes Goatify</h2>
                 <button id="close-pricing-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="modal-content-body flex-grow overflow-y-auto px-2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-text-light">
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">Free</h3>
                        <p class="text-5xl font-extrabold my-3">$0</p>
                        <p class="text-sm text-text-medium mb-4" data-translate-key="plan_free_sub">Para Siempre</p>
                         <ul class="text-sm space-y-2 mb-4 text-left">
                            <li><i class="fas fa-check-circle mr-2"></i>50 Cr√©ditos/mes</li>
                            <li><i class="fas fa-check-circle mr-2"></i>Acceso a Modelos B√°sicos</li>
                             <li><i class="fas fa-check-circle mr-2"></i>Workflows Limitados</li>
                        </ul>
                        <button id="free-plan-button" class="mt-auto w-full p-3 rounded-lg font-semibold border-2 border-primary text-primary hover:bg-primary hover:text-white transition-colors" data-translate-key="plan_free_cta">Tu Plan Actual</button>
                     </div>
                    <div class="plan-card border-2 rounded-xl p-6 flex flex-col bg-current-bg-dark plan-card-highlight">
                        <h3 class="text-2xl font-bold">GOAT <span class="text-primary">BOOST</span></h3>
                         <p class="text-5xl font-extrabold my-3">$7<span class="text-lg font-medium text-text-medium">/mes</span></p>
                        <button class="w-full p-2 text-sm rounded-lg font-semibold border border-primary text-primary hover:bg-primary hover:text-white transition-colors mb-4 plan-details-toggle" data-translate-key="view_details">Ver Detalles</button>
                        <div class="plan-details text-sm text-left">
                             <ul class="space-y-2 mb-4 plan-feature-list">
                                <li><i class="fas fa-check-circle mr-2"></i><strong>500 Cr√©ditos/mes</strong></li>
                                <li><i class="fas fa-check-circle mr-2"></i>Acceso a <strong>todos los modelos de IA</strong></li>
                                 <li><i class="fas fa-check-circle mr-2"></i>Acceso a <strong>todos los Workflows</strong></li>
                                <li><i class="fas fa-check-circle mr-2"></i>Soporte Prioritario</li>
                            </ul>
                         </div>
                        <button data-plan="boost" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_boost_cta">Obtener Boost</button>
                    </div>
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">GOAT <span class="text-primary">PRO</span></h3>
                        <p class="text-5xl font-extrabold my-3">$17<span class="text-lg font-medium text-text-medium">/mes</span></p>
                         <button class="w-full p-2 text-sm rounded-lg font-semibold border border-primary text-primary hover:bg-primary hover:text-white transition-colors mb-4 plan-details-toggle" data-translate-key="view_details">Ver Detalles</button>
                        <div class="plan-details text-sm text-left">
                            <ul class="space-y-2 mb-4 plan-feature-list">
                                 <li><i class="fas fa-check-circle mr-2"></i><strong>2000 Cr√©ditos/mes</strong></li>
                                <li><i class="fas fa-check-circle mr-2"></i>Todo lo del plan BOOST</li>
                                <li><i class="fas fa-check-circle mr-2 text-gold"></i><strong>¬°Te construimos tu P√°gina Web!</strong></li>
                                 <li><i class="fas fa-check-circle mr-2"></i>Consultor√≠a de IA</li>
                                <li><i class="fas fa-check-circle mr-2"></i>Acceso a Gu√≠as Premium</li>
                            </ul>
                         </div>
                        <button data-plan="pro" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_pro_cta">Quiero mi Plan Pro + Web</button>
                    </div>
                </div>
             </div>
        </div>
    </div>

    <div id="html-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full h-full max-w-4xl flex flex-col relative">
            <div class="modal-header">
                <h3 class="text-lg font-bold" data-translate-key="preview">Vista Previa</h3>
                <button id="close-html-preview-modal" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <iframe id="html-preview-iframe" class="w-full flex-grow border-2 border-themed rounded-b-lg bg-white"></iframe>
            <div id="preview-actions">
                <button id="download-html-btn" class="btn-primary p-2 rounded-lg text-sm"><i class="fas fa-download mr-1"></i> Descargar HTML</button>
                <button id="copy-html-btn" class="btn-primary p-2 rounded-lg text-sm"><i class="fas fa-copy mr-1"></i> Copiar C√≥digo</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-lg p-6 relative">
             <h3 class="text-lg font-bold mb-4" data-translate-key="settings">Configuraci√≥n</h3>
            <div class="space-y-4 text-sm max-h-[70vh] overflow-y-auto pr-2">
                <div>
                    <p class="font-semibold" data-translate-key="settings_email">Correo Electr√≥nico:</p>
                    <p id="settings-user-email" class="text-text-medium"></p>
                 </div>
                <div>
                    <p class="font-semibold" data-translate-key="settings_plan">Plan de Suscripci√≥n:</p>
                    <p id="settings-user-plan" class="text-text-medium"></p>
                    <button id="settings-upgrade-plan-btn" class="text-primary hover:underline mt-1 text-xs" data-translate-key="upgrade_plan">Mejorar Plan</button>
                 </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_fontsize">Tama√±o de Letra:</p>
                    <input type="range" id="font-size-slider" min="14" max="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg dark:bg-gray-700">
                    <span id="font-size-value" class="text-xs text-text-medium">16px</span>
                </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_theme">Personalizaci√≥n:</p>
                    <button id="settings-theme-toggle" class="flex items-center p-2 rounded hover:bg-medium w-full text-left">
                         <i class="fas fa-moon mr-2" id="settings-theme-icon"></i>
                        <span data-translate-key="settings_dark_mode">Modo Oscuro</span>
                    </button>
                </div>
                <div>
                     <div class="flex items-center justify-between">
                        <p class="font-semibold" data-translate-key="settings_notifications">Notificaciones de Tareas:</p>
                        <label for="notifications-toggle" class="inline-flex relative items-center cursor-pointer">
                            <input type="checkbox" id="notifications-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                 </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_lang">Idioma:</p>
                    <select id="language-selector" class="w-full p-2 rounded bg-input border border-themed">
                         <option value="es">Espa√±ol</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="border-t border-themed pt-4 mt-4">
                     <h4 class="font-semibold mb-2" data-translate-key="settings_integrations">Integraciones</h4>
                     <div class="space-y-2">
                        <button id="connect-google-calendar-btn" class="w-full bg-input p-2 rounded-lg flex items-center justify-start text-left hover:bg-light transition-colors">
                             <i class="fab fa-google mr-3 text-red-500 fa-lg"></i>
                            <div>
                                <span class="font-semibold">Google Calendar</span>
                                 <p class="text-xs text-text-medium" data-translate-key="google_calendar_desc">Sincroniza tus tareas y eventos.</p>
                            </div>
                        </button>
                        </div>
                </div>
                <div>
                    <button id="connect-whatsapp-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center mb-2">
                         <i class="fab fa-whatsapp mr-2"></i><span data-translate-key="settings_whatsapp">Conectarse a WhatsApp</span>
                    </button>
                    <a href="https://calendly.com/goatify" target="_blank" id="schedule-meeting-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar-alt mr-2"></i><span data-translate-key="settings_schedule_meeting">Agendar Reuni√≥n</span>
                     </a>
                </div>
            </div>
            <button id="close-settings-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>
    <div id="calendar-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div id="calendar-modal" class="modal-content rounded-lg w-full max-w-4xl p-6 relative">
             <h3 class="text-2xl font-extrabold text-center text-primary mb-4" data-translate-key="calendar_my_calendar">Mi Calendario y Tareas</h3>
             <div class="text-center mb-4">
                <p id="current-date-display" class="text-lg text-text-medium"></p>
                <p id="current-time-display" class="text-xl font-extrabold text-primary animate-pulse"></p>
            </div>
            <div class="calendar-view-toggle mb-4">
                <button id="day-view-btn" data-translate-key="calendar_day_view">Vista de D√≠a</button>
                <button id="week-view-btn" data-translate-key="calendar_week_view">Vista de Semana</button>
                <button id="month-view-btn" class="active" data-translate-key="calendar_month_view">Vista de Mes</button>
             </div>

            <div id="day-view-container">
                 <div class="calendar-header">
                    <button id="prev-day" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-day-display" class="text-xl font-semibold"></h4>
                     <button id="next-day" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="day-view-timeline"></div>
            </div>

            <div id="week-view-container">
                <div class="calendar-header">
                     <button id="prev-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-week-range" class="text-xl font-semibold"></h4>
                    <button id="next-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                 <div id="week-days-content"></div>
            </div>

            <div id="month-view-container">
                <div class="calendar-header">
                    <button id="prev-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-month-year" class="text-xl font-semibold"></h4>
                     <button id="next-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid mb-4">
                    <div class="font-bold text-primary" data-translate-key="calendar_mon">Lun</div>
                     <div class="font-bold text-primary" data-translate-key="calendar_tue">Mar</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_wed">Mi√©</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_thu">Jue</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_fri">Vie</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_sat">S√°b</div>
                     <div class="font-bold text-primary" data-translate-key="calendar_sun">Dom</div>
                </div>
                <div id="calendar-days-grid" class="calendar-grid"></div>
            </div>

            <div class="mt-6 border-t border-themed pt-4">
                <button id="add-task-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i><span data-translate-key="calendar_add_task_btn">A√±adir Tarea</span>
                </button>
            </div>

            <button id="close-calendar-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>

    <div id="task-notification-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-[110] p-4">
        <div class="modal-content text-center rounded-lg w-full max-w-md p-8 relative">
            <h3 id="task-notification-title" class="text-2xl font-bold mb-4"></h3>
            <div id="task-notification-body" class="text-lg text-text-light mb-8"></div>
            <button id="task-notification-close-btn" class="btn-primary px-8 py-3 rounded-lg font-semibold" data-translate-key="done_btn">Listo</button>
        </div>
    </div>


    <div id="gamification-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-4">
                <h2 class="text-3xl font-extrabold text-gold">
                    <i class="fas fa-coins mr-2"></i><span data-translate-key="gamification_title">La Ascensi√≥n del G.O.A.T. </span></h2>
                <button id="close-gamification-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>

            <div class="p-4 bg-input rounded-lg mb-4 flex-shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <span id="gamification-level-name" class="font-bold text-xl text-text-light">Nivel 1: Iniciador Digital</span>
                    <div class="text-right">
                        <span id="gamification-xp" class="font-bold text-primary">0 / 100 XP</span>
                         <p id="gamification-credits" class="text-sm text-gold font-semibold"><i class="fas fa-coins mr-1"></i>0 Cr√©ditos</p>
                    </div>
                </div>
                <div class="w-full xp-bar-bg rounded-full h-4">
                    <div id="gamification-xp-bar" class="xp-bar-fill h-4 rounded-full" style="width: 0%;"></div>
                 </div>
            </div>

            <div class="flex-grow overflow-hidden flex flex-col">
                <div class="flex-shrink-0 gamification-tabs flex items-center space-x-2">
                    <button class="gamification-tab active" data-tab="racha" data-translate-key="daily_streak_tab">Racha Diaria</button>
                     <button class="gamification-tab" data-tab="misiones" data-translate-key="missions_tab">Misiones</button>
                    <button class="gamification-tab" data-tab="logros" data-translate-key="achievements_tab">Logros</button>
                    <button id="gamification-rules-btn" class="ml-auto text-sm text-text-medium hover:text-primary" data-translate-key="rules_btn"><i class="fas fa-circle-question mr-1"></i> Reglas</button>
                </div>
                <div class="flex-grow overflow-y-auto pt-4">
                     <div id="gamification-tab-racha" class="gamification-tab-content space-y-4">
                        <p class="text-center text-text-medium" data-translate-key="streak_desc">Mant√©n tu racha para ganar XP, cr√©ditos y un cofre especial el d√≠a 7.</p>
                         <div id="daily-streak-container" class="grid grid-cols-7 gap-2 md:gap-4 text-center">
                            </div>
                    </div>
                     <div id="gamification-tab-misiones" class="gamification-tab-content hidden space-y-3">
                        </div>
                     <div id="gamification-tab-logros" class="gamification-tab-content hidden">
                        <div id="achievements-container" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                           </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="gamification-rules-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-[60] p-4">
         <div class="modal-content rounded-lg w-full max-w-2xl p-6 relative">
            <h3 class="text-lg font-bold mb-4 text-gold"><i class="fas fa-scroll mr-2"></i><span data-translate-key="rules_title">Reglas de "La Ascensi√≥n del GOAT"</span></h3>
            <div class="space-y-4 text-text-medium text-sm max-h-[70vh] overflow-y-auto pr-2">
                <p data-translate-key="rules_intro">¬°Bienvenido a tu viaje para convertirte en un G.O.A.T. (Greatest Of All Time) del emprendimiento digital! La l√≥gica es simple: cuanto m√°s usas la plataforma de forma estrat√©gica, m√°s recompensas obtienes.</p>
                <div>
                    <h4 class="font-semibold text-text-light mt-3" data-translate-key="xp_credits_title">1. Puntos de Experiencia (XP) vs. Cr√©ditos de Recompensa (ü™ô)</h4>
                    <p data-translate-key="xp_credits_desc">Existen dos tipos de recompensas:</p>
                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li data-translate-key="xp_desc"><strong>Puntos de Experiencia (XP):</strong> Miden tu progreso y maestr√≠a. El XP <strong class="text-primary">nunca se gasta</strong>, solo se acumula para que subas de nivel y desbloquees nuevos t√≠tulos.</li>
                        <li data-translate-key="credits_desc"><strong>Cr√©ditos de Recompensa (ü™ô):</strong> Son una <strong class="text-gold">reserva de cr√©ditos utilizables</strong> que ganas al completar misiones y rachas. Cuando se agotan los cr√©ditos diarios de tu plan, el sistema usar√° autom√°ticamente estos cr√©ditos de recompensa para que puedas seguir trabajando.</li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-semibold text-text-light mt-3" data-translate-key="how_to_level_up_title">2. C√≥mo Subir de Nivel</h4>
                    <p data-translate-key="how_to_level_up_desc">Acumula suficiente XP para ascender de nivel. Cada nivel representa una nueva etapa en tu dominio del marketing y los negocios con IA.</p>
                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li data-translate-key="level_1">Nivel 1: <strong>Iniciador Digital</strong></li>
                        <li data-translate-key="level_2">Nivel 2: <strong>Creador de Contenido</strong></li>
                         <li data-translate-key="level_3">Nivel 3: <strong>Estratega de Marketing</strong></li>
                        <li data-translate-key="level_4">Nivel 4: <strong>CEO Digital</strong></li>
                        <li data-translate-key="level_5">Nivel 5: <strong>G.O.A.T.</strong></li>
                    </ul>
                </div>
                  <div>
                    <h4 class="font-semibold text-text-light mt-3" data-translate-key="how_to_earn_rewards_title">3. C√≥mo Ganar Recompensas</h4>
                     <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li data-translate-key="daily_streak_reward"><strong>Racha Diaria:</strong> Cada d√≠a consecutivo que entras te da XP y Cr√©ditos de Recompensa.</li>
                        <li data-translate-key="goat_chest_reward"><strong>Cofre GOAT (D√≠a 7):</strong> ¬°Tu gran recompensa semanal por 7 d√≠as de racha! Puede contener una gran cantidad de cr√©ditos, <strong>cupones de descuento</strong> para nuestros servicios de implementaci√≥n (p√°ginas web, automatizaciones) o incluso una <strong>asesor√≠a estrat√©gica GRATIS</strong>.</li>
                        <li data-translate-key="missions_achievements_reward"><strong>Misiones y Logros:</strong> La forma m√°s r√°pida de ganar grandes bonificaciones de XP y Cr√©ditos. Completa tareas espec√≠ficas para acelerar tu ascenso.</li>
                    </ul>
                </div>
                 <p class="font-bold text-center mt-4 text-lg text-primary" data-translate-key="rules_closing">¬°Cada acci√≥n cuenta en tu camino a la cima! ¬°A por ello!</p>
            </div>
            <button id="close-gamification-rules-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        //<-- START OF SCRIPT -->
        window.addEventListener('DOMContentLoaded', () => {
            dayjs.extend(window.dayjs_plugin_localizedFormat);
            dayjs.extend(window.dayjs_plugin_isoWeek);

            const translations = {
                es: {
                    initializing: "Inicializando...", new_chat: "Nuevo Chat", new_folder: "Nueva Carpeta",
                    web_offer: "üöÄ ¬°Lanza tu Negocio, te regalamos una pg web Gratis con tu suscripcion!",
                     upgrade_plan: "Mejorar Plan", free_guides: "Gu√≠as de IA Gratis", workflows: "Workflows",
                    wf_pm: "Asistente de Proyectos", wf_financial: "Asistente Financiero", wf_notepad: "Bloc de Notas",
                    wf_expert: "Asistente Experto", wf_expert_1: "Laboratorio de Decisiones", wf_expert_2: "Resoluci√≥n de Conflictos",
                    wf_social: "Potenciador de Redes Sociales", wf_social_1: "Crear un Post Completo", wf_social_2: "Redacci√≥n de Copys",
                     wf_social_3: "Lluvia de Ideas para Posts", wf_social_4: "Definir Estrategia de Marca",
                    wf_business: "An√°lisis de Negocio", wf_business_1: "An√°lisis de tu Competencia", wf_business_2: "Definir mi Cliente Ideal",
                    wf_business_3: "Lluvia de Nombres para Marca", wf_sales: "Comunicaci√≥n y Ventas", wf_sales_1: "Ventas para tu Negocio",
                     wf_sales_2: "Redacci√≥n de Email", wf_sales_3: "Dise√±o Web", wf_sales_4: "Mejorar Habilidades Sociales",
                    wf_english_teacher: "English Teacher", wf_eng_1: "Traducir/Corregir Texto",
                    wf_eng_2: "Aprender Vocabulario Nuevo", wf_eng_3: "Practicar Conversaci√≥n", quick_actions: "Acciones R√°pidas", my_projects: "Mis Proyectos",
                    select_chats: "Seleccionar M√∫ltiples Chats",
                    delete: "Borrar", login: "Iniciar Sesi√≥n", settings: "Configuraci√≥n", logout: "Cerrar Sesi√≥n",
                     solutions: "Soluciones", ally_title: "Somos tu Aliado Estrat√©gico",
                    ally_desc: "Goatify no es solo un chat. Somos una IA personalizada con un equipo de expertos listos para ayudarte a escalar tu negocio.",
                    welcome_user: "¬°Hola, ", welcome_user_2: "! Hoy es un gran d√≠a para crear algo incre√≠ble.",
                    welcome_guest: "¬øC√≥mo puedo ayudarte hoy?", model: "Modelo:", model_general: "GOAT X",
                    model_web: "B√∫squeda Web", voice: "Voz:", placeholder_main: "Escribe tu mensaje...", cancel: "Cancelar",
                    confirm: "Confirmar", plans_title: "Planes Goatify", plan_free_sub: "Para Siempre", plan_free_cta: "Tu Plan Actual",
                     plan_boost_cta: "Obtener Boost", plan_pro_cta: "Quiero mi Plan Pro + Web",
                    preview: "Vista Previa", settings_email: "Correo Electr√≥nico:", settings_plan: "Plan de Suscripci√≥n:",
                    settings_fontsize: "Tama√±o de Letra:", settings_theme: "Personalizaci√≥n:", settings_dark_mode: "Modo Oscuro",
                     settings_lang: "Idioma:", settings_whatsapp: "Conectarse a WhatsApp", current_plan: "Tu Plan Actual",
                    settings_notifications: "Notificaciones de Tareas:", settings_schedule_meeting: "Agendar Reuni√≥n",
                    settings_integrations: "Integraciones", google_calendar_desc: "Sincroniza tus tareas y eventos.",
                    calendar_today: "Hoy", calendar_this_week: "Esta Semana", calendar_mon: "Lun", calendar_tue: "Mar", calendar_wed: "Mi√©",
                     calendar_thu: "Jue", calendar_fri: "Vie", calendar_sat: "S√°b", calendar_sun: "Dom",
                    calendar_no_tasks: "No hay tareas para este d√≠a.", calendar_add_task_placeholder: "A√±adir nueva tarea personal...",
                    calendar_add_task_btn: "A√±adir Tarea", calendar_my_calendar: "Mi Calendario y Tareas",
                    calendar_day_view: "Vista de D√≠a", calendar_month_view: "Vista de Mes", calendar_week_view: "Vista de Semana",
                    notification_task_due: "Es hora de: ", notification_title: "Goatify IA - ¬°Hora de tu Tarea!",
                    tasks_for: "Tareas para", add_task_for: "A√±adir Tarea para",
                    delete_task_confirm_title: "Confirmar Eliminaci√≥n", delete_task_confirm_body: "¬øEst√°s seguro de que quieres eliminar esta tarea?",
                    delete_btn: "Eliminar", done_btn: "Listo",
                    share_note: "Compartir Nota",
                    share_note_desc: "Ingresa el email del usuario de Goatify con quien quieres colaborar en esta nota.",
                    share_note_email_placeholder: "ejemplo@email.com",
                    share_note_info: "Nota: Esta funcionalidad requiere que ambos usuarios tengan un plan Pro y est√° en desarrollo. Por ahora, esto es una demostraci√≥n.",
                    share_note_button: "Compartir",
                    share_financial_data: "Compartir Datos Financieros",
                    share_financial_data_desc: "Ingresa el email del usuario de Goatify con quien quieres compartir estos datos financieros.",
                    share_financial_data_info: "Nota: Esta funcionalidad requiere que ambos usuarios tengan un plan Pro y est√° en desarrollo. Por ahora, esto es una demostraci√≥n.",
                    my_projects: "Mis Proyectos", add_to_folder: "Agregar a carpeta", no_folders_yet: "No hay carpetas a√∫n.",
                    new_note: "Nueva Nota", new_drawing_title: "Nuevo Dibujo", note_title_placeholder: "T√≠tulo de la nota...",
                    bold_text: "Negrita", italic_text: "Cursiva", underline_text: "Subrayar",
                    add_checklist: "A√±adir Checklist", tool_pencil: "L√°piz", tool_eraser: "Borrador", drawing_color: "Color", drawing_thickness: "Grosor", clear_all: "Limpiar todo",
                    share_note_btn: "Compartir", delete_note_btn: "Eliminar Nota", writing_assistant: "Asistente de Redacci√≥n",
                    notepad_placeholder: "Pide ideas, res√∫menes, o correcciones...",
                    filter_tags: "Filtrar", views: "Vistas:", kanban: "Kanban", list: "Lista", add_task_btn_short: "A√±adir Tarea",
                    project_calendar_title: "Calendario del Proyecto", project_assistant: "Asistente del Proyecto",
                    project_chat_placeholder: "Deja que Goatify organice tu proyecto...",
                    gamification_title: "La Ascensi√≥n del G.O.A.T.", daily_streak_tab: "Racha Diaria", missions_tab: "Misiones", achievements_tab: "Logros",
                    rules_btn: "Reglas", streak_desc: "Mant√©n tu racha para ganar XP, cr√©ditos y un cofre especial el d√≠a 7.",
                    rules_intro: "¬°Bienvenido a tu viaje para convertirte en un G.O.A.T. (Greatest Of All Time) del emprendimiento digital! La l√≥gica es simple: cuanto m√°s usas la plataforma de forma estrat√©gica, m√°s recompensas obtienes.",
                    xp_credits_title: "1. Puntos de Experiencia (XP) vs. Cr√©ditos de Recompensa (ü™ô)",
                    xp_credits_desc: "Existen dos tipos de recompensas:",
                    xp_desc: "Puntos de Experiencia (XP): Miden tu progreso y maestr√≠a. El XP nunca se gasta, solo se acumula para que subas de nivel y desbloquees nuevos t√≠tulos.",
                    credits_desc: "Cr√©ditos de Recompensa (ü™ô): Son una reserva de cr√©ditos utilizables que ganas al completar misiones y rachas. Cuando se agotan los cr√©ditos diarios de tu plan, el sistema usar√° autom√°ticamente estos cr√©ditos de recompensa para que puedas seguir trabajando. ¬°Son tu colch√≥n para que nunca pares de crear!",
                    how_to_level_up_title: "2. C√≥mo Subir de Nivel",
                    how_to_level_up_desc: "Acumula suficiente XP para ascender de nivel. Cada nivel representa una nueva etapa en tu dominio del marketing y los negocios con IA.",
                    level_1: "Nivel 1: Iniciador Digital", level_2: "Nivel 2: Creador de Contenido", level_3: "Nivel 3: Estratega de Marketing",
                    level_4: "Nivel 4: CEO Digital", level_5: "Nivel 5: G.O.A.T.",
                    how_to_earn_rewards_title: "3. C√≥mo Ganar Recompensas",
                    daily_streak_reward: "Racha Diaria: Cada d√≠a consecutivo que entras te da XP y Cr√©ditos de Recompensa.",
                    goat_chest_reward: "Cofre GOAT (D√≠a 7): ¬°Tu gran recompensa semanal por 7 d√≠as de racha! Puede contener una gran cantidad de cr√©ditos, cupones de descuento para nuestros servicios de implementaci√≥n (p√°ginas web, automatizaciones) o incluso una asesor√≠a estrat√©gica GRATIS.",
                    missions_achievements_reward: "Misiones y Logros: La forma m√°s r√°pida de ganar grandes bonificaciones de XP y Cr√©ditos. Completa tareas espec√≠ficas para acelerar tu ascenso.",
                    rules_closing: "¬°Cada acci√≥n cuenta en tu camino a la cima! ¬°A por ello!",
                    create_image_title: "Crear Imagen", upload_pdf_title: "Subir PDF", upload_image_title: "Subir Imagen",
                    activate_mic: "Activar Micr√≥fono", toggle_voice: "Activar/Desactivar Voz",
                    understood_btn: "¬°Entendido!", view_details: "Ver Detalles",
                    back_to_list: "Volver a la lista",
                    credits_details_title: "Mi D√≠a",
                    current_plan_details: "Plan Activo: ",
                    credits_breakdown: "Cr√©ditos Restantes:",
                    upgrade_for_more: "Mejora tu plan para obtener m√°s.",
                    gamification_credits_info: "Adicionalmente, tienes tus <strong>Cr√©ditos de Recompensa (ü™ô)</strong> ganados en la gamificaci√≥n, que se usan autom√°ticamente cuando se agotan los de tu plan.",
                    view_plans_btn: "Ver Planes",
                    motivation_title: "Dosis de Motivaci√≥n",
                    motivation_notifications: "Notificaciones peri√≥dicas",
                    default_chat_title: "Conversaci√≥n C√≥smica",
                    rename_title: "Renombrar",
                    delete_title: "Eliminar",
                    add_to_folder_title: "Agregar a Carpeta",
                    tasks_completed_today: "Tareas completadas hoy:",
                    activities_today: "Actividades hoy:",
                    positive_message: "¬°Cada peque√±o paso te acerca a tu √©xito!",
                    view_active_plan: "Ver mi Plan Activo",
                    learn_about_credits: "¬øQu√© son los cr√©ditos?",
                    success_title: "√âxito",
                    new_chat_created: "Has creado un nuevo",
                    folder_created_message: "Carpeta",
                    created_suffix: "creada.",
                    note_created_message: "Se ha creado:",
                    read_aloud_title: "Leer en voz alta",
                    edit_message_title: "Editar mensaje",
                    save_changes_btn: "Guardar Cambios",
                    image_prompt_desc: "Describe la imagen que quieres crear:",
                    image_prompt_placeholder: "Ej: Un astronauta en un caballo c√≥smico",
                    generate_btn: "Generar",
                    generate_image_message: "Generar imagen:",
                    image_creation_success: "¬°Aqu√≠ est√° tu creaci√≥n, Jefe/a!",
                    image_creation_error: "‚ùå **Error al crear la imagen:**",
                    create_folder_title: "Crear Nueva Carpeta",
                    folder_name_placeholder: "Nombre de la Carpeta...",
                    create_btn: "Crear",
                    undo_action_warning: "Esta acci√≥n no se puede deshacer.",
                    also_delete_items_warning: "Tambi√©n se eliminar√°n los",
                    items_contained_warning: "elementos que contiene.",
                    conversation_text: "Conversaci√≥n",
                    project_text: "Proyecto",
                    note_text: "Nota",
                    rename_title_prefix: "Renombrar",
                    reading_pdf_status: "Leyendo...",
                    processing_pdf_status: "Procesando...",
                    pdf_ready_status: "Listo",
                    pages_short: "p√°g.",
                    pdf_error_status: "Error al leer PDF.",
                    restricted_access_title: "Acceso Restringido",
                    restricted_access_message: "El modelo GOAT X PRO est√° disponible solo para usuarios con un plan de pago.",
                    exclusive_feature_title: "Funci√≥n Exclusiva",
                    exclusive_feature_message: "La gamificaci√≥n est√° disponible para usuarios logueados.",
                    drawing_tool_line: "L√≠nea",
                    drawing_tool_rect: "Rect√°ngulo",
                    drawing_tool_circle: "C√≠rculo",
                    undo_drawing: "Deshacer",
                    redo_drawing: "Rehacer",
                    download_html: "Descargar HTML",
                    copy_code: "Copiar C√≥digo",
                    pending_tasks_today: "Tareas pendientes hoy:",
                    total_activities_today: "Actividades totales hoy:",
                },
                en: {
                    initializing: "Initializing...", new_chat: "New Chat", new_folder: "New Folder",
                    web_offer: "üöÄ Launch your Business, get a free website with your subscription!",
                    upgrade_plan: "Upgrade Plan", free_guides: "Free AI Guides", workflows: "Workflows",
                     wf_pm: "Project Assistant", wf_financial: "Financial Assistant", wf_notepad: "Notepad",
                    wf_expert: "Expert Assistant", wf_expert_1: "Decision Lab", wf_expert_2: "Conflict Resolution",
                    wf_social: "Social Media Booster", wf_social_1: "Create a Full Post", wf_social_2: "Copywriting",
                    wf_social_3: "Brainstorm Post Ideas", wf_social_4: "Define Brand Strategy",
                    wf_business: "Business Analysis", wf_business_1: "Analyze your Competition", wf_business_2: "Define my Ideal Customer",
                     wf_business_3: "Brainstorm Brand Names", wf_sales: "Communication & Sales", wf_sales_1: "Sales for your Business",
                    wf_sales_2: "Email Writing", wf_sales_3: "Web Design", wf_sales_4: "Improve Social Skills",
                    wf_english_teacher: "English Teacher", wf_eng_1: "Translate/Correct Text",
                    wf_eng_2: "Learn New Vocabulary", wf_eng_3: "Practice Conversation", quick_actions: "Quick Actions", my_projects: "My Projects",
                    select_chats: "Select Multiple Chats",
                    delete: "Delete", login: "Login", settings: "Settings", logout: "Logout",
                    solutions: "Solutions", ally_title: "We are your Strategic Ally",
                    ally_desc: "Goatify is not just a chat. We are a custom AI with a team of experts ready to help you scale your business.",
                    welcome_user: "Hello, ", welcome_user_2: "! Today is a great day to create something amazing.",
                    welcome_guest: "How can I help you today?", model: "Model:", model_general: "GOAT X",
                    model_web: "Web Search", voice: "Voz:", placeholder_main: "Type your message...", cancel: "Cancel",
                    confirm: "Confirm", plans_title: "Goatify Plans", plan_free_sub: "Forever", plan_free_cta: "Current Plan",
                    plan_boost_cta: "Get Boost", plan_pro_cta: "Get Pro Plan + Web",
                    preview: "Preview", settings_email: "Email Address:", settings_plan: "Subscription Plan:",
                    settings_fontsize: "Font Size:", settings_theme: "Personalization:", settings_dark_mode: "Dark Mode",
                     settings_lang: "Language:", settings_whatsapp: "Connect to WhatsApp", current_plan: "Current Plan",
                    settings_notifications: "Task Notifications:", settings_schedule_meeting: "Schedule Meeting",
                    settings_integrations: "Integrations", google_calendar_desc: "Sync your tasks and events.",
                    calendar_today: "Today", calendar_this_week: "This Week", calendar_mon: "Mon", calendar_tue: "Tue", calendar_wed: "Wed",
                     calendar_thu: "Thu", calendar_fri: "Fri", calendar_sat: "Sat", calendar_sun: "Sun",
                    calendar_no_tasks: "No tasks for this day.", calendar_add_task_placeholder: "Add new personal task...",
                    calendar_add_task_btn: "Add Task", calendar_my_calendar: "My Calendar & Tasks",
                    calendar_day_view: "Day View", calendar_month_view: "Month View", calendar_week_view: "Week View",
                     notification_task_due: "Time for: ", notification_title: "Goatify IA - Task Due!",
                    tasks_for: "Tasks for", add_task_for: "Add Task for",
                    delete_task_confirm_title: "Confirm Deletion", delete_task_confirm_body: "Are you sure you want to delete this task?",
                    delete_btn: "Delete", done_btn: "Done",
                    share_note: "Share Note",
                    share_note_desc: "Enter the email of the Goatify user you want to collaborate with on this note.",
                    share_note_email_placeholder: "example@email.com",
                    share_note_info: "Note: This functionality requires both users to have a Pro plan and is under development. For now, this is a demonstration.",
                    share_note_button: "Share",
                    share_financial_data: "Share Financial Data",
                    share_financial_data_desc: "Enter the email of the Goatify user you want to share this financial data with.",
                    share_financial_data_info: "Note: This functionality requires both users to have a Pro plan and is under development. For now, this is a demonstration.",
                    my_projects: "My Projects", add_to_folder: "Add to Folder", no_folders_yet: "No folders yet.",
                    new_note: "New Note", new_drawing_title: "New Drawing", note_title_placeholder: "Note title...",
                    bold_text: "Bold", italic_text: "Italic", underline_text: "Underline",
                    add_checklist: "Add Checklist", tool_pencil: "Pencil", tool_eraser: "Eraser", drawing_color: "Color", drawing_thickness: "Thickness", clear_all: "Clear All",
                    share_note_btn: "Share", delete_note_btn: "Delete Note", writing_assistant: "Writing Assistant",
                    notepad_placeholder: "Ask for ideas, summaries, or corrections...",
                    filter_tags: "Filter", views: "Views:", kanban: "Kanban", list: "List", add_task_btn_short: "Add Task",
                    project_calendar_title: "Project Calendar", project_assistant: "Project Assistant",
                    project_chat_placeholder: "Let Goatify organize your project...",
                    gamification_title: "The G.O.A.T. Ascension", daily_streak_tab: "Daily Streak", missions_tab: "Missions", achievements_tab: "Achievements",
                    rules_btn: "Rules", streak_desc: "Maintain your streak to earn XP, credits, and a special chest on day 7.",
                    rules_intro: "Welcome to your journey to become a G.O.A.T. (Greatest Of All Time) of digital entrepreneurship! The logic is simple: the more strategically you use the platform, the more rewards you get.",
                    xp_credits_title: "1. Experience Points (XP) vs. Reward Credits (ü™ô)",
                    xp_credits_desc: "There are two types of rewards:",
                    xp_desc: "Experience Points (XP): Measure your progress and mastery. XP is never spent, it only accumulates for you to level up and unlock new titles.",
                    credits_desc: "Reward Credits (ü™ô): Are a reserve of usable credits that you earn by completing missions and streaks. When your plan's daily credits run out, the system will automatically use these reward credits so you can continue working. They are your safety net to keep creating!",
                    how_to_level_up_title: "2. How to Level Up",
                    how_to_level_up_desc: "Accumulate enough XP to ascend in level. Each level represents a new stage in your mastery of marketing and business with AI.",
                    level_1: "Level 1: Digital Initiator", level_2: "Level 2: Content Creator", level_3: "Level 3: Marketing Strategist",
                    level_4: "Level 4: Digital CEO", level_5: "Level 5: G.O.A.T.",
                    how_to_earn_rewards_title: "3. How to Earn Rewards",
                    daily_streak_reward: "Daily Streak: Each consecutive day you log in gives you XP and Reward Credits.",
                    goat_chest_reward: "GOAT Chest (Day 7): Your big weekly reward for a 7-day streak! It can contain a large amount of credits, discount coupons for our implementation services (websites, automations), or even a FREE strategic consultation.",
                    missions_achievements_reward: "Missions & Achievements: The fastest way to earn big XP and Credit bonuses. Complete specific tasks to accelerate your ascent.",
                    rules_closing: "Every action counts on your way to the top! Go for it!",
                    create_image_title: "Create Image", upload_pdf_title: "Upload PDF", upload_image_title: "Upload Image",
                    activate_mic: "Activate Microphone", toggle_voice: "Toggle Voice",
                    understood_btn: "Got it!", view_details: "View Details",
                    back_to_list: "Back to list",
                    credits_details_title: "My Day",
                    current_plan_details: "Active Plan: ",
                    credits_breakdown: "Remaining Credits:",
                    upgrade_for_more: "Upgrade your plan for more.",
                    gamification_credits_info: "Additionally, you have your <strong>Reward Credits (ü™ô)</strong> earned from gamification, which are used automatically when your plan credits run out.",
                    view_plans_btn: "View Plans",
                    motivation_title: "Dose of Motivation",
                    motivation_notifications: "Periodic notifications",
                    default_chat_title: "Cosmic Conversation",
                    rename_title: "Rename",
                    delete_title: "Delete",
                    add_to_folder_title: "Add to Folder",
                    tasks_completed_today: "Tasks completed today:",
                    activities_today: "Activities today:",
                    positive_message: "Every small step brings you closer to success!",
                    view_active_plan: "View my Active Plan",
                    learn_about_credits: "What are credits?",
                    success_title: "Success",
                    new_chat_created: "You created a new",
                    folder_created_message: "Folder",
                    created_suffix: "created.",
                    note_created_message: "Created:",
                    read_aloud_title: "Read aloud",
                    edit_message_title: "Edit message",
                    save_changes_btn: "Save Changes",
                    image_prompt_desc: "Describe the image you want to create:",
                    image_prompt_placeholder: "Ex: An astronaut on a cosmic horse",
                    generate_btn: "Generate",
                    generate_image_message: "Generate image:",
                    image_creation_success: "Here's your creation, Boss!",
                    image_creation_error: "‚ùå **Error creating image:**",
                    create_folder_title: "Create New Folder",
                    folder_name_placeholder: "Folder Name...",
                    create_btn: "Create",
                    undo_action_warning: "This action cannot be undone.",
                    also_delete_items_warning: "Also deletes",
                    items_contained_warning: "contained items.",
                    conversation_text: "Conversation",
                    project_text: "Project",
                    note_text: "Note",
                    rename_title_prefix: "Rename",
                    reading_pdf_status: "Reading...",
                    processing_pdf_status: "Processing...",
                    pdf_ready_status: "Ready",
                    pages_short: "pgs.",
                    pdf_error_status: "Error reading PDF.",
                    restricted_access_title: "Restricted Access",
                    restricted_access_message: "The GOAT X PRO model is only available for paid users.",
                    exclusive_feature_title: "Exclusive Feature",
                    exclusive_feature_message: "Gamification is available for logged-in users.",
                    drawing_tool_line: "Line",
                    drawing_tool_rect: "Rectangle",
                    drawing_tool_circle: "Circle",
                    undo_drawing: "Undo",
                    redo_drawing: "Redo",
                    download_html: "Download HTML",
                    copy_code: "Copy Code",
                    pending_tasks_today: "Pending tasks today:",
                    total_activities_today: "Total activities today:",
                }
            };
            const GUEST_CREDIT_LIMIT = 5;
            const FREE_PLAN_CREDIT_LIMIT = 50;
            const BOOST_PLAN_CREDIT_LIMIT = 500;
            const PRO_PLAN_CREDIT_LIMIT = 2000;

            const MOTIVATIONAL_MESSAGES = [
                "Eres una persona incre√≠ble, ¬°nunca lo dudes!",
                "Hoy es tu d√≠a para brillar. ¬°Ve por ello!",
                "Tu potencial es infinito. ¬°Puedes lograr lo que te propongas!",
                "La rompes todos los d√≠as, ¬°sigue as√≠!",
                "Conf√≠a en tu proceso. Est√°s construyendo algo grandioso.",
                "Cada paso que das te acerca a tu meta. ¬°No te detengas!",
                "Tu energ√≠a es contagiosa. ¬°Ilumina el mundo!",
                "Puedes con todo y m√°s. ¬°Cree en ti!",
                "El √©xito es la suma de peque√±os esfuerzos repetidos d√≠a tras d√≠a.",
                "No importa lo lento que vayas, siempre y cuando no te detengas.",
                "La √∫nica forma de hacer un gran trabajo es amar lo que haces.",
                "Un objetivo bien definido es la mitad del √©xito.",
                "La disciplina es el puente entre las metas y los logros.",
                "El fracaso es la oportunidad de empezar de nuevo con m√°s inteligencia.",
                "No esperes. El momento nunca ser√° el 'perfecto'.",
                "Cree que puedes y ya est√°s a medio camino.",
                "La vida es 10% lo que te pasa y 90% c√≥mo reaccionas.",
                "El secreto para salir adelante es empezar."
            ];
            const MOTIVATION_BUTTON_TEXTS = ["¬°Listo!", "¬°Vamos a darle!", "¬°Perfecto!", "¬°S√≠, yo puedo!", "¬°Vamos!", "¬°Entendido!", "¬°A por todas!", "¬°Con toda la actitud!", "¬°A crear!"];

            const COSTS = {
                GENERAL: 1,
                SEARCH: 2,
                WORKFLOW: 2,
                PDF_ANALYSIS: 2,
                IMAGE_ANALYSIS: 2,
                IMAGE_GENERATION: 5,
                GPT4O: 3 // Cost for GPT-4o model
            };
            let state = { chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
            let gamificationState = {};
            let currentChatId = null, currentUser = null, speechOn = false, availableVoices = [], selectedVoice = null, isRecognizing = false, selectedImageBase64 = null, selectedPdfText = null;
            let micWasOnBeforeSpeaking = false;
            let modalResolve = null;
            let modalKeydownHandler = null; // To handle Enter key on modals
            let isSelectModeActive = false;
            let chatsToDelete = new Set();
            let currentNoteId = null;
            let goatXProUsage = 0; // Daily usage counter for GPT-4o
            const GOAT_X_PRO_DAILY_LIMIT = 10; // Daily limit for GPT-4o

            let notificationsEnabled = localStorage.getItem('goatify-notifications-enabled') === null ? true : localStorage.getItem('goatify-notifications-enabled') === 'true';
            let motivationEnabled = localStorage.getItem('goatify-motivation-enabled') === null ? true : localStorage.getItem('goatify-motivation-enabled') === 'true';

            let selectedCalendarDate = dayjs();
            let currentCalendarView = 'month';
            let activeTagFilter = null;
            let motivationInterval = null;
            const dom = {};

            const fullDom = {
                appContainer: document.getElementById('app-container'),
                msgInput: document.getElementById('msg'), sendBtn: document.getElementById('send'),
                inputArea: document.getElementById('input-area'),
                filePreviewArea: document.getElementById('file-preview-area'),
                messageCounterWrapper: document.getElementById('message-counter-wrapper'),
                planCreditsInfo: document.getElementById('plan-credits-info'),
                rewardCreditsInfo: document.getElementById('reward-credits-info'),
                upgradePlanContainer: document.getElementById('upgrade-plan-container'),
                upgradePlanBtn: document.getElementById('upgrade-plan-btn'),
                newChatBtn: document.getElementById('new-chat-btn'), newFolderBtn: document.getElementById('new-folder-btn'),
                pricingModal: document.getElementById('pricing-modal'), closePricingModalBtn: document.getElementById('close-pricing-modal'),
                genericModal: document.getElementById('generic-modal'),
                viewContainer: document.getElementById('view-container'),
                chatMessages: document.getElementById('chat-messages'),
                notepadViewContainer: document.getElementById('notepad-view-container'),
                chatTitle: document.getElementById('chat-title'), mobileChatTitle: document.getElementById('mobile-chat-title'),
                desktopChatTitleWrapper: document.getElementById('desktop-chat-title-wrapper'), mobileChatTitleWrapper: document.getElementById('mobile-chat-title-wrapper'),
                initialMessageContainer: document.getElementById('initial-message-container'), themeToggle: document.getElementById('theme-toggle'), themeIcon: document.getElementById('theme-icon'),
                micBtn: document.getElementById('mic-btn'), ttsToggle: document.getElementById('tts-toggle'),
                modelSelector: document.getElementById('model-selector'),
                actionButtonsContainer: document.getElementById('action-buttons-container'),
                imageUploadBtn: document.getElementById('image-upload-btn'), imageUploadInput: document.getElementById('image-upload'),
                imagePreviewContainer: document.getElementById('image-preview-container'), imagePreview: document.getElementById('image-preview'),
                clearImageBtn: document.getElementById('clear-image-btn'), pdfUploadBtn: document.getElementById('pdf-upload-btn'), pdfUploadInput: document.getElementById('pdf-upload'),
                pdfPreviewContainer: document.getElementById('pdf-preview-container'), pdfNameEl: document.getElementById('pdf-name'), pdfStatusEl: document.getElementById('pdf-status'), clearPdfBtn: document.getElementById('clear-pdf-btn'),
                sidebar: document.getElementById('sidebar'), menuToggle: document.getElementById('menu-toggle'), sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarContent: document.getElementById('sidebar-content'), loginView: document.getElementById('login-view'), userMenuView: document.getElementById('user-menu-view'),
                loginBtn: document.getElementById('login-btn'), userMenuBtn: document.getElementById('user-menu-btn'), userMenuPopup: document.getElementById('user-menu-popup'), userEmail: document.getElementById('user-email'),
                logoutBtn: document.getElementById('logout-btn'), webLaunchOfferBtn: document.getElementById('web-launch-offer-btn'),
                workflowsContainer: document.getElementById('workflows-container'), freeGuidesLink: document.getElementById('free-guides-link'),
                personalizedWelcome: document.getElementById('personalized-welcome'), genericWelcome: document.getElementById('generic-welcome'), userName: document.getElementById('user-name'),
                loadingOverlay: document.getElementById('loading-overlay'), htmlPreviewModal: document.getElementById('html-preview-modal'),
                closeHtmlPreviewModalBtn: document.getElementById('close-html-preview-modal'), htmlPreviewIframe: document.getElementById('html-preview-iframe'),
                downloadHtmlBtn: document.getElementById('download-html-btn'), copyHtmlBtn: document.getElementById('copy-html-btn'),
                voiceSelector: document.getElementById('voice-selector'),
                voiceSelectorContainer: document.getElementById('voice-selector-container'),
                selectChatsBtn: document.getElementById('select-chats-btn'), deleteModeControls: document.getElementById('delete-mode-controls'),
                deleteSelectedBtn: document.getElementById('delete-selected-btn'), cancelSelectModeBtn: document.getElementById('cancel-select-mode-btn'),
                imageGenBtn: document.getElementById('image-gen-btn'), servicesMenuBtn: document.getElementById('services-menu-btn'), servicesMenu: document.getElementById('services-menu'),
                contextualFooter: document.getElementById('contextual-footer'),
                newChatIconBtn: document.getElementById('new-chat-icon-btn'),
                newFolderIconBtn: document.getElementById('new-folder-icon-btn'),
                settingsBtn: document.getElementById('settings-btn'), userSettingsIcon: document.getElementById('user-settings-icon'),
                settingsModal: document.getElementById('settings-modal'), closeSettingsModal: document.getElementById('close-settings-modal'),
                settingsUserEmail: document.getElementById('settings-user-email'), settingsUserPlan: document.getElementById('settings-user-plan'),
                settingsUpgradePlanBtn: document.getElementById('settings-upgrade-plan-btn'), fontSizeSlider: document.getElementById('font-size-slider'),
                fontSizeValue: document.getElementById('font-size-value'), settingsThemeToggle: document.getElementById('settings-theme-toggle'),
                settingsThemeIcon: document.getElementById('settings-theme-icon'), languageSelector: document.getElementById('language-selector'),
                connectWhatsappBtn: document.getElementById('connect-whatsapp-btn'), scheduleMeetingBtn: document.getElementById('schedule-meeting-btn'), freePlanButton: document.getElementById('free-plan-button'),
                notificationsToggle: document.getElementById('notifications-toggle'),
                mainChatArea: document.getElementById('main-chat-area'),
                calendarModalOverlay: document.getElementById('calendar-modal-overlay'),
                calendarModal: document.getElementById('calendar-modal'),
                calendarBtn: document.getElementById('calendar-btn'), mobileCalendarBtn: document.getElementById('calendar-btn-mobile'),
                closeCalendarModal: document.getElementById('close-calendar-modal'),
                prevMonthBtn: document.getElementById('prev-month'), nextMonthBtn: document.getElementById('next-month'),
                currentMonthYear: document.getElementById('current-month-year'), calendarDaysGrid: document.getElementById('calendar-days-grid'),
                addTaskBtn: document.getElementById('add-task-btn'),
                notificationBadge: document.getElementById('notification-badge'), mobileNotificationBadge: document.getElementById('notification-badge-mobile'),
                inAppNotification: document.getElementById('in-app-notification'),
                inAppNotificationTitle: document.getElementById('in-app-notification-title'),
                inAppNotificationBody: document.getElementById('in-app-notification-body'),
                inAppNotificationClose: document.getElementById('in-app-notification-close'),
                taskNotificationModal: document.getElementById('task-notification-modal'),
                taskNotificationTitle: document.getElementById('task-notification-title'),
                taskNotificationBody: document.getElementById('task-notification-body'),
                taskNotificationCloseBtn: document.getElementById('task-notification-close-btn'),
                monthViewContainer: document.getElementById('month-view-container'), weekViewContainer: document.getElementById('week-view-container'),
                dayViewContainer: document.getElementById('day-view-container'),
                monthViewBtn: document.getElementById('month-view-btn'), weekViewBtn: document.getElementById('week-view-btn'), dayViewBtn: document.getElementById('day-view-btn'),
                prevWeekBtn: document.getElementById('prev-week'), nextWeekBtn: document.getElementById('next-week'),
                currentWeekRange: document.getElementById('current-week-range'), weekDaysContent: document.getElementById('week-days-content'),
                prevDayBtn: document.getElementById('prev-day'), nextDayBtn: document.getElementById('next-day'),
                currentDayDisplay: document.getElementById('current-day-display'), dayViewTimeline: document.getElementById('day-view-timeline'),
                projectManagementView: document.getElementById('project-management-view'),
                projectBoardContainer: document.getElementById('project-board-container'),
                projectChatContainer: document.getElementById('project-chat-container'),
                projectChatToggle: document.getElementById('project-chat-toggle'),
                projectChatHeader: document.getElementById('project-chat-container-header'),
                projectViewTitle: document.getElementById('project-view-title'),
                kanbanView: document.getElementById('kanban-view'),
                listView: document.getElementById('list-view'),
                listViewMobile: document.getElementById('list-view-mobile'),
                viewToggleKanban: document.getElementById('view-toggle-kanban'),
                viewToggleList: document.getElementById('view-toggle-list'),
                addTaskListViewBtn: document.getElementById('add-task-list-view-btn'),
                projectChatMessages: document.getElementById('project-chat-messages'),
                projectMsgInput: document.getElementById('project-msg'),
                projectSendBtn: document.getElementById('project-send'),
                projectCalendarBtn: document.getElementById('project-calendar-btn'),
                tagFilterBtn: document.getElementById('tag-filter-btn'),
                tagFilterDropdown: document.getElementById('tag-filter-dropdown'),
                financialAssistantView: document.getElementById('financial-assistant-view'),
                gamificationBtn: document.getElementById('gamification-btn'), // This button does not exist in HTML
                gamificationModal: document.getElementById('gamification-modal'),
                closeGamificationModal: document.getElementById('close-gamification-modal'),
                gamificationLevelName: document.getElementById('gamification-level-name'),
                gamificationXp: document.getElementById('gamification-xp'),
                gamificationCredits: document.getElementById('gamification-credits'),
                gamificationXpBar: document.getElementById('gamification-xp-bar'),
                dailyStreakContainer: document.getElementById('daily-streak-container'),
                missionsContainer: document.getElementById('gamification-tab-misiones'),
                achievementsContainer: document.getElementById('achievements-container'),
                gamificationRulesBtn: document.getElementById('gamification-rules-btn'),
                gamificationRulesModal: document.getElementById('gamification-rules-modal'),
                closeGamificationRulesModal: document.getElementById('close-gamification-rules-modal'),
                motivationBtnHeader: document.getElementById('motivation-btn-header'),
                motivationBtnMobile: document.getElementById('motivation-btn-mobile'),
                motivationModal: document.getElementById('motivation-modal'),
                motivationTitle: document.getElementById('motivation-title'),
                motivationQuote: document.getElementById('motivation-quote'),
                motivationToggle: document.getElementById('motivation-toggle'),
                closeMotivationModal: document.getElementById('close-motivation-modal'),
                sidebarToggleArrow: document.getElementById('sidebar-toggle-arrow'),
                foldersContainer: document.getElementById('folders-container'),
                addProjectFolderBtn: document.getElementById('add-project-folder-btn'),

                // Notepad DOM elements
                notesListPanel: document.getElementById('notes-list-panel'),
                notesListHeader: document.getElementById('notes-list-header'),
                noteEditorPanel: document.getElementById('note-editor-panel'),
                noteTitleInput: document.getElementById('note-title-input'),
                noteEditorToolbar: document.getElementById('note-editor-toolbar'),
                textTools: document.getElementById('text-tools'),
                drawingTools: document.getElementById('drawing-tools'),
                deleteNoteBtn: document.getElementById('delete-note-btn'),
                shareNoteBtn: document.getElementById('share-note-btn'),
                addChecklistItemBtn: document.getElementById('add-checklist-item-btn'),
                noteContentArea: document.getElementById('note-content-area'),
                noteContentEditor: document.getElementById('note-content-editor'),
                noteCanvas: document.getElementById('note-canvas'),
                addNewNoteBtn: document.getElementById('add-new-note-btn'),
                addNewDrawingBtn: document.getElementById('add-new-drawing-btn'),
                noteBackBtn: document.getElementById('note-back-btn'),
                notepadChatContainer: document.getElementById('notepad-chat-container'),
                notepadChatHeader: document.getElementById('notepad-chat-header'),
                notepadChatToggle: document.getElementById('notepad-chat-toggle'),
                notepadChatMessages: document.getElementById('notepad-chat-messages'),
                notepadMsgInput: document.getElementById('notepad-msg'),
                notepadSendBtn: document.getElementById('notepad-send'),
                planCreditsDisplay: document.getElementById('plan-credits-display'),
                rewardCreditsDisplay: document.getElementById('reward-credits-display'),
                boldBtn: document.getElementById('bold-btn'),
                italicBtn: document.getElementById('italic-btn'),
                underlineBtn: document.getElementById('underline-btn'),
                fontFamilySelector: document.getElementById('font-family-selector'),
                toolLine: document.getElementById('tool-line'),
                toolRect: document.getElementById('tool-rect'),
                toolCircle: document.getElementById('tool-circle'),
                undoDrawingBtn: document.getElementById('undo-drawing-btn'),
                redoDrawingBtn: document.getElementById('redo-drawing-btn'),
                currentDateDisplay: document.getElementById('current-date-display'),
                currentTimeDisplay: document.getElementById('current-time-display'),
            };
            Object.assign(dom, fullDom);

            const XP_FOR_LEVEL = [0, 250, 750, 2000, 5000, Infinity];
            const LEVEL_NAMES = ["Iniciador Digital", "Creador de Contenido", "Estratega de Marketing", "CEO Digital", "G.O.A.T."];
            const MISSIONS = {
                'brand-strategy': { id: 'brand-strategy', text: 'Define tu primera estrategia de marca', xp: 50, credits: 15, workflow: 'brand-strategy', completed: false },
                'competitor-analysis': { id: 'competitor-analysis', text: 'Esp√≠a a la competencia por primera vez', xp: 50, credits: 15, workflow: 'competitor-analysis', completed: false },
                'week-organized': { id: 'week-organized', text: 'Crea una tarea para cada d√≠a de la semana', xp: 75, credits: 25, condition: checkWeekOrganized, completed: false },
                'project-created': { id: 'project-created', text: 'Crea tu primer proyecto y a√±ade 3 tareas', xp: 100, credits: 30, condition: (chatId) => checkProjectCreated(chatId, 3), completed: false },
                'image-generated': { id: 'image-generated', text: 'Genera tu primera imagen con IA', xp: 40, credits: 10, action: 'generateImage', completed: false },
                'english-practice': { id: 'english-practice', text: 'Practica tu conversaci√≥n en ingl√©s', xp: 30, credits: 10, workflow: 'english-teacher-practice', completed: false },
                'social-skills': { id: 'social-skills', text: 'Mejora tus habilidades sociales con un consejo de IA', xp: 30, credits: 10, workflow: 'social-skills', completed: false },
                'conflict-resolution': { id: 'conflict-resolution', text: 'Analiza tu primer conflicto con IA', xp: 40, credits: 15, workflow: 'conflict-resolution', completed: false },
                'decision-lab': { id: 'decision-lab', text: 'Usa el Laboratorio de Decisiones', xp: 50, credits: 20, workflow: 'decision-lab', completed: false },
            };
            const ACHIEVEMENTS = {
                'streak-30': { id: 'streak-30', title: 'Consistencia', description: 'Mant√©n la racha diaria por 30 d√≠as.', icon: 'fa-calendar-check', xp: 500, credits: 250 },
                'project-master': { id: 'project-master', title: 'Project Master', description: 'Completa 10 proyectos.', icon: 'fa-sitemap', xp: 1000, credits: 0, reward: '50% de descuento en consultor√≠a de automatizaci√≥n.' },
                'influencer': { id: 'influencer', title: 'Influencer', description: 'Genera 50 publicaciones para redes sociales.', icon: 'fa-bullhorn', xp: 750, credits: 0, reward: 'Un mes de GOAT Boost gratis.' },
            };

            function setLanguage(lang) {
                const translationData = translations[lang];
                if (!translationData) return;
                dayjs.locale(lang);
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    if (translationData[key]) {
                        const isIconOnlyButton = el.tagName === 'BUTTON' && el.querySelector('i') && !el.querySelector('span');

                        if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT' || el.tagName === 'SELECT') {
                            if (el.placeholder) el.placeholder = translationData[key];
                            if (el.title) el.title = translationData[key];
                        } else if (isIconOnlyButton) {
                            el.title = translationData[key];
                        } else {
                            const icon = el.querySelector('i');
                            const textSpan = el.querySelector('span');
                            if (textSpan) {
                                textSpan.textContent = translationData[key];
                            } else if (icon) {
                                let textNode = null;
                                for (const node of el.childNodes) {
                                    if (node.nodeType === Node.TEXT_NODE && node.textContent.trim().length > 0) {
                                        textNode = node;
                                        break;
                                    }
                                }
                                if (textNode) {
                                    textNode.textContent = ` ${translationData[key]}`;
                                } else {
                                    el.textContent = translationData[key];
                                }
                            } else {
                                el.textContent = translationData[key];
                            }
                        }
                    }
                });
                document.documentElement.lang = lang;
                localStorage.setItem('goatify-lang', lang);
                renderCalendarView();
                renderSidebar();
                renderGamificationModal();
                updateCreditCounter();
            }

            function updateContextualFooter(workflowKey) {
                if (!dom.contextualFooter) return;
                const workflowTexts = {
                    'create-full-post': 'Modo Redes Sociales: Define tu red social y tema para un post completo.',
                    'persuasive-copy': 'Modo Copywriter: Dime qu√© vendes y para d√≥nde es el texto.',
                    'brand-strategy': 'Modo Estratega: Dime el nombre y rubro de tu negocio para empezar.',
                     'competitor-analysis': 'Modo Analista: Pega la URL de tu competencia para investigarla.',
                    'sales-assistant': 'Modo Ventas: Pega el mensaje de tu cliente para responder.',
                    'english-teacher-practice': 'Practice mode: Let\'s talk. How was your day.',
                    'design-web': 'Modo Dise√±ador Web: Describe el componente visual y lo crear√© en HTML.',
                    'project-management': 'Modo Director de Proyectos: Describe tu proyecto para crear tareas en el tablero.',
                    'conflict-resolution': 'Modo Mediador: Describe la situaci√≥n de conflicto para encontrar una soluci√≥n.',
                    'decision-lab': 'Modo Estratega: Describe la decisi√≥n que enfrentas y tus opciones.',
                    'financial-assistant': 'Modo Financiero: Usa la tabla para registrar transacciones. P√≠deme an√°lisis en el chat.',
                    'notepad-app': 'Bloc de Notas: Organiza tus ideas, todo se guarda autom√°ticamente. Usa el chat para pedir ideas o correcciones.',
                    'notepad-assistant': 'Asistente de Redacci√≥n: Pide ideas, res√∫menes o ayuda para mejorar y corregir la ortograf√≠a de tu texto actual.',
                };
                const currentChat = state.chats[currentChatId];
                const key = workflowKey || (currentChat ? currentChat.workflow : (currentChatId === 'notepad-app' ? 'notepad-app' : null));
                dom.contextualFooter.textContent = workflowTexts[key] || 'Tu copiloto de IA para hacer crecer tu negocio.';
            }

            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            function showModal({ title, body, confirmText = 'Confirmar', cancelText = 'Cancelar', showCancel = true, showConfirm = true, extraButtons = [], dangerConfirm = false }) {
                const modalTitle = dom.genericModal.querySelector('#modal-title');
                const modalBody = dom.genericModal.querySelector('#modal-body');
                const modalButtonsContainer = dom.genericModal.querySelector('#modal-buttons-container');

                modalTitle.innerHTML = title;
                modalBody.innerHTML = body;

                let buttonsHTML = '';
                if (showCancel) {
                    buttonsHTML += `<button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded">${cancelText}</button>`;
                }
                extraButtons.forEach(btn => {
                    buttonsHTML += `<button id="${btn.id}" class="${btn.classes || 'px-4 py-2 rounded bg-gray-500 text-white'}">${btn.text}</button>`;
                });
                if (showConfirm) {
                    const confirmClasses = dangerConfirm ? 'btn-danger' : 'btn-primary';
                    buttonsHTML += `<button id="modal-confirm" class="px-4 py-2 rounded text-white ${confirmClasses}">${confirmText}</button>`;
                }
                modalButtonsContainer.innerHTML = buttonsHTML;

                if (showConfirm) {
                    dom.genericModal.querySelector('#modal-confirm').addEventListener('click', () => {
                        const inputs = modalBody.querySelectorAll('input, textarea, select');
                        const data = {};
                        inputs.forEach(input => {
                            data[input.id] = input.type === 'checkbox' ? input.checked : input.value;
                        });
                        hideModal({ confirmed: true, data });
                    }, { once: true });
                }

                if (showCancel) {
                    dom.genericModal.querySelector('#modal-cancel').addEventListener('click', () => hideModal({ confirmed: false }), { once: true });
                }
                extraButtons.forEach(btn => {
                    const buttonElement = dom.genericModal.querySelector(`#${btn.id}`);
                    if(buttonElement) {
                        buttonElement.addEventListener('click', (e) => {
                            btn.action(e, modalBody);
                        });
                    }
                });

                const confirmButton = dom.genericModal.querySelector('#modal-confirm');
                modalKeydownHandler = (e) => {
                    if (e.key === 'Enter') {
                        if (e.target.tagName !== 'TEXTAREA') {
                            e.preventDefault();
                            if (confirmButton) {
                                confirmButton.click();
                            }
                        }
                    }
                };
                document.addEventListener('keydown', modalKeydownHandler);

                dom.genericModal.classList.remove('hidden');
                dom.genericModal.classList.add('flex');

                return new Promise(resolve => { modalResolve = resolve; });
            }
            function hideModal(resolveWith = null) {
                if (modalKeydownHandler) {
                    document.removeEventListener('keydown', modalKeydownHandler);
                    modalKeydownHandler = null;
                }
                if(modalResolve) {
                    modalResolve(resolveWith);
                    modalResolve = null;
                }
                dom.genericModal.classList.add('hidden');
                dom.genericModal.classList.remove('flex');
            }

            function showPricingModal() {
                dom.pricingModal.classList.remove('hidden');
                dom.pricingModal.classList.add('flex');
                setTimeout(() => { dom.pricingModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);

                const lang = localStorage.getItem('goatify-lang') || 'es';
                const isFree = !currentUser || (currentUser.app_metadata?.plan || 'free') === 'free';

                if (isFree) {
                    dom.freePlanButton.textContent = translations[lang].current_plan;
                    dom.freePlanButton.disabled = true;
                    dom.freePlanButton.classList.add('btn-disabled');
                } else {
                    dom.freePlanButton.textContent = translations[lang].plan_free_cta;
                    dom.freePlanButton.disabled = false;
                    dom.freePlanButton.classList.remove('btn-disabled');
                }
            }

            function hidePricingModal() { dom.pricingModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => { dom.pricingModal.classList.add('hidden'); dom.pricingModal.classList.remove('flex'); }, 300); }

            function showSettingsModal() {
                dom.settingsModal.classList.remove('hidden');
                dom.settingsModal.classList.add('flex');
                if (currentUser) {
                    dom.settingsUserEmail.textContent = currentUser.email;
                    const userPlan = currentUser.app_metadata?.plan || 'free';
                    dom.settingsUserPlan.textContent = userPlan.charAt(0).toUpperCase() + userPlan.slice(1);
                    dom.settingsUpgradePlanBtn.classList.toggle('hidden', userPlan !== 'free');
                } else {
                    dom.settingsUserEmail.textContent = 'Not logged in';
                    dom.settingsUserPlan.textContent = 'Free (Guest)';
                    dom.settingsUpgradePlanBtn.classList.remove('hidden');
                }
                dom.fontSizeSlider.value = parseInt(getComputedStyle(document.body).getPropertyValue('--base-font-size')) || 16;
                dom.fontSizeValue.textContent = `${dom.fontSizeSlider.value}px`;
                dom.settingsThemeIcon.className = `fas fa-${document.body.classList.contains('dark-theme') ? 'sun' : 'moon'}`;
                dom.languageSelector.value = localStorage.getItem('goatify-lang') || 'es';
                dom.notificationsToggle.checked = notificationsEnabled;
            }

            function hideSettingsModal() {
                dom.settingsModal.classList.add('hidden');
                dom.settingsModal.classList.remove('flex');
            }

            function showInAppNotification(title, body, duration = 5000) {
                dom.inAppNotificationTitle.innerHTML = title;
                dom.inAppNotificationBody.innerHTML = body;
                dom.inAppNotification.classList.add('show');

                let timer;

                const closeNotification = (event) => {
                    if (event && event.target.closest('button, a')) {
                        return;
                    }
                    if(timer) clearTimeout(timer);
                    dom.inAppNotification.classList.remove('show');
                    dom.inAppNotification.removeEventListener('click', closeNotification);
                    dom.inAppNotificationClose.removeEventListener('click', closeFromX);
                };

                const closeFromX = (event) => {
                    event.stopPropagation();
                    closeNotification();
                };

                dom.inAppNotification.addEventListener('click', closeNotification);
                dom.inAppNotificationClose.addEventListener('click', closeFromX);

                if(duration) {
                    timer = setTimeout(closeNotification, duration);
                }
            }
            async function triggerPushNotification(title, body) {
                console.log("Intentando disparar notificaci√≥n push...");
                if (!currentUser) {
                    console.log("No hay usuario logueado, no se puede enviar la notificaci√≥n push.");
                    return;
                }

                try {
                    const response = await fetch('/.netlify/functions/send-push', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: currentUser.id,
                            title,
                            body,
                        }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Error desde el backend al enviar la notificaci√≥n:", errorData);
                    } else {
                        console.log("Petici√≥n para enviar push al backend fue exitosa.");
                    }
                } catch (error) {
                    console.error("Error de red al intentar disparar la notificaci√≥n push:", error);
                }
            }

            function urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }

            async function registerServiceWorkerAndSubscribe() {
                if (!('serviceWorker' in navigator && 'PushManager' in window)) {
                    console.warn("Las notificaciones Push no son soportadas en este navegador.");
                    notificationsEnabled = false;
                    return;
                }

                try {
                    const registration = await navigator.serviceWorker.register('/service-worker.js', { scope: '/' });
                    console.log('Service Worker registrado exitosamente.');

                    if (Notification.permission !== 'granted') {
                        console.log("El permiso para notificaciones a√∫n no ha sido concedido.");
                        return;
                    }

                    let subscription = await registration.pushManager.getSubscription();
                    if (subscription === null) {
                        console.log("No se encontr√≥ suscripci√≥n, creando una nueva.");

                        const VAPID_PUBLIC_KEY = 'BJ4v02ExA1Tso9D_s2zXJGXWf_Q-wG2t6RkcuU_k9mLyD_i_Ld16Gq2g4Gf4K_V8A2f4g7J1zX9Z8hE3D4A0f5Y';

                        subscription = await registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                        });
                        console.log('Nueva suscripci√≥n creada:', subscription);

                        await fetch('/.netlify/functions/save-subscription', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: currentUser.id,
                                subscription: subscription
                            }),
                        });
                        console.log("Suscripci√≥n enviada al backend para ser guardada.");
                    } else {
                        console.log("Ya existe una suscripci√≥n:", subscription);
                    }

                } catch (error) {
                    console.error('Fall√≥ el registro del Service Worker o la suscripci√≥n:', error);
                    notificationsEnabled = false;
                    if(dom.notificationsToggle) dom.notificationsToggle.checked = false;
                    localStorage.setItem('goatify-notifications-enabled', 'false');
                }
            }

            function showTaskNotification(title, body) {
                dom.taskNotificationModal.classList.remove('hidden');
                dom.taskNotificationModal.classList.add('flex');
                dom.taskNotificationTitle.textContent = title;

                const glowingBody = body.replace(/(Es hora de:.*)/, '<span class="glowing-text">$1</span>');
                dom.taskNotificationBody.innerHTML = glowingBody;

                triggerPushNotification(title, body);
            }

            function hideTaskNotification() {
                dom.taskNotificationModal.classList.add('hidden');
                dom.taskNotificationModal.classList.remove('flex');
            }

            function showCalendarModal() {
                dom.calendarModalOverlay.classList.remove('hidden');
                dom.calendarModalOverlay.classList.add('flex');
                if (!currentCalendarView) currentCalendarView = 'month';
                renderCalendarView();
                updateCalendarTime(); // Update time when modal opens
                updateMiDiaInfo(); // Update Mi D√≠a info when modal opens
            }

            function hideCalendarModal() {
                dom.calendarModalOverlay.classList.add('hidden');
                dom.calendarModalOverlay.classList.remove('flex');
            }

            function updateCalendarTime() {
                const now = dayjs();
                dom.currentDateDisplay.textContent = now.format('dddd, D [de] MMMM [de]YYYY');
                dom.currentTimeDisplay.textContent = now.format('HH:mm:ss');
            }
            setInterval(updateCalendarTime, 1000);

            // Function to update "Mi D√≠a" information
            function updateMiDiaInfo() {
                const lang = localStorage.getItem('goatify-lang') || 'es';
                const todayKey = dayjs().format('YYYY-MM-DD');
                const allTasksToday = getTasksForDay(todayKey);
                const completedTasksToday = allTasksToday.filter(task => task.completed).length;
                const totalPendingTasksToday = allTasksToday.filter(task => !task.completed).length;

                let totalChatActivities = 0;
                Object.values(state.chats).forEach(chat => {
                    if(chat.messages) {
                        chat.messages.forEach(msg => {
                            if (dayjs(msg.timestamp).isSame(dayjs(), 'day')) {
                                totalChatActivities++;
                            }
                        });
                    }
                });
                const totalActivitiesToday = completedTasksToday + totalPendingTasksToday + Math.floor(totalChatActivities / 2); // Roughly messages / 2 for user+assistant pairs

                const planCreditsInfo = getCreditCount();
                const totalCredits = planCreditsInfo.remaining + (gamificationState.credits || 0);

                const userName = currentUser ? (currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.email.split('@')[0]) : '';
                let greetingTitle = 'Jefe';
                if (userName.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(userName.toLowerCase())) {
                    greetingTitle = 'Jefa';
                }
                const modalWelcomeGreeting = dom.genericModal.querySelector('#modal-welcome-user-greeting');
                if (modalWelcomeGreeting) {
                    modalWelcomeGreeting.innerHTML = `¬°Hola, <span class="text-primary">${userName || greetingTitle}</span>! Ten un excelente d√≠a.`;
                }


                const completedTasksEl = dom.genericModal.querySelector('#calendar-info-completed-tasks');
                if(completedTasksEl) completedTasksEl.textContent = `${completedTasksToday}/${allTasksToday.length}`;

                const pendingTasksEl = dom.genericModal.querySelector('#calendar-info-pending-tasks');
                if(pendingTasksEl) pendingTasksEl.textContent = `${totalPendingTasksToday}`;

                const totalActivitiesEl = dom.genericModal.querySelector('#calendar-info-total-activities');
                if(totalActivitiesEl) totalActivitiesEl.textContent = `${totalActivitiesToday}`;

                const totalCreditsEl = dom.genericModal.querySelector('#calendar-info-total-credits');
                if(totalCreditsEl) totalCreditsEl.textContent = `${totalCredits} (${planCreditsInfo.remaining}/${planCreditsInfo.limit === Infinity ? '‚àû' : planCreditsInfo.limit} plan + ${gamificationState.credits || 0} ü™ô)`;
            }


            function renderMonthView() {
                dom.calendarDaysGrid.innerHTML = '';
                dom.currentMonthYear.textContent = selectedCalendarDate.format('MMMM YYYY');
                const startDay = selectedCalendarDate.startOf('month').startOf('isoWeek');

                for (let i = 0; i < 42; i++) {
                    const day = startDay.add(i, 'day');
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.dataset.date = day.format('YYYY-MM-DD');

                    dayEl.innerHTML = `<span class="calendar-day-number">${day.date()}</span><div class="calendar-day-tasks"></div>`;

                    if (day.month() === selectedCalendarDate.month()) {
                        dayEl.classList.add('current-month');
                    } else {
                        dayEl.classList.add('other-month');
                    }
                    if (day.isSame(dayjs(), 'day')) {
                        dayEl.classList.add('today');
                    }

                    const tasksContainer = dayEl.querySelector('.calendar-day-tasks');
                    const tasksForDay = getTasksForDay(day.format('YYYY-MM-DD'));
                    tasksForDay.slice(0, 3).forEach(task => {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'calendar-day-task';
                        taskEl.textContent = task.text;
                        taskEl.style.backgroundColor = getLabelColor(task.source === 'Personal' ? 'Personal' : (task.labels && task.labels[0] ? task.labels[0] : 'default'));
                        taskEl.draggable = true;
                        taskEl.dataset.taskId = task.id;
                        taskEl.dataset.taskSource = task.source;
                        taskEl.innerHTML = `
                            ${task.text}
                            <i class="fas fa-times delete-task-icon" data-task-id="${task.id}" data-task-source="${task.source}"></i>
                        `;
                        tasksContainer.appendChild(taskEl);
                    });

                    dayEl.addEventListener('click', (e) => {
                        if(e.target.classList.contains('delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(e.target.dataset.taskId);
                        } else if(e.target === e.currentTarget || e.target.classList.contains('calendar-day-tasks')) {
                             editCalendarTask(null, day.format('YYYY-MM-DD'));
                        } else if(e.target.closest('.calendar-day-task')) {
                            const taskEl = e.target.closest('.calendar-day-task');
                            handleTaskClick(taskEl.dataset.taskId, taskEl.dataset.taskSource);
                        }
                    });
                    dayEl.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    dayEl.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    dayEl.addEventListener('drop', handleCalendarDrop);
                    tasksContainer.querySelectorAll('.calendar-day-task').forEach(t => t.addEventListener('dragstart', handleCalendarDragStart));
                    tasksContainer.querySelectorAll('.calendar-day-task').forEach(t => t.addEventListener('touchstart', handleTouchStart, {passive: false}));

                    dom.calendarDaysGrid.appendChild(dayEl);
                }
            }

            function renderWeekView() {
                dom.weekDaysContent.innerHTML = '';
                let startOfWeek = selectedCalendarDate.startOf('isoWeek');

                const endOfWeek = startOfWeek.add(6, 'day');
                dom.currentWeekRange.textContent = `${startOfWeek.format('D MMM')} - ${endOfWeek.format('D MMM, YYYY')}`;

            for (let i = 0; i < 7; i++) {
                    const day = startOfWeek.add(i, 'day');
                    const dayKey = day.format('YYYY-MM-DD');
                    const tasks = getTasksForDay(dayKey);
                    const lang = localStorage.getItem('goatify-lang') || 'es';
                    const displayDate = day.format('dddd, D MMM');
                    const daySection = document.createElement('div');
                    daySection.className = 'week-day-section';
                    daySection.dataset.date = dayKey;

                    daySection.innerHTML = `
                        <h5>
                            <span>${displayDate}</span>
                            <button class="add-task-to-day-btn text-lg hover:text-primary" data-date="${dayKey}">+</button>
                        </h5>
                        <div class="space-y-1">
                            ${tasks.length === 0 ? `<p class="text-xs text-text-medium italic" data-translate-key="calendar_no_tasks">${translations[lang].calendar_no_tasks}</p>` : ''}
                            ${tasks.map((task) => {
                                const isPersonal = task.source === 'Personal';
                                return `
                                <div class="task-item flex items-center gap-2 cursor-pointer ${task.completed ? 'task-item-completed' : ''}"
                                     draggable="true" data-task-id="${task.id}" data-task-source="${task.source}">
                                     <input type="checkbox" class="task-checkbox flex-shrink-0" data-task-id="${task.id}" ${task.completed ? 'checked' : ''}>
                                    <span class="flex-grow">${task.text} ${task.time ? `(${task.time})` : ''} <span class="text-xs text-primary">(${task.source})</span></span>
                                    <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            `}).join('')}
                        </div>
                     `;
                    dom.weekDaysContent.appendChild(daySection);
                    daySection.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    daySection.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    daySection.addEventListener('drop', handleCalendarDrop);
                    daySection.addEventListener('click', (e) => {
                         if(e.target === e.currentTarget || e.target.classList.contains('space-y-1')) {
                            editCalendarTask(null, dayKey);
                        }
                    });
                }

                dom.weekDaysContent.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        updateTaskStatus(e.currentTarget.dataset.taskId, { completed: e.currentTarget.checked });
                    });
                 });

                dom.weekDaysContent.querySelectorAll('.task-item').forEach(item => {
                    item.addEventListener('dragstart', handleCalendarDragStart);
                    item.addEventListener('touchstart', handleTouchStart, {passive: false});
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(item.dataset.taskId);
                            return;
                        }
                        if (e.target.type === 'checkbox') return;
                        handleTaskClick(item.dataset.taskId, item.dataset.taskSource);
                     });
                });
                dom.weekDaysContent.querySelectorAll('.add-task-to-day-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const date = e.currentTarget.dataset.date;
                        editCalendarTask(null, date);
                    });
                });
            }

            function renderDayView() {
                dom.currentDayDisplay.textContent = selectedCalendarDate.format('dddd, D [de] MMMM');
                dom.dayViewTimeline.innerHTML = '';
                const tasksForDay = getTasksForDay(selectedCalendarDate.format('YYYY-MM-DD'));

                for (let hour = 0; hour < 24; hour++) {
                    const hourEl = document.createElement('div');
                    hourEl.className = 'day-view-hour';
                    const hourLabel = (hour < 10 ? '0' : '') + hour + ':00';
                    hourEl.dataset.time = hourLabel.substring(0,2);
                    const tasksInHour = tasksForDay.filter(t => t.time && t.time.startsWith((hour < 10 ? '0' : '') + hour));
                    hourEl.innerHTML = `
                        <div class="day-view-hour-label">${hourLabel}</div>
                        <div class="day-view-hour-content" data-time="${hourLabel}" data-date="${selectedCalendarDate.format('YYYY-MM-DD')}">
                            ${tasksInHour.map(task => {
                                return `
                                 <div class="task-item flex items-center gap-2 p-1 rounded-md ${task.completed ? 'bg-green-900/50 text-gray-400 line-through' : 'bg-input'} text-sm"
                                    draggable="true" data-task-id="${task.id}" data-task-source="${task.source}">
                                    <input type="checkbox" class="task-checkbox flex-shrink-0" data-task-id="${task.id}" ${task.completed ? 'checked' : ''}>
                                     <span class="flex-grow cursor-pointer"><strong>${task.time}:</strong> ${task.text} <span class="text-xs text-primary">(${task.source})</span></span>
                                    <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            `}).join('')}
                             <button class="add-task-to-time-btn text-lg hover:text-primary" data-date="${selectedCalendarDate.format('YYYY-MM-DD')}" data-time="${hourLabel}">+</button>
                        </div>
                    `;
                    dom.dayViewTimeline.appendChild(hourEl);

                    const hourContent = hourEl.querySelector('.day-view-hour-content');
                    hourContent.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    hourContent.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    hourContent.addEventListener('drop', handleCalendarDrop);
                     hourContent.addEventListener('click', (e) => {
                         if(e.target === e.currentTarget) {
                            editCalendarTask(null, selectedCalendarDate.format('YYYY-MM-DD'), e.currentTarget.dataset.time);
                        }
                    });
                }
                dom.dayViewTimeline.querySelectorAll('.add-task-to-time-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const date = e.currentTarget.dataset.date;
                         const time = e.currentTarget.dataset.time;
                        editCalendarTask(null, date, time);
                    });
                });
                dom.dayViewTimeline.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        updateTaskStatus(e.currentTarget.dataset.taskId, { completed: e.currentTarget.checked });
                    });
                });
                dom.dayViewTimeline.querySelectorAll('.task-item').forEach(item => {
                    item.addEventListener('dragstart', handleCalendarDragStart);
                    item.addEventListener('touchstart', handleTouchStart, {passive: false});
                    item.addEventListener('click', (e) => {
                         if (e.target.closest('.delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(item.dataset.taskId);
                            return;
                        }
                        if (e.target.type === 'checkbox') return;
                        handleTaskClick(item.dataset.taskId, item.dataset.taskSource);
                    });
                 });
            }

            function handleTaskClick(taskId, taskSource) {
                 if (taskSource === 'Personal') {
                    editCalendarTask(taskId);
                } else {
                    const projectChat = Object.values(state.chats).find(c => c.projectData && c.projectData.title === taskSource);
                    if (projectChat) {
                        editProjectTask(projectChat.id, taskId);
                    }
                }
            }

            let draggedCalendarTaskId = null;
            function handleCalendarDragStart(e) {
                const target = e.target.closest('[draggable="true"]');
                if (!target) return;
                draggedCalendarTaskId = target.dataset.taskId;
                e.dataTransfer.setData('text/plain', draggedCalendarTaskId);
                e.dataTransfer.effectAllowed = 'move';
            }

            function handleCalendarDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.style.backgroundColor = '';
                const taskId = e.dataTransfer.getData('text/plain');
                if (!taskId) return;

                const dropZone = e.currentTarget;
                const newDate = dropZone.dataset.date;
                let newTime = dropZone.dataset.time || findTask(taskId)?.task?.time || null;

                if (newTime && newTime.length === 2) {
                   const originalTask = findTask(taskId)?.task;
                   const originalMinutes = originalTask?.time?.substring(3,5) || '00';
                   newTime = `${newTime}:${originalMinutes}`;
                }

                const updates = { date: newDate, time: newTime };
                updateTaskStatus(taskId, updates);
            }

            let touchDragElement = null, ghostElement = null;
            let startX, startY;
            function handleTouchStart(e) {
                if (e.touches.length !== 1) return;
                const target = e.target.closest('[draggable="true"]');
                if (!target) return;

                touchDragElement = target;

                ghostElement = touchDragElement.cloneNode(true);
                ghostElement.style.position = 'absolute';
                ghostElement.style.zIndex = '1000';
                ghostElement.style.opacity = '0.7';
                ghostElement.style.pointerEvents = 'none';
                ghostElement.style.width = `${touchDragElement.offsetWidth}px`;
                document.body.appendChild(ghostElement);

                const touch = e.touches[0];
                startX = touch.pageX;
                startY = touch.pageY;
                ghostElement.style.left = `${startX - ghostElement.offsetWidth / 2}px`;
                ghostElement.style.top = `${startY - ghostElement.offsetHeight / 2}px`;

                document.addEventListener('touchmove', handleTouchMove, {passive: false});
                document.addEventListener('touchend', handleTouchEnd);
            }
            function handleTouchMove(e) {
                if (e.touches.length !== 1 || !ghostElement) return;
                e.preventDefault();
                const touch = e.touches[0];
                ghostElement.style.left = `${touch.pageX - ghostElement.offsetWidth / 2}px`;
                ghostElement.style.top = `${touch.pageY - ghostElement.offsetHeight / 2}px`;
            }
            function handleTouchEnd(e) {
                if (!ghostElement) return;

                ghostElement.style.display = 'none';
                const dropTarget = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
                ghostElement.remove();

                if (dropTarget) {
                    const dropZone = dropTarget.closest('.calendar-day, .week-day-section, .day-view-hour-content, .kanban-cards, .list-view-column-mobile, .list-view-content > h4, .project-header');
                    if(dropZone) {
                        const taskId = touchDragElement.dataset.taskId;
                        if (dropZone.classList.contains('kanban-cards')) {
                            const chatId = currentChatId;
                            const columnId = dropZone.dataset.columnId;
                            moveTask(chatId, taskId, columnId);
                        } else if(dropZone.classList.contains('list-view-column-mobile')) {
                            const chatId = currentChatId;
                            const columnId = dropZone.dataset.columnId;
                            moveTask(chatId, taskId, columnId);
                        } else if (dropZone.tagName === 'H4' && dropZone.closest('#list-view')) {
                             const columnTitle = dropZone.textContent.trim();
                             const chat = state.chats[currentChatId];
                             const targetColumn = chat.projectData.columns.find(c => c.title === columnTitle);
                             if (targetColumn) {
                                 moveTask(currentChatId, taskId, targetColumn.id);
                             }
                        }
                        else if (dropZone.classList.contains('project-header')) {
                            const targetProjectId = dropZone.closest('.project').dataset.id;
                            moveItemToProject(draggedItemId, targetProjectId);
                        }
                        else {
                            const newDate = dropZone.dataset.date;
                            let newTime = dropZone.dataset.time || findTask(taskId)?.task?.time || null;
                            if (newTime && newTime.length === 2) {
                                const originalTask = findTask(taskId)?.task;
                                const originalMinutes = originalTask?.time?.substring(3,5) || '00';
                                newTime = `${newTime}:${originalMinutes}`;
                            }
                            updateTaskStatus(taskId, { date: newDate, time: newTime });
                        }
                    }
                }

                touchDragElement = null; ghostElement = null;
                document.removeEventListener('touchmove', handleTouchMove);
                document.removeEventListener('touchend', handleTouchEnd);
            }

            function findTask(taskId) {
                if (!taskId) return null;
                if (taskId.startsWith('cal-')) {
                    for (const dayKey in state.calendar) {
                        const taskIndex = (state.calendar[dayKey] || []).findIndex(t => t.id === taskId);
                        if (taskIndex > -1) {
                            return { type: 'personal', task: state.calendar[dayKey][taskIndex], dayKey, taskIndex };
                        }
                    }
                } else if (taskId.startsWith('proj-')) {
                    for (const chat of Object.values(state.chats)) {
                        if (chat.projectData && chat.projectData.columns) {
                            for (const column of chat.projectData.columns) {
                                const taskIndex = (column.tasks || []).findIndex(t => t.id === taskId);
                                if (taskIndex > -1) {
                                     return { type: 'project', task: column.tasks[taskIndex], chat, column, taskIndex };
                                }
                            }
                        }
                    }
                }
                return null;
            }

            function updateTaskStatus(taskId, updates) {
                const found = findTask(taskId);
                if (!found) return;

                if (found.type === 'personal') {
                    const { task, dayKey } = found;
                    const oldDate = dayKey;
                    const newDate = updates.date || oldDate;

                    if (oldDate !== newDate) {
                        const taskIndex = state.calendar[oldDate].findIndex(t => t.id === taskId);
                        const [taskToMove] = state.calendar[oldDate].splice(taskIndex, 1);
                        if(state.calendar[oldDate].length === 0) delete state.calendar[oldDate];

                        if (!state.calendar[newDate]) state.calendar[newDate] = [];
                        Object.assign(taskToMove, updates);
                        delete taskToMove.date;
                        state.calendar[newDate].push(taskToMove);
                    } else {
                        delete updates.date;
                        Object.assign(task, updates);
                    }
                }
                else if (found.type === 'project') {
                    const { task, chat } = found;
                    const originalCompleted = task.completed;
                    Object.assign(task, updates);

                    if (updates.completed !== undefined && updates.completed !== originalCompleted) {
                        let sourceColumn, taskIndex;
                        for(const col of chat.projectData.columns){
                            const idx = (col.tasks || []).findIndex(t => t.id === taskId);
                            if(idx > -1){
                                sourceColumn = col;
                                taskIndex = idx;
                                break;
                            }
                        }

                        if (sourceColumn) {
                            const [taskToMove] = sourceColumn.tasks.splice(taskIndex, 1);
                            if (task.completed) {
                                const doneColumn = chat.projectData.columns.find(c => c.id === 'done');
                                if (doneColumn && sourceColumn.id !== 'done') doneColumn.tasks.push(taskToMove);
                                else sourceColumn.tasks.push(taskToMove);
                            } else {
                                const todoColumn = chat.projectData.columns.find(c => c.id === 'todo');
                                if (todoColumn && sourceColumn.id === 'done') todoColumn.tasks.push(taskToMove);
                                else sourceColumn.tasks.push(taskToMove);
                            }
                        }
                    }
                }

                saveState();
                if (dom.calendarModalOverlay.classList.contains('flex')) {
                    renderCalendarView();
                }
                if (dom.projectManagementView.style.display === 'flex') {
                    renderProjectBoard(currentChatId);
                }
            }


            function getTasksForDay(dayKey) {
                const calendarTasks = (state.calendar[dayKey] || []).map(t => ({...t, text: t.content, source: 'Personal'}));
                const projectTasks = [];
                Object.values(state.chats).forEach(chat => {
                    if (chat.projectData && chat.projectData.columns) {
                        chat.projectData.columns.forEach(column => {
                            (column.tasks || []).forEach(task => {
                                 if (task.dueDate === dayKey) {
                                    projectTasks.push({...task, source: chat.projectData.title, text: task.content});
                                }
                             });
                        });
                    }
                });
                return [...calendarTasks, ...projectTasks].sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
            }

            function updateNotificationBadge() {
                 let pendingNotifications = 0;
                const now = dayjs();
                Object.keys(state.calendar).forEach(dayKey => {
                    const tasksForDay = getTasksForDay(dayKey);
                    tasksForDay.forEach(task => {
                         if (!task.completed) {
                            if (task.time) {
                                const taskDateTime = dayjs(`${dayKey}T${task.time}`);
                                if (taskDateTime.isBefore(now)) {
                                     pendingNotifications++;
                                }
                            } else {
                                const taskDate = dayjs(dayKey);
                                if (taskDate.isBefore(now, 'day') || taskDate.isSame(now, 'day')) {
                                    pendingNotifications++;
                                }
                            }
                         }
                    });
                });

                const badgeEl = document.getElementById('notification-badge');
                const mobileBadgeEl = document.getElementById('notification-badge-mobile');

                if (pendingNotifications > 0) {
                    badgeEl.textContent = pendingNotifications;
                    badgeEl.classList.remove('hidden');
                    mobileBadgeEl.textContent = pendingNotifications;
                    mobileBadgeEl.classList.remove('hidden');
                } else {
                    badgeEl.classList.add('hidden');
                    mobileBadgeEl.classList.add('hidden');
                }
            }

            function checkAndNotifyTasks() {
                if (!notificationsEnabled) return;
                const now = dayjs();
                const todayKey = now.format('YYYY-MM-DD');
                const currentHourMinute = now.format('HH:mm');
                const allTasksToday = getTasksForDay(todayKey);
                allTasksToday.forEach(task => {
                    if (!task.completed && task.time === currentHourMinute && !task.notifiedThisMinute) {
                        const lang = localStorage.getItem('goatify-lang') || 'es';
                        const notificationTitle = translations[lang].notification_title;
                        const notificationBody = `${translations[lang].notification_task_due} ${task.text} (${task.time})`;

                        showTaskNotification(notificationTitle, notificationBody);

                        updateTaskNotifiedFlag(task.id, true);
                    }
                });
                for (const dayKey in state.calendar) {
                    if(state.calendar[dayKey]) {
                        state.calendar[dayKey].forEach(task => {
                            const taskDate = dayjs(dayKey);
                            const taskDateTime = task.time ? dayjs(`${dayKey}T${task.time}`) : taskDate;
                            if (task.notifiedThisMinute && taskDateTime.isBefore(now, 'minute')) {
                                task.notifiedThisMinute = false;
                            }
                        });
                    }
                }
                saveState();
                updateNotificationBadge();
            }

            function updateTaskNotifiedFlag(taskId, isNotified) {
                const found = findTask(taskId);
                if (found) {
                    found.task.notifiedThisMinute = isNotified;
                }
            }


            function renderCalendarView() {
                 dom.dayViewContainer.style.display = currentCalendarView === 'day' ? 'block' : 'none';
                dom.weekViewContainer.style.display = currentCalendarView === 'week' ? 'block' : 'none';
                dom.monthViewContainer.style.display = currentCalendarView === 'month' ? 'block' : 'none';

                dom.dayViewBtn.classList.toggle('active', currentCalendarView === 'day');
                dom.weekViewBtn.classList.toggle('active', currentCalendarView === 'week');
                dom.monthViewBtn.classList.toggle('active', currentCalendarView === 'month');

                if (currentCalendarView === 'day') renderDayView();
                if (currentCalendarView === 'week') renderWeekView();
                if (currentCalendarView === 'month') renderMonthView();
            }

            setInterval(checkAndNotifyTasks, 10 * 1000);

            function speak(text, element) {
                if (!text) return;

                if (speechOn) {
                    if (!('speechSynthesis' in window)) return;
                    speechSynthesis.cancel();
                    micWasOnBeforeSpeaking = isRecognizing;
                    if (isRecognizing) { recognition.stop(); }
                    const cleanText = text.replace(/<[^>]*>/g, '').replace(/[*_`#~[\]()üîç]|(-{3,})/g, '');
                    const utterance = new SpeechSynthesisUtterance(cleanText);
                    if (selectedVoice) { utterance.voice = selectedVoice;
                    }
                    utterance.rate = 1.15;
                    utterance.onend = () => {
                        if (micWasOnBeforeSpeaking) {
                            if (recognition && !isRecognizing) {
                                try { recognition.start(); } catch(e) { console.error("Error restarting recognition:", e); }
                            }
                            micWasOnBeforeSpeaking = false;
                        }
                    };
                    utterance.onerror = (e) => {
                        console.error('Speech synthesis error:', e);
                        if (micWasOnBeforeSpeaking) {
                            if (recognition && !isRecognizing) {
                               try { recognition.start(); } catch(e) { console.error("Error restarting recognition on error:", e); }
                            }
                            micWasOnBeforeSpeaking = false;
                        }
                    }
                    speechSynthesis.speak(utterance);
                } else if (element) {
                    speechSynthesis.cancel();
                    const cleanText = text.replace(/<[^>]*>/g, '').replace(/[*_`#~[\]()üîç]|(-{3,})/g, '');
                    const utterance = new SpeechSynthesisUtterance(cleanText);
                    if (selectedVoice) utterance.voice = selectedVoice;
                    utterance.rate = 1.15;
                    speechSynthesis.speak(utterance);
                }
            }

            function populateVoiceList() {
                const setVoices = () => {
                    if (typeof speechSynthesis === 'undefined') { return; }
                    availableVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('es-') || v.lang.startsWith('en-'));
                    const preferredVoices = [ "Microsoft Sabina Online (Natural) - Spanish (Mexico)", "Paulina", "Google espa√±ol de Estados Unidos", "Google espa√±ol" ];
                    availableVoices.sort((a, b) => {
                        let aIdx = preferredVoices.indexOf(a.name); let bIdx = preferredVoices.indexOf(b.name);
                        if (aIdx === -1) aIdx = Infinity; if (bIdx === -1) bIdx = Infinity;
                        if (aIdx !== bIdx) return aIdx - bIdx;
                        return a.name.localeCompare(b.name);
                    });

                    if (availableVoices.length > 0) {
                        dom.voiceSelector.innerHTML = '';
                        availableVoices.forEach(voice => {
                            const option = document.createElement('option');
                            const displayName = voice.name.replace('Microsoft', '').replace('Online (Natural) -', '').replace('Google', '').replace('Spanish (Mexico)','Mex').trim();
                            option.textContent = `${displayName || voice.lang} (${voice.lang})`;
                            option.value = voice.name;
                            dom.voiceSelector.appendChild(option);
                        });
                        selectedVoice = availableVoices[0];
                        if (selectedVoice) dom.voiceSelector.value = selectedVoice.name;
                    }
                }
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = setVoices;
                }
                setVoices();
            }

            function getModelForRequest(workflow, hasFile, assistantType) {
                let selector;
                switch (assistantType) {
                    case 'project':
                        selector = document.getElementById('project-model-selector');
                        break;
                    case 'financial':
                        selector = document.getElementById('financial-model-selector');
                        break;
                    case 'notepad':
                        selector = document.getElementById('notepad-model-selector');
                        break;
                    default:
                        selector = dom.modelSelector;
                }

                if (workflow === "design-web") return "gpt-4o-mini";
                if (hasFile) return "gpt-4o-mini";

                const selectedModel = selector.value;
                if (selectedModel === 'gpt-4o' && (!currentUser || (currentUser.app_metadata?.plan || 'free') === 'free')) {
                     showInAppNotification("Acceso Restringido", "El modelo GOAT X PRO est√° disponible solo para usuarios con un plan de pago.", 3000);
                     selector.value = 'gpt-3.5-turbo-1106';
                     return 'gpt-3.5-turbo-1106';
                }
                return selectedModel;
            }

            async function getAIResponse(prompt, history, image, pdf, model, workflow, userName, financialData = null, noteContent = null) {
                const name = (userName || '').split(' ')[0];
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }
                const body = {
                    prompt, history, model,
                    workflow, userName: name, title,
                    imageData: image, pdfText: pdf,
                    financialData, noteContent,
                 };
                try {
                    const response = await fetch('/.netlify/functions/get-ai-response', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(body),
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({details: 'Error desconocido en el servidor'}));
                        console.error("Backend Error:", errorData);
                        throw new Error(errorData.details || `Error del servidor: ${response.status}.`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("Fetch Error:", error);
                    throw error;
                }
            }

            function getCreditCount() {
                if (!currentUser) {
                    const usageData = JSON.parse(localStorage.getItem('guest_usage')) || { count: 0 };
                    return { remaining: Math.max(0, GUEST_CREDIT_LIMIT - usageData.count), limit: GUEST_CREDIT_LIMIT, plan: 'free (guest)' };
                }

                const plan = currentUser.app_metadata?.plan || 'free';
                let limit;
                switch (plan) {
                    case 'boost': limit = BOOST_PLAN_CREDIT_LIMIT; break;
                    case 'pro': limit = PRO_PLAN_CREDIT_LIMIT; break;
                    default: limit = FREE_PLAN_CREDIT_LIMIT;
                }

                const usageKey = `usage_monthly_${currentUser.id}`;
                const currentMonth = dayjs().format('YYYY-MM');
                const usageData = JSON.parse(localStorage.getItem(usageKey)) || { count: 0, month: '' };

                if (usageData.month !== currentMonth) {
                    return { remaining: limit, limit, plan };
                }

                return { remaining: Math.max(0, limit - usageData.count), limit, plan };
            }

            function spendCredits(cost, modelUsed) {
                if (modelUsed === 'gpt-4o') {
                    const today = dayjs().format('YYYY-MM-DD');
                    const proUsageKey = `goat_x_pro_usage_${currentUser?.id || 'guest'}_${today}`;
                    goatXProUsage = parseInt(localStorage.getItem(proUsageKey) || '0');

                    if (goatXProUsage >= GOAT_X_PRO_DAILY_LIMIT) {
                        showModal({
                            title: 'L√≠mite de Uso Alcanzado para GOAT X PRO',
                            body: `Has alcanzado el l√≠mite de ${GOAT_X_PRO_DAILY_LIMIT} usos diarios para el modelo GOAT X PRO. Por favor, usa el modelo GOAT X (General) o espera hasta ma√±ana para volver a usar GOAT X PRO.`,
                            confirmText: 'Entendido',
                            showCancel: false
                        }).then(() => {
                            dom.modelSelector.value = 'gpt-3.5-turbo-1106';
                            if (document.getElementById('project-model-selector')) document.getElementById('project-model-selector').value = 'gpt-3.5-turbo-1106';
                            if (document.getElementById('financial-model-selector')) document.getElementById('financial-model-selector').value = 'gpt-3.5-turbo-1106';
                            if (document.getElementById('notepad-model-selector')) document.getElementById('notepad-model-selector').value = 'gpt-3.5-turbo-1106';
                        });
                        return false;
                    }
                }

                if (currentUser && gamificationState.credits >= cost) {
                    gamificationState.credits -= cost;
                    saveGamificationState();
                    updateCreditCounter();
                    showInAppNotification("Cr√©dito de Recompensa Usado", `Se ha utilizado un cr√©dito de recompensa. Te quedan ${gamificationState.credits}.`, 2000);

                    if (modelUsed === 'gpt-4o') {
                        const today = dayjs().format('YYYY-MM-DD');
                        const proUsageKey = `goat_x_pro_usage_${currentUser?.id || 'guest'}_${today}`;
                        goatXProUsage++;
                        localStorage.setItem(proUsageKey, goatXProUsage.toString());
                    }
                    return true;
                }

                if (!currentUser) {
                    const usageKey = 'guest_usage';
                    let usageData = JSON.parse(localStorage.getItem(usageKey)) || { count: 0 };
                    if (usageData.count + cost > GUEST_CREDIT_LIMIT) {
                         showModal({
                            title: 'Cr√©ditos de Invitado Agotados',
                            body: `<p>Has utilizado tus ${GUEST_CREDIT_LIMIT} cr√©ditos de invitado. <strong>Inicia sesi√≥n para obtener 50 cr√©ditos mensuales m√°s, ¬°gratis!</strong></p><p class="mt-2 text-sm text-text-medium">Tambi√©n puedes usar este link para agendar una reuni√≥n y conocer nuestros planes.</p>`,
                            confirmText: 'Iniciar Sesi√≥n',
                            cancelText: 'M√°s Tarde',
                            extraButtons: [{
                                id: 'guest-meeting-btn',
                                classes: 'px-4 py-2 rounded btn-primary text-white',
                                text: 'Agendar Reuni√≥n',
                                action: () => {
                                    window.open('https://calendly.com/goatify', '_blank');
                                    hideModal();
                                }
                            }]
                        }).then(res => { if (res.confirmed) { netlifyIdentity.open('login'); } });
                        return false;
                    }
                    usageData.count += cost;
                    localStorage.setItem(usageKey, JSON.stringify(usageData));
                    updateCreditCounter();

                    if (modelUsed === 'gpt-4o') {
                        const today = dayjs().format('YYYY-MM-DD');
                        const proUsageKey = `goat_x_pro_usage_${currentUser?.id || 'guest'}_${today}`;
                        goatXProUsage++;
                        localStorage.setItem(proUsageKey, goatXProUsage.toString());
                    }
                    return true;
                }

                const { remaining } = getCreditCount();
                if (remaining < cost) {
                    showModal({
                        title: 'Cr√©ditos Insuficientes',
                        body: 'No tienes suficientes cr√©ditos este mes. Mejora tu plan para obtener m√°s o espera al pr√≥ximo mes.',
                        confirmText: 'Ver Planes'
                    }).then(res => { if (res.confirmed) showPricingModal(); });
                    return false;
                }

                const usageKey = `usage_monthly_${currentUser.id}`;
                const currentMonth = dayjs().format('YYYY-MM');
                let usageData = JSON.parse(localStorage.getItem(usageKey)) || { count: 0, month: '' };

                if (usageData.month !== currentMonth) {
                    usageData = { count: 0, month: currentMonth };
                }

                usageData.count += cost;
                localStorage.setItem(usageKey, JSON.stringify(usageData));
                updateCreditCounter();

                if (modelUsed === 'gpt-4o') {
                    const today = dayjs().format('YYYY-MM-DD');
                    const proUsageKey = `goat_x_pro_usage_${currentUser?.id || 'guest'}_${today}`;
                    goatXProUsage++;
                    localStorage.setItem(proUsageKey, goatXProUsage.toString());
                }
                return true;
            }

            async function loadStateForUser() {
                const loadLocalStorage = (key) => {
                    const saved = localStorage.getItem(key);
                    return saved ? JSON.parse(saved) : {};
                };

                if (!currentUser) {
                    const guestData = loadLocalStorage('guestState');
                    state = guestData.state || { chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
                    currentChatId = guestData.currentChatId || null;
                } else {
                     try {
                        const response = await fetch('/.netlify/functions/load-chats', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId: currentUser.id }),
                        });
                        if (!response.ok) { throw new Error(`Server error: ${response.status}`); }
                        const dbState = await response.json();
                        state = dbState.state || { chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
                        currentChatId = dbState.currentChatId;
                    } catch (error) {
                        console.error("Could not load from DB, falling back to localStorage:", error);
                        const userLocalData = loadLocalStorage(`goatbotState_${currentUser.id}`);
                        state = userLocalData.state || { chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
                        currentChatId = userLocalData.currentChatId;
                    }
                }

                state.calendar = state.calendar || {};
                state.projects = state.projects || {};
                state.chats = state.chats || {};
                state.structure = state.structure || [];
                state.notes = state.notes || [];

                // Ensure notepad-assistant-chat exists and is not deletable
                if (!state.chats['notepad-assistant-chat']) {
                    state.chats['notepad-assistant-chat'] = {
                        id: 'notepad-assistant-chat',
                        title: 'Asistente de Redacci√≥n',
                        messages: [{ role: 'assistant', content: '¬°Hola! Soy tu asistente de redacci√≥n. Pega tu texto aqu√≠ o p√≠deme ideas para empezar. Tambi√©n puedo corregir la ortograf√≠a.' }],
                        workflow: 'notepad-assistant',
                        isDeletable: false,
                    };
                }

                // Initialize goatXProUsage for the current day
                const today = dayjs().format('YYYY-MM-DD');
                const proUsageKey = `goat_x_pro_usage_${currentUser?.id || 'guest'}_${today}`;
                goatXProUsage = parseInt(localStorage.getItem(proUsageKey) || '0');

                loadGamificationState();
                renderSidebar();
                // Ensure currentChatId is valid after loading state
                if (currentChatId && (state.chats[currentChatId] || state.notes.find(n => n.id === currentChatId))) {
                    selectChat(currentChatId);
                } else if (state.structure.length > 0) {
                    selectChat(state.structure[0]); // Select the first item if current one is invalid
                } else {
                    resetChatView(); // Fallback if nothing to select
                }
            }

            async function saveState() {
                const stateData = { state, currentChatId };
                const key = currentUser ? `goatbotState_${currentUser.id}` : 'guestState';

                try {
                    localStorage.setItem(key, JSON.stringify(stateData));
                    if(currentUser) {
                        await fetch('/.netlify/functions/save-chats', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId: currentUser.id, stateToSave: stateData }),
                        });
                    }
                } catch (error) {
                    console.error("Failed to save state:", error);
                }
            }

            function updateUserUI() {
                const goatXProModels = document.querySelectorAll('.goat-x-pro-model');
                if (currentUser) {
                    dom.loginView.classList.add('hidden');
                    dom.userMenuView.classList.remove('hidden');
                    dom.genericWelcome.classList.add('hidden');
                    dom.personalizedWelcome.classList.remove('hidden');
                    const userName = currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.email.split('@')[0];
                    dom.userEmail.textContent = currentUser.user_metadata?.full_name || currentUser.email;
                    dom.userName.textContent = userName;
                    dom.upgradePlanContainer.classList.toggle('hidden', (currentUser.app_metadata?.plan || 'free') !== 'free');
                    goatXProModels.forEach(option => option.disabled = false);

                } else {
                    dom.loginView.classList.remove('hidden');
                    dom.userMenuView.classList.add('hidden');
                    dom.genericWelcome.classList.remove('hidden');
                    dom.personalizedWelcome.classList.add('hidden');
                    dom.upgradePlanContainer.classList.add('hidden');
                    goatXProModels.forEach(option => option.disabled = true);
                }
                updateCreditCounter();
            }

            function updateCreditCounter() {
                const { remaining, limit } = getCreditCount();
                const gamCredits = (currentUser && gamificationState.credits) ? gamificationState.credits : 0;
                let displayLimit = limit === Infinity ? '‚àû' : limit;

                dom.planCreditsDisplay.textContent = `${remaining}/${displayLimit}`;
                dom.rewardCreditsDisplay.textContent = `${gamCredits}`;

                dom.messageCounterWrapper.classList.remove('hidden');
            }

            function setTheme(isDark) {
                document.body.className = 'w-screen overflow-x-hidden';
                document.body.classList.add(isDark ? 'dark-theme' : 'light-theme');
                dom.themeIcon.className = `fas fa-${isDark ? 'sun' : 'moon'}`;
                if (dom.settingsThemeIcon) dom.settingsThemeIcon.className = `fas fa-${isDark ? 'moon' : 'sun'} mr-2`;
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            }

            function toggleSidebar(show) {
                const sidebar = dom.sidebar;
                if (show) {
                    sidebar.classList.add('is-open');
                    sidebar.classList.remove('collapsed');
                    dom.sidebarOverlay.classList.remove('opacity-0', 'pointer-events-none');
                    dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-right', 'fa-chevron-left');
                } else {
                    sidebar.classList.remove('is-open');
                    dom.sidebarOverlay.classList.add('opacity-0', 'pointer-events-none');
                    dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-left', 'fa-chevron-right');
                }
            }

            function createNewChat(options = {}) {
                const id = 'chat-' + crypto.randomUUID();
                const name = currentUser ? (currentUser.user_metadata.full_name?.split(' ')[0] || 'T√∫') : 'viajero';
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }

                let initialMessages;
                initialMessages = options.initialMessages ||
                [{
                    role: 'assistant',
                    content: `Saludos, ${title}. Soy Goatify IA, aqu√≠ para servirte. Cada idea tuya es una estrella a punto de nacer. ¬øEn qu√© universo nos sumergimos hoy?`
                }];

                state.chats[id] = {
                    id,
                    title: options.title || translations[localStorage.getItem('goatify-lang') || 'es'].default_chat_title || "Conversaci√≥n C√≥smica",
                    messages: initialMessages,
                    workflow: options.workflow || null,
                    model: options.model || 'gpt-3.5-turbo-1106'
                };

                if (options.workflow === 'project-management') {
                    state.chats[id].projectData = {
                        title: options.title,
                        columns: [
                             { id: 'todo', title: 'Por Hacer', tasks: [] },
                            { id: 'doing', title: 'En Progreso', tasks: [] },
                            { id: 'done', title: 'Hecho', tasks: [] }
                         ],
                        currentView: 'list'
                    };
                }
                if (options.workflow === 'financial-assistant') {
                    state.chats[id].financialData = {
                        incomeCategories: [],
                        expenseCategories: []
                    };
                }

                state.structure.unshift(id);
                selectChat(id);
                saveState();
                renderSidebar();
                dom.modelSelector.value = options.model || 'gpt-3.5-turbo-1106';
                if (window.innerWidth < 768) toggleSidebar(false);

                const chatType = options.title || 'chat';
                showInAppNotification(translations[localStorage.getItem('goatify-lang') || 'es'].success_title || "√âxito", `${translations[localStorage.getItem('goatify-lang') || 'es'].new_chat_created || "Has creado un nuevo" } ${chatType}.`, 800);

                return id;
            }

            function selectChat(chatId) {
                currentChatId = chatId;
                if (isSelectModeActive) return;

                dom.notepadViewContainer.classList.remove('mobile-editor-active');

                if (!chatId || (!state.chats[chatId] && !state.notes.find(n => n.id === chatId) && chatId !== 'notepad-app')) {
                    resetChatView();
                    return;
                }

                dom.chatMessages.style.display = 'none';
                dom.projectManagementView.style.display = 'none';
                dom.financialAssistantView.style.display = 'none';
                dom.notepadViewContainer.style.display = 'none';
                dom.inputArea.style.display = 'none';

                if (chatId.startsWith('note-') || chatId === 'notepad-app') {
                    dom.chatTitle.textContent = translations[localStorage.getItem('goatify-lang') || 'es'].wf_notepad;
                    dom.mobileChatTitle.textContent = translations[localStorage.getItem('goatify-lang') || 'es'].wf_notepad;
                    showNotepadView();

                    if (chatId.startsWith('note-')) {
                        selectNote(chatId);
                    } else {
                        if (state.notes.length > 0) {
                            selectNote(state.notes[0].id);
                        } else {
                            dom.noteEditorPanel.classList.add('hidden');
                        }
                    }
                } else {
                    const chat = state.chats[chatId];
                    if(!chat) { resetChatView(); return; } // Safety check

                    if (chat.workflow === 'project-management') {
                        dom.projectManagementView.style.display = 'flex';
                        renderProjectView(chatId);
                    } else if (chat.workflow === 'financial-assistant') {
                        dom.financialAssistantView.style.display = 'flex';
                        renderFinancialAssistant(chatId);
                    } else {
                        dom.chatMessages.style.display = 'block';
                        dom.inputArea.style.display = 'flex';
                        dom.chatMessages.innerHTML = '';
                        chat.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, msg.image, index, dom.chatMessages));
                        dom.initialMessageContainer.style.display = 'none';
                    }

                    dom.chatTitle.textContent = chat.title;
                    dom.mobileChatTitle.textContent = chat.title;
                    dom.modelSelector.value = chat.model || 'gpt-3.5-turbo-1106';
                    updateContextualFooter(chat.workflow);
                }

                updateActiveChatHighlight();
                saveState();
                if (window.innerWidth < 768) toggleSidebar(false);
            }

            function resetChatView() {
                currentChatId = null;
                dom.chatTitle.textContent = "Goatify IA";
                dom.mobileChatTitle.textContent = "Goatify IA";

                dom.chatMessages.style.display = 'block';
                dom.inputArea.style.display = 'flex';
                dom.projectManagementView.style.display = 'none';
                dom.financialAssistantView.style.display = 'none';
                dom.notepadViewContainer.style.display = 'none';

                dom.chatMessages.innerHTML = '';
                dom.initialMessageContainer.style.display = 'flex';
                updateUserUI();
                updateActiveChatHighlight();
                dom.modelSelector.value = 'gpt-3.5-turbo-1106';
                updateContextualFooter(null);
            }

            function addMessageToUI(role, content, imageSrc, messageIndex, container) {
                if (!container) return null;
                const wrapper = document.createElement('div');
                wrapper.className = `chat-bubble-wrapper group flex items-start gap-2 my-2 ${role === 'user' ? 'justify-end' : 'justify-start'}`;

                const bubble = document.createElement('div');
                bubble.className = `p-3 md:p-4 rounded-xl max-w-lg md:max-w-xl ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot'}`;
                if (imageSrc) {
                    const img = document.createElement('img');
                    img.src = imageSrc;
                    img.className = 'rounded-lg mb-2 max-w-full h-auto';
                    bubble.appendChild(img);
                }
                const contentDiv = document.createElement('div');
                contentDiv.className = 'markdown-content';
                const parsedContent = content === '‚Ä¶' ? `<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .2s;"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .4s;"></div></div>` : marked.parse(content || "");
                contentDiv.innerHTML = parsedContent;

                if (role === 'assistant') {
                    const speakerIcon = document.createElement('i');
                    speakerIcon.className = 'fas fa-volume-up speaker-icon';
                    speakerIcon.title = translations[localStorage.getItem('goatify-lang') || 'es'].read_aloud_title || 'Leer en voz alta';
                    speakerIcon.onclick = (e) => {
                        e.stopPropagation();
                        speak(content, e.target);
                    };
                    contentDiv.appendChild(speakerIcon);
                }

                bubble.appendChild(contentDiv);

                if (role === 'user' && container === dom.chatMessages) {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'p-1 text-text-medium opacity-100 transition-opacity';
                    editBtn.innerHTML = '<i class="fas fa-pencil-alt fa-xs"></i>';
                    editBtn.title = translations[localStorage.getItem('goatify-lang') || 'es'].edit_message_title || 'Editar mensaje';
                    editBtn.onclick = (e) => { e.stopPropagation(); handleEditMessage(messageIndex); };
                    wrapper.insertBefore(editBtn, wrapper.firstChild);
                }

                // FIX: Check for HTML code blocks to show preview button
                if (role === 'assistant' && /```html\n([\s\S]*?)```/.test(content)) {
                    const previewButton = document.createElement('button');
                    previewButton.innerHTML = `<i class="fas fa-eye mr-2"></i>${translations[localStorage.getItem('goatify-lang') || 'es'].preview}`;
                    previewButton.className = 'btn-primary text-xs font-semibold px-3 py-1 rounded-md mt-3';
                    previewButton.addEventListener('click', () => {
                        const match = content.match(/```html\n([\s\S]*?)```/);
                        const htmlToPreview = match ? match[1] : '';
                        dom.htmlPreviewIframe.srcdoc = htmlToPreview;
                        dom.htmlPreviewModal.classList.remove('hidden');
                        dom.htmlPreviewModal.classList.add('flex');
                    });
                    bubble.appendChild(previewButton);
                }

                wrapper.appendChild(bubble);
                container.appendChild(wrapper);
                container.scrollTop = container.scrollHeight;
                return bubble;
            }

            async function handleEditMessage(index) {
                const chat = state.chats[currentChatId];
                if (!chat || !chat.messages[index]) return;
                const originalContent = chat.messages[index].content;
                const result = await showModal({
                    title: translations[localStorage.getItem('goatify-lang') || 'es'].edit_message_title || 'Editar Mensaje',
                    body: `<textarea id="edit-msg-textarea" class="w-full p-2 rounded bg-input border border-themed h-28">${originalContent}</textarea>`,
                    confirmText: translations[localStorage.getItem('goatify-lang') || 'es'].save_changes_btn || 'Guardar Cambios'
                 });
                if (result.confirmed && result.data['edit-msg-textarea'] && result.data['edit-msg-textarea'].trim() !== originalContent.trim()) {
                    chat.messages[index].content = result.data['edit-msg-textarea'].trim();
                    await saveState();
                    selectChat(currentChatId);
                }
            }

            function updateMessageInUI(bubble, content, imageSrc, container) {
                if (!bubble) return;
                const wrapper = bubble.parentElement;
                if (!wrapper) return;

                bubble.innerHTML = '';
                 if (imageSrc) {
                    const img = document.createElement('img');
                    img.src = imageSrc;
                    img.className = 'rounded-lg mb-2 max-w-full h-auto';
                    bubble.appendChild(img);
                }
                const contentDiv = document.createElement('div');
                contentDiv.className = 'markdown-content';
                const parsedContent = marked.parse(content || "");
                contentDiv.innerHTML = parsedContent;

                const speakerIcon = document.createElement('i');
                speakerIcon.className = 'fas fa-volume-up speaker-icon';
                speakerIcon.title = translations[localStorage.getItem('goatify-lang') || 'es'].read_aloud_title || 'Leer en voz alta';
                speakerIcon.onclick = (e) => { e.stopPropagation(); speak(content, e.target); };
                contentDiv.appendChild(speakerIcon);

                bubble.appendChild(contentDiv);
                
                // FIX: Check for HTML code blocks to show preview button on update as well
                if (role === 'assistant' && /```html\n([\s\S]*?)```/.test(content)) {
                    const previewButton = document.createElement('button');
                    previewButton.innerHTML = `<i class="fas fa-eye mr-2"></i>${translations[localStorage.getItem('goatify-lang') || 'es'].preview}`;
                    previewButton.className = 'btn-primary text-xs font-semibold px-3 py-1 rounded-md mt-3';
                    previewButton.addEventListener('click', () => {
                        const match = content.match(/```html\n([\s\S]*?)```/);
                        const htmlToPreview = match ? match[1] : '';
                        dom.htmlPreviewIframe.srcdoc = htmlToPreview;
                        dom.htmlPreviewModal.classList.remove('hidden');
                        dom.htmlPreviewModal.classList.add('flex');
                    });
                    bubble.appendChild(previewButton);
                }
            }

            function renderSidebar() {
                dom.sidebarContent.innerHTML = '';
                dom.foldersContainer.innerHTML = '';
                const fragChats = document.createDocumentFragment();
                const fragFolders = document.createDocumentFragment();

                const itemMap = new Map();
                Object.values(state.chats).forEach(chat => itemMap.set(chat.id, { type: 'chat', data: chat }));
                state.notes.forEach(note => itemMap.set(note.id, { type: 'note', data: note }));
                Object.values(state.projects).forEach(proj => itemMap.set(proj.id, { type: 'project', data: proj }));

                const unfiledItems = new Set(state.structure);

                Object.values(state.projects).forEach(proj => {
                    const projectEl = createProjectElement(proj.id);
                    fragFolders.appendChild(projectEl);
                    unfiledItems.delete(proj.id);
                    (proj.itemIds || []).forEach(childId => unfiledItems.delete(childId));
                });

                unfiledItems.forEach(id => {
                    const item = itemMap.get(id);
                    if (!item) return;

                    if (item.type === 'chat') fragChats.appendChild(createChatItemElement(id, false));
                    if (item.type === 'note') fragChats.appendChild(createNoteItemElement(id, false));
                });

                dom.foldersContainer.appendChild(fragFolders);
                dom.sidebarContent.appendChild(fragChats);
                updateActiveChatHighlight();
            }

            function createChatItemElement(id, isSubItem = false) {
                const chat = state.chats[id];
                if (!chat || chat.isDeletable === false) return document.createDocumentFragment();

                const item = document.createElement('a');
                item.href = `?chat=${id}`;
                item.className = `chat-item group flex items-center justify-between p-2 rounded-md cursor-pointer hover:bg-light ${isSubItem ? 'pl-8' : ''}`;
                item.dataset.id = id;
                item.dataset.type = 'chat';

                if (isSelectModeActive) {
                    item.draggable = false;
                    const isSelected = chatsToDelete.has(id);
                    item.innerHTML = `<i class="far ${isSelected ? 'fa-check-square' : 'fa-square'} mr-2 text-primary"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span>`;
                    if (isSelected) item.classList.add('selected-for-delete');
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (chatsToDelete.has(id)) {
                            chatsToDelete.delete(id);
                            item.querySelector('i').classList.replace('fa-check-square', 'fa-square');
                             item.classList.remove('selected-for-delete');
                        } else {
                            chatsToDelete.add(id);
                            item.querySelector('i').classList.replace('fa-square', 'fa-check-square');
                            item.classList.add('selected-for-delete');
                        }
                        dom.deleteSelectedBtn.disabled = chatsToDelete.size === 0;
                    });
                } else {
                    const isMobileView = window.innerWidth < 768;
                    const actionsOpacityClass = isMobileView ? 'opacity-100' : 'opacity-0 group-hover:opacity-100';

                    item.draggable = true;
                    item.innerHTML = `<i class="far fa-comment-dots mr-2"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span>
                    <div class="chat-item-actions flex-shrink-0 flex items-center ${actionsOpacityClass} transition-opacity">
                        <button class="add-to-folder-btn text-text-medium hover:text-primary p-1 relative" title="${translations[localStorage.getItem('goatify-lang') || 'es'].add_to_folder_title}"><i class="fas fa-folder-plus fa-xs"></i>
                            <div class="add-to-folder-dropdown absolute hidden top-full left-1/2 -translate-x-1/2 mt-2 p-2 rounded-md shadow-lg"></div>
                        </button>
                        <button class="rename-btn text-text-medium hover:text-primary p-1" title="${translations[localStorage.getItem('goatify-lang') || 'es'].rename_title}"><i class="fas fa-pencil-alt fa-xs"></i></button>
                        <button class="delete-btn text-text-medium hover:text-red-500 p-1" title="${translations[localStorage.getItem('goatify-lang') || 'es'].delete_title}"><i class="fas fa-trash-alt fa-xs"></i></button>
                    </div>`;

                    item.addEventListener('click', e => {
                        if (!e.ctrlKey && !e.metaKey && e.button === 0) {
                            if (!e.target.closest('.chat-item-actions')) {
                                e.preventDefault();
                                selectChat(id);
                                history.pushState({chatId: id}, '', item.href);
                            }
                        }
                    });

                    item.addEventListener('dragstart', e => handleDragStart(e, id));

                    const addToFolderBtn = item.querySelector('.add-to-folder-btn');
                    const renameBtn = item.querySelector('.rename-btn');
                    const deleteBtn = item.querySelector('.delete-btn');

                    if (addToFolderBtn) {
                        addToFolderBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const dropdown = addToFolderBtn.querySelector('.add-to-folder-dropdown');
                            document.querySelectorAll('.add-to-folder-dropdown').forEach(d => {
                                if(d !== dropdown) d.classList.add('hidden');
                            });
                            dropdown.classList.toggle('hidden');
                            renderFolderDropdown(id, dropdown);
                        });
                    }

                    renameBtn.addEventListener('click', (e) => { e.stopPropagation(); e.preventDefault(); renameItem('chat', id); });
                    deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); e.preventDefault(); deleteItem('chat', id); });
                }
                return item;
            }

            function createNoteItemElement(id, isSubItem = false) {
                const note = state.notes.find(n => n.id === id);
                if (!note) return document.createDocumentFragment();

                const item = document.createElement('a');
                item.href = `?chat=${id}`;
                item.className = 'note-item group flex items-center justify-between p-2 rounded-md cursor-pointer';
                if (isSubItem) item.classList.add('pl-8');
                item.dataset.id = note.id;
                item.dataset.type = 'note';

                const isMobileView = window.innerWidth < 768;
                const actionsOpacityClass = isMobileView ? 'opacity-100' : 'opacity-0 group-hover:opacity-100';

                if (isSelectModeActive) {
                    item.draggable = false;
                    const isSelected = chatsToDelete.has(id);
                    item.innerHTML = `<i class="far ${isSelected ? 'fa-check-square' : 'fa-square'} mr-2 text-primary"></i><span class="flex-grow truncate text-sm font-medium">${note.title}</span>`;
                    if (isSelected) item.classList.add('selected-for-delete');
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (chatsToDelete.has(id)) {
                            chatsToDelete.delete(id);
                            item.querySelector('i').classList.replace('fa-check-square', 'fa-square');
                             item.classList.remove('selected-for-delete');
                        } else {
                            chatsToDelete.add(id);
                            item.querySelector('i').classList.replace('fa-square', 'fa-check-square');
                            item.classList.add('selected-for-delete');
                        }
                        dom.deleteSelectedBtn.disabled = chatsToDelete.size === 0;
                    });
                } else {
                    item.draggable = true;
                    item.innerHTML = `
                        <i class="fas ${note.type === 'drawing' ? 'fa-paint-brush' : 'fa-file-alt'} mr-2"></i>
                        <span class="flex-grow truncate text-sm font-medium">${note.title}</span>
                        <div class="chat-item-actions flex-shrink-0 ${actionsOpacityClass} transition-opacity">
                            <button class="add-to-folder-btn text-text-medium hover:text-primary p-1 relative" title="${translations[localStorage.getItem('goatify-lang') || 'es'].add_to_folder_title}"><i class="fas fa-folder-plus fa-xs"></i>
                                <div class="add-to-folder-dropdown absolute hidden top-full left-1/2 -translate-x-1/2 mt-2 p-2 rounded-md shadow-lg"></div>
                            </button>
                            <button class="rename-btn text-text-medium hover:text-primary p-1" title="${translations[localStorage.getItem('goatify-lang') || 'es'].rename_title}"><i class="fas fa-pencil-alt fa-xs"></i></button>
                            <button class="delete-btn text-text-medium hover:text-red-500 p-1" title="${translations[localStorage.getItem('goatify-lang') || 'es'].delete_title}"><i class="fas fa-trash-alt fa-xs"></i></button>
                        </div>
                    `;
                    item.addEventListener('click', e => {
                        if (!e.ctrlKey && !e.metaKey && e.button === 0) {
                             if (!e.target.closest('.chat-item-actions')) {
                                e.preventDefault();
                                selectChat(id);
                                history.pushState({chatId: id}, '', item.href);
                                if (window.innerWidth < 768) {
                                    dom.notepadViewContainer.classList.add('mobile-editor-active');
                                }
                            }
                        }
                    });

                    item.addEventListener('dragstart', e => handleDragStart(e, id));

                    const addToFolderBtn = item.querySelector('.add-to-folder-btn');
                    const renameBtn = item.querySelector('.rename-btn');
                    const deleteBtn = item.querySelector('.delete-btn');

                    if (addToFolderBtn) {
                        addToFolderBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const dropdown = addToFolderBtn.querySelector('.add-to-folder-dropdown');
                            document.querySelectorAll('.add-to-folder-dropdown').forEach(d => {
                                if(d !== dropdown) d.classList.add('hidden');
                            });
                            dropdown.classList.toggle('hidden');
                            renderFolderDropdown(id, dropdown);
                        });
                    }
                    renameBtn.addEventListener('click', (e) => { e.stopPropagation(); e.preventDefault(); renameItem('note', id); });
                    deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); e.preventDefault(); deleteItem('note', id); });
                }
                return item;
            }

            function renderFolderDropdown(itemId, dropdownElement) {
                dropdownElement.innerHTML = '';
                const folders = Object.values(state.projects);
                const currentFolderId = Object.values(state.projects).find(p => p.itemIds && p.itemIds.includes(itemId))?.id;

                if (folders.length === 0) {
                    dropdownElement.innerHTML = `<button class="p-2 text-xs text-text-medium italic" disabled>${translations[localStorage.getItem('goatify-lang') || 'es'].no_folders_yet}</button>`;
                    return;
                }

                folders.forEach(folder => {
                    const button = document.createElement('button');
                    button.textContent = folder.title;
                    button.dataset.folderId = folder.id;
                    if (folder.id === currentFolderId) {
                        button.disabled = true;
                        button.classList.add('bg-current-primary', 'text-white');
                    }
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // FIX: Call the updated move function that doesn't cause a refresh
                        moveItemToProject(itemId, folder.id);
                        dropdownElement.classList.add('hidden');
                        
                        // Manually move the item in the DOM for a smooth experience
                        const itemElement = document.querySelector(`[data-id="${itemId}"]`);
                        const targetFolderContent = document.querySelector(`.project[data-id="${folder.id}"] .project-content`);
                        if(itemElement && targetFolderContent) {
                            itemElement.classList.add('pl-8'); // Add indentation
                            targetFolderContent.prepend(itemElement);
                        }
                    });
                    dropdownElement.appendChild(button);
                });
            }

            function createProjectElement(id) {
                const project = state.projects[id];
                if (!project) return document.createDocumentFragment();
                const div = document.createElement('div');
                div.className = 'project folders-category';
                div.dataset.id = id;
                const header = document.createElement('div');
                header.className = 'project-header folders-header group flex items-center p-2 rounded-md cursor-pointer hover:bg-light';
                header.draggable = true;

                const isMobileView = window.innerWidth < 768;
                const actionsOpacityClass = isMobileView ? 'opacity-100' : 'opacity-0 group-hover:opacity-100';

                header.innerHTML = `<i class="fas fa-chevron-right project-arrow folder-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-folder mr-2 text-yellow-500"></i><span class="flex-grow truncate text-sm font-bold">${project.title}</span><div class="chat-item-actions flex-shrink-0 ${actionsOpacityClass} transition-opacity"><button class="rename-btn text-text-medium hover:text-primary p-1" title="${translations[localStorage.getItem('goatify-lang') || 'es'].rename_title}"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-text-medium hover:text-red-500 p-1" title="${translations[localStorage.getItem('goatify-lang') || 'es'].delete_title}"><i class="fas fa-trash-alt fa-xs"></i></button></div>`;
                const content = document.createElement('div');
                content.className = 'project-content folders-content pt-1 space-y-1';
                (project.itemIds || []).forEach(itemId => {
                    if (itemId.startsWith('chat-') && itemId !== 'notepad-assistant-chat') content.appendChild(createChatItemElement(itemId, true));
                    if (itemId.startsWith('note-')) content.appendChild(createNoteItemElement(itemId, true));
                });
                div.append(header, content);

                // FIX: REMOVED the direct click listener here to rely on the delegated listener on the body, fixing the folder deployment issue.

                header.addEventListener('dragstart', e => handleDragStart(e, id));
                header.addEventListener('dragover', e => handleDragOver(e, header));
                header.addEventListener('dragleave', e => handleDragLeave(e, header));
                header.addEventListener('drop', e => handleDrop(e, id));

                header.querySelector('.rename-btn').addEventListener('click', (e) => { e.stopPropagation(); renameItem('project', id);});
                header.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteItem('project', id);});

                if (project.isOpen) {
                    div.classList.add('open');
                }
                return div;
            }
            let draggedItemId = null;
            let currentDragSelection = null;
            function handleDragStart(e, id) {
                draggedItemId = id;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', id);
                if (isSelectModeActive && chatsToDelete.has(id)) {
                    e.dataTransfer.setData('application/json', JSON.stringify(Array.from(chatsToDelete)));
                    currentDragSelection = new Set(chatsToDelete);
                } else {
                    currentDragSelection = new Set([id]);
                }
            }
            function handleDragOver(e, el) { e.preventDefault(); el.classList.add('drag-over'); }
            function handleDragLeave(e, el) { el.classList.remove('drag-over'); }

            function handleDrop(e, targetProjectId) {
                e.preventDefault();
                e.stopPropagation();
                const targetElement = e.currentTarget;
                if (targetElement) targetElement.classList.remove('drag-over');
                
                const droppedItemId = e.dataTransfer.getData('text/plain');
                if (!droppedItemId || droppedItemId === targetProjectId) return;

                // FIX: Use the improved moveItemToProject that doesn't refresh the UI
                moveItemToProject(droppedItemId, targetProjectId);
                
                // Manually move the DOM element for a smooth visual update
                const draggedElement = document.querySelector(`[data-id="${droppedItemId}"]`);
                const targetFolderContent = document.querySelector(`.project[data-id="${targetProjectId}"] .project-content`);

                if (draggedElement && targetFolderContent) {
                    draggedElement.classList.add('pl-8'); // Add indentation
                    targetFolderContent.prepend(draggedElement);
                }
            }
            
            // FIX: This function no longer calls renderSidebar() to prevent the page refresh on item move.
            function moveItemToProject(itemId, targetProjectId = null) {
                // Remove item from its old location in the state
                state.structure = state.structure.filter(id => id !== itemId);
                Object.values(state.projects).forEach(p => { if(p.itemIds) p.itemIds = p.itemIds.filter(id => id !== itemId) });

                // Add item to its new location in the state
                if(targetProjectId && state.projects[targetProjectId]){
                    if(!state.projects[targetProjectId].itemIds) state.projects[targetProjectId].itemIds = [];
                    state.projects[targetProjectId].itemIds.unshift(itemId);
                } else {
                    // If not dropping in a folder, add back to the root
                    state.structure.unshift(itemId);
                }
                saveState(); // Save the new state
            }

            async function renameItem(type, id) {
                let item;
                if(type === 'chat') item = state.chats[id];
                else if(type === 'project') item = state.projects[id];
                else if(type === 'note') item = state.notes.find(n => n.id === id);
                if(!item) return;

                const result = await showModal({
                    title: `${translations[localStorage.getItem('goatify-lang') || 'es'].rename_title_prefix || "Renombrar"} ${type === 'chat' ? (translations[localStorage.getItem('goatify-lang') || 'es'].conversation_text || 'Conversaci√≥n') : (type === 'project' ? (translations[localStorage.getItem('goatify-lang') || 'es'].project_text || 'Proyecto') : (translations[localStorage.getItem('goatify-lang') || 'es'].note_text || 'Nota'))}`,
                    body: `<input type="text" id="rename-input" class="w-full p-2 rounded bg-input border border-themed" value="${item.title}">`,
                    confirmText: translations[localStorage.getItem('goatify-lang') || 'es'].rename_btn || 'Renombrar'
                 });
                if (result.confirmed && result.data['rename-input'] && result.data['rename-input'].trim()) {
                    item.title = result.data['rename-input'].trim();
                    if (type === 'chat' && currentChatId === id) {
                        dom.chatTitle.textContent = item.title;
                        if (dom.mobileChatTitle) dom.mobileChatTitle.textContent = item.title;
                        if(state.chats[id].workflow === 'project-management') {
                            state.chats[id].projectData.title = item.title;
                            dom.projectViewTitle.textContent = item.title;
                        }
                    } else if (type === 'note' && currentNoteId === id) {
                        dom.noteTitleInput.value = item.title;
                    }
                    saveState();
                    renderSidebar();
                }
            }
            async function deleteItem(type, id) {
                let item, childrenIds = [];
                if(type === 'chat') item = state.chats[id];
                else if(type === 'project') {
                    item = state.projects[id];
                    childrenIds = item.itemIds || [];
                }
                else if(type === 'note') item = state.notes.find(n => n.id === id);
                if(!item) return;

                let body = translations[localStorage.getItem('goatify-lang') || 'es'].undo_action_warning || 'Esta acci√≥n no se puede deshacer.';
                if(type === 'project' && childrenIds.length > 0) {
                    body += ` ${translations[localStorage.getItem('goatify-lang') || 'es'].also_delete_items_warning || "Tambi√©n se eliminar√°n los"} ${childrenIds.length} ${translations[localStorage.getItem('goatify-lang') || 'es'].items_contained_warning || "elementos que contiene."}`
                }

                const confResult = await showModal({
                    title: `${translations[localStorage.getItem('goatify-lang') || 'es'].delete_confirm_prefix || "Eliminar"} ${item.title}?`,
                    body: body,
                    confirmText: translations[localStorage.getItem('goatify-lang') || 'es'].delete || 'Eliminar',
                    dangerConfirm: true
                });

                if (confResult.confirmed) {
                    const idsToDelete = [id, ...childrenIds];
                    idsToDelete.forEach(deleteId => {
                        state.structure = state.structure.filter(i => i !== deleteId);
                        if (deleteId.startsWith('chat-')) delete state.chats[deleteId];
                        if (deleteId.startsWith('note-')) state.notes = state.notes.filter(n => n.id !== deleteId);
                        if (deleteId.startsWith('project-')) delete state.projects[deleteId];

                        Object.values(state.projects).forEach(p => {
                            if(p.itemIds) p.itemIds = p.itemIds.filter(cid => cid !== deleteId)
                        });

                        if (currentChatId === deleteId) resetChatView();
                        if (currentNoteId === deleteId) {
                            currentNoteId = null;
                            dom.noteEditorPanel.classList.add('hidden');
                        }
                    });

                    saveState();
                    renderSidebar();
                }
            }

            function updateActiveChatHighlight() {
                document.querySelectorAll('.chat-item, .note-item').forEach(item => {
                    item.classList.toggle('selected-chat', item.dataset.id === currentChatId || item.dataset.id === currentNoteId);
                });
            }

            function clearImageData() {
                dom.imageUploadInput.value = '';
                dom.imagePreviewContainer.classList.add('hidden');
                dom.filePreviewArea.style.display = "none";
                selectedImageBase64 = null;
            }
            function clearPdfData() {
                dom.pdfUploadInput.value = '';
                dom.pdfPreviewContainer.classList.add('hidden');
                dom.filePreviewArea.style.display = "none";
                selectedPdfText = null;
            }
            function hasFile() { return selectedImageBase64 || selectedPdfText; }
            async function sendMessage(forceSend = false, spokenMessage = null, { assistantType = 'main' } = {}) {
                let inputEl, messageContainer, financialData = null, noteContent = null;
                let chatIdToUpdate = currentChatId;
                let modelToUse;

                switch(assistantType) {
                    case 'project':
                        inputEl = dom.projectMsgInput;
                        messageContainer = dom.projectChatMessages;
                        modelToUse = getModelForRequest(state.chats[chatIdToUpdate]?.workflow, false, 'project');
                        break;
                    case 'financial':
                        inputEl = document.getElementById('financial-msg');
                        messageContainer = document.getElementById('financial-chat-messages');
                        financialData = state.chats[currentChatId].financialData;
                        modelToUse = getModelForRequest(state.chats[chatIdToUpdate]?.workflow, false, 'financial');
                        break;
                    case 'notepad':
                        inputEl = dom.notepadMsgInput;
                        messageContainer = dom.notepadChatMessages;
                        chatIdToUpdate = 'notepad-assistant-chat';
                        noteContent = dom.noteContentEditor.innerHTML;
                        modelToUse = getModelForRequest(state.chats[chatIdToUpdate]?.workflow, false, 'notepad');
                        break;
                    default:
                        inputEl = dom.msgInput;
                        messageContainer = dom.chatMessages;
                        if (!chatIdToUpdate) chatIdToUpdate = createNewChat({});
                        modelToUse = getModelForRequest(state.chats[chatIdToUpdate]?.workflow, hasFile(), 'main');
                }

                const userMessage = spokenMessage || inputEl.value.trim();
                if (!userMessage && !selectedImageBase64 && !selectedPdfText) return;

                const currentChat = state.chats[chatIdToUpdate];
                if (!currentChat) return;

                const webSearchTriggers = ['busca', 'investiga', 'en internet', 'tiempo real', 'qu√© d√≠a es hoy', 'qu√© fecha es hoy', 'cu√°l es el precio de', 'qui√©n es', 'qu√© es', 'noticias sobre'];
                const requiresWebSearch = webSearchTriggers.some(trigger => userMessage.toLowerCase().startsWith(trigger));
                if (requiresWebSearch && !hasFile() && !currentChat.workflow) { modelToUse = 'sonar'; }

                let cost = COSTS.GENERAL;
                if(modelToUse === 'sonar') cost = COSTS.SEARCH;
                if(currentChat.workflow) cost = COSTS.WORKFLOW;
                if(selectedPdfText) cost = COSTS.PDF_ANALYSIS;
                if(selectedImageBase64) cost = COSTS.IMAGE_ANALYSIS;
                if(modelToUse === 'gpt-4o') cost = COSTS.GPT4O;

                if (!spendCredits(cost, modelToUse)) return;

                if(currentChat.title === (translations[localStorage.getItem('goatify-lang') || 'es'].default_chat_title || 'Conversaci√≥n C√≥smica') && userMessage.length > 5 && assistantType === 'main') {
                    currentChat.title = userMessage.split(' ').slice(0, 4).join(' ');
                    renderSidebar();
                }

                const [image, pdf] = [selectedImageBase64, selectedPdfText];
                currentChat.messages.push({ role: 'user', content: userMessage, image, pdfText: pdf });
                addMessageToUI('user', userMessage, image, currentChat.messages.length - 1, messageContainer);
                const thinkingBubble = addMessageToUI('assistant', '‚Ä¶', null, null, messageContainer);
                inputEl.value = '';
                inputEl.style.height = 'auto';
                if(assistantType === 'main') {
                    clearImageData();
                    clearPdfData();
                }

                try {
                    const userNameForCall = currentUser ? (currentUser.user_metadata.full_name || currentUser.email) : 'viajero';
                    const responseData = await getAIResponse(userMessage, currentChat.messages.slice(0, -1), image, pdf, modelToUse, currentChat.workflow, userNameForCall, financialData, noteContent);

                    updateCreditCounter();
                    currentChat.messages.push({ role: 'assistant', content: responseData.reply });
                    updateMessageInUI(thinkingBubble, responseData.reply, null, messageContainer);
                    speak(responseData.reply);

                    if (currentChat.workflow && currentChat.workflow !== 'notepad-assistant') {
                        completeMission(currentChat.workflow, chatIdToUpdate);
                    }

                    if (assistantType === 'project' && responseData.projectUpdate && responseData.projectUpdate.tasks) {
                        const todoColumn = currentChat.projectData.columns.find(c => c.id === 'todo');
                        if (todoColumn) {
                            if (!todoColumn.tasks) todoColumn.tasks = [];
                             responseData.projectUpdate.tasks.forEach(task => {
                                 todoColumn.tasks.push({ id: `proj-${crypto.randomUUID()}`, content: task.content, completed: false, labels: task.labels || [], urgent: false });
                            });
                        }
                        renderProjectBoard(chatIdToUpdate);
                    }

                    saveState();
                } catch (error) {
                    updateMessageInUI(thinkingBubble, `‚ùå **Error de Conexi√≥n**<br><small>${error.message || 'No se pudo conectar al servidor.'}</small>`, null, messageContainer);
                }
            }
            async function generateImage() {
                const result = await showModal({ title: translations[localStorage.getItem('goatify-lang') || 'es'].create_image_title || 'Crear Imagen', body: `${translations[localStorage.getItem('goatify-lang') || 'es'].image_prompt_desc || 'Describe la imagen que quieres crear:'}<br><input type="text" id="img-prompt" class="w-full p-2 rounded bg-input border border-themed mt-2" placeholder="${translations[localStorage.getItem('goatify-lang') || 'es'].image_prompt_placeholder || 'Ej: Un astronauta en un caballo c√≥smico'}">`, confirmText: translations[localStorage.getItem('goatify-lang') || 'es'].generate_btn || 'Generar' });
                if (!result.confirmed || !result.data['img-prompt']) return;

                if (!spendCredits(COSTS.IMAGE_GENERATION, 'dall-e-2')) return;

                let chatIdToUpdate = currentChatId || createNewChat({});
                const currentChat = state.chats[chatIdToUpdate];
                currentChat.messages.push({ role: 'user', content: `${translations[localStorage.getItem('goatify-lang') || 'es'].generate_image_message || 'Generar imagen:'} "${result.data['img-prompt']}"` });
                addMessageToUI('user', `${translations[localStorage.getItem('goatify-lang') || 'es'].generate_image_message || 'Generar imagen:'} "${result.data['img-prompt']}"`, null, currentChat.messages.length - 1, dom.chatMessages);
                const thinkingBubble = addMessageToUI('assistant', '‚Ä¶', null, null, dom.chatMessages);
                try {
                    const response = await fetch('/.netlify/functions/generate-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ prompt: result.data['img-prompt'], model: 'dall-e-2' })
                    });
                    if (!response.ok) { throw new Error((await response.json()).error || 'Error del servidor'); }
                    const { imageData } = await response.json();
                    const imageContent = translations[localStorage.getItem('goatify-lang') || 'es'].image_creation_success || '¬°Aqu√≠ est√° tu creaci√≥n, Jefe/a!';
                    currentChat.messages.push({ role: 'assistant', content: imageContent, image: imageData });
                    updateMessageInUI(thinkingBubble, imageContent, imageData, dom.chatMessages);
                    completeMission('image-generated');
                    saveState();
                } catch (error) {
                    updateMessageInUI(thinkingBubble, `${translations[localStorage.getItem('goatify-lang') || 'es'].image_creation_error || '‚ùå **Error al crear la imagen:**'}<br><small>${error.message}</small>`, null, dom.chatMessages);
                }
            }
            function toggleSelectMode(active) {
                isSelectModeActive = active;
                dom.selectChatsBtn.classList.toggle('hidden', active);
                dom.deleteModeControls.classList.toggle('hidden', !active);
                if (!active) {
                    chatsToDelete.clear();
                    dom.deleteSelectedBtn.disabled = true;
                }
                renderSidebar();

                if (active) {
                    document.addEventListener('mousedown', handleMouseDownForSelection);
                } else {
                    document.removeEventListener('mousedown', handleMouseDownForSelection);
                    clearSelectionVisuals();
                }
            }
            function handleMouseDownForSelection(e) {
                if (e.button !== 0 || !e.target.closest('#sidebar-scrollable-content')) return;

                isDraggingForSelection = true;
                initialSelectionX = e.clientX;
                initialSelectionY = e.clientY;

                selectionRect = document.createElement('div');
                selectionRect.style.position = 'fixed';
                selectionRect.style.border = '1px solid var(--primary)';
                selectionRect.style.backgroundColor = 'rgba(138, 79, 255, 0.1)';
                selectionRect.style.zIndex = '99';
                document.body.appendChild(selectionRect);

                document.addEventListener('mousemove', handleMouseMoveForSelection);
                document.addEventListener('mouseup', handleMouseUpForSelection);
            }

            function handleMouseMoveForSelection(e) {
                if (!isDraggingForSelection || !selectionRect) return;

                const currentX = e.clientX;
                const currentY = e.clientY;

                const minX = Math.min(initialSelectionX, currentX);
                const maxX = Math.max(initialSelectionX, currentX);
                const minY = Math.min(initialSelectionY, currentY);
                const maxY = Math.max(initialSelectionY, currentY);

                selectionRect.style.left = `${minX}px`;
                selectionRect.style.top = `${minY}px`;
                selectionRect.style.width = `${maxX - minX}px`;
                selectionRect.style.height = `${maxY - minY}px`;

                const allItems = document.querySelectorAll('.chat-item:not(.selected-for-delete), .note-item:not(.selected-for-delete)');
                const selectionBounds = selectionRect.getBoundingClientRect();

                allItems.forEach(item => {
                    const itemBounds = item.getBoundingClientRect();
                    const isOverlapping = !(
                        selectionBounds.right < itemBounds.left ||
                        selectionBounds.left > itemBounds.right ||
                        selectionBounds.bottom < itemBounds.top ||
                        selectionBounds.top > itemBounds.bottom
                    );

                    if (isOverlapping) {
                        if (!chatsToDelete.has(item.dataset.id)) {
                            chatsToDelete.add(item.dataset.id);
                            item.querySelector('i').classList.replace('fa-square', 'fa-check-square');
                            item.classList.add('selected-for-delete');
                        }
                    } else {
                        if (chatsToDelete.has(item.dataset.id) && item.classList.contains('selected-for-delete')) {
                             chatsToDelete.delete(item.dataset.id);
                             item.querySelector('i').classList.replace('fa-check-square', 'fa-square');
                             item.classList.remove('selected-for-delete');
                        }
                    }
                });
                dom.deleteSelectedBtn.disabled = chatsToDelete.size === 0;
            }

            function handleMouseUpForSelection() {
                isDraggingForSelection = false;
                if (selectionRect) {
                    selectionRect.remove();
                    selectionRect = null;
                }
                document.removeEventListener('mousemove', handleMouseMoveForSelection);
                document.removeEventListener('mouseup', handleMouseUpForSelection);
                dom.deleteSelectedBtn.disabled = chatsToDelete.size === 0;
            }

            function clearSelectionVisuals() {
                document.querySelectorAll('.chat-item.selected-for-delete, .note-item.selected-for-delete').forEach(item => {
                    item.classList.remove('selected-for-delete');
                    const checkboxIcon = item.querySelector('i.fa-check-square');
                    if (checkboxIcon) checkboxIcon.classList.replace('fa-check-square', 'fa-square');
                });
            }

            // --- NOTEPAD FUNCTIONS START ---

            let drawingHistory = [];
            let historyIndex = -1;

            function saveDrawingState() {
                const canvas = dom.noteCanvas;
                if (!canvas) return;

                const imageData = canvas.toDataURL();
                if (historyIndex < drawingHistory.length - 1) {
                    drawingHistory = drawingHistory.slice(0, historyIndex + 1);
                }
                drawingHistory.push(imageData);
                historyIndex++;

                const activeNote = state.notes.find(n => n.id === currentNoteId);
                if (activeNote) {
                    activeNote.content = imageData;
                    saveState();
                }
            }

            function undoDrawing() {
                if (historyIndex > 0) {
                    historyIndex--;
                    const canvas = dom.noteCanvas;
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.onload = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    };
                    img.src = drawingHistory[historyIndex];
                    const activeNote = state.notes.find(n => n.id === currentNoteId);
                    if (activeNote) {
                        activeNote.content = drawingHistory[historyIndex];
                        saveState();
                    }
                }
            }

            function redoDrawing() {
                if (historyIndex < drawingHistory.length - 1) {
                    historyIndex++;
                    const canvas = dom.noteCanvas;
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.onload = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    };
                    img.src = drawingHistory[historyIndex];
                    const activeNote = state.notes.find(n => n.id === currentNoteId);
                    if (activeNote) {
                        activeNote.content = drawingHistory[historyIndex];
                        saveState();
                    }
                }
            }


            function showNotepadView() {
                dom.notepadViewContainer.style.display = 'flex';
                dom.notepadChatContainer.classList.toggle('hidden', window.innerWidth < 768);
                updateContextualFooter('notepad-app');

                const notepadChat = state.chats['notepad-assistant-chat'];
                dom.notepadChatMessages.innerHTML = '';
                if(notepadChat && notepadChat.messages){
                    notepadChat.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, msg.image, index, dom.notepadChatMessages));
                }


                if (state.notes.length === 0) {
                     dom.noteEditorPanel.classList.add('hidden');
                } else if (!currentNoteId || !state.notes.find(n => n.id === currentNoteId)) {
                    selectNote(state.notes[0].id);
                } else {
                    selectNote(currentNoteId);
                }

                const notepadModelSelector = document.getElementById('notepad-model-selector');
                if (notepadModelSelector) {
                    const goatXProOption = notepadModelSelector.querySelector('.goat-x-pro-model');
                    if (goatXProOption) goatXProOption.disabled = !currentUser;
                }
            }

            function selectNote(noteId) {
                const noteExists = state.notes.find(n => n.id === noteId);
                if (!noteExists) {
                    currentNoteId = null;
                    dom.noteEditorPanel.classList.add('hidden');
                    return;
                }
                dom.noteEditorPanel.classList.remove('hidden');
                currentNoteId = noteId;
                loadNoteIntoEditor(noteId);
                updateActiveChatHighlight();
            }

            function createNewNote(type = 'text') {
                const newNote = {
                    id: 'note-' + crypto.randomUUID(),
                    title: type === 'text' ? (translations[localStorage.getItem('goatify-lang') || 'es'].new_note || "Nueva Nota") : (translations[localStorage.getItem('goatify-lang') || 'es'].new_drawing_title || "Nuevo Dibujo"),
                    content: type === 'text' ? '' : null,
                    type: type,
                    createdAt: new Date().toISOString()
                };
                state.notes.unshift(newNote);
                state.structure.unshift(newNote.id);
                selectChat(newNote.id);

                if (window.innerWidth < 768) {
                    dom.notepadViewContainer.classList.add('mobile-editor-active');
                }
                showInAppNotification(translations[localStorage.getItem('goatify-lang') || 'es'].success_title || "√âxito", `${translations[localStorage.getItem('goatify-lang') || 'es'].note_created_message || "Se ha creado:"} "${newNote.title}"`, 800);
            }

            function loadNoteIntoEditor(noteId) {
                const note = state.notes.find(n => n.id === noteId);
                if (!note) return;

                currentNoteId = noteId;

                dom.noteTitleInput.value = note.title;
                const isDrawing = note.type === 'drawing';

                dom.noteContentEditor.style.display = isDrawing ? 'none' : 'block';
                dom.noteCanvas.style.display = isDrawing ? 'block' : 'none';
                dom.noteContentEditor.innerHTML = isDrawing ? '' : note.content;

                dom.textTools.style.display = isDrawing ? 'none' : 'flex';
                dom.drawingTools.style.display = isDrawing ? 'flex' : 'none';

                if (isDrawing) {
                    setupCanvas(note);
                } else {
                    dom.noteEditorToolbar.querySelectorAll('.text-editor-controls button').forEach(btn => btn.classList.remove('active'));
                }
            }

            function setupCanvas(note) {
                const canvas = dom.noteCanvas;
                const ctx = canvas.getContext('2d');
                const toolbar = dom.drawingTools;

                let isDrawing = false;
                let lastX = 0;
                let lastY = 0;
                let startX = 0;
                let startY = 0;
                let currentTool = 'pencil';
                let currentSnapshot = null;

                drawingHistory = [];
                historyIndex = -1;

                const resizeCanvas = () => {
                    const rect = canvas.parentElement.getBoundingClientRect();
                    canvas.width = rect.width;
                    canvas.height = rect.height;
                    if (note.content) {
                        const img = new Image();
                        img.onload = () => {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            saveDrawingState();
                        }
                        img.src = note.content;
                    } else {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        saveDrawingState();
                    }
                };

                resizeCanvas();
                window.removeEventListener('resize', resizeCanvas);
                window.addEventListener('resize', resizeCanvas);

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (note.content) {
                    const img = new Image();
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        saveDrawingState();
                    }
                    img.src = note.content;
                } else {
                    saveDrawingState();
                }


                const getCoords = (e) => {
                    const event = e.touches ? e.touches[0] : e;
                    const canvasRect = canvas.getBoundingClientRect();
                    return [event.clientX - canvasRect.left, event.clientY - canvasRect.top];
                }

                const startDrawing = (e) => {
                    e.preventDefault();
                    isDrawing = true;
                    [lastX, lastY] = getCoords(e);
                    [startX, startY] = [lastX, lastY];
                    if (currentTool === 'pencil' || currentTool === 'eraser') {
                         ctx.beginPath();
                         ctx.moveTo(lastX, lastY);
                    } else {
                        currentSnapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    }
                };
                const draw = (e) => {
                    if (!isDrawing) return;
                    e.preventDefault();

                    const [currentX, currentY] = getCoords(e);
                    ctx.strokeStyle = toolbar.querySelector('#drawing-color').value;
                    ctx.lineWidth = toolbar.querySelector('#drawing-line-width').value;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';

                    if (currentTool === 'pencil' || currentTool === 'eraser') {
                        ctx.lineTo(currentX, currentY);
                        ctx.stroke();
                    } else if (currentSnapshot) {
                        ctx.putImageData(currentSnapshot, 0, 0);
                        ctx.beginPath();
                        if (currentTool === 'line') {
                            ctx.moveTo(startX, startY);
                            ctx.lineTo(currentX, currentY);
                        } else if (currentTool === 'rect') {
                            ctx.rect(startX, startY, currentX - startX, currentY - startY);
                        } else if (currentTool === 'circle') {
                            const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
                            ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
                        }
                        ctx.stroke();
                    }
                    [lastX, lastY] = [currentX, currentY];
                };
                const stopDrawing = () => {
                    if (!isDrawing) return;
                    isDrawing = false;
                    if (currentTool === 'pencil' || currentTool === 'eraser') {
                        ctx.closePath();
                    }
                    saveDrawingState();
                    currentSnapshot = null;
                };

                canvas.onmousedown = startDrawing;
                canvas.onmousemove = draw;
                canvas.onmouseup = stopDrawing;
                canvas.onmouseout = stopDrawing;
                canvas.ontouchstart = startDrawing;
                canvas.ontouchmove = draw;
                canvas.ontouchend = stopDrawing;

                const setActiveTool = (toolId) => {
                    toolbar.querySelectorAll('.drawing-tool').forEach(t => t.classList.remove('active'));
                    toolbar.querySelector(`#${toolId}`).classList.add('active');
                    currentTool = toolId.replace('tool-', '');
                }

                toolbar.querySelector('#tool-pencil').onclick = () => setActiveTool('tool-pencil');
                toolbar.querySelector('#tool-eraser').onclick = () => setActiveTool('tool-eraser');
                toolbar.querySelector('#tool-line').onclick = () => setActiveTool('tool-line');
                toolbar.querySelector('#tool-rect').onclick = () => setActiveTool('tool-rect');
                toolbar.querySelector('#tool-circle').onclick = () => setActiveTool('tool-circle');
                toolbar.querySelector('#clear-canvas-btn').onclick = () => {
                     ctx.clearRect(0, 0, canvas.width, canvas.height);
                     const activeNote = state.notes.find(n => n.id === currentNoteId);
                     if (activeNote) {
                         activeNote.content = null;
                         saveState();
                     }
                     drawingHistory = [];
                     historyIndex = -1;
                     saveDrawingState();
                };
                toolbar.querySelector('#undo-drawing-btn').onclick = undoDrawing;
                toolbar.querySelector('#redo-drawing-btn').onclick = redoDrawing;
            }

            function applyTextFormat(command, value = null) {
                document.execCommand(command, false, value);
                dom.noteContentEditor.focus();
                updateToolbarButtonStates();
                const note = state.notes.find(n => n.id === currentNoteId);
                if (note && note.type === 'text') {
                    note.content = dom.noteContentEditor.innerHTML;
                    saveState();
                }
            }

            function updateToolbarButtonStates() {
                dom.boldBtn.classList.toggle('active', document.queryCommandState('bold'));
                dom.italicBtn.classList.toggle('active', document.queryCommandState('italic'));
                dom.underlineBtn.classList.toggle('active', document.queryCommandState('underline'));
            }

            function handleChecklistItem(target) {
                if(!target.matches('.checklist-item-checkbox')) return;
                const isChecked = target.checked;
                const textSpan = target.nextElementSibling;
                if (textSpan && textSpan.matches('.checklist-item-text')) {
                    textSpan.dataset.checked = isChecked;
                }
                const currentNote = state.notes.find(n => n.id === currentNoteId);
                if(currentNote) {
                    currentNote.content = dom.noteContentEditor.innerHTML;
                    saveState();
                }
            }

            async function shareNote() {
                const lang = localStorage.getItem('goatify-lang') || 'es';
                const result = await showModal({
                    title: translations[lang].share_note,
                    body: `<p>${translations[lang].share_note_desc}</p>
                           <input type="email" id="share-email-input" class="w-full p-2 rounded bg-input border border-themed mt-2" placeholder="${translations[lang].share_note_email_placeholder}">
                           <p class="text-xs text-text-medium mt-2">${translations[lang].share_note_info}</p>`,
                    confirmText: translations[lang].share_note_button
                });

                if (result.confirmed && result.data['share-email-input']) {
                    console.log(`(DEMO) Sharing note ${currentNoteId} with ${result.data['share-email-input']}. Backend implementation needed.`);
                    showInAppNotification(translations[lang].feature_in_dev_title || "Funci√≥n en Desarrollo", translations[lang].feature_in_dev_message || "La colaboraci√≥n en tiempo real estar√° disponible pronto.", 800);
                }
            }

            // --- NOTEPAD FUNCTIONS END ---


            function setupModalClickOutside(modalElement, hideFunction) {
                if (!modalElement) return;
                modalElement.addEventListener('click', (e) => {
                    if (e.target === modalElement) {
                        hideFunction();
                    }
                });
            }

            function showMotivationModal() {
                dom.motivationModal.classList.remove('hidden');
                dom.motivationModal.classList.add('flex');

                const randomIndex = Math.floor(Math.random() * MOTIVATIONAL_MESSAGES.length);
                const randomButtonText = MOTIVATION_BUTTON_TEXTS[Math.floor(Math.random() * MOTIVATION_BUTTON_TEXTS.length)];

                dom.motivationTitle.style.fontWeight = 'normal';
                dom.motivationQuote.textContent = MOTIVATIONAL_MESSAGES[randomIndex];
                dom.motivationQuote.style.fontWeight = 'bold';
                dom.motivationQuote.classList.add('shimmer-text');
                dom.closeMotivationModal.textContent = randomButtonText;

                setTimeout(() => dom.motivationQuote.classList.remove('shimmer-text'), 2500);

                const toggle = dom.motivationToggle;
                toggle.checked = motivationEnabled;
            }

            function hideMotivationModal() {
                dom.motivationModal.classList.add('hidden');
                dom.motivationModal.classList.remove('flex');
            }

            function setupMotivationInterval() {
                if (motivationInterval) clearInterval(motivationInterval);
                if (!motivationEnabled) return;

                const thirtyMinutes = 30 * 60 * 1000;
                motivationInterval = setInterval(() => {
                    if (!motivationEnabled) {
                        clearInterval(motivationInterval);
                        return;
                    }
                    const lang = localStorage.getItem('goatify-lang') || 'es';
                    const randomIndex = Math.floor(Math.random() * MOTIVATIONAL_MESSAGES.length);
                    const message = MOTIVATIONAL_MESSAGES[randomIndex];
                    const title = `<i class="fas fa-lightbulb text-yellow-400 mr-2"></i> ${translations[lang].motivation_title || 'Dosis de Motivaci√≥n'}`;
                    const body = `<p class="text-md">${message}</p>`;

                    showInAppNotification(title, body, 4000);
                    triggerPushNotification(translations[lang].motivation_title, message);

                }, thirtyMinutes);
            }
            function setupEventListeners() {
                dom.inAppNotificationClose?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dom.inAppNotification.classList.remove('show');
                });
                dom.taskNotificationCloseBtn?.addEventListener('click', hideTaskNotification);

                dom.planCreditsInfo?.addEventListener('click', () => {
                    const { remaining, limit, plan } = getCreditCount();
                    const gamCredits = (currentUser && gamificationState.credits) ? gamificationState.credits : 0;
                    const lang = localStorage.getItem('goatify-lang') || 'es';

                    const todayKey = dayjs().format('YYYY-MM-DD');
                    const allTasksToday = getTasksForDay(todayKey);
                    const completedTasksToday = allTasksToday.filter(task => task.completed).length;
                    let totalPendingTasksToday = allTasksToday.filter(task => !task.completed).length; // Calculate pending tasks
                    let totalChatActivities = 0;
                    Object.values(state.chats).forEach(chat => {
                        if(chat.messages) {
                            chat.messages.forEach(msg => {
                                if (dayjs(msg.timestamp).isSame(dayjs(), 'day')) {
                                    totalChatActivities++;
                                }
                            });
                        }
                    });
                    const totalActivitiesToday = completedTasksToday + totalPendingTasksToday + Math.floor(totalChatActivities / 2); // Sum of completed, pending tasks and chat messages

                    const positiveMessages = [
                        "¬°Est√°s haciendo un trabajo incre√≠ble!",
                        "¬°Cada peque√±o paso te acerca a tu √©xito!",
                        "¬°Sigue as√≠, la constancia es clave!",
                        "¬°Eres imparable, el GOAT en acci√≥n!",
                        "¬°Tu dedicaci√≥n te lleva lejos!"
                    ];
                    const randomPositiveMessage = positiveMessages[Math.floor(Math.random() * positiveMessages.length)];

                    let bodyContent = `
                        <div class="text-center mb-4">
                            <p id="modal-welcome-user-greeting" class="text-xl font-bold text-primary mb-2"></p>
                            <p id="modal-current-date-display" class="text-lg text-text-medium"></p>
                            <p id="modal-current-time-display" class="text-3xl font-extrabold text-primary animate-pulse"></p>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-center mb-4">
                            <div class="bg-current-bg-light p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
                                <h4 class="font-semibold text-text-light text-sm mb-1">
                                    <span data-translate-key="tasks_completed_today">Tareas completadas hoy:</span>
                                    <i class="fas fa-info-circle text-text-medium ml-1 cursor-pointer" title="N√∫mero de tareas que has marcado como completadas en tu calendario o en tus proyectos durante el d√≠a de hoy."></i>
                                </h4>
                                <p id="calendar-info-completed-tasks" class="text-2xl font-bold text-primary">${completedTasksToday}/${allTasksToday.length}</p>
                            </div>
                            <div class="bg-current-bg-light p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
                                <h4 class="font-semibold text-text-light text-sm mb-1">
                                    <span data-translate-key="pending_tasks_today">Tareas pendientes hoy:</span>
                                    <i class="fas fa-info-circle text-text-medium ml-1 cursor-pointer" title="Tareas que tienen fecha de vencimiento hoy y a√∫n no han sido completadas, incluyendo las de tus proyectos."></i>
                                </h4>
                                <p id="calendar-info-pending-tasks" class="text-2xl font-bold text-red-500">${totalPendingTasksToday}</p>
                            </div>
                            <div class="bg-current-bg-light p-4 rounded-lg shadow-md col-span-2 flex flex-col items-center justify-center">
                                <h4 class="font-semibold text-text-light text-sm mb-1">
                                    <span data-translate-key="total_activities_today">Actividades totales hoy:</span>
                                    <i class="fas fa-info-circle text-text-medium ml-1 cursor-pointer" title="Suma de todas las interacciones del d√≠a: tareas completadas, tareas pendientes y mensajes enviados en los chats."></i>
                                </h4>
                                <p id="calendar-info-total-activities" class="text-2xl font-bold text-gold">${totalActivitiesToday}</p>
                            </div>
                        </div>
                        <p class="mb-3 text-sm"><strong>${translations[lang].current_plan_details}</strong> ${plan.toUpperCase()}</p>
                        <p class="mb-4 text-sm"><strong>${translations[lang].credits_breakdown}</strong> ${remaining}/${limit === Infinity ? '‚àû' : limit} (${gamCredits} ü™ô)</p>
                        <p class="mb-4 text-md font-semibold text-primary text-center">${randomPositiveMessage}</p>
                    `;

                    showModal({
                        title: translations[lang].credits_details_title,
                        body: bodyContent,
                        showCancel: false,
                        confirmText: translations[lang].understood_btn,
                        extraButtons: [{
                            id: 'modal-view-active-plan-btn',
                            text: translations[lang].view_active_plan,
                            classes: 'btn-primary px-4 py-2 rounded',
                            action: () => {
                                hideModal();
                                showPricingModal();
                            }
                        },
                        {
                            id: 'modal-learn-about-credits-btn',
                            text: translations[lang].learn_about_credits,
                            classes: 'px-4 py-2 rounded bg-gray-500 text-white',
                            action: () => {
                                hideModal();
                                showModal({
                                    title: translations[lang].learn_about_credits,
                                    body: `<ul class="list-disc list-inside space-y-2 text-sm">
                                <li><strong>GOAT X:</strong> ${COSTS.GENERAL} cr√©dito</li>
                                <li><strong>B√∫squeda Web:</strong> ${COSTS.SEARCH} cr√©ditos</li>
                                <li><strong>Workflows:</strong> ${COSTS.WORKFLOW} cr√©ditos</li>
                                <li><strong>An√°lisis de PDF:</strong> ${COSTS.PDF_ANALYSIS} cr√©ditos</li>
                                <li><strong>An√°lisis de Imagen:</strong> ${COSTS.IMAGE_ANALYSIS} cr√©ditos</li>
                                <li><strong>Creaci√≥n de Imagen (DALL-E):</strong> ${COSTS.IMAGE_GENERATION} cr√©ditos</li>
                                <li><strong>GOAT X PRO (GPT-4o):</strong> ${COSTS.GPT4O} cr√©ditos</li>
                               </ul>
                               <p class="mt-4 text-sm italic">${translations[lang].gamification_credits_info}</p>`,
                                    confirmText: translations[lang].understood_btn,
                                    showCancel: false
                                });
                            }
                        }]
                    });

                    const modalWelcomeGreeting = document.getElementById('modal-welcome-user-greeting');
                    const modalDateDisplay = document.getElementById('modal-current-date-display');
                    const modalTimeDisplay = document.getElementById('modal-current-time-display');

                    const userName = currentUser ? (currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.email.split('@')[0]) : '';
                    let greetingTitle = 'Jefe';
                    if (userName.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(userName.toLowerCase())) {
                        greetingTitle = 'Jefa';
                    }
                    modalWelcomeGreeting.innerHTML = `¬°Hola, <span class="text-primary">${userName || greetingTitle}</span>! Ten un excelente d√≠a.`;

                    const updateModalTime = () => {
                        const now = dayjs();
                        if (modalDateDisplay) modalDateDisplay.textContent = now.format('dddd, D [de] MMMM [de]YYYY');
                        if (modalTimeDisplay) modalTimeDisplay.textContent = now.format('HH:mm:ss');
                    };
                    updateModalTime();
                    const modalTimeInterval = setInterval(updateModalTime, 1000);

                    const observer = new MutationObserver((mutationsList, observer) => {
                        for (const mutation of mutationsList) {
                            if (mutation.attributeName === 'class' && dom.genericModal.classList.contains('hidden')) {
                                clearInterval(modalTimeInterval);
                                observer.disconnect();
                            }
                        }
                    });
                    observer.observe(dom.genericModal, { attributes: true });
                });


                dom.rewardCreditsInfo?.addEventListener('click', () => {
                    if(!currentUser) {
                        showInAppNotification(translations[localStorage.getItem('goatify-lang') || 'es'].exclusive_feature_title || "Funci√≥n Exclusiva", translations[localStorage.getItem('goatify-lang') || 'es'].exclusive_feature_message || "La gamificaci√≥n est√° disponible para usuarios logueados.", 3000);
                        return;
                    }
                    renderGamificationModal();
                    dom.gamificationModal.classList.remove('hidden');
                    dom.gamificationModal.classList.add('flex');
                    setTimeout(() => dom.gamificationModal.querySelector('.modal-content').classList.remove('scale-95'), 10);
                });


                const motivationClickHandler = () => showMotivationModal();
                dom.motivationBtnHeader?.addEventListener('click', motivationClickHandler);
                dom.motivationBtnMobile?.addEventListener('click', motivationClickHandler);

                dom.closeMotivationModal?.addEventListener('click', hideMotivationModal);
                dom.motivationToggle?.addEventListener('change', () => {
                    motivationEnabled = dom.motivationToggle.checked;
                    localStorage.setItem('goatify-motivation-enabled', motivationEnabled);
                    if(motivationEnabled) {
                        setupMotivationInterval();
                    } else {
                        if(motivationInterval) clearInterval(motivationInterval);
                    }
                });

                dom.sendBtn?.addEventListener('click', () => sendMessage(false, null, { assistantType: 'main' }));

                const setupAssistantInput = (inputId, sendId, assistantType) => {
                    const inputEl = document.getElementById(inputId);
                    const sendBtn = document.getElementById(sendId);

                    if (sendBtn) {
                        sendBtn.addEventListener('click', () => {
                             sendMessage(false, null, { assistantType });
                        });
                    }
                     if (inputEl) {
                        inputEl.addEventListener('keydown', e => {
                            if (e.key === 'Enter' && !e.shiftKey) {
                                e.preventDefault();
                                sendMessage(false, null, { assistantType });
                            }
                        });
                     }
                };

                setupAssistantInput('project-msg', 'project-send', 'project');
                setupAssistantInput('notepad-msg', 'notepad-send', 'notepad');


                dom.msgInput?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                         sendMessage(false, null, { assistantType: 'main' });
                    }
                });
                dom.msgInput?.addEventListener('input', () => {
                    dom.msgInput.style.height = 'auto';
                    dom.msgInput.style.height = (dom.msgInput.scrollHeight) + 'px';
                });

                const newChatHandler = () => createNewChat();
                dom.newChatBtn?.addEventListener('click', newChatHandler);
                dom.newChatIconBtn?.addEventListener('click', newChatHandler);

                dom.newFolderBtn?.addEventListener('click', async () => { const result = await showModal({ title: translations[localStorage.getItem('goatify-lang') || 'es'].create_folder_title || 'Crear Nueva Carpeta', body: `<input type="text" id="project-name" class="w-full p-2 rounded bg-input border border-themed" placeholder="${translations[localStorage.getItem('goatify-lang') || 'es'].folder_name_placeholder || 'Nombre de la Carpeta...'}">`, confirmText: translations[localStorage.getItem('goatify-lang') || 'es'].create_btn || 'Crear' }); if (result.confirmed && result.data['project-name'].trim()) { const id = 'project-' + crypto.randomUUID(); state.projects[id] = { id, title: result.data['project-name'].trim(), itemIds: [] }; state.structure.unshift(id); saveState(); renderSidebar(); } });
                dom.newFolderIconBtn?.addEventListener('click', async () => {
                    const result = await showModal({
                        title: translations[localStorage.getItem('goatify-lang') || 'es'].create_folder_title || 'Crear Nueva Carpeta',
                        body: `<input type="text" id="project-name" class="w-full p-2 rounded bg-input border border-themed" placeholder="${translations[localStorage.getItem('goatify-lang') || 'es'].folder_name_placeholder || 'Nombre de la Carpeta...'}">`,
                        confirmText: translations[localStorage.getItem('goatify-lang') || 'es'].create_btn || 'Crear'
                    });
                    if (result.confirmed && result.data['project-name'].trim()) {
                        const id = 'project-' + crypto.randomUUID();
                        state.projects[id] = { id, title: result.data['project-name'].trim(), itemIds: [] };
                        state.structure.unshift(id);
                        saveState();
                        renderSidebar();
                        showInAppNotification(translations[localStorage.getItem('goatify-lang') || 'es'].success_title || "√âxito", `${translations[localStorage.getItem('goatify-lang') || 'es'].folder_created_message || "Carpeta"} "${result.data['project-name'].trim()}" ${translations[localStorage.getItem('goatify-lang') || 'es'].created_suffix || "creada."}`, 800);
                    }
                });
                dom.addProjectFolderBtn?.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const result = await showModal({
                        title: translations[localStorage.getItem('goatify-lang') || 'es'].create_folder_title || 'Crear Nueva Carpeta',
                        body: `<input type="text" id="project-name" class="w-full p-2 rounded bg-input border border-themed" placeholder="${translations[localStorage.getItem('goatify-lang') || 'es'].folder_name_placeholder || 'Nombre de la Carpeta...'}">`,
                        confirmText: translations[localStorage.getItem('goatify-lang') || 'es'].create_btn || 'Crear'
                    });
                    if (result.confirmed && result.data['project-name'].trim()) {
                        const id = 'project-' + crypto.randomUUID();
                        state.projects[id] = { id, title: result.data['project-name'].trim(), itemIds: [] };
                        state.structure.unshift(id);
                        saveState();
                        renderSidebar();
                        showInAppNotification(translations[localStorage.getItem('goatify-lang') || 'es'].success_title || "√âxito", `${translations[localStorage.getItem('goatify-lang') || 'es'].folder_created_message || "Carpeta"} "${result.data['project-name'].trim()}" ${translations[localStorage.getItem('goatify-lang') || 'es'].created_suffix || "creada."}`, 800);
                    }
                });


                dom.upgradePlanBtn?.addEventListener('click', showPricingModal);
                dom.closePricingModalBtn?.addEventListener('click', hidePricingModal);
                dom.themeToggle?.addEventListener('click', () => setTheme(!document.body.classList.contains('dark-theme')));
                dom.loginBtn?.addEventListener('click', () => netlifyIdentity.open('login'));

                dom.desktopChatTitleWrapper?.addEventListener('click', (e) => {
                    if (!e.target.closest('#calendar-btn') && !e.target.closest('#motivation-btn-header') && currentChatId && currentChatId.startsWith('chat-')) {
                        renameItem('chat', currentChatId);
                    }
                });
                dom.mobileChatTitleWrapper?.addEventListener('click', (e) => {
                    if (!e.target.closest('#calendar-btn-mobile') && !e.target.closest('#motivation-btn-mobile') && currentChatId && currentChatId.startsWith('chat-')) {
                        renameItem('chat', currentChatId);
                    }
                });

                dom.imageGenBtn?.addEventListener('click', generateImage);
                dom.pdfUploadBtn?.addEventListener('click', () => dom.pdfUploadInput.click());
                dom.imageUploadBtn?.addEventListener('click', () => dom.imageUploadInput.click());
                if (SR && dom.micBtn) {
                    recognition = new SR();
                    recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'es-ES';
                    recognition.onstart = () => { isRecognizing = true; dom.micBtn.classList.add('glowing-mic'); };
                    recognition.onend = () => { isRecognizing = false; dom.micBtn.classList.remove('glowing-mic'); };
                    recognition.onerror = (e) => { console.error("Speech recognition error", e); isRecognizing = false; dom.micBtn.classList.remove('glowing-mic'); };
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        const activeView = document.querySelector('#view-container > div:not(.hidden)');
                        let assistantType = 'main';
                        if(activeView) {
                            if(activeView.id === 'project-management-view') assistantType = 'project';
                            else if(activeView.id === 'financial-assistant-view') assistantType = 'financial';
                            else if(activeView.id === 'notepad-view-container') assistantType = 'notepad';
                        }

                        let activeInput = dom.msgInput;
                        if(assistantType === 'project') activeInput = dom.projectMsgInput;
                        else if(assistantType === 'financial') activeInput = document.getElementById('financial-msg');
                        else if(assistantType === 'notepad') activeInput = dom.notepadMsgInput;

                        activeInput.value = transcript;
                        sendMessage(false, null, { assistantType });
                    };
                    dom.micBtn.addEventListener('click', () => {
                        if(isRecognizing) { recognition.stop(); }
                        else { if (speechSynthesis.speaking) { speechSynthesis.cancel(); } try { recognition.start(); } catch(e) {console.error("Could not start recognition", e)} }
                    });
                } else { if(dom.micBtn) dom.micBtn.style.display = 'none'; }

                dom.ttsToggle?.addEventListener('click', () => {
                    speechOn = !speechOn;
                    const icon = dom.ttsToggle.querySelector('i');
                     icon.classList.toggle('fa-volume-high', speechOn);
                    icon.classList.toggle('fa-volume-mute', !speechOn);
                    if (!speechOn) {
                        speechSynthesis.cancel();
                    }
                 });

                dom.modelSelector?.addEventListener('change', () => {
                    const selectedValue = dom.modelSelector.value;
                    if (selectedValue === 'gpt-4o' && (!currentUser || (currentUser.app_metadata?.plan || 'free') === 'free')) {
                        showInAppNotification(translations[localStorage.getItem('goatify-lang') || 'es'].restricted_access_title || "Acceso Restringido", translations[localStorage.getItem('goatify-lang') || 'es'].restricted_access_message || "El modelo GOAT X PRO est√° disponible solo para usuarios con un plan de pago.", 3000);
                        dom.modelSelector.value = 'gpt-3.5-turbo-1106';
                    }
                });

                dom.clearImageBtn?.addEventListener('click', clearImageData);
                dom.clearPdfBtn?.addEventListener('click', clearPdfData);
                dom.imageUploadInput?.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { dom.filePreviewArea.style.display = "block"; clearPdfData(); const reader = new FileReader(); reader.onload = (ev) => { selectedImageBase64 = ev.target.result; dom.imagePreview.src = selectedImageBase64; dom.imagePreviewContainer.classList.remove('hidden'); }; reader.readAsDataURL(e.target.files[0]); } });
                dom.pdfUploadInput?.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file || file.type !== 'application/pdf') return; dom.filePreviewArea.style.display = "block"; clearImageData(); dom.pdfNameEl.textContent = file.name; dom.pdfStatusEl.textContent = translations[localStorage.getItem('goatify-lang') || 'es'].reading_pdf_status || 'Leyendo...'; dom.pdfPreviewContainer.classList.remove('hidden'); const reader = new FileReader(); reader.onload = async (ev) => { dom.pdfStatusEl.textContent = translations[localStorage.getItem('goatify-lang') || 'es'].processing_pdf_status || 'Procesando...'; try { const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(ev.target.result) }).promise; let text = ''; for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const content = await page.getTextContent(); text += content.items.map(item => item.str).join(' ') + '\n'; } selectedPdfText = text; dom.pdfStatusEl.textContent = `‚úÖ ${translations[localStorage.getItem('goatify-lang') || 'es'].pdf_ready_status || 'Listo'} (${pdf.numPages} ${translations[localStorage.getItem('goatify-lang') || 'es'].pages_short || 'p√°g.'})`; } catch (err) { console.error("Error al procesar el PDF:", err); dom.pdfStatusEl.textContent = `‚ùå ${translations[localStorage.getItem('goatify-lang') || 'es'].pdf_error_status || 'Error al leer PDF.'}`; selectedPdfText = null; setTimeout(clearPdfData, 2000); } }; reader.readAsArrayBuffer(file); });
                dom.menuToggle?.addEventListener('click', (e) => { e.stopPropagation(); toggleSidebar(true); });
                dom.sidebarOverlay?.addEventListener('click', () => toggleSidebar(false));
                dom.sidebarToggleArrow?.addEventListener('click', () => {
                    dom.sidebar.classList.toggle('collapsed');
                    if (dom.sidebar.classList.contains('collapsed')) {
                        dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-left', 'fa-chevron-right');
                    } else {
                        dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-right', 'fa-chevron-left');
                    }
                });
                dom.sidebar.querySelector('#logo-space')?.addEventListener('click', () => {
                    if (window.innerWidth >= 768) {
                        dom.sidebar.classList.toggle('collapsed');
                         if (dom.sidebar.classList.contains('collapsed')) {
                            dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-left', 'fa-chevron-right');
                        } else {
                            dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-right', 'fa-chevron-left');
                        }
                    }
                });

                dom.userMenuBtn?.addEventListener('click', (e) => { e.stopPropagation(); dom.userMenuPopup.classList.toggle('hidden'); });
                dom.logoutBtn?.addEventListener('click', () => { netlifyIdentity.logout(); dom.userMenuPopup.classList.add('hidden');});

                dom.userSettingsIcon?.addEventListener('click', (e) => { e.stopPropagation(); showSettingsModal(); });

                const workflowConfigs = {
                    'decision-lab': { title: "Laboratorio de Decisiones", workflow: 'decision-lab', initialMessages: [{ role: 'assistant', content: 'Bienvenido al Laboratorio de Decisiones. Recuerda que una decisi√≥n puede cambiar el rumbo de tu vida. Para ayudarte a analizar tu situaci√≥n, por favor, dime: ¬øCu√°l es la decisi√≥n que necesitas tomar y qu√© opciones est√°s considerando?' }] },
                    'conflict-resolution': { title: "Resoluci√≥n de Conflictos", workflow: 'conflict-resolution', initialMessages: [{ role: 'assistant', content: 'Entiendo. Las situaciones dif√≠ciles requieren una comunicaci√≥n clara. Por favor, describe el conflicto objetivamente: ¬øqui√©nes est√°n involucrados y cu√°l es el punto principal de desacuerdo?' }] },
                    'create-full-post': { title: "Crear Post Completo", workflow: 'create-full-post', initialMessages: [{ role: 'assistant', content: '¬°Claro! Vamos a crear un post incre√≠ble. ¬øPara qu√© red social lo necesitas (Instagram, Facebook, LinkedIn, etc.)?' }] },
                    'persuasive-copy': { title: "Redacci√≥n de Copys", workflow: 'persuasive-copy', initialMessages: [{ role: 'assistant', content: 'Estoy listo para redactar textos que vendan. ¬øPara qu√© necesitas este copy? (ej: Anuncio de Facebook, Post de Venta, Descripci√≥n de Producto)' }] },
                    'post-ideas': { title: "Lluvia de Ideas para Posts", workflow: 'post-ideas', initialMessages: [{ role: 'assistant', content: '¬°Acabemos con el bloqueo creativo! Dime un tema y te dar√© 7 ideas de contenido excelentes.' }] },
                    'brand-strategy': { title: "Estrategia de Marca", workflow: 'brand-strategy', initialMessages: [{ role: 'assistant', content: 'Definamos el coraz√≥n de tu marca. ¬øCu√°l es el nombre de tu negocio y a qu√© se dedica?' }] },
                    'competitor-analysis': { title: "An√°lisis de Competencia", workflow: 'competitor-analysis', model: 'sonar', initialMessages: [{ role: 'assistant', content: "Estoy listo para analizar a tu competencia usando el buscador web. Por favor, pega la URL (direcci√≥n web) de la p√°gina que quieres que investigue para entregarte un an√°lisis DAFO simplificado." }] },
                    'buyer-persona': { title: "Definir Cliente Ideal", workflow: 'buyer-persona', initialMessages: [{ role: 'assistant', content: "Vamos a definir a tu cliente ideal (Buyer Persona). Describe tu producto o servicio, y te har√© preguntas para construir el perfil detallado paso a paso." }] },
                    'brand-names': { title: "Lluvia de Nombres de Marca", workflow: 'brand-names', initialMessages: [{ role: 'assistant', content: "¬°Excelente! Busquemos un nombre incre√≠ble. Describe brevemente tu idea de negocio, tu p√∫blico y el estilo que buscas (ej. moderno, cl√°sico, divertido) para generar nombres y slogans." }] },
                    'sales-assistant': { title: "Ventas para tu Negocio", workflow: 'sales-assistant', initialMessages: [{ role: 'assistant', content: 'Para ayudarte a cerrar esa venta, pega aqu√≠ el mensaje de tu cliente.' }] },
                    'email-writing': { title: "Redacci√≥n de Email", workflow: 'email-writing', initialMessages: [{ role: 'assistant', content: 'Creemos un email que convierta. ¬øCu√°l es el objetivo principal de este correo?' }] },
                    'english-teacher-translate': { title: "Traducir/Corregir Texto", workflow: 'english-teacher-translate', initialMessages: [{ role: 'assistant', content: 'Of course! Please provide the text you want me to translate or correct.' }] },
                    'english-teacher-vocabulary': { title: "Aprender Vocabulario", workflow: 'english-teacher-vocabulary', initialMessages: [{ role: 'assistant', content: 'Excellent! Let\'s learn some new vocabulary. What topic are you interested in? (e.g., "business negotiations", "travel")' }] },
                    'english-teacher-practice': { title: "Practicar Conversaci√≥n", workflow: 'english-teacher-practice', initialMessages: [{ role: 'assistant', content: 'Great! Let\'s practice our conversation. So, tell me about your day.' }] },
                    'social-skills': { title: "Mejorar Habilidades Sociales", workflow: 'social-skills', initialMessages: [{ role: 'assistant', content: 'Las habilidades sociales son clave. ¬øEn qu√© situaci√≥n te gustar√≠a mejorar tu comunicaci√≥n? (Ej: una reuni√≥n de networking, una conversaci√≥n dif√≠cil, etc.)' }] },
                    'design-web': { title: "Dise√±o Web", workflow: 'design-web', model: 'gpt-4o', initialMessages: [{ role: 'assistant', content: 'Estoy listo para dise√±ar con c√≥digo. Describe la p√°gina o componente que quieres crear, y lo programar√© para ti.' }] },
                };

                // FIX: Delegated event listener for all sidebar sections
                document.body.addEventListener('click', e => {
                    const header = e.target.closest('.workflow-header, .actions-header, .folders-header');
                    if (header) {
                        const parentCategory = header.parentElement;
                        const workflowKey = header.dataset.workflow;

                        // FIX: Logic to handle Assistant buttons (Project, Finance, Notepad)
                        if (workflowKey) {
                            const mainAssistants = ['project-management', 'financial-assistant', 'notepad-app'];
                            if (mainAssistants.includes(workflowKey)) {
                                e.stopPropagation(); // Prevent collapse/expand
                                if (workflowKey === 'notepad-app') {
                                    selectChat('notepad-app');
                                } else {
                                    // Check if a chat for this assistant already exists
                                    const existingChatId = Object.keys(state.chats).find(id => state.chats[id].workflow === workflowKey);
                                    if (existingChatId) {
                                        selectChat(existingChatId);
                                    } else {
                                        createNewChat({ title: header.querySelector('span').textContent.trim(), workflow: workflowKey });
                                    }
                                }
                                return;
                            }
                        }
                        
                        // FIX: Logic for collapsing/expanding any category, including projects
                        if (!e.target.closest('button')) {
                            const isOpen = parentCategory.classList.toggle('open');
                            if (parentCategory.classList.contains('project')) {
                                const projectId = parentCategory.dataset.id;
                                if (state.projects[projectId]) {
                                    state.projects[projectId].isOpen = isOpen;
                                    saveState();
                                }
                            }
                        }
                    }

                    const workflowButton = e.target.closest('[data-workflow]');
                    if (workflowButton && workflowButton.closest('.workflow-content')) {
                        const workflowKey = workflowButton.dataset.workflow;
                        const config = workflowConfigs[workflowKey];
                         if (config) {
                            createNewChat(config);
                        }
                    }
                });

                dom.webLaunchOfferBtn.addEventListener('click', () => {
                    const lang = localStorage.getItem('goatify-lang') || 'es';
                    const offerTitle = `<i class="fas fa-gift mr-2"></i>${'Tu Oferta de Lanzamiento Exclusiva'}`;
                    const offerMessage = `<p class="font-bold mb-2">${'Al suscribirte a nuestro Plan Pro por $17/mes, desbloqueas:'}</p><ul class="list-disc list-inside space-y-2 text-left"><li><strong>${'Acceso Ilimitado a Goatify IA:'}</strong> ${'Todos los modelos y workflows sin restricciones.'}</li><li><strong>${'Construcci√≥n de tu P√°gina Web Profesional:'}</strong> ${'Nosotros construiremos la primera versi√≥n, ¬°gratis!'}</li></ul><p class="font-bold mt-4 mb-2">${'¬øC√≥mo funciona?'}</p><ol class="list-decimal list-inside space-y-1 text-left"><li><strong>${'Agenda tu Sesi√≥n Estrat√©gica:'}</strong> ${'Al confirmar, agenda tu llamada de 20 min.'}</li><li><strong>${'Co-creaci√≥n:'}</strong> ${'En la llamada definiremos objetivos y crearemos el borrador con IA.'}</li><li><strong>${'Entrega:'}</strong> ${'Nuestro equipo lo pulir√° y te entregar√° una web de una secci√≥n, lista.'}</li></ol><p class="text-xs mt-4 italic"><strong>${'Importante:'}</strong> ${'La web es tuya para siempre. Para mantenerla online con nuestro hosting, necesitas tu suscripci√≥n Pro activa. Si cancelas, te entregamos el c√≥digo completo.'}</p>`;
                    showModal({ title: offerTitle, body: offerMessage, confirmText: 'Agendar Sesi√≥n Estrat√©gica' }).then(res => { if (res.confirmed) { window.open('https://calendly.com/goatify', '_blank'); } });
                });
                dom.freeGuidesLink.addEventListener('click', (e) => { e.preventDefault(); const isPaidUser = currentUser && currentUser.app_metadata?.plan && currentUser.app_metadata.plan !== 'free'; if (isPaidUser) { window.open('https://goatify.app/guiasIA', '_blank'); } else { const lang = localStorage.getItem('goatify-lang') || 'es'; const title = 'Acceso Exclusivo para Suscriptores'; const message = 'Estas gu√≠as se actualizan semanalmente con estrategias de negocio que te ayudar√°n a crecer un mont√≥n. Son un beneficio exclusivo para nuestros suscriptores. ¬°√önete a un plan para desbloquearlas!'; showModal({ title, body: message, confirmText: 'Ver Planes' }).then(res => { if (res.confirmed) { showPricingModal(); } }); } });
                dom.closeHtmlPreviewModalBtn?.addEventListener('click', () => { dom.htmlPreviewModal.classList.add('hidden'); dom.htmlPreviewModal.classList.remove('flex'); });

                // FIX: Correctly implement HTML download functionality
                dom.downloadHtmlBtn?.addEventListener('click', () => {
                    try {
                        const htmlContent = dom.htmlPreviewIframe.contentDocument.documentElement.outerHTML;
                        const blob = new Blob([htmlContent], { type: 'text/html' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'goatify-page.html';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        showInAppNotification("Descarga Exitosa", "El archivo HTML ha sido descargado.", 1500);
                    } catch (error) {
                        console.error("Error al descargar HTML:", error);
                        showInAppNotification("Error de Descarga", "No se pudo preparar el archivo para la descarga.", 1500);
                    }
                });

                dom.copyHtmlBtn?.addEventListener('click', () => {
                    const htmlContent = dom.htmlPreviewIframe.contentDocument.documentElement.outerHTML;
                    navigator.clipboard.writeText(htmlContent)
                        .then(() => showInAppNotification("Copiado", "El c√≥digo HTML ha sido copiado al portapapeles.", 800))
                        .catch(err => console.error('Error al copiar el texto: ', err));
                });


                dom.voiceSelector?.addEventListener('change', (e) => { selectedVoice = availableVoices.find(voice => voice.name === e.target.value); });

                document.addEventListener('click', (e) => {
                    if (dom.userMenuBtn && dom.userMenuPopup && !dom.userMenuBtn.contains(e.target) && !dom.userMenuPopup.contains(e.target) && !dom.userSettingsIcon.contains(e.target)) { dom.userMenuPopup.classList.add('hidden'); }

                    const servicesMenu = dom.servicesMenu;
                    const servicesMenuBtn = dom.servicesMenuBtn;
                    if (servicesMenu && servicesMenuBtn && servicesMenu.classList.contains('show') && !servicesMenuBtn.contains(e.target) && !servicesMenu.contains(e.target)) {
                        servicesMenu.classList.remove('show');
                    }
                    if (dom.tagFilterDropdown && dom.tagFilterBtn && !dom.tagFilterBtn.contains(e.target) && !dom.tagFilterDropdown.contains(e.target)) {
                        dom.tagFilterDropdown.classList.add('hidden');
                    }
                    document.querySelectorAll('.add-to-folder-dropdown').forEach(dropdown => {
                        if (!e.target.closest('.add-to-folder-btn')) {
                            dropdown.classList.add('hidden');
                        }
                    });
                });

                const solutionLinks = {
                    "sol-web": "Hola, estoy interesado en su servicio de 'P√°ginas Web que Convierten'. ¬øPodr√≠an darme m√°s informaci√≥n?",
                    "sol-auto": "Hola, me interesa saber m√°s sobre 'Ventas en Piloto Autom√°tico' con IA. ¬øC√≥mo funciona?",
                    "sol-social": "Hola, quisiera informaci√≥n sobre los 'Avatares para Redes Sociales' y las estrategias de contenido.",
                    "sol-consult": "Hola, estoy interesado en la consultor√≠a para 'Escalar mi Empresa con IA'. ¬øCu√°les son los siguientes pasos?"
                };

                Object.entries(solutionLinks).forEach(([id, message]) => {
                    const linkEl = document.getElementById(id);
                    if (linkEl) {
                        linkEl.addEventListener('click', (e) => {
                            e.preventDefault();
                            const whatsappUrl = `https://wa.me/17439106116?text=${encodeURIComponent(message)}`;
                            window.open(whatsappUrl, '_blank');
                        });
                    }
                });

                dom.servicesMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dom.servicesMenu.classList.toggle('show');
                });

                const setAppHeight = () => { const app = document.getElementById('app-container'); if(app) app.style.height = `${window.innerHeight}px`; };
                setAppHeight();
                window.addEventListener('resize', setAppHeight);
                dom.selectChatsBtn?.addEventListener('click', () => toggleSelectMode(true));
                dom.cancelSelectModeBtn?.addEventListener('click', () => toggleSelectMode(false));
                dom.deleteSelectedBtn?.addEventListener('click', async () => { if (chatsToDelete.size === 0) return; const lang = localStorage.getItem('goatify-lang') || 'es'; const confirm = await showModal({ title: `Eliminar ${chatsToDelete.size} elemento(s)`, body: 'Esta acci√≥n es irreversible. ¬øConfirmas la eliminaci√≥n?', confirmText: 'Eliminar', dangerConfirm: true }); if (confirm.confirmed) { chatsToDelete.forEach(id => deleteItem(id.split('-')[0], id)); toggleSelectMode(false); } });
                dom.settingsBtn?.addEventListener('click', showSettingsModal);
                dom.closeSettingsModal?.addEventListener('click', hideSettingsModal);
                dom.settingsUpgradePlanBtn?.addEventListener('click', () => { hideSettingsModal(); showPricingModal(); });
                dom.fontSizeSlider?.addEventListener('input', (e) => {
                    const fontSize = e.target.value;
                    document.body.style.setProperty('--base-font-size', `${fontSize}px`);
                    dom.fontSizeValue.textContent = `${fontSize}px`;
                });
                dom.settingsThemeToggle?.addEventListener('click', () => {
                    setTheme(!document.body.classList.contains('dark-theme'));
                });
                dom.notificationsToggle?.addEventListener('change', async () => {
                    notificationsEnabled = dom.notificationsToggle.checked;
                    localStorage.setItem('goatify-notifications-enabled', notificationsEnabled);
                    if (notificationsEnabled) {
                        const permission = await Notification.requestPermission();
                        if (permission === 'granted') {
                            registerServiceWorkerAndSubscribe();
                        } else {
                            notificationsEnabled = false;
                            dom.notificationsToggle.checked = false;
                             localStorage.setItem('goatify-notifications-enabled', 'false');
                        }
                    }
                });
                dom.languageSelector?.addEventListener('change', (e) => {
                    setLanguage(e.target.value);
                });
                dom.connectWhatsappBtn?.addEventListener('click', () => {
                    window.open('https://wa.me/17439106116?text=Hola%2C%20me%20gustar%C3%ADa%20conectar%20mi%20cuenta%20de%20Goatify%20IA%20a%20WhatsApp.', '_blank');
                });
                dom.scheduleMeetingBtn?.addEventListener('click', () => {
                    window.open('https://calendly.com/goatify', '_blank');
                });
                dom.freePlanButton?.addEventListener('click', showPricingModal);

                dom.calendarBtn?.addEventListener('click', showCalendarModal);
                dom.mobileCalendarBtn?.addEventListener('click', showCalendarModal);

                dom.projectCalendarBtn?.addEventListener('click', showCalendarModal);
                dom.closeCalendarModal?.addEventListener('click', hideCalendarModal);

                dom.prevMonthBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.subtract(1, 'month'); renderCalendarView(); });
                dom.nextMonthBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.add(1, 'month'); renderCalendarView(); });
                dom.prevWeekBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.subtract(1, 'week'); renderCalendarView(); });
                dom.nextWeekBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.add(1, 'week'); renderCalendarView(); });
                dom.prevDayBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.subtract(1, 'day'); renderCalendarView(); });
                dom.nextDayBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.add(1, 'day'); renderCalendarView(); });

                dom.monthViewBtn.addEventListener('click', () => { currentCalendarView = 'month'; renderCalendarView(); });
                dom.weekViewBtn.addEventListener('click', () => { currentCalendarView = 'week'; renderCalendarView(); });
                dom.dayViewBtn.addEventListener('click', () => { currentCalendarView = 'day'; renderCalendarView(); });
                dom.addTaskBtn?.addEventListener('click', () => editCalendarTask(null, selectedCalendarDate.format('YYYY-MM-DD')));

                document.body.addEventListener('click', (e) => {
                    // Handle info popups for calendar/Mi D√≠a metrics
                    if (e.target.classList.contains('fa-info-circle')) {
                        const title = e.target.closest('h4')?.textContent.trim().replace(/\s*[\r\n].*/g, '').replace(/\s*(\r|\n)\s*/g, ' ').replace(/\s{2,}/g, ' '); // Clean title
                        const description = e.target.title;
                        showModal({ title: title, body: description, showConfirm: false, cancelText: 'Cerrar' });
                    }
                });

                dom.viewToggleKanban.addEventListener('click', () => {
                    if (!currentChatId) return;
                    const chat = state.chats[currentChatId];
                    if (!chat || !chat.projectData) return;
                    chat.projectData.currentView = 'kanban';
                     renderProjectBoard(currentChatId);
                });
                dom.viewToggleList.addEventListener('click', () => {
                    if (!currentChatId) return;
                    const chat = state.chats[currentChatId];
                    if (!chat || !chat.projectData) return;
                    chat.projectData.currentView = 'list';
                     renderProjectBoard(currentChatId);
                });
                 dom.addTaskListViewBtn.addEventListener('click', () => {
                    if (currentChatId) {
                        editProjectTask(currentChatId, null, 'todo');
                    }
                });

                document.body.addEventListener('click', e => {
                    const toggleAndContainer = [
                        { header: '#project-chat-container-header', container: dom.projectChatContainer },
                        { header: '#financial-chat-header', container: document.getElementById('financial-chat-container') },
                        { header: '#notepad-chat-header', container: dom.notepadChatContainer }
                    ];

                    toggleAndContainer.forEach(item => {
                        if (e.target.closest(item.header)) {
                             item.container?.classList.toggle('collapsed');
                        }
                    });
                });

                // NOTEPAD Event Listeners
                dom.addNewNoteBtn?.addEventListener('click', () => createNewNote('text'));
                dom.addNewDrawingBtn?.addEventListener('click', () => createNewNote('drawing'));
                dom.deleteNoteBtn?.addEventListener('click', () => deleteItem('note', currentNoteId));
                dom.shareNoteBtn?.addEventListener('click', shareNote);
                dom.noteBackBtn?.addEventListener('click', () => {
                    dom.notepadViewContainer.classList.remove('mobile-editor-active');
                });
                dom.noteTitleInput?.addEventListener('input', (e) => {
                    const note = state.notes.find(n => n.id === currentNoteId);
                    if (note && note.title !== e.target.value) {
                        note.title = e.target.value;
                        saveState();
                        renderSidebar();
                    }
                });
                dom.noteContentEditor?.addEventListener('input', () => {
                    const note = state.notes.find(n => n.id === currentNoteId);
                     if (note && note.type === 'text') {
                        note.content = dom.noteContentEditor.innerHTML;
                        saveState();
                    }
                });
                dom.noteContentEditor?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        const selection = window.getSelection();
                        const range = selection.getRangeAt(0);
                        const currentChecklistItem = range.startContainer.closest('.checklist-item');
                        if (currentChecklistItem) {
                            e.preventDefault();
                            applyTextFormat('insertHTML', '<div class="checklist-item"><input type="checkbox" class="checklist-item-checkbox"><span contenteditable="true" class="checklist-item-text"></span></div>');
                        }
                    }
                });

                // Text editor formatting buttons
                dom.boldBtn?.addEventListener('click', () => applyTextFormat('bold'));
                dom.italicBtn?.addEventListener('click', () => applyTextFormat('italic'));
                dom.underlineBtn?.addEventListener('click', () => applyTextFormat('underline'));
                dom.fontFamilySelector?.addEventListener('change', (e) => {
                    const selectedFont = e.target.value;
                    dom.noteContentEditor.style.fontFamily = selectedFont;
                    localStorage.setItem('notepad-font-family', selectedFont);
                    const note = state.notes.find(n => n.id === currentNoteId);
                    if (note && note.type === 'text') {
                        note.content = dom.noteContentEditor.innerHTML;
                        saveState();
                    }
                });


                dom.noteContentEditor?.addEventListener('mouseup', updateToolbarButtonStates);
                dom.noteContentEditor?.addEventListener('keyup', updateToolbarButtonStates);
                dom.noteContentEditor?.addEventListener('click', e => {
                    handleChecklistItem(e.target);
                    updateToolbarButtonStates();
                });
                dom.addChecklistItemBtn?.addEventListener('click', () => {
                    const selection = window.getSelection();
                    const range = selection.getRangeAt(0);
                    const currentContainer = selection.focusNode?.parentElement?.closest('#note-content-editor, .checklist-item-text');

                    if (!currentContainer) {
                        dom.noteContentEditor.innerHTML += `<div class="checklist-item"><input type="checkbox" class="checklist-item-checkbox"><span contenteditable="true" class="checklist-item-text"></span></div>`;
                        const newChecklistItem = dom.noteContentEditor.lastElementChild;
                        const newTextSpan = newChecklistItem.querySelector('.checklist-item-text');
                        if (newTextSpan) {
                            newTextSpan.focus();
                        }
                    } else {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = `<input type="checkbox" class="checklist-item-checkbox"><span contenteditable="true" class="checklist-item-text"></span>`;
                        const newChecklistItemContent = tempDiv.firstChild;
                        const newTextSpan = newChecklistItemContent.nextElementSibling;

                        if (currentContainer.classList.contains('checklist-item-text')) {
                            const parentChecklistItem = currentContainer.closest('.checklist-item');
                            const newChecklistItemWrapper = document.createElement('div');
                            newChecklistItemWrapper.className = 'checklist-item';
                            newChecklistItemWrapper.appendChild(newChecklistItemContent);
                            newChecklistItemWrapper.appendChild(newTextSpan);

                            parentChecklistItem.parentNode.insertBefore(newChecklistItemWrapper, parentChecklistItem.nextSibling);
                            newTextSpan.focus();
                        } else {
                            range.deleteContents();
                            const wrapper = document.createElement('div');
                            wrapper.className = 'checklist-item';
                            wrapper.appendChild(newChecklistItemContent);
                            wrapper.appendChild(newTextSpan);
                            range.insertNode(wrapper);
                            range.setStartAfter(wrapper);
                            range.setEndAfter(wrapper);
                            selection.removeAllRanges();
                            selection.addRange(range);
                            newTextSpan.focus();
                        }
                    }
                    const note = state.notes.find(n => n.id === currentNoteId);
                    if (note) {
                        note.content = dom.noteContentEditor.innerHTML;
                        saveState();
                    }
                });

                document.querySelectorAll('.plan-details-toggle').forEach(button => {
                    button.addEventListener('click', () => {
                        const details = button.nextElementSibling;
                        details.classList.toggle('open');
                    });
                 });

                setupModalClickOutside(dom.genericModal, ()=>hideModal({confirmed: false}));
                setupModalClickOutside(dom.pricingModal, hidePricingModal);
                setupModalClickOutside(dom.settingsModal, hideSettingsModal);
                setupModalClickOutside(dom.calendarModalOverlay, hideCalendarModal);
                setupModalClickOutside(dom.motivationModal, hideMotivationModal);
                setupModalClickOutside(dom.htmlPreviewModal, () => {
                    dom.htmlPreviewModal.classList.add('hidden');
                    dom.htmlPreviewModal.classList.remove('flex');
                });
                dom.gamificationBtn?.addEventListener('click', () => {
                    if(!currentUser) {
                        showInAppNotification("Funci√≥n Exclusiva", "La gamificaci√≥n est√° disponible para usuarios logueados.", 3000);
                        return;
                    }
                    renderGamificationModal();
                    dom.gamificationModal.classList.remove('hidden');
                    dom.gamificationModal.classList.add('flex');
                     setTimeout(() => dom.gamificationModal.querySelector('.modal-content').classList.remove('scale-95'), 10);
                });
                dom.closeGamificationModal?.addEventListener('click', () => {
                    dom.gamificationModal.querySelector('.modal-content').classList.add('scale-95');
                    setTimeout(() => { dom.gamificationModal.classList.add('hidden'); dom.gamificationModal.classList.remove('flex'); }, 300);
                });
                dom.gamificationModal.addEventListener('click', (e) => {
                    if (e.target === dom.gamificationModal) {
                        dom.closeGamificationModal.click();
                    }
                });

                dom.gamificationRulesBtn?.addEventListener('click', () => {
                    dom.gamificationRulesModal.classList.remove('hidden');
                    dom.gamificationRulesModal.classList.add('flex');
                });
                dom.closeGamificationRulesModal?.addEventListener('click', () => {
                    dom.gamificationRulesModal.classList.add('hidden');
                    dom.gamificationRulesModal.classList.remove('flex');
                });
                setupModalClickOutside(dom.gamificationRulesModal, () => {
                    dom.gamificationRulesModal.classList.add('hidden');
                    dom.gamificationRulesModal.classList.remove('flex');
                });
                dom.gamificationModal.querySelectorAll('.gamification-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const currentActive = dom.gamificationModal.querySelector('.gamification-tab.active');
                        if (currentActive) currentActive.classList.remove('active');
                        tab.classList.add('active');
                        dom.gamificationModal.querySelectorAll('.gamification-tab-content').forEach(content => content.classList.add('hidden'));
                         dom.gamificationModal.querySelector(`#gamification-tab-${tab.dataset.tab}`).classList.remove('hidden');
                    });
                });
                dom.missionsContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-mission-id]');
                    if (button && !button.disabled) {
                        const missionId = button.dataset.missionId;
                        const mission = MISSIONS[missionId];
                        if (mission && mission.workflow) {
                            const workflowButton = document.querySelector(`[data-workflow="${mission.workflow}"]`);
                            if(workflowButton) {
                                workflowButton.click();
                                dom.closeGamificationModal.click();
                            }
                        } else if (mission && mission.action === 'generateImage') {
                            generateImage();
                            dom.closeGamificationModal.click();
                        } else {
                            dom.closeGamificationModal.click();
                        }
                    }
                });
            }

            let initFired = false;
            const finishInitialization = (user) => {
                if (initFired) return;
                initFired = true;
                currentUser = user;

                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const chatIdFromUrl = urlParams.get('chat');

                    updateUserUI();
                    loadStateForUser().then(() => {
                        populateVoiceList();
                        setupEventListeners();
                        if (currentUser && notificationsEnabled) {
                             registerServiceWorkerAndSubscribe();
                        }
                        updateContextualFooter(null);
                        setupMotivationInterval();

                        dom.appContainer.classList.remove('opacity-0');
                        // FIX: Faster initial load by reducing timeout
                        setTimeout(() => {
                            dom.loadingOverlay.style.opacity = '0';
                            setTimeout(() => dom.loadingOverlay.style.display = 'none', 300);
                        }, 500);
                        
                        // FIX: Welcome motivation message
                        setTimeout(() => {
                            const lang = localStorage.getItem('goatify-lang') || 'es';
                            const welcomeMessages = [
                                "¬°Qu√© bueno verte! Vamos a crear algo incre√≠ble.",
                                "¬°Hola! Listo para transformar ideas en realidad.",
                                "¬°Bienvenido/a de nuevo! Tu pr√≥ximo gran proyecto te espera."
                            ];
                            const message = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
                            const title = `<i class="fas fa-hand-sparkles text-gold mr-2"></i> ${translations[lang].welcome_user} ${currentUser?.user_metadata?.full_name?.split(' ')[0] || ''}`;
                            showInAppNotification(title, message, 5000);
                        }, 2000);


                        if (chatIdFromUrl && (state.chats[chatIdFromUrl] || (state.notes || []).find(n => n.id === chatIdFromUrl))) {
                            selectChat(chatIdFromUrl);
                        } else if (currentChatId && (state.chats[currentChatId] || (state.notes || []).find(n => n.id === currentChatId))) {
                            selectChat(currentChatId);
                        } else if (state.structure.length > 0) { // If last used chat is invalid, try to select the first one
                             selectChat(state.structure[0]);
                        } else {
                            resetChatView(); // Fallback if no chats/notes at all
                        }

                        updateNotificationBadge();
                        if (currentUser && !localStorage.getItem('goatify-gamification-rules-seen')) {
                            setTimeout(() => {
                                dom.gamificationRulesModal.classList.remove('hidden');
                                dom.gamificationRulesModal.classList.add('flex');
                                localStorage.setItem('goatify-gamification-rules-seen', 'true');
                            }, 2000);
                        }
                    });
                } catch (e) {
                    console.error("Error during finishInitialization:", e);
                    dom.loadingOverlay.innerHTML = `<div class="text-red-500 text-center">Error al cargar la aplicaci√≥n.<br>Por favor, recarga la p√°gina.<br><small>${e.message}</small></div>`;
                }
            };

            const savedLang = localStorage.getItem('goatify-lang') || 'es';
            setLanguage(savedLang);
            setTheme(localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches));

            const unlockAudio = () => {
                const silence = new SpeechSynthesisUtterance('');
                silence.volume = 0;
                window.speechSynthesis.speak(silence);
                document.body.removeEventListener('touchstart', unlockAudio);
                document.body.removeEventListener('click', unlockAudio);
            };
            document.body.addEventListener('touchstart', unlockAudio, { once: true });
            document.body.addEventListener('click', unlockAudio, { once: true });

            if (window.netlifyIdentity) {
                netlifyIdentity.on('init', (user) => finishInitialization(user));
                netlifyIdentity.on('login', (user) => {
                    netlifyIdentity.close();
                    currentUser = user;
                    updateUserUI();
                    loadStateForUser();
                    if (notificationsEnabled) {
                         registerServiceWorkerAndSubscribe();
                    }
                });
                netlifyIdentity.on('logout', () => {
                    currentUser = null;
                    updateUserUI();
                    loadStateForUser();
                    resetChatView();
                });
                netlifyIdentity.on('error', (err) => {
                    console.error("Netlify Identity Error:", err);
                    if (!initFired) finishInitialization(null);
                });
            } else {
                 console.warn("Netlify Identity widget not found. Proceeding as guest.");
                 finishInitialization(null);
            }

            // FIX: Faster initial load timeout
            setTimeout(() => {
                if (!initFired) {
                    console.warn("Netlify Identity 'init' event did not fire within timeout. Forcing app initialization.");
                    finishInitialization(window.netlifyIdentity ? netlifyIdentity.currentUser() : null);
                 }
            }, 1500);
        });
        //<-- END OF SCRIPT -->
    </script>
</body>
</html>
