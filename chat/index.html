<!DOCTYPE html>
<html data-theme="light" lang="es">
<head>
<meta charset="utf-8"/>
<!-- 
  ============================================================================
  META TAGS DE VISTA Y RESPONSIVIDAD (¡IMPORTANTE!)
  ============================================================================
-->
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<title>Goatify IA — Suite de Negocios Responsiva</title>
<link rel="icon" href="Logos HD.png" type="image/png">

<!-- SEO Meta Tags -->
<meta content="Goatify IA es tu sistema operativo de negocios que se adapta a tu industria. Personaliza tu espacio de trabajo para marketing, e-commerce, y más." name="description"/>
<meta content="project management, crm, business os, collaboration, ai chat, cronopost, goatify ia, personalized workspace" name="keywords"/>
<meta content="Goatify" name="author"/>

<!-- Open Graph Meta Tags -->
<meta content="Goatify IA — Suite de Negocios Responsiva" property="og:title"/>
<meta content="website" property="og:type"/>
<meta content="La nueva era de la productividad. Goatify IA personaliza tus proyectos, tareas y herramientas según tu tipo de negocio desde el inicio." property="og:description"/>
<meta content="#f6f7fb" name="theme-color"/>

<!-- 
  ============================================================================
  LIBRERÍAS EXTERNAS (Iconos, PDF)
  ============================================================================
-->
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- 
  ============================================================================
  INICIO DE ESTILOS CSS (MODIFICADOS)
  ============================================================================
-->
<style>
  /* ----------------------------------------------------------------------------
  VARIABLES DE TEMA (ROOT)
  ----------------------------------------------------------------------------
  */
  :root{
    --bg:#0b0f19; --surface:#0f172a; --muted:#1e293b; --line:#334155;
    --text:#e2e8f0; --sub:#94a3b8; --brand:#a78bfa; --brand2:#8b5cf6; --accent:#38bdf8;
    --danger:#f87171; --warn:#fbbf24; --success:#22c55e; --info:#60a5fa;
    --shadow:0 20px 60px rgba(0,0,0,.45);
    --radius:10px; /* Redondez más sutil */
    --xs:10px; --sm:11.5px; --md:13px; --lg:15px; --xl:17px; /* Tipografía más fina */
    --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  [data-theme="light"]{
    --bg:#f8fafc; --surface:#ffffff; --muted:#f1f5f9; --line:#e9eef5; /* Línea más suave */
    --text:#0f172a; --sub:#64748b; --brand:#6d28d9; --brand2:#8b5cf6; --accent:#0ea5e9;
    --shadow:0 10px 25px rgba(15, 23, 42,.06); /* Sombra más suave */
  }
  
  /* ----------------------------------------------------------------------------
  ESTILOS GLOBALES Y RESET
  ----------------------------------------------------------------------------
  */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  
  *{
    box-sizing:border-box; 
    /* Transiciones fluidas */
    transition: background .2s ease, color .2s ease, border-color .2s ease, transform .2s ease, box-shadow .2s ease, width .2s ease, grid-template-columns .2s ease, opacity .2s ease, height .2s ease, flex-basis .2s ease;
  }
  html,body{
    height:100%;
  } 
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font: var(--md)/1.5 var(--font-sans); 
    overflow-x: hidden; /* Previene scroll horizontal */
  }
  a{
    color:var(--brand);
    text-decoration:none;
  }
  main {
    height: calc(100vh - 55px); /* Altura total menos el header */
    overflow-y: auto;
    overflow-x: hidden;
  }
  
  /* Scrollbars más finos y modernos */
  ::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }
  ::-webkit-scrollbar-track {
    background: transparent;
  }
  ::-webkit-scrollbar-thumb {
    background: var(--line);
    border-radius: 10px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: var(--muted);
  }

  /* ----------------------------------------------------------------------------
  LAYOUT PRINCIPAL (ASIDE, HEADER, CONTAINER)
  ----------------------------------------------------------------------------
  */
  .container{
    display:grid;
    /* Ancho por defecto del sidebar */
    grid-template-columns: 260px 1fr; 
    min-height:100%;
  }
  aside{
    border-right:1px solid var(--line);
    background:var(--surface);
    padding:10px 10px 20px 10px;
    position:relative;
    z-index:30; 
    display: flex; 
    flex-direction: column; 
    width: 100%; /* Ancho controlado por el grid */
    height: 100vh; /* Ocupa toda la altura */
    /* Evita que el contenido se encoja más allá de su mínimo */
    overflow: hidden; 
  }
  
  /* Contenedores internos del Aside */
  aside .aside-top-section {
    flex-shrink: 0; /* No se encoge */
    padding: 0 4px;
  }
  aside .aside-middle-section {
    /* Ocupa el espacio restante, base flexible */
    flex: 1 1 50%; 
    overflow-y: auto; /* Permite scroll */
    min-height: 150px; /* Altura mínima */
    margin: 10px 0;
    padding: 10px 0;
  }
  
  /* NUEVO: Separador redimensionable */
  #sidebar-resizer {
    flex-shrink: 0;
    height: 5px;
    cursor: ns-resize;
    background: transparent;
    border-top: 1px solid var(--line);
    border-bottom: 1px solid var(--line);
    margin: 5px 0;
  }
  #sidebar-resizer:hover {
    background: var(--muted);
  }

  aside .aside-bottom-section {
    flex-shrink: 0; /* No se encoge */
    /* Base flexible, pero no crecerá tanto como el de arriba */
    flex: 0 1 40%;
    overflow-y: auto;
    min-height: 150px;
  }

  header.app{
    position:sticky;
    top:0;
    z-index:40;
    background:color-mix(in hsl, var(--surface) 85%, transparent);
    backdrop-filter:blur(10px);
    border-bottom:1px solid var(--line);
    padding:8px 10px;
    display:flex;
    gap:10px;
    align-items:center;
    height: 55px; /* Altura fija para el header */
  }

  /* ----------------------------------------------------------------------------
  COMPONENTES DE UI BÁSICOS (Botones, Inputs, Chips, Badges)
  ----------------------------------------------------------------------------
  */
  .brand{
    display:flex;
    gap:8px;
    align-items:center;
    font-weight:700; /* Ligeramente menos pesado */
    font-size: var(--lg); 
    padding: 8px 0;
  }
  .brand-logo { 
    height: 26px; 
    width: auto; 
    flex-shrink: 0;
  }
  .badge{
    padding:2px 8px;
    border-radius:999px;
    background:linear-gradient(90deg,var(--brand),var(--brand2));
    color:#fff;
    font-size:var(--xs);
    font-weight: 600;
  }
  .btn{
    border-radius:var(--radius);
    border:1px solid var(--line);
    background:var(--surface);
    color:var(--text);
    padding:8px 12px;
    cursor:pointer;
    display:inline-flex;
    gap:6px; /* Gap más pequeño */
    align-items:center; 
    font-weight: 500; /* Peso estándar */
    white-space: nowrap;
    justify-content: center;
  }
  .btn:hover{
    transform:translateY(-1px); 
    border-color: color-mix(in hsl, var(--brand) 60%, transparent);
    box-shadow: 0 3px 10px rgba(0,0,0,.05);
  } 
  .btn:active{
    transform:none; 
    box-shadow: none;
    background: var(--muted);
  }
  .btn.btn-sm { 
    padding: 4px 8px; 
    font-size: var(--sm); 
    gap: 4px;
  }
  .btn-primary{
    border:none;
    background:linear-gradient(90deg,var(--brand),var(--brand2));
    color:#fff;
  }
  .btn-primary:hover {
    box-shadow: 0 4px 15px color-mix(in hsl, var(--brand) 30%, transparent);
    border: none;
  }
  .btn-ghost{
    background:transparent; 
    border-color: transparent; 
    box-shadow: none;
  }
  .btn-ghost:hover {
    background: var(--muted);
    border-color: var(--muted);
    transform: none;
    box-shadow: none;
  }
  .btn-ghost.active { 
    background: var(--muted); 
    color: var(--brand);
    font-weight: 600;
  }
  .chip{
    display:inline-flex;
    gap:6px;
    align-items:center;
    padding:4px 10px;
    border:1px solid transparent;
    border-radius:999px;
    background:var(--muted); 
    cursor: pointer;
    font-size: var(--sm);
  }
  .chip:hover { 
    border-color: var(--line);
    background: var(--surface);
  }
  input,select,textarea{
    border:1px solid var(--line);
    border-radius:8px; /* Ligeramente más cuadrado */
    background:var(--muted);
    color:var(--text);
    padding:8px 12px;
    outline:none; 
    width: 100%;
    box-sizing: border-box;
    font-family: var(--font-sans);
    font-size: var(--md);
  }
  input:focus, select:focus, textarea:focus { 
    border-color: var(--brand); 
    background: var(--surface); 
    box-shadow: 0 0 0 3px color-mix(in hsl, var(--brand) 20%, transparent); 
  }
  textarea { 
    resize: vertical; 
    min-height: 50px;
  }

  /* ----------------------------------------------------------------------------
  NAVEGACIÓN LATERAL (Aside) - ¡DISEÑO MODIFICADO!
  ----------------------------------------------------------------------------
  */
  .projList{
    display:flex;
    flex-direction:column;
    gap: 2px; /* Espaciado mínimo */
    padding: 0 4px; /* Padding para los items */
  }
  /* Estilo base para botones de nav y proyecto */
  .navBtn, .projItem { 
    display:flex;
    gap: 8px; /* Reducido */
    align-items:center;
    border:1px solid transparent;
    border-radius: 8px; /* Reducido */
    background:transparent;
    padding: 6px 8px; /* Reducido */
    cursor:pointer; 
    font-weight: 500; 
    font-size: var(--sm); /* Reducido */
    color: var(--sub); /* Color más suave por defecto */
    text-decoration: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .navBtn i, .projItem i {
    flex-shrink: 0;
    width: 16px; /* Iconos más pequeños */
    height: 16px;
  }
  .navBtn:hover, .projItem:hover {
    background:var(--muted);
    color: var(--text);
  }
  .navBtn.active {
    background: color-mix(in hsl, var(--brand) 10%, transparent); 
    color: var(--brand); 
    font-weight: 600;
  }
  
  /* Estilos específicos de Proyecto */
  .projItem .proj-text {
    flex-grow: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .projItem .proj-actions { 
    display: none; 
    margin-left: auto; 
    gap: 2px;
  }
  .projItem:hover .proj-actions { 
    display: flex; 
  }
  .projItem.active { 
    background: color-mix(in hsl, var(--brand) 10%, transparent); 
    font-weight: 600; 
    color: var(--brand);
  }
  .proj-color-dot { 
    width: 8px; /* Reducido */
    height: 8px; /* Reducido */
    border-radius: 50%; 
    flex-shrink: 0;
  }
  
  /* Cabecera de la lista de proyectos */
  .projList-header {
    padding: 0 10px 4px 10px;
    font-size: var(--sm);
    color: var(--sub);
  }
  .projList-header b {
    font-weight: 600;
    color: var(--text);
  }
  .projList-header .btn {
    padding: 2px 6px;
  }
  .projList-header .btn i {
    width: 14px;
    height: 14px;
  }

  /* Estilos para carpetas */
  .mj-folder-list {
    margin: 2px 0 6px 16px; /* Reducido y menos indentado */
    display: grid; 
    gap: 2px; /* Reducido */
    padding-left: 8px;
    border-left: 1px solid var(--line);
  }
  .mj-folder-row {
    display:flex;
    align-items:center;
    gap: 6px; /* Reducido */
    cursor:pointer;
    font-size: var(--sm); /* Reducido */
    padding: 4px 6px; /* Reducido */
    border-radius: 6px;
    color: var(--sub);
    text-decoration: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .mj-folder-row:hover {
    background: var(--muted);
    color: var(--text);
  }
  .mj-folder-row .dot {
    width: 6px; /* Reducido */
    height: 6px; /* Reducido */
    border-radius:50%;
    flex-shrink: 0;
  }
  .mj-folder-row .label {
    flex-grow: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .mj-folder-actions {
    display: none;
    gap: 2px;
    margin-left: auto;
  }
  .mj-folder-row:hover .mj-folder-actions {
    display: flex;
  }
  .mj-folder-actions .btn {
    padding: 2px;
  }
  .mj-folder-actions i {
    width: 14px;
    height: 14px;
  }

  /* NUEVO: Icono para plegar/desplegar proyecto */
  .projItem .proj-toggle {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    color: var(--sub);
  }
  .projItem .proj-toggle i {
    transition: transform 0.2s ease;
  }
  .projItem[data-collapsed="true"] .proj-toggle i {
    transform: rotate(-90deg);
  }
  .projItem[data-collapsed="true"] + .mj-folder-list {
    display: none;
  }


  /* ----------------------------------------------------------------------------
  ESTILOS DE PANELES Y CONTENIDO GENERAL
  ----------------------------------------------------------------------------
  */
  .panel{
    background:var(--surface);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    margin:10px;
    overflow:hidden; 
    animation: fadeIn .3s ease;
  }
  /* Contenedor de altura completa para vistas de chat */
  .panel.full-height-panel {
    height: calc(100vh - 75px); /* Altura total - header - márgenes */
    margin: 10px;
    display: flex;
    flex-direction: column;
  }

  @keyframes fadeIn { 
    from { opacity: 0; transform: translateY(10px); } 
    to { opacity: 1; transform: translateY(0); } 
  }
  .row{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .spacer{
    flex:1;
  }
  .section{
    padding:16px;
    border-top:1px solid var(--line);
  }
  .card{
    border:1px solid var(--line);
    border-radius:12px;
    background:var(--muted);
    padding:16px;
  }
  .overview-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
    gap: 16px; 
  }
  .stat-card { 
    background: var(--surface); 
    padding: 16px; 
    border-radius: var(--radius); 
    cursor: pointer;
    border: 1px solid var(--line);
  }
  .stat-card:hover { 
    transform: translateY(-2px); 
    box-shadow: var(--shadow); 
    border-color: var(--brand); 
  }
  .stat-card h4 { 
    margin: 0 0 8px 0; 
    color: var(--sub); 
    font-size: var(--sm);
    font-weight: 500;
  }
  .stat-card p { 
    margin: 0; 
    font-size: var(--xl); 
    font-weight: 600; 
  }
  .empty-state { 
    text-align: center; 
    padding: 40px; 
    color: var(--sub); 
  }
  .empty-state i { 
    margin-bottom: 12px; 
    width: 36px;
    height: 36px;
  }
  .table-wrapper { 
    overflow-x: auto; 
    -webkit-overflow-scrolling: touch; 
  }

  /* ----------------------------------------------------------------------------
  PESTAÑAS (TABS)
  ----------------------------------------------------------------------------
  */
  .tabs{
    display:flex;
    gap:6px;
    padding:10px; /* Reducido */
    border-bottom:1px solid var(--line); 
    flex-wrap: wrap;
  }
  .tab{
    all:unset;
    cursor:pointer;
    padding:6px 12px; /* Reducido */
    border:1px solid transparent;
    border-radius:8px;
    background:transparent; 
    font-weight: 500; 
    font-size: var(--sm);
    color: var(--sub);
    min-width: 80px; 
    text-align: center;
  }
  .tab:hover {
    background: var(--muted);
    color: var(--text);
  }
  .tab.active{
    background:var(--surface);
    color: var(--brand);
    font-weight: 600;
    border-color:var(--line);
    box-shadow: 0 1px 3px rgba(0,0,0,.03);
  }
  
  /* ----------------------------------------------------------------------------
  MÓDULO: TAREAS (KANBAN & LISTA)
  ----------------------------------------------------------------------------
  */
  .board{
    display:grid;
    grid-template-columns:repeat(4, 1fr);
    gap:10px;
    padding:10px;
    overflow-x: auto; /* Permite scroll horizontal si las columnas no caben */
    min-height: 220px;
  }
  .col{
    background:var(--muted);
    border:1px solid var(--line);
    border-radius:12px;
    min-height:220px;
    padding:8px;
    min-width: 250px; /* Ancho mínimo para columnas */
    display: flex; /* Para controlar el espacio interno */
    flex-direction: column; /* Apila header y contenido */
  }
  .col-header { /* Contenedor para el header de la columna */
     padding: 8px; 
     align-items: center;
     flex-shrink: 0;
     font-size: var(--sm);
     font-weight: 600;
  }
  .col-content { /* Contenedor para las tareas y espacio vacío */
      flex-grow: 1; /* Ocupa el espacio restante */
      min-height: 100px; /* Altura mínima para click */
      cursor: pointer; /* Indica que es clickeable */
  }
  .col .row b { 
    word-break: break-word; 
  }
  .col.dragover { 
    outline: 2px dashed var(--brand); 
    background: color-mix(in hsl, var(--brand) 10%, transparent); 
  }
  .task{
    background:var(--surface);
    border:1px solid var(--line);
    border-radius:10px;
    padding:10px; /* Reducido */
    margin:8px 4px;
    cursor:grab;
    box-shadow:var(--shadow);
    font-size: var(--sm);
  }
  .task:active {
    cursor: grabbing;
  }
  
  /* NUEVO: Tags de Tareas */
  .task-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 8px;
  }
  .task-tag {
    font-size: 10px;
    font-weight: 500;
    padding: 2px 6px;
    border-radius: 6px;
    background: var(--muted);
    color: var(--sub);
  }

  #task-list-table th { 
    text-align: left; 
    padding: 8px; 
    color: var(--sub); 
    border-bottom: 2px solid var(--line); 
    font-size: var(--sm); 
    font-weight: 500;
  }
  #task-list-table td { 
    padding: 10px 8px; /* Más espacio vertical */
    border-bottom: 1px solid var(--line);
    font-size: var(--sm);
  }
  #task-list-table tbody tr { 
    cursor: pointer; 
  }
  #task-list-table tbody tr:hover { 
    background: var(--muted); 
  }
  .status-badge { 
    padding: 3px 8px; 
    border-radius: 999px; 
    font-size: var(--xs); 
    font-weight: 600; 
    text-transform: uppercase; 
  }
  
  /* ----------------------------------------------------------------------------
  MÓDULO: CALENDARIOS (PROYECTO Y CRONOPOST)
  ----------------------------------------------------------------------------
  */
  #cpCalendarContainer { 
    background: var(--surface); 
    border-radius: var(--radius); 
    padding: 10px; 
    border: 1px solid var(--line); 
  }
  .calendar { 
    display: grid; 
    grid-template-columns: repeat(7, 1fr); 
    gap: 6px; 
  }
  .day { 
    min-height: 140px; 
    border: 1px solid var(--line); 
    border-radius: 10px; 
    background: var(--surface); 
    padding: 6px; 
    display: flex; 
    flex-direction: column; 
    gap: 4px; 
    cursor: pointer; 
    transition: background 0.2s ease;
  }
  .day:hover { 
    background: var(--muted); 
  }
  .day.dragover { /* CORRECCIÓN D&D: Estilo para drop */
    outline: 2px dashed var(--brand); 
    background: color-mix(in hsl, var(--brand) 10%, transparent);
  }
  .cp-post, .cal-task { 
    font-size: 11px; /* Reducido */
    background: var(--surface); 
    border-radius: 6px; /* Reducido */
    padding: 4px 6px; 
    cursor: grab; 
    box-shadow: 0 2px 4px rgba(0,0,0,.05); 
    border: 1px solid var(--line);
    border-left: 3px solid; 
    margin-bottom: 4px; 
    font-weight: 500;
  }
  .cal-task:active {
    cursor: grabbing;
  }

  /* ----------------------------------------------------------------------------
  MÓDULO: HUB PROFESIONAL
  ----------------------------------------------------------------------------
  */
  .profile-card .profile-header { 
    height: 100px; 
    background: var(--surface); 
    border-radius: var(--radius) var(--radius) 0 0; 
    transition: background .3s ease; 
  }
  .profile-card .avatar { 
    width: 100px; 
    height: 100px; 
    border-radius: 50%; 
    object-fit: cover; 
    border: 4px solid var(--surface); 
    box-shadow: 0 0 10px rgba(0,0,0,0.1); 
    margin: -50px auto 10px; 
    cursor: pointer; 
  }
  
  /* ----------------------------------------------------------------------------
  MÓDULO: NOTAS Y LIENZO
  ----------------------------------------------------------------------------
  */
  .note-editor-wrapper { 
    display: grid; 
    grid-template-columns: 1fr 300px; 
    gap: 10px; 
    align-items: start;
  }
  #noteEditor { 
    min-height: 60vh; 
    max-height: 60vh; 
    background: var(--surface); 
    border-radius: var(--radius); 
    border: 1px solid var(--line); 
    padding: 12px; 
    overflow-y: auto; 
    outline: none;
  }
  #noteEditor:focus {
    border-color: var(--brand); 
    box-shadow: 0 0 0 3px color-mix(in hsl, var(--brand) 20%, transparent); 
  }
  #drawingCanvas { 
    border: 1px solid var(--line); 
    border-radius: var(--radius); 
    cursor: crosshair; 
    width:100%; 
    height:auto; 
    aspect-ratio: 250 / 180; 
  }
  
  /* ----------------------------------------------------------------------------
  MÓDULO: CHAT IA & CHAT GLOBAL
  ----------------------------------------------------------------------------
  */
  .gchat-grid { /* Layout para grids de chat */
    display: grid; 
    gap: 10px; 
    grid-template-columns: 260px 1fr; 
    padding: 10px; 
    height: 100%; /* Ocupa el 100% del panel padre */
    box-sizing: border-box;
  }
  #p-tab-chat .gchat-grid { 
    height: calc(100vh - 140px); /* Ajuste para header + tabs */
  }
  #ai-global-chat .gchat-grid {
    height: 100%; /* El panel padre .full-height-panel le da altura */
  }

  /* Contenedor de lista de chat */
  .gchat-grid > .card:first-child {
    display:flex; 
    flex-direction: column; 
    overflow-y: auto;
    max-height: 100%;
    background: var(--muted);
    padding: 8px;
  }
  /* Contenedor de log de chat */
  .gchat-grid > .card:last-child {
    display:flex; 
    flex-direction:column; 
    height: 100%;
    overflow: hidden; /* Previene desbordamiento */
    padding: 8px;
  }

  .chat-log { 
    display: flex; 
    flex-direction: column; 
    overflow-y: auto; 
    overflow-x: hidden; 
    border-radius: var(--radius); 
    padding: 10px; 
    background: var(--muted); 
    flex: 1; /* Crece para ocupar espacio */
    min-height: 0; /* Permite encogerse */
  }
  .chat-log .msg { 
    display: flex; 
    gap: 10px; 
    margin-bottom: 12px; 
    max-width: 85%; 
    align-items: flex-end; 
  }
  .chat-log .msg.mine { 
    align-self: flex-end; 
    flex-direction: row-reverse; 
  }
  .chat-log .msg-avatar { 
    width: 32px; /* Reducido */
    height: 32px; /* Reducido */
    border-radius: 50%; 
    object-fit: cover; 
    flex-shrink: 0; 
    background: var(--surface); 
    padding: 2px;
  }
  .chat-log .msg-content { 
    display: flex; 
    flex-direction: column; 
  }
  .chat-log .msg-who { 
    font-size: var(--sm); 
    font-weight: 600; 
    margin-bottom: 4px; 
    color: var(--sub); 
  }
  .chat-log .msg-body { 
    background: var(--surface); 
    padding: 8px 12px; 
    border-radius: 12px; 
    word-break: break-word; 
    font-size: var(--sm);
    line-height: 1.6;
    box-shadow: 0 2px 5px rgba(0,0,0,.04);
  }
  .chat-log .msg.mine .msg-content { 
    align-items: flex-end; 
  }
  .chat-log .msg.mine .msg-body { 
    background: var(--brand); 
    color: #fff; 
  }
  .chat-input-area { 
    align-items: flex-end; 
    border-top: 1px solid var(--line); 
    padding-top: 10px; 
    flex-shrink: 0; /* No se encoge */
  }
  .chat-input-area textarea { 
    resize: none; 
    max-height: 150px; 
    background: var(--surface);
    border: none;
    box-shadow: none;
    padding-left: 0;
  }
  .chat-input-area textarea:focus {
    box-shadow: none;
    border: none;
  }

  /* Selector de Modelo IA */
  .model-selector { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
    gap: 8px; 
    padding-bottom: 8px; 
    margin-bottom: 8px; 
    flex-shrink: 0; 
  }
  .model-card { 
    border: 1px solid var(--line); 
    border-radius: var(--radius); 
    padding: 8px; 
    cursor: pointer; 
    background: var(--surface); 
    text-align: center; 
  }
  .model-card:not(.disabled):hover { 
    border-color: var(--brand); 
  }
  .model-card.active { 
    border-color: var(--brand); 
    background: color-mix(in hsl, var(--brand) 10%, transparent); 
    box-shadow: 0 0 0 2px var(--brand); 
  }
  .model-card.disabled { 
    opacity: 0.5; 
    cursor: not-allowed; 
    background: var(--muted); 
  }
  .model-card h5 { 
    margin: 0 0 4px; 
    font-size: var(--sm); 
    white-space: nowrap; 
    font-weight: 600;
  }
  .model-card p { 
    margin: 0; 
    font-size: var(--xs); 
    color: var(--sub); 
    line-height: 1.3; 
  }

  /* Bloques de Código en Chat */
  .code-block { 
    border: 1px solid var(--line); 
    border-radius: var(--radius); 
    margin: 8px 0; 
    background: var(--bg); /* Fondo oscuro para código */
  }
  .code-header { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    padding: 4px 8px; 
    background: color-mix(in hsl, var(--surface) 20%, var(--bg)); 
    border-bottom: 1px solid var(--line); 
    font-size: var(--sm); 
  }
  .code-block pre { 
    margin: 0; 
    padding: 12px; 
    overflow-x: auto; 
    background-color: transparent; 
    border-radius: 0 0 var(--radius) var(--radius); 
    font-size: 12px;
  }
  .code-preview-container { 
    border-top: 1px solid var(--line); 
    padding: 8px; 
  }
  .code-preview-container iframe { 
    width: 100%; 
    height: 200px; 
    border: 1px solid var(--line); 
    border-radius: 8px; 
    background: white; 
  }
  
  /* ----------------------------------------------------------------------------
  MÓDULO: BOLSA DE EMPLEO
  ----------------------------------------------------------------------------
  */
  .job-card { 
    background: var(--surface); 
    border: 1px solid var(--line); 
    border-left: 4px solid var(--accent); 
    border-radius: 12px; 
    padding: 16px; 
    margin-bottom: 10px; 
    cursor: pointer; 
  }
  .job-card:hover { 
    border-color: var(--accent); 
    box-shadow: var(--shadow); 
    transform: translateY(-2px); 
  }
  .job-card .job-title { 
    font-weight: 600; /* Reducido */
    font-size: var(--lg); 
  }
  .job-card .job-company { 
    color: var(--sub); 
    font-size: var(--sm);
  }
  .job-card-details { 
    display: none; 
    margin-top: 16px; 
    border-top: 1px solid var(--line); 
    padding-top: 16px; 
    white-space: pre-wrap; 
  }
  
  /* ----------------------------------------------------------------------------
  MÓDULO: ASISTENTE DE MONETIZACIÓN
  ----------------------------------------------------------------------------
  */
  .monet-card { 
    background: var(--surface); 
    border: 1px solid var(--line); 
    border-radius: var(--radius); 
    padding: 20px; 
    text-align: center; 
    cursor: pointer; 
    transition: transform .2s, box-shadow .2s; 
  }
  .monet-card:hover { 
    transform: translateY(-5px); 
    box-shadow: var(--shadow); 
    border-color: var(--brand); 
  }
  .monet-card i { 
    color: var(--brand); 
  }
  .monet-card h4 { 
    margin: 10px 0 5px 0; 
  }
  .monet-card p { 
    font-size: var(--sm); 
    color: var(--sub); 
    margin: 0; 
  }
  #monetModuleModal h4 { 
    color: var(--brand2); 
    margin-top: 1.5em; 
    margin-bottom: 0.5em; 
  }
  #monetModuleModal ul { 
    padding-left: 20px; 
  }
  #monetModuleModal .tip { 
    background: color-mix(in hsl, var(--warn) 15%, transparent); 
    border-left: 3px solid var(--warn); 
    padding: 12px; 
    margin: 1em 0; 
    border-radius: 8px;
  }
  
  /* ----------------------------------------------------------------------------
  MÓDULO: MINDSET
  ----------------------------------------------------------------------------
  */
  #breathing-circle-container { 
    position: relative; 
    width: 150px; 
    height: 150px; 
    margin: 20px auto; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
  }
  #breathing-circle { 
    width: 100%; 
    height: 100%; 
    border-radius: 50%; 
    background: var(--brand); 
    animation: breathe 8s ease-in-out infinite; 
  }
  #breathing-text { 
    position: absolute; 
    color: white; 
    font-weight: 600; 
    animation: breathe-text 8s ease-in-out infinite;
  }
  @keyframes breathe { 
    0%, 100% { transform: scale(0.6); opacity: 0.7; } 
    50% { transform: scale(1); opacity: 1; } 
  }
  @keyframes breathe-text { 
    0%, 100% { content: "Inhala..."; } 
    50% { content: "Exhala..."; } 
  }
  
  /* ----------------------------------------------------------------------------
  MODALES Y TOASTS
  ----------------------------------------------------------------------------
  */
  dialog { 
    border: 1px solid var(--line); 
    border-radius: var(--radius); 
    box-shadow: var(--shadow); 
    max-width: 600px; 
    padding: 0; 
    overflow: hidden; 
    background: var(--surface);
    color: var(--text);
  }
  dialog[open] { 
    animation: fadeIn .2s ease; 
  }
  dialog::backdrop { 
    background: rgba(0,0,0,.5); 
    backdrop-filter: blur(4px); 
  }
  #toast { 
    position: fixed; 
    bottom: -100px; 
    left: 50%; 
    transform: translateX(-50%); 
    padding: 12px 20px; 
    border-radius: 999px; 
    z-index: 100; 
    font-weight: 600; 
    font-size: var(--sm);
    box-shadow: var(--shadow); 
    opacity: 0; 
    transition: opacity .3s, bottom .3s;
    background: var(--bg);
    border: 1px solid var(--line);
    color: var(--text);
  }
  #toast.info { border-left: 4px solid var(--info); }
  #toast.success { border-left: 4px solid var(--success); }
  #toast.warn { border-left: 4px solid var(--warn); }
  #toast.danger { border-left: 4px solid var(--danger); }
  #toast.show { 
    opacity: 1; 
    bottom: 30px; 
  }
  
  /* ----------------------------------------------------------------------------
  LAYOUTS DE GRID ESPECÍFICOS
  ----------------------------------------------------------------------------
  */
  .hub-grid, #cronopost-grid { 
    display: grid; 
    gap: 10px; 
  }
  .hub-grid { 
    grid-template-columns: 360px 1fr; 
  }
  #cronopost-grid { 
    grid-template-columns: 1fr 320px; 
    padding: 10px; 
  }
  #cpMonthLbl { 
    min-width: 150px; 
    justify-content: center; 
  }

  /* ----------------------------------------------------------------------------
  ASIDE COLAPSABLE (Desktop) - ¡LÓGICA ACTUALIZADA!
  ----------------------------------------------------------------------------
  */
  
  /* 1. ESTADO COLAPSADO */
  body.aside-collapsed .container { 
    grid-template-columns: 74px 1fr; 
  }
  body.aside-collapsed aside { 
    width: 74px; 
    align-items: center; /* Centra todo */
    padding: 10px 0;
  }
  
  /* 2. ELIMINADO EL :hover PARA EXPANDIR */
  /* body.aside-collapsed aside:hover { ... } <== ¡ELIMINADO! */

  /* 3. Transiciones (se mantienen para el toggle) */
  body.aside-collapsed aside .brand span, 
  body.aside-collapsed aside .projItem > .proj-text, 
  body.aside-collapsed aside .navBtn > span {
    transition: opacity .1s, transform .1s, width .1s; 
  }
  
  /* 4. Ocultar texto y elementos extra cuando está colapsado */
  body.aside-collapsed aside .brand span,
  body.aside-collapsed aside .navBtn > span,
  body.aside-collapsed aside .projItem > .proj-text, /* Target específico */
  body.aside-collapsed aside .projItem > .proj-toggle, /* Icono de plegar */
  body.aside-collapsed aside .projItem > .proj-actions, /* Acciones */
  body.aside-collapsed aside .projList-header,
  body.aside-collapsed aside .search input,
  body.aside-collapsed aside .mj-folder-list,
  body.aside-collapsed aside #sidebar-resizer /* Oculta resizer */
  { 
    opacity: 0; 
    pointer-events: none; 
    width: 0;
    transform: translateX(-10px);
    display: none; /* Asegura que no ocupe espacio */
  }
  
  /* 5. Ajustar logo y botones de íconos */
  body.aside-collapsed aside .aside-top-section .brand {
    justify-content: center;
  }
  body.aside-collapsed aside .brand-logo {
    margin: 8px 0; /* Espacio para el logo centrado */
  }
  body.aside-collapsed aside .navBtn,
  body.aside-collapsed aside .projItem { 
    justify-content: center; 
    padding: 10px;
    width: 54px; /* Ancho fijo para centrar */
  }
  body.aside-collapsed aside .proj-color-dot {
    margin: 0;
    width: 12px; /* Más grande para ser visible */
    height: 12px;
  }
  body.aside-collapsed aside .search { 
    padding: 0; 
  }
  body.aside-collapsed aside .aside-middle-section,
  body.aside-collapsed aside .aside-bottom-section {
    padding: 10px 4px; /* Menos padding lateral */
    align-items: center;
  }
  body.aside-collapsed aside .projList {
    align-items: center;
  }

  /* ----------------------------------------------------------------------------
  MENÚ MÓVIL (Overlay y Dropdown)
  ----------------------------------------------------------------------------
  */
  #menu-overlay { 
    position: fixed; 
    inset: 0; 
    background: rgba(0,0,0,0.4); 
    z-index: 98; 
    display: none; 
    transition: opacity .3s ease; 
    opacity: 0; 
  }
  body.aside-open #menu-overlay { 
    display: block; 
    opacity: 1; 
  }
  
  .header-desktop-actions { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
  }
  .header-mobile-actions { 
    display: none; 
    align-items: center; 
    gap: 6px; 
  }
  .dropdown-container { 
    position: relative; 
  }
  .dropdown-menu { 
    display: none; 
    position: absolute; 
    top: calc(100% + 8px); 
    right: 0; 
    background: var(--surface); 
    border: 1px solid var(--line); 
    border-radius: var(--radius); 
    box-shadow: var(--shadow); 
    width: 220px; 
    z-index: 50; 
    padding: 6px; 
    flex-direction: column; 
    gap: 4px; 
    animation: fadeIn .15s ease-out; 
  }
  .dropdown-menu.active { 
    display: flex; 
  }
  .dropdown-item { 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    padding: 10px 12px; 
    border-radius: 10px; 
    color: var(--text); 
    font-weight: 500; 
    font-size: var(--md); 
    cursor: pointer; 
  }
  .dropdown-item:hover { 
    background: var(--muted); 
  }
  .dropdown-item i { 
    color: var(--sub); 
  }

  /* ============================================================================
  INICIO DE MEDIA QUERIES (ESTILOS RESPONSIVOS)
  ============================================================================
  */
  
  /* ----------------------------------------------------------------------------
  TABLET Y MÓVIL (Hasta 1180px) - Comportamiento del ASIDE
  ----------------------------------------------------------------------------
  */
  @media (max-width: 1180px){
    /* En móvil, el colapso es siempre un overlay */
    body.aside-collapsed .container { 
      grid-template-columns: 1fr; 
    }
    body.aside-collapsed aside { 
      /* Vuelve a su ancho normal para el overlay */
      width: 300px; 
      transform: translateX(-101%);
      align-items: stretch; /* Revertir centrado */
      padding: 10px 10px 20px 10px;
    }
    
    /* Mostrar el menú overlay */
    body.aside-open aside { 
      transform: translateX(0); 
      height: 100vh; /* Asegurar altura completa */
      box-shadow: var(--shadow);
    }
    
    .container{ 
      grid-template-columns: 1fr; 
    }
    aside{ 
      position: fixed; 
      inset: 0; 
      transform: translateX(-101%); 
      transition: transform .3s ease-in-out; 
      z-index: 99; 
      background: var(--surface); 
      width: 300px; 
      height: 100vh; /* Asegurar altura completa */
    }
    body.aside-open { 
      overflow: hidden; 
    }
    
    /* Revertir todos los estilos de colapsado a la normalidad en móvil */
    body.aside-collapsed aside .brand span, 
    body.aside-collapsed aside .navBtn > span, 
    body.aside-collapsed aside .projItem > .proj-text,
    body.aside-collapsed aside .projItem > .proj-toggle,
    body.aside-collapsed aside .projItem > .proj-actions,
    body.aside-collapsed aside .projList-header, 
    body.aside-collapsed aside .search input,
    body.aside-collapsed aside .mj-folder-list,
    body.aside-collapsed aside #sidebar-resizer { 
      opacity: 1; 
      pointer-events: auto;
      width: auto;
      transform: translateX(0);
      display: flex; /* O el display original */
    }
    
    /* Revertir display:none a su estado original */
    body.aside-collapsed aside .brand span,
    body.aside-collapsed aside .navBtn > span,
    body.aside-collapsed aside .projItem > .proj-text,
    body.aside-collapsed aside .projItem > .proj-toggle,
    body.aside-collapsed aside .projList-header,
    body.aside-collapsed aside .search input,
    body.aside-collapsed aside #sidebar-resizer {
        display: block; /* O flex, etc. */
    }
    body.aside-collapsed aside .projItem > .proj-actions,
    body.aside-collapsed aside .mj-folder-list {
        display: grid; /* O flex, etc. */
    }
    /* ...y para .projItem:hover .proj-actions */
    body.aside-collapsed aside .projItem:hover .proj-actions {
        display: flex;
    }

    body.aside-collapsed aside .navBtn,
    body.aside-collapsed aside .projItem { 
      justify-content: flex-start; /* Revertir justificado */
      width: auto; /* Ancho automático */
    }
    body.aside-collapsed aside .aside-top-section .brand {
        justify-content: flex-start;
    }
    body.aside-collapsed aside .search {
        padding: 0;
    }
    body.aside-collapsed aside .proj-color-dot {
        width: 8px; /* Tamaño pequeño original */
        height: 8px;
    }
    body.aside-collapsed aside .aside-middle-section,
    body.aside-collapsed aside .aside-bottom-section {
      padding: 10px 0;
      align-items: stretch;
    }
    body.aside-collapsed aside .projList {
      align-items: stretch;
    }

    /* Ocultar el resizer en móvil */
    #sidebar-resizer {
      display: none;
    }
    /* Asegurar que las secciones tomen altura en móvil */
    aside .aside-middle-section {
      height: 50%;
    }
    aside .aside-bottom-section {
      height: auto; /* Crece según necesidad */
      flex: 1 1 auto;
      overflow-y: auto;
    }

  }
  
  /* ----------------------------------------------------------------------------
  MÓVIL (Hasta 768px) - Layouts principales y chats
  ----------------------------------------------------------------------------
  */
  @media (max-width: 768px) {
    .header-desktop-actions { 
      display: none; 
    }
    .header-mobile-actions { 
      display: flex; 
    }
    
    /* Layouts de Grids a 1 Columna */
    .hub-grid, .note-editor-wrapper, #cronopost-grid { 
      grid-template-columns: 1fr; 
    }
    
    /* --------------------------------------------------------------------------
    MEJORA DE CHAT MÓVIL
    --------------------------------------------------------------------------
    */
    .panel.full-height-panel {
        height: calc(100vh - 63px); /* header - margen */
        margin: 8px;
    }
    #p-tab-chat {
        /* El panel de tabs ya no tiene altura fija, el grid la controla */
        height: auto; 
        padding: 0;
    }
    #p-tab-chat .gchat-grid {
      /* Ajuste para header + tabs de proyecto + margen */
      height: calc(100vh - 55px - 60px - 16px); 
      padding: 8px;
    }
    
    .gchat-grid {
        display: flex; /* CAMBIO: de grid a flex */
        flex-direction: column; /* Stack vertical */
        height: 100%; /* Ocupa el 100% del panel padre */
        max-height: none;
        padding: 8px;
        gap: 8px;
    }
    /* Lista de chats (Primer card) */
    .gchat-grid > .card:first-child {
        flex-shrink: 0; /* No se encoge */
        max-height: 180px; /* Altura máxima */
        overflow-y: auto;
    }
    /* Contenedor de chat (Segundo card) */
    .gchat-grid > .card:last-child {
        flex-grow: 1; /* Ocupa el espacio restante */
        min-height: 0; /* Permite encogerse */
        overflow: hidden; /* Previene desbordamiento del card */
    }
    /* El log de chat */
    .gchat-grid > .card:last-child .chat-log {
        flex-grow: 1; /* Ocupa espacio en el card */
        min-height: 0;
    }
    /* El área de input */
    .gchat-grid > .card:last-child .chat-input-area {
        flex-shrink: 0; /* No se encoge */
    }
    
    /* AJUSTE MODEL CARDS (Puntos 4 y 6) */
    .model-selector { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); 
      gap: 6px; 
      overflow-x: visible; 
      padding-bottom: 6px;
      margin-bottom: 6px;
    }
    .model-selector .model-card { 
      min-width: 0; 
      padding: 6px; 
      flex-basis: auto;
    }
    .model-card h5 { 
      font-size: 11px; 
      margin-bottom: 2px; 
    }
    .model-card p { 
      font-size: 10px; 
      line-height: 1.2; 
    }
    /* ----------------------------------------------------------------------- */

    .board { 
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Columnas más anchas en móvil */
      gap: 8px; 
      padding: 10px; 
    }
    .col { 
      padding: 6px; 
      min-height: 160px; 
    }
    .task { 
      padding: 8px; 
      font-size: var(--sm); 
      margin: 4px 2px; 
    }
    
    /* Mejoras en Tablas Móviles */
    .table-wrapper { 
      /* overflow-x: auto; */ /* Ya estaba, pero aseguramos */
    }
    #finTable, #task-list-table { 
      min-width: 100%; 
      width: 100%; 
      /* table-layout: fixed; */ /* Quitado para que se ajuste al contenido */
      font-size: var(--sm); 
    }
    #finTable td, #finTable th, 
    #task-list-table td, #task-list-table th { 
      padding: 8px 4px; 
      white-space: nowrap; /* Evita saltos de línea feos */
    }
    #finTable th:nth-child(3), #finTable td:nth-child(3) { 
      text-align: right; 
    }
    #finTable th:last-child, #finTable td:last-child, 
    #task-list-table th:last-child, #task-list-table td:last-child { 
      width: 40px; 
      white-space: normal;
    }
    #task-list-table th:nth-child(3), #task-list-table td:nth-child(3) { 
      text-align: center; 
    }
    
    /* Ajustes Generales Móvil */
    .panel { 
      margin: 8px; 
    }
    .tabs { 
      padding: 8px; 
    }
    .tab { 
      padding: 6px 12px; 
      font-size: var(--sm); 
    }
    #project-header-right { 
      flex-wrap: wrap; 
      justify-content: flex-end; 
      gap: 4px; 
    }
    dialog { 
      width: calc(100vw - 30px); 
      max-width: 95%; 
    }
    #p-tab-finance .overview-grid { 
      grid-template-columns: 1fr 1fr; 
      gap: 8px;
    }
    #p-tab-finance .stat-card p { 
      font-size: var(--lg); 
    }
    .stat-card { 
      padding: 12px; 
    }
    .day { 
      min-height: 100px; 
    }
    #cpMonthLbl { 
      min-width: 100px; 
    }
  }
  
  /* ----------------------------------------------------------------------------
  MÓVIL PEQUEÑO (Hasta 480px) - Ajustes finos
  ----------------------------------------------------------------------------
  */
  @media (max-width: 480px) {
      body { 
        font-size: var(--sm); 
      }
      .stat-card p { 
        font-size: var(--lg); 
      }
      .brand { 
        font-size: var(--md); 
      }
      .row { 
        gap: 6px; 
      }
      #p-tab-finance .overview-grid { 
        grid-template-columns: 1fr; /* 1 columna en móvil pequeño */
      }
  }
</style>
</head>
<body class="aside-collapsed"> <!-- Inicia colapsado por defecto en desktop -->

<!-- 
============================================================================
HEADER DE LA APLICACIÓN
============================================================================
-->
<header class="app">
<!-- Este botón ahora controla el colapso en desktop Y el overlay en móvil -->
<button class="btn btn-ghost" id="menuBtn"><i data-lucide="menu"></i></button>
<div class="brand">
    <img src="Logos HD.png" alt="Goatify Logo" class="brand-logo">
    Goatify <span style="color:var(--brand)">IA</span>
</div>
<div class="spacer"></div>

<!-- Acciones de Header para Desktop -->
<div class="header-desktop-actions">
    <div class="chip" id="walletChip" title="Ver Billetera"><i data-lucide="wallet"></i> <span id="wallet-amount">$0</span></div>
    <div class="chip" id="intisChip" title="Tus Intis (puntos de gamificación)"><i data-lucide="sparkles"></i> <span id="intis-amount">0</span></div>
    <button class="btn btn-ghost" id="themeBtn" title="Cambiar Tema"><i data-lucide="sun"></i></button>
    <button class="btn btn-ghost" id="tourBtn" title="Iniciar Tour"><i data-lucide="help-circle"></i></button>
</div>

<!-- Acciones de Header para Móvil (Dropdown) -->
<div class="header-mobile-actions">
    <div class="dropdown-container">
        <button class="btn btn-ghost" id="mobileMoreBtn"><i data-lucide="more-vertical"></i></button>
        <div class="dropdown-menu" id="mobileDropdown">
            <div id="mobileWalletBtn" class="dropdown-item"><i data-lucide="wallet"></i><span>Billetera</span></div>
            <div id="mobileIntisBtn" class="dropdown-item"><i data-lucide="sparkles"></i><span>Intis</span></div>
            <div id="mobileThemeBtn" class="dropdown-item"><i data-lucide="sun"></i><span>Tema</span></div>
            <div id="mobileTourBtn" class="dropdown-item"><i data-lucide="help-circle"></i><span>Tour</span></div>
        </div>
    </div>
</div>
</header>

<!-- 
============================================================================
CONTENEDOR PRINCIPAL (Aside y Main)
============================================================================
-->
<div class="container">
<!-- 
----------------------------------------------------------------------------
BARRA LATERAL (ASIDE) - ¡ESTRUCTURA ACTUALIZADA!
----------------------------------------------------------------------------
-->
<aside>
<!-- Sección Superior: Logo y Búsqueda -->
<div class="aside-top-section">
    <div class="brand">
        <img src="Logos HD.png" alt="Goatify Logo" class="brand-logo">
        <span>Goatify <span style="color:var(--brand)">IA</span></span>
    </div>
    <div class="search" style="margin: 10px 0;"><input id="q" placeholder="Buscar en todo…"/></div>
</div>

<!-- Sección Media: Proyectos (Scrollable) -->
<div class="aside-middle-section">
    <div class="projList-header row"><b>Proyectos</b><span class="spacer"></span><button class="btn btn-sm" id="newProject"><i data-lucide="plus"></i> Nuevo</button></div>
    <div class="projList" id="projList" style="margin-top: 10px;">
        <!-- Los proyectos y carpetas se renderizan aquí -->
    </div>
</div>

<!-- NUEVO: Separador Redimensionable -->
<div id="sidebar-resizer" title="Ajustar tamaño"></div>

<!-- Sección Inferior: Navegación Global -->
<div class="aside-bottom-section">
    <div id="nav-list" class="projList" style="padding-top: 5px;">
        <a class="navBtn" data-nav="ai-global-chat" href="#!ai-global-chat"><i data-lucide="bot"></i> <span>Asistente IA Global</span></a>
        <a class="navBtn" data-nav="cronopost" href="#!cronopost"><i data-lucide="calendar-days"></i> <span>Calendario General</span></a>
        <a class="navBtn" data-nav="hub" href="#!hub"><i data-lucide="globe-2"></i> <span>Hub Profesional</span></a>
        <a class="navBtn" data-nav="gchat" href="#!gchat"><i data-lucide="messages-square"></i> <span>Chat Global</span></a>
        <a class="navBtn" data-nav="monet" href="#!monet"><i data-lucide="dollar-sign"></i> <span>Asistente de Monetización</span></a>
        <a class="navBtn" data-nav="mindset" href="#!mindset"><i data-lucide="brain-circuit"></i> <span>Bienestar y Mindset</span></a>
        <a class="navBtn" data-nav="settings" href="#!settings"><i data-lucide="settings"></i> <span>Ajustes</span></a>
    </div>
</div>
</aside>

<!-- 
----------------------------------------------------------------------------
CONTENIDO PRINCIPAL (MAIN)
----------------------------------------------------------------------------
-->
<main id="main">
<!-- 
============================================================================
SHELL DEL PROYECTO (Panel único para todas las pestañas de proyecto)
============================================================================
-->
<section class="panel" id="projectShell" style="display:none">
<div class="tabs" id="project-tabs">
    <button class="tab active" data-ptab="overview">Overview</button>
    <button class="tab" data-ptab="tasks">Tareas</button>
    <button class="tab" data-ptab="calendar">Calendario</button>
    <button class="tab" data-ptab="notes">Notas</button>
    <button class="tab" data-ptab="tables">Tablas</button>
    <button class="tab" data-ptab="files">Archivos</button>
    <button class="tab" data-ptab="chat">Chat IA</button>
    <button class="tab" data-ptab="finance">Finanzas</button>
    <div class="spacer"></div>
    <div id="project-header-right" class="row">
        <div class="chip" id="projectNameChip">Proyecto</div>
        <button class="btn btn-ghost btn-sm" id="addFolder" title="Nueva Carpeta"><i data-lucide="folder-plus"></i></button>
        <select id="folderSel" class="btn-sm"></select>
        <button class="btn btn-primary btn-sm" id="quickAdd"><i data-lucide="plus"></i> Añadir</button>
    </div>
</div>
<!-- Pestaña: Overview -->
<div id="p-tab-overview" style="padding:16px; display:block;">
    <div id="ovr" class="overview-grid"></div>
</div>
<!-- Pestaña: Tareas -->
<div id="p-tab-tasks" style="display:none;">
    <div class="row" style="padding: 6px 10px; border-bottom: 1px solid var(--line);">
        <button id="viewToggleBoard" class="btn btn-ghost active"><i data-lucide="layout-grid"></i> Tablero</button>
        <button id="viewToggleList" class="btn btn-ghost"><i data-lucide="list"></i> Lista</button>
        
        <!-- NUEVO: Filtro de Tags -->
        <div class="chip" style="padding: 0 0 0 8px; margin-left: 10px;">
           <i data-lucide="tag" style="width:14px; height:14px; color: var(--sub);"></i>
           <input id="taskTagFilter" placeholder="Filtrar por tag..." style="border:none; background:transparent; padding: 6px 8px; font-size: var(--sm); width: 150px;">
        </div>

        <span class="spacer"></span>
        <button id="addColumnBtn" class="btn btn-sm"><i data-lucide="plus"></i> Columna</button>
    </div>
    <div id="kanban-view">
        <div class="board" id="kanban"></div>
    </div>
    <div id="list-view" class="table-wrapper" style="display:none; padding: 10px;">
        <table id="task-list-table" style="width:100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="width: 50%;">Tarea</th>
                    <th>Estado</th>
                    <th>Fecha Límite</th>
                    <th>Tags</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<!-- Pestaña: Calendario -->
<div id="p-tab-calendar" style="display:none; padding:10px;">
    <div class="row"><b>Calendario del proyecto</b><span class="spacer"></span><button class="btn" id="prevM"><i data-lucide="chevron-left"></i></button><div class="chip" id="monthLbl">Mes</div><button class="btn" id="nextM"><i data-lucide="chevron-right"></i></button></div>
    <div class="calendar" id="calGrid" style="margin-top:10px;"></div>
</div>
<!-- Pestaña: Notas -->
<div id="p-tab-notes" style="display:none; padding:10px">
    <div class="note-editor-wrapper">
        <div class="card" style="padding:8px;">
            <div class="row" style="margin-bottom:8px; padding: 4px; flex-wrap: wrap;">
                <button class="btn btn-sm" data-cmd="bold"><b>B</b></button>
                <button class="btn btn-sm" data-cmd="italic"><i>I</i></button>
                <button class="btn btn-sm" data-cmd="underline"><u>U</u></button>
                <button class="btn btn-sm" data-cmd="insertUnorderedList">•</button>
                <button class="btn btn-sm" data-cmd="insertOrderedList">1.</button>
                <button class="btn btn-sm" data-cmd="formatBlock" data-value="h2">H2</button>
                <button class="btn btn-sm" data-cmd="formatBlock" data-value="h3">H3</button>
                <span class="spacer"></span>
                <button class="btn btn-sm" id="exportNotePDF"><i data-lucide="file-down"></i> PDF</button>
            </div>
            <div id="noteEditor" contenteditable="true"></div>
        </div>
        <div>
            <div class="card">
                <div class="row"><b>Mis Notas</b><span class="spacer"></span><button class="btn btn-sm" id="newNoteBtn"><i data-lucide="plus"></i></button></div>
                <div id="noteList" style="margin-top:8px; max-height: 20vh; overflow-y: auto;"></div>
            </div>
            <div class="card" style="margin-top:10px">
                <div class="row"><b>Lienzo Rápido</b><span class="spacer"></span><button class="btn btn-sm" id="clearCanvasBtn"><i data-lucide="eraser"></i></button></div>
                <div class="row" style="margin: 8px 0;"><input type="color" id="canvasColorPicker"><input type="range" id="canvasStrokeSlider" min="1" max="20" value="3"></div>
                <canvas id="drawingCanvas"></canvas>
            </div>
        </div>
    </div>
</div>
<!-- Pestaña: Tablas -->
<div id="p-tab-tables" style="display:none; padding:10px;">
    <div class="row">
      <select id="tableSelector" class="btn-sm"></select>
      <button class="btn" id="newTableBtn"><i data-lucide="plus-square"></i></button>
      <span class="spacer"></span>
      <button class="btn" id="addCol"><i data-lucide="plus"></i> Columna</button>
      <button class="btn" id="addRow"><i data-lucide="plus"></i> Fila</button>
      <button class="btn" id="exportCSV">CSV</button>
    </div>
    <div class="section table-wrapper" id="sheetWrap" style="margin-top:10px;"></div>
</div>
<!-- Pestaña: Archivos -->
<div id="p-tab-files" style="display:none;padding:10px">
    <div class="row"><b>Archivos</b><span class="spacer"></span><label class="btn btn-primary"><i data-lucide="upload"></i> Subir Archivos<input id="fileInput" multiple type="file" style="display: none;"/></label></div>
    <div id="fileList" style="margin-top:10px" class="row"></div>
</div>
<!-- Pestaña: Chat IA (Proyecto) -->
<div id="p-tab-chat" style="display:none">
    <div class="gchat-grid">
        <!-- Columna de Lista de Chats -->
        <div class="card" style="display:flex; flex-direction: column; overflow-y: auto;">
            <div class="row"><b>Conversaciones</b><span class="spacer"></span><button class="btn btn-sm" id="newChat"><i data-lucide="plus"></i></button></div>
            <div id="chatList" style="margin-top:8px"></div>
        </div>
        <!-- Columna de Chat Activo -->
        <div class="card" style="display:flex; flex-direction:column; height: 100%;">
            <div class="model-selector">
                <div class="model-card active" data-model="pro">
                    <h5>Goatify Pro</h5>
                    <p>Potente y creativo, ideal para la mayoría de tareas.</p>
                </div>
                <div class="model-card" data-model="web">
                    <h5>Goatify Web</h5>
                    <p>Conectado a internet para respuestas actualizadas.</p>
                </div>
                <div class="model-card disabled" data-model="x" title="Próximamente">
                    <h5>Goatify X</h5>
                    <p>Nuestro modelo más avanzado y veloz.</p>
                </div>
            </div>
            <div class="row" style="border-bottom: 1px solid var(--line); padding-bottom: 8px; margin-bottom: 8px; flex-shrink: 0;">
                 <span class="spacer"></span>
                <button class="btn btn-sm" id="chatToTasks"><i data-lucide="list-plus"></i> Crear Tarea</button>
            </div>
            <div id="chatLog" class="chat-log"></div>
            <div class="row chat-input-area">
                <button class="btn btn-ghost" id="p_attachFileBtn" title="Analizar Imagen, PDF, etc."><i data-lucide="paperclip"></i></button>
                <textarea class="spacer" id="chatMsg" placeholder="Habla con la IA de tu proyecto…" rows="1"></textarea>
                <button class="btn btn-primary" id="sendMsg"><i data-lucide="send"></i></button>
                <input type="file" id="p_chatFileInput" style="display:none" />
            </div>
        </div>
    </div>
</div>
<!-- Pestaña: Finanzas -->
<div id="p-tab-finance" style="display:none; padding:10px;">
    <div class="row"><b>Finanzas del Proyecto</b><span class="spacer"></span><button class="btn btn-primary" id="finNew"><i data-lucide="plus"></i> Movimiento</button><button class="btn" id="finExport">CSV</button></div>
    <div class="overview-grid" style="padding: 10px 0;">
        <div class="stat-card"><h4>Ingresos Totales</h4><p id="finIn" style="color: var(--success);">0</p></div>
        <div class="stat-card"><h4>Egresos Totales</h4><p id="finOut" style="color: var(--danger);">0</p></div>
        <div class="stat-card"><h4>Balance Neto</h4><p id="finBal">0</p></div>
    </div>
    <div class="table-wrapper">
        <table id="finTable" style="width:100%; border-collapse: collapse;">
            <thead><tr><th style="text-align: left; padding: 8px;">Fecha</th><th style="text-align: left; padding: 8px;">Tipo</th><th style="text-align: right; padding: 8px;">Monto</th><th style="text-align: left; padding: 8px;">Categoría</th><th style="text-align: left; padding: 8px;">Nota</th><th></th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
</section>

<!-- 
============================================================================
MÓDULO: ASISTENTE IA GLOBAL - ¡ESTRUCTURA ACTUALIZADA!
============================================================================
-->
<section class="panel full-height-panel" id="ai-global-chat" style="display:none;">
    <div class="gchat-grid">
        <!-- Columna de Lista de Chats -->
        <div class="card">
            <div class="row"><b>Conversaciones</b><span class="spacer"></span><button class="btn btn-sm" id="aiNewChat"><i data-lucide="plus"></i></button></div>
            <div id="aiChatList" style="margin-top:8px"></div>
        </div>
        <!-- Columna de Chat Activo -->
        <div class="card">
             <!-- NUEVO: Encabezado de estado vacío (Punto 5) -->
             <div id="aiChatEmptyHeader" class="empty-state" style="display:none; padding: 20px 0 0 0; text-align: center; border-bottom: 1px solid var(--line);">
                <img src="Logos HD.png" style="width: 60px; height: 60px; margin-bottom: 12px;" alt="Goatify Logo">
                <h3 style="margin: 0; padding-bottom: 16px;">¿Cómo puedo ayudarte hoy?</h3>
             </div>
             <!-- Selector de Modelo (Ahora después del header) -->
             <div class="model-selector">
                <div class="model-card active" data-model="pro">
                    <h5>Goatify Pro</h5>
                    <p>Potente y creativo, ideal para la mayoría de tareas.</p>
                </div>
                <div class="model-card" data-model="web">
                    <h5>Goatify Web</h5>
                    <p>Conectado a internet para respuestas actualizadas.</p>
                </div>
                <div class="model-card disabled" data-model="x" title="Próximamente">
                    <h5>Goatify X</h5>
                    <p>Nuestro modelo más avanzado y veloz.</p>
                </div>
            </div>
            <div class="row" style="border-bottom: 1px solid var(--line); padding-bottom: 8px; margin-bottom: 8px; flex-shrink: 0;">
                <span class="spacer"></span>
                <button class="btn btn-sm" id="aiImageGenBtn"><i data-lucide="image"></i> Generar Imagen</button>
            </div>
            <!-- Log del Chat -->
            <div id="aiChatLog" class="chat-log">
                <!-- El estado vacío (sugerencias) se renderizará aquí -->
            </div>
            <!-- Input del Chat -->
            <div class="row chat-input-area">
                <button class="btn btn-ghost" id="g_attachFileBtn" title="Analizar Imagen, PDF, etc."><i data-lucide="paperclip"></i></button>
                <textarea class="spacer" id="aiChatMsg" placeholder="Habla con tu Asistente IA Global..." rows="1"></textarea>
                <button class="btn btn-primary" id="aiSendMsg"><i data-lucide="send"></i></button>
                <input type="file" id="g_chatFileInput" style="display:none" />
            </div>
        </div>
    </div>
</section>

<!-- 
============================================================================
MÓDULO: CRONOPOST (Calendario General)
============================================================================
-->
<section class="panel" id="cronopost" style="display:none;">
    <div class="row" style="padding:12px; border-bottom: 1px solid var(--line);">
        <!-- TÍTULO CAMBIADO -->
        <b>Calendario General</b>
        <div class="chip" style="margin-left: 10px;">Proyecto:</div>
        <select id="cpProjectSelect" class="btn-sm"></select>
        <span class="spacer"></span>
        <button class="btn" id="cpPrevM"><i data-lucide="chevron-left"></i></button>
        <div class="chip" id="cpMonthLbl">Mes</div>
        <button class="btn" id="cpNextM"><i data-lucide="chevron-right"></i></button>
    </div>
    <div id="cronopost-grid">
        <div id="cpCalendarContainer">
            <div class="calendar" id="cpCalendar"></div>
        </div>
        <div id="cpIdeas">
            <div class="card">
                <div class="row"><b>💡 Banco de Ideas</b><span class="spacer"></span><button class="btn btn-primary btn-sm" id="cpGenAIIdeas"><i data-lucide="sparkles"></i> IA</button></div>
                <div id="cpIdeasList" style="max-height: 50vh; overflow-y: auto; padding-right: 5px; margin: 10px 0;"></div>
                <input id="cpNewIdeaInput" placeholder="Escribe una nueva idea..." style="margin-bottom: 8px;">
                <button class="btn" id="cpAddIdeaBtn" style="width: 100%;">+ Añadir Idea</button>
            </div>
        </div>
    </div>
</section>

<!-- 
============================================================================
MÓDULO: HUB PROFESIONAL
============================================================================
-->
<section class="panel" id="hub" style="display:none; padding: 10px;">
    <div class="hub-grid">
    <div class="profile-card" style="background:var(--surface); border-radius:var(--radius); border:1px solid var(--line);">
        <div class="profile-header"></div>
        <div class="avatar-wrapper" style="padding: 0 20px;">
             <img alt="avatar" class="avatar" id="avatar" src="https://placehold.co/100x100/dde2ed/0b132a?text=TÚ"/>
             <input type="file" id="avatarInput" accept="image/*" style="display:none;">
        </div>
        <div style="padding: 0 20px 20px;">
            <h3 id="pNombreDisplay" style="margin: 0; display:inline-block; cursor:pointer;">Tu Nombre</h3>
            <p id="pRoleDisplay" class="sub" style="margin: 4px 0 10px; cursor:pointer;">Tu Rol Profesional</p>
            <p id="pBioDisplay" class="sub" style="font-size: var(--sm); cursor:pointer;">Tu biografía profesional. Habla sobre tu experiencia, tus habilidades y lo que buscas.</p>
            <div id="pSocialsDisplay" class="row"></div>
            <hr style="border-color:var(--line);"/>
            <b>Editar Perfil</b>
            <input id="pNombre" placeholder="Tu nombre" style="margin-top: 8px;"/>
            <input id="pRole" placeholder="Rol (Ej: Frontend Developer)" style="margin: 8px 0;"/>
            <textarea id="pBio" placeholder="Bio corta" rows="3" style="margin-bottom: 8px;"></textarea>
            <div class="row"><input id="pSocialLinkedin" placeholder="URL LinkedIn"/><input id="pSocialTwitter" placeholder="URL Twitter"/></div>
            <button class="btn btn-primary" id="savePerfil" style="width:100%; margin-top:10px;">Guardar Perfil</button>
        </div>
    </div>
    <div>
        <div class="tabs" style="padding:0; border-bottom:none; margin-bottom:10px;">
            <button class="tab active" data-htab="market">Mercado de Servicios</button>
            <button class="tab" data-htab="jobs">Bolsa de Empleos</button>
        </div>
        <div id="h-htab-market">
            <div class="card" style="margin-bottom: 10px;">
              <b>Publicar un nuevo producto o servicio</b>
              <div class="row"><input id="mkName" placeholder="Nombre"/><input id="mkPrice" placeholder="Precio (Ej: 500)" type="number"/></div>
              <textarea id="mkDesc" placeholder="Describe tu servicio..." rows="2" style="width:100%; margin: 8px 0;"></textarea>
              <button class="btn btn-primary" id="addMK">Publicar en Mercado</button>
            </div>
            <div id="mkList" style="max-height: 60vh; overflow-y:auto; padding: 5px;"></div>
        </div>
        <div id="h-htab-jobs" style="display:none;">
             <div class="card" style="margin-bottom: 10px;">
              <b>Publicar una nueva oferta de empleo</b>
              <div class="row" style="gap: 8px; margin-top: 8px;">
                <input id="jobTitle" placeholder="Título del Puesto" style="flex: 2;"/>
                <input id="jobCompany" placeholder="Empresa" style="flex: 1;"/>
              </div>
              <div class="row" style="gap: 8px; margin-top: 8px;">
                <input id="jobLocation" placeholder="Ubicación (Ej: Remoto)" style="flex: 1;"/>
                <input id="jobPay" placeholder="Salario (Ej: $2000/mes)" style="flex: 1;"/>
                <select id="jobType" style="flex: 1;">
                    <option>Tiempo Completo</option>
                    <option>Medio Tiempo</option>
                    <option>Por Proyecto</option>
                    <option>Freelance</option>
                </select>
              </div>
              <textarea id="jobDesc" placeholder="Descripción del puesto, requisitos, beneficios..." rows="4" style="width:100%; margin: 8px 0;"></textarea>
              <button class="btn btn-primary" id="addJob">Publicar Empleo</button>
            </div>
            <div class="row" style="padding: 0 5px; margin-bottom: 10px;">
                <input id="jobSearchInput" placeholder="Buscar empleos por título o empresa...">
            </div>
            <div id="jobsList" style="max-height: 60vh; overflow-y:auto; padding: 5px;"></div>
        </div>
    </div>
</div>
</section>

<!-- 
============================================================================
MÓDULO: CHAT GLOBAL
============================================================================
-->
<section class="panel full-height-panel" id="gchat" style="display:none">
    <div class="gchat-grid">
        <!-- Columna de Lista de Usuarios -->
        <div class="card">
            <b>Usuarios Conectados</b>
            <div id="gUserList" class="user-list" style="margin-top:8px; flex:1; overflow-y:auto;"></div>
        </div>
        <!-- Columna de Chat Activo -->
        <div class="card">
            <h3 id="gChatHeader" style="margin: 0 0 10px 0;">Chat Global: #general</h3>
            <div id="gChatLog" class="chat-log" style="flex:1;"></div>
            <div class="row" style="padding-top:10px;"><input class="spacer" id="gChatMsg" placeholder="Escribe un mensaje..."/><button class="btn btn-primary" id="sendGChat"><i data-lucide="send"></i></button></div>
        </div>
    </div>
</section>

<!-- 
============================================================================
MÓDULO: ASISTENTE DE MONETIZACIÓN
============================================================================
-->
<section class="panel" id="monet" style="display:none; padding: 10px;">
    <div class="card" style="text-align: center; background: linear-gradient(145deg, color-mix(in hsl, var(--brand) 85%, black), color-mix(in hsl, var(--accent) 85%, black)); color: white;">
        <h2 style="margin:0;">Asistente de Monetización Quantum Pro</h2>
        <p style="opacity: 0.8;">Transforma tus ideas en ingresos. Selecciona un módulo para empezar.</p>
    </div>
    <div id="monet-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; margin-top: 10px;">
    </div>
</section>

<!-- 
============================================================================
MÓDULO: BIENESTAR Y MINDSET
============================================================================
-->
<section class="panel" id="mindset" style="display:none; padding: 10px;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; align-items: start;">
        <div class="card">
            <h3><i data-lucide="brain-circuit"></i> Balance Mente-Cuerpo</h3>
            <p class="sub">El verdadero éxito no es solo alcanzar metas, sino mantener un equilibrio saludable. Tu bienestar es la base de tu productividad y creatividad.</p>
            <p class="sub" style="font-size: var(--sm);">Una parte clave del balance es mejorar tus habilidades sociales y hacer networking. Por eso hemos creado el Chat Global, un espacio para que conectes con otros profesionales.</p>
            <div class="row" style="margin-top: 16px;">
                <a href="#!gchat" class="btn btn-primary nav-link-btn" style="width: 100%;">
                    <i data-lucide="messages-square"></i>
                    <span>Ir al Chat Global</span>
                </a>
            </div>
        </div>
        <div class="card" style="text-align:center;">
            <h3><i data-lucide="wind"></i> Pausa para Respirar</h3>
            <p class="sub">Tómate un minuto para centrarte.</p>
            <div id="breathing-circle-container">
                <div id="breathing-circle"></div>
                <span id="breathing-text">Inhala...</span>
            </div>
        </div>
        <div class="card">
            <h3><i data-lucide="dumbbell"></i> Momento de Actividad</h3>
            <p class="sub">El movimiento impulsa la mente. Estira tu cuerpo o prepárate para una rutina de entrenamiento completa para recargar tu energía.</p>
            <div class="row" style="margin-top: 16px; justify-content: center;">
                <a href="https://www.goatify.app/fit" target="_blank" class="btn btn-primary" style="width: 100%;">
                    <i data-lucide="external-link"></i>
                    <span>Entrenar con goatiFIT (Rutinas Gratis)</span>
                </a>
            </div>
        </div>
         <div class="card">
            <h3><i data-lucide="quote"></i> Dosis de Inspiración</h3>
            <p class="sub" id="mindsetQuote">"El éxito es la suma de pequeños esfuerzos repetidos día tras día."</p>
        </div>
    </div>
</section>

<!-- 
============================================================================
MÓDULO: AJUSTES
============================================================================
-->
<section class="panel" id="settings" style="display:none;padding:10px">
<div class="card">
<b>Ajustes de la Aplicación</b>
<div class="row" style="margin-top:8px"><button class="btn" id="btnExport">Exportar Datos (.json)</button><label class="btn">Importar Datos<input type="file" accept="application/json" id="btnImport" style="display:none;"/></label><button class="btn" id="resetApp" style="background:var(--danger); color:white; border-color: var(--danger);">Reset Total</button></div>
<div class="section tip" style="background: color-mix(in hsl, var(--info) 10%, transparent); border-left: 3px solid var(--info); padding: 12px; margin: 1em 0; border-radius: 8px;"><i data-lucide="database" style="width:16px; height:16px; margin-right: 8px; vertical-align: middle;"></i> Todo se guarda offline en tu navegador (localStorage). Para colaborar, se necesita una base de datos como Firebase.</div>
</div>
</section>
</main>
</div> <!-- Fin de .container -->

<!-- 
============================================================================
OVERLAY PARA MENÚ MÓVIL
============================================================================
-->
<div id="menu-overlay"></div>

<!-- 
============================================================================
MODALES DE LA APLICACIÓN
============================================================================
-->
<!-- Modal: Selección de Industria (Onboarding) -->
<dialog id="industryModal">
    <div style="padding: 24px; text-align: center;">
        <i data-lucide="briefcase" width="48" height="48" style="color: var(--brand);"></i>
        <h2 style="margin-top: 10px;">¡Bienvenido a Goatify IA!</h2>
        <p class="sub">Para empezar, personalicemos tu espacio de trabajo. ¿Cuál es tu industria o tipo de negocio?</p>
        <div class="card" style="text-align: left;">
             <label for="industrySelect">Selecciona tu Industria:</label>
             <select id="industrySelect" style="width: 100%; margin: 12px 0;">
                <option value="agency">Agencia de Marketing / Servicios</option>
                <option value="ecommerce">E-commerce / Tienda Online</option>
                <option value="creator">Creador de Contenido / Marca Personal</option>
                <option value="generic">Otro / General</option>
            </select>
            <button class="btn btn-primary" id="loadIndustryBtn" style="width: 100%;">Personalizar y Empezar</button>
        </div>
    </div>
</dialog>

<!-- Modal: Input Genérico -->
<dialog id="inputModal">
    <div style="padding: 24px;">
        <h3 id="inputModalTitle" style="margin-top:0"></h3>
        <p id="inputModalDesc" class="sub"></p>
        <input id="inputModalInput" style="margin-bottom: 12px;"/>
        <div class="row" style="margin-top: 24px;">
            <button class="btn" onclick="$('#inputModal').close()">Cancelar</button>
            <span class="spacer"></span>
            <button class="btn btn-primary" id="inputModalConfirm">Confirmar</button>
        </div>
    </div>
</dialog>

<!-- Modal: Detalles de Tarea -->
<dialog id="taskDetailModal">
    <div style="padding: 24px; display: flex; flex-direction: column; max-height: 85vh;">
        <div class="row">
            <h3 style="margin-top:0">Detalles de la Tarea</h3>
            <span class="spacer"></span>
            <button class="btn btn-ghost" onclick="$('#taskDetailModal').close()"><i data-lucide="x"></i></button>
        </div>
        <input type="hidden" id="taskDetailId">
        <div style="overflow-y: auto; padding-right: 10px;">
            <label>Título de la Tarea</label>
            <input id="taskDetailTitle" placeholder="¿Qué hay que hacer?" style="margin: 8px 0 16px; font-size: var(--lg); padding: 12px;" />
            
            <label>Descripción</label>
            <textarea id="taskDetailDesc" placeholder="Añade más detalles..." rows="4" style="margin: 8px 0 16px;"></textarea>
            
            <div class="row" style="gap: 16px; margin-bottom: 16px;">
                <div style="flex:1">
                    <label>Estado</label>
                    <select id="taskDetailStatus" style="margin-top: 8px;"></select>
                </div>
                <div style="flex:1">
                    <label>Fecha Límite</label>
                    <input type="date" id="taskDetailDue" style="margin-top: 8px;" />
                </div>
            </div>

             <!-- Selector de Carpeta -->
             <div style="margin-bottom: 16px;">
                 <label>Carpeta</label>
                 <select id="taskDetailFolder" style="margin-top: 8px;"></select>
             </div>

             <!-- NUEVO: Input de Tags -->
             <div style="margin-bottom: 16px;">
                 <label>Tags (separados por coma)</label>
                 <input id="taskDetailTags" placeholder="Ej: urgente, diseño, cliente" style="margin-top: 8px;" />
             </div>
        </div>
        <div class="row" style="margin-top: 24px; border-top: 1px solid var(--line); padding-top: 16px;">
            <button class="btn" style="color:var(--danger); border-color: var(--danger);" id="taskDetailDeleteBtn"><i data-lucide="trash-2"></i> Eliminar</button>
            <span class="spacer"></span>
            <button class="btn" onclick="$('#taskDetailModal').close()">Cancelar</button>
            <button class="btn btn-primary" id="taskDetailSaveBtn"><i data-lucide="save"></i> Guardar Cambios</button>
        </div>
    </div>
</dialog>

<!-- Modal: Créditos -->
<dialog id="creditsModal">
    <div style="padding: 24px; text-align: center;">
        <button onclick="$('#creditsModal').close()" class="btn btn-ghost" style="position:absolute; top:10px; right:10px;"><i data-lucide="x"></i></button>
        <h2 style="margin-top: 0;">🚀 Desbloquea tu Potencial con Goatify PRO</h2>
        <p class="sub">La versión gratuita te da <b>100 créditos</b> para probar las funciones de IA. Cuando se acaben, ciertas acciones estarán limitadas.</p>
        <div class="card" style="text-align: left; background: color-mix(in hsl, var(--brand) 8%, transparent); border-left: 4px solid var(--brand);">
            <h3 style="margin-top:0;">Coste de Créditos y Beneficios PRO</h3>
            <ul id="pricingList" style="padding-left: 20px;">
                <li><b>Generación de ideas IA:</b> 5 créditos</li>
                <li><b>Chat IA (Goatify Pro):</b> 1 crédito por mensaje</li>
                <li><b>Chat IA (Goatify Web):</b> 3 créditos por mensaje</li>
                <li><b>Membresía PRO ($4 USD/mes):</b> Créditos ilimitados y acceso a todas las funciones sin restricciones.</li>
            </ul>
        </div>
        <button class="btn btn-primary" style="width: 100%; margin-top: 16px; padding: 12px;">Obtener Goatify PRO</button>
    </div>
</dialog>

<!-- Modal: Videollamada (Placeholder) -->
<dialog id="videoCallModal">
    <div style="padding: 24px; text-align: center;">
        <h3 id="videoCallTitle">Llamando a...</h3>
        <p class="sub">Esperando que acepte la llamada.</p>
        <div style="width: 120px; height: 120px; border-radius: 50%; background: var(--muted); margin: 20px auto; display:flex; align-items:center; justify-content:center;"><i data-lucide="video" size="48"></i></div>
        <button class="btn" style="background:var(--danger); color:white;" onclick="$('#videoCallModal').close()">Cancelar Llamada</button>
    </div>
</dialog>

<!-- Modal: Módulo de Monetización -->
<dialog id="monetModuleModal">
    <div style="padding: 24px; display: flex; flex-direction: column; max-height: 85vh;">
         <div class="row">
            <h3 id="monetModuleTitle" style="margin-top:0; color: var(--brand);"></h3>
            <span class="spacer"></span>
            <button onclick="$('#monetModuleModal').close()" class="btn btn-ghost"><i data-lucide="x"></i></button>
        </div>
        <div id="monetModuleContent" style="overflow-y: auto; padding-right: 10px;"></div>
    </div>
</dialog>

<!-- Modal: Billetera General -->
<dialog id="walletModal">
    <div style="padding: 24px; display: flex; flex-direction: column; max-height: 85vh;">
        <div class="row">
            <h3 style="margin-top:0"><i data-lucide="wallet"></i> Billetera General</h3>
            <span class="spacer"></span>
            <button onclick="$('#walletModal').close()" class="btn btn-ghost"><i data-lucide="x"></i></button>
        </div>
        <p class="sub">Registra aquí todos los ingresos y egresos de tus proyectos para tener un control financiero centralizado.</p>
        <div class="card" style="margin: 10px 0;">
            <div class="row"><input id="wMonto" placeholder="Monto" type="number" step="0.01"/><select id="wTipo"><option>Ingreso</option><option>Egreso</option></select></div>
            <div class="row" style="margin-top:8px"><input id="wCat" placeholder="Categoría" class="spacer"/><input id="wNota" placeholder="Nota" class="spacer"/></div>
            <button class="btn btn-primary" id="wAdd" style="width:100%; margin-top:8px;">+ Añadir Movimiento</button>
        </div>
        <div class="table-wrapper" style="overflow-y: auto; padding-right: 10px;">
            <table style="width:100%;">
                <thead><tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Cat</th><th>Nota</th><th></th></tr></thead>
                <tbody id="wBody"></tbody>
            </table>
        </div>
    </div>
</dialog>

<!-- Modal: Intis (Gamificación) -->
<dialog id="intisModal">
     <div style="padding: 24px; text-align: center;">
        <button onclick="$('#intisModal').close()" class="btn btn-ghost" style="position:absolute; top:10px; right:10px;"><i data-lucide="x"></i></button>
        <i data-lucide="sparkles" width="48" height="48" style="color: var(--brand);"></i>
        <h2 style="margin-top: 10px;">¿Qué son los Intis? ✨</h2>
        <p class="sub">Los Intis son nuestra moneda de gamificación, diseñada para fomentar una economía circular y colaborativa dentro de Goatify.</p>
        <div class="card" style="text-align: left;">
            <h4 style="margin-top:0">Reglas para Ganar Intis</h4>
            <ul style="padding-left: 20px;">
                <li><b>+100 Intis:</b> Cargar una plantilla de industria al empezar.</li>
                <li><b>+50 Intis:</b> Crear un nuevo proyecto desde cero.</li>
                <li><b>+20 Intis:</b> Publicar en el Hub Profesional (empleos y servicios).</li>
                <li><b>+10 Intis:</b> Completar una tarea (moverla a "Hecho").</li>
                <li><b>+5 Intis:</b> Crear una nueva tarea, nota, tabla, o idea de contenido.</li>
                <li><b>+5 Intis:</b> Registrar un movimiento en la billetera.</li>
                <li><b>+5 Intis:</b> Subir un archivo.</li>
                <li><b>+2 Intis:</b> Enviar un mensaje en el Chat Global.</li>
            </ul>
             <h4 style="margin-top:1em;">¿Para qué sirven?</h4>
             <p>Actualmente, los Intis miden tu progreso y participación. En el futuro, podrás usarlos para canjear recompensas, acceder a funciones exclusivas y realizar transacciones dentro del mercado.</p>
        </div>
    </div>
</dialog>

<!-- Modal: Enviar Chat a Proyecto -->
<dialog id="sendChatModal">
    <div style="padding: 24px;">
        <h3 id="sendChatModalTitle" style="margin-top:0">Enviar Conversación a Proyecto</h3>
        <p class="sub">Selecciona el proyecto de destino:</p>
        <select id="sendChatProjectSelect" style="width: 100%; margin: 12px 0;"></select>
        <div class="row" style="margin-top: 24px;">
            <button class="btn" onclick="$('#sendChatModal').close()">Cancelar</button>
            <span class="spacer"></span>
            <button class="btn btn-primary" id="sendChatConfirmBtn">Confirmar</button>
        </div>
    </div>
</dialog>

<!-- Modal: Nueva Tarea (desde Cronopost) -->
<dialog id="cronoTaskModal">
    <div style="padding: 24px;">
        <h3 id="cronoTaskModalTitle" style="margin-top:0">Nueva Tarea</h3>
        <p id="cronoTaskModalDesc" class="sub"></p>
        <label>Título de la Tarea</label>
        <input id="cronoTaskTitle" style="margin: 8px 0 16px;" />
        <label>Asignar a Proyecto</label>
        <select id="cronoTaskProjectSelect" style="margin-top: 8px;"></select>
        <div class="row" style="margin-top: 24px;">
            <button class="btn" onclick="$('#cronoTaskModal').close()">Cancelar</button>
            <span class="spacer"></span>
            <button class="btn btn-primary" id="cronoTaskConfirm">Crear Tarea</button>
        </div>
    </div>
</dialog>

<!-- Modal: Búsqueda -->
<dialog id="searchModal">
    <div style="padding: 24px; display: flex; flex-direction: column; max-height: 85vh;">
        <div class="row">
            <h3 style="margin-top:0">Resultados de Búsqueda</h3>
            <span class="spacer"></span>
            <button class="btn btn-ghost" onclick="$('#searchModal').close()"><i data-lucide="x"></i></button>
        </div>
        <div id="searchResults" style="overflow-y: auto; padding-right: 10px; margin-top: 16px;"></div>
    </div>
</dialog>

<!-- Modal: Finanzas de Proyecto (Corregido) -->
<dialog id="projectFinModal">
    <div style="padding: 24px;">
        <h3 style="margin-top:0">Nuevo Movimiento de Proyecto</h3>
        <div class="row" style="gap: 8px;">
            <input id="pF_Monto" placeholder="Monto" type="number" step="0.01" style="flex:1;"/>
            <select id="pF_Tipo" style="flex:1;">
                <option>Ingreso</option>
                <option>Egreso</option>
            </select>
        </div>
        <div class="row" style="margin-top:8px; gap: 8px;">
            <input id="pF_Cat" placeholder="Categoría" style="flex:1;"/>
            <input id="pF_Nota" placeholder="Nota" style="flex:1;"/>
        </div>
        <div class="row" style="margin-top: 24px;">
            <button class="btn" onclick="$('#projectFinModal').close()">Cancelar</button>
            <span class="spacer"></span>
            <button class="btn btn-primary" id="pF_Confirm">Añadir</button>
        </div>
    </div>
</dialog>

<!-- 
============================================================================
ELEMENTOS DEL TOUR GUIADO
============================================================================
-->
<div id="tour-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index: 1000;"></div>
<div id="tour-tooltip" style="display:none; position:fixed; background:var(--surface); color:var(--text); padding:16px; border-radius:var(--radius); z-index:1001; max-width:300px; box-shadow:var(--shadow); transition: top .3s ease, left .3s ease;">
    <h4 id="tour-title" style="margin-top:0;"></h4>
    <p id="tour-text" class="sub"></p>
    <div class="row">
        <span id="tour-step"></span>
        <span class="spacer"></span>
        <button class="btn" id="tour-prev">Anterior</button>
        <button class="btn btn-primary" id="tour-next">Siguiente</button>
    </div>
</div>

<!-- 
============================================================================
NOTIFICACIÓN TOAST
============================================================================
-->
<div id="toast" class="info"></div>


<!-- 
============================================================================
============================================================================
INICIO DE JAVASCRIPT
============================================================================
============================================================================
-->
<!-- ... (El HTML y CSS de la entrega anterior va aquí) ... -->

<!-- 
============================================================================
============================================================================
INICIO DE JAVASCRIPT
============================================================================
============================================================================
-->
<script>
// "use strict"; // Desactivado temporalmente para depuración si es necesario

/* ============================================================================
SECCIÓN 1: ESTADO GLOBAL Y MANEJO DE DATOS
============================================================================
*/
var S = {}; // El objeto de estado global
const initialState = {
  version:'9.1-final', // Versión actualizada con todas las mejoras
  userProfile: { industry: null },
  projects: [],
  activeProject: null,
  activeNav: 'ai-global-chat', // Vista predeterminada
  ui: {
      taskView: 'board',
      asideCollapsed: true, // Inicia colapsado en desktop
      activeFolder: 'General', // Siempre hay una carpeta activa
      sidebarTopHeight: '50%', // Altura inicial de la sección de proyectos
      projectCollapsedState: {} // Guarda el estado plegado de cada proyecto { projectId: true/false }
  },
  folders: {}, // folders[projectId] = ['General', 'Folder2', ...]
  tasks: {},   // tasks[projectId] = { 'General': [], 'Folder2': [] } // Incluye tags: ['tag1', 'tag2']
  notes: {},   // notes[projectId] = {list:[], active:null, bodies:{}, drawings:{}}
  chats: {},   // chats[projectId] = {threads:[], messages:{}, activeThread: null, model: 'pro'}
  tables: {},  // tables[projectId] = {list:[], active:null, data:{}}
  files: {},   // files[projectId] = []
  fin: {},     // fin[projectId] = {rows:[]}
  cronopost: { posts: {}, ideas: {} },
  hub: { 
    perfil: { id:'u_me', nombre:'Tu Nombre', rol:'Emprendedor Digital', bio:'¡Listo para conquistar el mundo digital!', avatar: null, socials: {linkedin:'', twitter:''}},
    market:[],
    jobs:[],
    users: [ 
        {id: 'u_ana', nombre: 'Ana', rol: 'Diseñadora UX', online: true, avatar: 'https://placehold.co/100x100/f87171/ffffff?text=A'},
        {id: 'u_carlos', nombre: 'Carlos', rol: 'Copywriter', online: false, avatar: 'https://placehold.co/100x100/38bdf8/ffffff?text=C'},
        {id: 'u_elena', nombre: 'Elena', rol: 'Project Manager', online: true, avatar: 'https://placehold.co/100x100/22c55e/ffffff?text=E'},
    ]
  },
  gchat: { messages:{'general': []}, dms: {}, activeChat: 'general' },
  monet: {},
  mindset: { frequency: 'daily' },
  wallet: { movs: [] },
  intis: 0,
  aiGlobalChat: { threads: [{id:'c_global_1', title:'Chat General'}], messages: {'c_global_1':[]}, activeThread: 'c_global_1', model: 'pro' },
  credits: 100,
};
const CREDIT_COSTS = {
    aiChatPro: 1,
    aiChatWeb: 3,
    aiIdeas: 5,
};

/**
 * Guarda el estado global 'S' en localStorage.
 */
function save(){ 
    try {
        localStorage.setItem('goatify_v9_final', JSON.stringify(S)); // Nueva clave v9.1
        syncHeader();
    } catch(e) {
        console.error("Error saving to localStorage", e);
        showToast("Error: Los datos son demasiado grandes para guardar localmente.", "warn");
    }
}

/**
 * Carga el estado 'S' desde localStorage o usa el estado inicial.
 * Realiza migraciones y comprobaciones de integridad.
 */
function load(){
  let raw = localStorage.getItem('goatify_v9_final') || localStorage.getItem('goatify_v9_nav') || localStorage.getItem('goatify_v8_7'); // Carga datos antiguos si existen
  S = raw ? JSON.parse(raw) : JSON.parse(JSON.stringify(initialState));
  
  // Migraciones y valores por defecto (asegura que el estado viejo sea compatible)
  S.projects.forEach(p => {
      const projId = p.id;
      if(!p.taskColumns) p.taskColumns = ['Backlog','En curso','Bloqueado','Hecho'];
      
      // MIGRACIÓN: Estructura de Tareas por Carpetas y Tags
      if (!S.tasks[projId] || Array.isArray(S.tasks[projId])) {
          const oldTasks = Array.isArray(S.tasks[projId]) ? S.tasks[projId] : [];
          S.tasks[projId] = { 'General': [] }; // Inicializa con 'General'
          oldTasks.forEach(task => {
              if (!task.folder) task.folder = 'General'; // Asigna carpeta por defecto
              if (!task.tags) task.tags = []; // Añade array de tags vacío
              if (!S.tasks[projId][task.folder]) S.tasks[projId][task.folder] = []; // Crea la carpeta si no existe
              S.tasks[projId][task.folder].push(task);
          });
      } else {
          // Si ya existe la estructura de carpetas, solo asegura tags
          Object.values(S.tasks[projId]).forEach(folderTasks => {
              folderTasks.forEach(task => {
                  if (!task.tags) task.tags = [];
              });
          });
      }
      
      // Asegurar que todas las carpetas definidas existan en la estructura de tasks
      (S.folders[projId] || ['General']).forEach(folderName => {
          if (!S.tasks[projId][folderName]) {
              S.tasks[projId][folderName] = [];
          }
      });
      
      // Asegurar que las carpetas existan
      if (!S.folders[projId] || S.folders[projId].length === 0) S.folders[projId] = ['General'];
      // Asegurar inicialización para otros módulos
      if (!S.notes[projId]) S.notes[projId] = {list:[], active:null, bodies:{}, drawings:{}};
      if (!S.chats[projId]) S.chats[projId] = {threads:[], messages:{}, activeThread: null, model: 'pro'};
      if (!S.tables[projId]) S.tables[projId] = {list:[{id: 'tbl_default', name: 'Tabla 1'}], active: 'tbl_default', data: {'tbl_default': {cols:['Col 1'], rows:[]}}};
      if (!S.files[projId]) S.files[projId] = [];
      if (!S.fin[projId]) S.fin[projId] = {rows:[]};
      if (!S.cronopost.posts[projId]) S.cronopost.posts[projId] = {};
      if (!S.cronopost.ideas[projId]) S.cronopost.ideas[projId] = [];

  });
  if (!S.userProfile) S.userProfile = { industry: null };
  if (!S.hub || !S.hub.users) S.hub = initialState.hub;
  if (!S.hub.jobs) S.hub.jobs = [];
  if (!S.gchat) S.gchat = initialState.gchat;
  if (!S.wallet) S.wallet = { movs: [] };
  if (!S.intis) S.intis = 0;
  if (!S.aiGlobalChat) S.aiGlobalChat = initialState.aiGlobalChat;
  if (!S.ui) S.ui = { taskView: 'board', asideCollapsed: true, activeFolder: 'General', sidebarTopHeight: '50%', projectCollapsedState: {} };
  if (!S.tables) S.tables = {};
  if (!S.ui.activeFolder) S.ui.activeFolder = 'General';
  if (!S.ui.sidebarTopHeight) S.ui.sidebarTopHeight = '50%';
  if (!S.ui.projectCollapsedState) S.ui.projectCollapsedState = {};
  
  syncHeader();
  document.body.classList.toggle('aside-collapsed', S.ui.asideCollapsed);
  // Aplica la altura guardada del sidebar
  applySidebarHeight(); 
}

/**
 * Aplica la altura guardada a las secciones del sidebar.
 */
function applySidebarHeight() {
    const topSection = $('aside .aside-middle-section');
    const bottomSection = $('aside .aside-bottom-section');
    if (topSection && bottomSection) {
        // Usa flex-basis para controlar la altura relativa
        topSection.style.flexBasis = S.ui.sidebarTopHeight || '50%'; 
        // bottomSection se ajustará automáticamente con flex-grow/shrink
    }
}

/**
 * Sincroniza los valores de la billetera e Intis en el header.
 */
function syncHeader(){
  const walletBalance = (S.wallet.movs || []).reduce((acc, mov) => acc + (mov.tipo === 'Ingreso' ? mov.monto : -mov.monto), 0);
  $('#wallet-amount').textContent = `$${walletBalance.toFixed(2)}`;
  $('#intis-amount').textContent = S.intis;
}

/**
 * Consume créditos de IA y maneja errores.
 * @param {number} amount - Cantidad de créditos a usar.
 * @returns {boolean} - True si los créditos se usaron, false si no.
 */
function useCredits(amount) {
    if (S.credits < amount) {
        showToast("Créditos insuficientes. ¡Actualiza a PRO!", "warn");
        $('#creditsModal').showModal();
        return false;
    }
    S.credits -= amount;
    save();
    return true;
}

/**
 * Añade puntos de gamificación (Intis).
 * @param {number} points - Puntos a añadir.
 * @param {string} reason - Razón para el log.
 */
function addIntis(points, reason) {
    S.intis += points;
    save();
    showToast(`+${points} Intis ✨ (${reason})`, 'info');
}

/* ============================================================================
SECCIÓN 2: FUNCIONES UTILITARIAS (Helpers)
============================================================================
*/
/**
 * Selector de DOM (Query Selector)
 * @param {string} sel - Selector CSS.
 * @returns {Element | null}
 */
const $ = sel => document.querySelector(sel);

/**
 * Selector de DOM Múltiple (Query Selector All)
 * @param {string} sel - Selector CSS.
 * @returns {NodeListOf<Element>}
 */
const $$ = sel => document.querySelectorAll(sel); // Devuelve NodeList directamente

/**
 * Creador de elementos DOM.
 * @param {string} tag - Etiqueta HTML (ej: 'div').
 * @param {object} attrs - Atributos (ej: {class: 'clase', dataset: {id: 1}}).
 * @param  {...any} kids - Nodos hijos (texto o elementos).
 * @returns {Element}
 */
function el(tag, attrs={}, ...kids){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='dataset'){ Object.entries(v).forEach(([dk,dv])=>e.dataset[dk]=dv); }
    else if(k==='html'){ e.innerHTML = v; }
    else if(k==='textContent'){ e.textContent = v; }
    else if(k.startsWith('on')) { e[k] = v; } // Asigna listeners directamente
    else e.setAttribute(k,v);
  });
  kids.forEach(k=>{ if(k) e.append(k); });
  return e;
}

/**
 * Formatea una fecha localmente.
 * @param {string|Date} d - La fecha.
 * @param {string} type - 'datetime', 'date', 'short'.
 * @returns {string} - Fecha formateada.
 */
function fmtDate(d, type = 'datetime'){ 
    const dt = new Date(d); 
    if (isNaN(dt)) return ''; // Manejo de fecha inválida
    
    // CORRECCIÓN TIMEZONE: Obtener componentes locales
    const year = dt.getFullYear();
    const month = String(dt.getMonth() + 1).padStart(2, '0'); // Meses son 0-11
    const day = String(dt.getDate()).padStart(2, '0');
    
    if (type === 'date') return `${year}-${month}-${day}`; // Formato YYYY-MM-DD
    if (type === 'short') return dt.toLocaleDateString('es', { day: 'numeric', month: 'short' }); // Ej: 23 oct

    // Para datetime, usa toLocaleString que respeta la zona horaria del navegador
    return dt.toLocaleString('es', { dateStyle: 'short', timeStyle: 'short'}); 
}

/**
 * Convierte un array 2D en una cadena CSV.
 * @param {Array<Array<any>>} rows - Array de filas.
 * @returns {string} - Cadena CSV.
 */
function csv(rows){ return rows.map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n'); }

/**
 * Inicia la descarga de un archivo de texto.
 * @param {string} filename - Nombre del archivo.
 * @param {string} text - Contenido del archivo.
 */
function download(filename, text){
  const a = el('a',{href:URL.createObjectURL(new Blob([text],{type:'text/plain'})), download:filename});
  document.body.appendChild(a); a.click(); a.remove();
}

/**
 * Muestra una notificación toast.
 * @param {string} message - Mensaje a mostrar.
 * @param {string} type - 'info', 'success', 'warn', 'danger'.
 */
let toastTimeout;
function showToast(message, type = 'info') {
    const toast = $('#toast');
    if (!toast) return;
    toast.textContent = message;
    toast.className = ''; // Limpia clases previas
    toast.classList.add(type, 'show');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 3000);
}

/**
 * Muestra el modal de input genérico.
 * @param {string} title - Título del modal.
 * @param {string} description - Descripción.
 * @param {string} placeholder - Placeholder del input.
 * @param {Function} callback - Función a ejecutar al confirmar (recibe el valor).
 * @param {string} [initialValue=''] - Valor inicial del input.
 */
function showInputModal(title, description, placeholder, callback, initialValue = '') {
    $('#inputModalTitle').textContent = title;
    $('#inputModalDesc').textContent = description;
    const input = $('#inputModalInput');
    input.placeholder = placeholder;
    input.value = initialValue;
    
    // Asegura que el listener de confirmación sea único
    const confirmBtn = $('#inputModalConfirm');
    const newConfirmBtn = confirmBtn.cloneNode(true); // Clonar para quitar listeners viejos
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.onclick = () => {
        const value = input.value.trim();
        if (value || placeholder === 'eliminar' || placeholder === 'BORRAR TODO') {
             if (placeholder === 'eliminar' && value.toLowerCase() !== 'eliminar') {
                 showToast('La confirmación no coincide.', 'warn');
                 return;
             }
             if (placeholder === 'BORRAR TODO' && value !== 'BORRAR TODO') {
                 showToast('La confirmación no coincide.', 'warn');
                 return;
             }
            callback(value);
            $('#inputModal').close();
        } else {
            showToast('Por favor, ingresa un valor.', 'warn');
        }
    };

    $('#inputModal').showModal();
    input.focus();
}


/* ============================================================================
SECCIÓN 3: NAVEGACIÓN PRINCIPAL Y UI CORE
============================================================================
*/

/**
 * Renderiza la lista de proyectos y carpetas en el aside.
 * Incluye lógica de plegado/desplegado.
 */
function renderAside() {
  const list = $('#projList'); list.innerHTML='';
  
  S.projects.forEach(p => {
    const isCollapsed = S.ui.projectCollapsedState[p.id] === true;
    
    // 1. Crear el item del Proyecto (como <a>)
    const item = el('a', {
        class:'projItem', 
        dataset: {id: p.id, collapsed: isCollapsed}, 
        href: `#!project/${p.id}`,
        onclick: (e) => {
            // Permitir click en toggle sin navegar
            if (!e.target.closest('.proj-toggle')) {
                e.preventDefault();
                history.pushState({view: `project/${p.id}`}, '', `#!project/${p.id}`);
                openProject(p.id);
            }
        }
      },
        // Icono para plegar/desplegar
        el('span', { class: 'proj-toggle', onclick: (e) => { e.preventDefault(); e.stopPropagation(); toggleProjectCollapse(p.id); }}, 
            el('i', {'data-lucide': 'chevron-down', width: 16, height: 16})
        ),
        el('div', {class:'proj-color-dot', style:`background-color:${p.color}`}),
        el('span',{class: 'proj-text', textContent:p.name, title: p.name}),
        el('div', {class: 'proj-actions'},
            el('button', {class: 'btn btn-ghost btn-sm', title: 'Editar nombre', onclick: (e) => { e.stopPropagation(); e.preventDefault(); editProjectName(p.id); }}, el('i', {'data-lucide': 'edit-3', width: 14})),
            el('button', {class: 'btn btn-ghost btn-sm', title: 'Eliminar Proyecto', onclick: (e) => { e.stopPropagation(); e.preventDefault(); deleteProject(p.id); }}, el('i', {'data-lucide': 'trash-2', width: 14})) // Botón Eliminar Proyecto
        )
    );
    if (p.id === S.activeProject) item.classList.add('active');
    list.appendChild(item);

    // 2. Crear la lista de carpetas para este proyecto
    const folderWrap = el('div', {class: 'mj-folder-list'});
    const folders = (S.folders[p.id] || ['General']);
    
    folders.forEach(f => {
        const folderRow = el('a', {
            class: 'mj-folder-row',
            href: `#!project/${p.id}/folder/${encodeURIComponent(f)}`,
            onclick: (e) => {
                e.preventDefault();
                history.pushState({view: `project/${p.id}/folder/${f}`}, '', `#!project/${p.id}/folder/${encodeURIComponent(f)}`);
                openProject(p.id, f); // Pasa la carpeta a openProject
            }
        },
            el('span', {class: 'dot', style: `background-color:${p.color}`}),
            el('span', {class: 'label', textContent: f, title: f}),
            el('div', {class: 'mj-folder-actions'},
                 el('button', {class: 'btn btn-ghost btn-sm', title: 'Renombrar Carpeta', onclick: (e) => { e.stopPropagation(); e.preventDefault(); editFolderName(p.id, f); }}, el('i', {'data-lucide': 'edit-3', width: 14})),
                 // Solo permite eliminar si no es 'General'
                 f !== 'General' ? el('button', {class: 'btn btn-ghost btn-sm', title: 'Eliminar Carpeta', onclick: (e) => { e.stopPropagation(); e.preventDefault(); deleteFolder(p.id, f); }}, el('i', {'data-lucide': 'trash-2', width: 14})) : null
            )
        );
        folderWrap.appendChild(folderRow);
    });
    list.appendChild(folderWrap);
  });
  
  // 3. Actualiza el estado activo de los botones de navegación global
  $$('.navBtn[data-nav]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.nav === S.activeNav && !S.activeProject);
  });

  lucide.createIcons();
}

/**
 * Cambia el estado de plegado/desplegado de un proyecto en el aside.
 */
function toggleProjectCollapse(projectId) {
    S.ui.projectCollapsedState[projectId] = !S.ui.projectCollapsedState[projectId];
    save();
    renderAside(); // Re-renderiza para aplicar el cambio visual
}


/**
 * Muestra una sección principal (módulo global).
 * @param {string} sectionId - ID del módulo a mostrar.
 */
function show(sectionId){
  // Oculta todas las secciones
  $$('main > section').forEach(s => s.style.display = 'none');
  // Muestra la sección solicitada
  const s = $('#'+sectionId);  
  if(s) s.style.display='block';
  
  // Actualiza el estado
  S.activeProject = null;
  S.activeNav = sectionId;
  save();
  
  renderAside();
  document.body.classList.remove('aside-open'); // Cierra el menú móvil
  
  // Renderiza el contenido específico del módulo
  switch(sectionId) {
    case 'ai-global-chat': renderGlobalAIChat(); break;
    case 'cronopost': renderCronoPOST(); break;
    case 'hub': renderHub(); break;
    case 'gchat': renderGChat(); break;
    case 'monet': renderMonetAssistant(); break;
    case 'mindset': setupMindset(); break;
  }
}

/**
 * Abre un proyecto específico.
 * @param {string} id - ID del proyecto.
 * @param {string} [folderName='General'] - Carpeta específica a activar.
 */
function openProject(id, folderName = 'General') {
  S.activeProject = id;
  S.activeNav = null;
  S.ui.taskView = 'board'; // Default a vista de tablero
  
  // Asegura que la carpeta exista antes de activarla
  if (!(S.folders[id] || []).includes(folderName)) {
      console.warn(`Folder "${folderName}" not found in project ${id}. Defaulting to 'General'.`);
      folderName = 'General';
  }
  S.ui.activeFolder = folderName; 
  save();
  
  // Oculta módulos globales y muestra el shell del proyecto
  $$('main > section').forEach(s => s.style.display = 'none');
  $('#projectShell').style.display='block';
  
  const p = S.projects.find(x=>x.id===id);
  $('#projectNameChip').textContent = p?.name || 'Proyecto';
  $('#projectNameChip').style.borderLeft = `3px solid ${p?.color || 'var(--brand)'}`;

  // Carga las carpetas del proyecto en el selector
  renderFolderSelector(); 

  renderAside();
  renderProject(); // Renderiza todos los sub-módulos del proyecto
  $('#projectShell .tabs .tab[data-ptab="overview"]')?.click(); // Activa la pestaña de overview
  document.body.classList.remove('aside-open'); // Cierra el menú móvil
}

/**
 * Renderiza el selector de carpetas y asigna su listener.
 */
function renderFolderSelector() {
    const projId = S.activeProject;
    if (!projId) return;
    const folderSel = $('#folderSel');
    folderSel.innerHTML = '';
    
    (S.folders[projId] || ['General']).forEach(f => folderSel.append(el('option', {textContent: f, value: f})));
    
    // Mantiene la carpeta seleccionada si existe, sino va a 'General'
    const currentFolder = (S.folders[projId] || []).includes(S.ui.activeFolder) ? S.ui.activeFolder : 'General';
    folderSel.value = currentFolder;
    S.ui.activeFolder = currentFolder; // Asegura que esté en el estado
    
    // Asigna listener para cambiar de carpeta (solo si no existe ya)
    if (!folderSel.dataset.listenerAttached) {
        folderSel.addEventListener('change', (e) => {
            S.ui.activeFolder = e.target.value;
            save();
            // Actualiza la URL
            history.pushState({view: `project/${projId}/folder/${S.ui.activeFolder}`}, '', `#!project/${projId}/folder/${encodeURIComponent(S.ui.activeFolder)}`);
            renderTasks(); // Re-renderiza las tareas al cambiar de carpeta
        });
        folderSel.dataset.listenerAttached = 'true';
    }
}


/**
 * Llama a todas las funciones de renderizado de los sub-módulos del proyecto.
 */
function renderProject() {
    renderOverview();
    renderCalendar();
    renderNotes();
    renderTables();
    renderFiles();
    renderProjectChat();
    renderFin();
    renderTasks(); // Renderiza Tareas (que sí usa carpetas)
}

/* ============================================================================
SECCIÓN 4: CRUD DE PROYECTOS Y CARPETAS
============================================================================
*/

/**
 * Muestra un modal para crear un nuevo proyecto y lo inicializa.
 */
function createNewProject() {
    showInputModal('Crear Nuevo Proyecto', 'Dale un nombre a tu nuevo espacio de trabajo.', 'Ej: Lanzamiento App Móvil', (name) => {
        const id = 'p' + Date.now();
        const color = `hsl(${Math.random() * 360}, 70%, 60%)`;
        
        // Inicializa el estado para el nuevo proyecto
        S.projects.push({id, name, color, taskColumns: ['Backlog','En curso','Bloqueado','Hecho']});
        S.folders[id]=['General'];
        S.tasks[id]= { 'General': [] }; // Estructura inicial de tareas por carpeta
        S.notes[id]={list:[], active:null, bodies:{}, drawings:{}}; 
        S.chats[id]={threads:[], messages:{}, activeThread: null, model: 'pro'};
        S.tables[id]={list:[{id: 'tbl_default', name: 'Tabla 1'}], active: 'tbl_default', data: {'tbl_default': {cols:['Col 1'], rows:[]}}};
        S.files[id]=[];
        S.fin[id]={rows:[]};
        S.cronopost.posts[id] = {}; 
        S.cronopost.ideas[id] = [];
        S.ui.projectCollapsedState[id] = false; // Inicia expandido
        
        addIntis(50, 'Proyecto nuevo');
        showToast('Proyecto creado!', 'success');
        save();
        
        // Navega al nuevo proyecto
        history.pushState({view: `project/${id}`}, '', `#!project/${id}`);
        openProject(id, 'General');
        renderAside(); // Renderiza el aside para mostrar el nuevo proyecto
    });
}

/**
 * Edita el nombre de un proyecto.
 */
function editProjectName(projectId) {
    const project = S.projects.find(p => p.id === projectId);
    if (!project) return;
    
    showInputModal('Editar Proyecto', 'Nuevo nombre para el proyecto:', project.name, (newName) => {
        if (!newName || newName === project.name) return;
        project.name = newName;
        save();
        renderAside();
        // Si el proyecto está abierto, actualiza el chip
        if (S.activeProject === projectId) {
             $('#projectNameChip').textContent = newName;
        }
        showToast('Proyecto renombrado', 'success');
    }, project.name);
}

/**
 * Elimina un proyecto completo (con confirmación).
 */
function deleteProject(projectId) {
    const project = S.projects.find(p => p.id === projectId);
    if (!project) return;

    showInputModal('Confirmar Eliminación de Proyecto', `Esto eliminará el proyecto "${project.name}" y TODO su contenido (tareas, notas, etc.). Esta acción es IRREVERSIBLE. Escribe "eliminar" para confirmar.`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            // Elimina todos los datos asociados
            S.projects = S.projects.filter(p => p.id !== projectId);
            delete S.folders[projectId];
            delete S.tasks[projectId];
            delete S.notes[projectId];
            delete S.chats[projectId];
            delete S.tables[projectId];
            delete S.files[projectId];
            delete S.fin[projectId];
            delete S.cronopost.posts[projectId];
            delete S.cronopost.ideas[projectId];
            delete S.ui.projectCollapsedState[projectId];
            
            // Si era el proyecto activo, navega a la vista por defecto
            if (S.activeProject === projectId) {
                S.activeProject = null;
                S.activeNav = 'ai-global-chat'; // O la vista por defecto que prefieras
                history.pushState({view: S.activeNav}, '', `#!${S.activeNav}`);
                show(S.activeNav);
            }
            
            save();
            renderAside(); // Actualiza la lista de proyectos
            showToast(`Proyecto "${project.name}" eliminado permanentemente.`, 'info');
        }
    });
}

/**
 * Añade una nueva carpeta al proyecto activo.
 */
function addFolder() {
    const id = S.activeProject; if (!id) return;
    showInputModal('Nueva Carpeta', 'Nombre de la nueva carpeta:', 'Ej: Documentos', name => {
        if ((S.folders[id] || []).includes(name)) { // Asegura que S.folders[id] exista
            showToast(`La carpeta "${name}" ya existe.`, 'warn');
            return;
        }
        if (!S.folders[id]) S.folders[id] = []; // Inicializa si no existe
        S.folders[id].push(name);
        if (!S.tasks[id]) S.tasks[id] = {}; // Inicializa tasks si no existe
        S.tasks[id][name] = []; // Inicializa la carpeta en la estructura de tareas
        save();
        
        // Actualiza la UI y navega a la nueva carpeta
        history.pushState({view: `project/${id}/folder/${name}`}, '', `#!project/${id}/folder/${encodeURIComponent(name)}`);
        openProject(id, name); // Llama a openProject para asegurar que todo se actualice
    });
}

/**
 * Edita el nombre de una carpeta.
 */
function editFolderName(projectId, oldName) {
    if (oldName === 'General') {
        showToast('La carpeta "General" no se puede renombrar.', 'warn');
        return;
    }
    
    showInputModal('Renombrar Carpeta', `Nuevo nombre para "${oldName}":`, oldName, (newName) => {
        if (!newName || newName === oldName) return;
        if ((S.folders[projectId] || []).includes(newName)) {
            showToast(`La carpeta "${newName}" ya existe.`, 'warn');
            return;
        }

        // 1. Renombrar en la lista de carpetas
        const folderIndex = (S.folders[projectId] || []).indexOf(oldName);
        if (folderIndex > -1) {
            S.folders[projectId][folderIndex] = newName;
        }

        // 2. Renombrar la clave en S.tasks (si existe)
        if (S.tasks[projectId] && S.tasks[projectId][oldName]) {
            S.tasks[projectId][newName] = S.tasks[projectId][oldName];
            delete S.tasks[projectId][oldName];

            // 3. Actualizar la propiedad 'folder' en cada tarea
            (S.tasks[projectId][newName] || []).forEach(task => {
                task.folder = newName;
            });
        } else {
             S.tasks[projectId][newName] = []; // Crear si no existía por alguna razón
        }

        // 4. Actualizar la UI si es la carpeta activa
        if (S.activeProject === projectId && S.ui.activeFolder === oldName) {
            S.ui.activeFolder = newName;
            renderFolderSelector(); // Solo actualiza el selector, no renderiza tareas
            history.pushState({view: `project/${projectId}/folder/${newName}`}, '', `#!project/${projectId}/folder/${encodeURIComponent(newName)}`); // Actualiza URL
        }
        
        save();
        renderAside(); // Actualiza el menú lateral
        showToast('Carpeta renombrada', 'success');

    }, oldName);
}

/**
 * Elimina una carpeta (mueve tareas a 'General').
 */
function deleteFolder(projectId, folderName) {
    if (folderName === 'General') {
        showToast('La carpeta "General" no se puede eliminar.', 'warn');
        return;
    }

    showInputModal('Confirmar Eliminación de Carpeta', `Esto eliminará la carpeta "${folderName}". Las tareas dentro se moverán a "General". Escribe "eliminar" para confirmar.`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            // 1. Mover tareas a 'General'
            const tasksToMove = S.tasks[projectId]?.[folderName] || [];
            if (!S.tasks[projectId]['General']) S.tasks[projectId]['General'] = []; // Asegura que 'General' exista
            
            tasksToMove.forEach(task => {
                task.folder = 'General'; // Actualiza la propiedad folder de la tarea
                S.tasks[projectId]['General'].push(task);
            });

            // 2. Eliminar la carpeta de la lista
            S.folders[projectId] = (S.folders[projectId] || []).filter(f => f !== folderName);

            // 3. Eliminar la entrada de la carpeta en S.tasks
            delete S.tasks[projectId][folderName];

            // 4. Si era la carpeta activa, cambia a 'General'
            if (S.activeProject === projectId && S.ui.activeFolder === folderName) {
                S.ui.activeFolder = 'General';
                history.pushState({view: `project/${projectId}/folder/General`}, '', `#!project/${projectId}/folder/General`); // Actualiza URL
                renderFolderSelector(); // Actualiza el selector
                renderTasks(); // Re-renderiza las tareas ya que la vista cambió
            }

            save();
            renderAside(); // Actualiza el menú lateral
            showToast(`Carpeta "${folderName}" eliminada. Tareas movidas a General.`, 'info');
        }
    });
}


/* ============================================================================
SECCIÓN 5: SUB-MÓDULOS DE PROYECTO
============================================================================
*/

// --- 5.1: OVERVIEW ---
/**
 * Renderiza la pestaña de Overview del proyecto.
 * Cuenta todas las tareas de todas las carpetas.
 */
function renderOverview(){
    const id = S.activeProject; if(!id) return;
    const wrap = $('#ovr'); wrap.innerHTML = '';
    const p = S.projects.find(x => x.id === id);
    if (!p) return; // Seguridad si el proyecto no existe
    
    // Obtiene TODAS las tareas del proyecto, independientemente de la carpeta
    const allTasks = Object.values(S.tasks[id] || {}).flat();
    
    const finance = S.fin[id] || {rows:[]};
    const notes = S.notes[id]?.list || [];
    const files = S.files[id] || [];

    const createStatCard = (title, value, icon, color, tab) => {
        const card = el('div', { class: 'stat-card', style: `border-left: 4px solid ${color}` },
            el('div', { style: 'display:flex; align-items:center; gap:12px;' },
                el('div', { style: `padding:10px; border-radius:50%; background:color-mix(in hsl, ${color} 15%, transparent); color:${color}`}, el('i', {'data-lucide': icon})),
                el('div', {},
                    el('h4', { textContent: title }),
                    el('p', { textContent: value })
                )
            )
        );
        card.onclick = () => $(`#project-tabs .tab[data-ptab="${tab}"]`)?.click(); // Añadido optional chaining
        return card;
    };

    const doneColName = p.taskColumns[p.taskColumns.length - 1] || 'Hecho';
    const done = allTasks.filter(x => x.status === doneColName).length;
    const totalTasks = allTasks.length;
    const progress = totalTasks > 0 ? Math.round(done / totalTasks * 100) : 0;
    const sumIn = finance.rows.reduce((a, b) => a + (b.tipo === 'Ingreso' ? Number(b.monto) : 0), 0);
    const sumOut = finance.rows.reduce((a, b) => a + (b.tipo === 'Egreso' ? Number(b.monto) : 0), 0);

    wrap.append(createStatCard('Progreso de Tareas', `${progress}%`, 'check-circle', 'var(--brand)', 'tasks'));
    wrap.append(createStatCard('Tareas Pendientes', `${totalTasks - done}`, 'list-todo', 'var(--warn)', 'tasks'));
    wrap.append(createStatCard('Balance Neto', `$${(sumIn - sumOut).toFixed(2)}`, 'scale', 'var(--success)', 'finance'));
    wrap.append(createStatCard('Archivos y Notas', `${files.length + notes.length}`, 'file-text', 'var(--accent)', 'files'));

    lucide.createIcons();
}

// --- 5.2: TAREAS (KANBAN & LISTA) ---
/**
 * Renderiza la pestaña de Tareas, filtrando por carpeta activa Y por tags.
 */
function renderTasks(){
    const view = S.ui.taskView;
    const isBoardView = view === 'board';
    $('#kanban-view').style.display = isBoardView ? 'block' : 'none';
    $('#list-view').style.display = isBoardView ? 'none' : 'block';
    $('#addColumnBtn').style.display = isBoardView ? 'inline-flex' : 'none';
    $('#viewToggleBoard').classList.toggle('active', isBoardView);
    $('#viewToggleList').classList.toggle('active', !isBoardView);
    
    // Obtiene la carpeta activa y el proyecto
    const activeFolder = S.ui.activeFolder || 'General';
    const projId = S.activeProject;
    if (!projId) return;

    // Asegura que la estructura exista
    if (!S.tasks[projId]) S.tasks[projId] = { 'General': [] };
    if (!S.tasks[projId][activeFolder]) S.tasks[projId][activeFolder] = [];

    const tasksForFolder = S.tasks[projId][activeFolder];
    
    // Aplica el filtro de tags
    const tagFilter = ($('#taskTagFilter')?.value || '').toLowerCase().trim();
    const filteredTasks = tagFilter 
        ? tasksForFolder.filter(t => (t.tags || []).some(tag => tag.toLowerCase().includes(tagFilter))) 
        : tasksForFolder;

    if (isBoardView) renderTaskBoard(filteredTasks);
    else renderTaskList(filteredTasks);
}

/**
 * Renderiza el tablero Kanban con tareas filtradas (carpeta y tag).
 * @param {Array<object>} tasks - Array de tareas filtradas.
 */
function renderTaskBoard(tasks){
  const projId=S.activeProject; if(!projId) return;
  const p = S.projects.find(x => x.id === projId);
  if (!p) return; // Seguridad
  const cols = p.taskColumns || [];
  const board=$('#kanban'); board.innerHTML='';
  
  cols.forEach((c, index) => {
    const colEl=el('div',{class:'col',dataset:{status:c}},
      el('div',{class:'row col-header'}, // Usa col-header
          el('b',{textContent:c, style: 'flex: 1; white-space: normal; overflow: hidden; text-overflow: ellipsis;', title: c}), 
          el('span', {class:'chip', textContent: tasks.filter(t=>t.status===c).length}), // Usa 'tasks' (ya filtradas)
          el('div', { class: 'proj-actions', style: 'display: flex;' },
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { e.stopPropagation(); renameColumn(index); }, title: 'Renombrar' }, el('i', { 'data-lucide': 'edit-3', width: 14 })),
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { e.stopPropagation(); deleteColumn(index); }, title: 'Eliminar' }, el('i', { 'data-lucide': 'trash-2', width: 14 }))
          )
      ),
      el('div', {class: 'col-content', onclick: (e) => { 
          // Solo crea tarea si se hace click en el fondo vacío, no en una tarea
          if (e.target.classList.contains('col-content')) {
              createTaskInColumn(c); 
          }
      }}, 
        // Renderiza las tareas filtradas que pertenecen a esta columna
        ...tasks.filter(t=>t.status===c).map(t=>{
          const tagsHtml = (t.tags && t.tags.length > 0) 
            ? el('div', {class: 'task-tags'}, ...t.tags.map(tag => el('span', {class: 'task-tag', textContent: tag})))
            : null;

          const taskEl=el('div',{class:'task',draggable:'true', dataset: {id:t.id}, onclick: ()=>openTaskModal(t.id), style:'border-left: 3px solid ' + (p.color || 'var(--brand)')},
            el('div',{ textContent:t.title }),
            tagsHtml // Añade los tags aquí
          );
          taskEl.ondragstart=e=>{ e.stopPropagation(); e.dataTransfer.setData('text/plain',t.id); };
          return taskEl;
        })
      ) // Fin col-content
    );
    
    // Eventos D&D para la columna
    colEl.ondragover=e=>{e.preventDefault(); colEl.classList.add('dragover');};
    colEl.ondragleave=()=>colEl.classList.remove('dragover');
    colEl.ondrop=e=>{
      e.preventDefault(); // Asegura prevenir comportamiento por defecto
      colEl.classList.remove('dragover');
      const tid=e.dataTransfer.getData('text');
      const activeFolder = S.ui.activeFolder || 'General';
      
      // Busca la tarea en la carpeta activa
      const taskList = S.tasks[projId]?.[activeFolder];
      if (!taskList) return; // Seguridad
      
      const t=taskList.find(x=>x.id===tid);
      const doneColName = p.taskColumns[p.taskColumns.length - 1];
      if (t) { 
        if(t.status !== doneColName && c === doneColName) addIntis(10, 'Tarea completada');
        t.status=c; 
        save(); 
        renderTasks(); // Re-renderiza con filtros aplicados
        renderOverview();
      }
    };
    board.appendChild(colEl);
  });
  lucide.createIcons();
}

/**
 * Añade una nueva columna al tablero Kanban.
 */
function addColumn() {
    const id = S.activeProject; if (!id) return;
    const p = S.projects.find(x => x.id === id);
    if (!p) return;
    showInputModal('Nueva Columna', 'Nombre para la nueva columna de tareas:', 'Ej: Revisión', name => {
        if (!p.taskColumns) p.taskColumns = [];
        p.taskColumns.push(name);
        save();
        renderTasks(); // Re-renderiza (ya incluye filtrado)
    });
}

/**
 * Renombra una columna del Kanban. Afecta a TODAS las carpetas.
 * @param {number} index - Índice de la columna.
 */
function renameColumn(index) {
    const projId = S.activeProject; if (!projId) return;
    const p = S.projects.find(x => x.id === projId);
    if (!p || !p.taskColumns || !p.taskColumns[index]) return; // Seguridad
    const oldName = p.taskColumns[index];
    
    showInputModal('Renombrar Columna', `Nuevo nombre para "${oldName}":`, oldName, newName => {
        if (!newName || newName === oldName) return; 
        
        // Actualiza tareas en TODAS las carpetas
        Object.keys(S.tasks[projId] || {}).forEach(folder => {
            (S.tasks[projId][folder] || []).forEach(t => { 
                if (t.status === oldName) t.status = newName; 
            });
        });
        p.taskColumns[index] = newName;
        save();
        renderTasks(); // Re-renderiza la vista actual
    }, oldName);
}

/**
 * Elimina una columna (solo si está vacía en TODAS las carpetas).
 * @param {number} index - Índice de la columna.
 */
function deleteColumn(index) {
    const projId = S.activeProject; if (!projId) return;
    const p = S.projects.find(x => x.id === projId);
    if (!p || !p.taskColumns || !p.taskColumns[index]) return; // Seguridad
    const colName = p.taskColumns[index];
    
    // Verifica si la columna está vacía en TODAS las carpetas
    const isEmptyEverywhere = Object.values(S.tasks[projId] || {}).every(folderTasks => 
        !folderTasks.some(t => t.status === colName)
    );

    if (!isEmptyEverywhere) {
        showToast('No se puede eliminar una columna que contiene tareas en alguna carpeta.', 'warn');
        return;
    }
    
    showInputModal('Confirmar Eliminación', `¿Seguro que quieres eliminar la columna "${colName}"? Escribe "eliminar" para confirmar.`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            p.taskColumns.splice(index, 1);
            save();
            renderTasks();
        }
    });
}

/**
 * Renderiza la vista de lista de tareas filtradas (carpeta y tag).
 * @param {Array<object>} tasks - Array de tareas filtradas.
 */
function renderTaskList(tasks) {
    const projId = S.activeProject; if (!projId) return;
    const tbody = $('#task-list-table tbody');
    if (!tbody) return; // Seguridad
    tbody.innerHTML = '';
    
    // Fila para crear nueva tarea
    const newRow = el('tr', { class: 'mj-new-task-row', style: 'cursor: pointer;' },
        el('td', { colspan: 5, textContent: '+ Nueva tarea…', style: 'color: var(--sub); font-style: italic; padding: 10px 12px;' })
    );
    newRow.onclick = quickAddTask;
    tbody.append(newRow);

    tasks.forEach(t => {
        const tagsHtml = (t.tags && t.tags.length > 0)
            ? t.tags.map(tag => el('span', {class: 'task-tag', textContent: tag}) )
            : el('span', {textContent: '---', style:'color: var(--sub);'});

        const tr = el('tr', { onclick: () => openTaskModal(t.id) },
            el('td', { textContent: t.title }),
            el('td', {}, el('span', { class: 'status-badge', style: `background: color-mix(in hsl, ${getTaskStatusColor(t.status)} 20%, transparent); color: ${getTaskStatusColor(t.status)};`, textContent: t.status })),
            el('td', { textContent: t.due ? fmtDate(t.due, 'short') : '---' }),
            el('td', { style:'display: flex; gap: 4px; flex-wrap: wrap;'}, ...(Array.isArray(tagsHtml) ? tagsHtml : [tagsHtml])), // Desestructura si es array
            el('td', {}, el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { e.stopPropagation(); deleteTask(t.id); } }, el('i', { 'data-lucide': 'trash-2', width: 14 })))
        );
        tbody.append(tr);
    });
    lucide.createIcons();
}

/**
 * Devuelve un color basado en el estado de la tarea.
 * @param {string} status - Nombre del estado.
 * @returns {string} - Variable CSS de color.
 */
function getTaskStatusColor(status) {
    if (!status) return 'var(--sub)';
    const s = status.toLowerCase();
    if (s.includes('hecho') || s.includes('done') || s.includes('aprobado') || s.includes('lanzado')) return 'var(--success)';
    if (s.includes('curso') || s.includes('progress') || s.includes('progreso') || s.includes('revisión')) return 'var(--info)';
    if (s.includes('bloqueado') || s.includes('blocked')) return 'var(--danger)';
    return 'var(--sub)'; // Default
}

/**
 * Muestra un modal para añadir una tarea rápida a la carpeta activa.
 */
function quickAddTask() {
    const projId=S.activeProject; if(!projId) return;
    const p = S.projects.find(x => x.id === projId);
    if (!p) return;
    const firstColumn = p.taskColumns[0] || 'Backlog';
    const activeFolder = S.ui.activeFolder || 'General';
    
    showInputModal('Nueva Tarea', `Añadir tarea a la carpeta "${activeFolder}"`, 'Describe la tarea...', (title) => {
        if (!S.tasks[projId][activeFolder]) S.tasks[projId][activeFolder] = []; // Asegura que exista
        S.tasks[projId][activeFolder].push({id:'t'+Date.now(), title, status:firstColumn, desc:'', due:'', folder: activeFolder, tags: []}); // Añade tags vacío
        addIntis(5, 'Tarea creada');
        save(); renderTasks(); renderOverview(); renderAside();
    });
}

/**
 * Crea una tarea directamente en una columna del tablero Kanban.
 * @param {string} columnStatus - El estado de la columna donde se hizo click.
 */
function createTaskInColumn(columnStatus) {
    const projId = S.activeProject; if (!projId) return;
    const activeFolder = S.ui.activeFolder || 'General';
    showInputModal(`Nueva Tarea en "${columnStatus}"`, `Añadir tarea a la carpeta "${activeFolder}"`, 'Describe la tarea...', (title) => {
         if (!S.tasks[projId][activeFolder]) S.tasks[projId][activeFolder] = []; // Asegura que exista
         S.tasks[projId][activeFolder].push({id:'t'+Date.now(), title, status:columnStatus, desc:'', due:'', folder: activeFolder, tags: []}); // Añade tags vacío
         addIntis(5, 'Tarea creada');
         save(); renderTasks(); renderOverview(); renderAside();
    });
}


/**
 * Abre el modal de detalles de una tarea y carga las carpetas y tags.
 * @param {string} taskId - ID de la tarea.
 */
function openTaskModal(taskId) {
    const projId = S.activeProject;
    if (!projId) return;
    const activeFolder = S.ui.activeFolder || 'General';
    const p = S.projects.find(x => x.id === projId);
    if (!p) return;
    
    // Busca la tarea en la carpeta activa (o en todas si falla)
    let task = S.tasks[projId]?.[activeFolder]?.find(t => t.id === taskId);
    let taskOriginFolder = activeFolder; // Guarda la carpeta original
    
    if (!task) {
        console.warn(`Task ${taskId} not found in active folder ${activeFolder}, searching globally...`);
        for (let folderName in S.tasks[projId]) {
            task = S.tasks[projId][folderName].find(t => t.id === taskId);
            if (task) {
                console.log(`Task ${taskId} found in folder ${folderName}`);
                taskOriginFolder = folderName;
                // No cambiamos S.ui.activeFolder aquí, solo usamos taskOriginFolder
                break;
            }
        }
    }

    if (!task) {
        showToast('Error: No se encontró la tarea.', 'danger');
        return;
    }
    
    $('#taskDetailId').value = task.id;
    $('#taskDetailTitle').value = task.title;
    $('#taskDetailDesc').value = task.desc || '';
    $('#taskDetailDue').value = task.due ? task.due.split('T')[0] : ''; // Formato YYYY-MM-DD para input date
    
    // Carga estados
    const statusSel = $('#taskDetailStatus');
    statusSel.innerHTML = '';
    (p.taskColumns || []).forEach(s => {
        statusSel.append(el('option', { value: s, textContent: s }));
    });
    statusSel.value = task.status;
    
    // Carga carpetas
    const folderSel = $('#taskDetailFolder');
    folderSel.innerHTML = '';
    (S.folders[projId] || ['General']).forEach(f => {
        folderSel.append(el('option', { value: f, textContent: f}));
    });
    folderSel.value = task.folder || 'General'; // Carpeta actual de la tarea
    
    // Carga tags
    $('#taskDetailTags').value = (task.tags || []).join(', ');

    // Guarda la carpeta original en un dataset para usarla al guardar
    $('#taskDetailModal').dataset.originFolder = taskOriginFolder; 
    
    $('#taskDetailModal').showModal();
    lucide.createIcons();
}

/**
 * Guarda los cambios desde el modal de detalles de tarea, incluyendo carpeta y tags.
 */
function saveTaskDetails() {
    const projId = S.activeProject;
    if (!projId) return;
    const p = S.projects.find(x => x.id === projId);
    if (!p) return;
    
    const taskId = $('#taskDetailId').value;
    const modal = $('#taskDetailModal');
    const oldFolder = modal.dataset.originFolder || S.ui.activeFolder || 'General'; // Carpeta de donde viene
    const newFolder = $('#taskDetailFolder').value;
    
    // Encuentra la tarea y su índice en la carpeta ORIGINAL
    let taskIndex = -1;
    let task = null;
    if (S.tasks[projId]?.[oldFolder]) {
         taskIndex = S.tasks[projId][oldFolder].findIndex(t => t.id === taskId);
         if (taskIndex !== -1) {
             task = S.tasks[projId][oldFolder][taskIndex];
         }
    }
    
    if (!task) {
        console.error(`Task ${taskId} not found in origin folder ${oldFolder} for saving details.`);
        showToast('Error al guardar la tarea.', 'danger');
        modal.close();
        return;
    }

    const oldStatus = task.status;
    const newStatus = $('#taskDetailStatus').value;
    const doneColName = p.taskColumns[p.taskColumns.length - 1];

    // Actualiza datos de la tarea
    task.title = $('#taskDetailTitle').value.trim();
    task.desc = $('#taskDetailDesc').value.trim();
    task.due = $('#taskDetailDue').value; // Guarda como YYYY-MM-DD
    task.status = newStatus;
    task.folder = newFolder; // Actualiza la carpeta
    // Actualiza tags: limpia, separa por coma, quita espacios y vacíos
    task.tags = ($('#taskDetailTags').value || '')
                  .split(',')
                  .map(tag => tag.trim())
                  .filter(tag => tag !== ''); 

    // Mover la tarea si la carpeta cambió
    if (oldFolder !== newFolder) {
        // Quita de la carpeta vieja
        S.tasks[projId][oldFolder].splice(taskIndex, 1);
        // Añade a la carpeta nueva (asegura que exista)
        if (!S.tasks[projId][newFolder]) S.tasks[projId][newFolder] = [];
        S.tasks[projId][newFolder].push(task);
        // Si la carpeta activa ERA la antigua, actualízala a la nueva
        if (S.ui.activeFolder === oldFolder) {
             $('#folderSel').value = newFolder; // Actualiza visualmente el selector
             S.ui.activeFolder = newFolder;
             history.pushState({view: `project/${projId}/folder/${newFolder}`}, '', `#!project/${projId}/folder/${encodeURIComponent(newFolder)}`); // Actualiza URL
        }
    }
    
    // Gamificación
    if (oldStatus !== doneColName && newStatus === doneColName) {
        addIntis(10, 'Tarea completada');
    }
    
    save();
    renderTasks(); // Re-renderiza las tareas (con filtro si aplica)
    renderOverview();
    renderCalendar();
    renderCronoPOST();
    renderAside(); // Actualiza contadores
    modal.close();
    delete modal.dataset.originFolder; // Limpia la carpeta de origen
}

/**
 * Elimina una tarea (de su carpeta actual).
 * @param {string} taskId - ID de la tarea.
 */
function deleteTask(taskId) {
    const projId = S.activeProject;
    if (!projId) return;
    
    // Encuentra la carpeta de la tarea
    let taskFolder = null;
    let taskIndex = -1;
    for (const folderName in (S.tasks[projId] || {})) {
        const index = S.tasks[projId][folderName].findIndex(t => t.id === taskId);
        if (index > -1) {
            taskFolder = folderName;
            taskIndex = index;
            break;
        }
    }

    if (!taskFolder) {
        showToast('Error: No se pudo encontrar la tarea para eliminar.', 'danger');
        return;
    }
    
    showInputModal('Confirmar Eliminación', `¿Seguro que quieres eliminar esta tarea? Escribe "eliminar" para confirmar.`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            S.tasks[projId][taskFolder].splice(taskIndex, 1);
            save(); 
            renderTasks(); // Re-renderiza la vista actual
            renderOverview(); 
            renderCalendar(); 
            renderCronoPOST();
            renderAside(); // Actualiza contadores
            $('#taskDetailModal').close(); // Cierra si estaba abierto
            showToast('Tarea eliminada.', 'info');
        }
    });
}

// --- 5.3: CALENDARIO (PROYECTO) ---
let calRef=new Date(); // Referencia de fecha para el calendario del proyecto

/**
 * Renderiza el calendario del proyecto, mostrando tareas de la CARPETA ACTIVA.
 * CORREGIDO: Manejo de fechas para D&D.
 */
function renderCalendar(){
  const projId=S.activeProject; if(!projId) return;
  const activeFolder = S.ui.activeFolder || 'General';
  $('#monthLbl').textContent = calRef.toLocaleString('es', {month:'long', year:'numeric'});
  const grid=$('#calGrid'); grid.innerHTML='';
  
  const monthGrid = (ref=new Date()) => {
      const y=ref.getFullYear(), m=ref.getMonth();
      const first=new Date(y,m,1);
      const start = new Date(first); start.setDate(1-((first.getDay()+6)%7)); // Empieza en Lunes
      const days=[]; let cur=new Date(start);
      // Genera 42 días para cubrir 6 semanas
      while(days.length < 42){ days.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
      return days;
  }
  
  const projColor = S.projects.find(p=>p.id===projId)?.color || 'var(--brand)';
  // Obtiene tareas SÓLO de la carpeta activa
  const tasksForFolder = S.tasks[projId]?.[activeFolder] || [];
  
  monthGrid(calRef).forEach(d=>{
    // CORRECCIÓN TIMEZONE: Obtener YYYY-MM-DD local
    const localYear = d.getFullYear();
    const localMonth = String(d.getMonth() + 1).padStart(2, '0');
    const localDay = String(d.getDate()).padStart(2, '0');
    const localDateString = `${localYear}-${localMonth}-${localDay}`; // YYYY-MM-DD
    const dateKeyForComparison = d.toDateString(); // Para comparación simple con datos guardados (si no usan YYYY-MM-DD)

    const day=el('div',{class:'day', dataset: {localDate: localDateString}}); // Guarda YYYY-MM-DD local
    if(d.getMonth() !== calRef.getMonth()) day.style.opacity = .4;
    day.append(el('div',{class:'sub', textContent:d.getDate()}));
    day.onclick = () => createTaskOnDate(d); // Usa el objeto Date original para crear
    
    day.ondragover = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; day.classList.add('dragover'); };
    day.ondragleave = () => { day.classList.remove('dragover'); };
    day.ondrop = (e) => {
        e.preventDefault();
        day.classList.remove('dragover');
        const taskId = e.dataTransfer.getData('text/plain');
        if (!taskId || !projId) return;

        // Busca la tarea SÓLO en la carpeta activa
        const task = S.tasks[projId]?.[activeFolder]?.find(t => t.id === taskId);

        if (task) {
            // CORRECCIÓN TIMEZONE: Guarda la fecha local YYYY-MM-DD
            task.due = day.dataset.localDate; 
            save();
            renderCalendar(); 
            renderCronoPOST(); 
            renderTasks(); // Re-renderiza tareas
        }
    };
    
    // Renderiza las tareas (de la carpeta activa) en el día
    // CORRECCIÓN TIMEZONE: Compara usando YYYY-MM-DD o toDateString según cómo se guarde 'due'
    tasksForFolder.filter(t => t.due && (t.due === localDateString || new Date(t.due).toDateString() === dateKeyForComparison)).forEach(t => {
        const taskEl = el('div', { 
            class: 'cal-task', 
            textContent: t.title, 
            style: `border-left-color: ${projColor}`,
            draggable: 'true',
            title: t.title
        });
        taskEl.onclick = (e) => { 
            e.stopPropagation(); 
            openTaskModal(t.id); 
        };
        taskEl.ondragstart = (e) => {
            e.stopPropagation(); 
            e.dataTransfer.setData('text/plain', t.id);
            e.dataTransfer.effectAllowed = 'move';
        };
        day.append(taskEl);
    });
    grid.append(day);
  });
}

/**
 * Crea una tarea en una fecha específica, asignándola a la carpeta activa.
 * CORREGIDO: Guarda la fecha en formato YYYY-MM-DD local.
 * @param {Date} date - Fecha seleccionada (objeto Date local).
 */
function createTaskOnDate(date) {
    const projId = S.activeProject; if (!projId) return;
    const p = S.projects.find(x => x.id === projId);
    if (!p) return;
    const firstColumn = p.taskColumns[0] || 'Backlog';
    const activeFolder = S.ui.activeFolder || 'General'; // Usa la carpeta activa
    
    // CORRECCIÓN TIMEZONE: Formatea a YYYY-MM-DD local para guardar
    const localYear = date.getFullYear();
    const localMonth = String(date.getMonth() + 1).padStart(2, '0');
    const localDay = String(date.getDate()).padStart(2, '0');
    const localDateString = `${localYear}-${localMonth}-${localDay}`; // YYYY-MM-DD
    
    showInputModal('Nueva Tarea', `Crear tarea para ${fmtDate(date, 'short')} en carpeta "${activeFolder}"`, 'Describe la tarea...', (title) => {
        const newTask = { 
            id: 't' + Date.now(), 
            title, 
            status: firstColumn, 
            desc: '', 
            due: localDateString, // Guarda YYYY-MM-DD local
            folder: activeFolder, // Asigna la carpeta
            tags: []
        };
        if (!S.tasks[projId][activeFolder]) S.tasks[projId][activeFolder] = []; // Asegura
        S.tasks[projId][activeFolder].push(newTask);
        addIntis(5, 'Tarea creada');
        save();
        renderTasks(); renderCalendar(); renderOverview(); renderAside();
    });
}

// --- 5.4: NOTAS Y LIENZO ---
let currentDrawingNoteId = null; // Mueve la declaración aquí
function renderNotes(){ 
    const id=S.activeProject; if(!id) return;
    // Asegura inicialización si falta
    if (!S.notes[id]) S.notes[id] = { list: [], active: null, bodies: {}, drawings: {} };
    const N=S.notes[id];
    const list=$('#noteList'); list.innerHTML='';
    
    N.list.forEach(n=>{
        const item = el('div',{class:'projItem', onclick:()=>{N.active=n.id; save(); renderNotes();}},
            el('span', {textContent: n.title}),
            el('span', {class: 'spacer'}),
            el('button', {class: 'btn btn-ghost btn-sm', onclick: e => {e.stopPropagation(); deleteNote(n.id)}}, el('i', {'data-lucide': 'trash-2', width: 14}))
        );
        if(n.id===N.active) item.classList.add('active');
        list.append(item);
    });
    
    if(!N.active && N.list.length > 0) {
        N.active=N.list[0].id;
        // No guardes aquí, solo actualiza la UI
    }
    
    const editor = $('#noteEditor');
    editor.innerHTML = (N.active? (N.bodies[N.active]||'') : 'Selecciona o crea una nota para empezar.');
    // Quita el oninput y usa un listener más robusto
    if (editor.dataset.listenerAttached !== 'true') {
        editor.addEventListener('input', () => { 
            const currentProjectId = S.activeProject; // Captura el ID en el momento del listener
            if (currentProjectId && S.notes[currentProjectId]?.active) { 
                S.notes[currentProjectId].bodies[S.notes[currentProjectId].active] = editor.innerHTML; 
                save(); // Considera un debounce aquí si hay problemas de rendimiento
            } 
        });
        editor.dataset.listenerAttached = 'true';
    }
    
    if (N.active && N.active !== currentDrawingNoteId) {
        initDrawingCanvas(N.active);
        currentDrawingNoteId = N.active;
    } else if (!N.active) {
        const canvas = $('#drawingCanvas'); if (!canvas) return; const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        currentDrawingNoteId = null; // Resetea si no hay nota activa
    }
    lucide.createIcons();
}
function createNewNote() { 
    const id=S.activeProject; if(!id) return; 
    showInputModal('Nueva Nota', 'Título de la nueva nota:', 'Ej: Ideas para reunión', (t) => {
        const nid='n'+Date.now(); 
        if (!S.notes[id]) S.notes[id] = { list: [], active: null, bodies: {}, drawings: {} }; // Asegura inicialización
        S.notes[id].list.push({id:nid,title:t}); 
        S.notes[id].active=nid; 
        S.notes[id].bodies[nid]=''; 
        S.notes[id].drawings[nid]='';
        addIntis(5, 'Nota creada');
        save(); 
        renderNotes();
    });
}
function deleteNote(noteId) { 
     showInputModal('Confirmar Eliminación', `¿Eliminar esta nota? Escribe "eliminar".`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            const id = S.activeProject;
            if (!S.notes[id]) return; // Seguridad
            S.notes[id].list = S.notes[id].list.filter(n => n.id !== noteId);
            delete S.notes[id].bodies[noteId];
            delete S.notes[id].drawings[noteId];
            if (S.notes[id].active === noteId) {
                S.notes[id].active = S.notes[id].list.length > 0 ? S.notes[id].list[0].id : null;
            }
            save();
            renderNotes();
        }
    });
}
function initDrawingCanvas(noteId) { 
    const canvas = $('#drawingCanvas'); if (!canvas) return;
    const ctx = canvas.getContext('2d');
    
    // Ajusta tamaño del canvas a su contenedor si ha cambiado
    if (canvas.width !== canvas.clientWidth || canvas.height !== canvas.clientHeight) {
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
    }

    let drawing = false;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Carga el dibujo guardado
    const currentProjectId = S.activeProject; // Captura el ID actual
    if (S.notes[currentProjectId]?.drawings?.[noteId]) {
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        img.onerror = () => console.error("Error loading drawing image for note:", noteId);
        img.src = S.notes[currentProjectId].drawings[noteId];
    }

    const getCoords = (e) => {
        const rect = canvas.getBoundingClientRect();
        const event = e.touches ? e.touches[0] : e;
        // Escala las coordenadas al tamaño real del canvas
        const x = (event.clientX - rect.left) * (canvas.width / rect.width);
        const y = (event.clientY - rect.top) * (canvas.height / rect.height);
        return {x, y};
    };

    let lastX, lastY; // Para suavizar líneas táctiles
    const start = (e) => { 
        e.preventDefault(); 
        drawing = true; 
        const {x, y} = getCoords(e);
        lastX = x; lastY = y;
        ctx.beginPath();
        ctx.moveTo(x, y);
    };
    const end = (e) => {
        if (!drawing) return;
        drawing = false; 
        ctx.beginPath(); // Finaliza la línea actual
        
        // Guarda el canvas como Data URL (con manejo de errores)
        try {
           const activeNoteIdNow = S.notes[currentProjectId]?.active; // Verifica si la nota sigue activa
           if (activeNoteIdNow === noteId) { // Solo guarda si la nota no cambió mientras dibujabas
             S.notes[currentProjectId].drawings[noteId] = canvas.toDataURL(); 
             save();
           } else {
             console.warn("Note changed while drawing, drawing not saved.");
           }
        } catch (err) {
            console.error("Error saving canvas data:", err);
            showToast("Error al guardar el dibujo.", "danger");
        }
    };
    const draw = (e) => {
        if (!drawing) return; 
        e.preventDefault();
        const {x, y} = getCoords(e);
        ctx.lineWidth = $('#canvasStrokeSlider').value; ctx.lineCap = 'round';
        ctx.strokeStyle = $('#canvasColorPicker').value;
        ctx.lineTo(x, y); ctx.stroke();
        ctx.beginPath(); // Empieza nuevo trazo
        ctx.moveTo(x, y);
        lastX = x; lastY = y;
    };
    
    // Reemplaza el canvas para limpiar listeners antiguos (más robusto)
    const newCanvas = canvas.cloneNode(true);
    canvas.parentNode.replaceChild(newCanvas, canvas);
    const newCtx = newCanvas.getContext('2d'); // Usa el nuevo contexto
    
    // Carga el dibujo existente en el nuevo canvas
    if (S.notes[currentProjectId]?.drawings?.[noteId]) {
        const img = new Image();
        img.onload = () => newCtx.drawImage(img, 0, 0, newCanvas.width, newCanvas.height);
        img.src = S.notes[currentProjectId].drawings[noteId];
    }
    
    // Añade listeners al nuevo canvas
    newCanvas.addEventListener('mousedown', start); 
    newCanvas.addEventListener('mouseup', end); 
    newCanvas.addEventListener('mousemove', draw);
    newCanvas.addEventListener('mouseleave', end); // Termina si el ratón sale

    newCanvas.addEventListener('touchstart', start, { passive: false }); 
    newCanvas.addEventListener('touchend', end, { passive: false }); 
    newCanvas.addEventListener('touchmove', draw, { passive: false });
    newCanvas.addEventListener('touchcancel', end, { passive: false }); // Termina si se cancela el toque
}
function exportNote(format) { 
    const id = S.activeProject; const noteId = S.notes[id]?.active;
    if (!noteId) return showToast("Selecciona una nota para exportar.", "warn");
    const title = S.notes[id].list.find(n => n.id === noteId)?.title || "Nota";
    const contentHTML = S.notes[id].bodies[noteId] || "";
    if (format === 'pdf') {
        try {
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF();
            doc.text(title, 10, 10);
            
            // Intenta renderizar HTML, con fallback a texto plano si falla
            doc.html(contentHTML, { 
                callback: (doc) => { 
                    try {
                        doc.save(`${title}.pdf`); 
                    } catch (saveErr) {
                         console.error("jsPDF save error:", saveErr);
                         showToast("Error al guardar el PDF.", "danger");
                    }
                }, 
                x: 10, 
                y: 20, 
                width: 180, 
                windowWidth: 800,
                html2canvas: { scale: 0.25 } // Escala baja para evitar problemas de tamaño
            }).catch(htmlErr => {
                 console.error("jsPDF html rendering error:", htmlErr);
                 showToast("Error al generar el PDF desde HTML, exportando como texto.", "warn");
                 // Fallback a texto plano
                 const textContent = el('div', {html: contentHTML}).textContent || "";
                 doc.text(textContent, 10, 20, { maxWidth: 180 });
                 doc.save(`${title}_texto.pdf`);
            });
        } catch (pdfErr) {
            console.error("jsPDF initialization error:", pdfErr);
            showToast("Error al inicializar la exportación a PDF.", "danger");
        }
    }
}

// --- 5.5: TABLAS --- 
function renderTables(){ 
  const id=S.activeProject; if(!id) return;
  // Asegura inicialización si falta
  if (!S.tables[id]) S.tables[id] = { list: [{id: 'tbl_default', name: 'Tabla 1'}], active: 'tbl_default', data: {'tbl_default': {cols:['Col 1'], rows:[]}} };
  const T_PROJ = S.tables[id];
  
  const selector = $('#tableSelector');
  selector.innerHTML = '';
  T_PROJ.list.forEach(t => selector.append(el('option',{value:t.id, textContent:t.name})));
  // Asegura que el valor activo exista en la lista
  if (!T_PROJ.list.find(t => t.id === T_PROJ.active) && T_PROJ.list.length > 0) {
      T_PROJ.active = T_PROJ.list[0].id;
      save(); // Guarda el cambio de tabla activa
  }
  selector.value = T_PROJ.active;

  const wrap=$('#sheetWrap'); wrap.innerHTML='';
  const T_DATA = T_PROJ.data[T_PROJ.active];

  if (!T_DATA || !T_DATA.cols || T_DATA.cols.length === 0) {
      wrap.innerHTML = `<div class="empty-state"><i data-lucide="table-2" width="48" height="48"></i><h4>Tabla vacía.</h4><p>Añade columnas y filas para empezar.</p></div>`;
      lucide.createIcons(); return;
  }
  
  const tbl=el('table',{style:'width:100%; border-collapse: collapse; min-width: 600px;'});
  // Cabecera con botón de eliminar columna
  const thead=el('thead',{}, el('tr',{}, 
      ...T_DATA.cols.map((c,ci)=>el('th',{style:'border: 1px solid var(--line); padding: 8px; position:relative;'}, 
          el('span', {textContent: c}),
          el('button', {
              class: 'btn btn-ghost btn-sm', 
              style:'position:absolute; top:2px; right:2px; padding: 2px;', 
              title: 'Eliminar Columna',
              onclick: () => deleteTableColumn(ci)
            }, 
            el('i', {'data-lucide': 'x', width: 14})
          )
      ))
  ));
  const tbody=el('tbody',{});
  (T_DATA.rows || []).forEach((r,ri)=>{
    const tr=el('tr',{}, 
        ...T_DATA.cols.map((c,ci)=>el('td',{style:'border: 1px solid var(--line); padding: 0;'}, 
            el('input',{value:r[ci]||'', style:'border:none; background:transparent; padding: 8px; width: 100%; height: 100%;', 
                onchange:(e)=>{r[ci]=e.target.value; save();}
            })
        )),
        // Botón eliminar fila
        el('td', {style:'border: 1px solid var(--line); padding: 0; width: 40px; text-align: center;'},
            el('button', {
                class: 'btn btn-ghost btn-sm', 
                style: 'padding: 4px;', 
                title: 'Eliminar Fila',
                onclick: () => deleteTableRow(ri)
              }, 
              el('i', {'data-lucide':'trash-2', width:14})
            )
        )
    );
    tbody.appendChild(tr);
  });
  tbl.append(thead,tbody);
  wrap.append(tbl);
  lucide.createIcons();
}
function createNewTable() { 
    const id = S.activeProject; if (!id) return;
    showInputModal('Nueva Tabla', `Nombre de la nueva tabla:`, `Tabla ${S.tables[id].list.length + 1}`, (name) => {
        const tableId = 'tbl_' + Date.now();
        S.tables[id].list.push({ id: tableId, name: name });
        S.tables[id].data[tableId] = { cols: ['Nueva Columna'], rows: [['']] };
        S.tables[id].active = tableId;
        addIntis(5, 'Tabla creada');
        save(); renderTables();
    });
}
function deleteTableColumn(colIndex) {
    const projId = S.activeProject; if (!projId) return;
    const activeTableId = S.tables[projId]?.active;
    if (!activeTableId) return;
    const tableData = S.tables[projId].data[activeTableId];
    if (!tableData || !tableData.cols || colIndex < 0 || colIndex >= tableData.cols.length) return;

    showInputModal('Confirmar Eliminación', `¿Eliminar la columna "${tableData.cols[colIndex]}"? Escribe "eliminar".`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            tableData.cols.splice(colIndex, 1);
            (tableData.rows || []).forEach(row => row.splice(colIndex, 1));
            save();
            renderTables();
        }
    });
}
function deleteTableRow(rowIndex) {
    const projId = S.activeProject; if (!projId) return;
    const activeTableId = S.tables[projId]?.active;
    if (!activeTableId) return;
    const tableData = S.tables[projId].data[activeTableId];
    if (!tableData || !tableData.rows || rowIndex < 0 || rowIndex >= tableData.rows.length) return;
    
    tableData.rows.splice(rowIndex, 1);
    save();
    renderTables();
}


// --- 5.6: ARCHIVOS ---
function renderFiles(){ 
  const id=S.activeProject; if(!id) return;
  // Asegura inicialización
  if (!S.files[id]) S.files[id] = [];
  const L=S.files[id]; const wrap=$('#fileList'); wrap.innerHTML='';
  if (L.length === 0) {
      wrap.innerHTML = `<div class="empty-state" style="width:100%"><i data-lucide="file-up" width="48" height="48"></i><h4>No hay archivos.</h4><p>Sube documentos, imágenes, etc.</p></div>`;
      lucide.createIcons(); return;
  }
  L.forEach((f,idx)=>{
      const fileChip = el('div', {class:'chip'},  
        el('a',{href:f.url,download:f.name, textContent:f.name, target:'_blank', title:`Tamaño: ${f.size ? (f.size / 1024).toFixed(1) + ' KB' : 'N/A'}`}),
        el('button', {class: 'btn btn-ghost btn-sm', style:'padding:2px;', onclick:()=>{ L.splice(idx,1); save(); renderFiles(); renderOverview(); }}, el('i', {'data-lucide':'trash-2', width:14}))
      );
      wrap.append(fileChip);
  });
  lucide.createIcons();
}

// --- 5.7: FINANZAS (PROYECTO) ---
function renderFin(){ 
  const id=S.activeProject; if(!id) return;
  // Asegura inicialización
  if (!S.fin[id]) S.fin[id] = { rows: [] };
  const F=S.fin[id]; 
  const tbody=$('#finTable tbody'); tbody.innerHTML='';
  (F.rows || []).forEach((r,i)=>{
    const tr=el('tr',{}, 
        el('td',{textContent:fmtDate(r.fecha, 'short'), style:'padding:8px'}), 
        el('td',{textContent:r.tipo, style:'padding:8px; color:' + (r.tipo === 'Ingreso' ? 'var(--success)' : 'var(--danger)')}), 
        el('td',{textContent:'$'+Number(r.monto).toFixed(2), style:'text-align:right; padding:8px'}), 
        el('td',{textContent:r.cat, style:'padding:8px'}), 
        el('td',{textContent:r.nota, style:'padding:8px'}),
        el('td',{}, el('button',{class:'btn btn-ghost btn-sm',onclick:()=>{F.rows.splice(i,1); save(); renderFin(); renderOverview();}}, el('i',{'data-lucide':'trash-2', width:14})))
    );
    tbody.appendChild(tr);
  });
  
  const sumIn=F.rows.reduce((a,b)=>a+(b.tipo==='Ingreso' ? Number(b.monto) : 0),0);
  const sumOut=F.rows.reduce((a,b)=>a+(b.tipo==='Egreso' ? Number(b.monto) : 0),0);
  $('#finIn').textContent='$'+sumIn.toFixed(2);
  $('#finOut').textContent='$'+sumOut.toFixed(2);
  $('#finBal').textContent='$'+(sumIn-sumOut).toFixed(2);
  lucide.createIcons();
}
function addProjectFinanceMove() { 
    const id = S.activeProject; if (!id) return;
    // Asegura inicialización
    if (!S.fin[id]) S.fin[id] = { rows: [] };
    const F = S.fin[id];
    const monto = parseFloat($('#pF_Monto').value);
    const tipo = $('#pF_Tipo').value;
    const cat = $('#pF_Cat').value.trim() || 'General';
    const nota = $('#pF_Nota').value.trim();
    
    if (isNaN(monto) || monto <= 0) { // Comprueba si es NaN
        showToast('Por favor, ingresa un monto válido.', 'warn');
        return;
    }
    
    F.rows.push({ fecha: new Date().toISOString(), tipo, monto, cat, nota }); // Guarda fecha ISO
    addIntis(5, 'Movimiento financiero');
    save();
    renderFin();
    renderOverview();
    
    $('#pF_Monto').value = '';
    $('#pF_Cat').value = '';
    $('#pF_Nota').value = '';
    $('#projectFinModal').close();
}

// --- 5.8: CHAT IA (PROYECTO) ---
function renderProjectChat() { 
    const pid = S.activeProject; if (!pid) return;
    // Asegura inicialización
    if (!S.chats[pid]) S.chats[pid] = { threads: [], messages: {}, activeThread: null, model: 'pro' };
    const C = S.chats[pid];
    const list = $('#chatList'); list.innerHTML = '';
    
    (C.threads || []).forEach(th => {
        const it = el('div', { class: 'projItem', dataset: { id: th.id }, onclick: () => { C.activeThread = th.id; save(); renderProjectChat(); } },
           el('span', {textContent: th.title, style:'flex: 1; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;'})
           // Aquí podrías añadir botones de renombrar/eliminar si quieres
        );
        if (th.id === C.activeThread) it.classList.add('active');
        list.append(it);
    });
    
    if (!C.activeThread && C.threads?.length > 0) { C.activeThread = C.threads[0].id; save(); }
    
    $$('#p-tab-chat .model-card').forEach(c => c.classList.toggle('active', C.model === c.dataset.model));
    
    const log = $('#chatLog'); log.innerHTML = '';
    if (C.activeThread) {
        (C.messages[C.activeThread] || []).forEach(m => log.append(createMessageElement(m, S.hub.perfil)));
        // Scroll al final después de renderizar mensajes
        requestAnimationFrame(() => { log.scrollTop = log.scrollHeight; }); 
    }
}
function sendProjectChatMessage() { 
    const pid = S.activeProject; if (!pid) return;
    // Asegura inicialización
    if (!S.chats[pid]) S.chats[pid] = { threads: [], messages: {}, activeThread: null, model: 'pro' };
    if (!S.chats[pid]?.activeThread) {
        // Si no hay hilo activo, intenta crear uno o selecciona el primero
        if ((S.chats[pid].threads || []).length > 0) {
            S.chats[pid].activeThread = S.chats[pid].threads[0].id;
        } else {
            // Crea un hilo inicial si no hay ninguno
            const newId = 'c'+Date.now();
            S.chats[pid].threads = [{id: newId, title: 'Chat Inicial'}];
            S.chats[pid].activeThread = newId;
            S.chats[pid].messages = {[newId]: []};
        }
        save();
        renderProjectChat(); // Re-renderiza para mostrar el hilo activo
        // No envíes el mensaje aún, permite al usuario confirmar
        return; 
    }

    const msgInput = $('#chatMsg');
    const msg = msgInput.value.trim(); if (!msg) return;
    const C = S.chats[pid];
    const model = C.model;
    const cost = model === 'web' ? CREDIT_COSTS.aiChatWeb : CREDIT_COSTS.aiChatPro;
    if (!useCredits(cost)) return;
    
    const threadId = C.activeThread;
    if (!C.messages[threadId]) C.messages[threadId] = [];
    C.messages[threadId].push({ who: 'Tú', at: new Date().toISOString(), text: msg }); // Guarda fecha ISO
    msgInput.value = ''; msgInput.style.height = 'auto'; renderProjectChat();

    // Simulación de respuesta de IA
    setTimeout(() => {
        let responseText = `Como modelo de IA, mi sugerencia para "${msg}" sería dividirlo en tareas más pequeñas.`;
        if (model === 'web') responseText = `[Búsqueda Web] Para "${msg}", los resultados sugieren enfocarse en marketing de contenidos.`;
        if (msg.toLowerCase().includes('genera un botón html')) {
            responseText = `Claro, aquí tienes un botón HTML con estilos: [CODE]<!DOCTYPE html>
<html>
<head>
<style>
.myButton {
  box-shadow: inset 0px 1px 0px 0px #a4e271;
  background:linear-gradient(to bottom, #89c403 5%, #77a809 100%);
  border:1px solid #74b807;
  display:inline-block;
  cursor:pointer;
  color:#ffffff;
  font-family:Arial;
  font-size:15px;
  font-weight:bold;
  padding:6px 24px;
  text-decoration:none;
  text-shadow:0px 1px 0px #528009;
}
.myButton:hover {
  background:linear-gradient(to bottom, #77a809 5%, #89c403 100%);
}
</style>
</head>
<body>
<button class="myButton">Botón Verde</button>
</body>
</html>
[/CODE]`;
        }
        C.messages[threadId].push({ who: 'IA', at: new Date().toISOString(), text: responseText, type: model }); // Guarda fecha ISO
        save(); renderProjectChat();
    }, 1500);
}

/* ============================================================================
SECCIÓN 6: MÓDULOS GLOBALES
============================================================================
*/

// --- 6.1: ASISTENTE IA GLOBAL --- (¡ACTUALIZADO!)
const aiPrompts = [
    { title: 'Dame ideas de posts', prompt: 'Dame 5 ideas de posts para redes sociales sobre productividad para emprendedores' },
    { title: 'Crea una imagen', prompt: 'Crea una imagen de un astronauta meditando en marte, estilo acuarela' },
    { title: 'Resume un texto', prompt: 'Resume el siguiente texto en 3 puntos clave: [pega tu texto aquí]' },
    { title: 'Escribe un email', prompt: 'Escribe un email corto para un cliente potencial presentando mis servicios de desarrollo web' },
];
function renderGlobalAIChat() { 
    // Asegura inicialización
    if (!S.aiGlobalChat) S.aiGlobalChat = JSON.parse(JSON.stringify(initialState.aiGlobalChat));
    const C = S.aiGlobalChat;
    const list = $('#aiChatList'); list.innerHTML = '';
    
    C.threads.forEach(th => {
        const actions = el('div', { class: 'proj-actions' },
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { e.stopPropagation(); renameAIChat(th.id); }, title: 'Renombrar' }, el('i', { 'data-lucide': 'edit-3', width: 14 })),
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { e.stopPropagation(); showSendToProjectModal(th.id); }, title: 'Enviar a proyecto' }, el('i', { 'data-lucide': 'send', width: 14 })),
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { e.stopPropagation(); deleteAIChat(th.id); }, title: 'Eliminar' }, el('i', { 'data-lucide': 'trash-2', width: 14 }))
        );
        const it = el('div', { class: 'projItem', dataset: { id: th.id }, onclick: () => { C.activeThread = th.id; save(); renderGlobalAIChat(); } },
            el('span', { textContent: th.title, style: 'flex: 1; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;' }),
            actions
        );
        if (th.id === C.activeThread) it.classList.add('active');
        list.append(it);
    });
    
    // Si no hay hilo activo, selecciona el primero o crea uno
    if (!C.activeThread && C.threads.length > 0) {
        C.activeThread = C.threads[0].id;
        save();
    } else if (C.threads.length === 0) {
        // Crea un hilo inicial si no hay ninguno
        const newId = 'c_global_1';
        C.threads = [{id: newId, title: 'Chat General'}];
        C.activeThread = newId;
        C.messages = {[newId]: []};
        save();
        return renderGlobalAIChat(); // Llama de nuevo para renderizar
    }

    $$('#ai-global-chat .model-card').forEach(c => c.classList.toggle('active', C.model === c.dataset.model));
    
    const log = $('#aiChatLog'); log.innerHTML = '';
    const emptyHeader = $('#aiChatEmptyHeader');
    
    if (C.activeThread) {
        const messages = C.messages[C.activeThread] || [];
        if (messages.length === 0) {
            // Estado vacío: Muestra header y sugerencias
            emptyHeader.style.display = 'block';
            const suggestions = el('div', {style: 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 16px;'});
            aiPrompts.forEach(p => {
                const card = el('div', {class:'card', style: 'padding: 12px; cursor: pointer; background: var(--surface);'}, 
                  el('b', {textContent: p.title, style: 'font-size: var(--sm);'}),
                  el('p', {textContent: p.prompt, style: 'font-size: var(--xs); color: var(--sub); margin: 4px 0 0; opacity: .7;'})
                );
                card.onclick = () => { $('#aiChatMsg').value = p.prompt; $('#aiChatMsg').focus(); };
                suggestions.append(card);
            });
            log.append(suggestions);
        } else {
            // Chat con mensajes: Oculta header
            emptyHeader.style.display = 'none';
            messages.forEach(m => log.append(createMessageElement(m, S.hub.perfil)));
        }
        // Scroll al final después de renderizar
         requestAnimationFrame(() => { log.scrollTop = log.scrollHeight; });
    } else {
        // No hay thread activo (raro, pero posible)
        emptyHeader.style.display = 'block';
    }
    lucide.createIcons();
}
function renameAIChat(threadId) { 
    const C = S.aiGlobalChat;
    const thread = C.threads.find(t => t.id === threadId);
    if (!thread) return;
    showInputModal('Renombrar Conversación', 'Nuevo título:', thread.title, (newTitle) => {
        if (!newTitle || newTitle === thread.title) return;
        thread.title = newTitle;
        save();
        renderGlobalAIChat();
    }, thread.title);
}
function deleteAIChat(threadId) { 
     showInputModal('Confirmar Eliminación', `¿Eliminar esta conversación? Escribe "eliminar".`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            const C = S.aiGlobalChat;
            C.threads = C.threads.filter(t => t.id !== threadId);
            delete C.messages[threadId];
            if (C.activeThread === threadId) {
                C.activeThread = C.threads.length > 0 ? C.threads[0].id : null;
            }
            save();
            renderGlobalAIChat();
        }
    });
}
function showSendToProjectModal(threadId) { 
    const modal = $('#sendChatModal');
    const select = $('#sendChatProjectSelect');
    select.innerHTML = '';
    if (S.projects.length === 0) {
        select.append(el('option', {textContent: 'No hay proyectos para enviar'}));
        $('#sendChatConfirmBtn').disabled = true;
    } else {
        S.projects.forEach(p => select.append(el('option', {value: p.id, textContent: p.name})));
        $('#sendChatConfirmBtn').disabled = false;
    }
    
    // Asegura listener único
    const confirmBtn = $('#sendChatConfirmBtn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.onclick = () => {
        const projId = select.value;
        if (projId) {
            const C = S.aiGlobalChat;
            const thread = C.threads.find(t => t.id === threadId);
            const messages = C.messages[threadId];
            if (!thread || !messages) return;
            // Asegura inicialización del chat de proyecto
            if (!S.chats[projId]) S.chats[projId] = { threads: [], messages: {}, activeThread: null, model: 'pro' };

            const newThreadId = 'c' + Date.now();
            S.chats[projId].threads.unshift({ id: newThreadId, title: `Desde Global: ${thread.title}`});
            S.chats[projId].messages[newThreadId] = JSON.parse(JSON.stringify(messages)); // Copia profunda
            S.chats[projId].activeThread = newThreadId;
            save();
            showToast(`Chat enviado a "${S.projects.find(p=>p.id===projId).name}"`, 'success');
            
            // Navega al proyecto y pestaña
            history.pushState({view: `project/${projId}`}, '', `#!project/${projId}`);
            openProject(projId, 'General'); // Abre en General por defecto
            $('#project-tabs .tab[data-ptab="chat"]').click();
            modal.close();
        }
    };
    modal.showModal();
}
function sendGlobalAIChatMessage() { 
    const msgInput = $('#aiChatMsg');
    const msg = msgInput.value.trim(); if (!msg) return;
    const C = S.aiGlobalChat;
    if (!C || !C.activeThread) {
         showToast("Error: No hay una conversación activa.", "danger");
         return; 
    }
    const model = C.model;
    const cost = model === 'web' ? CREDIT_COSTS.aiChatWeb : CREDIT_COSTS.aiChatPro;
    if (!useCredits(cost)) return;
    
    const threadId = C.activeThread;
    if (!C.messages[threadId]) C.messages[threadId] = [];
    C.messages[threadId].push({ who: 'Tú', at: new Date().toISOString(), text: msg }); // Guarda fecha ISO
    msgInput.value = ''; msgInput.style.height = 'auto'; renderGlobalAIChat();

    // Simulación de respuesta de IA
    setTimeout(() => {
        let responseText = `Respuesta genérica para "${msg}". Recuerda que puedes enviar esta conversación a un proyecto específico.`;
         if (msg.toLowerCase().includes('genera código')) responseText = "Por supuesto, ¿qué tipo de código necesitas? Especifícalo y lo crearé para ti.";
         if (msg.toLowerCase().includes('crea una imagen')) responseText = "¡Claro! Generando imagen... [Aquí iría la imagen]";
        C.messages[threadId].push({ who: 'IA', at: new Date().toISOString(), text: responseText, type: model }); // Guarda fecha ISO
        save(); renderGlobalAIChat();
    }, 1000);
}
function createMessageElement(message, userProfile) { 
    const isMine = message.who === 'Tú';
    // Asegura que userProfile exista
    const profile = userProfile || { avatar: null }; 
    const sender = {
        name: isMine ? 'Tú' : (message.who || 'IA'), // Usa message.who si existe
        avatar: isMine ? (profile.avatar || 'https://placehold.co/40x40/dde2ed/0b132a?text=TÚ') : 'Logos HD.png'
    };
    const msgBody = el('div', { class: 'msg-body' });
    
    const codeRegex = /\[CODE\]([\s\S]*?)\[\/CODE\]/g;
    let lastIndex = 0;
    let match;
    const textToParse = message.text || ""; // Asegura que sea string
    
    while ((match = codeRegex.exec(textToParse)) !== null) {
        if (match.index > lastIndex) {
            msgBody.append(document.createTextNode(textToParse.substring(lastIndex, match.index)));
        }
        const codeContent = match[1];
        const codeBlock = el('div', { class: 'code-block' },
            el('div', { class: 'code-header' },
                el('span', { textContent: 'Código Generado' }),
                el('span', { class: 'spacer' }),
                el('button', { class: 'btn btn-sm code-preview-btn' }, el('i', {'data-lucide':'eye', width:14})),
                el('button', { class: 'btn btn-sm code-copy-btn' }, el('i', {'data-lucide':'copy', width:14})),
                el('button', { class: 'btn btn-sm code-download-btn' }, el('i', {'data-lucide':'download', width:14}))
            ),
            el('pre', {}, el('code', { textContent: codeContent })),
            el('div', { class: 'code-preview-container', style: 'display:none;' },
                el('iframe', { title: 'Vista Previa de Código' })
            )
        );
        codeBlock.querySelector('.code-preview-btn').onclick = (e) => {
            const previewContainer = e.target.closest('.code-block').querySelector('.code-preview-container');
            const iframe = previewContainer.querySelector('iframe');
            iframe.srcdoc = codeContent;
            previewContainer.style.display = previewContainer.style.display === 'none' ? 'block' : 'none';
        };
         codeBlock.querySelector('.code-copy-btn').onclick = () => {
             navigator.clipboard.writeText(codeContent).then(() => showToast('Código copiado!', 'success'), () => showToast('Error al copiar.', 'warn'));
         };
        codeBlock.querySelector('.code-download-btn').onclick = () => {
            download('codigo_generado.html', codeContent);
        };
        msgBody.append(codeBlock);
        lastIndex = match.index + match[0].length;
    }
    if (lastIndex < textToParse.length) {
        msgBody.append(document.createTextNode(textToParse.substring(lastIndex)));
    }

    const msgElement = el('div', { class: 'msg' + (isMine ? ' mine' : '') },
        el('img', { src: sender.avatar, class: 'msg-avatar', alt: sender.name }),
        el('div', { class: 'msg-content' },
            el('div', { class: 'msg-who', textContent: sender.name }),
            msgBody
        )
    );
    lucide.createIcons(); // Llama a lucide después de crear los botones
    return msgElement;
}


// --- 6.2: CRONOPOST (Calendario General) ---
let cpRef = new Date(); // Referencia de fecha para Cronopost
function renderCronoPOST() { 
    const sel = $('#cpProjectSelect'); const currentSelection = sel.value;
    sel.innerHTML = '';
    sel.append(el('option', { value: 'all', textContent: 'Todos los Proyectos' }));
    S.projects.forEach(p => sel.append(el('option', { value: p.id, textContent: p.name })));
    sel.value = S.projects.find(p => p.id === currentSelection) ? currentSelection : 'all';

    const activeProjectId = sel.value;
    $('#cpMonthLbl').textContent = cpRef.toLocaleString('es', { month: 'long', year: 'numeric' });
    const calendarEl = $('#cpCalendar'); calendarEl.innerHTML = '';
    
    const headerRow = el('div',{style:'display:contents;'});
    ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'].forEach(day => headerRow.append(el('div', { textContent: day, style: 'text-align:center; font-weight: 600; color: var(--sub); padding-bottom: 8px; font-size: var(--sm);' })));
    calendarEl.append(headerRow);
    
    const monthGrid = (ref = new Date()) => {
        const y = ref.getFullYear(), m = ref.getMonth(); const first = new Date(y, m, 1);
        const start = new Date(first); start.setDate(1 - ((first.getDay() + 6) % 7)); // Empieza en Lunes
        const days = []; let cur = new Date(start);
        // Genera 35 días (5 semanas) o 42 si el mes empieza tarde en la semana
        const numDays = (first.getDay() === 0 || first.getDay() > 4) ? 42 : 35; 
        while (days.length < numDays) { days.push(new Date(cur)); cur.setDate(cur.getDate() + 1); } return days;
    };
    
    const projectsToShow = activeProjectId === 'all' ? S.projects : S.projects.filter(p => p.id === activeProjectId);

    monthGrid(cpRef).forEach(d => {
        // CORRECCIÓN TIMEZONE: Fecha local YYYY-MM-DD
        const localYear = d.getFullYear();
        const localMonth = String(d.getMonth() + 1).padStart(2, '0');
        const localDay = String(d.getDate()).padStart(2, '0');
        const localDateString = `${localYear}-${localMonth}-${localDay}`; // YYYY-MM-DD
        const dateKeyForComparison = d.toDateString(); // Clave simple para posts

        const dayEl = el('div', { class: 'day', dataset: { localDate: localDateString, dateString: dateKeyForComparison } }); // Guarda ambos formatos
        dayEl.onclick = () => createTaskFromCronoPOST(d);
        if(d.getMonth() !== cpRef.getMonth()) dayEl.style.opacity = .5;
        dayEl.append(el('div', { textContent: d.getDate(), style: 'font-weight: 500; color: var(--sub); margin-bottom: 4px; text-align: right; font-size: var(--sm);' }));

        projectsToShow.forEach(proj => {
            // Posts (usa dateKeyForComparison - toDateString)
            const posts = S.cronopost.posts[proj.id] || {};
            (posts[dateKeyForComparison] || []).forEach((p) => {
                const postEl = el('div', { class: 'cp-post', draggable: 'true', textContent: p.title, title: `${proj.name}: ${p.title}`, style: `border-left-color:${proj.color}; background: color-mix(in hsl, ${proj.color} 15%, transparent);` });
                postEl.ondragstart = e => {
                    e.stopPropagation(); 
                    e.dataTransfer.setData('text/plain', JSON.stringify({type: 'post', id: p.id, title: p.title, fromDateString: dateKeyForComparison, fromProject: proj.id}));
                    e.dataTransfer.effectAllowed = 'move';
                };
                dayEl.append(postEl);
            });
            // Tareas (Leer de todas las carpetas, compara con localDateString Y toDateString)
            const allTasksForProject = Object.values(S.tasks[proj.id] || {}).flat();
            allTasksForProject.filter(t => t.due && (t.due === localDateString || new Date(t.due).toDateString() === dateKeyForComparison)).forEach(t => {
                const taskEl = el('div', { class: 'cal-task', draggable: 'true', textContent: `✓ ${t.title}`, title: `Tarea: ${t.title}`, style: `border-left-color:${proj.color};` });
                taskEl.dataset.folder = t.folder; // Añade la carpeta
                taskEl.ondragstart = e => {
                     e.stopPropagation();
                     e.dataTransfer.setData('text/plain', JSON.stringify({type: 'task', id: t.id, fromProject: proj.id, folder: t.folder }));
                     e.dataTransfer.effectAllowed = 'move';
                };
                dayEl.append(taskEl);
            });
        });

        // Eventos D&D
        dayEl.ondragover = (e) => { e.preventDefault(); dayEl.classList.add('dragover'); };
        dayEl.ondragleave = (e) => { dayEl.classList.remove('dragover'); };
        dayEl.ondrop = (e) => { 
            e.preventDefault(); dayEl.classList.remove('dragover');
            let data;
            try { data = JSON.parse(e.dataTransfer.getData('text/plain')); } catch(err) { console.error("Error parsing D&D data:", err); return; }

            // CORRECCIÓN TIMEZONE: Usa las fechas guardadas en el día
            const toLocalDate = dayEl.dataset.localDate; // YYYY-MM-DD
            const toDateStringKey = dayEl.dataset.dateString; // toDateString()
            
            const targetProjectId = $('#cpProjectSelect').value;
            
            if (data.type === 'idea') { 
                if (targetProjectId === 'all') { showToast('Selecciona un proyecto específico para agendar ideas.', 'warn'); return; }
                if (!S.cronopost.posts[targetProjectId]) S.cronopost.posts[targetProjectId] = {};
                if (!S.cronopost.posts[targetProjectId][toDateStringKey]) S.cronopost.posts[targetProjectId][toDateStringKey] = [];
                S.cronopost.posts[targetProjectId][toDateStringKey].push({ id: 'post' + Date.now(), title: data.title });
                // Elimina de ideas (asegura que exista el array)
                if (S.cronopost.ideas[targetProjectId]) {
                     S.cronopost.ideas[targetProjectId] = S.cronopost.ideas[targetProjectId].filter(i => i.id !== data.id);
                }
            
            } else if (data.type === 'post') { 
                 // Mueve el post usando toDateString como clave
                const fromPosts = S.cronopost.posts[data.fromProject]?.[data.fromDateString];
                if (!fromPosts) return; 
                
                const postIndex = fromPosts.findIndex(p => p.id === data.id);
                if (postIndex > -1) {
                    const [post] = fromPosts.splice(postIndex, 1);
                    // Si el array de origen queda vacío, elimínalo (opcional)
                    if (fromPosts.length === 0) delete S.cronopost.posts[data.fromProject][data.fromDateString];
                    
                    // Añade al destino
                    if (!S.cronopost.posts[data.fromProject]) S.cronopost.posts[data.fromProject] = {};
                    if (!S.cronopost.posts[data.fromProject][toDateStringKey]) S.cronopost.posts[data.fromProject][toDateStringKey] = [];
                    S.cronopost.posts[data.fromProject][toDateStringKey].push(post);
                }
            
            } else if (data.type === 'task') {
                // Busca la tarea en su carpeta original
                const taskFolder = data.folder || 'General';
                const task = S.tasks[data.fromProject]?.[taskFolder]?.find(t => t.id === data.id);
                // CORRECCIÓN TIMEZONE: Guarda la fecha local YYYY-MM-DD
                if (task) task.due = toLocalDate; 
            }
            save(); 
            renderCronoPOST();
            // Si el proyecto afectado es el activo, renderiza su calendario también
            if (S.activeProject && (S.activeProject === data.fromProject || S.activeProject === targetProjectId)) {
                renderCalendar();
            }
        };
        calendarEl.append(dayEl);
    });

    // Banco de ideas
    const ideasList = $('#cpIdeasList'); ideasList.innerHTML = '';
    const ideasContainer = $('#cpIdeas');
    if (activeProjectId !== 'all') { 
        ideasContainer.style.opacity = 1;
        // Asegura inicialización de ideas
        if (!S.cronopost.ideas[activeProjectId]) S.cronopost.ideas[activeProjectId] = []; 
        const ideas = S.cronopost.ideas[activeProjectId];
        
        if (ideas.length === 0) {
             ideasList.innerHTML = `<div class="empty-state" style="padding: 10px; font-size: var(--sm);">Añade tu primera idea para este proyecto.</div>`;
        } else {
            ideas.forEach(idea => {
                const ideaEl = el('div', { class: 'cp-post', draggable: 'true', textContent: idea.title });
                ideaEl.ondragstart = (e) => {
                    e.stopPropagation();
                    e.dataTransfer.setData('text/plain', JSON.stringify({type: 'idea', id: idea.id, title: idea.title}));
                    e.dataTransfer.effectAllowed = 'move';
                };
                ideasList.append(ideaEl);
            });
        }
    } else {
         ideasList.innerHTML = `<div class="empty-state" style="padding: 10px; font-size: var(--sm);">Selecciona un proyecto para ver y añadir ideas.</div>`;
         ideasContainer.style.opacity = 0.6;
    }
}
function createTaskFromCronoPOST(date) { 
    const modal = $('#cronoTaskModal');
    $('#cronoTaskModalDesc').textContent = `Crear tarea para ${fmtDate(date, 'short')}`;
    const select = $('#cronoTaskProjectSelect');
    select.innerHTML = '';
    if(S.projects.length === 0) {
        showToast('Debes crear un proyecto primero.', 'warn');
        return;
    }
    S.projects.forEach(p => select.append(el('option', {value: p.id, textContent: p.name})));
    
    // Asegura listener único
    const confirmBtn = $('#cronoTaskConfirm');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.onclick = () => {
        const title = $('#cronoTaskTitle').value.trim();
        const projectId = select.value;
        if (!title || !projectId) return showToast('Se requiere un título y un proyecto.', 'warn');

        const p = S.projects.find(x => x.id === projectId);
        if (!p) return; // Seguridad
        const firstColumn = p.taskColumns[0] || 'Backlog';
        const targetFolder = 'General'; // Siempre a General desde Cronopost
        
        // CORRECCIÓN TIMEZONE: Guarda YYYY-MM-DD local
        const localYear = date.getFullYear();
        const localMonth = String(date.getMonth() + 1).padStart(2, '0');
        const localDay = String(date.getDate()).padStart(2, '0');
        const localDateString = `${localYear}-${localMonth}-${localDay}`;

        const newTask = { 
            id: 't' + Date.now(), 
            title, 
            status: firstColumn, 
            desc: '', 
            due: localDateString, // Guarda YYYY-MM-DD
            folder: targetFolder, // Asigna carpeta
            tags: []
        };
        
        // Asegura inicialización
        if (!S.tasks[projectId]) S.tasks[projectId] = {};
        if (!S.tasks[projectId][targetFolder]) S.tasks[projectId][targetFolder] = []; 
        
        S.tasks[projectId][targetFolder].push(newTask);
        addIntis(5, 'Tarea creada');
        save();
        renderCronoPOST(); 
        if(S.activeProject === projectId) { renderCalendar(); renderTasks(); } // Actualiza si está activo
        renderAside(); // Actualiza contadores
        modal.close();
        $('#cronoTaskTitle').value = '';
    };
    modal.showModal();
}

// --- 6.3: HUB PROFESIONAL ---
function renderHub() { 
    // Asegura inicialización
    if (!S.hub) S.hub = JSON.parse(JSON.stringify(initialState.hub)); 
    const P = S.hub.perfil;
    $('#avatar').src = P.avatar || 'https://placehold.co/100x100/dde2ed/0b132a?text=TÚ';
    $('#pNombreDisplay').textContent = P.nombre;
    $('#pRoleDisplay').textContent = P.rol;
    $('#pBioDisplay').textContent = P.bio;
    $('#pNombre').value = P.nombre;
    $('#pRole').value = P.rol;
    $('#pBio').value = P.bio;
    $('#pSocialLinkedin').value = P.socials?.linkedin || '';
    $('#pSocialTwitter').value = P.socials?.twitter || '';
    
    const socialsEl = $('#pSocialsDisplay'); socialsEl.innerHTML = '';
    if(P.socials?.linkedin) socialsEl.append(el('a', {href: P.socials.linkedin, target:'_blank', class:'btn btn-ghost btn-sm'}, el('i', {'data-lucide':'linkedin'})));
    if(P.socials?.twitter) socialsEl.append(el('a', {href: P.socials.twitter, target:'_blank', class:'btn btn-ghost btn-sm'}, el('i', {'data-lucide':'twitter'})));
    
    const mkList = $('#mkList'); mkList.innerHTML = '';
    (S.hub.market || []).forEach(item => { // Asegura que market exista
        mkList.append(el('div', {class: 'card', style:'margin-bottom:10px; background: var(--surface);'},
            el('div', {class:'row'}, el('b', {textContent: item.name}), el('span', {class:'spacer'}), el('span', {class:'chip', textContent: `$${item.price}`})),
            el('p', {class:'sub', textContent:item.desc}),
            el('div', {class:'row'}, el('span',{class:'spacer'}),
                el('button', {class:'btn btn-sm btn-ghost', onclick:()=>editMarketItem(item.id)}, el('i',{'data-lucide':'edit-3', width:16})),
                el('button', {class:'btn btn-sm btn-ghost', onclick:()=>deleteMarketItem(item.id)}, el('i',{'data-lucide':'trash-2', width:16}))
            )
        ));
    });
    renderJobs();
    lucide.createIcons();
}
function renderJobs(){ 
    const list = $('#jobsList'); list.innerHTML = '';
    const searchTerm = ($('#jobSearchInput')?.value || '').toLowerCase().trim(); // Asegura que exista
    const jobs = (S.hub.jobs || []).filter(j => // Asegura que jobs exista
         (j.title || '').toLowerCase().includes(searchTerm) || 
         (j.company || '').toLowerCase().includes(searchTerm)
    );
    
    if (jobs.length === 0) {
        list.innerHTML = `<div class="empty-state"><i data-lucide="search-x" width="48" height="48"></i><h4>No hay ofertas de empleo</h4><p>No hay ofertas que coincidan con tu búsqueda o no se han publicado ofertas.</p></div>`;
        lucide.createIcons(); return;
    }
    
    jobs.forEach(job => {
        const card = el('div', {class: 'job-card'},
            el('div', {class:'row'},
                el('div', {},
                    el('div', {class: 'job-title', textContent: job.title}),
                    el('div', {class: 'job-company', textContent: `${job.company} • ${job.location}`})
                ),
                el('span', {class: 'spacer'}),
                el('div', {},
                    el('div', {class:'chip', textContent: job.type}),
                    el('div', {style:'text-align:right; margin-top: 4px; font-weight: 600;', textContent: job.pay})
                )
            ),
            el('div', {class: 'job-card-details'}, el('p', {textContent: job.desc}))
        );
        card.onclick = () => {
            const details = card.querySelector('.job-card-details');
            if (details) details.style.display = details.style.display === 'block' ? 'none' : 'block';
        };
        list.append(card);
    });
}
function addJob() { 
    // Asegura inicialización
    if (!S.hub) S.hub = JSON.parse(JSON.stringify(initialState.hub));
    if (!S.hub.jobs) S.hub.jobs = []; 

    const job = { id: 'j' + Date.now(), title: $('#jobTitle').value.trim(), company: $('#jobCompany').value.trim(), location: $('#jobLocation').value.trim(), pay: $('#jobPay').value.trim(), type: $('#jobType').value, desc: $('#jobDesc').value.trim(), authorId: 'u_me' };
    if (!job.title || !job.company) return showToast('El título y la empresa son obligatorios.', 'warn');
    S.hub.jobs.unshift(job); addIntis(20, 'Empleo publicado'); save(); renderJobs();
    showToast('Oferta de empleo publicada', 'success');
    ['#jobTitle', '#jobCompany', '#jobLocation', '#jobPay', '#jobDesc'].forEach(s => $(s).value = '');
}
function saveProfile() { 
    // Asegura inicialización
    if (!S.hub) S.hub = JSON.parse(JSON.stringify(initialState.hub));
    if (!S.hub.perfil.socials) S.hub.perfil.socials = { linkedin: '', twitter: '' };

    S.hub.perfil.nombre = $('#pNombre').value; S.hub.perfil.rol = $('#pRole').value; S.hub.perfil.bio = $('#pBio').value;
    S.hub.perfil.socials.linkedin = $('#pSocialLinkedin').value; S.hub.perfil.socials.twitter = $('#pSocialTwitter').value;
    save(); renderHub(); showToast("Perfil actualizado", "success");
}
function handleAvatarUpload(e) { 
    const file = e.target.files?.[0]; if (!file) return; // Optional chaining
    const reader = new FileReader();
    reader.onload = (event) => { 
        // Asegura inicialización
        if (!S.hub) S.hub = JSON.parse(JSON.stringify(initialState.hub)); 
        S.hub.perfil.avatar = event.target?.result; // Optional chaining
        save(); 
        renderHub(); 
    };
    reader.onerror = () => showToast("Error al cargar la imagen.", "danger");
    reader.readAsDataURL(file);
}
function editMarketItem(id) { 
    // Asegura inicialización
    if (!S.hub || !S.hub.market) return;
    const item = S.hub.market.find(i => i.id === id); if (!item) return;
    showInputModal('Editar Servicio', 'Nuevo nombre:', item.name, newName => {
        showInputModal('Editar Servicio', 'Nuevo precio:', item.price, newPrice => {
            if (newName) item.name = newName;
            const priceNum = Number(newPrice); // Convierte a número
            if (!isNaN(priceNum)) item.price = priceNum; // Solo actualiza si es un número válido
            save(); renderHub();
        }, item.price);
    }, item.name);
}
function deleteMarketItem(id) { 
     // Asegura inicialización
    if (!S.hub || !S.hub.market) return;
    showInputModal('Confirmar Eliminación', `¿Eliminar este servicio del mercado? Escribe "eliminar".`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            S.hub.market = S.hub.market.filter(i => i.id !== id);
            save(); renderHub();
        }
    });
}

// --- 6.4: CHAT GLOBAL ---
function renderGChat() { 
    // Asegura inicialización
    if (!S.hub) S.hub = JSON.parse(JSON.stringify(initialState.hub)); 
    if (!S.gchat) S.gchat = JSON.parse(JSON.stringify(initialState.gchat));
    if (!S.gchat.messages) S.gchat.messages = { 'general': [] };
    if (!S.gchat.dms) S.gchat.dms = {};

    const allUsers = [S.hub.perfil, ...(S.hub.users || [])]; // Asegura que users exista
    const userList = $('#gUserList'); userList.innerHTML = '';
    
    // Canal #general
    const generalChannel = el('div', {class: 'projItem', onclick: ()=> openDirectMessage('general')}, el('i', {'data-lucide': 'hash'}), el('span', {textContent: 'general'}));
    if (S.gchat.activeChat === 'general') generalChannel.classList.add('active');
    userList.append(generalChannel);
    
    // Lista de usuarios (para DMs)
    allUsers.filter(u => u && u.id !== 'u_me').forEach(u => { // Añade chequeo de nulidad para u
        const dmKey = ['u_me', u.id].sort().join('-');
        const userEl = el('div', {class: 'projItem', dataset: {userid: u.id}, onclick: ()=> openDirectMessage(u.id)},
            el('div', {class:'presence-dot', style:`width: 8px; height: 8px; border-radius: 50%; background:${u.online ? 'var(--success)' : 'var(--sub)'}`}),
            el('span', {textContent: u.nombre})
        );
        if (S.gchat.activeChat === dmKey) userEl.classList.add('active');
        userList.append(userEl);
    });
    
    const log = $('#gChatLog'); log.innerHTML = ''; let messages = []; let activeChatName = "Chat";
    
    // Carga mensajes del chat activo
    if (S.gchat.activeChat === 'general') {
        activeChatName = "# general"; messages = S.gchat.messages.general || [];
        if (messages.length === 0) messages.push({senderId: 'system', at: new Date().toISOString(), text: '¡Bienvenido al chat global! Sé respetuoso y colabora.'}); // Guarda ISO
        $('#gChatHeader').textContent = activeChatName;
    } else {
        const otherUserId = S.gchat.activeChat.replace('u_me','').replace('-','');
        const otherUser = allUsers.find(u => u && u.id === otherUserId); // Chequeo de nulidad
        if(otherUser) {
            activeChatName = `Chat con ${otherUser.nombre}`;
            // Recrea el header para asegurar el listener
            const header = $('#gChatHeader');
            header.innerHTML = `Chat con ${otherUser.nombre}`;
            const callBtn = el('button', {class:"btn btn-sm btn-ghost", id:"videoCallBtn", style:"margin-left: auto;"}, el('i', {'data-lucide':"video"}));
            callBtn.onclick = () => { $('#videoCallTitle').textContent = `Llamando a ${otherUser.nombre}...`; $('#videoCallModal').showModal(); };
            header.appendChild(callBtn);
        } else {
             $('#gChatHeader').textContent = "Chat";
        }
        messages = S.gchat.dms[S.gchat.activeChat] || [];
    }

    // Renderiza mensajes
    messages.forEach(m => {
        const sender = allUsers.find(u => u && u.id === m.senderId) || {nombre: 'Sistema', avatar: 'Logos HD.png'}; // Chequeo de nulidad
        log.append(createMessageElement(m, sender)); // Pasa el objeto sender completo
    });
    // Scroll al final
    requestAnimationFrame(() => { log.scrollTop = log.scrollHeight; });
    lucide.createIcons();
}
function openDirectMessage(userId) { 
    S.gchat.activeChat = (userId === 'general' || userId === 'u_me') ? 'general' : ['u_me', userId].sort().join('-');
    save(); renderGChat();
}
function sendGChatMessage() { 
    const msgInput = $('#gChatMsg');
    const msg = msgInput.value.trim(); if (!msg) return;
    
    // Asegura inicialización
    if (!S.gchat) S.gchat = JSON.parse(JSON.stringify(initialState.gchat));
    if (!S.gchat.messages) S.gchat.messages = { 'general': [] };
    if (!S.gchat.dms) S.gchat.dms = {};

    const message = { senderId: 'u_me', at: new Date().toISOString(), text: msg }; // Guarda ISO
    
    if (S.gchat.activeChat === 'general') { 
        S.gchat.messages.general.push(message);
    } else { 
        if (!S.gchat.dms[S.gchat.activeChat]) S.gchat.dms[S.gchat.activeChat] = []; 
        S.gchat.dms[S.gchat.activeChat].push(message); 
    }
    addIntis(2, 'Mensaje en chat');
    save(); renderGChat(); msgInput.value = '';
}

// --- 6.5: MONETIZACIÓN & MINDSET ---
const monetizationModules = { 
    oferta: { icon: 'gem', title: 'Ofertas Irresistibles', desc: 'Estructura productos que tus clientes no puedan rechazar.', content: `<h4>El Principio de la Transformación</h4><p>Una oferta irresistible no es sobre tu producto, es sobre la <strong>transformación</strong> que vendes. Debes llevar a tu cliente de un "Estado A" (con un problema doloroso) a un "Estado B" (con el problema resuelto y aspiraciones cumplidas).</p><h4>Componentes Clave de tu Oferta:</h4><ul><li><strong>Resultado Específico y Deseado:</strong> ¿Qué logrará exactamente tu cliente? (Ej: "Lanza tu podcast profesional en 30 días", no "Aprende a hacer podcasts").</li><li><strong>Bonos de Alto Valor:</strong> Añade extras que complementen la oferta principal. (Ej: Plantillas de guiones, checklist técnico, acceso a comunidad privada).</li><li><strong>Garantía Sólida (Inversión de Riesgo):</strong> Reduce el riesgo a cero para el comprador.</li><li><strong>Urgencia y Escasez:</strong> Motiva la acción inmediata. (Ej: "Disponible solo para las primeras 20 personas").</li></ul><div class="tip"><strong>Tip Profesional:</strong> Nombra tu oferta basándote en el resultado. "El Sistema Podcast Launchpad 30" suena mucho más valioso.</div>` },
    contenido: { icon: 'megaphone', title: 'Marketing de Contenidos', desc: 'Atrae a tu cliente ideal creando contenido de valor.', content: `<h4>La Estrategia del "Dar Primero"</h4><p>El marketing de contenidos se basa en atraer clientes en lugar de perseguirlos. Lo haces ofreciendo valor por adelantado, posicionándote como una autoridad en tu nicho.</p><h4>Pasos para una Estrategia Exitosa:</h4><ul><li><strong>Define tu Pilar de Contenido:</strong> Elige un tema central en el que eres experto.</li><li><strong>Elige UN Formato y UN Canal Principal:</strong> ¿Videos en YouTube? ¿Hilos en Twitter/X? Domina uno antes de expandirte.</li><li><strong>Crea "Contenido Solución":</strong> Cada pieza de contenido debe resolver un micro-problema de tu audiencia.</li><li><strong>Llamada a la Acción (CTA):</strong> Al final de tu contenido, invita a la audiencia a dar el siguiente paso. (Ej: "Descarga mi guía gratuita sobre X").</li></ul><div class="tip"><strong>Tip Profesional:</strong> Crea una pieza de contenido larga y de alto valor y luego "recíclala" en piezas más pequeñas para otras redes.</div>` },
    suscripcion: { icon: 'calendar-check', title: 'Modelos de Suscripción', desc: 'Crea ingresos recurrentes y una comunidad fiel.', content: `<h4>El Poder del Ingreso Predecible</h4><p>Los modelos de suscripción transforman tu negocio de transacciones únicas a relaciones a largo plazo, dándote un flujo de caja estable.</p><h4>Tipos de Modelos Populares:</h4><ul><li><strong>Comunidad Privada:</strong> Acceso a un grupo (Discord, Slack, etc.), networking y contenido exclusivo.</li><li><strong>Software como Servicio (SaaS):</strong> Ofreces una herramienta o software por una cuota mensual/anual.</li><li><strong>Producto como Servicio (PaaS):</strong> Ofreces un servicio "hecho para ti" de forma ilimitada por una cuota fija (Ej: Diseño gráfico ilimitado).</li></ul><div class="tip"><strong>Tip Profesional:</strong> Empieza con una "Oferta Fundacional" a un precio más bajo para tus primeros miembros. Ellos te darán feedback valioso.</div>` },
     embudos: { icon: 'filter', title: 'Embudos de Venta', desc: 'Diseña el viaje de un extraño a un cliente leal.', content: `<h4>¿Qué es un Embudo de Ventas?</h4><p>Es el proceso paso a paso que guía a tus clientes potenciales hacia la compra. En lugar de una tienda con mil opciones, un embudo ofrece un camino claro.</p><h4>Fases de un Embudo Básico:</h4><ol><li><strong>Tráfico (ToFu):</strong> ¿Cómo te descubren? (Redes sociales, anuncios, SEO).</li><li><strong>Captación (MoFu):</strong> Ofreces un "Lead Magnet" (ebook, webinar) a cambio del correo.</li><li><strong>Venta (BoFu):</strong> Presentas tu oferta principal a través de una página de ventas y correos.</li><li><strong>Fidelización:</strong> Aportas valor post-compra para que se conviertan en clientes recurrentes.</li></ol><div class="tip"><strong>Tip Profesional:</strong> La mayoría de las ventas no ocurren en el primer contacto. Una secuencia de 5-7 correos automáticos puede multiplicar tus conversiones.</div>` }
};
function renderMonetAssistant() { 
    const grid = $('#monet-grid'); grid.innerHTML = '';
    for (const key in monetizationModules) {
        const module = monetizationModules[key];
        const card = el('div', {class: 'monet-card', onclick: () => openMonetModule(key)},
            el('i', {'data-lucide': module.icon, width: 40, height: 40}),
            el('h4', {textContent: module.title}),
            el('p', {textContent: module.desc})
        );
        grid.append(card);
    }
    lucide.createIcons();
}
function openMonetModule(key) { 
    const module = monetizationModules[key]; if (!module) return;
    $('#monetModuleTitle').textContent = module.title;
    $('#monetModuleContent').innerHTML = module.content;
    $('#monetModuleModal').showModal();
    lucide.createIcons(); // Llama aquí por si hay iconos en el contenido
}
function setupMindset() { 
    const quotes = ["El éxito es la suma de pequeños esfuerzos repetidos día tras día.", "La creatividad es la inteligencia divirtiéndose.", "El único modo de hacer un gran trabajo es amar lo que haces."];
    $('#mindsetQuote').textContent = `"${quotes[Math.floor(Math.random()*quotes.length)]}"`;
    const breathingText = $('#breathing-text');
    const circle = $('#breathing-circle');
    // Reinicia la animación para asegurar sincronización
    circle.style.animation = 'none';
    breathingText.style.animation = 'none';
    requestAnimationFrame(() => {
        circle.style.animation = '';
        breathingText.style.animation = '';
        breathingText.textContent = 'Inhala...'; // Asegura estado inicial
    });
    // El listener de 'animationiteration' puede ser menos fiable, se quita
}

// --- 6.6: BILLETERA GLOBAL & INTIS ---
function renderWallet() { 
    // Asegura inicialización
    if (!S.wallet) S.wallet = { movs: [] };
    const tbody = $('#wBody'); tbody.innerHTML = '';
    // Ordena por fecha descendente antes de renderizar
    const sortedMovs = [...S.wallet.movs].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    sortedMovs.forEach((mov, i) => { // 'i' aquí es el índice original si lo necesitas, pero no se usa para eliminar
        const tr = el('tr', {},
            el('td', {textContent: fmtDate(mov.fecha, 'short')}), // Usa formato corto
            el('td', {textContent: mov.tipo, style: `color: ${mov.tipo === 'Ingreso' ? 'var(--success)' : 'var(--danger)'}`}),
            el('td', {textContent: `$${mov.monto.toFixed(2)}`, style:'text-align: right;'}),
            el('td', {textContent: mov.cat}),
            el('td', {textContent: mov.nota}),
            el('td', {}, el('button', {class: 'btn btn-ghost btn-sm', onclick: () => { 
                // Encuentra el índice real en S.wallet.movs para eliminar
                const originalIndex = S.wallet.movs.findIndex(originalMov => originalMov === mov);
                if (originalIndex > -1) {
                    S.wallet.movs.splice(originalIndex, 1); 
                }
                save(); 
                renderWallet(); 
            }}, el('i', {'data-lucide': 'trash-2', width: 14})))
        );
        tbody.append(tr); // Usa append para orden normal (fecha más reciente arriba por sort)
    });
    lucide.createIcons();
}
function addWalletTransaction() { 
    const monto = parseFloat($('#wMonto').value);
    if (isNaN(monto) || monto <= 0) return showToast('Por favor, ingresa un monto válido.', 'warn');
    const newMov = { fecha: new Date().toISOString(), tipo: $('#wTipo').value, monto: monto, cat: $('#wCat').value.trim() || 'General', nota: $('#wNota').value.trim() };
    
    // Asegura inicialización
    if (!S.wallet) S.wallet = { movs: [] };
    S.wallet.movs.push(newMov);
    addIntis(5, 'Movimiento en billetera');
    save(); renderWallet();
    $('#wMonto').value = ''; $('#wCat').value = ''; $('#wNota').value = '';
}

/* ============================================================================
SECCIÓN 7: ONBOARDING (Plantillas de Industria)
============================================================================
*/
const industryTemplates = { 
    agency: { 
        projects: [{id: 'p_agency_1', name: 'Cliente Tech Solutions', color: '#3b82f6', taskColumns:['Por hacer', 'En progreso', 'En revisión', 'Aprobado']}], 
        folders: {'p_agency_1': ['General']},
        tasks: {'p_agency_1': { 'General': [ 
            {id:'t_a1', title:'Reunión de kickoff con cliente', status:'Aprobado', desc:'', due:'', folder:'General', tags: ['cliente']}, 
            {id:'t_a2', title:'Definir KPIs de la campaña', status:'En progreso', desc:'', due:'', folder:'General', tags: ['estrategia']}, 
            {id:'t_a3', title:'Enviar propuesta de diseño', status:'Por hacer', desc:'', due:'', folder:'General', tags: ['diseño']} 
        ]}}, 
        notes: {'p_agency_1': {list: [{id:'n_a1', title: 'Minuta Kickoff'}], active:'n_a1', bodies:{'n_a1':'<p><strong>Puntos clave:</strong> Foco en Aumento de Leads.</p>'}, drawings:{}}}, 
    },
    ecommerce: { 
        projects: [{id: 'p_ecom_1', name: 'Lanzamiento Colección Otoño', color: '#16a34a', taskColumns: ['Ideas', 'Producción', 'Marketing', 'Lanzado']}], 
        folders: {'p_ecom_1': ['General']},
        tasks: {'p_ecom_1': { 'General': [ 
            {id:'t_e1', title:'Sesión de fotos de producto', status:'Producción', desc:'', due:'', folder:'General', tags: ['fotos']}, 
            {id:'t_e2', title:'Actualizar banners de la web', status:'Marketing', desc:'', due:'', folder:'General', tags: ['web', 'diseño']}, 
            {id:'t_e3', title:'Preparar campaña de email marketing', status:'Ideas', desc:'', due:'', folder:'General', tags: ['email', 'marketing']} 
        ]}}, 
        notes: {'p_ecom_1': {list: [{id:'n_e1', title: 'Ideas para Campaña'}], active:'n_e1', bodies:{'n_e1':'<p>Foco en colores cálidos y confort.</p>'}, drawings:{}}}, 
    },
    creator: { 
        projects: [{id: 'p_creator_1', name: 'Contenido YouTube Q4', color: '#ef4444', taskColumns: ['Guion', 'Grabación', 'Edición', 'Publicado']}], 
        folders: {'p_creator_1': ['General']},
        tasks: {'p_creator_1': { 'General': [ 
            {id:'t_c1', title:'Grabar video sobre "5 Errores Comunes"', status:'Grabación', desc:'', due:'', folder:'General', tags: ['video', 'youtube']}, 
            {id:'t_c2', title:'Escribir guion para colaboración con @usuario', status:'Guion', desc:'', due:'', folder:'General', tags: ['colaboracion', 'guion']}, 
            {id:'t_c3', title:'Investigar temas para videos de Diciembre', status:'Guion', desc:'', due:'', folder:'General', tags: ['ideas', 'investigacion']} 
        ]}}, 
        cronopost: { ideas: {'p_creator_1': [{id:'i_c1', title: 'Detrás de cámaras de mi último video'}]}}, 
    }
};
function loadIndustryTemplate(industry) { 
    const template = industryTemplates[industry] || {};
    
    // Asigna los datos de la plantilla usando deep copy para evitar referencias
    S.projects = JSON.parse(JSON.stringify(template.projects || [])); 
    S.folders = JSON.parse(JSON.stringify(template.folders || {}));
    S.tasks = JSON.parse(JSON.stringify(template.tasks || {})); 
    S.notes = JSON.parse(JSON.stringify(template.notes || {}));
    if (template.cronopost) S.cronopost.ideas = JSON.parse(JSON.stringify(template.cronopost.ideas || {}));
    
    // Inicializa todos los sub-estados para los proyectos de la plantilla
    S.projects.forEach(p => {
        const id = p.id;
        if (!p.taskColumns) p.taskColumns = ['Backlog','En curso','Bloqueado','Hecho'];
        if (!S.folders[id]) S.folders[id] = ['General'];
        if (!S.tasks[id]) S.tasks[id] = { 'General': [] }; 
        // Asegura que todas las tareas tengan array de tags
         Object.values(S.tasks[id]).forEach(folderTasks => {
              folderTasks.forEach(task => { if (!task.tags) task.tags = []; });
         });
        if (!S.notes[id]) S.notes[id] = {list:[], active:null, bodies:{}, drawings:{}}; 
        if (!S.chats[id]) S.chats[id] = {threads:[], messages:{}, activeThread: null, model: 'pro'};
        if (!S.tables[id]) S.tables[id] = {list:[{id: 'tbl_default', name: 'Tabla 1'}], active: 'tbl_default', data: {'tbl_default': {cols:[], rows:[]}}};
        if (!S.files[id]) S.files[id] = [];
        if (!S.fin[id]) S.fin[id] = {rows:[]};
        if (!S.cronopost.posts[id]) S.cronopost.posts[id] = {};
        if (!S.cronopost.ideas[id]) S.cronopost.ideas[id] = [];
        S.ui.projectCollapsedState[id] = false; // Inicia expandido
    });
    
    S.userProfile.industry = industry; 
    addIntis(100, `Plantilla ${industry} cargada`);
    save(); 
    showToast(`¡Bienvenido! Tu espacio de trabajo para ${industry} está listo.`, 'success');
    
    if(S.projects.length > 0) {
        history.pushState({view: `project/${S.projects[0].id}`}, '', `#!project/${S.projects[0].id}`);
        openProject(S.projects[0].id);
    } else {
        history.pushState({view: 'ai-global-chat'}, '', `#!ai-global-chat`);
        show('ai-global-chat');
    }
    renderAside();
}

/* ============================================================================
SECCIÓN 8: BÚSQUEDA GLOBAL
============================================================================
*/
function performSearch() { 
    const query = $('#q').value.toLowerCase().trim();
    if (!query) return;
    const results = [];
    const queryWords = query.split(' ').filter(w => w);

    const isMatch = (text) => {
        if (!text) return false;
        const lowerText = text.toLowerCase();
        return queryWords.every(word => lowerText.includes(word));
    };

    S.projects.forEach(p => {
        const projId = p.id;
        if (isMatch(p.name)) {
            results.push({
                type: 'Proyecto', name: p.name, context: 'Nombre del proyecto',
                action: () => { 
                    history.pushState({view: `project/${projId}`}, '', `#!project/${projId}`);
                    openProject(projId); 
                    $('#searchModal').close(); 
                }
            });
        }
        // Busca en Tareas (itera sobre carpetas)
        Object.entries(S.tasks[projId] || {}).forEach(([folderName, tasksInFolder]) => {
            (tasksInFolder || []).forEach(t => { // Asegura que tasksInFolder exista
                if (isMatch(t.title) || isMatch(t.desc)) {
                    results.push({
                        type: 'Tarea', name: t.title, context: `En proyecto: ${p.name} (Carpeta: ${folderName})`,
                        action: () => { 
                            history.pushState({view: `project/${projId}/folder/${folderName}`}, '', `#!project/${projId}/folder/${encodeURIComponent(folderName)}`);
                            openProject(projId, folderName); 
                            // Espera un poco a que se renderice antes de abrir el modal
                            setTimeout(() => openTaskModal(t.id), 100); 
                            $('#searchModal').close(); 
                        }
                    });
                }
            });
        });
        // Busca en Notas
        (S.notes[projId]?.list || []).forEach(n => {
            if (isMatch(n.title) || isMatch(S.notes[projId].bodies[n.id])) {
                results.push({
                    type: 'Nota', name: n.title, context: `En proyecto: ${p.name}`,
                    action: () => { 
                        history.pushState({view: `project/${projId}`}, '', `#!project/${projId}`);
                        openProject(projId);
                        S.notes[projId].active = n.id;
                        save();
                        // Espera a que se abra el proyecto y luego cambia de pestaña
                        setTimeout(() => {
                            $('#project-tabs .tab[data-ptab="notes"]').click();
                            renderNotes(); // Asegura que la nota correcta se muestre
                        }, 50); 
                        $('#searchModal').close();
                    }
                });
            }
        });
    });
    
    // Muestra resultados
    const resultsEl = $('#searchResults'); resultsEl.innerHTML = '';
    if (results.length === 0) { 
        resultsEl.innerHTML = `<div class="empty-state">No se encontraron resultados para "${query}"</div>`;
    } else { 
        results.forEach(r => {
            const resultCard = el('div', { class: 'card', style: 'margin-bottom: 10px; cursor: pointer; background: var(--surface);'},
                el('div', {class:'row'}, 
                    el('b', {textContent: r.name}),
                    el('span', {class: 'spacer'}),
                    el('span', {class: 'chip', textContent: r.type})
                ),
                el('p', {class: 'sub', textContent: r.context, style: 'margin: 4px 0 0; font-size: var(--sm)'})
            );
            resultCard.onclick = r.action;
            resultsEl.append(resultCard);
        });
    }
    $('#searchModal').showModal();
}

/* ============================================================================
SECCIÓN 9: TOUR GUIADO
============================================================================
*/
let currentTourStep = 0;
const tourSteps = [ 
    { el: '#menuBtn', title: 'Menú Principal', text: 'Usa este botón para expandir o contraer la barra lateral de navegación y proyectos.'},
    { el: 'aside .aside-middle-section', title: 'Tus Proyectos', text: 'Aquí encontrarás todos tus proyectos y sus carpetas. Haz clic en uno para abrirlo o crea uno nuevo.'},
    { el: '#nav-list', title: 'Módulos Globales', text: 'Accede a herramientas que abarcan todos tus proyectos, como el Asistente IA, Calendario General y el Hub Profesional.'},
    { el: '#projectShell .tabs', title: 'Pestañas del Proyecto', text: 'Dentro de un proyecto, navega entre sus diferentes herramientas como Tareas, Calendario, Finanzas y más.'},
    { el: '#folderSel', title: 'Selector de Carpetas', text: 'Usa este selector para filtrar las TAREAS por carpeta dentro del proyecto.'},
    { el: '#quickAdd', title: 'Añadir Rápido', text: 'Este botón cambia según la pestaña en la que te encuentres. Te permite añadir rápidamente tareas (a la carpeta actual), notas, etc.'},
    { el: '#walletChip', title: 'Billetera e Intis', text: 'Lleva un control de tus finanzas globales y tus puntos de gamificación (Intis) desde aquí.'},
];
function showTourStep(index) { 
    if (index >= tourSteps.length) { endTour(); return; }
    currentTourStep = index;
    const step = tourSteps[index];
    const targetEl = $(step.el);
    if (!targetEl) { console.warn("Tour step element not found:", step.el); showTourStep(index + 1); return; }
    
    const tooltip = $('#tour-tooltip');
    $('#tour-overlay').style.display = 'block';
    tooltip.style.display = 'block';
    
    $('#tour-title').textContent = step.title;
    $('#tour-text').textContent = step.text;
    $('#tour-step').textContent = `${index + 1} / ${tourSteps.length}`;
    $('#tour-prev').disabled = index === 0;

    // Asegura que el elemento sea visible antes de calcular la posición
    targetEl.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
    
    // Espera un poco para que el scroll termine antes de posicionar
    setTimeout(() => {
        const rect = targetEl.getBoundingClientRect();
        
        // Posicionamiento inteligente del tooltip
        let top = rect.bottom + 10;
        let left = rect.left;

        tooltip.style.top = `${top}px`;
        tooltip.style.left = `${left}px`;
        
        // Ajusta si se sale de la pantalla
        const tooltipRect = tooltip.getBoundingClientRect();
        if(tooltipRect.right > window.innerWidth) tooltip.style.left = `${window.innerWidth - tooltipRect.width - 10}px`;
        if(tooltipRect.bottom > window.innerHeight) tooltip.style.top = `${rect.top - tooltipRect.height - 10}px`;
        if (tooltipRect.top < 0) tooltip.style.top = '10px';
        if (tooltipRect.left < 0) tooltip.style.left = '10px';
    }, 300); // Ajusta este tiempo si es necesario
}
function endTour() { 
    $('#tour-overlay').style.display = 'none';
    $('#tour-tooltip').style.display = 'none';
}

/* ============================================================================
SECCIÓN 10: INICIALIZACIÓN Y EVENT LISTENERS GLOBALES
============================================================================
*/

/**
 * Manejador de navegación basado en Hash.
 */
function handleNav() {
    const hash = window.location.hash.replace('#!', ''); // Limpia el hash
    if (hash.startsWith('project/')) {
        const parts = hash.split('/');
        const projId = parts[1];
        const folderName = parts[3] ? decodeURIComponent(parts[3]) : 'General';
        
        if (S.projects.find(p => p.id === projId)) {
            openProject(projId, folderName);
        } else {
            console.warn('Project not found from hash, redirecting.');
            history.replaceState({view: 'ai-global-chat'}, '', `#!ai-global-chat`);
            show('ai-global-chat');
        }
    } else if (hash && $(`[data-nav="${hash}"]`)) {
        show(hash);
    } else {
        // Default: si hay proyectos, abre el primero, sino va a IA Global
        if (S.projects.length > 0) {
            const firstProjId = S.projects[0].id;
            history.replaceState({view: `project/${firstProjId}`}, '', `#!project/${firstProjId}`);
            openProject(firstProjId, 'General');
        } else {
            history.replaceState({view: 'ai-global-chat'}, '', `#!ai-global-chat`);
            show('ai-global-chat');
        }
    }
}

/**
 * Función de inicialización principal.
 */
function init(){
  load(); // Carga los datos y realiza migraciones
  lucide.createIcons(); // Renderiza iconos iniciales
  
  if (!S.userProfile || !S.userProfile.industry) {
    // Solo muestra si NO hay proyectos (asume que si hay proyectos, ya pasó el onboarding)
    if (S.projects.length === 0) {
        $('#industryModal').showModal(); 
    }
  }
  
  // Listener para la navegación global en el aside
  $('#nav-list').addEventListener('click', (e) => {
      const link = e.target.closest('a.navBtn');
      if (link && link.dataset.nav) {
          e.preventDefault(); 
          const view = link.dataset.nav;
          history.pushState({view}, '', `#!${view}`); 
          show(view);
      }
  });
  
  // Listener para enlaces internos (Mindset -> Chat Global)
  document.body.addEventListener('click', e => {
    const link = e.target.closest('a.nav-link-btn');
    if (link && link.hash) {
        e.preventDefault();
        const view = link.hash.replace('#!', '');
        if($(`[data-nav="${view}"]`)){
            history.pushState({view}, '', `#!${view}`);
            show(view);
        }
    }
  });
  
  // Listener para popstate (navegación historial del navegador)
  window.addEventListener('popstate', (e) => {
      // Si el estado tiene view, úsalo, sino re-parsea el hash
      if (e.state && e.state.view) {
           const view = e.state.view;
           if (view.startsWith('project/')) {
              const parts = view.split('/');
              const projId = parts[1];
              const folderName = parts[3] ? decodeURIComponent(parts[3]) : 'General';
              openProject(projId, folderName);
           } else {
              show(view);
           }
      } else {
          handleNav();
      }
  });

  handleNav(); // Llama al manejador de navegación al cargar
  renderAside();
  setupHeaderActions();
  setupAutoResize();
  setupSidebarResizer(); // Configura el resizer
}

/**
 * Configura los listeners para las acciones del header.
 */
function setupHeaderActions() { 
    const themeHandler = () => {
        const h=document.documentElement; 
        const newTheme = h.getAttribute('data-theme')==='light'?'dark':'light'; 
        h.setAttribute('data-theme', newTheme);
        const themeIconName = newTheme === 'light' ? 'sun' : 'moon';
        
        // Actualiza ambos iconos (desktop y mobile)
        $$(`#themeBtn > i, #mobileThemeBtn > i`).forEach(icon => {
           if(icon) icon.outerHTML = `<i data-lucide="${themeIconName}"></i>`;
        });
        
        lucide.createIcons();
    };
    const tourHandler = () => showTourStep(0);

    $('#themeBtn').onclick = themeHandler;
    $('#tourBtn').onclick = tourHandler;
    
    // Dropdown móvil
    $('#mobileMoreBtn').onclick = (e) => { e.stopPropagation(); $('#mobileDropdown').classList.toggle('active'); };
    document.addEventListener('click', (e) => { 
        // Cierra si se hace click fuera del dropdown
        if (!e.target.closest('.dropdown-container')) {
            $('#mobileDropdown').classList.remove('active'); 
        }
    });
    $('#mobileThemeBtn').onclick = themeHandler;
    $('#mobileTourBtn').onclick = tourHandler;
    $('#mobileWalletBtn').onclick = () => { $('#walletChip').click(); $('#mobileDropdown').classList.remove('active'); };
    $('#mobileIntisBtn').onclick = () => { $('#intisChip').click(); $('#mobileDropdown').classList.remove('active'); };
}

/**
 * Configura el auto-resize para textareas.
 */
function setupAutoResize() { 
    document.addEventListener('input', e => {
        if (e.target.tagName.toLowerCase() === 'textarea') {
            e.target.style.height = 'auto'; // Reinicia altura
            // Ajusta altura al scrollHeight, con un máx de 150px (del CSS)
            e.target.style.height = Math.min(e.target.scrollHeight, 150) + 'px'; 
        }
    });
}

/**
 * Configura el redimensionador del sidebar.
 */
function setupSidebarResizer() {
    const resizer = $('#sidebar-resizer');
    const sidebar = $('aside');
    const topSection = sidebar.querySelector('.aside-middle-section');
    const bottomSection = sidebar.querySelector('.aside-bottom-section');

    let isResizing = false;

    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        sidebar.style.userSelect = 'none'; // Evita seleccionar texto mientras se arrastra
        document.body.style.cursor = 'ns-resize'; // Cambia cursor globalmente
    });

    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;

        const sidebarRect = sidebar.getBoundingClientRect();
        // Calcula la nueva altura relativa de la sección superior
        const newTopHeight = e.clientY - sidebarRect.top - topSection.offsetTop; 
        const totalHeight = topSection.offsetHeight + bottomSection.offsetHeight; // Altura total disponible
        
        // Limita la altura mínima (ej: 100px) y máxima
        const minHeight = 100;
        const maxHeight = totalHeight - 100; // Deja al menos 100px para la sección inferior
        
        const clampedHeight = Math.max(minHeight, Math.min(newTopHeight, maxHeight));
        
        // Calcula el porcentaje
        const newTopPercentage = (clampedHeight / totalHeight) * 100;

        // Aplica usando flex-basis
        topSection.style.flexBasis = `${newTopPercentage}%`;
        // bottomSection se ajustará automáticamente
        
        // Guarda el porcentaje en el estado para persistencia
        S.ui.sidebarTopHeight = `${newTopPercentage}%`; 
        // No guardes ('save()') en cada mousemove por rendimiento
    });

    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            sidebar.style.userSelect = ''; // Restaura selección de texto
            document.body.style.cursor = ''; // Restaura cursor
            save(); // Guarda el estado final
        }
    });
}

/**
 * Conecta las pestañas con su contenido y actualiza el botón Quick Add.
 */
function wireTabs(scopeSelector, prefix, contentPrefix){ 
  const root=$(scopeSelector); if (!root) return;
  const quickAddBtn = $('#quickAdd');
  
  root.querySelectorAll(`.tabs .tab[data-${prefix}]`).forEach(btn=>{
    btn.addEventListener('click',()=>{
      // Desactiva todas las pestañas
      root.querySelectorAll(`.tabs .tab[data-${prefix}]`).forEach(t=>t.classList.remove('active'));
      // Activa la clickeada
      btn.classList.add('active');
      const target = btn.dataset[prefix];
      
      // Oculta todos los paneles de contenido
      root.querySelectorAll(`[id^="${contentPrefix}-"]`).forEach(p=>p.style.display='none');
      // Muestra el panel correspondiente
      const pane = root.querySelector(`#${contentPrefix}-${target}`);
      if(pane) pane.style.display='block';

      // Lógica del botón "Quick Add"
      if (quickAddBtn) {
        let text = 'Nueva Tarea'; let handler = quickAddTask;
        let icon = 'plus';
        let isVisible = true;
        switch(target) {
            case 'tasks': text = 'Tarea'; handler = quickAddTask; icon = 'plus'; break;
            case 'notes': text = 'Nota'; handler = createNewNote; icon = 'plus'; break;
            case 'tables': text = 'Tabla'; handler = createNewTable; icon = 'plus-square'; break;
            case 'finance': text = 'Movimiento'; handler = ()=>{$('#finNew').click()}; icon = 'plus'; break;
            default: isVisible = false;
        }
        quickAddBtn.style.display = isVisible ? 'inline-flex' : 'none';
        quickAddBtn.innerHTML = `<i data-lucide="${icon}"></i> ${text}`;
        quickAddBtn.onclick = handler;
        lucide.createIcons();
      }
    });
  });
}

/* ============================================================================
SECCIÓN 11: LISTENERS ESPECÍFICOS DE MÓDULOS Y OTROS
============================================================================
*/

// --- Listeners Generales (ya configurados en init, añadimos los que faltan) ---
$('#loadIndustryBtn').onclick = () => { const industry = $('#industrySelect').value; loadIndustryTemplate(industry); $('#industryModal').close(); };
$('#newProject').onclick = createNewProject;
$('#q').addEventListener('keydown', e => { if (e.key === 'Enter') performSearch(); });
$('#menuBtn').onclick=()=>{
    const bodyClassList = document.body.classList;
    if (window.innerWidth <= 1180) {
        // En móvil, solo toggle 'aside-open'
        bodyClassList.toggle('aside-open');
        // No afecta 'aside-collapsed' ni guarda estado
    } else {
        // En desktop, toggle 'aside-collapsed' y guarda
        S.ui.asideCollapsed = !S.ui.asideCollapsed;
        bodyClassList.toggle('aside-collapsed', S.ui.asideCollapsed);
        save();
    }
};
$('#menu-overlay').onclick = () => document.body.classList.remove('aside-open');
$('#walletChip').onclick = () => { renderWallet(); $('#walletModal').showModal(); };
$('#intisChip').onclick = () => { $('#intisModal').showModal(); lucide.createIcons(); };
$('#wAdd').onclick = addWalletTransaction;
$('#resetApp').onclick=()=>{ showInputModal('Confirmar Eliminación Total', `Esto es irreversible. Escribe "BORRAR TODO" para confirmar.`, 'BORRAR TODO', (confirmText) => { if(confirmText === 'BORRAR TODO') { localStorage.clear(); window.location.reload(); } })}; // localStorage.clear() es más seguro
$('#tour-next').onclick = () => showTourStep(currentTourStep + 1);
$('#tour-prev').onclick = () => showTourStep(currentTourStep - 1);

// --- Listeners de Proyecto ---
wireTabs('#projectShell', 'ptab', 'p-tab');
// $('#quickAdd') se configura en wireTabs
$('#addColumnBtn').onclick = addColumn;
$('#addFolder').onclick = addFolder; 
$('#taskTagFilter').addEventListener('input', renderTasks); // Filtra al escribir

// Calendario de Proyecto
$('#prevM').onclick=()=>{calRef.setMonth(calRef.getMonth()-1); renderCalendar();};
$('#nextM').onclick=()=>{calRef.setMonth(calRef.getMonth()+1); renderCalendar();};
// Notas
$('#newNoteBtn').onclick = createNewNote;
$$('#p-tab-notes [data-cmd]').forEach(btn=>btn.onclick=()=>document.execCommand(btn.dataset.cmd, false, btn.dataset.value || null));
$('#clearCanvasBtn').onclick=()=>{ const id=S.activeProject; if(!id||!S.notes[id]?.active)return; delete S.notes[id].drawings[S.notes[id].active]; save(); initDrawingCanvas(S.notes[id].active); }; // Llama a initDrawingCanvas para limpiar
$('#exportNotePDF').onclick = () => exportNote('pdf');
// Archivos
$('#fileInput').onchange=(e)=>{ const id=S.activeProject; if(!id) return; if (!S.files[id]) S.files[id] = []; for(const f of e.target.files){ S.files[id].push({name:f.name,url:URL.createObjectURL(f), size:f.size}); } addIntis(5, 'Archivo subido'); save(); renderFiles(); renderOverview(); e.target.value = null; }; // Resetea input
// Chat IA de Proyecto
$('#newChat').onclick=()=>{ const id=S.activeProject; if(!id)return; if(!S.chats[id]) S.chats[id] = { threads: [], messages: {}, activeThread: null, model: 'pro' }; showInputModal('Nueva Conversación', 'Título de la nueva conversación:', 'Ej: Ideas para el blog', t => { const newId = 'c'+Date.now(); S.chats[id].threads.push({id:newId, title:t}); S.chats[id].activeThread = newId; if(!S.chats[id].messages) S.chats[id].messages={}; S.chats[id].messages[newId] = []; save(); renderProjectChat();})};
$$('#p-tab-chat .model-card:not(.disabled)').forEach(card => card.onclick=()=>{ const id=S.activeProject; if(!id || !S.chats[id])return; S.chats[id].model=card.dataset.model; save(); renderProjectChat(); });
$('#sendMsg').onclick = sendProjectChatMessage;
$('#chatMsg').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendProjectChatMessage(); }});
$('#p_attachFileBtn').onclick = () => $('#p_chatFileInput').click(); // Falta lógica de manejo de archivo
$('#chatToTasks').onclick=()=>{ const id=S.activeProject; if(!id) return; const C=S.chats[id]; if(!C?.activeThread) return; const lastMsg = C.messages[C.activeThread]?.filter(m=>m.who==='IA').pop(); if(!lastMsg) return showToast('No hay respuesta de IA para convertir.','warn'); const activeFolder = S.ui.activeFolder || 'General'; if (!S.tasks[id]) S.tasks[id] = {}; if (!S.tasks[id][activeFolder]) S.tasks[id][activeFolder] = []; S.tasks[id][activeFolder].push({id:'t'+Date.now(), title: (lastMsg.text || '').substring(0, 50) + "...", status:S.projects.find(p=>p.id===id)?.taskColumns[0] || 'Backlog', desc:lastMsg.text || '', due:'', folder: activeFolder, tags: []}); save(); renderTasks(); renderAside(); showToast('Tarea creada desde el chat.','success');};
// Tablas
$('#newTableBtn').onclick = createNewTable;
$('#tableSelector').onchange = (e) => { const projId = S.activeProject; if (!projId || !S.tables[projId]) return; S.tables[projId].active = e.target.value; save(); renderTables(); };
$('#addCol').onclick=()=>{ const id=S.activeProject; if(!id || !S.tables[id]) return; const activeTableId = S.tables[id].active; if (!activeTableId) return; const T=S.tables[id].data[activeTableId]; showInputModal('Nueva Columna', 'Nombre de la nueva columna:', `Col ${T.cols.length + 1}`, name => { if (!T.cols) T.cols = []; T.cols.push(name); if (!T.rows) T.rows = []; T.rows.forEach(r=>r.push('')); save(); renderTables(); })};
$('#addRow').onclick=()=>{ const id=S.activeProject; if(!id || !S.tables[id]) return; const activeTableId = S.tables[id].active; if (!activeTableId) return; const T=S.tables[id].data[activeTableId]; if (!T.cols) T.cols = ['Col 1']; if (!T.rows) T.rows = []; T.rows.push(new Array(T.cols.length).fill('')); save(); renderTables();};
$('#exportCSV').onclick=()=>{ const id=S.activeProject; if(!id || !S.tables[id]) return; const activeTableId = S.tables[id].active; if (!activeTableId) return; const T=S.tables[id].data[activeTableId]; const tableName = S.tables[id].list.find(t => t.id === activeTableId)?.name || 'tabla'; download(`${tableName}.csv`, csv([T.cols, ...T.rows]));};
// Finanzas de Proyecto
$('#finNew').onclick=()=>{ $('#projectFinModal').showModal(); };
$('#pF_Confirm').onclick = addProjectFinanceMove;
$('#finExport').onclick=()=>{ const id=S.activeProject; if(!id || !S.fin[id]) return; const F=S.fin[id]; const projName = S.projects.find(p=>p.id===id)?.name || 'proyecto'; download(`finanzas_${projName}.csv`, csv([['Fecha','Tipo','Monto','Cat','Nota'], ...F.rows.map(r=>[r.fecha,r.tipo,r.monto,r.cat,r.nota])]));};
// Vistas de Tareas
$('#viewToggleBoard').onclick = () => { S.ui.taskView = 'board'; save(); renderTasks(); };
$('#viewToggleList').onclick = () => { S.ui.taskView = 'list'; save(); renderTasks(); };
// Modal de Tareas
$('#taskDetailSaveBtn').onclick = saveTaskDetails;
$('#taskDetailDeleteBtn').onclick = () => deleteTask($('#taskDetailId').value);

// --- Listeners de Módulos Globales ---
// Cronopost
$('#cpProjectSelect').onchange = renderCronoPOST;
$('#cpPrevM').onclick = () => { cpRef.setMonth(cpRef.getMonth() - 1); renderCronoPOST(); };
$('#cpNextM').onclick = () => { cpRef.setMonth(cpRef.getMonth() + 1); renderCronoPOST(); };
$('#cpAddIdeaBtn').onclick = () => {
    const activeProjectId = $('#cpProjectSelect').value; 
    if (!activeProjectId || activeProjectId === 'all') { showToast('Por favor, selecciona un proyecto específico para añadir una idea.', 'warn'); return; }
    const title = $('#cpNewIdeaInput').value.trim(); if (!title) return;
    if(!S.cronopost.ideas[activeProjectId]) S.cronopost.ideas[activeProjectId] = [];
    S.cronopost.ideas[activeProjectId].push({ id: 'i' + Date.now(), title });
    addIntis(5, 'Idea de contenido');
    save(); renderCronoPOST(); $('#cpNewIdeaInput').value = '';
};
$('#cpGenAIIdeas').onclick = () => {
    const activeProjectId = $('#cpProjectSelect').value;
    if (!activeProjectId || activeProjectId === 'all') { showToast('Selecciona un proyecto para generar ideas con IA.', 'warn'); return; }
    if (!useCredits(CREDIT_COSTS.aiIdeas)) return;
    const projName = S.projects.find(p=>p.id===activeProjectId)?.name || 'tu proyecto';
    showToast('Generando ideas con IA...', 'info');
    setTimeout(()=> {
        const ideas = [`Campaña de "Detrás de Cámaras" para ${projName}`, `Colaboración con influencer de nicho`, `Contenido generado por usuarios (UGC)`];
        if (!S.cronopost.ideas[activeProjectId]) S.cronopost.ideas[activeProjectId] = []; // Asegura
        ideas.forEach(title => S.cronopost.ideas[activeProjectId].push({ id: 'i' + Date.now(), title }));
        save(); renderCronoPOST();
    }, 1500);
};
// Hub
wireTabs('#hub', 'htab', 'h-htab');
$('#avatar').onclick = () => $('#avatarInput').click();
$('#avatarInput').onchange = handleAvatarUpload;
$('#savePerfil').onclick = saveProfile;
$('#addMK').onclick = () => {
    // Asegura inicialización
    if (!S.hub) S.hub = JSON.parse(JSON.stringify(initialState.hub));
    if (!S.hub.market) S.hub.market = []; 
    const name = $('#mkName').value; const price = Number($('#mkPrice').value || 0); if (!name) return;
    S.hub.market.push({id:'m'+Date.now(), name, price, desc:$('#mkDesc').value});
    addIntis(20, 'Servicio publicado');
    save(); renderHub();
    ['#mkName', '#mkPrice', '#mkDesc'].forEach(s => $(s).value = '');
};
$('#addJob').onclick = addJob;
$('#jobSearchInput').oninput = renderJobs;
// Chat Global
$('#sendGChat').onclick = sendGChatMessage;
$('#gChatMsg').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendGChatMessage();} }); // Añadido shiftKey check
// Chat IA Global
$('#aiNewChat').onclick=()=>{ showInputModal('Nueva Conversación Global', 'Título de la nueva conversación:', 'Ej: Brainstorming General', t => { const newId = 'c_g_'+Date.now(); if(!S.aiGlobalChat) S.aiGlobalChat=JSON.parse(JSON.stringify(initialState.aiGlobalChat)); S.aiGlobalChat.threads.push({id:newId, title:t}); S.aiGlobalChat.messages[newId] = []; S.aiGlobalChat.activeThread = newId; save(); renderGlobalAIChat();})};
$('#aiSendMsg').onclick = sendGlobalAIChatMessage;
$$('#ai-global-chat .model-card:not(.disabled)').forEach(card => card.onclick = () => { if(S.aiGlobalChat) S.aiGlobalChat.model = card.dataset.model; save(); renderGlobalAIChat(); });
$('#aiChatMsg').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendGlobalAIChatMessage(); }});
$('#g_attachFileBtn').onclick = () => $('#g_chatFileInput').click(); // Falta lógica de manejo
$('#aiImageGenBtn').onclick = () => showInputModal('Generar Imagen con IA', 'Describe la imagen que quieres crear:', 'Un gato astronauta en marte', p => { $('#aiChatMsg').value = `Crea una imagen de ${p}`; sendGlobalAIChatMessage(); });

// --- Ejecutar Inicialización al cargar el DOM ---
document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>

