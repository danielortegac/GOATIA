<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOATBOT Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
    </script>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <style>
        :root {
            --bg-dark: #121212; --bg-medium: #1e1e1e; --bg-light: #2c2c2c; --primary: #8a4fff; --primary-hover: #7b46e6; --text-light: #e0e0e0; --text-medium: #b3b3b3; --border-color: #3a3a3a;
            --light-bg-dark: #f7f7f8; --light-bg-medium: #ffffff; --light-bg-light: #f0f0f0; --light-primary: #7c40e6; --light-primary-hover: #6a37d3; --light-text-dark: #1f2937; --light-text-medium: #6b7280; --light-border-color: #e5e7eb;
        }
        /* Basic styles */
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; font-size: 16px; }
        
        /* Theming */
        .dark-theme { --current-bg-dark: var(--bg-dark); --current-bg-medium: var(--bg-medium); --current-bg-light: var(--bg-light); --current-primary: var(--primary); --current-primary-hover: var(--primary-hover); --current-text-light: var(--text-light); --current-text-medium: var(--text-medium); --current-border-color: var(--border-color); background-color: var(--current-bg-dark); color: var(--text-light); }
        .light-theme { --current-bg-dark: var(--light-bg-dark); --current-bg-medium: var(--light-bg-medium); --current-bg-light: var(--light-bg-light); --current-primary: var(--light-primary); --current-primary-hover: var(--light-primary-hover); --current-text-light: var(--light-text-dark); --current-text-medium: var(--light-text-medium); --current-border-color: var(--light-border-color); background-color: var(--light-bg-dark); color: var(--light-text-dark); }
        
        /* Component theming */
        #sidebar { background-color: var(--current-bg-dark); border-right: 1px solid var(--current-border-color); }
        #main-chat-area, .modal-content { background-color: var(--current-bg-medium); }
        .chat-bubble-bot, .bg-input, #pdf-preview-container, .chat-item, .project-header, #user-menu-popup { background-color: var(--current-bg-light); }
        .border-themed { border-color: var(--current-border-color); }
        .chat-bubble-user { background-color: var(--current-primary); color: white; }
        .btn-primary { background-color: var(--current-primary); color: white; }
        .btn-primary:hover { background-color: var(--current-primary-hover); }
        .plan-card-highlight { border-color: var(--current-primary); box-shadow: 0 0 15px rgba(138, 79, 255, 0.3); }
        .placeholder-themed::placeholder { color: var(--current-text-medium); }
        .text-primary { color: var(--current-primary); }
        
        /* Animations & Effects */
        .glowing-mic { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(138, 79, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0); } }
        
        /* Project accordion */
        .project .project-content { display: none; }
        .project.open .project-content { display: block; }
        .project.open .project-arrow { transform: rotate(90deg); }
        .project-header.drag-over { background-color: var(--current-primary); }

        /* Code Block Styling */
        .code-block { background-color: #0d1117; border: 1px solid var(--current-border-color); border-radius: 0.5rem; overflow: hidden; margin-top: 1rem; }
        .code-block-header { display: flex; align-items: center; justify-content: space-between; background-color: #161b22; padding: 0.5rem 1rem; font-size: 0.8rem; color: var(--text-medium); }
        .code-block-header span { font-family: monospace; }
        .code-block-header button { background-color: transparent; border: none; color: var(--text-medium); cursor: pointer; padding: 0.25rem; border-radius: 0.25rem; }
        .code-block-header button:hover { background-color: rgba(255, 255, 255, 0.1); }
        .code-block-body { padding: 1rem; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.875rem; white-space: pre-wrap; color: var(--text-light); }
        .code-block-body::-webkit-scrollbar { width: 6px; }
        .code-block-body::-webkit-scrollbar-thumb { background: #3a3a3a; border-radius: 3px; }
        .code-block-body::-webkit-scrollbar-track { background: transparent; }

        /* Mobile specific adjustments */
        #sidebar.is-open { transform: translateX(0); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        
        @media (max-width: 767px) {
            #main-chat-area {
                height: 100%;
            }
             #input-area {
                padding-bottom: 1rem;
             }
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden dark-theme">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-bg-dark bg-opacity-95 flex flex-col items-center justify-center z-[100] transition-opacity duration-300">
        <img src="https://raw.githubusercontent.com/GoatFactoryDev/goatbot/main/logo-goatify-header.png" alt="GOATIFY Logo" class="w-24 h-24 object-contain mb-6 animate-pulse" onerror="this.onerror=null;this.src='https://placehold.co/96x96/121212/e0e0e0?text=LOGO';">
        <div class="text-text-light text-center">
             <i class="fas fa-spinner fa-spin fa-2x"></i>
             <p class="mt-3 text-lg font-semibold">Inicializando...</p>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden opacity-0 pointer-events-none"></div>

    <!-- App Container -->
    <div id="app-container" class="flex h-full w-full relative opacity-0 transition-opacity duration-300">
        <aside id="sidebar" class="w-72 flex-shrink-0 flex flex-col p-3 transition-transform duration-300 -translate-x-full md:translate-x-0 absolute md:relative z-30 h-full">
            <div class="flex-shrink-0">
                <div id="logo-space" class="w-24 h-24 rounded-lg mx-auto mb-4 flex items-center justify-center overflow-hidden bg-input">
                    <img src="https://raw.githubusercontent.com/GoatFactoryDev/goatbot/main/logo-goatify-header.png" alt="GOATIFY Logo" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                </div>
                <div class="flex flex-col space-y-2 mb-4">
                    <button id="new-chat-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-plus mr-2"></i><span>Nuevo Chat</span></button>
                    <button id="new-project-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg bg-input"><i class="fas fa-folder-plus mr-2"></i><span>Nuevo Proyecto</span></button>
                    <button id="upgrade-plan-btn" class="hidden flex items-center justify-center font-semibold p-3 rounded-lg bg-yellow-500 text-black hover:bg-yellow-400"><i class="fas fa-rocket mr-2"></i><span>Mejorar Plan</span></button>
                </div>
            </div>
            <div class="flex-shrink-0 border-t border-b border-themed my-3 py-3">
                <h3 class="text-xs font-semibold uppercase text-text-medium mb-2 px-2">Workflows</h3>
                <div class="space-y-1">
                    <button id="copywriting-workflow-btn" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center"><i class="fas fa-pencil-alt w-6 mr-2"></i>Copywriting</button>
                    <button id="sales-response-workflow-btn" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center"><i class="fas fa-handshake w-6 mr-2"></i>Respuestas de Ventas</button>
                    <button id="web-page-workflow-btn" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center"><i class="fas fa-code w-6 mr-2"></i>P√°gina Web</button>
                    <button id="english-teacher-workflow-btn" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center"><i class="fas fa-language w-6 mr-2"></i>English Teacher</button>
                </div>
            </div>
            <div id="sidebar-content" class="flex-grow overflow-y-auto pr-1 space-y-1"></div>
            <div id="user-section" class="flex-shrink-0 border-t border-themed mt-2 pt-3">
                <div id="login-view" class="hidden">
                    <button id="login-btn" class="w-full flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-sign-in-alt mr-2"></i><span>Iniciar Sesi√≥n / Registrarse</span></button>
                </div>
                <div id="user-menu-view" class="hidden relative">
                    <button id="user-menu-btn" class="w-full flex items-center text-left p-2 rounded-lg hover:bg-light transition-colors">
                        <span id="user-email" class="flex-grow truncate text-sm font-semibold"></span>
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <div id="user-menu-popup" class="absolute bottom-full left-0 w-full mb-2 rounded-lg p-2 border border-themed shadow-lg hidden">
                        <button id="logout-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-sign-out-alt w-6 mr-2"></i>Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </div>
        </aside>

        <main id="main-chat-area" class="flex-1 flex flex-col h-full">
           <header class="flex items-center justify-between p-2 md:p-4 border-b border-themed flex-shrink-0">
                <button id="menu-toggle" class="md:hidden text-xl p-2"><i class="fas fa-bars"></i></button>
                <h1 id="chat-title" class="text-lg font-semibold truncate cursor-pointer mx-2" title="Renombrar Chat">GOATBOT Pro</h1>
                <div class="flex items-center space-x-1 md:space-x-2">
                    <div id="voice-selector-container" class="flex items-center space-x-2">
                        <select id="voice-selector" class="rounded-md p-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-purple-500 bg-input text-text-light border border-themed"></select>
                    </div>
                    <div id="message-counter" class="hidden sm:block text-xs font-mono"></div>
                    <button id="ttsToggle" title="Activar/Desactivar Voz" class="text-xl hover:opacity-80 transition-colors p-2"><i class="fa fa-volume-high"></i></button>
                    <button id="theme-toggle" title="Cambiar Tema" class="text-xl p-2"><i class="fas fa-moon" id="theme-icon"></i></button>
                </div>
            </header>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-3 sm:p-6">
                <div class="flex justify-center items-center h-full" id="initial-message-container">
                    <div id="welcome-message-wrapper" class="text-center text-text-medium">
                        <img src="https://raw.githubusercontent.com/GoatFactoryDev/goatbot/main/logo-goatify-header.png" alt="GOATIFY Logo" class="w-24 h-24 object-contain mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                        <div id="personalized-welcome" class="hidden">
                            <h2 class="text-2xl font-bold">¬°Hola, <span id="user-name"></span>!</h2>
                            <p class="text-lg mt-1">Hoy es un gran d√≠a. ¬°Puedes con todo!</p>
                        </div>
                        <div id="generic-welcome" class="hidden">
                            <p class="text-xl">¬øC√≥mo puedo ayudarte hoy?</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="input-area" class="p-2 sm:p-4 border-t border-themed">
                <div id="file-preview-area" class="mb-3 space-y-2 px-1 sm:px-0">
                    <div id="image-preview-container" class="hidden relative w-24 h-24 sm:w-32 sm:h-32 rounded-lg overflow-hidden border border-themed">
                        <img id="image-preview" src="#" alt="Image Preview" class="w-full h-full object-contain">
                        <button id="clear-image-btn" class="absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs z-10"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="pdf-preview-container" class="hidden relative p-3 rounded-lg border-themed">
                         <div class="flex items-center"><i class="fas fa-file-pdf text-red-500 text-3xl mr-4 flex-shrink-0"></i><div class="flex-grow min-w-0"><p id="pdf-name" class="text-sm font-medium truncate"></p><p id="pdf-status" class="text-xs font-mono"></p></div></div><button id="clear-pdf-btn" class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs z-10"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="flex items-center space-x-3 mb-3 px-1 sm:px-2">
                    <label for="model-selector" class="font-medium text-sm text-text-medium">Modelo:</label>
                    <select id="model-selector" class="rounded-md p-1.5 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm bg-input text-text-light border border-themed">
                        <option value="gpt-3.5-turbo">Goatify Pro (Texto)</option>
                        <option value="gpt-4o">Goatify Nebula (Archivos)</option>
                        <option value="perplexity/sonar-small-online">B√∫squeda Web (Sonar)</option>
                    </select>
                </div>
                <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2">
                    <input type="file" id="pdf-upload" accept=".pdf,application/pdf" class="hidden"><input type="file" id="image-upload" accept="image/*" class="hidden">
                    <button id="pdf-upload-btn" title="Subir PDF" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-file-pdf text-xl"></i></button>
                    <button id="image-upload-btn" title="Subir Imagen" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-image text-xl"></i></button>
                    <button id="web-search-btn" title="Activar B√∫squeda Web" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-globe text-xl"></i></button>
                    <button id="voice" title="Hablar" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-microphone text-xl"></i></button>
                    <textarea id="msg" placeholder="Escribe tu mensaje..." class="flex-1 bg-transparent p-2 h-12 resize-none outline-none placeholder-themed" rows="1"></textarea>
                    <button id="send" title="Enviar" class="p-2 sm:p-4 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i id="send-icon" class="fa fa-paper-plane text-xl"></i></button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-sm p-6 relative">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3><p id="modal-message" class="mb-4 text-text-medium"></p>
            <input type="text" id="modal-input" class="w-full p-2 rounded mb-4 hidden bg-input border border-themed" placeholder="">
            <div class="flex justify-end space-x-2">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded">Cancelar</button><button id="modal-confirm" class="px-4 py-2 rounded text-white btn-primary">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="pricing-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-4xl p-8 relative transform scale-95 transition-transform duration-300">
            <button id="close-pricing-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            <div class="text-center mb-8"><h2 class="text-3xl md:text-4xl font-extrabold">Elige el Plan Perfecto Para Ti</h2><p class="text-lg text-text-medium mt-2">Desbloquea todo el potencial de Goatify.</p></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col"><h3 class="text-2xl font-bold">Free Ride</h3><p class="text-4xl font-extrabold my-4">$0<span class="text-lg font-medium text-text-medium"> / mes</span></p><ul class="space-y-3 text-sm flex-grow mb-6"><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>15 cr√©ditos / mes</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Organizaci√≥n por Proyectos</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Acceso a Workflows</li><li class="flex items-center"><i class="fas fa-times-circle text-red-500 mr-2"></i>Soporte prioritario</li></ul><button class="mt-auto w-full p-3 rounded-lg font-semibold bg-input cursor-default">Tu Plan Actual</button></div>
                <div class="plan-card border-2 rounded-xl p-6 flex flex-col plan-card-highlight relative"><span class="absolute -top-3.5 left-1/2 -translate-x-1/2 bg-primary text-white text-xs font-bold px-3 py-1 rounded-full">M√ÅS POPULAR</span><h3 class="text-2xl font-bold">GoatBoost</h3><p class="text-4xl font-extrabold my-4">$7<span class="text-lg font-medium text-text-medium"> / mes</span></p><ul class="space-y-3 text-sm flex-grow mb-6"><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>300 cr√©ditos / mes</li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Workflows Pro</li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Modelo Web Pro (GPT-4o)</li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Hist√≥rico ilimitado</li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Soporte v√≠a email</li></ul><button data-plan="boost" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors">Seleccionar Plan</button></div>
                <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col"><h3 class="text-2xl font-bold">GoatForce Pro</h3><p class="text-4xl font-extrabold my-4">$17<span class="text-lg font-medium text-text-medium"> / mes</span></p><ul class="space-y-3 text-sm flex-grow mb-6"><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>3,000 cr√©ditos / mes</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Acceso a todos los modelos</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>API key propia (Opcional)</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Webinars mensuales</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Comunidad privada</li></ul><button data-plan="pro" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors">Seleccionar Plan</button></div>
            </div>
        </div>
    </div>
    <div id="html-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full h-full max-w-4xl p-2 md:p-4 relative flex flex-col">
            <div class="flex-shrink-0 flex items-center justify-between mb-2">
                <h3 class="text-lg font-bold">Vista Previa</h3>
                <button id="close-html-preview-modal" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <iframe id="html-preview-iframe" class="w-full flex-grow h-full border-2 border-themed rounded-lg bg-white"></iframe>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        // **RESTRUCTURED SCRIPT START**
        window.addEventListener('DOMContentLoaded', () => {
            // All script logic is now placed here, ensuring everything is defined before use.
            
            // 1. CONSTANTS & STATE
            const GUEST_CREDIT_LIMIT = 5;
            const FREE_PLAN_CREDIT_LIMIT = 15;
            const COSTS = { WEB_PAGE: 3, COPYWRITING: 2, SALES_RESPONSE: 2, NEBULA: 2, GENERAL: 1, SEARCH: 1, ENGLISH_TEACHER: 1 };
            let state = { chats: {}, projects: {}, structure: [] };
            let currentChatId = null, currentUser = null, pendingMessage = null, speechOn = true, availableVoices = [], selectedVoice = null, isRecognizing = false, selectedImageBase64 = null, selectedPdfText = null, isWebSearchMode = false;
            let modalResolve = null;

            // 2. DOM ELEMENTS
            const dom = {
                msgInput: document.getElementById('msg'), sendBtn: document.getElementById('send'),
                messageCounterEl: document.getElementById('message-counter'), upgradePlanBtn: document.getElementById('upgrade-plan-btn'),
                newChatBtn: document.getElementById('new-chat-btn'), newProjectBtn: document.getElementById('new-project-btn'),
                pricingModal: document.getElementById('pricing-modal'), closePricingModalBtn: document.getElementById('close-pricing-modal'),
                genericModal: document.getElementById('generic-modal'), chatMessages: document.getElementById('chat-messages'),
                chatTitle: document.getElementById('chat-title'), initialMessageContainer: document.getElementById('initial-message-container'),
                themeToggle: document.getElementById('theme-toggle'), themeIcon: document.getElementById('theme-icon'),
                voiceBtn: document.getElementById('voice'), ttsToggle: document.getElementById('ttsToggle'),
                modelSelector: document.getElementById('model-selector'),
                imageUploadBtn: document.getElementById('image-upload-btn'), imageUploadInput: document.getElementById('image-upload'),
                imagePreviewContainer: document.getElementById('image-preview-container'), imagePreview: document.getElementById('image-preview'),
                clearImageBtn: document.getElementById('clear-image-btn'),
                pdfUploadBtn: document.getElementById('pdf-upload-btn'), pdfUploadInput: document.getElementById('pdf-upload'),
                pdfPreviewContainer: document.getElementById('pdf-preview-container'), pdfNameEl: document.getElementById('pdf-name'),
                pdfStatusEl: document.getElementById('pdf-status'), clearPdfBtn: document.getElementById('clear-pdf-btn'),
                sidebar: document.getElementById('sidebar'), menuToggle: document.getElementById('menu-toggle'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarContent: document.getElementById('sidebar-content'),
                loginView: document.getElementById('login-view'), userMenuView: document.getElementById('user-menu-view'),
                loginBtn: document.getElementById('login-btn'), userMenuBtn: document.getElementById('user-menu-btn'),
                userMenuPopup: document.getElementById('user-menu-popup'), userEmail: document.getElementById('user-email'),
                logoutBtn: document.getElementById('logout-btn'),
                personalizedWelcome: document.getElementById('personalized-welcome'),
                genericWelcome: document.getElementById('generic-welcome'),
                userName: document.getElementById('user-name'),
                loadingOverlay: document.getElementById('loading-overlay'),
                appContainer: document.getElementById('app-container'),
                copywritingWorkflowBtn: document.getElementById('copywriting-workflow-btn'),
                salesResponseWorkflowBtn: document.getElementById('sales-response-workflow-btn'),
                webPageWorkflowBtn: document.getElementById('web-page-workflow-btn'),
                englishTeacherWorkflowBtn: document.getElementById('english-teacher-workflow-btn'),
                htmlPreviewModal: document.getElementById('html-preview-modal'),
                closeHtmlPreviewModalBtn: document.getElementById('close-html-preview-modal'),
                htmlPreviewIframe: document.getElementById('html-preview-iframe'),
                voiceSelector: document.getElementById('voice-selector'),
                webSearchBtn: document.getElementById('web-search-btn'),
            };
            
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            // --- HELPER & CORE FUNCTIONS ---
            
            function showModal({ title, message, useInput = false, placeholder = '', confirmText = 'Confirmar' }) {
                const modalTitle = dom.genericModal.querySelector('#modal-title'), modalMessage = dom.genericModal.querySelector('#modal-message'), modalInput = dom.genericModal.querySelector('#modal-input'), modalConfirm = dom.genericModal.querySelector('#modal-confirm');
                modalTitle.textContent = title; modalMessage.textContent = message; modalMessage.style.display = message ? 'block' : 'none'; modalInput.style.display = useInput ? 'block' : 'none'; modalInput.value = ''; modalInput.placeholder = placeholder; modalConfirm.textContent = confirmText;
                dom.genericModal.classList.remove('hidden'); dom.genericModal.classList.add('flex');
                if (useInput) modalInput.focus();
                return new Promise(resolve => { modalResolve = resolve; });
            }
            function hideModal(resolveWith = null) { if(modalResolve) { modalResolve(resolveWith); modalResolve = null; } dom.genericModal.classList.add('hidden'); dom.genericModal.classList.remove('flex');  }
            function showPricingModal() { dom.pricingModal.classList.remove('hidden'); dom.pricingModal.classList.add('flex'); setTimeout(() => { dom.pricingModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10); }
            function hidePricingModal() { dom.pricingModal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => { dom.pricingModal.classList.add('hidden'); dom.pricingModal.classList.remove('flex'); }, 300); }
            
            function speak(text) { 
                if (!speechOn || !('speechSynthesis' in window) || !text) return; 
                speechSynthesis.cancel(); 
                const cleanText = text.replace(/[*_`#~[\]()üîç]|(-{3,})|(\*\*Fuente:\*\*.*)/g, ''); 
                const utterance = new SpeechSynthesisUtterance(cleanText); 
                if (selectedVoice) utterance.voice = selectedVoice;
                speechSynthesis.speak(utterance); 
            }

            function populateVoiceList() {
                const voiceContainer = dom.voiceSelector.parentElement;

                const setVoices = () => {
                    if (typeof speechSynthesis === 'undefined') {
                        voiceContainer.style.display = 'flex';
                        dom.voiceSelector.innerHTML = '<option value="">No hay voces</option>';
                        dom.voiceSelector.disabled = true;
                        return;
                    }

                    const allVoices = speechSynthesis.getVoices();
                    const preferredVoices = [ "Microsoft Sabina Online (Natural) - Spanish (Mexico)", "Paulina", "Google espa√±ol de Estados Unidos", "Google espa√±ol" ];
                    
                    availableVoices = allVoices.filter(v => v.lang.startsWith('es-') && !v.lang.startsWith('es-ES'));
                    
                    if (availableVoices.length === 0) {
                        availableVoices = allVoices.filter(v => v.lang.startsWith('es-'));
                    }
                    
                    availableVoices.sort((a, b) => {
                        let aIdx = preferredVoices.indexOf(a.name); let bIdx = preferredVoices.indexOf(b.name);
                        if (aIdx === -1) aIdx = Infinity; if (bIdx === -1) bIdx = Infinity;
                        if (aIdx !== bIdx) return aIdx - bIdx;
                        return a.name.localeCompare(b.name);
                    });

                    dom.voiceSelector.innerHTML = '';
                    voiceContainer.style.display = 'flex';

                    if(availableVoices.length === 0) {
                        dom.voiceSelector.innerHTML = '<option value="">No hay voces</option>';
                        dom.voiceSelector.disabled = true;
                    } else {
                        dom.voiceSelector.disabled = false;
                        availableVoices.forEach(voice => {
                            const option = document.createElement('option');
                            const displayName = voice.name.replace('Microsoft', '').replace('Online (Natural) -', '').replace('Google', '').replace('Spanish (Mexico)','Mex').trim();
                            option.textContent = displayName || voice.lang;
                            option.value = voice.name;
                            dom.voiceSelector.appendChild(option);
                        });
                        selectedVoice = availableVoices[0];
                        if (selectedVoice) dom.voiceSelector.value = selectedVoice.name;
                    }
                }

                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = setVoices;
                }
                
                setTimeout(setVoices, 200);
            }
            
            async function getAIResponse(prompt, history, image, pdf, model, workflow) {
                 const token = currentUser ? await currentUser.jwt() : null;

                // Prepend system prompts based on workflow and general personality
                let fullHistory = [...history];
                
                // General friendly personality prompt
                const friendlyPrompt = {
                    role: "system",
                    content: "Eres GOATBOT, un asistente de IA excepcionalmente amable y servicial. Siempre saluda al usuario con cari√±o y de forma positiva (ej. '¬°Muy buenos d√≠as! Espero que tengas un d√≠a incre√≠ble. ¬øC√≥mo te sientes hoy?'), y desp√≠dete de forma muy atenta (ej. '¬°Fue un verdadero placer ayudarte! Estoy a tus √≥rdenes para lo que necesites. ¬°Que tengas un excelente d√≠a!'). Trata al usuario con el m√°ximo respeto, empat√≠a y positividad en todo momento."
                };
                
                // Add friendly prompt if it's the first message from the assistant
                if (history.filter(m => m.role === 'assistant').length === 0) {
                    fullHistory.unshift(friendlyPrompt);
                }

                // Specific workflow prompt for English Teacher
                if (workflow === 'english-teacher') {
                    const teacherPrompt = {
                        role: "system",
                        content: "You are an expert English Teacher and translator. Your primary language for conversation is English. ALWAYS respond in English. If the user writes or speaks in English and makes a mistake, gently correct them, explain the error briefly, and then provide the correct version before continuing the conversation. If the user asks for a translation, provide it clearly. You must always speak your full English response. Only provide Spanish text if the user explicitly asks for a translation or an explanation in Spanish."
                    };
                    fullHistory.unshift(teacherPrompt);
                }

                const response = await fetch('/.netlify/functions/get-ai-response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...(token && { 'Authorization': `Bearer ${token}` }) },
                    body: JSON.stringify({ prompt, history: fullHistory, model, imageData: image, pdfText: pdf })
                });
                if (response.status === 403) return { error: 'LIMIT_REACHED' };
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.details || `Error del servidor: ${response.statusText}`);
                }
                return response.json();
            }

            function getCreditCount() { return currentUser ? (currentUser.app_metadata.credits !== undefined ? currentUser.app_metadata.credits : FREE_PLAN_CREDIT_LIMIT) : parseInt(localStorage.getItem('guestCreditCount') || '0'); }
            function setCreditCount(count) {
                const newCount = Math.max(0, count); 
                if(currentUser) {
                    currentUser.app_metadata.credits = newCount;
                } else {
                     localStorage.setItem('guestCreditCount', String(newCount));
                }
                updateCreditCounter();
            }
            
            function loadStateForUser() {
                const key = currentUser ? `goatbotState_${currentUser.id}` : 'guestState';
                const saved = localStorage.getItem(key);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    state = parsed.state || { chats: {}, projects: {}, structure: [] };
                    currentChatId = parsed.currentChatId;
                } else {
                    state = { chats: {}, projects: {}, structure: [] };
                    currentChatId = null;
                }
                renderSidebar();
                selectChat(currentChatId);
            }

            function saveState() { localStorage.setItem(currentUser ? `goatbotState_${currentUser.id}` : 'guestState', JSON.stringify({ state, currentChatId })); }
            
            function updateUserUI() {
                if (currentUser) {
                    dom.loginView.classList.add('hidden');
                    dom.userMenuView.classList.remove('hidden');
                    dom.genericWelcome.classList.add('hidden');
                    dom.personalizedWelcome.classList.remove('hidden');
                    const userName = currentUser.user_metadata.full_name?.split(' ')[0] || currentUser.email.split('@')[0];
                    dom.userEmail.textContent = currentUser.user_metadata.full_name || currentUser.email;
                    dom.userName.textContent = userName;
                    dom.upgradePlanBtn.classList.toggle('hidden', (currentUser.app_metadata.plan || 'free') !== 'free');
                } else {
                    dom.loginView.classList.remove('hidden');
                    dom.userMenuView.classList.add('hidden');
                    dom.genericWelcome.classList.remove('hidden');
                    dom.personalizedWelcome.classList.add('hidden');
                    dom.upgradePlanBtn.classList.add('hidden');
                }
                updateCreditCounter();
            }

            function updateCreditCounter() {
                const count = getCreditCount();
                const limit = currentUser ? FREE_PLAN_CREDIT_LIMIT : GUEST_CREDIT_LIMIT;
                const planName = currentUser ? 'Plan Gratuito' : 'Invitado';
                dom.messageCounterEl.textContent = `${planName}: ${count}/${limit} cr√©ditos`;
            }

            function setTheme(isDark) { 
                document.body.className = 'h-screen w-screen overflow-hidden';
                document.body.classList.add(isDark ? 'dark-theme' : 'light-theme');
                dom.themeIcon.className = `fas fa-${isDark ? 'sun' : 'moon'}`; 
                localStorage.setItem('theme', isDark ? 'dark' : 'light'); 
            }

            function toggleSidebar(show) {
                if (show) {
                    dom.sidebar.classList.add('is-open');
                    dom.sidebarOverlay.classList.remove('pointer-events-none');
                    dom.sidebarOverlay.classList.add('opacity-50');
                } else {
                    dom.sidebar.classList.remove('is-open');
                    dom.sidebarOverlay.classList.remove('opacity-50');
                    dom.sidebarOverlay.classList.add('pointer-events-none');
                }
            }
            
            function createNewChat(options = {}) {
                const id = 'chat-' + crypto.randomUUID(); 
                state.chats[id] = { 
                    id, 
                    title: options.title || "Nuevo Chat", 
                    messages: options.initialMessages || [],
                    workflow: options.workflow || null,
                    model: options.model || 'gpt-3.5-turbo'
                }; 
                state.structure.unshift(id); 
                selectChat(id); 
                saveState(); 
                renderSidebar(); 
                dom.modelSelector.value = options.model || (options.workflow ? 'gpt-4o' : 'gpt-3.5-turbo');
                updateWebSearchButtonState();
                if (window.innerWidth < 768) toggleSidebar(false);
                return id; 
            }

            function selectChat(chatId) { 
                if (!chatId || !state.chats[chatId]) { 
                    resetChatView(); 
                    return; 
                } 
                currentChatId = chatId; 
                dom.initialMessageContainer.style.display = 'none'; 
                dom.chatMessages.innerHTML = ''; 
                const chat = state.chats[chatId]; 
                dom.chatTitle.textContent = chat.title; 
                chat.messages.forEach((msg) => addMessageToUI(msg.role, msg.content, msg.image)); 
                dom.modelSelector.value = chat.model || 'gpt-3.5-turbo';
                updateWebSearchButtonState();
                updateActiveChatHighlight(); 
                saveState();
                if (window.innerWidth < 768) toggleSidebar(false);
            }
            function resetChatView() { currentChatId = null; dom.chatTitle.textContent = "GOATBOT Pro"; dom.chatMessages.innerHTML = ''; dom.initialMessageContainer.style.display = 'flex'; updateUserUI(); updateActiveChatHighlight(); dom.modelSelector.value = 'gpt-3.5-turbo'; updateWebSearchButtonState(); }
            
            function renderCodeBlock(content) {
                const codeBlock = document.createElement('div');
                codeBlock.className = 'code-block';
                const header = document.createElement('div');
                header.className = 'code-block-header';
                header.innerHTML = `<span>HTML</span><button title="Copiar c√≥digo"><i class="fas fa-copy"></i></button>`;
                const body = document.createElement('pre');
                body.className = 'code-block-body';
                body.textContent = content;
                header.querySelector('button').addEventListener('click', (e) => {
                    const textarea = document.createElement('textarea');
                    textarea.value = content;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                      document.execCommand('copy');
                      e.currentTarget.innerHTML = '<i class="fas fa-check"></i> ¬°Copiado!';
                    } catch (err) {
                      e.currentTarget.innerHTML = '<i class="fas fa-times"></i> Error';
                    }
                    document.body.removeChild(textarea);
                    setTimeout(() => e.currentTarget.innerHTML = '<i class="fas fa-copy"></i>', 2000);
                });
                codeBlock.append(header, body);
                return codeBlock;
            }

            function addMessageToUI(role, content, imageSrc) {
                const wrapper = document.createElement('div');
                wrapper.className = `chat-bubble-wrapper flex items-start gap-2 my-2 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                const bubble = document.createElement('div');
                bubble.className = `p-3 md:p-4 rounded-xl max-w-lg md:max-w-xl ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot'}`;
                if (imageSrc) {
                    const img = document.createElement('img');
                    img.src = imageSrc;
                    img.className = 'rounded-lg mb-2 max-w-xs h-auto';
                    bubble.appendChild(img);
                }
                const contentDiv = document.createElement('div');
                contentDiv.className = 'markdown-content';
                const currentChat = state.chats[currentChatId];
                if (role === 'assistant' && currentChat?.workflow === 'web-page' && /<\/?[a-z][\s\S]*>/i.test(content)) {
                    contentDiv.innerHTML = 'Aqu√≠ tienes el c√≥digo para tu p√°gina web:';
                    contentDiv.appendChild(renderCodeBlock(content));
                } else {
                    contentDiv.innerHTML = content === '‚Ä¶' ? `<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .2s;"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .4s;"></div></div>` : marked.parse(content || "");
                }
                bubble.appendChild(contentDiv);
                if (role === 'assistant' && currentChat?.workflow === 'web-page' && /<\/?[a-z][\s\S]*>/i.test(content)) {
                    const actionsWrapper = document.createElement('div');
                    actionsWrapper.className = 'mt-3 pt-3 border-t border-themed flex items-center gap-2';
                    const previewBtn = document.createElement('button');
                    previewBtn.innerHTML = '<i class="fas fa-eye mr-2"></i>Vista Previa';
                    previewBtn.className = 'text-xs font-semibold py-1 px-2 rounded bg-input hover:bg-opacity-70';
                    previewBtn.onclick = () => {
                        const blob = new Blob([content], { type: 'text/html' });
                        const url = URL.createObjectURL(blob);
                        dom.htmlPreviewIframe.src = url;
                        dom.htmlPreviewModal.classList.remove('hidden');
                        dom.htmlPreviewIframe.onload = () => URL.revokeObjectURL(url);
                    };
                    actionsWrapper.appendChild(previewBtn);
                    bubble.appendChild(actionsWrapper);
                }
                wrapper.appendChild(bubble);
                dom.chatMessages.appendChild(wrapper);
                dom.chatMessages.scrollTop = dom.chatMessages.scrollHeight;
                return bubble;
            }
            
            function updateMessageInUI(bubble, content) {
                 const newBubble = addMessageToUI('assistant', content);
                 if (bubble && bubble.parentElement) {
                     bubble.parentElement.replaceWith(newBubble.parentElement);
                 }
            }

            function renderSidebar() { dom.sidebarContent.innerHTML = ''; const frag = document.createDocumentFragment(); (state.structure || []).forEach(id => { if (id.startsWith('project-')) frag.appendChild(createProjectElement(id)); else if (id.startsWith('chat-')) frag.appendChild(createChatItemElement(id)); }); dom.sidebarContent.appendChild(frag); updateActiveChatHighlight(); }
            function createChatItemElement(id, isSubItem = false) { const chat = state.chats[id]; if (!chat) return document.createDocumentFragment(); const item = document.createElement('div'); item.className = `chat-item group flex items-center justify-between p-2 rounded-md cursor-pointer ${isSubItem ? 'pl-5' : ''}`; item.dataset.id = id; item.draggable = true; item.innerHTML = `<i class="far fa-comment-dots mr-2"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span><div class="chat-item-actions flex-shrink-0"><button class="rename-btn text-text-medium hover:text-primary p-1"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-text-medium hover:text-red-500 p-1"><i class="fas fa-trash-alt fa-xs"></i></button></div>`; item.addEventListener('click', e => { if (!e.target.closest('.chat-item-actions')) selectChat(id); }); item.addEventListener('dragstart', e => handleDragStart(e, id)); item.querySelector('.rename-btn').addEventListener('click', () => renameItem('chat', id)); item.querySelector('.delete-btn').addEventListener('click', () => deleteItem('chat', id)); return item; }
            function createProjectElement(id) {
                const project = state.projects[id];
                if (!project) return document.createDocumentFragment();
                const div = document.createElement('div'); div.className = 'project'; div.dataset.id = id;
                const header = document.createElement('div'); header.className = 'project-header group flex items-center p-2 rounded-md cursor-pointer';
                header.innerHTML = `<i class="fas fa-chevron-right project-arrow mr-2 transition-transform"></i><i class="fas fa-folder mr-2 text-yellow-500"></i><span class="flex-grow truncate text-sm font-bold">${project.title}</span><div class="chat-item-actions flex-shrink-0"><button class="rename-btn text-text-medium hover:text-primary p-1"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-text-medium hover:text-red-500 p-1"><i class="fas fa-trash-alt fa-xs"></i></button></div>`;
                const content = document.createElement('div'); content.className = 'project-content pl-2 pt-1 space-y-1';
                (project.chatIds || []).forEach(chatId => content.appendChild(createChatItemElement(chatId, true)));
                div.append(header, content);
                header.addEventListener('click', e => { if (!e.target.closest('.chat-item-actions')) div.classList.toggle('open'); });
                header.addEventListener('dragover', e => handleDragOver(e, header));
                header.addEventListener('dragleave', e => handleDragLeave(e, header));
                header.addEventListener('drop', e => handleDrop(e, id, header));
                header.querySelector('.rename-btn').addEventListener('click', () => renameItem('project', id));
                header.querySelector('.delete-btn').addEventListener('click', () => deleteItem('project', id));
                return div;
            }
            let draggedItemId = null; function handleDragStart(e, id) { draggedItemId = id; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', id); } function handleDragOver(e, el) { e.preventDefault(); el.classList.add('drag-over'); } function handleDragLeave(e, el) { el.classList.remove('drag-over'); }
            function handleDrop(e, targetProjectId, targetElement) {
                e.preventDefault(); if (targetElement) targetElement.classList.remove('drag-over');
                const sourceChatId = e.dataTransfer.getData('text/plain');
                if (!sourceChatId || !sourceChatId.startsWith('chat-') || targetProjectId === sourceChatId) return;
                state.structure = state.structure.filter(id => id !== sourceChatId); 
                Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(id => id !== sourceChatId) }); 
                if(state.projects[targetProjectId]){ 
                    if(!state.projects[targetProjectId].chatIds) state.projects[targetProjectId].chatIds = [];
                    state.projects[targetProjectId].chatIds.unshift(sourceChatId); 
                } 
                saveState(); renderSidebar(); 
            }
            async function renameItem(type, id) { const item = type === 'chat' ? state.chats[id] : state.projects[id]; const newName = await showModal({ title: `Renombrar ${type === 'chat' ? 'Chat' : 'Proyecto'}`, useInput: true, placeholder: item.title }); if (newName && newName.trim()) { item.title = newName.trim(); if (type === 'chat' && currentChatId === id) dom.chatTitle.textContent = item.title; saveState(); renderSidebar(); } hideModal(); }
            async function deleteItem(type, id) { const item = type === 'chat' ? state.chats[id] : state.projects[id]; const conf = await showModal({ title: `Eliminar ${item.title}?`, message: 'Esta acci√≥n no se puede deshacer.', confirmText: 'Eliminar' }); if (conf) { state.structure = state.structure.filter(i => i !== id); if (type === 'project') { (item.chatIds || []).forEach(cid => delete state.chats[cid]); delete state.projects[id]; } else { delete state.chats[id]; Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(cid => cid !== id)}); } if(currentChatId === id || (type === 'project' && (item.chatIds || []).includes(currentChatId))) resetChatView(); saveState(); renderSidebar(); } hideModal(); }
            function updateActiveChatHighlight() { document.querySelectorAll('.chat-item').forEach(item => { item.style.backgroundColor = item.dataset.id === currentChatId ? 'var(--current-primary)' : 'transparent'; }); }
            
            function autoSelectModel(prompt = '') {
                const currentChat = state.chats[currentChatId];
                if (hasFile() || currentChat?.workflow) return;
                const searchKeywords = ['noticias', 'qu√© pas√≥ hoy', 'fecha de hoy', 'actualidad', 'tiempo real', 'busca en la web'];
                if (searchKeywords.some(kw => prompt.toLowerCase().includes(kw))) {
                    dom.modelSelector.value = 'perplexity/sonar-small-online';
                } else {
                    dom.modelSelector.value = 'gpt-3.5-turbo';
                }
                updateWebSearchButtonState();
            }

            function clearImageData() { dom.imageUploadInput.value = ''; dom.imagePreviewContainer.classList.add('hidden'); selectedImageBase64 = null; if(!currentChatId || !state.chats[currentChatId]?.workflow) autoSelectModel(); }
            function clearPdfData() { dom.pdfUploadInput.value = ''; dom.pdfPreviewContainer.classList.add('hidden'); selectedPdfText = null; if(!currentChatId || !state.chats[currentChatId]?.workflow) autoSelectModel(); }
            function hasFile() { return selectedImageBase64 || selectedPdfText; }
            
            async function sendMessage(forceSend = false) {
                const userMessage = dom.msgInput.value.trim();
                if (!userMessage && !selectedImageBase64 && !selectedPdfText) return;
                
                const currentChat = state.chats[currentChatId];
                if (!currentChat || !currentChat.workflow) {
                    autoSelectModel(userMessage);
                }

                const count = getCreditCount();
                const model = dom.modelSelector.value;
                let cost = COSTS.GENERAL;
                
                if (currentChat?.workflow === 'web-page') cost = COSTS.WEB_PAGE;
                else if (currentChat?.workflow === 'copywriting') cost = COSTS.COPYWRITING;
                else if (currentChat?.workflow === 'sales-response') cost = COSTS.SALES_RESPONSE;
                else if (currentChat?.workflow === 'english-teacher') cost = COSTS.ENGLISH_TEACHER;
                else if (model === 'perplexity/sonar-small-online') cost = COSTS.SEARCH;
                else if (model === 'gpt-4o' && hasFile()) cost = COSTS.NEBULA;

                if ((!currentUser && count < cost && !forceSend) || (currentUser && count < cost && !forceSend)) {
                    showPricingModal(); return;
                }

                let chatIdToUpdate = currentChatId || createNewChat({ model: model });
                if (!state.chats[chatIdToUpdate]) return;
                
                setCreditCount(count - cost);
                
                const [image, pdf] = [selectedImageBase64, selectedPdfText];
                state.chats[chatIdToUpdate].messages.push({ role: 'user', content: userMessage, image, pdfText: pdf });
                addMessageToUI('user', userMessage, image);
                const thinkingBubble = addMessageToUI('assistant', '‚Ä¶');
                dom.msgInput.value = ''; dom.msgInput.style.height = 'auto'; clearImageData(); clearPdfData();

                try {
                    const workflowForCall = state.chats[chatIdToUpdate]?.workflow || null;
                    const responseData = await getAIResponse(userMessage, state.chats[chatIdToUpdate].messages.slice(0, -1), image, pdf, model, workflowForCall);
                    
                    if (responseData.error === 'LIMIT_REACHED') {
                        updateMessageInUI(thinkingBubble, `Has alcanzado el l√≠mite de cr√©ditos de tu plan. ¬°Actualiza para continuar!`);
                        if (currentUser) setCreditCount(0); showPricingModal(); return;
                    }

                    if (responseData.reply) {
                        state.chats[chatIdToUpdate].messages.push({ role: 'assistant', content: responseData.reply });
                        updateMessageInUI(thinkingBubble, responseData.reply);
                        speak(responseData.reply);
                        if (currentUser && typeof responseData.new_credit_count !== 'undefined') {
                            setCreditCount(responseData.new_credit_count);
                        }
                        saveState();
                    } else if (responseData.error) {
                        updateMessageInUI(thinkingBubble, `‚ùå **Error**<br><small>${responseData.details || 'Error del servidor.'}</small>`);
                        setCreditCount(count);
                    }
                } catch (error) {
                    updateMessageInUI(thinkingBubble, `‚ùå **Error de Conexi√≥n**<br><small>${error.message || 'No se pudo conectar al servidor.'}</small>`);
                    setCreditCount(count);
                }
            }

            function toggleWebSearchMode() {
                isWebSearchMode = !isWebSearchMode;
                if (isWebSearchMode) {
                    dom.modelSelector.value = 'perplexity/sonar-small-online';
                } else {
                    dom.modelSelector.value = 'gpt-3.5-turbo';
                }
                updateWebSearchButtonState();
            }

            function updateWebSearchButtonState() {
                isWebSearchMode = dom.modelSelector.value === 'perplexity/sonar-small-online';
                dom.webSearchBtn.classList.toggle('text-primary', isWebSearchMode);
                dom.webSearchBtn.classList.toggle('text-text-medium', !isWebSearchMode);
            }

            function setupEventListeners() {
                dom.genericModal.querySelector('#modal-confirm').addEventListener('click', () => { const input = dom.genericModal.querySelector('#modal-input'); hideModal(input.style.display !== 'none' ? input.value : true); });
                dom.genericModal.querySelector('#modal-cancel').addEventListener('click', () => hideModal(null));
                dom.sendBtn.addEventListener('click', sendMessage);
                dom.msgInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
                dom.msgInput.addEventListener('input', () => { dom.msgInput.style.height = 'auto'; dom.msgInput.style.height = (dom.msgInput.scrollHeight) + 'px';});

                dom.newChatBtn.addEventListener('click', () => createNewChat());
                dom.newProjectBtn.addEventListener('click', async () => { const name = await showModal({ title: 'Crear Proyecto', useInput: true, placeholder: 'Nombre del Proyecto...' }); if (name && name.trim()) { const id = 'project-' + crypto.randomUUID(); state.projects[id] = { id, title: name.trim(), chatIds: [] }; state.structure.unshift(id); saveState(); renderSidebar(); } hideModal(); });
                dom.upgradePlanBtn.addEventListener('click', showPricingModal);
                dom.closePricingModalBtn.addEventListener('click', hidePricingModal);
                dom.themeToggle.addEventListener('click', () => setTheme(!document.body.classList.contains('dark-theme')));

                if (SR) {
                    recognition = new SR(); recognition.continuous = false; recognition.lang = 'es-ES'; recognition.interimResults = false;
                    recognition.onstart = () => { isRecognizing = true; dom.voiceBtn.classList.add('glowing-mic'); };
                    recognition.onend = () => { isRecognizing = false; dom.voiceBtn.classList.remove('glowing-mic'); };
                    recognition.onresult = (event) => { dom.msgInput.value = Array.from(event.results).map(r => r[0].transcript).join(''); sendMessage(); };
                    dom.voiceBtn.addEventListener('click', () => { if (isRecognizing) recognition.stop(); else recognition.start(); });
                } else { if(dom.voiceBtn) dom.voiceBtn.style.display = 'none'; }
                
                const ttsIcon = dom.ttsToggle.querySelector('i');
                dom.ttsToggle.addEventListener('click', () => { 
                    speechOn = !speechOn;
                    ttsIcon.classList.toggle('fa-volume-high', speechOn); ttsIcon.classList.toggle('fa-volume-mute', !speechOn);
                    dom.ttsToggle.classList.toggle('text-yellow-400', speechOn); dom.ttsToggle.classList.toggle('text-text-medium', !speechOn);
                    if (!speechOn) speechSynthesis.cancel();
                });

                dom.webSearchBtn.addEventListener('click', toggleWebSearchMode);
                dom.modelSelector.addEventListener('change', updateWebSearchButtonState);

                dom.imageUploadBtn.addEventListener('click', () => dom.imageUploadInput.click());
                dom.pdfUploadBtn.addEventListener('click', () => dom.pdfUploadInput.click());
                dom.clearImageBtn.addEventListener('click', clearImageData);
                dom.clearPdfBtn.addEventListener('click', clearPdfData);
                dom.imageUploadInput.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { clearPdfData(); const reader = new FileReader(); reader.onload = (ev) => { selectedImageBase64 = ev.target.result; dom.imagePreview.src = selectedImageBase64; dom.imagePreviewContainer.classList.remove('hidden'); autoSelectModel(); }; reader.readAsDataURL(e.target.files[0]); } });
                dom.pdfUploadInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file || file.type !== 'application/pdf') return; clearImageData(); dom.pdfNameEl.textContent = file.name; dom.pdfStatusEl.textContent = 'Leyendo...'; dom.pdfPreviewContainer.classList.remove('hidden'); const reader = new FileReader(); reader.onload = async (ev) => { dom.pdfStatusEl.textContent = 'Procesando...'; try { const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(ev.target.result) }).promise; let text = ''; for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const content = await page.getTextContent(); text += content.items.map(item => item.str).join(' ') + '\n'; } selectedPdfText = text; dom.pdfStatusEl.textContent = `‚úÖ Listo (${pdf.numPages} p√°g.)`; autoSelectModel(); } catch (err) { console.error("Error al procesar el PDF:", err); dom.pdfStatusEl.textContent = '‚ùå Error al leer PDF.'; selectedPdfText = null; setTimeout(clearPdfData, 2000); } }; reader.readAsArrayBuffer(file); });
                
                dom.menuToggle.addEventListener('click', (e) => { e.stopPropagation(); toggleSidebar(true); });
                dom.sidebarOverlay.addEventListener('click', () => toggleSidebar(false));
                dom.userMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); dom.userMenuPopup.classList.toggle('hidden'); });
                dom.logoutBtn.addEventListener('click', () => { netlifyIdentity.logout(); dom.userMenuPopup.classList.add('hidden');});
                
                const createWorkflowChat = (opts) => { createNewChat(opts); if (window.innerWidth < 768) toggleSidebar(false); };
                dom.copywritingWorkflowBtn.addEventListener('click', () => createWorkflowChat({ title: "Nuevo Copy", workflow: "copywriting", model: "gpt-3.5-turbo", initialMessages: [{ role: 'assistant', content: `¬°Claro! Empecemos un nuevo copy (costo: ${COSTS.COPYWRITING} cr√©ditos). Por favor, dame el contexto: ¬øcu√°l es el producto o servicio, a qui√©n te diriges y cu√°l es el objetivo principal del copy?` }] }));
                dom.salesResponseWorkflowBtn.addEventListener('click', () => createWorkflowChat({ title: "Respuesta de Venta", workflow: "sales-response", model: "gpt-3.5-turbo", initialMessages: [{ role: 'assistant', content: `¬°Excelente! Estoy listo para ayudarte a cerrar esa venta (costo: ${COSTS.SALES_RESPONSE} cr√©ditos). Pega el mensaje de tu cliente y te dar√© la respuesta perfecta para convencerlo.` }] }));
                dom.webPageWorkflowBtn.addEventListener('click', () => createWorkflowChat({ title: "Nueva P√°gina Web", workflow: "web-page", model: "gpt-4o", initialMessages: [{ role: 'assistant', content: `¬°Perfecto! Estoy listo para generar una p√°gina web profesional con HTML y Tailwind CSS (costo: ${COSTS.WEB_PAGE} cr√©ditos).\n\n**En tu pr√≥ximo mensaje, describe con todo el detalle posible la p√°gina que quieres crear.**` }] }));
                dom.englishTeacherWorkflowBtn.addEventListener('click', () => createWorkflowChat({
                    title: "English Teacher",
                    workflow: "english-teacher",
                    model: "gpt-3.5-turbo",
                    initialMessages: [{
                        role: 'assistant',
                        content: "Hello! Do you want me to translate something, or would you like to learn something new?\n\n(¬°Hola! ¬øQuieres que traduzca algo, o te gustar√≠a aprender algo nuevo?)"
                    }]
                }));

                dom.closeHtmlPreviewModalBtn.addEventListener('click', () => dom.htmlPreviewModal.classList.add('hidden'));
                dom.voiceSelector.addEventListener('change', (e) => { selectedVoice = availableVoices.find(voice => voice.name === e.target.value); });

                document.addEventListener('click', (e) => {
                    if (!dom.userMenuBtn.contains(e.target) && !dom.userMenuPopup.contains(e.target)) dom.userMenuPopup.classList.add('hidden');
                    if (window.innerWidth < 768 && !dom.sidebar.contains(e.target) && dom.sidebar.classList.contains('is-open')) toggleSidebar(false);
                });
            }
            
            function initApp() {
                setTheme(localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches));
                let initFired = false;

                const finishInitialization = async (user) => {
                    if (initFired) return; initFired = true;
                    currentUser = user ? await ensureUserMetadata(user) : null;
                    if (!user) { if (localStorage.getItem('hasLoggedInBefore') === 'true') localStorage.setItem('guestCreditCount', GUEST_CREDIT_LIMIT); }
                    updateUserUI(); loadStateForUser();
                    if (!currentUser && (localStorage.getItem('hasLoggedInBefore') === 'true' || getCreditCount() >= GUEST_CREDIT_LIMIT)) {
                        showModal({ title: 'Bienvenido de Nuevo', message: `Ya has usado los cr√©ditos de invitado en este navegador. Por favor, inicia sesi√≥n para continuar.`, confirmText: 'Iniciar Sesi√≥n' })
                        .then(wantsToLogin => { if (wantsToLogin) netlifyIdentity.open(); });
                    }
                    dom.appContainer.classList.remove('opacity-0');
                    dom.loadingOverlay.classList.add('opacity-0');
                    setTimeout(() => dom.loadingOverlay.style.display = 'none', 300);
                };

                const ensureUserMetadata = async (user) => {
                    if (user && (typeof user.app_metadata.credits === 'undefined')) {
                        try {
                            const updatedUser = await netlifyIdentity.gotrue.user.update({ data: { credits: FREE_PLAN_CREDIT_LIMIT } });
                            await updatedUser.jwt(true); return netlifyIdentity.currentUser(); 
                        } catch (error) { console.error("Error setting default credits:", error); user.app_metadata.credits = FREE_PLAN_CREDIT_LIMIT; return user; }
                    }
                    return user;
                };

                netlifyIdentity.on('init', (user) => finishInitialization(user));
                setTimeout(() => { if (!initFired) finishInitialization(netlifyIdentity.currentUser()); }, 2500);
                netlifyIdentity.on('login', async user => {
                    netlifyIdentity.close(); localStorage.removeItem('guestCreditCount'); localStorage.setItem('hasLoggedInBefore', 'true');
                    currentUser = await ensureUserMetadata(user); await currentUser.jwt(true);
                    currentUser = netlifyIdentity.currentUser(); updateUserUI(); loadStateForUser();
                });
                netlifyIdentity.on('logout', () => { currentUser = null; updateUserUI(); loadStateForUser(); localStorage.setItem('guestCreditCount', GUEST_CREDIT_LIMIT); updateCreditCounter(); resetChatView(); });
                
                // Initial setup calls
                const ttsIcon = dom.ttsToggle.querySelector('i');
                ttsIcon.classList.toggle('fa-volume-high', speechOn); ttsIcon.classList.toggle('fa-volume-mute', !speechOn);
                dom.ttsToggle.classList.toggle('text-yellow-400', speechOn); dom.ttsToggle.classList.toggle('text-text-medium', !speechOn);
                
                populateVoiceList();
                setupEventListeners();
                updateWebSearchButtonState();
            }

            // Let's go!
            initApp();
        });
    </script>
</body>
</html>
