<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Goatify IA</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Goatify/goatify-images/main/Logos%20HD.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/locale/es.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/plugin/localizedFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #121212;
            --bg-medium: #1e1e1e;
            --bg-light: #2c2c2c;
            --primary: #8a4fff;
            --primary-hover: #7b46e6;
            --text-light: #e0e0e0;
            --text-medium: #b3b3b3;
            --border-color: #3a3a3a;
            --success: #2ecc71;
            --warning: #f39c12;

            --light-bg-dark: #f7f7f8;
            --light-bg-medium: #ffffff;
            --light-bg-light: #f0f0f0;
            --light-primary: #7c40e6;
            --light-primary-hover: #6a37d3;
            --light-text-dark: #1f2937;
            --light-text-medium: #6b7280;
            --light-border-color: #e5e7eb;

            --base-font-size: 16px;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: var(--base-font-size);
        }

        .dark-theme {
            --current-bg-dark: var(--bg-dark);
            --current-bg-medium: var(--bg-medium);
            --current-bg-light: var(--bg-light);
            --current-primary: var(--primary);
            --current-primary-hover: var(--primary-hover);
            --current-text-light: var(--text-light);
            --current-text-medium: var(--text-medium);
            --current-border-color: var(--border-color);
            background-color: var(--current-bg-dark);
            color: var(--text-light);
        }

        .light-theme {
            --current-bg-dark: var(--light-bg-dark);
            --current-bg-medium: var(--light-bg-medium);
            --current-bg-light: var(--light-bg-light);
            --current-primary: var(--light-primary);
            --current-primary-hover: var(--light-primary-hover);
            --current-text-light: var(--light-text-dark);
            --current-text-medium: var(--light-text-medium);
            --current-border-color: var(--light-border-color);
            background-color: var(--light-bg-dark);
            color: var(--light-text-dark);
        }
        
        #sidebar { background-color: var(--current-bg-dark); border-right: 1px solid var(--current-border-color); height: 100vh; display: flex; flex-direction: column; transition: width 0.3s ease, padding 0.3s ease, transform 0.3s ease; }
        #sidebar.collapsed { width: 0; padding: 0; overflow: hidden; border-right: none;}
        #sidebar.collapsed > * { display: none; }
        
        #sidebar-scroll-area {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0;
        }

        #main-chat-area, .modal-content { background-color: var(--current-bg-medium); }
        .chat-bubble-bot, .bg-input, #pdf-preview-container, .chat-item, .project-header, #user-menu-popup, #services-menu, .pro-controls-bg { background-color: var(--current-bg-light); }
        .border-themed { border-color: var(--current-border-color); }
        .chat-bubble-user { background-color: var(--current-primary); color: white; }
        .btn-primary { background-color: var(--current-primary); color: white; }
        .btn-primary:hover { background-color: var(--current-primary-hover); }
        .plan-card-highlight { border-color: var(--current-primary); box-shadow: 0 0 15px rgba(138, 79, 255, 0.3); }
        .placeholder-themed::placeholder { color: var(--current-text-medium); }
        .text-primary { color: var(--current-primary); }
        .glowing-mic { animation: pulse 1.5s infinite; color: var(--primary) !important; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(138, 79, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0); }
        }
        
        @keyframes tada {
            from { transform: scale3d(1, 1, 1); }
            10%, 20% { transform: scale3d(0.9, 0.9, 0.9) rotate3d(0, 0, 1, -3deg); }
            30%, 50%, 70%, 90% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, 3deg); }
            40%, 60%, 80% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, -3deg); }
            to { transform: scale3d(1, 1, 1); }
        }
        .animate-tada { animation: tada 1s ease-in-out; }

        .project .project-content { display: none; }
        .project.open .project-content { display: block; }
        .project.open .project-arrow { transform: rotate(90deg); }
        .project-header.drag-over { background-color: var(--current-primary); }
        #sidebar.is-open { transform: translateX(0); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        #app-container { height: 100vh; height: -webkit-fill-available; }
        #pricing-modal .modal-content-body, #gamification-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .chat-item.selected-for-delete { background-color: var(--primary) !important; color: white; }
        
        .model-selector-wrapper { position: relative; display: inline-flex; align-items: center; }
        .model-selector-wrapper select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='var(--current-text-light)' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; height: 32px; font-size: 0.875rem; line-height: 1.25rem; border: none; outline: none; cursor: pointer; min-width: 120px; background-color: transparent; }
        .pro-controls-bg { display: flex; align-items: center; justify-content: space-between; padding: 0.375rem; border-radius: 0.5rem; overflow: hidden; width: fit-content; max-width: 100%; gap: 0.5rem; }
        .pro-controls-bg > div:first-child { display: flex; align-items: center; gap: 0.5rem; }
        .workflow-content { display: none; }
        .workflow-category.open .workflow-content { display: block; }
        .workflow-category.open .workflow-arrow { transform: rotate(90deg); }
        .plan-card { background-color: var(--current-bg-light); }
        #pdf-preview-container { padding: 0.5rem; }
        
        .cool-light-effect { position: relative; overflow: hidden; }
        .cool-light-effect::before { content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(138, 79, 255, 0.25) 50%, rgba(255,255,255,0) 100%); transform: translateX(-150%) skewX(-15deg); transition: transform 0.8s ease; pointer-events: none; }
        .cool-light-effect:hover::before { animation: sweep 2s infinite linear; }
        @keyframes sweep { 0% { transform: translateX(-100%) skewX(-15deg); } 100% { transform: translateX(200%) skewX(-15deg); } }

        .input-wrapper { border: 2px solid transparent; transition: box-shadow 0.3s ease, border-color 0.3s ease; }
        .input-wrapper:focus-within { box-shadow: 0 0 10px 0px rgba(138, 79, 255, 0.5); border-color: var(--current-primary-hover); }

        #chat-title { color: var(--primary); font-weight: 700; transition: color 0.3s ease; }
        #chat-title-wrapper:hover #chat-title { color: var(--primary-hover); }
        
        #chat-title-wrapper { position: relative; padding-left: 24px; }
        #chat-title-wrapper .edit-icon, #mobile-chat-title-wrapper .edit-icon { position: absolute; left: 0; top: 50%; transform: translateY(-50%); opacity: 1; transition: transform 0.2s ease; }
        #chat-title-wrapper:hover .edit-icon, #mobile-chat-title-wrapper:hover .edit-icon { transform: translateY(-50%) scale(1.1); }

        .btn-disabled { background-color: #3a3a3a !important; color: #888 !important; cursor: not-allowed !important; border-color: #3a3a3a !important;}
        .chat-item.selected-chat { background-color: var(--current-primary); color: white !important; }
        .chat-item.selected-chat .text-sm { color: white !important; }
        .light-theme .chat-item { color: var(--light-text-dark); }
        
        /* Gamification Styles */
        .gamification-tab.active { border-color: var(--current-primary); background-color: var(--current-primary); color: white; }
        .mission-item.completed { opacity: 0.5; text-decoration: line-through; }
        .mission-item.completed button { display: none; }
        .achievement-badge { filter: grayscale(1); opacity: 0.6; }
        .achievement-badge.unlocked { filter: grayscale(0); opacity: 1; }
        .xp-bar-bg { background-color: var(--current-bg-light); }
        .xp-bar-fill { background-color: var(--success); transition: width 0.5s ease-out; }
        .streak-day.active { background-color: var(--current-primary); color: white; border-color: var(--current-primary); }
        .streak-day.completed { background-color: var(--success); color: white; border-color: var(--success); }

        /* Pricing Toggle */
        .pricing-toggle-bg { background-color: var(--current-bg-light); }
        .pricing-toggle-btn.active { background-color: var(--current-primary); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        /* Kanban Styles */
        #project-management-view { display: flex; flex-direction: column; gap: 1rem; height: 100%; }
        #project-board-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        #project-chat-container { display: flex; flex-direction: column; border-top: 1px solid var(--current-border-color); padding-top: 1rem; transition: height 0.3s ease, flex-basis 0.3s ease; }
        #project-chat-container-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding-bottom: 0.5rem; }
        #project-chat-container.collapsed .project-chat-body { display: none; }
        #project-chat-container.collapsed { height: auto !important; flex-grow: 0; flex-basis: auto; }
        #project-chat-toggle i { transition: transform 0.3s ease; }
        #project-chat-container.collapsed #project-chat-toggle i { transform: rotate(-90deg); }
        #project-chat-messages { flex-grow: 1; overflow-y: auto; padding: 0.5rem; }
        #kanban-view { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; overflow: hidden; flex-grow: 1; }
        .kanban-column { background-color: var(--current-bg-light); border-radius: 0.75rem; padding: 1rem; display: flex; flex-direction: column; height: 100%; min-width: 0; }
        .kanban-column-title { font-weight: 700; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--current-border-color); display: flex; justify-content: space-between; align-items: center; }
        .kanban-cards { flex-grow: 1; min-height: 100px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; }
        .kanban-card { background-color: var(--current-bg-medium); padding: 0.75rem 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; border-left: 4px solid var(--current-primary); }
        .kanban-card:active { cursor: grabbing; background-color: var(--primary); }
        .kanban-cards.drag-over { border: 2px dashed var(--current-primary); background-color: rgba(138, 79, 255, 0.1); }

        @media (min-width: 768px) {
            #project-management-view { flex-direction: row; }
            #project-chat-container { border-left: 1px solid var(--current-border-color); border-top: none; padding-left: 1rem; padding-top: 0; height: 100%; flex-basis: 40%; flex-shrink: 0; }
            #project-chat-container.collapsed { flex-basis: 40px; }
            #project-chat-container.collapsed .project-chat-body, #project-chat-container.collapsed #project-chat-container-header h3 { display: none; }
            #project-chat-container.collapsed #project-chat-toggle { justify-content: center; }
        }
        
        @media (max-width: 767px) {
            #project-management-view { height: 100%; }
            #project-board-container { flex: 1 1 50%; }
            #project-chat-container { flex: 1 1 50%; height: 50%; }
            #kanban-view { display: grid; grid-template-columns: repeat(3, 1fr); overflow-x: auto; }
        }
    </style>
</head>
<body class="w-screen overflow-x-hidden dark-theme">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <div id="loading-overlay" class="fixed inset-0 bg-bg-dark bg-opacity-95 flex flex-col items-center justify-center z-[100] transition-opacity duration-300">
        <img src="https://raw.githubusercontent.com/Goatify/goatify-images/main/Logos%20HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mb-6 animate-pulse" onerror="this.onerror=null;this.src='https://placehold.co/96x96/121212/e0e0e0?text=LOGO';">
        <div class="text-text-light text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3 text-lg font-semibold" data-translate-key="initializing">Inicializando...</p>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden opacity-0 pointer-events-none"></div>

    <div id="app-container" class="flex w-full relative opacity-0 transition-opacity duration-300">
        <aside id="sidebar" class="w-72 flex-shrink-0 p-3 transition-transform duration-300 -translate-x-full md:translate-x-0 absolute md:relative z-30 h-full">
            <!-- Static Top Section -->
            <div id="sidebar-static-top" class="flex-shrink-0">
                <div id="logo-space" class="w-24 h-24 rounded-lg mx-auto mb-4 flex-shrink-0 flex items-center justify-center overflow-hidden bg-input">
                    <img src="https://raw.githubusercontent.com/Goatify/goatify-images/main/Logos%20HD.png" alt="Goatify Logo" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                </div>
                
                <div class="flex flex-col space-y-2 mb-4">
                    <button id="new-chat-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-plus mr-2"></i><span data-translate-key="new_chat">Nuevo Chat</span></button>
                    <button id="new-folder-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg bg-input"><i class="fas fa-folder-plus mr-2"></i><span data-translate-key="new_folder">Nueva Carpeta</span></button>
                </div>
            </div>

            <!-- Scrollable Middle Section -->
            <div id="sidebar-scroll-area" class="flex-grow min-h-0">
                <div id="upgrade-plan-container" class="hidden text-center p-2 bg-yellow-400 rounded-lg mb-2">
                    <button id="upgrade-plan-btn" class="text-xs font-semibold text-black hover:text-gray-800">
                        <i class="fas fa-rocket mr-1"></i>
                        <span data-translate-key="upgrade_plan">Mejorar Plan</span>
                    </button>
                </div>
                <div class="border-t border-b border-themed my-3 py-3">
                    <h3 class="text-xs font-semibold uppercase text-text-medium mb-2 px-2" data-translate-key="workflows">Workflows</h3>
                    <div id="workflows-container" class="space-y-1">
                         <div class="workflow-category">
                            <div id="project-workflow-header" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                <i class="fas fa-tasks w-6 mr-2 text-purple-400"></i>
                                <span class="text-sm font-bold" data-translate-key="wf_pm">Dirección de Proyectos</span>
                            </div>
                        </div>
                        <div class="workflow-category">
                            <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-share-alt w-6 mr-2 text-pink-400"></i>
                                <span class="text-sm font-bold" data-translate-key="wf_social">Potenciador de Redes Sociales</span>
                            </div>
                            <div class="workflow-content pl-4 pt-1 space-y-1">
                                <button data-workflow="create-full-post" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_1">Crear un Post Completo</button>
                                <button data-workflow="persuasive-copy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_2">Redacción de Copys</button>
                                <button data-workflow="post-ideas" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_3">Lluvia de Ideas para Posts</button>
                                <button data-workflow="brand-strategy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_4">Definir Estrategia de Marca</button>
                            </div>
                        </div>
                         <div class="workflow-category">
                            <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-chart-pie w-6 mr-2 text-blue-400"></i>
                                <span class="text-sm font-bold" data-translate-key="wf_business">Análisis de Negocio</span>
                            </div>
                            <div class="workflow-content pl-4 pt-1 space-y-1">
                                <button data-workflow="competitor-analysis" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_1">Análisis de tu Competencia</button>
                                <button data-workflow="buyer-persona" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_2">Definir mi Cliente Ideal</button>
                                <button data-workflow="brand-names" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_3">Lluvia de Nombres para Marca</button>
                            </div>
                        </div>
                        <div class="workflow-category">
                            <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-headset w-6 mr-2 text-green-400"></i>
                                <span class="text-sm font-bold" data-translate-key="wf_sales">Comunicación y Ventas</span>
                            </div>
                            <div class="workflow-content pl-4 pt-1 space-y-1">
                                <button data-workflow="sales-assistant" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_1">Asistente de Ventas 24/7</button>
                                <button data-workflow="email-writing" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_2">Redacción de Email</button>
                                <button data-workflow="design-web" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_3">Diseño Web</button>
                            </div>
                        </div>
                        <div class="workflow-category">
                            <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-graduation-cap w-6 mr-2 text-red-400"></i>
                                <span class="text-sm font-bold" data-translate-key="wf_skills">Desarrollo de Habilidades</span>
                            </div>
                            <div class="workflow-content pl-4 pt-1 space-y-1">
                                <button data-workflow="english-teacher-practice" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_3">Practicar Inglés</button>
                                <button data-workflow="social-skills" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_skills_social">Mejorar Habilidades Sociales</button>
                                <button data-workflow="dictionary" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_skills_dict">Diccionario Inteligente</button>
                            </div>
                        </div>
                    </div>
                    <div class="border-t border-themed pt-2 mt-2">
                        <button id="select-chats-btn" class="w-full text-sm p-2 rounded hover:bg-light flex items-center justify-center">
                            <i class="fas fa-tasks mr-2"></i><span data-translate-key="select_chats">Seleccionar Múltiples Chats</span>
                        </button>
                    </div>
                </div>
                <div id="delete-mode-controls" class="hidden flex space-x-2 mb-2 px-2">
                    <button id="delete-selected-btn" class="flex-1 flex items-center justify-center font-semibold p-2 rounded-lg bg-red-600 text-white disabled:opacity-50" disabled><i class="fas fa-trash-alt mr-2"></i><span data-translate-key="delete">Borrar</span></button>
                    <button id="cancel-select-mode-btn" class="p-2 rounded-lg bg-gray-600 text-white"><i class="fas fa-times"></i></button>
                </div>
                <div id="sidebar-content" class="pr-1 space-y-1"></div>
            </div>

            <!-- Static Bottom Section -->
            <div id="user-section" class="flex-shrink-0 border-t border-themed mt-auto pt-3">
                <div id="login-view" class="hidden">
                    <button id="login-btn" class="w-full flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-sign-in-alt mr-2"></i><span data-translate-key="login">Iniciar Sesión</span></button>
                </div>
                <div id="user-menu-view" class="hidden relative">
                    <button id="user-menu-btn" class="w-full flex items-center text-left p-2 rounded-lg hover:bg-light transition-colors">
                        <span id="user-email" class="flex-grow truncate text-sm font-semibold"></span>
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <div id="user-menu-popup" class="absolute bottom-full left-0 w-full mb-2 rounded-lg p-2 border border-themed shadow-lg hidden bg-current-bg-light">
                        <button id="settings-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-cog w-6 mr-2"></i><span data-translate-key="settings">Configuración</span></button>
                        <button id="logout-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-sign-out-alt w-6 mr-2"></i><span data-translate-key="logout">Cerrar Sesión</span></button>
                    </div>
                </div>
            </div>
        </aside>

        <main id="main-chat-area" class="flex-1 flex flex-col h-full overflow-hidden">
            <header class="flex items-center justify-between p-3 md:p-4 border-b border-themed flex-shrink-0 relative">
                <button id="menu-toggle" class="md:hidden text-xl p-2"><i class="fas fa-bars"></i></button>
                <button id="sidebar-toggle-desktop" class="hidden md:block text-xl p-2 mr-2"><i class="fas fa-angle-left"></i></button>
                <div id="chat-title-wrapper" class="hidden sm:flex items-center group cursor-pointer mx-2 flex-1 min-w-0" title="Renombrar Chat">
                    <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                    <h1 id="chat-title" class="text-lg font-semibold truncate">Goatify IA</h1>
                </div>
                <div class="flex items-center space-x-1 sm:space-x-2 flex-shrink-0 ml-auto">
                    <button id="gamification-btn" title="Mi Ascensión GOAT" class="text-yellow-400 hover:text-yellow-300 p-2 transition-colors relative">
                        <i class="fas fa-trophy text-xl"></i>
                        <span id="gamification-badge" class="absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-current-bg-medium hidden"></span>
                    </button>
                    <button id="services-menu-btn" title="Potenciar mi Negocio" class="text-xl p-2 hover:opacity-80 transition-opacity flex items-center gap-2">
                        <i class="fas fa-rocket text-primary"></i>
                        <span class="text-sm font-semibold text-primary" data-translate-key="solutions">Soluciones</span>
                    </button>
                    <div id="message-counter" class="text-xs font-mono whitespace-nowrap"></div>
                    <button id="theme-toggle" title="Cambiar Tema" class="text-xl p-2"><i class="fas fa-moon" id="theme-icon"></i></button>
                </div>
                <div id="services-menu" class="absolute top-full right-4 mt-2 w-80 rounded-xl shadow-lg border border-themed z-30 p-4 transition-all duration-300 ease-in-out opacity-0 scale-95 -translate-y-2 pointer-events-none origin-top-right">
                    <h4 class="font-bold text-lg mb-1 text-text-light" data-translate-key="ally_title">Somos tu Aliado Estratégico</h4>
                    <p class="text-sm text-text-medium mb-4" data-translate-key="ally_desc">Goatify no es solo un chat. Somos una IA personalizada con un equipo de expertos listos para ayudarte a escalar tu negocio.</p>
                    <ul class="space-y-3">
                        <li><a href="#" data-solution="web" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Páginas Web que Convierten</p><p class="text-sm text-text-medium">Transformamos tus ideas en webs y tiendas online diseñadas para vender.</p></a></li>
                        <li><a href="#" data-solution="auto" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Ventas en Piloto Automático</p><p class="text-sm text-text-medium">Implementamos sistemas de IA para automatizar tus ventas y procesos clave.</p></a></li>
                        <li><a href="#" data-solution="social" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Avatares para Redes Sociales</p><p class="text-sm text-text-medium">Creamos avatares hiperrealistas con IA y estrategias de contenido que captan la atención.</p></a></li>
                        <li><a href="#" data-solution="consult" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Escala tu Empresa con IA</p><p class="text-sm text-text-medium">Obtén consultoría experta para integrar la IA en el ADN de tu negocio.</p></a></li>
                    </ul>
                </div>
            </header>
            <div class="block sm:hidden text-center py-1.5 border-b border-themed bg-current-bg-dark shadow-sm flex-shrink-0">
                <div id="mobile-chat-title-wrapper" class="flex items-center justify-center group cursor-pointer px-4" title="Renombrar Chat">
                    <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                    <h2 id="mobile-chat-title" class="text-sm font-semibold truncate">Goatify IA</h2>
                </div>
            </div>

            <div id="chat-messages" class="flex-1 overflow-y-auto p-3 sm:p-6">
                <div class="flex justify-center items-center h-full" id="initial-message-container">
                    <div id="welcome-message-wrapper" class="text-center text-text-medium">
                        <img src="https://raw.githubusercontent.com/Goatify/goatify-images/main/Logos%20HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                        <h2 class="text-3xl font-bold text-text-light">Goatify IA</h2>
                        <div id="personalized-welcome" class="hidden"><p class="text-lg mt-1"><span data-translate-key="welcome_user">¡Hola, </span><span id="user-name"></span><span data-translate-key="welcome_user_2">! Hoy es un gran día para crear algo increíble.</span></p></div>
                        <div id="generic-welcome" class="hidden"><p class="text-xl" data-translate-key="welcome_guest">¿Cómo puedo ayudarte hoy?</p></div>
                    </div>
                </div>
            </div>
            
            <div id="project-management-view" class="hidden flex-1 p-4 overflow-hidden">
                <div id="project-board-container">
                    <div class="flex flex-wrap justify-between items-center mb-4 flex-shrink-0 gap-2">
                        <h2 id="project-view-title" class="text-2xl font-bold">Nombre del Proyecto</h2>
                    </div>
                     <div class="flex items-center space-x-2 project-view-controls mb-4">
                        <span class="text-sm text-text-medium hidden sm:inline">Vistas:</span>
                        <button id="view-toggle-kanban" class="px-3 py-1 text-sm rounded-md">Kanban</button>
                        <button id="view-toggle-list" class="px-3 py-1 text-sm rounded-md">Lista</button>
                    </div>
                    <div id="kanban-view" class="flex-1"></div>
                    <div id="list-view" class="hidden flex-1 space-y-2 overflow-y-auto"></div>
                </div>
                <div id="project-chat-container">
                    <div id="project-chat-container-header">
                        <h3 class="text-lg font-semibold text-primary">Asistente del Proyecto</h3>
                        <button id="project-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-down"></i></button>
                    </div>
                    <div class="project-chat-body flex flex-col flex-grow min-h-0">
                        <div id="project-chat-messages" class="chat-bubble-bot"></div>
                        <div id="project-input-area" class="mt-auto pt-2">
                             <div class="pro-controls-bg rounded-lg p-1 mb-2">
                                <div class="flex items-center space-x-2">
                                    <label for="project-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1" data-translate-key="model">Modelo:</label>
                                    <div class="model-selector-wrapper">
                                        <select id="project-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                            <option value="gpt-4o-mini">Creativo (GPT-4o Mini)</option>
                                            <option value="gpt-3.5-turbo-1106">Rápido (GPT-3.5)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                             <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                <textarea id="project-msg" placeholder="Deja que Goatify organice tu proyecto..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm"></textarea>
                                <button id="project-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="input-area" class="p-2 sm:p-4 border-t border-themed flex-shrink-0">
                <div id="file-preview-area" class="mb-2 space-y-2 px-1 sm:px-0"></div>
                <div class="pro-controls-bg rounded-lg p-1.5 mb-2 cool-light-effect">
                    <div class="flex items-center space-x-2">
                        <div class="flex items-center space-x-2">
                            <label for="model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1" data-translate-key="model">Modelo:</label>
                            <div class="model-selector-wrapper">
                                <select id="model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                    <option value="gpt-4o-mini">Creativo (GPT-4o Mini)</option>
                                    <option value="gpt-3.5-turbo-1106">Rápido (GPT-3.5)</option>
                                    <option value="sonar">Búsqueda Web</option>
                                </select>
                            </div>
                        </div>
                        <div id="voice-selector-container" class="hidden items-center space-x-2">
                            <label for="voice-selector" class="font-medium text-xs text-text-medium" data-translate-key="voice">Voz:</label>
                             <div class="model-selector-wrapper">
                                <select id="voice-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light w-24"></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                    <input type="file" id="pdf-upload" accept=".pdf,application/pdf" class="hidden"><input type="file" id="image-upload" accept="image/*" class="hidden">
                    <button id="image-gen-btn" title="Crear Imagen" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fas fa-paint-brush text-xl"></i></button>
                    <button id="pdf-upload-btn" title="Subir PDF" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-file-pdf text-xl"></i></button>
                    <button id="image-upload-btn" title="Subir Imagen" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-image text-xl"></i></button>
                    <button id="mic-btn" title="Activar Micrófono" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-microphone text-xl"></i></button>
                    <button id="tts-toggle" title="Activar/Desactivar Voz" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-volume-mute text-xl"></i></button>
                    <textarea id="msg" placeholder="Escribe tu mensaje..." class="flex-1 bg-transparent p-2 h-12 max-h-32 resize-none outline-none placeholder-themed" rows="1" data-translate-key="placeholder_main"></textarea>
                    <button id="send" title="Enviar" class="p-2 sm:p-4 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i id="send-icon" class="fa fa-paper-plane text-xl"></i></button>
                </div>
                <div id="contextual-footer" class="text-center text-xs text-text-medium mt-2 px-2 h-4"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4"><div class="modal-content rounded-lg w-full max-w-md p-6 relative"><h3 id="modal-title" class="text-lg font-bold mb-4"></h3><div id="modal-body" class="mb-4 text-text-medium text-sm"></div><div id="modal-buttons-container" class="flex justify-end space-x-2"></div></div></div>
    
    <div id="pricing-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-6xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex flex-col items-center justify-between mb-4">
                <h2 class="text-3xl md:text-4xl font-extrabold text-center flex-grow" data-translate-key="plans_title">Planes Goatify IA</h2>
                <button id="close-pricing-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
                <div class="mt-4 p-1 rounded-lg pricing-toggle-bg flex items-center space-x-1">
                    <button id="monthly-toggle" class="pricing-toggle-btn active px-4 py-2 text-sm font-semibold rounded-md transition-all">Mensual</button>
                    <button id="yearly-toggle" class="pricing-toggle-btn px-4 py-2 text-sm font-semibold rounded-md transition-all">Anual <span class="bg-yellow-400 text-black text-xs font-bold px-2 py-1 rounded-full ml-1">2 Meses GRATIS</span></button>
                </div>
            </div>
            <div class="modal-content-body flex-grow overflow-y-auto px-2">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 text-text-light">
                    <!-- Free Plan -->
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">Free</h3>
                        <p class="text-5xl font-extrabold my-3">$0</p>
                        <p class="text-sm text-text-medium mb-6 h-10" data-translate-key="plan_free_sub">Para explorar y empezar</p>
                        <button id="free-plan-button" class="mt-auto w-full p-3 rounded-lg font-semibold border-2 border-primary text-primary hover:bg-primary hover:text-white transition-colors" data-translate-key="plan_free_cta">Tu Plan Actual</button>
                        <ul class="space-y-3 mt-6 text-sm">
                            <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>15 Créditos/mes</li>
                            <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Acceso a modelos básicos</li>
                            <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Gamificación Nivel 1</li>
                        </ul>
                    </div>
                    <!-- GOAT Boost Plan -->
                    <div class="plan-card border-2 rounded-xl p-6 flex flex-col bg-current-bg-dark plan-card-highlight">
                         <p class="text-center font-bold bg-primary text-white py-1 px-3 rounded-full w-fit mx-auto -mt-10 mb-4">MÁS POPULAR</p>
                        <h3 class="text-2xl font-bold">GOAT <span class="text-primary">BOOST</span></h3>
                        <p class="text-5xl font-extrabold my-3" data-price-monthly="$10" data-price-yearly="$100">$10</p>
                        <p class="text-sm text-text-medium mb-6 h-10">Para creadores y emprendedores que quieren más poder.</p>
                        <button data-plan="boost" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_boost_cta">Obtener Boost</button>
                        <ul class="space-y-3 mt-6 text-sm">
                             <li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i><strong>100</strong> Créditos/mes</li>
                             <li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Acceso a <strong>todos los modelos IA</strong></li>
                             <li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Workflows <strong>avanzados</strong></li>
                            <li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Gamificación completa</li>
                             <li class="flex items-center"><i class="fas fa-times-circle text-gray-500 mr-2"></i>Página Web de Regalo</li>
                        </ul>
                    </div>
                    <!-- GOAT Pro Plan -->
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">GOAT <span class="text-primary">PRO</span></h3>
                        <p class="text-5xl font-extrabold my-3" data-price-monthly="$20" data-price-yearly="$200">$20</p>
                        <p class="text-sm text-text-medium mb-6 h-10">La solución completa para negocios que buscan escalar.</p>
                        <button data-plan="pro" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_pro_cta">Quiero mi Plan Pro + Web</button>
                        <ul class="space-y-3 mt-6 text-sm">
                             <li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i><strong>Créditos Ilimitados</strong></li>
                             <li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Acceso a <strong>todos los modelos IA</strong></li>
                             <li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Workflows <strong>avanzados</strong></li>
                            <li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Gamificación completa</li>
                             <li class="flex items-center"><i class="fas fa-gift text-yellow-400 mr-2"></i><strong>Página Web de Regalo</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-lg p-6 relative">
            <h3 class="text-lg font-bold mb-4" data-translate-key="settings">Configuración</h3>
            <div class="space-y-4 text-sm">
                <!-- User Info & Plan -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="font-semibold" data-translate-key="settings_email">Correo Electrónico:</p>
                        <p id="settings-user-email" class="text-text-medium truncate"></p>
                    </div>
                    <div>
                        <p class="font-semibold" data-translate-key="settings_plan">Plan de Suscripción:</p>
                        <p id="settings-user-plan" class="text-text-medium"></p>
                        <button id="settings-upgrade-plan-btn" class="text-primary hover:underline mt-1 text-xs" data-translate-key="upgrade_plan">Mejorar Plan</button>
                    </div>
                </div>
                <!-- Personalization -->
                <div class="border-t border-themed pt-4">
                    <p class="font-semibold mb-2" data-translate-key="settings_theme">Personalización:</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <p class="font-semibold text-xs mb-1" data-translate-key="settings_fontsize">Tamaño de Letra:</p>
                            <input type="range" id="font-size-slider" min="14" max="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg dark:bg-gray-700">
                            <span id="font-size-value" class="text-xs text-text-medium">16px</span>
                        </div>
                        <button id="settings-theme-toggle" class="flex items-center p-2 rounded hover:bg-medium w-full text-left border border-themed">
                            <i class="fas fa-moon mr-2" id="settings-theme-icon"></i>
                            <span data-translate-key="settings_dark_mode">Modo Oscuro</span>
                        </button>
                    </div>
                </div>
                <!-- Integrations -->
                <div class="border-t border-themed pt-4">
                    <p class="font-semibold mb-2" data-translate-key="settings_integrations">Integraciones</p>
                    <button id="connect-gcalendar-btn" class="w-full bg-input p-2 rounded-lg flex items-center justify-center mb-2 hover:bg-medium transition-colors">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Google_Calendar_icon_%282020%29.svg" class="w-5 h-5 mr-2" alt="Google Calendar Logo">
                        <span data-translate-key="settings_gcalendar">Conectar Google Calendar</span>
                    </button>
                </div>
            </div>
            <button id="close-settings-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>
    
    <div id="gamification-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-2xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-4">
                <h2 class="text-2xl md:text-3xl font-extrabold text-center flex-grow"><i class="fas fa-trophy text-yellow-400 mr-2"></i><span data-translate-key="gamification_title">La Ascensión del GOAT</span></h2>
                <button id="close-gamification-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <!-- Gamification Header -->
            <div class="flex-shrink-0 mb-4 p-3 rounded-lg bg-current-bg-light border border-themed">
                <div class="flex justify-between items-center mb-2">
                    <p class="font-bold text-lg" id="gamification-level-name">Nivel 1: Emprendedor Novato</p>
                    <p class="font-semibold text-sm"><span id="gamification-xp">0</span> / <span id="gamification-next-level-xp">100</span> XP</p>
                </div>
                <div class="w-full xp-bar-bg rounded-full h-2.5">
                    <div id="gamification-xp-bar" class="xp-bar-fill h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <!-- Gamification Tabs -->
            <div class="flex-shrink-0 flex border-b border-themed mb-4">
                <button data-tab="streak" class="gamification-tab flex-1 py-2 px-4 text-sm font-semibold border-b-2 border-transparent" data-translate-key="gamification_tab_streak">Racha Diaria</button>
                <button data-tab="missions" class="gamification-tab flex-1 py-2 px-4 text-sm font-semibold border-b-2 border-transparent" data-translate-key="gamification_tab_missions">Misiones</button>
                <button data-tab="achievements" class="gamification-tab flex-1 py-2 px-4 text-sm font-semibold border-b-2 border-transparent" data-translate-key="gamification_tab_achievements">Logros</button>
            </div>
            <div class="modal-content-body flex-grow overflow-y-auto px-2">
                <!-- Racha Diaria Content -->
                <div id="streak-tab-content" class="gamification-tab-content space-y-4">
                    <p class="text-center text-text-medium" data-translate-key="gamification_streak_desc">¡Inicia sesión cada día para ganar XP y créditos! Completa 7 días para abrir el Cofre GOAT.</p>
                    <div id="daily-streak-container" class="grid grid-cols-7 gap-2 text-center">
                        <!-- Days will be generated by JS -->
                    </div>
                </div>
                <!-- Misiones Content -->
                <div id="missions-tab-content" class="gamification-tab-content hidden space-y-3">
                    <!-- Missions will be generated by JS -->
                </div>
                <!-- Logros Content -->
                <div id="achievements-tab-content" class="gamification-tab-content hidden">
                    <div id="achievements-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 text-center">
                         <!-- Achievements will be generated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        window.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired.");
            dayjs.extend(window.dayjs_plugin_localizedFormat);
            
            // --- GLOBAL STATE & CONSTANTS ---
            const translations = {
                es: {
                    initializing: "Inicializando...", new_chat: "Nuevo Chat", new_folder: "Nueva Carpeta",
                    upgrade_plan: "Mejorar Plan", workflows: "Workflows",
                    wf_pm: "Dirección de Proyectos",
                    wf_social: "Potenciador de Redes Sociales", wf_social_1: "Crear un Post Completo", wf_social_2: "Redacción de Copys", wf_social_3: "Lluvia de Ideas para Posts", wf_social_4: "Definir Estrategia de Marca",
                    wf_business: "Análisis de Negocio", wf_business_1: "Análisis de tu Competencia", wf_business_2: "Definir mi Cliente Ideal", wf_business_3: "Lluvia de Nombres para Marca",
                    wf_sales: "Comunicación y Ventas", wf_sales_1: "Asistente de Ventas 24/7", wf_sales_2: "Redacción de Email", wf_sales_3: "Diseño Web",
                    wf_skills: "Desarrollo de Habilidades", wf_eng_3: "Practicar Inglés", wf_skills_social: "Mejorar Habilidades Sociales", wf_skills_dict: "Diccionario Inteligente",
                    select_chats: "Seleccionar Múltiples Chats", delete: "Borrar", login: "Iniciar Sesión",
                    settings: "Configuración", logout: "Cerrar Sesión", solutions: "Soluciones",
                    ally_title: "Somos tu Aliado Estratégico", ally_desc: "Goatify no es solo un chat. Somos una IA personalizada con un equipo de expertos listos para ayudarte a escalar tu negocio.",
                    welcome_user: "¡Hola, ", welcome_user_2: "! Hoy es un gran día para crear algo increíble.", welcome_guest: "¿Cómo puedo ayudarte hoy?",
                    model: "Modelo:", voice: "Voz:", placeholder_main: "Escribe tu mensaje...",
                    cancel: "Cancelar", confirm: "Confirmar",
                    plans_title: "Planes Goatify IA", plan_free_sub: "Para explorar y empezar", plan_free_cta: "Tu Plan Actual", plan_boost_cta: "Obtener Boost", plan_pro_cta: "Quiero mi Plan Pro + Web",
                    settings_email: "Correo Electrónico:", settings_plan: "Plan de Suscripción:", settings_fontsize: "Tamaño de Letra:",
                    settings_theme: "Personalización:", settings_dark_mode: "Modo Oscuro", settings_integrations: "Integraciones", settings_gcalendar: "Conectar Google Calendar",
                    gamification_title: "La Ascensión del GOAT", gamification_tab_streak: "Racha Diaria", gamification_tab_missions: "Misiones", gamification_tab_achievements: "Logros",
                    gamification_streak_desc: "¡Inicia sesión cada día para ganar XP y créditos! Completa 7 días para abrir el Cofre GOAT.",
                },
                en: { /* English translations can be added here */ }
            };
            
            let state = { chats: {}, projects: {}, structure: [], calendar: {} };
            let gamificationState = {};
            let currentChatId = null, currentUser = null, speechOn = false, availableVoices = [], selectedVoice = null, isRecognizing = false, selectedImageBase64 = null, selectedPdfText = null;
            let micWasOnBeforeSpeaking = false;
            let modalResolve = null;
            let isSelectModeActive = false;
            let chatsToDelete = new Set();
            let activeTagFilter = null;
            let recognition;

            // --- DOM ELEMENT CACHING ---
            const dom = {
                appContainer: document.getElementById('app-container'), msgInput: document.getElementById('msg'), sendBtn: document.getElementById('send'),
                inputArea: document.getElementById('input-area'), messageCounterEl: document.getElementById('message-counter'), upgradePlanContainer: document.getElementById('upgrade-plan-container'),
                upgradePlanBtn: document.getElementById('upgrade-plan-btn'), newChatBtn: document.getElementById('new-chat-btn'), newFolderBtn: document.getElementById('new-folder-btn'),
                pricingModal: document.getElementById('pricing-modal'), closePricingModalBtn: document.getElementById('close-pricing-modal'), genericModal: document.getElementById('generic-modal'),
                chatMessages: document.getElementById('chat-messages'), chatTitle: document.getElementById('chat-title'), mobileChatTitle: document.getElementById('mobile-chat-title'),
                chatTitleWrapper: document.getElementById('chat-title-wrapper'), mobileChatTitleWrapper: document.getElementById('mobile-chat-title-wrapper'),
                initialMessageContainer: document.getElementById('initial-message-container'), themeToggle: document.getElementById('theme-toggle'), themeIcon: document.getElementById('theme-icon'),
                micBtn: document.getElementById('mic-btn'), ttsToggle: document.getElementById('tts-toggle'), modelSelector: document.getElementById('model-selector'),
                imageUploadBtn: document.getElementById('image-upload-btn'), imageUploadInput: document.getElementById('image-upload'),
                pdfUploadBtn: document.getElementById('pdf-upload-btn'), pdfUploadInput: document.getElementById('pdf-upload'), filePreviewArea: document.getElementById('file-preview-area'),
                sidebar: document.getElementById('sidebar'), menuToggle: document.getElementById('menu-toggle'), sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarContent: document.getElementById('sidebar-content'), loginView: document.getElementById('login-view'), userMenuView: document.getElementById('user-menu-view'),
                loginBtn: document.getElementById('login-btn'), userMenuBtn: document.getElementById('user-menu-btn'), userMenuPopup: document.getElementById('user-menu-popup'), userEmail: document.getElementById('user-email'),
                logoutBtn: document.getElementById('logout-btn'), workflowsContainer: document.getElementById('workflows-container'),
                personalizedWelcome: document.getElementById('personalized-welcome'), genericWelcome: document.getElementById('generic-welcome'), userName: document.getElementById('user-name'),
                loadingOverlay: document.getElementById('loading-overlay'), voiceSelector: document.getElementById('voice-selector'), voiceSelectorContainer: document.getElementById('voice-selector-container'),
                selectChatsBtn: document.getElementById('select-chats-btn'), deleteModeControls: document.getElementById('delete-mode-controls'),
                deleteSelectedBtn: document.getElementById('delete-selected-btn'), cancelSelectModeBtn: document.getElementById('cancel-select-mode-btn'),
                imageGenBtn: document.getElementById('image-gen-btn'), servicesMenuBtn: document.getElementById('services-menu-btn'), servicesMenu: document.getElementById('services-menu'),
                contextualFooter: document.getElementById('contextual-footer'), settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'), closeSettingsModal: document.getElementById('close-settings-modal'),
                settingsUserEmail: document.getElementById('settings-user-email'), settingsUserPlan: document.getElementById('settings-user-plan'),
                settingsUpgradePlanBtn: document.getElementById('settings-upgrade-plan-btn'), fontSizeSlider: document.getElementById('font-size-slider'),
                fontSizeValue: document.getElementById('font-size-value'), settingsThemeToggle: document.getElementById('settings-theme-toggle'),
                settingsThemeIcon: document.getElementById('settings-theme-icon'),
                projectWorkflowHeader: document.getElementById('project-workflow-header'), sidebarToggleDesktop: document.getElementById('sidebar-toggle-desktop'),
                mainChatArea: document.getElementById('main-chat-area'),
                projectManagementView: document.getElementById('project-management-view'), projectBoardContainer: document.getElementById('project-board-container'),
                projectChatContainer: document.getElementById('project-chat-container'), projectChatToggle: document.getElementById('project-chat-toggle'),
                chatMessagesView: document.getElementById('chat-messages'), projectViewTitle: document.getElementById('project-view-title'),
                kanbanView: document.getElementById('kanban-view'), listView: document.getElementById('list-view'),
                viewToggleKanban: document.getElementById('view-toggle-kanban'), viewToggleList: document.getElementById('view-toggle-list'),
                projectChatMessages: document.getElementById('project-chat-messages'), projectMsgInput: document.getElementById('project-msg'),
                projectSendBtn: document.getElementById('project-send'), tagFilterBtn: document.getElementById('tag-filter-btn'),
                tagFilterDropdown: document.getElementById('tag-filter-dropdown'), projectModelSelector: document.getElementById('project-model-selector'),
                monthlyToggle: document.getElementById('monthly-toggle'), yearlyToggle: document.getElementById('yearly-toggle'),
                freePlanButton: document.getElementById('free-plan-button'),
                gamificationBtn: document.getElementById('gamification-btn'), gamificationModal: document.getElementById('gamification-modal'),
                closeGamificationModal: document.getElementById('close-gamification-modal'), gamificationBadge: document.getElementById('gamification-badge'),
                connectGCalendarBtn: document.getElementById('connect-gcalendar-btn'),
            };

            // --- UTILITY & HELPER FUNCTIONS ---
            
            function setLanguage(lang) {
                const translationData = translations[lang] || translations.es;
                dayjs.locale(lang);
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    if (translationData[key]) {
                        if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') {
                            if(el.placeholder) el.placeholder = translationData[key];
                        } else {
                            el.innerHTML = translationData[key];
                        }
                    }
                });
                document.documentElement.lang = lang;
                localStorage.setItem('goatify-lang', lang);
            }
            
            function showModal({ title, body, confirmText = 'Confirmar', cancelText = 'Cancelar', showCancel = true }) {
                const modalTitle = dom.genericModal.querySelector('#modal-title');
                const modalBody = dom.genericModal.querySelector('#modal-body');
                const modalButtonsContainer = dom.genericModal.querySelector('#modal-buttons-container');
                
                modalTitle.innerHTML = title;
                modalBody.innerHTML = body;
                
                modalButtonsContainer.innerHTML = `
                    ${showCancel ? `<button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded">${cancelText}</button>` : ''}
                    <button id="modal-confirm" class="px-4 py-2 rounded text-white btn-primary">${confirmText}</button>
                `;
                
                dom.genericModal.querySelector('#modal-confirm').addEventListener('click', () => {
                    const inputs = modalBody.querySelectorAll('input, textarea, select');
                    const data = {};
                    inputs.forEach(input => {
                        data[input.id] = input.type === 'checkbox' ? input.checked : input.value;
                    });
                    hideModal({ confirmed: true, data });
                }, { once: true });
                
                if (showCancel) {
                    dom.genericModal.querySelector('#modal-cancel').addEventListener('click', () => hideModal({ confirmed: false }), { once: true });
                }
                
                dom.genericModal.classList.remove('hidden');
                dom.genericModal.classList.add('flex');
                
                return new Promise(resolve => { modalResolve = resolve; });
            }

            function hideModal(resolveWith = null) { if(modalResolve) { modalResolve(resolveWith); modalResolve = null; } dom.genericModal.classList.add('hidden'); dom.genericModal.classList.remove('flex'); }
            
            function showPricingModal() {
                dom.pricingModal.classList.remove('hidden');
                dom.pricingModal.classList.add('flex');
                setTimeout(() => { dom.pricingModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
                updatePricingPlanButtons();
            }

            function hidePricingModal() { dom.pricingModal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => { dom.pricingModal.classList.add('hidden'); dom.pricingModal.classList.remove('flex'); }, 300); }

            function showSettingsModal() {
                dom.settingsModal.classList.remove('hidden');
                dom.settingsModal.classList.add('flex');
                if (currentUser) {
                    dom.settingsUserEmail.textContent = currentUser.email;
                    const userPlan = currentUser.app_metadata?.plan || 'free';
                    dom.settingsUserPlan.textContent = userPlan.charAt(0).toUpperCase() + userPlan.slice(1);
                    dom.settingsUpgradePlanBtn.classList.toggle('hidden', userPlan !== 'free');
                } else {
                    dom.settingsUserEmail.textContent = 'No ha iniciado sesión';
                    dom.settingsUserPlan.textContent = 'Gratis (Invitado)';
                    dom.settingsUpgradePlanBtn.classList.remove('hidden');
                }
            }

            function hideSettingsModal() { dom.settingsModal.classList.add('hidden'); dom.settingsModal.classList.remove('flex'); }

            function showGamificationModal() {
                updateGamificationUI();
                dom.gamificationModal.classList.remove('hidden');
                dom.gamificationModal.classList.add('flex');
                setTimeout(() => { dom.gamificationModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
                dom.gamificationBadge.classList.add('hidden');
            }

            function hideGamificationModal() { dom.gamificationModal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => { dom.gamificationModal.classList.add('hidden'); dom.gamificationModal.classList.remove('flex'); }, 300); }
            
            function setTheme(isDark) {
                document.body.className = 'w-screen overflow-x-hidden';
                document.body.classList.add(isDark ? 'dark-theme' : 'light-theme');
                dom.themeIcon.className = `fas fa-${isDark ? 'sun' : 'moon'}`;
                if (dom.settingsThemeIcon) dom.settingsThemeIcon.className = `fas fa-${isDark ? 'moon' : 'sun'} mr-2`;
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            }
            
            // --- CORE AI & PROMPT ENGINEERING ---
            async function getAIResponse(prompt, history, image, pdf, model, workflow, userName) {
                const name = (userName || '').split(' ')[0];
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }

                let systemPrompt = `Eres Goatify IA, un asistente de IA de élite, especializado en potenciar negocios y emprendedores. Tu cliente, ${name}, confía en ti. Tu tono es profesional, cercano y altamente competente. Siempre buscas dar respuestas que no solo informen, sino que también ofrezcan un valor estratégico accionable.`;
                
                const workflowPrompts = {
                    'create-full-post': `\n\nActúa como un Community Manager experto y estratega de marketing digital de clase mundial. \n**Reglas Obligatorias:**\n1. **Tono:** Sofisticado, energético y directo. Usa emojis para añadir personalidad, no para rellenar.\n2. **Estructura:**\n - **Hook (Gancho):** Una primera línea impactante que capture la atención de inmediato.\n - **Cuerpo:** Desarrolla el tema con 2-3 párrafos cortos y fáciles de leer. Usa **negritas** para resaltar ideas clave.\n - **Llamada a la Acción (CTA):** Siempre finaliza con una pregunta clara o una instrucción para fomentar la interacción (ej. "Comenta abajo", "Guarda este post", "Visita el link en la bio").\n3. **Hashtags:** Incluye un bloque de 5-7 hashtags relevantes y estratégicos al final. Mezcla hashtags populares con algunos de nicho.\n\n**Tarea:** Basado en la siguiente petición del usuario, genera el post perfecto.`,
                    'persuasive-copy': `\n\nActúa como un copywriter de respuesta directa de nivel mundial. Tu objetivo es persuadir y convertir.\n**Aprende de estos ejemplos:**\n**EJEMPLO BUENO:**\n- **Usuario:** "Necesito un copy para un anuncio de Facebook sobre audífonos con cancelación de ruido."\n- **Tu Respuesta Ideal:**\n> **¿Cansado del ruido? Sumérgete en tu propio mundo. 🎧**\n> \n> Nuestros nuevos audífonos Aura-X no solo reproducen música, crean silencio. Diseñados para que te concentres en lo que importa: tu trabajo, tu podcast, tu paz.\n> \n> Con 30 horas de batería, sentirás que el mundo exterior se desvanece.\n> \n> ✨ **¡Consigue los tuyos con un 20% de descuento de lanzamiento!** Haz clic aquí para transformar tu concentración.\n\n**EJEMPLO MALO (a evitar):**\n- **Usuario:** "Un copy para audífonos."\n- **Respuesta a Evitar:** "Estos son unos audífonos muy buenos, tienen cancelación de ruido y la batería dura mucho. Cómpralos ahora."\n\nAhora, procesa la petición del usuario siguiendo el estilo del **EJEMPLO BUENO**.`,
                    'competitor-analysis': `\n\nEres un Analista de Estrategia de Negocios. Tu tarea es analizar la URL de la competencia que te proporciona el usuario.\n**Sigue estos pasos en tu razonamiento interno:**\n1. Analiza el contenido de la URL para identificar el producto/servicio principal.\n2. Identifica el público objetivo aparente.\n3. Extrae la propuesta de valor principal.\n4. Analiza el tono de la comunicación.\n5. Busca llamadas a la acción (CTAs) evidentes.\n\n**Formato de Respuesta:**\nUna vez analizado, presenta la información al usuario en un formato de tabla Markdown con el siguiente análisis DAFO simplificado:\n\n### Análisis Rápido de [Nombre de la Competencia]\n\n| Fortalezas (👍) | Oportunidades (🚀) |\n| :--- | :--- |\n| *Tu análisis aquí* | *Tu análisis aquí* |\n| Debilidades (👎) | Amenazas (🔥) |\n| *Tu análisis aquí* | *Tu análisis aquí* |\n\n**Conclusión Estratégica:**\n*Un breve párrafo con tu recomendación principal para el usuario.*`,
                    'project-management': `\n\nActúas como un Director de Proyectos experto (Project Manager). Tu objetivo es ayudar al usuario a desglosar un objetivo grande en tareas concretas y accionables. Formula preguntas claras para entender el alcance, los entregables y los plazos. Tu respuesta final debe ser una lista de tareas sugeridas.`,
                    'english-teacher-practice': `\n\nActúa como un profesor de inglés amigable y paciente. Tu objetivo es ayudar al usuario a practicar su conversación. Haz preguntas abiertas, corrige errores de forma constructiva y mantén la conversación fluida.`,
                    'social-skills': `\n\nActúas como un coach de habilidades sociales. Tu objetivo es dar consejos prácticos y accionables para mejorar la comunicación y las relaciones interpersonales. Utiliza escenarios y ejemplos para ilustrar tus puntos.`,
                    'dictionary': `\n\nActúas como un diccionario multilingüe y etimólogo. Cuando un usuario te de una palabra, proporciona: 1. Definición clara. 2. Sinónimos y antónimos. 3. Un ejemplo de uso en una oración. 4. (Si es posible) El origen o etimología de la palabra.`
                };

                if (workflow && workflowPrompts[workflow]) {
                    systemPrompt += workflowPrompts[workflow];
                }

                const body = { prompt, history, model, systemPrompt, imageData: image, pdfText: pdf };
                
                try {
                    const response = await fetch('/.netlify/functions/get-ai-response', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${netlifyIdentity.currentUser()?.token?.access_token}` },
                        body: JSON.stringify(body),
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({details: 'Error desconocido en el servidor'}));
                        throw new Error(errorData.details || `Error del servidor: ${response.status}.`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("Fetch Error:", error);
                    throw error;
                }
            }

            // --- MAIN APPLICATION LOGIC ---

            async function sendMessage(forceSend = false, spokenMessage = null, isProjectChat = false) {
                const inputEl = isProjectChat ? dom.projectMsgInput : dom.msgInput;
                const userMessage = spokenMessage || inputEl.value.trim();
                if (!userMessage && !selectedImageBase64 && !selectedPdfText) return;

                let chatIdToUpdate = currentChatId;
                if (!chatIdToUpdate && !isProjectChat) {
                    chatIdToUpdate = createNewChat({});
                }
                if (!chatIdToUpdate) return;
                
                const currentChat = state.chats[chatIdToUpdate];
                if (!currentChat) return;

                const [image, pdf] = [selectedImageBase64, selectedPdfText];
                currentChat.messages.push({ role: 'user', content: userMessage, image, pdfText: pdf });
                
                const messageContainer = isProjectChat ? dom.projectChatMessages : dom.chatMessages;
                addMessageToUI('user', userMessage, image, currentChat.messages.length - 1, messageContainer);
                const thinkingBubble = addMessageToUI('assistant', '…', null, null, messageContainer);
                inputEl.value = ''; inputEl.style.height = 'auto';
                clearFileData();
                
                try {
                    const modelToUse = isProjectChat ? dom.projectModelSelector.value : getModelForRequest(currentChat.workflow, hasFile());
                    const userNameForCall = currentUser ? (currentUser.user_metadata.full_name || currentUser.email) : 'viajero';
                    
                    const responseData = await getAIResponse(userMessage, currentChat.messages.slice(0, -1), image, pdf, modelToUse, currentChat.workflow, userNameForCall);

                    if (responseData.reply) {
                        currentChat.messages.push({ role: 'assistant', content: responseData.reply });
                        updateMessageInUI(thinkingBubble, responseData.reply, null, messageContainer);
                        speak(responseData.reply);
                        
                        if (isProjectChat && responseData.projectUpdate && responseData.projectUpdate.tasks) {
                             const todoColumn = currentChat.projectData.columns.find(c => c.id === 'todo');
                             if (todoColumn) {
                                 responseData.projectUpdate.tasks.forEach(task => {
                                     if (!todoColumn.tasks) todoColumn.tasks = [];
                                     todoColumn.tasks.push({ id: crypto.randomUUID(), content: task.content, completed: false, labels: task.labels || [] });
                                 });
                             }
                             renderProjectBoard(chatIdToUpdate);
                        }

                        saveState();
                        checkAndCompleteMissions(currentChat.workflow, userMessage);
                    } else if (responseData.error) {
                        throw new Error(responseData.details || 'Error del servidor.');
                    }
                } catch (error) {
                    updateMessageInUI(thinkingBubble, `❌ **Error de Conexión**<br><small>${error.message}</small>`, null, messageContainer);
                }
            }
            
            // --- GAMIFICATION LOGIC ---
            const missions = {
                'm_strategy': { id: 'm_strategy', text: 'Define tu primera estrategia de marca', workflow: 'brand-strategy', xp: 50, credits: 15 },
                'm_competitor': { id: 'm_competitor', text: 'Espía a la competencia con el buscador web', workflow: 'competitor-analysis', xp: 50, credits: 15 },
                'm_project': { id: 'm_project', text: 'Crea tu primer tablero de proyecto', workflow: 'project-management', xp: 100, credits: 30 },
                'm_image': { id: 'm_image', text: 'Genera tu primera imagen con IA', workflow: 'image-generation', xp: 40, credits: 10 },
                'm_english': { id: 'm_english', text: 'Practica tu inglés en una conversación', workflow: 'english-teacher-practice', xp: 60, credits: 20 },
                'm_social_skills': { id: 'm_social_skills', text: 'Pide un consejo para mejorar tus habilidades sociales', workflow: 'social-skills', xp: 60, credits: 20 },
            };

            const achievements = {
                'a_streak_30': { id: 'a_streak_30', name: 'Consistencia GOAT', description: 'Mantén la racha por 30 días', icon: 'fa-calendar-check', xp: 500, credits: 250 },
                'a_projects_10': { id: 'a_projects_10', name: 'Project Master', description: 'Completa 10 proyectos', icon: 'fa-sitemap', xp: 1000, credits: 0, reward: {type: 'discount', value: 0.5, service: 'automatización'} },
                'a_posts_50': { id: 'a_posts_50', name: 'Influencer', description: 'Genera 50 posts para redes', icon: 'fa-share-nodes', xp: 750, credits: 0, reward: {type: 'plan', value: 'boost', duration: 1} },
            };

            function initGamificationState() {
                const defaultState = { xp: 0, level: 1, credits: 0, lastLogin: null, streak: 0, completedMissions: [], unlockedAchievements: [], hasSeenRules: false };
                try {
                    gamificationState = JSON.parse(localStorage.getItem(`gamificationState_${currentUser?.id || 'guest'}`)) || defaultState;
                } catch (e) {
                    console.error("Could not parse gamification state, resetting.", e);
                    gamificationState = defaultState;
                }
                if (!gamificationState.hasSeenRules) {
                    showGamificationRules();
                    gamificationState.hasSeenRules = true;
                    saveGamificationState();
                }
            }
            
            function saveGamificationState() { localStorage.setItem(`gamificationState_${currentUser?.id || 'guest'}`, JSON.stringify(gamificationState)); }
            function addXP(amount) { gamificationState.xp += amount; showXPNotification(amount); checkLevelUp(); saveGamificationState(); updateGamificationUI(); }
            function addCredits(amount, reason) { gamificationState.credits += amount; showCreditNotification(amount, reason); saveGamificationState(); updateCreditCounter(); }
            function checkLevelUp() {
                const levels = [100, 300, 700, 1500, Infinity];
                while (gamificationState.xp >= levels[gamificationState.level - 1]) {
                    gamificationState.xp -= levels[gamificationState.level - 1];
                    gamificationState.level++;
                    showLevelUpNotification(gamificationState.level);
                }
            }

            function checkDailyStreak() {
                const today = dayjs().format('YYYY-MM-DD');
                if (gamificationState.lastLogin === today) return;
                const yesterday = dayjs().subtract(1, 'day').format('YYYY-MM-DD');
                gamificationState.streak = (gamificationState.lastLogin === yesterday) ? gamificationState.streak + 1 : 1;
                gamificationState.lastLogin = today;
                const day = gamificationState.streak;
                if (day <= 3) { addXP(10); addCredits(5, "Racha Diaria"); }
                else if (day <= 6) { addXP(20); addCredits(10, "Racha Diaria"); }
                else if (day >= 7) { addXP(100); openGoatChest(); gamificationState.streak = 0; }
                saveGamificationState();
            }
            
            function openGoatChest() {
                const rand = Math.random();
                let reward;
                if (rand < 0.01) { reward = { type: 'consultancy', text: '¡Legendario! Ganaste una Asesoría Estratégica de 30 min GRATIS.' }; }
                else if (rand < 0.1) { reward = { type: 'discount', value: 0.25, text: '¡Épico! Ganaste un 25% de descuento en nuestros servicios.' }; }
                else if (rand < 0.4) { reward = { type: 'credits', value: 150, text: '¡Raro! Ganaste 150 créditos extra.' }; addCredits(150, "Cofre GOAT"); }
                else { reward = { type: 'credits', value: 50, text: '¡Común! Ganaste 50 créditos.' }; addCredits(50, "Cofre GOAT"); }
                showModal({ title: '🎁 ¡Cofre GOAT Abierto! 🎁', body: reward.text, confirmText: '¡Genial!', showCancel: false });
                if(window.confetti) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            }

            function checkAndCompleteMissions(workflow) {
                Object.values(missions).forEach(mission => {
                    if (gamificationState.completedMissions.includes(mission.id)) return;
                    if (mission.workflow && mission.workflow === workflow) {
                        gamificationState.completedMissions.push(mission.id);
                        addXP(mission.xp);
                        addCredits(mission.credits, `Misión: ${mission.text}`);
                        showModal({ title: '🚀 ¡Misión Cumplida! 🚀', body: `Completaste: "${mission.text}"<br>+${mission.xp} XP, +${mission.credits} Créditos`, confirmText: '¡Vamos!', showCancel: false });
                        if(window.confetti) confetti();
                    }
                });
                saveGamificationState();
            }

            function updateGamificationUI() {
                if (!document.getElementById('gamification-level-name')) return;
                const levels = { 1: "Emprendedor Novato", 2: "Creador de Contenido", 3: "Estratega de Marketing", 4: "CEO Digital", 5: "GOAT" };
                const xpForNext = [100, 300, 700, 1500];
                document.getElementById('gamification-level-name').textContent = `Nivel ${gamificationState.level}: ${levels[gamificationState.level] || 'GOAT'}`;
                const nextLevelXP = xpForNext[gamificationState.level - 1] || gamificationState.xp;
                document.getElementById('gamification-xp').textContent = gamificationState.xp;
                document.getElementById('gamification-next-level-xp').textContent = nextLevelXP;
                document.getElementById('gamification-xp-bar').style.width = `${(gamificationState.xp / nextLevelXP) * 100}%`;
            }

            function showXPNotification(amount) { /* TODO */ }
            function showCreditNotification(amount, reason) { /* TODO */ }
            function showLevelUpNotification(level) { /* TODO */ }
            function showGamificationRules() {
                showModal({
                    title: '룰 ¡Bienvenido a la Ascensión del GOAT! 룰',
                    body: `<p class="text-center mb-4">Tu viaje para convertirte en un maestro del marketing digital comienza ahora. Así es como funciona:</p>
                           <ul class="space-y-3 text-left">
                               <li><strong><i class="fas fa-arrow-up-right-dots text-green-400 mr-2"></i>Gana XP:</strong> Completa misiones y mantén tu racha diaria para ganar Puntos de Experiencia (XP).</li>
                               <li><strong><i class="fas fa-trophy text-yellow-400 mr-2"></i>Sube de Nivel:</strong> Acumula XP para subir de nivel, desde "Novato" hasta "GOAT", desbloqueando tu potencial.</li>
                               <li><strong><i class="fas fa-calendar-check text-blue-400 mr-2"></i>Racha Diaria:</strong> ¡No rompas la cadena! Inicia sesión todos los días para ganar recompensas crecientes y un cofre especial el día 7.</li>
                               <li><strong><i class="fas fa-bullseye text-red-400 mr-2"></i>Completa Misiones:</strong> Te guiaremos para que descubras todo el poder de Goatify IA. Cada misión cumplida te da grandes recompensas.</li>
                           </ul>
                           <p class="text-center mt-4 font-bold">¡Cada acción cuenta! ¿Estás listo para empezar?</p>`,
                    confirmText: '¡Estoy Listo!',
                    showCancel: false
                });
            }
            
            // --- RESTORED CORE FUNCTIONS ---
            function updateCreditCounter() { /* Placeholder */ }
            function updatePricingPlanButtons() { /* Placeholder */ }
            function getModelForRequest(workflow, hasFile) {
                if (workflow === "design-web") return "gpt-4o-mini";
                if (hasFile) return "gpt-4o-mini";
                return dom.modelSelector.value;
            }
            function hasFile() { return selectedImageBase64 || selectedPdfText; }
            function clearFileData() {
                dom.imageUploadInput.value = '';
                dom.pdfUploadInput.value = '';
                dom.filePreviewArea.innerHTML = '';
                selectedImageBase64 = null;
                selectedPdfText = null;
            }
            function createNewChat(options = {}) {
                const id = 'chat-' + crypto.randomUUID();
                state.chats[id] = { id, title: options.title || "Nueva Conversación", messages: options.initialMessages || [], workflow: options.workflow || null, model: options.model || 'gpt-4o-mini' };
                state.structure.unshift(id);
                selectChat(id);
                saveState();
                renderSidebar();
                return id;
            }
            function addMessageToUI(role, content, imageSrc, messageIndex, container) {
                const wrapper = document.createElement('div');
                wrapper.className = `chat-bubble-wrapper group flex items-start gap-2 my-2 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                const bubble = document.createElement('div');
                bubble.className = `p-3 md:p-4 rounded-xl max-w-lg md:max-w-xl ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot'}`;
                if (imageSrc) {
                    const img = document.createElement('img');
                    img.src = imageSrc;
                    img.className = 'rounded-lg mb-2 max-w-full h-auto';
                    bubble.appendChild(img);
                }
                const contentDiv = document.createElement('div');
                contentDiv.className = 'markdown-content';
                contentDiv.innerHTML = content === '…' ? `<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .2s;"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .4s;"></div></div>` : marked.parse(content || "");
                bubble.appendChild(contentDiv);
                wrapper.appendChild(bubble);
                container.appendChild(wrapper);
                container.scrollTop = container.scrollHeight;
                return bubble;
            }
            function updateMessageInUI(bubble, content, imageSrc, container) {
                const newBubble = addMessageToUI('assistant', content, imageSrc, null, container);
                if (bubble && bubble.parentElement) {
                    bubble.parentElement.replaceWith(newBubble.parentElement);
                }
            }
            function selectChat(chatId) {
                if (!chatId || !state.chats[chatId]) { resetChatView(); return; }
                currentChatId = chatId;
                const chat = state.chats[chatId];
                dom.initialMessageContainer.style.display = 'none';
                if (chat.workflow === 'project-management') {
                    dom.chatMessagesView.style.display = 'none';
                    dom.inputArea.style.display = 'none';
                    dom.projectManagementView.style.display = 'flex';
                    renderProjectView(chatId);
                } else {
                    dom.projectManagementView.style.display = 'none';
                    dom.chatMessagesView.style.display = 'block';
                    dom.inputArea.style.display = 'block';
                    dom.chatMessages.innerHTML = '';
                    chat.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, msg.image, index, dom.chatMessages));
                }
                dom.chatTitle.textContent = chat.title;
                dom.mobileChatTitle.textContent = chat.title;
                dom.modelSelector.value = chat.model || 'gpt-4o-mini';
                updateActiveChatHighlight();
                saveState();
                updateContextualFooter(chat.workflow);
            }
            function resetChatView() {
                currentChatId = null;
                dom.chatTitle.textContent = "Goatify IA";
                dom.mobileChatTitle.textContent = "Goatify IA";
                dom.chatMessagesView.style.display = 'block';
                dom.inputArea.style.display = 'block';
                dom.projectManagementView.style.display = 'none';
                dom.chatMessages.innerHTML = '';
                dom.initialMessageContainer.style.display = 'flex';
                updateUserUI();
                updateActiveChatHighlight();
                updateContextualFooter(null);
            }
            function renderSidebar() {
                dom.sidebarContent.innerHTML = '';
                (state.structure || []).forEach(id => {
                    if (id.startsWith('project-')) { /* create project element */ }
                    else if (id.startsWith('chat-')) {
                        const chat = state.chats[id];
                        if (!chat) return;
                        const item = document.createElement('div');
                        item.className = 'chat-item group flex items-center justify-between p-2 rounded-md cursor-pointer';
                        item.dataset.id = id;
                        item.innerHTML = `<i class="far fa-comment-dots mr-2"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span>`;
                        item.addEventListener('click', () => selectChat(id));
                        dom.sidebarContent.appendChild(item);
                    }
                });
                updateActiveChatHighlight();
            }
            function updateActiveChatHighlight() {
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.toggle('selected-chat', item.dataset.id === currentChatId);
                });
            }
            function updateUserUI() {
                if (currentUser) {
                    dom.loginView.classList.add('hidden');
                    dom.userMenuView.classList.remove('hidden');
                    dom.genericWelcome.classList.add('hidden');
                    dom.personalizedWelcome.classList.remove('hidden');
                    const userName = currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.email.split('@')[0];
                    dom.userEmail.textContent = currentUser.user_metadata?.full_name || currentUser.email;
                    dom.userName.textContent = userName;
                } else {
                    dom.loginView.classList.remove('hidden');
                    dom.userMenuView.classList.add('hidden');
                    dom.genericWelcome.classList.remove('hidden');
                    dom.personalizedWelcome.classList.add('hidden');
                }
            }
            async function loadStateForUser() { /* Simplified */ state = { chats: {}, projects: {}, structure: [], calendar: {} }; currentChatId = null; renderSidebar(); selectChat(null); }
            async function saveState() { /* Simplified */ }
            function updateContextualFooter(workflowKey) { /* Placeholder */ }
            function renderProjectView(chatId) { /* Placeholder */ }
            function renderProjectBoard(chatId) { /* Placeholder */ }
            function speak(text) {
                if (!speechOn || !('speechSynthesis' in window) || !text) return;
                speechSynthesis.cancel();
                micWasOnBeforeSpeaking = isRecognizing;
                if (isRecognizing) { recognition.stop(); }
                const cleanText = text.replace(/<[^>]*>/g, '').replace(/[*_`#~[\]()🔍]|(-{3,})/g, '');
                const utterance = new SpeechSynthesisUtterance(cleanText);
                if (selectedVoice) { utterance.voice = selectedVoice; }
                utterance.rate = 1.15;
                utterance.onend = () => { if (micWasOnBeforeSpeaking) { try { recognition.start(); } catch(e) {} } };
                speechSynthesis.speak(utterance);
            }
            function populateVoiceList() {
                if(!dom.voiceSelector) return;
                const setVoices = () => {
                    if (typeof speechSynthesis === 'undefined') return;
                    availableVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('es-'));
                    if(availableVoices.length > 0) {
                        dom.voiceSelector.innerHTML = '';
                        availableVoices.forEach(voice => {
                            const option = document.createElement('option');
                            option.textContent = voice.name;
                            option.value = voice.name;
                            dom.voiceSelector.appendChild(option);
                        });
                        selectedVoice = availableVoices[0];
                    }
                }
                if (speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = setVoices; }
                setTimeout(setVoices, 200);
            }

            // --- INITIALIZATION ---
            function init() {
                console.log("App Initializing. User:", currentUser ? currentUser.email : "guest");
                const savedLang = localStorage.getItem('goatify-lang') || 'es';
                setLanguage(savedLang);
                setTheme(localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches));
                
                initGamificationState();
                updateUserUI();
                loadStateForUser();
                populateVoiceList();
                setupEventListeners();
                updateContextualFooter(null);
                checkDailyStreak();

                dom.appContainer.classList.remove('opacity-0');
                dom.loadingOverlay.style.display = 'none';

                if (currentChatId && state.chats[currentChatId]) {
                    selectChat(currentChatId);
                } else {
                    resetChatView();
                }
            }
            
            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                dom.sendBtn?.addEventListener('click', () => sendMessage(false, null, false));
                dom.projectSendBtn?.addEventListener('click', () => sendMessage(false, null, true));
                dom.newFolderBtn?.addEventListener('click', async () => { /* create project logic */ });
                dom.gamificationBtn?.addEventListener('click', showGamificationModal);
                dom.closeGamificationModal?.addEventListener('click', hideGamificationModal);
                dom.connectGCalendarBtn?.addEventListener('click', () => { showModal({title: "Integración con Google Calendar", body: "Esta función te permitirá sincronizar tus tareas de Goatify con tu calendario de Google. ¡Próximamente disponible!", confirmText: "Entendido", showCancel: false}); });
                dom.monthlyToggle.addEventListener('click', () => {
                    dom.monthlyToggle.classList.add('active');
                    dom.yearlyToggle.classList.remove('active');
                    document.querySelectorAll('[data-price-monthly]').forEach(el => { el.textContent = el.dataset.priceMonthly; });
                });
                dom.yearlyToggle.addEventListener('click', () => {
                    dom.yearlyToggle.classList.add('active');
                    dom.monthlyToggle.classList.remove('active');
                    document.querySelectorAll('[data-price-yearly]').forEach(el => { el.textContent = el.dataset.priceYearly; });
                });
                document.querySelectorAll('#services-menu a').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const solution = e.currentTarget.dataset.solution;
                        const messages = {
                            web: "Hola Goatify, estoy interesado en sus servicios de diseño de Páginas Web que Convierten. ¿Podrían darme más información?",
                            auto: "Hola Goatify, me gustaría saber más sobre cómo pueden ayudarme a poner mis Ventas en Piloto Automático con IA.",
                            social: "Hola Goatify, ¡quiero información sobre los Avatares para Redes Sociales! Suena increíble.",
                            consult: "Hola Goatify, necesito su ayuda para Escalar mi Empresa con IA. ¿Podemos hablar sobre su consultoría estratégica?"
                        };
                        const text = encodeURIComponent(messages[solution] || "Hola Goatify, me gustaría saber más sobre sus soluciones de IA.");
                        window.open(`https://wa.me/17439106116?text=${text}`, '_blank');
                    });
                });
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SR && dom.micBtn) {
                    recognition = new SR();
                    recognition.continuous = false; recognition.lang = 'es-ES';
                    recognition.onstart = () => { isRecognizing = true; dom.micBtn.classList.add('glowing-mic'); };
                    recognition.onend = () => { isRecognizing = false; dom.micBtn.classList.remove('glowing-mic'); };
                    recognition.onresult = (event) => { const transcript = event.results[0][0].transcript; if(transcript) { dom.msgInput.value = transcript; sendMessage(); } };
                    dom.micBtn.addEventListener('click', () => {
                        if (isRecognizing) { recognition.stop(); }
                        else {
                            speechSynthesis.cancel();
                            speechOn = true;
                            const icon = dom.ttsToggle.querySelector('i');
                            icon.classList.add('fa-volume-high');
                            icon.classList.remove('fa-volume-mute');
                            try { recognition.start(); } catch (e) { console.error(e); }
                        }
                    });
                }
            }

            // --- Netlify Identity Integration ---
            let initFired = false;
            const startApp = (user) => {
                if (initFired) return;
                initFired = true;
                currentUser = user;
                init();
            };
            netlifyIdentity.on('init', user => startApp(user));
            netlifyIdentity.on('login', user => { netlifyIdentity.close(); startApp(user); });
            netlifyIdentity.on('logout', () => startApp(null));
            setTimeout(() => startApp(netlifyIdentity.currentUser()), 1500);

        });
    </script>
</body>
</html>
