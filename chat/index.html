<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#101010">
    <link rel="manifest" href="manifest.json">
    <title>Goatify IA</title>
    <link rel="icon" type="image/png" href="./Logos HD.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/locale/es.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/plugin/localizedFormat.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/plugin/isoWeek.js"></script>
    
    <style>
        :root {
            --bg-dark: #101010;
            --bg-medium: #1a1a1a;
            --bg-light: #282828;
            --primary: #8a4fff;
            --primary-hover: #7b46e6;
            --text-light: #e5e5e5;
            --text-medium: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
            --gold-color: #FFD700;
            --urgent-color: #ef4444;
            --danger-color: #dc2626;

            --light-bg-dark: #f9f9f9;
            --light-bg-medium: #ffffff;
            --light-bg-light: #f1f1f1;
            --light-primary: #7c40e6;
            --light-primary-hover: #6a37d3;
            --light-text-dark: #1f2937;
            --light-text-medium: #6b7280;
            --light-border-color: rgba(0, 0, 0, 0.09);

            /* Base font size, will be controlled by JS for dynamic changes */
            --base-font-size: 15px; 
        }

        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            /* Apply font size to everything by default */
            font-size: var(--base-font-size); 
        }

        body {
            font-family: 'Montserrat', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* All font-size related classes will inherit from --base-font-size and scale */
        .text-xxs { font-size: calc(var(--base-font-size) * 0.6); }
        .text-xs { font-size: calc(var(--base-font-size) * 0.75); }
        .text-sm { font-size: calc(var(--base-font-size) * 0.875); }
        .text-base { font-size: var(--base-font-size); }
        .text-lg { font-size: calc(var(--base-font-size) * 1.125); }
        .text-xl { font-size: calc(var(--base-font-size) * 1.25); }
        .text-2xl { font-size: calc(var(--base-font-size) * 1.5); }
        .text-3xl { font-size: calc(var(--base-font-size) * 1.875); }
        .text-4xl { font-size: calc(var(--base-font-size) * 2.25); }
        .text-5xl { font-size: calc(var(--base-font-size) * 3); }


        .dark-theme {
            --current-bg-dark: var(--bg-dark);
            --current-bg-medium: var(--bg-medium);
            --current-bg-light: var(--bg-light);
            --current-primary: var(--primary);
            --current-primary-hover: var(--primary-hover);
            --current-text-light: var(--text-light);
            --current-text-medium: var(--text-medium);
            --current-border-color: var(--border-color);
            background-color: var(--current-bg-dark);
            color: var(--text-light);
        }

        .light-theme {
            --current-bg-dark: var(--light-bg-dark);
            --current-bg-medium: var(--light-bg-medium);
            --current-bg-light: var(--light-bg-light);
            --current-primary: var(--light-primary);
            --current-primary-hover: var(--light-primary-hover);
            --current-text-light: var(--light-text-dark);
            --current-text-medium: var(--light-text-medium);
            --current-border-color: var(--light-border-color);
            background-color: var(--light-bg-dark);
            color: var(--light-text-dark);
        }
        
        #sidebar { 
            background-color: var(--current-bg-dark); 
            border-right: 1px solid var(--current-border-color); 
            height: 100vh; 
            transition: width 0.3s ease, transform 0.3s ease; 
            z-index: 40; 
            position: relative;
            display: flex; /* Ensure flex column layout for sidebar content */
            flex-direction: column;
        }
        /* When collapsed, only show the logo space, and the toggle arrow */
        #sidebar.collapsed { 
            width: 80px; /* Adjusted collapsed width to show logo (e.g., 64px width + 2x8px padding) */
            padding-left: 0;
            padding-right: 0; 
            overflow: hidden; 
            border-right: none;
        }
        /* When sidebar is collapsed, only display the header (logo) and the toggle arrow */
        #sidebar.collapsed > *:not(#sidebar-toggle-arrow, #sidebar-header, .workflow-category) { 
            display: none; 
        }
        /* Style for collapsed workflow icons at the bottom of the collapsed sidebar */
        #sidebar.collapsed .workflow-category .workflow-header {
            padding: 8px 0; /* Adjust padding for icon-only display */
            justify-content: center; /* Center the icon */
        }
        #sidebar.collapsed .workflow-category .workflow-header i:not(.workflow-arrow) {
            margin-right: 0; /* Remove margin for icon-only display */
        }
        #sidebar.collapsed .workflow-category .workflow-header span,
        #sidebar.collapsed .workflow-category .workflow-arrow {
            display: none; /* Hide text and arrow when collapsed */
        }

        #sidebar.collapsed #sidebar-toggle-arrow {
            display: flex;
            left: unset; /* Reset left positioning */
            right: -12px; /* Position correctly when collapsed */
            transform: translateY(0%) rotate(180deg); /* Arrow points right when collapsed */
            top: 12px; /* Position at the top right */
        }

        #sidebar-toggle-arrow {
            position: absolute;
            top: 12px; /* Position at the top right */
            right: -12px;
            transform: translateY(0%) rotate(0deg); /* No vertical translation initially, arrow points left initially (expanded state) */
            background-color: var(--current-bg-dark);
            border: 1px solid var(--current-border-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: none; /* Hidden by default, shown on desktop */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 45;
            transition: transform 0.3s ease, left 0.3s ease, right 0.3s ease, top 0.3s ease; /* Added top to transition */
        }
        #sidebar:not(.collapsed) #sidebar-toggle-arrow {
            right: -12px; /* Keep it on the right side when expanded */
            transform: translateY(0%) rotate(0deg); /* Arrow points left when expanded */
        }


        #sidebar-header, #sidebar-bottom-fixed {
            flex-shrink: 0;
            padding: 0.75rem;
        }
        #sidebar-header { border-bottom: 1px solid var(--current-border-color); }
        #sidebar-bottom-fixed { border-top: 1px solid var(--current-border-color); }

        #sidebar-scrollable-content {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
        }
        #sidebar-content-main {
            flex-grow: 1;
        }
        #sidebar-footer {
            flex-shrink: 0;
            margin-top: auto;
            padding-top: 1rem;
        }

        /* New styles for folder category in sidebar */
        .folders-category .folder-header {
            display: flex;
            align-items: center;
            padding: 2px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-weight: 600; /* Made folder names bold */
        }
        .folders-category .folder-header:hover {
            background-color: var(--current-bg-light);
        }
        .folders-category.open .folder-content {
            display: block;
        }
        .folders-category.open .folder-arrow {
            transform: rotate(90deg);
        }
        .folders-content {
            display: none;
            padding-left: 0.5rem; /* Indent contents of the folder */
        }
        .folders-content .chat-item {
            padding-left: 1.5rem; /* Further indent items inside folders */
        }
        .folders-category.default-open .folders-content { display: block; } /* Always open by default */

        @media (max-width: 767px) {
            #sidebar {
                transform: translateX(-100%);
                position: fixed;
                top: 0;
                left: 0;
                width: 288px;
            }
            #sidebar.is-open {
                transform: translateX(0);
            }
            #sidebar, #sidebar > .flex {
                height: 100vh;
                height: -webkit-fill-available;
            }
            /* Mobile font size adjustment - handled by base-font-size now */
            /* button, .btn-primary { 
                padding-top: 0.4rem; padding-bottom: 0.4rem; 
                padding-left: 0.75rem; padding-right: 0.75rem;
                font-size: 0.8rem;
            } */
            /* .text-lg { font-size: 1rem; }
            .text-xl { font-size: 1.1rem; }
            .text-2xl { font-size: 1.2rem; }
            .text-3xl { font-size: 1.4rem; } */
            #app-container {
                max-height: calc(100vh - 10px);
            }
             #sidebar.collapsed { /* On mobile, when explicitly collapsed by menu button, should hide completely */
                width: 0; 
                padding: 0; 
                overflow: hidden; 
                border-right: none;
            }
            #sidebar.collapsed > * { /* Hide all content when fully collapsed on mobile */
                display: none; 
            }
            #sidebar.collapsed #sidebar-toggle-arrow { /* Hide sidebar toggle arrow on mobile */
                display: none;
            }
        }


        #main-chat-area, .modal-content { background-color: var(--current-bg-medium); }
        .chat-bubble-bot, .bg-input, #pdf-preview-container, .chat-item, .project-header, #user-menu-popup, #services-menu, .pro-controls-bg { background-color: var(--current-bg-light); }
        .border-themed { border-color: var(--current-border-color); }
        .chat-bubble-user { background-color: var(--current-primary); color: white; }
        .btn-primary { background-color: var(--current-primary); color: white; }
        .btn-primary:hover { background-color: var(--current-primary-hover); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .plan-card-highlight { border-color: var(--current-primary); box-shadow: 0 0 15px rgba(138, 79, 255, 0.3); }
        .placeholder-themed::placeholder { color: var(--current-text-medium); }
        .text-primary, .workflow-header i:not(.workflow-arrow) { color: var(--current-primary) !important; }
        .glowing-mic { animation: pulse 1.5s infinite; color: var(--primary) !important; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(138, 79, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0); }
        }

        .project .project-content { display: none; }
        .project.open .project-content { display: block; }
        .project.open .project-arrow { transform: rotate(90deg); }
        .project-header.drag-over { background-color: var(--current-primary); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        #app-container { height: 100vh; height: -webkit-fill-available; }
        #pricing-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .chat-item.selected-for-delete { background-color: var(--primary) !important; color: white; }
        
        .model-selector-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .model-selector-wrapper select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
            padding-right: 2.5rem;
            height: 32px;
            font-size: calc(var(--base-font-size) * 0.875); /* Adjusted to use calc or be relative to base */
            line-height: 1.25rem;
            border: none;
            outline: none;
            cursor: pointer;
            min-width: 120px;
            background-color: transparent;
        }
         .model-selector-wrapper i {
            position: absolute;
            right: 0.5rem;
            pointer-events: none;
        }

        .pro-controls-bg {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.375rem;
            border-radius: 0.5rem;
            overflow: hidden; 
            width: 100%;
            gap: 0.5rem;
        }

        #pro-controls-left, #pro-controls-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        #pro-controls-left {
            flex-grow: 1;
            min-width: 0;
        }

        #pro-controls-right {
            flex-shrink: 0;
        }
        
        .workflow-category.open .workflow-content, .actions-category.open .actions-content, .folders-category.open .folders-content { display: block; }
        .workflow-category.open .workflow-arrow, .actions-category.open .actions-arrow, .folders-category.open .folder-arrow { transform: rotate(90deg); }
        .workflow-content, .actions-content, .folders-content { display: none; }
        .folders-category.default-open .folders-content { display: block; } /* Always open by default */

        .plan-card { background-color: var(--current-bg-light); }
        #pdf-preview-container { padding: 0.5rem; }
        
        @keyframes sweep {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(200%) skewX(-15deg); }
        }
        .cool-light-effect { position: relative; overflow: hidden; }
        .cool-light-effect::before {
            content: '';
            position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(138, 79, 255, 0.25) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-150%) skewX(-15deg); transition: transform 0.8s ease;
            pointer-events: none;
        }
        .cool-light-effect:hover::before { animation: sweep 2s infinite linear; }

        .input-wrapper { border: 1px solid transparent; transition: box-shadow 0.3s ease, border-color 0.3s ease; }
        .input-wrapper:focus-within { box-shadow: 0 0 10px 0px rgba(138, 79, 255, 0.5); border-color: var(--current-primary-hover); }

        #chat-title {
            color: var(--primary);
            font-weight: 700;
            transition: color 0.3s ease;
        }
        #desktop-chat-title-wrapper:hover #chat-title {
            color: var(--primary-hover);
        }
        
        #desktop-chat-title-wrapper {
            position: relative;
            cursor: pointer;
        }
        #desktop-chat-title-wrapper .edit-icon {
            opacity: 0;
            transition: opacity 0.2s;
            margin-right: 8px;
        }
        #desktop-chat-title-wrapper:hover .edit-icon {
            opacity: 1;
        }
        #mobile-chat-title-wrapper .edit-icon {
            margin-right: 8px;
        }

        .btn-disabled { background-color: #3a3a3a !important; color: #888 !important; cursor: not-allowed !important; border-color: #3a3a3a !important;}

        .chat-item.selected-chat {
            background-color: var(--current-primary);
            color: white !important;
        }
        .chat-item.selected-chat .text-sm {
            color: white !important;
        }
        .light-theme .chat-item {
            color: var(--light-text-dark);
        }

        /* Calendar styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day {
            padding: 2px;
            border-radius: 4px;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            transition: background-color 0.2s ease, border 0.2s ease;
            position: relative;
            border: 2px solid transparent;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .calendar-day-number {
            font-weight: bold;
            font-size: calc(var(--base-font-size) * 0.8); 
            margin: 4px;
            align-self: flex-start;
        }
        .calendar-day-tasks {
            flex-grow: 1;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 0 2px 2px 2px;
        }
        .calendar-day-task {
            font-size: calc(var(--base-font-size) * 0.65); 
            padding: 2px 4px;
            border-radius: 4px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
            position: relative;
        }
        .calendar-day-task .delete-task-icon {
            display: none;
            position: absolute;
            right: 1px;
            top: 1px;
            color: white;
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 14px;
            height: 14px;
            font-size: calc(var(--base-font-size) * 0.5); 
            line-height: 14px;
            text-align: center;
        }
        .calendar-day-task:hover .delete-task-icon {
            display: block;
        }

        .calendar-day:hover {
            background-color: var(--current-bg-light);
        }
        .calendar-day.current-month {
            color: var(--current-text-light);
        }
        .calendar-day.other-month {
            color: var(--current-text-medium);
            opacity: 0.5;
        }
        .calendar-day.today .calendar-day-number {
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 2px;
        }
        .task-dots-container {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
        }
        .task-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-item-completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .notification-bell-icon {
            position: relative;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7em;
            line-height: 1;
            min-width: 18px;
            text-align: center;
        }
        
        .calendar-view-toggle, .project-view-controls {
            display: flex;
            gap: 0.5rem;
            background-color: var(--current-bg-dark);
            padding: 0.25rem;
            border-radius: 8px;
            width: 100%;
        }

        .calendar-view-toggle button, .project-view-controls button {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            font-weight: 600;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
            white-space: nowrap; /* Prevents text wrapping */
        }
        .calendar-view-toggle button.active, .project-view-controls button.active {
            background-color: var(--current-primary);
            color: white;
            box-shadow: 0 0 8px rgba(138, 79, 255, 0.4);
        }
        .calendar-view-toggle button:hover:not(.active), .project-view-controls button:hover:not(.active) {
            background-color: var(--current-bg-medium);
        }
        .dark-theme .project-view-controls button:not(.active) {
            color: var(--current-text-light);
        }
        .light-theme .project-view-controls button:not(.active) {
            color: var(--current-text-dark);
        }

        #month-view-container, #day-view-container {
            display: block;
        }
        #week-view-container, #day-view-container {
            display: none;
        }
        #week-view-container, #day-view-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--current-border-color);
            border-radius: 8px;
            padding: 10px;
        }
        .week-day-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--current-border-color);
        }
        .week-day-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .week-day-section h5 {
            font-weight: 700;
            color: var(--current-primary);
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .week-day-section .task-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 0;
        }
        
        .day-view-timeline {
            position: relative;
        }
        .day-view-hour {
            display: flex;
            border-top: 1px solid var(--current-border-color);
        }
        .day-view-hour-label {
            width: 60px;
            flex-shrink: 0;
            text-align: right;
            padding-right: 10px;
            font-size: calc(var(--base-font-size) * 0.75); 
            color: var(--current-text-medium);
        }
        .day-view-hour-content {
            flex-grow: 1;
            border-left: 1px solid var(--current-border-color);
            padding: 5px;
            min-height: 40px;
            position: relative;
        }
        .add-task-to-time-btn {
            position: absolute;
            right: 5px;
            top: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .day-view-hour-content:hover .add-task-to-time-btn {
            opacity: 1;
        }

        /* Project, Financial & Notepad View Styles */
        #project-management-view, #financial-assistant-view, #notepad-view-container {
            display: flex;
            flex-direction: column; 
            gap: 1rem;
            height: 100%;
            position: relative; 
            flex: 1;
            overflow: hidden;
        }
        
        #project-board-container, #financial-tools-container, #notepad-editor-and-chat-container {
            flex: 1; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0; 
        }
        
        #project-chat-container, #financial-chat-container, #notepad-chat-container {
            display: flex;
            flex-direction: column;
            border-top: 1px solid var(--current-border-color);
            padding-top: 1rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
            background-color: var(--current-bg-medium);
        }
        #project-chat-container.collapsed, #financial-chat-container.collapsed, #notepad-chat-container.collapsed {
            flex-grow: 0;
            flex-basis: auto;
            height: 50px !important;
        }

        #project-chat-container .project-chat-body,
        #financial-chat-container .financial-chat-body,
        #notepad-chat-container .notepad-chat-body {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        #project-chat-container.collapsed .project-chat-body,
        #financial-chat-container.collapsed .financial-chat-body,
        #notepad-chat-container.collapsed .notepad-chat-body {
            display: none;
        }

        #project-chat-toggle i, #financial-chat-toggle i, #notepad-chat-toggle i {
            transition: transform 0.3s ease;
        }
        #project-chat-container:not(.collapsed) #project-chat-toggle i,
        #financial-chat-container:not(.collapsed) #financial-chat-toggle i,
        #notepad-chat-container:not(.collapsed) #notepad-chat-toggle i {
            transform: rotate(180deg);
        }

        #project-chat-messages, #financial-chat-messages, #notepad-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        #kanban-view {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 1rem;
            overflow: hidden; 
            flex-grow: 1;
        }

        .kanban-column {
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-width: 0; /* Allow columns to shrink */
        }
        .kanban-column-title {
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--current-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-cards {
            flex-grow: 1;
            min-height: 100px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .kanban-card {
            background-color: var(--current-bg-medium);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            border-left: 4px solid var(--current-primary);
            position: relative;
        }
        .kanban-card .delete-task-icon {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
            color: var(--current-text-medium);
            background-color: var(--current-bg-light);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: calc(var(--base-font-size) * 0.65); 
            line-height: 18px;
            text-align: center;
            transition: all 0.2s ease;
        }
        .kanban-card .delete-task-icon:hover {
            background-color: var(--danger-color);
            color: white;
            transform: scale(1.1);
        }
        .kanban-card:hover .delete-task-icon {
            display: block;
        }
        .kanban-card.urgent {
            border-left-color: var(--urgent-color);
        }
        .kanban-card:active {
            cursor: grabbing;
            background-color: var(--primary);
        }
        .kanban-card p {
            font-weight: 500;
            padding-right: 20px; /* Space for delete icon */
        }
        .kanban-card .card-footer {
            font-size: calc(var(--base-font-size) * 0.75); 
            color: var(--current-text-medium);
            margin-top: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-cards.drag-over {
            border: 2px dashed var(--current-primary);
            background-color: rgba(138, 79, 255, 0.1);
        }
        
        /* List View Styles */
        #list-view {
            overflow: hidden;
            flex-grow: 1;
            display: flex; 
            flex-direction: column; 
        }
        .list-view-header {
            display: grid;
            grid-template-columns: 1fr 150px 80px 120px 40px;
            gap: 1rem;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid var(--current-border-color);
            font-weight: 700;
            font-size: calc(var(--base-font-size) * 0.75); 
            text-transform: uppercase;
            color: var(--current-text-medium);
            flex-shrink: 0; 
        }
        .list-view-content {
             overflow-y: auto; 
             flex-grow: 1; 
        }
        .list-view-task {
            display: grid;
            grid-template-columns: 1fr 150px 80px 120px 40px;
            gap: 1rem;
            align-items: center;
            padding: 0.25rem 1rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        .list-view-task input[type="date"], .list-view-task input[type="time"] {
                background: transparent;
                border: none;
                border-radius: 4px;
                padding: 2px 4px;
                font-size: calc(var(--base-font-size) * 0.8); 
                width: auto;
                color: var(--current-text-light);
                color-scheme: dark;
        }
        .light-theme .list-view-task input { color-scheme: light; color: var(--light-text-dark); }
        .list-view-task:hover {
            background-color: var(--current-bg-light);
        }
        .list-view-task.task-item-completed .task-content-list {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .task-content-list.urgent {
            font-weight: 600;
            color: var(--urgent-color);
        }
        /* Make text inputs for list view editable in place */
        .task-content-list[contenteditable="true"] { /* Changed from input[type="text"] to contenteditable span */
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
            color: var(--current-text-light); /* Inherit text color */
            min-height: 1.25rem; /* Ensure minimum height for contenteditable */
            display: inline-block; /* Allow proper sizing */
            padding: 0; /* Remove padding here */
        }
        .task-content-list[contenteditable="true"]:focus {
             background-color: var(--current-bg-dark);
             border-radius: 4px;
             padding: 2px 4px; /* Add padding when focused for better editing experience */
        }

        .priority-cell {
            text-align: center;
            cursor: pointer;
        }
        
        .task-labels {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .task-label {
            padding: 2px 8px;
            font-size: calc(var(--base-font-size) * 0.7); 
            border-radius: 12px;
            font-weight: 600;
        }
        #project-tag-filter-container {
            position: relative;
        }
        #tag-filter-dropdown {
            position: absolute;
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Gamification Styles */
        #gamification-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .gamification-tabs { border-bottom: 2px solid var(--current-border-color); }
        .gamification-tab { padding: 0.75rem 1rem; font-weight: 600; color: var(--current-text-medium); cursor: pointer; border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; }
        .gamification-tab.active { color: var(--current-primary); border-color: var(--current-primary); }
        .xp-bar-bg { background-color: var(--current-bg-light); }
        .xp-bar-fill { background-color: var(--current-primary); transition: width 0.5s ease-out; }
        .level-badge { background-color: var(--current-primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: calc(var(--base-font-size) * 0.7); font-weight: bold; }
        .streak-day { background-color: var(--current-bg-light); border: 2px solid var(--current-border-color); transition: all 0.2s ease; }
        .streak-day.active { border-color: var(--current-primary); transform: scale(1.05); box-shadow: 0 0 10px rgba(138, 79, 255, 0.5); }
        .streak-day.completed { background-color: var(--current-primary); color: white; border-color: var(--current-primary); }
        .streak-day .fa-gift { color: var(--gold-color); }
        .mission-item.completed { opacity: 0.5; text-decoration: line-through; }
        .mission-item.completed .btn-primary { background-color: #4CAF50; cursor: default; }
        .achievement-badge { border: 2px solid var(--current-border-color); filter: grayscale(100%); opacity: 0.6; transition: all 0.3s ease; }
        .achievement-badge.unlocked { border-color: var(--gold-color); filter: grayscale(0%); opacity: 1; box-shadow: 0 0 15px var(--gold-color); }
        .achievement-badge.unlocked .fa-medal { color: var(--gold-color); }
        .text-gold { color: var(--gold-color); }

        /* Pricing Modal Enhancements */
        .plan-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .plan-details.open {
            max-height: 500px; /* Adjust as needed */
        }
        .plan-feature-list {
            list-style-position: inside;
        }
        .plan-feature-list li {
            padding-left: 1em;
            text-indent: -1em;
        }
        .plan-feature-list .fa-check-circle {
            color: var(--primary);
        }

        /* NEW Financial Assistant Styles */
        #financial-tools-container {
             padding: 1rem;
             gap: 1rem;
             overflow-y: auto;
        }
        .finance-section {
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
        }
        .finance-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        .finance-section-header h3 {
            font-size: calc(var(--base-font-size) * 1.125); 
            font-weight: 700;
        }
        .finance-category {
            margin-top: 1rem;
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
        }
        .finance-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .finance-category-header .finance-category-name-input {
            background: transparent;
            border: none;
            outline: none;
            font-weight: bold;
            width: 70%;
            color: var(--current-text-light);
        }
        .finance-category-content {
            padding: 0.75rem;
        }
        .finance-item-row {
            display: grid;
            grid-template-columns: 1fr 100px 40px;
            gap: 0.75rem;
            align-items: center;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--current-border-color);
        }
        .finance-item-row:last-child {
            border-bottom: none;
        }
        .finance-item-row input {
            background: transparent;
            border: none;
            padding: 0.25rem;
            width: 100%;
            outline: none;
            color: var(--current-text-light);
        }
        .finance-item-row input:focus {
            background-color: var(--current-bg-dark);
            border-radius: 4px;
        }
        .finance-summary {
            background-color: var(--current-bg-light);
            border-radius: 0.5rem;
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            text-align: center;
        }
        .finance-summary h4 {
            font-size: calc(var(--base-font-size) * 0.8); 
            color: var(--current-text-medium);
        }
        .finance-summary p {
            font-size: calc(var(--base-font-size) * 1.25); 
            font-weight: 700;
        }
        #total-income { color: #22c55e; }
        #total-expenses { color: #ef4444; }

        /* Notepad View */
        #notepad-view-container {
            display: none; /* Hidden by default */
            padding: 0; /* No padding on main container */
        }
        /* Collapsed state for notes list panel */
        #notes-list-panel.collapsed {
            width: 50px; /* Collapsed width */
            padding: 0;
            overflow: hidden;
        }
        #notes-list-panel.collapsed > *:not(#notes-list-toggle, #notes-list-header) {
            display: none;
        }
        /* Remove the toggle button from the Notepad's internal UI, it will always be expanded */
        #notes-list-panel #notes-list-toggle {
            display: none; /* Hide the internal toggle button */
        }
        /* Ensure notes-list-header remains visible when collapsed to show "Nueva Nota/Dibujo" buttons */
        #notes-list-panel.collapsed #notes-list-header {
            display: flex; /* Keep header visible */
            justify-content: center; /* Center buttons */
            flex-direction: column; /* Stack buttons */
            align-items: center;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        #notes-list-panel.collapsed #notes-list-header #add-new-note-btn,
        #notes-list-panel.collapsed #notes-list-header #add-new-drawing-btn {
            width: auto; /* Allow buttons to shrink */
            padding: 0.5rem; /* Adjust padding for smaller buttons */
        }


        #notepad-editor-and-chat-container {
            display: flex;
            flex-direction: row;
            flex-grow: 1;
            gap: 1rem;
            padding: 1rem;
            min-height: 0;
        }
        #notes-list-panel {
            width: 280px;
            flex-shrink: 0;
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            padding: 0.75rem;
            gap: 0.75rem;
            position: relative; /* For toggle button positioning */
            transition: width 0.3s ease, padding 0.3s ease;
        }
        #notes-list-header {
            flex-shrink: 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--current-border-color);
            /* Ensure the header buttons are always visible and formatted correctly */
            display: flex; /* Enable flex for buttons */
            align-items: center; /* Align buttons vertically */
            justify-content: space-between; /* Space out buttons */
            gap: 0.5rem; /* Space between buttons */
        }
        #notes-list {
            flex-grow: 1;
            /* Hidden by default as per new requirements - Only visible when explicitly opened in mobile or if desktop mode forces it */
            display: none; 
            flex-direction: column;
            gap: 0.5rem;
        }
        .note-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background-color: var(--current-bg-medium);
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
            /* Ensure notes in the sidebar are thinner/normal, not bold or oversized */
            font-weight: normal; /* Override bold if accidentally applied */
            font-size: calc(var(--base-font-size) * 0.875); /* Match text-sm */
        }
        .note-item.active { 
            background-color: var(--current-primary); 
            color: white; 
            font-weight: bold;
            border-left-color: var(--gold-color);
        }
        #note-editor-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        #note-editor-toolbar {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--current-border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            background-color: var(--current-bg-medium);
        }
         #note-editor-toolbar button, .drawing-tool {
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.375rem;
            padding: 0.4rem 0.6rem;
            transition: all 0.2s ease;
        }
         #note-editor-toolbar button:hover, .drawing-tool:hover {
            background-color: var(--current-bg-dark);
            border-color: var(--current-primary);
        }
        #note-editor-toolbar button.active {
            background-color: var(--current-primary);
            color: white;
            border-color: var(--current-primary);
        }
        .drawing-tool[type="color"] {
             padding: 0.2rem;
             min-width: 36px;
             height: 36px;
        }
        #note-title-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            outline: none;
            font-size: calc(var(--base-font-size) * 1.1); 
            font-weight: bold;
            padding: 0.5rem 0.75rem; 
            border-bottom: 1px solid var(--current-border-color);
        }
        #note-content-area {
            position: relative;
            flex-grow: 1;
        }
        #note-content-editor {
            flex-grow: 1;
            width: 100%;
            height: 100%;
            background-color: transparent;
            color: var(--current-text-light);
            border: none;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Montserrat', sans-serif;
            font-size: var(--base-font-size); /* Scales with base-font-size */
            resize: none;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap; /* Ensure line breaks are respected */
        }
        #note-content-editor:focus-within {
            box-shadow: none;
        }
        .checklist-item {
            display: flex;
            align-items: flex-start; /* Align items to the top for multi-line text */
            gap: 0.75rem; /* Space between checkbox and text */
            margin: 0.5rem 0;
        }
        .checklist-item input[type="checkbox"] {
            width: 1.15em;
            height: 1.15em;
            accent-color: var(--current-primary);
            cursor: pointer;
            flex-shrink: 0; /* Prevent checkbox from shrinking */
            margin-top: 0.2em; /* Adjust vertical alignment of checkbox */
        }
        .checklist-item-text {
            flex-grow: 1;
            outline: none;
            min-height: 1.15em; /* Ensure text area has minimum height */
            padding-top: 0.2em; /* Align text with checkbox visually */
            padding-bottom: 0.2em;
            word-wrap: break-word; /* Allow text to wrap within the span */
        }
        .checklist-item-text[data-checked="true"] {
            text-decoration: line-through;
            opacity: 0.6;
        }
        #note-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--light-bg-medium); /* Or a translucent background for dark theme */
            cursor: crosshair;
        }
        /* This toggle button is for the notes panel collapse/expand, not needed if always expanded */
        #notes-list-toggle {
            display: none; /* This button is removed as per requirements */
        }


        /* In-app notification */
        #in-app-notification {
            position: fixed;
            top: 50%; /* Center vertically */
            left: 50%; /* Center horizontally */
            transform: translate(-50%, -50%) translateY(-200%); /* Start above and center */
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            padding: 1rem;
            border-radius: 0.75rem;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            border: 1px solid var(--current-border-color);
            max-width: 90%;
            width: 400px;
            opacity: 0;
            pointer-events: none;
            cursor: default; /* Changed to default since it's dismissable by buttons now */
            text-align: center; /* Center content within notification */
        }
        #in-app-notification.show {
            transform: translate(-50%, -50%) translateY(0); /* Move to center */
            opacity: 1;
            pointer-events: auto;
        }
        #in-app-notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        #in-app-notification-header h4 {
            font-weight: bold;
        }
        .glowing-text {
            animation: text-glow 1.5s infinite alternate;
            text-shadow: 0 0 8px rgba(138, 79, 255, 0.7), 0 0 12px rgba(138, 79, 255, 0.5);
        }
        @keyframes text-glow {
            from {
                text-shadow: 0 0 4px rgba(138, 79, 255, 0.5), 0 0 8px rgba(138, 79, 255, 0.3);
            }
            to {
                text-shadow: 0 0 8px rgba(138, 79, 255, 0.7), 0 0 16px rgba(138, 79, 255, 0.5);
            }
        }


        /* Desktop specific styles */
        @media (min-width: 768px) {
            #sidebar-toggle-arrow {
                display: flex;
            }
            #sidebar.collapsed {
                width: 80px; /* Match the content width (logo) */
            }
            #sidebar:not(.collapsed) {
                width: 288px;
            }

            #services-menu {
                opacity: 0;
                visibility: hidden;
                transform: scale(0.95) translateY(-10px);
                transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
            }
            #services-menu.show {
                opacity: 1;
                visibility: visible;
                transform: scale(1) translateY(0);
            }
            #project-management-view, #financial-assistant-view {
                display: flex; 
                flex-direction: row; 
            }
             #notepad-editor-and-chat-container {
                flex-direction: row;
            }
            #notes-list-panel {
                transition: width 0.3s ease, padding 0.3s ease;
            }
            /* The toggle button is now always hidden, and the panel is always expanded. */
            #notes-list-toggle {
                display: none; 
            }
            #notes-list {
                display: flex; /* Always show notes list on desktop when panel is expanded */
            }


            #project-chat-container, #financial-chat-container, #notepad-chat-container {
                display: flex;
                border-left: 1px solid var(--current-border-color);
                border-top: none;
                padding-left: 1rem;
                padding-top: 0;
                height: 100%;
                flex-basis: 40%;
                flex-shrink: 0;
                flex-direction: column;
            }
            #project-chat-container.collapsed, #financial-chat-container.collapsed, #notepad-chat-container.collapsed {
                flex-basis: 50px;
                height: 100% !important;
            }
            #project-chat-container-header, #financial-chat-header, #notepad-chat-header { cursor: pointer; }

            #project-chat-container.collapsed .project-chat-body,
            #project-chat-container.collapsed #project-chat-container-header h3,
            #financial-chat-container.collapsed .financial-chat-body,
            #financial-chat-container.collapsed #financial-chat-header h3,
            #notepad-chat-container.collapsed .notepad-chat-body,
            #notepad-chat-container.collapsed #notepad-chat-header h3 {
                display: none;
            }

            #project-chat-container.collapsed #project-chat-toggle,
            #financial-chat-container.collapsed #financial-chat-toggle,
            #notepad-chat-container.collapsed #notepad-chat-toggle {
                transform: rotate(90deg);
                justify-content: center;
            }
            #project-chat-container.collapsed #project-chat-toggle i,
            #financial-chat-container.collapsed #financial-chat-toggle i,
            #notepad-chat-container.collapsed #notepad-chat-toggle i {
                 transform: rotate(180deg);
            }
        }
        
        /* Mobile specific adjustments */
        @media (max-width: 767px) {
            #mobile-chat-title-wrapper .edit-icon, #mobile-chat-title-wrapper #motivation-btn-mobile {
                display: inline-block;
            }
             #desktop-chat-title-wrapper .edit-icon, #desktop-chat-title-wrapper #motivation-btn-header {
                display: none;
            }
            /* Calendar modal should now always appear centered, not specifically top-left or relative to other elements */
            #calendar-modal {
                padding: 0.5rem;
                max-width: 98vw;
                max-height: 95vh;
                position: fixed; /* Ensures it's positioned relative to the viewport */
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%); /* Centers the modal based on its own dimensions */
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            /* Other modals (generic, pricing, settings, gamification) will have their default behavior (top:20px or top:50%/left:50%) */
            /* In-app notification uses top:50%/left:50% and transform:translate for centering and glowing effect */
            
            #calendar-modal > div:not(:first-child) {
                overflow-y: auto;
            }

            .header-left-icons {
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 0;
            }
             .header-left-icons > * {
                padding: 0.3rem; 
            }
            .header-right-icons {
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 0;
            }
            .header-right-icons > * {
                padding: 0.3rem;
            }
            #desktop-chat-title-wrapper { display: none; }
            #main-header-content {
                display: flex;
                align-items: center;
                justify-content: space-between;
                width: 100%;
                gap: 0.5rem;
            }
            #main-header-content > * {
                flex-basis: 33.33%;
            }
            #main-header-content .header-left-icons { justify-content: flex-start; }
            #main-header-content .header-right-icons { justify-content: flex-end; }
            /* Hide the combined message counter on small screens, individual icons will have popups */
            #main-header-content #message-counter { display: none; } 


            #file-preview-area {
                display: none; /* Only show when there is a file */
             }
             #image-preview-container {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                max-height: 45px;
                flex-shrink: 1;
            }
            #image-preview {
                max-height: 45px;
                width: auto;
                border-radius: 0.25rem;
            }
            #input-area {
                display: flex;
                flex-direction: column;
            }

            /* Mobile chat containers */
            #project-chat-container, #financial-chat-container, #notepad-chat-container {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 50px;
                overflow: hidden;
                border-top: 1px solid var(--current-border-color);
                z-index: 10;
                transition: height 0.3s ease;
                max-height: calc(100vh - 120px); 
            }
            #project-chat-container:not(.collapsed),
            #financial-chat-container:not(.collapsed),
            #notepad-chat-container:not(.collapsed) {
                 height: 100%;
            }
            #project-chat-container .project-chat-body,
            #financial-chat-container .financial-chat-body,
            #notepad-chat-container .notepad-chat-body {
                height: calc(100% - 50px);
                display: flex;
                flex-direction: column;
            }

            #kanban-view {
                grid-template-columns: repeat(3, 1fr);
                overflow-y: auto;
                overflow-x: hidden;
                gap: 0.4rem; 
                padding-bottom: 50px;
            }
            .kanban-column {
                min-width: 0;
                padding: 0.4rem;
            }
            .kanban-column-title { font-size: calc(var(--base-font-size) * 0.7); } 
            .kanban-card { padding: 0.4rem; }
            .kanban-card p { font-weight: normal; font-size: calc(var(--base-font-size) * 0.7); } 

            #list-view-mobile {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                 padding-bottom: 50px;
                 overflow-y: auto;
                 flex-grow: 1;
            }
            .list-view-task-mobile { background-color: var(--current-bg-light); padding: 0.75rem; border-radius: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
            .list-view-task-mobile-header { display: flex; align-items: flex-start; gap: 0.75rem; }
            .list-view-task-mobile-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--current-border-color); padding-top: 0.5rem; font-size: calc(var(--base-font-size) * 0.75); }
            .list-view-task-mobile-footer input[type="time"], .list-view-task-mobile-footer input[type="date"] {
                background: var(--current-bg-dark);
                border: none;
                border-radius: 4px;
                padding: 2px 4px;
                font-size: calc(var(--base-font-size) * 0.7); 
                width: auto;
                color-scheme: dark;
            }
            .light-theme .list-view-task-mobile-footer input[type="time"], .light-theme .list-view-task-mobile-footer input[type="date"] {
                 color-scheme: light;
            }

            /* Notepad Mobile Optimization */
            #notepad-view-container {
                flex-direction: column;
                padding: 0;
                height: 100%;
            }
            #notepad-editor-and-chat-container {
                flex-direction: column;
                padding: 0.5rem;
                height: 100%;
                gap: 0.5rem;
            }
            #notepad-view-container.mobile-editor-active #notes-list-panel {
                display: none;
            }
            #notepad-view-container:not(.mobile-editor-active) #notepad-editor-and-chat-container {
                display: none;
            }
            #notes-list-panel {
                width: 100%;
                height: 100%;
                border-radius: 0;
            }
            #notes-list {
                display: flex; /* Always show notes list on mobile when notes panel is active */
            }
            #note-editor-panel {
                height: 100%;
            }
            #note-back-btn {
                display: inline-block; /* Show back button on mobile */
            }
            #notepad-chat-container {
                position: relative;
                height: 50%; /* Adjust as needed */
                max-height: 50%;
            }

            #services-menu {
                position: fixed;
                opacity: 0;
                visibility: hidden;
                transform: scale(0.95) translateY(-10px);
                transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
                width: 90vw;
                max-width: 320px;
                top: 60px;
                right: 10px;
                max-height: calc(100vh - 80px);
                overflow-y: auto;
                z-index: 50;
            }
            #services-menu.show {
                opacity: 1;
                visibility: visible;
                transform: scale(1) translateY(0);
            }
            
            .calendar-view-toggle button { padding: 6px 4px; font-size: calc(var(--base-font-size) * 0.75); }
            .project-view-controls { width: fit-content; flex-grow: 0; }
            .project-view-controls button { padding: 6px 8px; font-size: calc(var(--base-font-size) * 0.75); flex-grow: 0; }
            
            #gamification-modal .modal-content { padding: 1rem; }
            #gamification-modal h2 { font-size: calc(var(--base-font-size) * 1.25); }
            .streak-day .text-lg { font-size: calc(var(--base-font-size) * 0.8); }
            .streak-day .text-2xl { font-size: calc(var(--base-font-size) * 1.1); }
            .streak-day .text-xs { font-size: calc(var(--base-font-size) * 0.6); }
            .mission-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .mission-item .btn-primary { padding: 0.25rem 0.5rem; font-size: calc(var(--base-font-size) * 0.75); align-self: flex-end; }
            #achievements-container { gap: 0.5rem; }
            .achievement-badge { padding: 0.5rem; font-size: calc(var(--base-font-size) * 0.7); }
            .achievement-badge .fa-3x { font-size: calc(var(--base-font-size) * 1.75); }

            /* Mobile chat item icons always visible */
            .chat-item .chat-item-actions {
                opacity: 1 !important;
            }
            #notes-list-panel.collapsed #notes-list-toggle { /* Hide notepad toggle on mobile, regardless of state */
                display: none;
            }
        }
        
        /* Mobile Landscape */
        @media (max-height: 500px) and (orientation: landscape) {
            #sidebar.is-open #sidebar-scrollable-content {
                 overflow-y: auto;
                 height: 100%;
            }
            #main-chat-area, #project-management-view, #financial-assistant-view, #notepad-view-container {
                overflow-y: auto;
            }
            #chat-messages {
                padding: 0.5rem;
                flex-grow: 1;
            }
            #kanban-view {
                grid-template-columns: repeat(3, minmax(250px, 1fr));
                overflow-x: auto;
            }
            .modal-content { max-height: 95vh; overflow-y: auto; }
            #input-area { padding: 0.5rem; flex-shrink: 0; }
            .pro-controls-bg { padding: 0.25rem; }
            #msg { height: 3rem !important; max-height: 3rem; }
        }

        /* Motivation Modal Shimmer Effect */
        #motivation-quote.shimmer-text {
            position: relative;
            overflow: hidden;
        }
        #motivation-quote.shimmer-text::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            animation: shimmer 2.5s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes shimmer {
            0% { transform: translateX(-150%) skewX(-15deg); }
            100% { transform: translateX(250%) skewX(-15deg); }
        }

    </style>
</head>
<body class="w-screen overflow-x-hidden dark-theme">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script type="text/javascript">
        if (window.netlifyIdentity) {
            netlifyIdentity.init();
        }
    </script>
    <div id="loading-overlay" class="fixed inset-0 bg-bg-dark bg-opacity-95 flex flex-col items-center justify-center z-[100] transition-opacity duration-300">
        <img src="./Logos HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mb-6 animate-pulse" onerror="this.onerror=null;this.src='https://placehold.co/96x96/121212/e0e0e0?text=LOGO';">
        <div class="text-text-light text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3 text-lg font-semibold" data-translate-key="initializing">Inicializando...</p>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden opacity-0 pointer-events-none"></div>

    <div id="app-container" class="flex w-full relative opacity-0 transition-opacity duration-300">
        <aside id="sidebar" class="w-72 flex-shrink-0 flex flex-col transition-transform duration-300 md:translate-x-0 h-full">
            
            <div id="sidebar-header" class="relative">
                <div id="logo-space" class="w-16 h-16 rounded-lg mx-auto flex-shrink-0 flex items-center justify-center overflow-hidden cursor-pointer">
                    <img src="./Logos HD.png" alt="Goatify Logo" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/64x64/2c2c2c/e0e0e0?text=LOGO';">
                </div>
                 <div id="sidebar-toggle-arrow" class="absolute top-3 right-3 md:block"> <i class="fas fa-chevron-left"></i> </div>
            </div>

            <div class="flex-shrink-0 px-4 pt-2 pb-4 border-b border-themed">
                 <div class="mb-4">
                    <h3 class="text-xs font-semibold uppercase text-text-medium mb-2 px-2" data-translate-key="workflows">Workflows</h3>
                    <div id="sidebar-top-actions" class="space-y-2">
                        <button data-workflow="project-management" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                            <i class="fas fa-tasks w-6 mr-2"></i>
                           <span class="text-sm font-bold" data-translate-key="wf_pm_title">Asistente de Proyectos</span>
                       </button>
                       <button data-workflow="financial-assistant" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                            <i class="fas fa-wallet w-6 mr-2"></i>
                           <span class="text-sm font-bold" data-translate-key="wf_fa_title">Asistente Financiero</span>
                       </button>
                        <button data-workflow="notepad-app" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                            <i class="fas fa-book-open w-6 mr-2"></i>
                           <span class="text-sm font-bold" data-translate-key="wf_na_title">Bloc de Notas</span>
                       </button>
                   </div>
                </div>
            </div>

            <div id="sidebar-scrollable-content">
                <div id="sidebar-content-main" class="flex flex-col">
                    <div class="flex-grow">
                        <div class="mb-4">
                             <div id="workflows-container" class="space-y-1">
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-brain w-6 mr-2"></i>
                                        <span class="text-sm font-bold" data-translate-key="wf_expert">Asistente Experto</span>
                                    </div>
                                     <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="decision-lab" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_expert_1">Laboratorio de Decisiones</button>
                                        <button data-workflow="conflict-resolution" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_expert_2">Resolucin de Conflictos</button>
                                     </div>
                                </div>
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-share-alt w-6 mr-2"></i>
                                        <span class="text-sm font-bold" data-translate-key="wf_social">Potenciador de Redes Sociales</span>
                                     </div>
                                    <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="create-full-post" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_1">Crear un Post Completo</button>
                                         <button data-workflow="persuasive-copy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_2">Redaccin de Copys</button>
                                        <button data-workflow="post-ideas" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_3">Lluvia de Ideas para Posts</button>
                                         <button data-workflow="brand-strategy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_4">Definir Estrategia de Marca</button>
                                    </div>
                                </div>
                                 <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-chart-pie w-6 mr-2"></i>
                                        <span class="text-sm font-bold" data-translate-key="wf_business">Anlisis de Negocio</span>
                                    </div>
                                     <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="competitor-analysis" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_1">Anlisis de tu Competencia</button>
                                         <button data-workflow="buyer-persona" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_2">Definir mi Cliente Ideal</button>
                                        <button data-workflow="brand-names" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_3">Lluvia de Nombres para Marca</button>
                                     </div>
                                </div>
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-headset w-6 mr-2"></i>
                                        <span class="text-sm font-bold" data-translate-key="wf_sales_category">Comunicacin y Ventas</span>
                                     </div>
                                    <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="sales-assistant" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_1">Ventas para tu Negocio</button> <button data-workflow="email-writing" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_2">Redaccin de Email</button>
                                        <button data-workflow="design-web" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_3">Diseo Web</button>
                                         <button data-workflow="social-skills" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_4">Mejorar Habilidades Sociales</button>
                                    </div>
                                 </div>
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-language w-6 mr-2"></i>
                                        <span class="text-sm font-bold" data-translate-key="wf_eng_category">English Teacher</span>
                                    </div>
                                       <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="english-teacher-translate" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_1">Traducir/Corregir Texto</button>
                                         <button data-workflow="english-teacher-vocabulary" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_2">Aprender Vocabulario Nuevo</button>
                                        <button data-workflow="english-teacher-practice" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_3">Practicar Conversacin</button>
                                     </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="actions-category border-t border-themed pt-4">
                            <div class="actions-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                <i class="fas fa-chevron-right actions-arrow mr-2 transition-transform text-xs"></i>
                                <span class="text-sm font-bold" data-translate-key="quick_actions">Acciones Rpidas</span>
                            </div>
                            <div class="actions-content pl-4 pt-2 space-y-2">
                                <button id="new-chat-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors w-full"><i class="fas fa-plus mr-2"></i><span data-translate-key="new_chat">Nuevo Chat</span></button>
                            </div>
                        </div>

                        <div class="folders-category border-t border-themed pt-4 default-open"> <div class="folder-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                <i class="fas fa-chevron-right folder-arrow mr-2 transition-transform text-xs"></i>
                                <i class="fas fa-folder-open mr-2 text-yellow-500"></i>
                                <span class="text-sm font-bold" data-translate-key="my_folders">Mis Carpetas</span>
                            </div>
                            <div class="folders-content pl-4 pt-1 space-y-1">
                                <button id="new-folder-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg bg-input w-full"><i class="fas fa-folder-plus mr-2"></i><span data-translate-key="new_folder">Nueva Carpeta</span></button>
                                <div id="folders-list" class="space-y-1"></div>
                            </div>
                        </div>

    
                        <div class="border-t border-themed pt-2 mt-4">
                             <button id="select-chats-btn" class="w-full text-sm p-2 rounded hover:bg-light flex items-center justify-center">
                                <i class="fas fa-tasks mr-2"></i><span data-translate-key="select_chats">Seleccionar Mltiples Chats</span>
                            </button>
                         </div>
                        <div id="delete-mode-controls" class="hidden flex space-x-2 my-2">
                            <button id="delete-selected-btn" class="flex-1 flex items-center justify-center font-semibold p-2 rounded-lg bg-red-600 text-white disabled:opacity-50" disabled><i class="fas fa-trash-alt mr-2"></i><span data-translate-key="delete">Borrar</span></button>
                             <button id="cancel-select-mode-btn" class="p-2 rounded-lg bg-gray-600 text-white"><i class="fas fa-times"></i></button>
                        </div>
                        <div id="sidebar-content" class="pr-1 space-y-1"></div>
                    </div>
                </div>

                <div id="sidebar-footer">
                    <div class="flex flex-col space-y-2 border-t border-themed pt-4">
                        <button id="web-launch-offer-btn" class="w-full text-left font-semibold text-sm p-3 rounded-lg btn-primary transition-colors animate-pulse" data-translate-key="web_offer">
                            Lanza tu Negocio, te regalamos una pg web Gratis con tu suscripcion!
                        </button>
                        <div id="upgrade-plan-container" class="hidden text-center p-2 bg-yellow-400 rounded-lg">
                            <button id="upgrade-plan-btn" class="text-xs font-semibold text-black hover:text-gray-800">
                                <i class="fas fa-rocket mr-1"></i>
                               <span data-translate-key="upgrade_plan">Mejorar Plan</span>
                            </button>
                        </div>
                        <div class="text-center p-2 bg-input rounded-lg">
                            <a href="#" id="free-guides-link" class="text-xs font-semibold text-primary hover:underline">
                                <i class="fas fa-book-open mr-1"></i>
                               <span data-translate-key="free_guides">Guas de IA Gratis</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sidebar-bottom-fixed">
                 <div id="user-section">
                    <div id="login-view" class="hidden">
                        <button id="login-btn" class="w-full flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-sign-in-alt mr-2"></i><span data-translate-key="login">Iniciar Sesin</span></button>
                    </div>
                     <div id="user-menu-view" class="hidden relative">
                        <button id="user-menu-btn" class="w-full flex items-center text-left p-2 rounded-lg hover:bg-light transition-colors">
                            <span id="user-email" class="flex-grow truncate text-sm font-semibold"></span>
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <div id="user-menu-popup" class="absolute bottom-full left-0 w-full mb-2 rounded-lg p-2 border border-themed shadow-lg hidden">
                            <button id="settings-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-cog w-6 mr-2"></i><span data-translate-key="settings">Configuracin</span></button>
                             <button id="logout-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-sign-out-alt w-6 mr-2"></i><span data-translate-key="logout">Cerrar Sesin</span></button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <main id="main-chat-area" class="flex-1 flex flex-col h-full overflow-hidden">
            <header class="flex items-center justify-between p-3 md:p-4 border-b border-themed flex-shrink-0 relative">
                <div id="main-header-content" class="flex items-center justify-between w-full">
                    <div class="flex items-center flex-shrink-0 header-left-icons">
                        <button id="menu-toggle" class="md:hidden text-xl p-2"><i class="fas fa-bars"></i></button>
                        <button id="new-chat-icon-btn" title="Nuevo Chat" class="text-xl p-2 hover:opacity-80 transition-opacity"><i class="fas fa-plus-circle text-primary"></i></button>
                        <button id="new-folder-icon-btn" title="Nueva Carpeta" class="text-xl p-2 hover:opacity-80 transition-opacity"><i class="fas fa-folder-plus text-primary"></i></button>
                        <button id="calendar-btn" title="Mi Calendario y Tareas" class="text-sky-400 hover:text-sky-300 p-2 transition-colors notification-bell-icon">
                            <i class="fas fa-calendar-days text-xl"></i>
                            <span id="notification-badge" class="notification-badge hidden">0</span>
                        </button>
                    </div>
                    
                    <div id="desktop-chat-title-wrapper" class="hidden sm:flex items-center justify-center group cursor-pointer mx-2 flex-1 min-w-0" title="Renombrar Chat">
                        <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                        <h1 id="chat-title" class="text-lg font-semibold truncate">Goatify IA</h1>
                        <button id="motivation-btn-header" title="Motivacin Diaria" class="text-yellow-400 hover:text-yellow-300 p-2 transition-colors ml-2"><i class="fas fa-lightbulb text-xl"></i></button>
                    </div>

                    <div class="flex items-center space-x-1 sm:space-x-2 header-right-icons">
                        <button id="plan-credits-btn" title="Crditos del Plan" class="text-xs px-1 py-1 hover:opacity-80 transition-opacity flex items-center space-x-0.5"> <i class="fas fa-trophy text-base" style="color: var(--primary);"></i> <span id="plan-credits-display" class="font-bold text-xs text-black dark:text-white">0/0</span> </button>
                        <button id="gamification-btn" title="Crditos de Recompensa / Mi Ascensin" class="text-xs px-1 py-1 hover:opacity-80 transition-opacity flex items-center space-x-0.5"> <i class="fas fa-coins text-base"></i> <span id="reward-credits-display" class="font-bold text-xs text-black dark:text-white">0</span> </button>
                        <div id="message-counter" class="text-xs font-mono whitespace-nowrap block mx-2 md:block hidden">
                            </div>
                        <button id="services-menu-btn" title="Potenciar mi Negocio" class="relative text-xl p-2 hover:opacity-80 transition-opacity flex items-center gap-2">
                            <i class="fas fa-rocket text-primary"></i>
                            <span class="text-sm font-semibold text-primary hidden md:inline" data-translate-key="solutions">Soluciones</span>
                        </button>
                        <button id="theme-toggle" title="Cambiar Tema" class="text-xl p-2"><i class="fas fa-moon" id="theme-icon"></i></button>
                    </div>
                </div>
                 <div id="services-menu" class="absolute top-full right-4 mt-2 w-80 rounded-xl shadow-lg border border-themed z-30 p-4 origin-top-right">
                    <h4 class="font-bold text-lg mb-1 text-text-light" data-translate-key="ally_title">Somos tu Aliado Estratgico</h4>
                    <p class="text-sm text-text-medium mb-4" data-translate-key="ally_desc">Goatify no es solo un chat. Somos una IA personalizada con un equipo de expertos listos para ayudarte a escalar tu negocio.</p>
                    <ul class="space-y-3">
                        <li><a id="sol-web" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Pginas Web que Convierten</p><p class="text-sm text-text-medium">Transformamos tus ideas en webs y tiendas online diseadas para vender.</p></a></li>
                         <li><a id="sol-auto" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Ventas en Piloto Automtico</p><p class="text-sm text-text-medium">Implementamos sistemas de IA para automatizar tus ventas y procesos clave.</p></a></li>
                        <li><a id="sol-social" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Avatares para Redes Sociales</p><p class="text-sm text-text-medium">Creamos avatares hiperrealistas con IA y estrategias de contenido que captan la atencin.</p></a></li>
                         <li><a id="sol-consult" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Escala tu Empresa con IA</p><p class="text-sm text-text-medium">Obtn consultora experta para integrar la IA en el ADN de tu negocio.</p></a></li>
                    </ul>
                </div>
            </header>
            <div class="block sm:hidden text-center py-1.5 border-b border-themed bg-current-bg-dark shadow-sm flex-shrink-0">
                <div id="mobile-chat-title-wrapper" class="flex items-center justify-center group cursor-pointer px-4 relative" title="Renombrar Chat">
                    <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                    <h2 id="mobile-chat-title" class="text-sm font-semibold truncate">Goatify IA</h2>
                    <button id="motivation-btn-mobile" title="Motivacin Diaria" class="text-yellow-400 hover:text-yellow-300 p-2 transition-colors"><i class="fas fa-lightbulb text-lg"></i></button>
                </div>
             </div>
            
            <div id="view-container" class="flex-1 overflow-hidden relative">
                <div id="chat-messages" class="h-full overflow-y-auto p-3 sm:p-6">
                    <div class="flex justify-center items-center h-full" id="initial-message-container">
                        <div id="welcome-message-wrapper" class="text-center text-text-medium">
                            <img src="./Logos HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                            <h2 class="text-3xl font-bold text-text-light">Goatify IA</h2>
                            <div id="personalized-welcome" class="hidden"><p class="text-lg mt-1"><span data-translate-key="welcome_user">Hola, </span><span id="user-name"></span><span data-translate-key="welcome_user_2">! Hoy es un gran da para crear algo increble.</span></p></div>
                            <div id="generic-welcome" class="hidden"><p class="text-xl" data-translate-key="welcome_guest">Cmo puedo ayudarte hoy?</p></div>
                        </div>
                    </div>
                </div>

                <div id="notepad-view-container" class="hidden">
                    <div id="notes-list-panel">
                        <div id="notes-list-header" class="flex items-center gap-2">
                            <button id="add-new-note-btn" class="flex-1 text-sm p-2 rounded-md bg-input hover:bg-current-bg-dark flex items-center justify-center gap-2"><i class="fas fa-file-alt"></i><span data-translate-key="new_note_btn">Nueva Nota</span></button> 
                            <button id="add-new-drawing-btn" class="p-2 bg-input rounded-md hover:bg-current-bg-dark" title="Nuevo Dibujo" data-translate-key="new_drawing_title"><i class="fas fa-paint-brush"></i></button> 
                        </div>
                        </div>
                    <div id="notepad-editor-and-chat-container">
                        <div id="note-editor-panel">
                             <div id="note-editor-toolbar">
                                <button id="note-back-btn" title="Volver a la lista" class="p-2 hidden mr-2"><i class="fas fa-arrow-left"></i></button>
                                <input id="note-title-input" type="text" placeholder="Ttulo de la nota...">
                                <div id="text-tools" class="flex items-center gap-2 ml-auto">
                                    <button id="add-checklist-item-btn" title="Aadir Checklist" class="p-2"><i class="fas fa-check-square"></i></button>
                                </div>
                                <div id="drawing-tools" class="hidden items-center gap-2">
                                    <button id="tool-pencil" class="drawing-tool active" title="Lpiz"><i class="fas fa-pencil-alt"></i></button>
                                    <button id="tool-eraser" class="drawing-tool" title="Borrador"><i class="fas fa-eraser"></i></button>
                                    <input type="color" id="drawing-color" class="drawing-tool" title="Color" value="#000000"> <input type="range" id="drawing-line-width" class="drawing-tool" min="1" max="50" value="3" title="Grosor">
                                    <button id="clear-canvas-btn" class="drawing-tool" title="Limpiar todo"><i class="fas fa-trash-alt"></i></button>
                                </div>
                                <button id="share-note-btn" title="Compartir / Colaborar" class="p-2 ml-2"><i class="fas fa-user-plus"></i></button>
                                <button id="delete-note-btn" title="Eliminar Nota" class="p-2 text-red-500 hover:text-red-400 transition-colors"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <div id="note-content-area" class="relative flex-grow">
                                <div id="note-content-editor" contenteditable="true" class="h-full"></div>
                                <canvas id="note-canvas" class="absolute top-0 left-0 hidden"></canvas>
                            </div>
                        </div>
                        <div id="notepad-chat-container" class="hidden md:flex">
                            <div id="notepad-chat-header" class="flex justify-between items-center cursor-pointer p-2">
                                <h3 class="text-lg font-semibold text-primary">Asistente de Redaccin</h3>
                                <button id="notepad-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-up"></i></button>
                            </div>
                            <div class="notepad-chat-body">
                                <div id="notepad-chat-messages" class="chat-bubble-bot"></div>
                                <div class="mt-auto pt-2">
                                    <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                                        <div class="flex items-center space-x-2">
                                           <label for="notepad-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1">Modelo:</label>
                                            <div class="model-selector-wrapper">
                                               <select id="notepad-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                                    <option value="gpt-3.5-turbo-1106">GOAT X</option> <option value="sonar">Bsqueda Web</option>
                                                    <option value="gpt-4o" class="goat-x-pro-model">GOAT X PRO</option>
                                                </select>
                                                 <i class="fas fa-chevron-down text-xs"></i>
                                           </div>
                                        </div>
                                   </div>
                                    <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                        <textarea id="notepad-msg" placeholder="Pide ideas, resmenes, etc..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm"></textarea>
                                        <button id="notepad-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="financial-assistant-view" class="hidden h-full"></div>
                
                <div id="project-management-view" class="hidden p-4 h-full">
                    <div id="project-board-container" class="flex flex-col h-full">
                        <div class="flex flex-wrap justify-between items-center mb-4 flex-shrink-0 gap-2">
                            <h2 id="project-view-title" class="text-2xl font-bold">Nombre del Proyecto</h2>
                             <div id="project-tag-filter-container" class="relative">
                                <button id="tag-filter-btn" class="p-2 rounded-md bg-input text-sm"><i class="fas fa-tag mr-1"></i> Filtrar</button>
                                <div id="tag-filter-dropdown" class="hidden absolute right-0 mt-1 p-2 rounded-md shadow-lg w-48"></div>
                             </div>
                        </div>
                         <div class="flex items-center space-x-2 project-view-controls mb-4 flex-shrink-0">
                            <span class="text-sm text-text-medium hidden sm:inline">Vistas:</span>
                             <button id="view-toggle-kanban" class="px-3 py-1 text-sm rounded-md">Kanban</button>
                            <button id="view-toggle-list" class="px-3 py-1 text-sm rounded-md">Lista</button>
                            <button id="add-task-list-view-btn" title="Aadir Tarea" class="hidden ml-auto p-2 rounded-md bg-primary text-white"><i class="fas fa-plus"></i></button>
                            <button id="project-calendar-btn" title="Calendario del Proyecto" class="text-sky-400 hover:text-sky-300 p-2 transition-colors ml-auto"><i class="fas fa-calendar-alt text-xl"></i></button>
                        </div>
                         <div id="kanban-view" class="hidden flex-1">
                            </div>
                        <div id="list-view" class="hidden flex-1 flex-col">
                        </div>
                        <div id="list-view-mobile" class="hidden flex-1 overflow-y-auto">
                        </div>
                    </div>
                    <div id="project-chat-container">
                         <div id="project-chat-container-header" class="flex justify-between items-center cursor-pointer p-2">
                            <h3 class="text-lg font-semibold text-primary">Asistente del Proyecto</h3>
                            <button id="project-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-up"></i></button>
                        </div>
                         <div class="project-chat-body">
                            <div id="project-chat-messages" class="chat-bubble-bot"></div>
                            <div id="project-input-area" class="mt-auto pt-2">
                                 <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                                     <div class="flex items-center space-x-2">
                                        <label for="project-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1">Modelo:</label>
                                         <div class="model-selector-wrapper">
                                            <select id="project-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                                <option value="gpt-3.5-turbo-1106">GOAT X</option> <option value="sonar">Bsqueda Web</option>
                                                <option value="gpt-4o" class="goat-x-pro-model">GOAT X PRO</option>
                                             </select>
                                              <i class="fas fa-chevron-down text-xs"></i>
                                        </div>
                                     </div>
                                </div>
                                 <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                     <textarea id="project-msg" placeholder="Deja que Goatify organice tu proyecto..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm"></textarea>
                                    <button id="project-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="input-area" class="p-2 sm:p-4 border-t border-themed flex-shrink-0">
                <div id="file-preview-area" class="mb-2 space-y-2 px-1 sm:px-0">
                     <div id="image-preview-container" class="hidden relative">
                        <img id="image-preview" src="#" alt="Image Preview">
                        <span id="image-name" class="text-xs text-text-medium truncate flex-grow"></span>
                         <button id="clear-image-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                    <div id="pdf-preview-container" class="hidden relative">
                        <i class="fas fa-file-pdf text-red-500 text-xl"></i>
                         <div class="flex-grow min-w-0">
                            <p id="pdf-name" class="font-medium truncate"></p>
                            <p id="pdf-status" class="text-xxs font-mono"></p>
                         </div>
                        <button id="clear-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                </div>
                <div class="pro-controls-bg rounded-lg p-1 cool-light-effect">
                    <div id="pro-controls-left">
                        <label for="model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1" data-translate-key="model">Modelo:</label>
                        <div class="model-selector-wrapper">
                            <select id="model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                <option value="gpt-3.5-turbo-1106" data-translate-key="model_general">GOAT X</option> <option value="sonar" data-translate-key="model_web">Bsqueda Web</option>
                                <option value="gpt-4o" class="goat-x-pro-model">GOAT X PRO</option>
                            </select>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                    <div id="pro-controls-right">
                        <div id="voice-selector-container" class="hidden items-center space-x-2">
                            <label for="voice-selector" class="font-medium text-xs text-text-medium" data-translate-key="voice">Voz:</label>
                            <div class="model-selector-wrapper">
                                <select id="voice-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light w-24"></select>
                            </div>
                        </div>
                        <div id="action-buttons-container" class="flex items-center">
                            <button id="image-gen-btn" title="Crear Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fas fa-paint-brush text-lg"></i></button>
                            <button id="pdf-upload-btn" title="Subir PDF" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-file-pdf text-lg"></i></button>
                            <button id="image-upload-btn" title="Subir Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-image text-lg"></i></button>
                        </div>
                    </div>
                 </div>
                <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                    <input type="file" id="pdf-upload" accept=".pdf,application/pdf" class="hidden"><input type="file" id="image-upload" accept="image/*" class="hidden">
                    <button id="mic-btn" title="Activar Micrfono" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-microphone text-xl"></i></button>
                     <button id="tts-toggle" title="Activar/Desactivar Voz" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-volume-mute text-xl"></i></button>
                    <textarea id="msg" placeholder="Escribe tu mensaje..." class="flex-1 bg-transparent p-2 h-12 max-h-32 resize-none outline-none placeholder-themed" rows="1" data-translate-key="placeholder_main"></textarea>
                    <button id="send" title="Enviar" class="p-2 sm:p-4 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i id="send-icon" class="fa fa-paper-plane text-xl"></i></button>
                 </div>
                <div id="contextual-footer" class="text-center text-xs text-text-medium mt-2 px-2 h-4"></div>
            </div>
        </main>
    </div>

    <div id="in-app-notification">
        <div id="in-app-notification-header">
            <h4 id="in-app-notification-title"></h4>
            <button id="in-app-notification-close" class="text-text-medium hover:text-text-light text-2xl leading-none">&times;</button>
        </div>
        <p id="in-app-notification-body"></p>
        <div id="in-app-notification-buttons" class="mt-4 flex justify-center space-x-2">
            <button id="notification-done-btn" class="btn-primary px-4 py-2 rounded-lg">Listo</button>
            <button id="notification-snooze-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg">Aplazar</button>
        </div>
    </div>

    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <div id="modal-body" class="mb-4 text-text-medium text-sm"></div>
            <div id="modal-buttons-container" class="flex justify-end space-x-2">
                 </div>
        </div>
    </div>

    <div id="motivation-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative text-center">
            <i class="fas fa-lightbulb text-4xl text-yellow-400 mb-4"></i>
            <h3 id="motivation-title" class="text-2xl mb-4">Dosis de Motivacin</h3>
            <p id="motivation-quote" class="text-lg text-text-light mb-6 min-h-[50px]"></p>
            <div class="flex items-center justify-center mb-6">
                <label for="motivation-toggle" class="flex items-center cursor-pointer">
                    <span class="mr-3 text-text-light font-medium">
                        Notificaciones peridicas
                    </span>
                    <div class="relative">
                        <input type="checkbox" id="motivation-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                    </div>
                </label>
            </div>
            <button id="close-motivation-modal" class="btn-primary px-6 py-2 rounded-lg">Entendido!</button>
        </div>
    </div>
    
    <div id="pricing-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-5xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-6">
                <h2 class="text-3xl md:text-4xl font-extrabold text-center flex-grow" data-translate-key="plans_title">Planes Goatify</h2>
                 <button id="close-pricing-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="modal-content-body flex-grow overflow-y-auto px-2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-text-light">
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">Free</h3>
                        <p class="text-5xl font-extrabold my-3">$0</p>
                        <p class="text-sm text-text-medium mb-4" data-translate-key="plan_free_sub">Para Siempre</p>
                         <ul class="text-sm space-y-2 mb-4 text-left">
                            <li><i class="fas fa-check-circle mr-2"></i>50 Crditos/mes</li>
                            <li><i class="fas fa-check-circle mr-2"></i>Acceso a Modelos Bsicos</li>
                             <li><i class="fas fa-check-circle mr-2"></i>Workflows Limitados</li>
                        </ul>
                        <button id="free-plan-button" class="mt-auto w-full p-3 rounded-lg font-semibold border-2 border-primary text-primary hover:bg-primary hover:text-white transition-colors" data-translate-key="plan_free_cta">Tu Plan Actual</button>
                     </div>
                    <div class="plan-card border-2 rounded-xl p-6 flex flex-col bg-current-bg-dark plan-card-highlight">
                        <h3 class="text-2xl font-bold">GOAT <span class="text-primary">BOOST</span></h3>
                         <p class="text-5xl font-extrabold my-3">$7<span class="text-lg font-medium text-text-medium">/mes</span></p>
                        <button class="w-full p-2 text-sm rounded-lg font-semibold border border-primary text-primary hover:bg-primary hover:text-white transition-colors mb-4 plan-details-toggle">Ver Detalles</button>
                        <div class="plan-details text-sm text-left">
                             <ul class="space-y-2 mb-4 plan-feature-list">
                                <li><i class="fas fa-check-circle mr-2"></i><strong>500 Crditos/mes</strong></li>
                                <li><i class="fas fa-check-circle mr-2"></i>Acceso a <strong>todos los modelos de IA</strong></li>
                                 <li><i class="fas fa-check-circle mr-2"></i>Acceso a <strong>todos los Workflows</strong></li>
                                <li><i class="fas fa-check-circle mr-2"></i>Soporte Prioritario</li>
                            </ul>
                         </div>
                        <button data-plan="boost" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_boost_cta">Obtener Boost</button>
                    </div>
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">GOAT <span class="text-primary">PRO</span></h3>
                        <p class="text-5xl font-extrabold my-3">$17<span class="text-lg font-medium text-text-medium">/mes</span></p>
                         <button class="w-full p-2 text-sm rounded-lg font-semibold border border-primary text-primary hover:bg-primary hover:text-white transition-colors mb-4 plan-details-toggle">Ver Detalles</button>
                        <div class="plan-details text-sm text-left">
                            <ul class="space-y-2 mb-4 plan-feature-list">
                                 <li><i class="fas fa-check-circle mr-2"></i><strong>2000 Crditos/mes</strong></li>
                                <li><i class="fas fa-check-circle mr-2"></i>Todo lo del plan BOOST</li>
                                <li><i class="fas fa-check-circle mr-2 text-gold"></i><strong>Te construimos tu Pgina Web!</strong></li>
                                 <li><i class="fas fa-check-circle mr-2"></i>Consultora de IA</li>
                                <li><i class="fas fa-check-circle mr-2"></i>Acceso a Guas Premium</li>
                            </ul>
                         </div>
                        <button data-plan="pro" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_pro_cta">Quiero mi Plan Pro + Web</button>
                    </div>
                </div>
             </div>
        </div>
    </div>

    <div id="html-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full h-full max-w-4xl p-2 md:p-4 relative flex flex-col">
            <h3 class="text-lg font-bold" data-translate-key="preview">Vista Previa</h3>
            <button id="close-html-preview-modal" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            <iframe id="html-preview-iframe" class="w-full flex-grow h-full border-2 border-themed rounded-lg bg-white"></iframe>
        </div>
    </div>
    
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-lg p-6 relative">
             <h3 class="text-lg font-bold mb-4" data-translate-key="settings">Configuracin</h3>
            <div class="space-y-4 text-sm max-h-[70vh] overflow-y-auto pr-2">
                <div>
                    <p class="font-semibold" data-translate-key="settings_email">Correo Electrnico:</p>
                    <p id="settings-user-email" class="text-text-medium"></p>
                 </div>
                <div>
                    <p class="font-semibold" data-translate-key="settings_plan">Plan de Suscripcin:</p>
                    <p id="settings-user-plan" class="text-text-medium"></p>
                    <button id="settings-upgrade-plan-btn" class="text-primary hover:underline mt-1 text-xs" data-translate-key="upgrade_plan">Mejorar Plan</button>
                 </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_fontsize">Tamao de Letra:</p>
                    <input type="range" id="font-size-slider" min="12" max="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg dark:bg-gray-700">
                    <span id="font-size-value" class="text-xs text-text-medium">16px</span>
                </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_theme">Personalizacin:</p>
                    <button id="settings-theme-toggle" class="flex items-center p-2 rounded hover:bg-medium w-full text-left">
                         <i class="fas fa-moon mr-2" id="settings-theme-icon"></i>
                        <span data-translate-key="settings_dark_mode">Modo Oscuro</span>
                    </button>
                </div>
                <div>
                     <div class="flex items-center justify-between">
                        <p class="font-semibold" data-translate-key="settings_notifications">Notificaciones de Tareas:</p>
                        <label for="notifications-toggle" class="inline-flex relative items-center cursor-pointer">
                            <input type="checkbox" id="notifications-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                 </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_lang">Idioma:</p>
                    <select id="language-selector" class="w-full p-2 rounded bg-input border border-themed">
                         <option value="es">Espaol</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="border-t border-themed pt-4 mt-4">
                     <h4 class="font-semibold mb-2" data-translate-key="settings_integrations">Integraciones</h4>
                     <div class="space-y-2">
                        <button id="connect-google-calendar-btn" class="w-full bg-input p-2 rounded-lg flex items-center justify-start text-left hover:bg-light transition-colors">
                             <i class="fab fa-google mr-3 text-red-500 fa-lg"></i>
                            <div>
                                <span class="font-semibold">Google Calendar</span>
                                 <p class="text-xs text-text-medium">Sincroniza tus tareas y eventos.</p>
                            </div>
                        </button>
                        </div>
                </div>
                <div>
                    <button id="connect-whatsapp-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center mb-2">
                         <i class="fab fa-whatsapp mr-2"></i><span data-translate-key="settings_whatsapp">Conectarse a WhatsApp</span>
                    </button>
                    <a href="https://calendly.com/goatify" target="_blank" id="schedule-meeting-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar-alt mr-2"></i><span data-translate-key="settings_schedule_meeting">Agendar Reunin</span>
                     </a>
                </div>
            </div>
            <button id="close-settings-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>

    <div id="calendar-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div id="calendar-modal" class="modal-content rounded-lg w-full max-w-4xl p-6 relative">
             <h3 class="text-lg font-bold mb-4" data-translate-key="calendar_my_calendar">Mi Calendario y Tareas</h3>
            <div class="calendar-view-toggle mb-4">
                <button id="day-view-btn" data-translate-key="calendar_day_view">Vista de Da</button>
                <button id="week-view-btn" data-translate-key="calendar_week_view">Vista de Semana</button>
                <button id="month-view-btn" class="active" data-translate-key="calendar_month_view">Vista de Mes</button>
             </div>

            <div id="day-view-container">
                 <div class="calendar-header">
                    <button id="prev-day" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-day-display" class="text-xl font-semibold"></h4>
                     <button id="next-day" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="day-view-timeline"></div>
            </div>

            <div id="week-view-container">
                <div class="calendar-header">
                     <button id="prev-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-week-range" class="text-xl font-semibold"></h4>
                    <button id="next-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                 <div id="week-days-content"></div>
            </div>

            <div id="month-view-container">
                <div class="calendar-header">
                    <button id="prev-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-month-year" class="text-xl font-semibold"></h4>
                     <button id="next-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid mb-4">
                    <div class="font-bold text-primary" data-translate-key="calendar_mon">Lun</div>
                     <div class="font-bold text-primary" data-translate-key="calendar_tue">Mar</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_wed">Mi</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_thu">Jue</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_fri">Vie</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_sat">Sb</div>
                     <div class="font-bold text-primary" data-translate-key="calendar_sun">Dom</div>
                </div>
                <div id="calendar-days-grid" class="calendar-grid"></div>
            </div>

            <div class="mt-6 border-t border-themed pt-4">
                <button id="add-task-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i><span data-translate-key="calendar_add_task_btn">Aadir Tarea</span>
                </button>
            </div>

            <button id="close-calendar-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>

    <div id="gamification-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-4">
                <h2 class="text-3xl font-extrabold text-gold">
                    <i class="fas fa-coins mr-2"></i><span data-translate-key="gamification_title">La Ascensin del G.O.A.T.</span> </h2>
                <button id="close-gamification-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>
            
            <div class="p-4 bg-input rounded-lg mb-4 flex-shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <span id="gamification-level-name" class="font-bold text-xl text-text-light">Nivel 1: Iniciador Digital</span>
                    <div class="text-right">
                        <span id="gamification-xp" class="font-bold text-primary">0 / 100 XP</span>
                         <p id="gamification-credits" class="text-sm text-gold font-semibold"><i class="fas fa-coins mr-1"></i>0 Crditos</p>
                    </div>
                </div>
                <div class="w-full xp-bar-bg rounded-full h-4">
                    <div id="gamification-xp-bar" class="xp-bar-fill h-4 rounded-full" style="width: 0%;"></div>
                 </div>
            </div>

            <div class="flex-grow overflow-hidden flex flex-col">
                <div class="flex-shrink-0 gamification-tabs flex items-center space-x-2">
                    <button class="gamification-tab active" data-tab="racha" data-translate-key="gamification_streak_tab">Racha Diaria</button> <button class="gamification-tab" data-tab="misiones" data-translate-key="gamification_missions_tab">Misiones</button> <button class="gamification-tab" data-tab="logros" data-translate-key="gamification_achievements_tab">Logros</button> <button id="gamification-rules-btn" class="ml-auto text-sm text-text-medium hover:text-primary" data-translate-key="gamification_rules_btn"><i class="fas fa-circle-question mr-1"></i> Reglas</button> </div>
                <div class="flex-grow overflow-y-auto pt-4">
                     <div id="gamification-tab-racha" class="gamification-tab-content space-y-4">
                        <p class="text-center text-text-medium" data-translate-key="gamification_streak_desc">Mantn tu racha para ganar XP, crditos y un cofre especial el da 7.</p> <div id="daily-streak-container" class="grid grid-cols-7 gap-2 md:gap-4 text-center">
                            </div>
                    </div>
                     <div id="gamification-tab-misiones" class="gamification-tab-content hidden space-y-3">
                        </div>
                     <div id="gamification-tab-logros" class="gamification-tab-content hidden">
                        <div id="achievements-container" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                           </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="gamification-rules-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-[60] p-4">
         <div class="modal-content rounded-lg w-full max-w-2xl p-6 relative">
            <h3 class="text-lg font-bold mb-4 text-gold" data-translate-key="gamification_rules_title"><i class="fas fa-scroll mr-2"></i>Reglas de "La Ascensin del GOAT"</h3> <div class="space-y-4 text-text-medium text-sm max-h-[70vh] overflow-y-auto pr-2">
                <p data-translate-key="gamification_rules_intro">Bienvenido a tu viaje para convertirte en un G.O.A.T. (Greatest Of All Time) del emprendimiento digital! La lgica es simple: cuanto ms usas la plataforma de forma estratgica, ms recompensas obtienes.</p> <div>
                    <h4 class="font-semibold text-text-light mt-3" data-translate-key="gamification_rules_xp_credits_title">1. Puntos de Experiencia (XP) vs. Crditos de Recompensa ()</h4> <p data-translate-key="gamification_rules_xp_credits_desc">Existen dos tipos de recompensas:</p> <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li data-translate-key="gamification_rules_xp_desc"><strong>Puntos de Experiencia (XP):</strong> Miden tu progreso y maestra. El XP <strong class="text-primary">nunca se gasta</strong>, solo se acumula para que subas de nivel y desbloquees nuevos ttulos.</li> <li data-translate-key="gamification_rules_credits_desc"><strong>Crditos de Recompensa ():</strong> Son una <strong class="text-gold">reserva de crditos utilizables</strong> que ganas al completar misiones y rachas. Cuando se agotan los crditos diarios de tu plan, el sistema usar automticamente estos crditos de recompensa para que puedas seguir trabajando.</li> </ul>
                </div>
                 <div>
                    <h4 class="font-semibold text-text-light mt-3" data-translate-key="gamification_rules_level_up_title">2. Cmo Subir de Nivel</h4> <p data-translate-key="gamification_rules_level_up_desc">Acumula suficiente XP para ascender de nivel. Cada nivel representa una nueva etapa en tu dominio del marketing y los negocios con IA.</p> <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li data-translate-key="level_1">Nivel 1: <strong>Iniciador Digital</strong></li> <li data-translate-key="level_2">Nivel 2: <strong>Creador de Contenido</strong></li> <li data-translate-key="level_3">Nivel 3: <strong>Estratega de Marketing</strong></li> <li data-translate-key="level_4">Nivel 4: <strong>CEO Digital</strong></li> <li data-translate-key="level_5">Nivel 5: <strong>G.O.A.T.</strong></li> </ul>
                </div>
                  <div>
                    <h4 class="font-semibold text-text-light mt-3" data-translate-key="gamification_rules_rewards_title">3. Cmo Ganar Recompensas</h4> <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li data-translate-key="gamification_rules_daily_streak"><strong>Racha Diaria:</strong> Cada da consecutivo que entras te da XP y Crditos de Recompensa.</li> <li data-translate-key="gamification_rules_goat_chest"><strong>Cofre GOAT (Da 7):</strong> Tu gran recompensa semanal por 7 das de racha! Puede contener una gran cantidad de crditos, <strong>cupones de descuento</strong> para nuestros servicios de implementacin (pginas web, automatizaciones) o incluso una <strong>asesora estratgica GRATIS</strong>.</li> <li data-translate-key="gamification_rules_missions_achievements"><strong>Misiones y Logros:</strong> La forma ms rpida de ganar grandes bonificaciones de XP y Crditos. Completa tareas especficas para acelerar tu ascenso.</li> </ul>
                </div>
                 <p class="font-bold text-center mt-4 text-lg text-primary" data-translate-key="gamification_rules_call_to_action">Cada accin cuenta en tu camino a la cima! A por ello!</p> </div>
            <button id="close-gamification-rules-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>

    <div id="plan-credits-info-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative">
            <h3 class="text-lg font-bold mb-4" data-translate-key="credits_info_title">Informacin de Crditos del Plan</h3> <div class="text-text-medium text-sm">
                <p data-translate-key="credits_info_desc">Aqu se detallan los costos de los crditos para cada accin:</p> <ul class="list-disc list-inside mt-2 space-y-1">
                    <li data-translate-key="cost_general">**GOAT X (General):** 1 crdito por mensaje</li> <li data-translate-key="cost_search">**Bsqueda Web:** 2 crditos por mensaje</li> <li data-translate-key="cost_workflow">**Workflows:** 2 crditos por mensaje</li> <li data-translate-key="cost_pdf_analysis">**Anlisis de PDF:** 2 crditos por mensaje</li> <li data-translate-key="cost_image_analysis">**Anlisis de Imagen:** 2 crditos por mensaje</li> <li data-translate-key="cost_image_generation">**Generacin de Imagen:** 5 crditos por imagen</li> <li data-translate-key="cost_gpt4o">**GOAT X PRO:** 3 crditos por mensaje</li> </ul>
                <p class="mt-4" data-translate-key="credits_info_renewal">Los crditos se renuevan mensualmente segn tu plan de suscripcin.</p> </div>
            <button id="close-plan-credits-info-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        //<-- START OF SCRIPT -->
        window.addEventListener('DOMContentLoaded', () => {
            dayjs.extend(window.dayjs_plugin_localizedFormat);
            dayjs.extend(window.dayjs_plugin_isoWeek);
             
            const translations = {
                es: {
                    initializing: "Inicializando...", new_chat: "Nuevo Chat", new_folder: "Nueva Carpeta",
                    web_offer: " Lanza tu Negocio, te regalamos una pg web Gratis con tu suscripcion!",
                     upgrade_plan: "Mejorar Plan", free_guides: "Guas de IA Gratis", workflows: "Workflows",
                    wf_pm_title: "Asistente de Proyectos", wf_fa_title: "Asistente Financiero", wf_na_title: "Bloc de Notas",
                    wf_expert: "Asistente Experto", wf_expert_1: "Laboratorio de Decisiones", wf_expert_2: "Resolucin de Conflictos",
                    wf_social: "Potenciador de Redes Sociales", wf_social_1: "Crear un Post Completo", wf_social_2: "Redaccin de Copys",
                     wf_social_3: "Lluvia de Ideas para Posts", wf_social_4: "Definir Estrategia de Marca",
                    wf_business: "Anlisis de Negocio", wf_business_1: "Anlisis de tu Competencia", wf_business_2: "Definir mi Cliente Ideal",
                    wf_business_3: "Lluvia de Nombres para Marca", wf_sales_category: "Comunicacin y Ventas", wf_sales_1: "Ventas para tu Negocio", /* Changed text */
                     wf_sales_2: "Redaccin de Email", wf_sales_3: "Diseo Web", wf_sales_4: "Mejorar Habilidades Sociales",
                    wf_eng_category: "English Teacher", wf_eng_1: "Traducir/Corregir Texto",
                    wf_eng_2: "Aprender Vocabulario Nuevo", wf_eng_3: "Practicar Conversacin", quick_actions: "Acciones Rpidas", select_chats: "Seleccionar Mltiples Chats",
                    delete: "Borrar", login: "Iniciar Sesin", settings: "Configuracin", logout: "Cerrar Sesin",
                     solutions: "Soluciones", ally_title: "Somos tu Aliado Estratgico", my_folders: "Mis Carpetas",
                    ally_desc: "Goatify no es solo un chat. Somos una IA personalizada con un equipo de expertos listos para ayudarte a escalar tu negocio.",
                    welcome_user: "Hola, ", welcome_user_2: "! Hoy es un gran da para crear algo increble.",
                    welcome_guest: "Cmo puedo ayudarte hoy?", model: "Modelo:", model_general: "GOAT X",
                    model_web: "Bsqueda Web", voice: "Voz:", placeholder_main: "Escribe tu mensaje...", cancel: "Cancelar",
                    confirm: "Confirm", plans_title: "Planes Goatify", plan_free_sub: "Para Siempre", plan_free_cta: "Empezar Gratis",
                     plan_boost_cta: "Obtener Boost", plan_pro_cta: "Quiero mi Plan Pro + Web",
                    preview: "Vista Previa", settings_email: "Correo Electrnico:", settings_plan: "Plan de Suscripcin:",
                    settings_fontsize: "Tamao de Letra:", settings_theme: "Personalizacin:", settings_dark_mode: "Modo Oscuro",
                     settings_lang: "Idioma:", settings_whatsapp: "Conectarse a WhatsApp", current_plan: "Tu Plan Actual",
                    settings_notifications: "Notificaciones de Tareas:", settings_schedule_meeting: "Agendar Reunin",
                    settings_integrations: "Integraciones", new_note_btn: "Nueva Nota", new_drawing_title: "Nuevo Dibujo",
                    calendar_today: "Hoy", calendar_this_week: "Esta Semana", calendar_mon: "Lun", calendar_tue: "Mar", calendar_wed: "Mi",
                     calendar_thu: "Jue", calendar_fri: "Vie", calendar_sat: "Sb", calendar_sun: "Dom",
                    calendar_no_tasks: "No hay tareas para este da.", calendar_add_task_placeholder: "Aadir nueva tarea personal...",
                    calendar_add_task_btn: "Aadir Tarea", calendar_my_calendar: "Mi Calendario y Tareas",
                    calendar_day_view: "Vista de Da", calendar_month_view: "Vista de Mes", calendar_week_view: "Vista de Semana",
                    notification_task_due: "Es hora de: ", notification_title: "Goatify IA - Hora de tu Tarea!",
                    tasks_for: "Tareas para", add_task_for: "Aadir Tarea para",
                    delete_task_confirm_title: "Confirmar Eliminacin", delete_task_confirm_body: "Ests seguro de que quieres eliminar esta tarea?",
                    delete_btn: "Eliminar",
                    share_note: "Compartir Nota",
                    share_note_desc: "Ingresa el email del usuario de Goatify con quien quieres colaborar en esta nota.",
                    share_note_email_placeholder: "ejemplo@email.com",
                    share_note_info: "Nota: Esta funcionalidad requiere que ambos usuarios tengan un plan Pro y est en desarrollo. Por ahora, esto es una demostracin.",
                    share_note_button: "Compartir",
                    share_financial_data: "Compartir Datos Financieros",
                    share_financial_data_desc: "Ingresa el email del usuario de Goatify con quien quieres compartir estos datos financieros.",
                    share_financial_data_info: "Nota: Esta funcionalidad requiere que ambos usuarios tengan un plan Pro y est en desarrollo. Por ahora, esto es una demostracin.",
                    gamification_title: "La Ascensin del G.O.A.T.",
                    gamification_streak_tab: "Racha Diaria",
                    gamification_missions_tab: "Misiones",
                    gamification_achievements_tab: "Logros",
                    gamification_rules_btn: "Reglas",
                    gamification_rules_title: "Reglas de \"La Ascensin del GOAT\"",
                    gamification_rules_intro: "Bienvenido a tu viaje para convertirte en un G.O.A.T. (Greatest Of All Time) del emprendimiento digital! La lgica es simple: cuanto ms usas la plataforma de forma estratgica, ms recompensas obtienes.",
                    gamification_rules_xp_credits_title: "1. Puntos de Experiencia (XP) vs. Crditos de Recompensa ()",
                    gamification_rules_xp_credits_desc: "Existen dos tipos de recompensas:",
                    gamification_rules_xp_desc: "<strong>Puntos de Experiencia (XP):</strong> Miden tu progreso y maestra. El XP <strong class=\"text-primary\">nunca se gasta</strong>, solo se acumula para que subas de nivel y desbloquees nuevos ttulos.",
                    gamification_rules_credits_desc: "<strong>Crditos de Recompensa ():</strong> Son una <strong class=\"text-gold\">reserva de crditos utilizables</strong> que ganas al completar misiones y rachas. Cuando se agotan los crditos diarios de tu plan, el sistema usar automticamente estos crditos de recompensa para que puedas seguir trabajando.",
                    gamification_rules_level_up_title: "2. Cmo Subir de Nivel",
                    gamification_rules_level_up_desc: "Acumula suficiente XP para ascender de nivel. Cada nivel representa una nueva etapa en tu dominio del marketing y los negocios con IA.",
                    level_1: "Nivel 1: <strong>Iniciador Digital</strong>",
                    level_2: "Nivel 2: <strong>Creador de Contenido</strong>",
                    level_3: "Nivel 3: <strong>Estratega de Marketing</strong>",
                    level_4: "Nivel 4: <strong>CEO Digital</strong>",
                    level_5: "Nivel 5: <strong>G.O.A.T.</strong>",
                    gamification_rules_rewards_title: "3. Cmo Ganar Recompensas",
                    gamification_rules_daily_streak: "<strong>Racha Diaria:</strong> Cada da consecutivo que entras te da XP y Crditos de Recompensa.",
                    gamification_rules_goat_chest: "<strong>Cofre GOAT (Da 7):</strong> Tu gran recompensa semanal por 7 das de racha! Puede contener una gran cantidad de crditos, <strong>cupones de descuento</strong> para nuestros servicios de implementacin (pginas web, automatizaciones) o incluso una <strong>asesora estratgica GRATIS</strong>.",
                    gamification_rules_missions_achievements: "<strong>Misiones y Logros:</strong> La forma ms rpida de ganar grandes bonificaciones de XP y Crditos. Completa tareas especficas para acelerar tu ascenso.",
                    gamification_rules_call_to_action: "Cada accin cuenta en tu camino a la cima! A por ello!",
                    credits_info_title: "Informacin de Crditos del Plan",
                    credits_info_desc: "Aqu se detallan los costos de los crditos para cada accin:",
                    cost_general: "**GOAT X (General):** 1 crdito por mensaje",
                    cost_search: "**Bsqueda Web:** 2 crditos por mensaje",
                    cost_workflow: "**Workflows:** 2 crditos por mensaje",
                    cost_pdf_analysis: "**Anlisis de PDF:** 2 crditos por mensaje",
                    cost_image_analysis: "**Anlisis de Imagen:** 2 crditos por mensaje",
                    cost_image_generation: "**Generacin de Imagen:** 5 crditos por imagen",
                    cost_gpt4o: "**GOAT X PRO:** 3 crditos por mensaje",
                    credits_info_renewal: "Los crditos se renuevan mensualmente segn tu plan de suscripcin.",
                },
                en: {
                     initializing: "Initializing...", new_chat: "New Chat", new_folder: "New Folder",
                    web_offer: " Launch your Business, get a free website with your subscription!",
                    upgrade_plan: "Upgrade Plan", free_guides: "Free AI Guides", workflows: "Workflows",
                    wf_pm_title: "Project Assistant", wf_fa_title: "Financial Assistant", wf_na_title: "Notepad",
                    wf_expert: "Expert Assistant", wf_expert_1: "Decision Lab", wf_expert_2: "Conflict Resolution",
                    wf_social: "Social Media Booster", wf_social_1: "Create a Full Post", wf_social_2: "Copywriting",
                    wf_social_3: "Brainstorm Post Ideas", wf_social_4: "Define Brand Strategy",
                    wf_business: "Business Analysis", wf_business_1: "Analyze your Competition", wf_business_2: "Define my Ideal Customer",
                     wf_business_3: "Brainstorm Brand Names", wf_sales_category: "Communication & Sales", wf_sales_1: "Sales for your Business", /* Changed text */
                    wf_sales_2: "Email Writing", wf_sales_3: "Web Design", wf_sales_4: "Improve Social Skills",
                    wf_eng_category: "English Teacher", wf_eng_1: "Translate/Correct Text",
                    wf_eng_2: "Learn New Vocabulary", wf_eng_3: "Practice Conversation", quick_actions: "Quick Actions", select_chats: "Select Multiple Chats",
                    delete: "Delete", login: "Login", settings: "Settings", logout: "Logout",
                    solutions: "Solutions", ally_title: "We are your Strategic Ally", my_folders: "My Folders",
                    ally_desc: "Goatify is not just a chat. We are a custom IA with a team of experts ready to help you scale your business.",
                    welcome_user: "Hello, ", welcome_user_2: "! Today is a great day to create something amazing.",
                    welcome_guest: "How can I help you today?", model: "Model:", model_general: "GOAT X",
                    model_web: "Web Search", voice: "Voice:", placeholder_main: "Type your message...", cancel: "Cancel",
                    confirm: "Confirm", plans_title: "Goatify Plans", plan_free_sub: "Forever", plan_free_cta: "Get Started for Free",
                    plan_boost_cta: "Get Boost", plan_pro_cta: "Get Pro Plan + Web",
                    preview: "Preview", settings_email: "Email Address:", settings_plan: "Subscription Plan:",
                    settings_fontsize: "Font Size:", settings_theme: "Personalization:", settings_dark_mode: "Dark Mode",
                     settings_lang: "Language:", settings_whatsapp: "Connect to WhatsApp", current_plan: "Current Plan",
                    settings_notifications: "Task Notifications:", settings_schedule_meeting: "Schedule Meeting",
                    settings_integrations: "Integrations", new_note_btn: "New Note", new_drawing_title: "New Drawing",
                    calendar_today: "Today", calendar_this_week: "This Week", calendar_mon: "Mon", calendar_tue: "Mar", calendar_wed: "Wed",
                     calendar_thu: "Thu", calendar_fri: "Fri", calendar_sat: "Sat", calendar_sun: "Sun",
                    calendar_no_tasks: "No tasks for this day.", calendar_add_task_placeholder: "Add new personal task...",
                    calendar_add_task_btn: "Add Task", calendar_my_calendar: "My Calendar & Tasks",
                    calendar_day_view: "Day View", calendar_month_view: "Month View", calendar_week_view: "Week View",
                     notification_task_due: "Time for: ", notification_title: "Goatify IA - Task Due!",
                    tasks_for: "Tasks for", add_task_for: "Add Task for",
                    delete_task_confirm_title: "Confirm Deletion", delete_task_confirm_body: "Are you sure you want to delete this task?",
                    delete_btn: "Delete",
                    share_note: "Share Note",
                    share_note_desc: "Enter the email of the Goatify user you want to collaborate with on this note.",
                    share_note_email_placeholder: "example@email.com",
                    share_note_info: "Note: This functionality requires both users to have a Pro plan and is under development. For now, this is a demonstration.",
                    share_note_button: "Share",
                    share_financial_data: "Share Financial Data",
                    share_financial_data_desc: "Enter the email of the Goatify user you want to share this financial data with.",
                    share_financial_data_info: "Note: This functionality requires both users to have a Pro plan and is under development. For now, this is a demonstration.",
                    gamification_title: "The Ascension of the G.O.A.T.",
                    gamification_streak_tab: "Daily Streak",
                    gamification_missions_tab: "Missions",
                    gamification_achievements_tab: "Achievements",
                    gamification_rules_btn: "Rules",
                    gamification_rules_title: "Rules of \"The Ascension of the GOAT\"",
                    gamification_rules_intro: "Welcome to your journey to become a G.O.A.T. (Greatest Of All Time) of digital entrepreneurship! The logic is simple: the more you use the platform strategically, the more rewards you get.",
                    gamification_rules_xp_credits_title: "1. Experience Points (XP) vs. Reward Credits ()",
                    gamification_rules_xp_credits_desc: "There are two types of rewards:",
                    gamification_rules_xp_desc: "<strong>Experience Points (XP):</strong> Measure your progress and mastery. XP <strong class=\"text-primary\">is never spent</strong>, it only accumulates for you to level up and unlock new titles.",
                    gamification_rules_credits_desc: "<strong>Reward Credits ():</strong> These are a <strong class=\"text-gold\">reserve of usable credits</strong> that you earn by completing missions and streaks. When your plan's daily credits run out, the system will automatically use these reward credits so you can continue working.",
                    gamification_rules_level_up_title: "2. How to Level Up",
                    gamification_rules_level_up_desc: "Accumulate enough XP to ascend in level. Each level represents a new stage in your mastery of AI marketing and business.",
                    level_1: "Level 1: <strong>Digital Initiator</strong>",
                    level_2: "Level 2: <strong>Content Creator</strong>",
                    level_3: "Level 3: <strong>Marketing Strategist</strong>",
                    level_4: "Level 4: <strong>Digital CEO</strong>",
                    level_5: "Level 5: <strong>G.O.A.T.</strong>",
                    gamification_rules_rewards_title: "3. How to Earn Rewards",
                    gamification_rules_daily_streak: "<strong>Daily Streak:</strong> Each consecutive day you log in gives you XP and Reward Credits.",
                    gamification_rules_goat_chest: "<strong>GOAT Chest (Day 7):</strong> Your big weekly reward for a 7-day streak! It can contain a large amount of credits, <strong>discount coupons</strong> for our implementation services (websites, automations), or even a <strong>FREE strategic consultation</strong>.",
                    gamification_rules_missions_achievements: "<strong>Missions and Achievements:</strong> The fastest way to earn big XP and Credit bonuses. Complete specific tasks to accelerate your ascension.",
                    gamification_rules_call_to_action: "Every action counts on your way to the top! Go for it!",
                    credits_info_title: "Plan Credits Information",
                    credits_info_desc: "Here are the credit costs for each action:",
                    cost_general: "**GOAT X (General):** 1 credit per message",
                    cost_search: "**Web Search:** 2 credits per message",
                    cost_workflow: "**Workflows:** 2 credits per message",
                    cost_pdf_analysis: "**PDF Analysis:** 2 credits per message",
                    cost_image_analysis: "**Image Analysis:** 2 credits per message",
                    cost_image_generation: "**Image Generation:** 5 credits per image",
                    cost_gpt4o: "**GOAT X PRO:** 3 credits per message",
                    credits_info_renewal: "Credits renew monthly according to your subscription plan.",
                }
            };
            const GUEST_CREDIT_LIMIT = 5;
            const FREE_PLAN_CREDIT_LIMIT = 50;
            const BOOST_PLAN_CREDIT_LIMIT = 500;
            const PRO_PLAN_CREDIT_LIMIT = 2000;

            const MOTIVATIONAL_MESSAGES = [
                "Eres una persona increble, nunca lo dudes!",
                "Hoy es tu da para brillar. Ve por ello!",
                "Tu potencial es infinito. Puedes lograr lo que te propongas!",
                "La rompes todos los das, sigue as!",
                "Confa en tu proceso. Ests construyendo algo grandioso.",
                "Cada paso que das te acerca a tu meta. No te detengas!",
                "Tu energa es contagiosa. Ilumina el mundo!",
                "Puedes con todo y ms. Cree en ti!",
                "El xito es la suma de pequeos esfuerzos repetidos da tras da.",
                "No esperes el momento perfecto, toma el momento y hazlo perfecto.",
                "Cada pequeo paso te acerca a tu meta. Sigue avanzando!",
                "Tu actitud determina tu direccin. Elige ser positivo!",
                "Convierte los obstculos en oportunidades. Tienes la fuerza!",
                "La persistencia es el camino al xito. No te rindas jams!"
            ];
            const MOTIVATION_BUTTON_TEXTS = [
                "Entendido!", "Vamos a darle!", "Perfecto!", "S, yo puedo!", "Vamos!",
                "A por ello!", "Manos a la obra!", "Con toda la actitud!", "As se hace!", "Dale con todo!"
            ];

            const COSTS = { 
                GENERAL: 1, 
                SEARCH: 2, 
                WORKFLOW: 2,
                PDF_ANALYSIS: 2,
                IMAGE_ANALYSIS: 2,
                IMAGE_GENERATION: 5,
                GPT4O: 3 // Cost for GPT-4o model
            };
            let state = { chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
            let gamificationState = {};
            let currentChatId = null, currentUser = null, speechOn = false, availableVoices = [], selectedVoice = null, isRecognizing = false, selectedImageBase64 = null, selectedPdfText = null;
            let micWasOnBeforeSpeaking = false;
            let modalResolve = null;
            let isSelectModeActive = false;
            let chatsToDelete = new Set();
            let currentNoteId = null;
            let goatXProUsage = 0; // Daily usage counter for GPT-4o

            // Daily limit for GPT-4o, if not logged in or on free plan, it's 0 (effectively unlimited for paid plans)
            const getGoatXProDailyLimit = () => {
                if (currentUser && (currentUser.app_metadata?.plan === 'boost' || currentUser.app_metadata?.plan === 'pro')) {
                    return Infinity; // Unlimited for paid plans
                }
                return 10; // 10 uses per day for free users
            };


            let notificationsEnabled = localStorage.getItem('goatify-notifications-enabled') === null ? true : localStorage.getItem('goatify-notifications-enabled') === 'true';
            let motivationEnabled = localStorage.getItem('goatify-motivation-enabled') === null ? true : localStorage.getItem('goatify-motivation-enabled') === 'true';

            let selectedCalendarDate = dayjs();
            let currentCalendarView = 'month';
            let activeTagFilter = null;
            let motivationInterval = null;
            const dom = {};
            
            const fullDom = {
                appContainer: document.getElementById('app-container'),
                msgInput: document.getElementById('msg'), sendBtn: document.getElementById('send'),
                inputArea: document.getElementById('input-area'),
                filePreviewArea: document.getElementById('file-preview-area'),
                messageCounterEl: document.getElementById('message-counter'), 
                upgradePlanContainer: document.getElementById('upgrade-plan-container'),
                upgradePlanBtn: document.getElementById('upgrade-plan-btn'),
                newChatBtn: document.getElementById('new-chat-btn'), newFolderBtn: document.getElementById('new-folder-btn'),
                pricingModal: document.getElementById('pricing-modal'), closePricingModalBtn: document.getElementById('close-pricing-modal'),
                genericModal: document.getElementById('generic-modal'), 
                viewContainer: document.getElementById('view-container'),
                chatMessages: document.getElementById('chat-messages'),
                notepadViewContainer: document.getElementById('notepad-view-container'),
                chatTitle: document.getElementById('chat-title'), mobileChatTitle: document.getElementById('mobile-chat-title'),
                desktopChatTitleWrapper: document.getElementById('desktop-chat-title-wrapper'), mobileChatTitleWrapper: document.getElementById('mobile-chat-title-wrapper'),
                initialMessageContainer: document.getElementById('initial-message-container'), themeToggle: document.getElementById('theme-toggle'), themeIcon: document.getElementById('theme-icon'),
                micBtn: document.getElementById('mic-btn'), ttsToggle: document.getElementById('tts-toggle'), 
                modelSelector: document.getElementById('model-selector'),
                actionButtonsContainer: document.getElementById('action-buttons-container'),
                imageUploadBtn: document.getElementById('image-upload-btn'), imageUploadInput: document.getElementById('image-upload'),
                imagePreviewContainer: document.getElementById('image-preview-container'), imagePreview: document.getElementById('image-preview'),
                clearImageBtn: document.getElementById('clear-image-btn'), pdfUploadBtn: document.getElementById('pdf-upload-btn'), pdfUploadInput: document.getElementById('pdf-upload'),
                pdfPreviewContainer: document.getElementById('pdf-preview-container'), pdfNameEl: document.getElementById('pdf-name'), pdfStatusEl: document.getElementById('pdf-status'), clearPdfBtn: document.getElementById('clear-pdf-btn'),
                sidebar: document.getElementById('sidebar'), menuToggle: document.getElementById('menu-toggle'), sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarContent: document.getElementById('sidebar-content'), loginView: document.getElementById('login-view'), userMenuView: document.getElementById('user-menu-view'),
                loginBtn: document.getElementById('login-btn'), userMenuBtn: document.getElementById('user-menu-btn'), userMenuPopup: document.getElementById('user-menu-popup'), userEmail: document.getElementById('user-email'),
                logoutBtn: document.getElementById('logout-btn'), webLaunchOfferBtn: document.getElementById('web-launch-offer-btn'),
                workflowsContainer: document.getElementById('workflows-container'), freeGuidesLink: document.getElementById('free-guides-link'),
                personalizedWelcome: document.getElementById('personalized-welcome'), genericWelcome: document.getElementById('generic-welcome'), userName: document.getElementById('user-name'),
                loadingOverlay: document.getElementById('loading-overlay'), htmlPreviewModal: document.getElementById('html-preview-modal'),
                closeHtmlPreviewModalBtn: document.getElementById('close-html-preview-modal'), htmlPreviewIframe: document.getElementById('html-preview-iframe'),
                voiceSelector: document.getElementById('voice-selector'), 
                voiceSelectorContainer: document.getElementById('voice-selector-container'),
                selectChatsBtn: document.getElementById('select-chats-btn'), deleteModeControls: document.getElementById('delete-mode-controls'),
                deleteSelectedBtn: document.getElementById('delete-selected-btn'), cancelSelectModeBtn: document.getElementById('cancel-select-mode-btn'),
                imageGenBtn: document.getElementById('image-gen-btn'), servicesMenuBtn: document.getElementById('services-menu-btn'), servicesMenu: document.getElementById('services-menu'),
                contextualFooter: document.getElementById('contextual-footer'),
                newChatIconBtn: document.getElementById('new-chat-icon-btn'),
                newFolderIconBtn: document.getElementById('new-folder-icon-btn'), 
                settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'), closeSettingsModal: document.getElementById('close-settings-modal'),
                settingsUserEmail: document.getElementById('settings-user-email'), settingsUserPlan: document.getElementById('settings-user-plan'),
                settingsUpgradePlanBtn: document.getElementById('settings-upgrade-plan-btn'), fontSizeSlider: document.getElementById('font-size-slider'),
                fontSizeValue: document.getElementById('font-size-value'), settingsThemeToggle: document.getElementById('settings-theme-toggle'),
                settingsThemeIcon: document.getElementById('settings-theme-icon'), languageSelector: document.getElementById('language-selector'),
                connectWhatsappBtn: document.getElementById('connect-whatsapp-btn'), scheduleMeetingBtn: document.getElementById('schedule-meeting-btn'), freePlanButton: document.getElementById('free-plan-button'),
                notificationsToggle: document.getElementById('notifications-toggle'),
                mainChatArea: document.getElementById('main-chat-area'),
                calendarModalOverlay: document.getElementById('calendar-modal-overlay'),
                calendarModal: document.getElementById('calendar-modal'),
                calendarBtn: document.getElementById('calendar-btn'),
                closeCalendarModal: document.getElementById('close-calendar-modal'),
                prevMonthBtn: document.getElementById('prev-month'), nextMonthBtn: document.getElementById('next-month'),
                currentMonthYear: document.getElementById('current-month-year'), calendarDaysGrid: document.getElementById('calendar-days-grid'),
                addTaskBtn: document.getElementById('add-task-btn'),
                notificationBadge: document.getElementById('notification-badge'),
                inAppNotification: document.getElementById('in-app-notification'), 
                inAppNotificationTitle: document.getElementById('in-app-notification-title'),
                inAppNotificationBody: document.getElementById('in-app-notification-body'),
                inAppNotificationClose: document.getElementById('in-app-notification-close'),
                notificationDoneBtn: document.getElementById('notification-done-btn'),
                notificationSnoozeBtn: document.getElementById('notification-snooze-btn'),
                monthViewContainer: document.getElementById('month-view-container'), weekViewContainer: document.getElementById('week-view-container'),
                dayViewContainer: document.getElementById('day-view-container'),
                monthViewBtn: document.getElementById('month-view-btn'), weekViewBtn: document.getElementById('week-view-btn'), dayViewBtn: document.getElementById('day-view-btn'),
                prevWeekBtn: document.getElementById('prev-week'), nextWeekBtn: document.getElementById('next-week'),
                currentWeekRange: document.getElementById('current-week-range'), weekDaysContent: document.getElementById('week-days-content'),
                prevDayBtn: document.getElementById('prev-day'), nextDayBtn: document.getElementById('next-day'),
                currentDayDisplay: document.getElementById('current-day-display'), dayViewTimeline: document.getElementById('day-view-timeline'),
                projectManagementView: document.getElementById('project-management-view'),
                projectBoardContainer: document.getElementById('project-board-container'),
                projectChatContainer: document.getElementById('project-chat-container'),
                projectChatToggle: document.getElementById('project-chat-toggle'),
                projectChatHeader: document.getElementById('project-chat-container-header'),
                projectViewTitle: document.getElementById('project-view-title'),
                kanbanView: document.getElementById('kanban-view'),
                listView: document.getElementById('list-view'),
                listViewMobile: document.getElementById('list-view-mobile'),
                viewToggleKanban: document.getElementById('view-toggle-kanban'),
                viewToggleList: document.getElementById('view-toggle-list'),
                addTaskListViewBtn: document.getElementById('add-task-list-view-btn'),
                projectChatMessages: document.getElementById('project-chat-messages'),
                projectMsgInput: document.getElementById('project-msg'),
                projectSendBtn: document.getElementById('project-send'),
                projectCalendarBtn: document.getElementById('project-calendar-btn'),
                tagFilterBtn: document.getElementById('tag-filter-btn'),
                tagFilterDropdown: document.getElementById('tag-filter-dropdown'),
                financialAssistantView: document.getElementById('financial-assistant-view'),
                gamificationBtn: document.getElementById('gamification-btn'),
                gamificationModal: document.getElementById('gamification-modal'),
                closeGamificationModal: document.getElementById('close-gamification-modal'),
                gamificationLevelName: document.getElementById('gamification-level-name'),
                gamificationXp: document.getElementById('gamification-xp'),
                gamificationCredits: document.getElementById('gamification-credits'),
                gamificationXpBar: document.getElementById('gamification-xp-bar'),
                dailyStreakContainer: document.getElementById('daily-streak-container'),
                missionsContainer: document.getElementById('gamification-tab-misiones'),
                achievementsContainer: document.getElementById('achievements-container'),
                gamificationRulesBtn: document.getElementById('gamification-rules-btn'),
                gamificationRulesModal: document.getElementById('gamification-rules-modal'),
                closeGamificationRulesModal: document.getElementById('close-gamification-rules-modal'),
                motivationBtnHeader: document.getElementById('motivation-btn-header'),
                motivationBtnMobile: document.getElementById('motivation-btn-mobile'),
                motivationModal: document.getElementById('motivation-modal'),
                motivationTitle: document.getElementById('motivation-title'),
                motivationQuote: document.getElementById('motivation-quote'),
                motivationToggle: document.getElementById('motivation-toggle'),
                closeMotivationModal: document.getElementById('close-motivation-modal'),
                sidebarToggleArrow: document.getElementById('sidebar-toggle-arrow'),
                
                // Notepad DOM elements
                notesListPanel: document.getElementById('notes-list-panel'),
                notesList: document.getElementById('notes-list'),
                notesListHeader: document.getElementById('notes-list-header'),
                noteEditorPanel: document.getElementById('note-editor-panel'),
                noteTitleInput: document.getElementById('note-title-input'),
                noteEditorToolbar: document.getElementById('note-editor-toolbar'),
                textTools: document.getElementById('text-tools'),
                drawingTools: document.getElementById('drawing-tools'),
                deleteNoteBtn: document.getElementById('delete-note-btn'),
                shareNoteBtn: document.getElementById('share-note-btn'),
                addChecklistItemBtn: document.getElementById('add-checklist-item-btn'),
                noteContentArea: document.getElementById('note-content-area'),
                noteContentEditor: document.getElementById('note-content-editor'),
                noteCanvas: document.getElementById('note-canvas'),
                addNewNoteBtn: document.getElementById('add-new-note-btn'),
                addNewDrawingBtn: document.getElementById('add-new-drawing-btn'),
                noteBackBtn: document.getElementById('note-back-btn'),
                notepadChatContainer: document.getElementById('notepad-chat-container'),
                notepadChatHeader: document.getElementById('notepad-chat-header'),
                notepadChatToggle: document.getElementById('notepad-chat-toggle'),
                notepadChatMessages: document.getElementById('notepad-chat-messages'),
                notepadMsgInput: document.getElementById('notepad-msg'),
                notepadSendBtn: document.getElementById('notepad-send'),
                notesListToggle: document.getElementById('notes-list-toggle'),
                planCreditsDisplay: document.getElementById('plan-credits-display'),
                rewardCreditsDisplay: document.getElementById('reward-credits-display'),
                planCreditsInfoModal: document.getElementById('plan-credits-info-modal'),
                closePlanCreditsInfoModal: document.getElementById('close-plan-credits-info-modal'),
                foldersList: document.getElementById('folders-list'),
            };
            Object.assign(dom, fullDom);

            // --- END OF DOM MAPPING ---

            const XP_FOR_LEVEL = [0, 250, 750, 2000, 5000, Infinity]; 
            const LEVEL_NAMES = ["Iniciador Digital", "Creador de Contenido", "Estratega de Marketing", "CEO Digital", "G.O.A.T."];
            const MISSIONS = {
                'brand-strategy': { id: 'brand-strategy', text: 'Define tu primera estrategia de marca', xp: 50, credits: 15, workflow: 'brand-strategy' },
                'competitor-analysis': { id: 'competitor-analysis', text: 'Espa a la competencia por primera vez', xp: 50, credits: 15, workflow: 'competitor-analysis' },
                'week-organized': { id: 'week-organized', text: 'Crea una tarea para cada da de la semana', xp: 75, credits: 25, condition: checkWeekOrganized },
                'project-created': { id: 'project-created', text: 'Crea tu primer proyecto y aade 3 tareas', xp: 100, credits: 30, condition: (chatId) => checkProjectCreated(chatId, 3) },
                'image-generated': { id: 'image-generated', text: 'Genera tu primera imagen con IA', xp: 40, credits: 10, action: 'generateImage' },
                'english-practice': { id: 'english-practice', text: 'Practica tu conversacin en ingls', xp: 30, credits: 10, workflow: 'english-teacher-practice' },
                'social-skills': { id: 'social-skills', text: 'Mejora tus habilidades sociales con un consejo de IA', xp: 30, credits: 10, workflow: 'social-skills' },
                'conflict-resolution': { id: 'conflict-resolution', text: 'Analiza tu primer conflicto con IA', xp: 40, credits: 15, workflow: 'conflict-resolution' },
                'decision-lab': { id: 'decision-lab', text: 'Usa el Laboratorio de Decisiones', xp: 50, credits: 20, workflow: 'decision-lab' },
            };
            const ACHIEVEMENTS = {
                'streak-30': { id: 'streak-30', title: 'Consistencia', description: 'Mantn la racha diaria por 30 das.', icon: 'fa-calendar-check', xp: 500, credits: 250 },
                'project-master': { id: 'project-master', title: 'Project Master', description: 'Completa 10 proyectos.', icon: 'fa-sitemap', xp: 1000, credits: 0, reward: '50% de descuento en consultora de automatizacin.' },
                'influencer': { id: 'influencer', title: 'Influencer', description: 'Genera 50 publicaciones para redes sociales.', icon: 'fa-bullhorn', xp: 750, credits: 0, reward: 'Un mes de GOAT Boost gratis.' },
            };

            function setLanguage(lang) {
                const translationData = translations[lang];
                if (!translationData) return;
                dayjs.locale(lang);
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    if (translationData[key]) {
                        // For textareas and inputs, update placeholder
                        if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') {
                             if(el.placeholder) el.placeholder = translationData[key];
                        } else if (el.querySelector('i')) { // If it has a child icon, assume text is its sibling
                            const textNode = Array.from(el.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
                            if (textNode) {
                                textNode.textContent = ' ' + translationData[key];
                            } else { // If text is in a span, update the span
                                const textSpan = el.querySelector('span:not(.notification-badge):not([id*="-credits-display"])');
                                if (textSpan) {
                                    textSpan.textContent = translationData[key];
                                } else {
                                    el.textContent = translationData[key];
                                }
                            }
                        } else {
                             el.textContent = translationData[key];
                        }
                     }
                });
                // Manually update specific non-data-translate-key elements that need translation
                document.getElementById('add-new-note-btn').querySelector('span').textContent = translations[lang].new_note_btn || 'Nueva Nota';
                document.getElementById('add-new-drawing-btn').title = translations[lang].new_drawing_title || 'Nuevo Dibujo';

                document.documentElement.lang = lang;
                localStorage.setItem('goatify-lang', lang);
                renderCalendarView();
            }
            
            function updateContextualFooter(workflowKey) {
                if (!dom.contextualFooter) return;
                const workflowTexts = {
                    'create-full-post': 'Modo Redes Sociales: Define tu red social y tema para un post completo.',
                    'persuasive-copy': 'Modo Copywriter: Dime qu vendes y para dnde es el texto.',
                    'brand-strategy': 'Modo Estratega: Dime el nombre y rubro de tu negocio para empezar.',
                     'competitor-analysis': 'Modo Analista: Pega la URL de tu competencia para investigarla.',
                    'sales-assistant': 'Modo Ventas para tu Negocio: Pega el mensaje de tu cliente para responder.', /* Updated text */
                    'english-teacher-practice': 'Practice mode: Let\'s talk. How was your day.',
                    'design-web': 'Modo Diseador Web: Describe el componente visual y lo crear en HTML.',
                    'project-management': 'Modo Director de Proyectos: Describe tu proyecto para crear tareas en el tablero.',
                    'conflict-resolution': 'Modo Mediador: Describe la situacin de conflicto para encontrar una solucin.',
                    'decision-lab': 'Modo Estratega: Describe la decisin que enfrentas y tus opciones.',
                    'financial-assistant': 'Modo Financiero: Usa la tabla para registrar transacciones. Pdeme anlisis en el chat.',
                    'notepad-app': 'Bloc de Notas: Organiza tus ideas. Todo se guarda automticamente.',
                    'notepad-assistant': 'Asistente de Redaccin: Pide ideas, resmenes o ayuda para mejorar tu texto actual. Tambin puedo corregir tu ortografa y gramtica.', /* Updated message */
                };
                const currentChat = state.chats[currentChatId];
                const key = workflowKey || (currentChat ? currentChat.workflow : (currentChatId === 'notepad-app' ? 'notepad-app' : null));
                dom.contextualFooter.textContent = workflowTexts[key] || 'Tu copiloto de IA para hacer crecer tu negocio.';
            }

            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            function showModal({ title, body, confirmText = 'Confirmar', cancelText = 'Cancelar', showCancel = true, showConfirm = true, extraButtons = [], dangerConfirm = false }) {
                const modalTitle = dom.genericModal.querySelector('#modal-title');
                const modalBody = dom.genericModal.querySelector('#modal-body');
                const modalButtonsContainer = dom.genericModal.querySelector('#modal-buttons-container');
                
                modalTitle.innerHTML = title; 
                modalBody.innerHTML = body;
                
                let buttonsHTML = '';
                extraButtons.forEach(btn => {
                    buttonsHTML += `<button id="${btn.id}" class="${btn.classes || 'px-4 py-2 rounded bg-gray-500 text-white'}">${btn.text}</button>`;
                });
                if (showCancel) {
                    buttonsHTML += `<button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded">${cancelText}</button>`;
                }
                if (showConfirm) {
                    const confirmClasses = dangerConfirm ? 'btn-danger' : 'btn-primary';
                    buttonsHTML += `<button id="modal-confirm" class="px-4 py-2 rounded text-white ${confirmClasses}">${confirmText}</button>`;
                }
                modalButtonsContainer.innerHTML = buttonsHTML;

                if (showConfirm) {
                    dom.genericModal.querySelector('#modal-confirm').addEventListener('click', () => {
                        const inputs = modalBody.querySelectorAll('input, textarea, select');
                        const data = {};
                        inputs.forEach(input => {
                            data[input.id] = input.type === 'checkbox' ? input.checked : input.value;
                        });
                        hideModal({ confirmed: true, data });
                    }, { once: true });
                }

                if (showCancel) {
                    dom.genericModal.querySelector('#modal-cancel').addEventListener('click', () => hideModal({ confirmed: false }), { once: true });
                }
                extraButtons.forEach(btn => {
                    dom.genericModal.querySelector(`#${btn.id}`).addEventListener('click', (e) => {
                         btn.action(e, modalBody);
                    });
                });
                
                dom.genericModal.classList.remove('hidden');
                dom.genericModal.classList.add('flex');
                
                return new Promise(resolve => { modalResolve = resolve; });
            }
            function hideModal(resolveWith = null) { if(modalResolve) { modalResolve(resolveWith); modalResolve = null; } dom.genericModal.classList.add('hidden'); dom.genericModal.classList.remove('flex');  }
            
            function showPricingModal() { 
                dom.pricingModal.classList.remove('hidden');
                dom.pricingModal.classList.add('flex'); 
                setTimeout(() => { dom.pricingModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
                
                const lang = localStorage.getItem('goatify-lang') || 'es';
                const isFree = !currentUser || (currentUser.app_metadata?.plan || 'free') === 'free';
                
                if (isFree) {
                    dom.freePlanButton.textContent = translations[lang].current_plan;
                    dom.freePlanButton.disabled = true;
                    dom.freePlanButton.classList.add('btn-disabled');
                } else {
                    dom.freePlanButton.textContent = translations[lang].plan_free_cta;
                    dom.freePlanButton.disabled = false;
                    dom.freePlanButton.classList.remove('btn-disabled');
                }
            }
            function hidePricingModal() { dom.pricingModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => { dom.pricingModal.classList.add('hidden'); dom.pricingModal.classList.remove('flex'); }, 300); }

            function showSettingsModal() {
                dom.settingsModal.classList.remove('hidden');
                dom.settingsModal.classList.add('flex');
                if (currentUser) {
                    dom.settingsUserEmail.textContent = currentUser.email;
                    const userPlan = currentUser.app_metadata?.plan || 'free';
                    dom.settingsUserPlan.textContent = userPlan.charAt(0).toUpperCase() + userPlan.slice(1);
                    dom.settingsUpgradePlanBtn.classList.toggle('hidden', userPlan !== 'free');
                } else {
                    dom.settingsUserEmail.textContent = 'Not logged in';
                    dom.settingsUserPlan.textContent = 'Free (Guest)';
                    dom.settingsUpgradePlanBtn.classList.remove('hidden');
                }
                dom.fontSizeSlider.value = parseInt(getComputedStyle(document.body).getPropertyValue('--base-font-size')) || 16;
                dom.fontSizeValue.textContent = `${dom.fontSizeSlider.value}px`;
                dom.settingsThemeIcon.className = `fas fa-${document.body.classList.contains('dark-theme') ? 'sun' : 'moon'}`;
                dom.languageSelector.value = localStorage.getItem('goatify-lang') || 'es';
                dom.notificationsToggle.checked = notificationsEnabled;
            }

            function hideSettingsModal() {
                dom.settingsModal.classList.add('hidden');
                dom.settingsModal.classList.remove('flex');
            }

            function showInAppNotification(title, body, duration = null, taskId = null) { /* Added taskId parameter */
                dom.inAppNotificationTitle.innerHTML = title;
                dom.inAppNotificationBody.innerHTML = body;
                dom.inAppNotification.classList.add('show');
                
                const notificationButtons = document.getElementById('in-app-notification-buttons');
                const notificationDoneBtn = document.getElementById('notification-done-btn');
                const notificationSnoozeBtn = document.getElementById('notification-snooze-btn');

                let timer;

                const closeNotification = (event) => {
                    // This function should be callable externally and internally without relying on event.target.closest
                    if(timer) clearTimeout(timer);
                    dom.inAppNotification.classList.remove('show');
                    // Remove listeners to prevent memory leaks and multiple calls
                    notificationDoneBtn.removeEventListener('click', handleNotificationDone);
                    notificationSnoozeBtn.removeEventListener('click', handleNotificationSnooze);
                    dom.inAppNotificationClose.removeEventListener('click', closeFromX);
                    // Crucially, remove the overlay click listener if it was set
                    dom.inAppNotification.removeEventListener('click', closeNotification); 
                };
            
                const closeFromX = (event) => {
                    event.stopPropagation(); // Prevent event from bubbling up to the notification overlay
                    closeNotification();
                };

                const handleNotificationDone = () => {
                    if (taskId) {
                        updateTaskStatus(taskId, { completed: true });
                    }
                    closeNotification();
                };

                const handleNotificationSnooze = async () => {
                    const snoozeOptions = [
                        { label: '5 minutos', value: 5 },
                        { label: '15 minutos', value: 15 },
                        { label: '30 minutos', value: 30 },
                        { label: '1 hora', value: 60 },
                        { label: 'Maana por la maana', value: 'tomorrow_morning' }
                    ];

                    const optionsHtml = snoozeOptions.map(opt => 
                        `<option value="${opt.value}">${opt.label}</option>`
                    ).join('');

                    const result = await showModal({
                        title: 'Aplazar Tarea',
                        body: `<p>Por cunto tiempo quieres aplazar esta tarea?</p>
                               <select id="snooze-duration" class="w-full p-2 rounded bg-input border border-themed mt-2">${optionsHtml}</select>`,
                        confirmText: 'Aplazar',
                        cancelText: 'Cancelar'
                    });

                    if (result.confirmed && taskId) {
                        const snoozeDuration = result.data['snooze-duration'];
                        let newTime, newDate;
                        const task = findTask(taskId)?.task;

                        if (snoozeDuration === 'tomorrow_morning') {
                            newDate = dayjs().add(1, 'day').format('YYYY-MM-DD');
                            newTime = '08:00'; // Default morning time
                        } else {
                            const minutesToAdd = parseInt(snoozeDuration);
                            const currentDateTime = dayjs(`${task.date}T${task.time || '00:00'}`); // Use task.date and task.time
                            const newDateTime = currentDateTime.add(minutesToAdd, 'minute');
                            newDate = newDateTime.format('YYYY-MM-DD');
                            newTime = newDateTime.format('HH:mm');
                        }
                        updateTaskStatus(taskId, { date: newDate, time: newTime, notifiedThisMinute: false });
                        closeNotification();
                    } else {
                        // If snooze is cancelled, don't close the original notification immediately
                    }
                };

                // Attach event listeners for notification action buttons
                notificationDoneBtn.addEventListener('click', handleNotificationDone);
                notificationSnoozeBtn.addEventListener('click', handleNotificationSnooze);
                dom.inAppNotificationClose.addEventListener('click', closeFromX);
            
                // For generic pop-ups (not calendar/task notifications), duration is applied and they are short-lived.
                // For calendar/task notifications, they are fixed on screen until dismissed by user actions.
                if (taskId === null) { // This means it's a short-lived popup (e.g., chat created, motivation)
                    notificationButtons.classList.add('hidden'); // Hide buttons for short-lived popups
                    timer = setTimeout(closeNotification, duration);
                    dom.inAppNotification.removeEventListener('click', closeNotification); // Remove outer click listener if it's auto-dismissed
                } else { // This means it's a persistent notification (e.g., calendar/task notification)
                    notificationButtons.classList.remove('hidden'); // Show buttons for persistent notifications
                    // Add click listener to notification overlay itself for dismissal (if it has buttons)
                    dom.inAppNotification.addEventListener('click', closeNotification, { once: true });
                }
            }

            function showCalendarModal() {
                dom.calendarModalOverlay.classList.remove('hidden');
                dom.calendarModalOverlay.classList.add('flex');
                // The calendar modal position is controlled by CSS, so it appears centered.
                if (!currentCalendarView) currentCalendarView = 'month'; 
                renderCalendarView();
            }

            function hideCalendarModal() {
                dom.calendarModalOverlay.classList.add('hidden');
                dom.calendarModalOverlay.classList.remove('flex');
            }

            function renderMonthView() {
                dom.calendarDaysGrid.innerHTML = '';
                dom.currentMonthYear.textContent = selectedCalendarDate.format('MMMMYYYY');
                const startDay = selectedCalendarDate.startOf('month').startOf('isoWeek');

                for (let i = 0; i < 42; i++) {
                    const day = startDay.add(i, 'day');
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.dataset.date = day.format('YYYY-MM-DD');

                    dayEl.innerHTML = `<span class="calendar-day-number">${day.date()}</span><div class="calendar-day-tasks"></div>`;

                    if (day.month() === selectedCalendarDate.month()) {
                        dayEl.classList.add('current-month');
                    } else {
                        dayEl.classList.add('other-month');
                    }
                    if (day.isSame(dayjs(), 'day')) {
                        dayEl.classList.add('today');
                    }

                    const tasksContainer = dayEl.querySelector('.calendar-day-tasks');
                    const tasksForDay = getTasksForDay(day.format('YYYY-MM-DD'));
                    tasksForDay.slice(0, 3).forEach(task => { // Limit to 3 tasks to avoid clutter
                        const taskEl = document.createElement('div');
                        taskEl.className = 'calendar-day-task';
                        taskEl.textContent = task.text;
                        taskEl.style.backgroundColor = getLabelColor(task.source === 'Personal' ? 'Personal' : (task.labels && task.labels[0] ? task.labels[0] : 'default'));
                        taskEl.draggable = true;
                        taskEl.dataset.taskId = task.id;
                        taskEl.dataset.taskSource = task.source;
                        taskEl.innerHTML = `
                            ${task.text}
                            <i class="fas fa-times delete-task-icon" data-task-id="${task.id}" data-task-source="${task.source}"></i>
                        `;
                        tasksContainer.appendChild(taskEl);
                    });

                    dayEl.addEventListener('click', (e) => {
                        if(e.target.classList.contains('delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(e.target.dataset.taskId);
                        } else if(e.target === e.currentTarget || e.target.classList.contains('calendar-day-tasks')) {
                             editCalendarTask(null, day.format('YYYY-MM-DD'));
                        } else if(e.target.closest('.calendar-day-task')) {
                            const taskEl = e.target.closest('.calendar-day-task');
                            handleTaskClick(taskEl.dataset.taskId, taskEl.dataset.taskSource);
                        }
                    });
                    dayEl.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    dayEl.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    dayEl.addEventListener('drop', handleCalendarDrop);
                    tasksContainer.querySelectorAll('.calendar-day-task').forEach(t => t.addEventListener('dragstart', handleCalendarDragStart));
                    tasksContainer.querySelectorAll('.calendar-day-task').forEach(t => t.addEventListener('touchstart', handleTouchStart, {passive: false}));

                    dom.calendarDaysGrid.appendChild(dayEl);
                }
            }
            
            function renderWeekView() {
                dom.weekDaysContent.innerHTML = '';
                let startOfWeek = selectedCalendarDate.startOf('isoWeek');

                const endOfWeek = startOfWeek.add(6, 'day');
                dom.currentWeekRange.textContent = `${startOfWeek.format('D MMM')} - ${endOfWeek.format('D MMM,YYYY')}`;

                for (let i = 0; i < 7; i++) {
                    const day = startOfWeek.add(i, 'day');
                    const dayKey = day.format('YYYY-MM-DD');
                    const tasks = getTasksForDay(dayKey);
                    const lang = localStorage.getItem('goatify-lang') || 'es';
                    const displayDate = day.format('dddd, D MMM');
                    const daySection = document.createElement('div');
                    daySection.className = 'week-day-section';
                    daySection.dataset.date = dayKey;

                    daySection.innerHTML = `
                        <h5>
                            <span>${displayDate}</span>
                            <button class="add-task-to-day-btn text-lg hover:text-primary" data-date="${dayKey}">+</button>
                        </h5>
                        <div class="space-y-1">
                            ${tasks.length === 0 ? `<p class="text-xs text-text-medium italic">${translations[lang].calendar_no_tasks}</p>` : ''}
                            ${tasks.map((task) => {
                                const isPersonal = task.source === 'Personal';
                                return `
                                <div class="task-item flex items-center gap-2 cursor-pointer ${task.completed ? 'task-item-completed' : ''}" 
                                     draggable="true" data-task-id="${task.id}" data-task-source="${task.source}">
                                     <input type="checkbox" class="task-checkbox flex-shrink-0" data-task-id="${task.id}" ${task.completed ? 'checked' : ''}>
                                    <span class="flex-grow">${task.text} ${task.time ? `(${task.time})` : ''} <span class="text-xs text-primary">(${task.source})</span></span>
                                    <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            `}).join('')}
                        </div>
                     `;
                    dom.weekDaysContent.appendChild(daySection);
                    daySection.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    daySection.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    daySection.addEventListener('drop', handleCalendarDrop);
                    daySection.addEventListener('click', (e) => {
                         if(e.target === e.currentTarget || e.target.classList.contains('space-y-1')) {
                            editCalendarTask(null, dayKey);
                        }
                    });
                }

                dom.weekDaysContent.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        updateTaskStatus(e.currentTarget.dataset.taskId, { completed: e.currentTarget.checked });
                    });
                 });

                dom.weekDaysContent.querySelectorAll('.task-item').forEach(item => {
                    item.addEventListener('dragstart', handleCalendarDragStart);
                    item.addEventListener('touchstart', handleTouchStart, {passive: false});
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(item.dataset.taskId);
                            return;
                        }
                        if (e.target.type === 'checkbox') return;
                        handleTaskClick(item.dataset.taskId, item.dataset.taskSource);
                     });
                });
                dom.weekDaysContent.querySelectorAll('.add-task-to-day-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const date = e.currentTarget.dataset.date;
                        editCalendarTask(null, date);
                    });
                });
            }

            function renderDayView() {
                dom.currentDayDisplay.textContent = selectedCalendarDate.format('dddd, D [de] MMMM');
                dom.dayViewTimeline.innerHTML = '';
                const tasksForDay = getTasksForDay(selectedCalendarDate.format('YYYY-MM-DD'));
                
                for (let hour = 0; hour < 24; hour++) {
                    const hourEl = document.createElement('div');
                    hourEl.className = 'day-view-hour';
                    const hourLabel = (hour < 10 ? '0' : '') + hour + ':00';
                    hourEl.dataset.time = hourLabel.substring(0,2); // "09"
                    const tasksInHour = tasksForDay.filter(t => t.time && t.time.startsWith((hour < 10 ? '0' : '') + hour));
                    hourEl.innerHTML = `
                        <div class="day-view-hour-label">${hourLabel}</div>
                        <div class="day-view-hour-content" data-time="${hourLabel}" data-date="${selectedCalendarDate.format('YYYY-MM-DD')}">
                            ${tasksInHour.map((task) => `
                                <div class="task-item flex items-center gap-2 p-1 rounded-md ${task.completed ? 'bg-green-900/50 text-gray-400 line-through' : 'bg-input'} text-sm" 
                                     draggable="true" data-task-id="${task.id}" data-task-source="${task.source}">
                                    <input type="checkbox" class="task-checkbox flex-shrink-0" data-task-id="${task.id}" ${task.completed ? 'checked' : ''}>
                                     <span class="flex-grow cursor-pointer"><strong>${task.time}:</strong> ${task.text} <span class="text-xs text-primary">(${task.source})</span></span>
                                     <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            `).join('')}
                             <button class="add-task-to-time-btn text-lg hover:text-primary" data-date="${selectedCalendarDate.format('YYYY-MM-DD')}" data-time="${hourLabel}">+</button>
                        </div>
                    `;
                    dom.dayViewTimeline.appendChild(hourEl);

                    const hourContent = hourEl.querySelector('.day-view-hour-content');
                    hourContent.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    hourContent.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    hourContent.addEventListener('drop', handleCalendarDrop);
                     hourContent.addEventListener('click', (e) => {
                         if(e.target === e.currentTarget) {
                            editCalendarTask(null, selectedCalendarDate.format('YYYY-MM-DD'), e.currentTarget.dataset.time);
                        }
                    });
                }
                dom.dayViewTimeline.querySelectorAll('.add-task-to-time-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const date = e.currentTarget.dataset.date;
                         const time = e.currentTarget.dataset.time;
                        editCalendarTask(null, date, time);
                    });
                });
                dom.dayViewTimeline.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        updateTaskStatus(e.currentTarget.dataset.taskId, { completed: e.currentTarget.checked });
                    });
                });
                dom.dayViewTimeline.querySelectorAll('.task-item').forEach(item => {
                    item.addEventListener('dragstart', handleCalendarDragStart);
                    item.addEventListener('touchstart', handleTouchStart, {passive: false});
                    item.addEventListener('click', (e) => {
                         if (e.target.closest('.delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(item.dataset.taskId);
                            return;
                        }
                        if (e.target.type === 'checkbox') return;
                        handleTaskClick(item.dataset.taskId, item.dataset.taskSource);
                    });
                 });
            }

            function handleTaskClick(taskId, taskSource) {
                 if (taskSource === 'Personal') {
                    editCalendarTask(taskId);
                } else {
                    const projectChat = Object.values(state.chats).find(c => c.projectData && c.projectData.title === taskSource);
                    if (projectChat) {
                        editProjectTask(projectChat.id, taskId);
                    }
                }
            }
            
            let draggedCalendarTaskId = null;
            function handleCalendarDragStart(e) {
                const target = e.target.closest('[draggable="true"]');
                if (!target) return;
                draggedCalendarTaskId = target.dataset.taskId;
                e.dataTransfer.setData('text/plain', draggedCalendarTaskId);
                e.dataTransfer.effectAllowed = 'move';
            }
            
            function handleCalendarDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.style.backgroundColor = '';
                const taskId = e.dataTransfer.getData('text/plain');
                if (!taskId) return;

                const dropZone = e.currentTarget;
                const newDate = dropZone.dataset.date;
                let newTime = dropZone.dataset.time || findTask(taskId)?.task?.time || null; 
                
                if (newTime && newTime.length === 2) { 
                   const originalTask = findTask(taskId)?.task;
                   const originalMinutes = originalTask?.time?.substring(3,5) || '00';
                   newTime = `${newTime}:${originalMinutes}`;
                }
                
                const updates = { date: newDate, time: newTime };
                updateTaskStatus(taskId, updates);
            }

            let touchDragElement = null, ghostElement = null;
            function handleTouchStart(e) {
                if (e.touches.length !== 1) return;
                const target = e.target.closest('[draggable="true"]');
                if (!target) return;
                
                touchDragElement = target;
                
                ghostElement = touchDragElement.cloneNode(true);
                ghostElement.style.position = 'absolute';
                ghostElement.style.zIndex = '1000';
                ghostElement.style.opacity = '0.7';
                ghostElement.style.pointerEvents = 'none';
                ghostElement.style.width = `${touchDragElement.offsetWidth}px`;
                document.body.appendChild(ghostElement);
                
                const touch = e.touches[0];
                ghostElement.style.left = `${touch.pageX - ghostElement.offsetWidth / 2}px`;
                ghostElement.style.top = `${touch.pageY - ghostElement.offsetHeight / 2}px`;

                document.addEventListener('touchmove', handleTouchMove, {passive: false});
                document.addEventListener('touchend', handleTouchEnd);
            }
            function handleTouchMove(e) {
                if (e.touches.length !== 1 || !ghostElement) return;
                e.preventDefault();
                const touch = e.touches[0];
                ghostElement.style.left = `${touch.pageX - ghostElement.offsetWidth / 2}px`;
                ghostElement.style.top = `${touch.pageY - ghostElement.offsetHeight / 2}px`;
            }
            function handleTouchEnd(e) {
                if (!ghostElement) return;
                
                ghostElement.style.display = 'none';
                const dropTarget = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
                ghostElement.remove();
                
                if (dropTarget) {
                    const dropZone = dropTarget.closest('.calendar-day, .week-day-section, .day-view-hour-content, .kanban-cards, .list-view-column-mobile, .list-view-content > h4');
                    if(dropZone) {
                        const taskId = touchDragElement.dataset.taskId;
                        if (dropZone.classList.contains('kanban-cards')) {
                            const chatId = currentChatId;
                            const columnId = dropZone.dataset.columnId;
                            moveTask(chatId, taskId, columnId);
                        } else if(dropZone.classList.contains('list-view-column-mobile')) {
                            const chatId = currentChatId;
                            const columnId = dropZone.dataset.columnId;
                            moveTask(chatId, taskId, columnId);
                        } else if (dropZone.tagName === 'H4' && dropZone.closest('#list-view')) {
                             const columnTitle = dropZone.textContent.trim();
                             const chat = state.chats[currentChatId];
                             const targetColumn = chat.projectData.columns.find(c => c.title === columnTitle);
                             if (targetColumn) {
                                 moveTask(currentChatId, taskId, targetColumn.id);
                             }
                        }
                        else {
                            const newDate = dropZone.dataset.date;
                            let newTime = dropZone.dataset.time || findTask(taskId)?.task?.time || null;
                            if (newTime && newTime.length === 2) {
                                const originalTask = findTask(taskId)?.task;
                                const originalMinutes = originalTask?.time?.substring(3,5) || '00';
                                newTime = `${newTime}:${originalMinutes}`;
                            }
                            updateTaskStatus(taskId, { date: newDate, time: newTime });
                        }
                    }
                }
                
                touchDragElement = null; ghostElement = null;
                document.removeEventListener('touchmove', handleTouchMove);
                document.removeEventListener('touchend', handleTouchEnd);
            }

            function findTask(taskId) {
                if (!taskId) return null;
                if (taskId.startsWith('cal-')) {
                    for (const dayKey in state.calendar) {
                        const taskIndex = (state.calendar[dayKey] || []).findIndex(t => t.id === taskId);
                        if (taskIndex > -1) {
                            return { type: 'personal', task: state.calendar[dayKey][taskIndex], dayKey, taskIndex };
                        }
                    }
                } else if (taskId.startsWith('proj-')) {
                    for (const chat of Object.values(state.chats)) {
                        if (chat.projectData && chat.projectData.columns) {
                            for (const column of chat.projectData.columns) {
                                const taskIndex = (column.tasks || []).findIndex(t => t.id === taskId);
                                if (taskIndex > -1) {
                                     return { type: 'project', task: column.tasks[taskIndex], chat, column, taskIndex };
                                }
                            }
                        }
                    }
                }
                return null;
            }

            function updateTaskStatus(taskId, updates) {
                const found = findTask(taskId);
                if (!found) return;

                if (found.type === 'personal') {
                    const { task, dayKey } = found;
                    const oldDate = dayKey;
                    const newDate = updates.date || oldDate;
                    
                    if (oldDate !== newDate) {
                        const taskIndex = state.calendar[oldDate].findIndex(t => t.id === taskId);
                        const [taskToMove] = state.calendar[oldDate].splice(taskIndex, 1);
                        if(state.calendar[oldDate].length === 0) delete state.calendar[oldDate];
                        
                        if (!state.calendar[newDate]) state.calendar[newDate] = [];
                        Object.assign(taskToMove, updates);
                        delete taskToMove.date;
                        state.calendar[newDate].push(taskToMove);
                    } else {
                        delete updates.date;
                        Object.assign(task, updates);
                    }
                } 
                else if (found.type === 'project') {
                    const { task, chat } = found;
                    const originalCompleted = task.completed;
                    Object.assign(task, updates);

                    if (updates.completed !== undefined && updates.completed !== originalCompleted) {
                        let sourceColumn, taskIndex;
                        for(const col of chat.projectData.columns){
                            const idx = (col.tasks || []).findIndex(t => t.id === taskId);
                            if(idx > -1){
                                sourceColumn = col;
                                taskIndex = idx;
                                break;
                            }
                        }

                        if (sourceColumn) {
                            const [taskToMove] = sourceColumn.tasks.splice(taskIndex, 1);
                            if (task.completed) {
                                const doneColumn = chat.projectData.columns.find(c => c.id === 'done');
                                if (doneColumn && sourceColumn.id !== 'done') doneColumn.tasks.push(taskToMove);
                                else sourceColumn.tasks.push(taskToMove); 
                            } else {
                                const todoColumn = chat.projectData.columns.find(c => c.id === 'todo');
                                if (todoColumn && sourceColumn.id === 'done') todoColumn.tasks.push(taskToMove);
                                else sourceColumn.tasks.push(taskToMove);
                            }
                        }
                    }
                }

                saveState();
                if (dom.calendarModalOverlay.classList.contains('flex')) {
                    renderCalendarView();
                }
                if (dom.projectManagementView.style.display === 'flex') {
                    renderProjectBoard(currentChatId);
                }
            }


            function getTasksForDay(dayKey) {
                const calendarTasks = (state.calendar[dayKey] || []).map(t => ({...t, text: t.content, source: 'Personal'}));
                const projectTasks = [];
                Object.values(state.chats).forEach(chat => {
                    if (chat.projectData && chat.projectData.columns) {
                        chat.projectData.columns.forEach(column => {
                            (column.tasks || []).forEach(task => {
                                 if (task.dueDate === dayKey) {
                                    projectTasks.push({...task, source: chat.projectData.title, text: task.content});
                                }
                             });
                        });
                    }
                });
                return [...calendarTasks, ...projectTasks].sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
            }


            function updateNotificationBadge() {
                 let pendingNotifications = 0;
                const now = dayjs();
                Object.keys(state.calendar).forEach(dayKey => {
                    const tasksForDay = getTasksForDay(dayKey);
                    tasksForDay.forEach(task => {
                         if (!task.completed) {
                            if (task.time) {
                                const taskDateTime = dayjs(`${dayKey}T${task.time}`);
                                if (taskDateTime.isBefore(now)) {
                                     pendingNotifications++;
                                }
                            } else {
                                const taskDate = dayjs(dayKey);
                                if (taskDate.isBefore(now, 'day') || taskDate.isSame(now, 'day')) {
                                    pendingNotifications++;
                                }
                            }
                         }
                    });
                });
                
                const badgeEl = document.getElementById('notification-badge');

                if (pendingNotifications > 0) {
                    badgeEl.textContent = pendingNotifications;
                    badgeEl.classList.remove('hidden');
                } else {
                    badgeEl.classList.add('hidden');
                }
            }

            // Function to request and handle push notifications outside the browser
            function requestPushNotificationPermission() {
                if ('Notification' in window && Notification.permission !== "granted" && Notification.permission !== "denied" && 'serviceWorker' in navigator) {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            navigator.serviceWorker.ready.then(registration => {
                                registration.pushManager.subscribe({
                                    userVisibleOnly: true,
                                    applicationServerKey: urlBase64ToUint8Array('YOUR_PUBLIC_VAPID_KEY') // Replace with your VAPID key
                                }).then(subscription => {
                                    console.log('Push notification subscribed:', subscription);
                                    // Send subscription to your server to save it
                                }).catch(error => {
                                    console.error('Push subscription failed:', error);
                                });
                            });
                        }
                    });
                }
            }

            function urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding)
                    .replace(/\-/g, '+')
                    .replace(/_/g, '/');

                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);

                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }


            function checkAndNotifyTasks() {
                if (!notificationsEnabled) return;
                const now = dayjs();
                const todayKey = now.format('YYYY-MM-DD');
                const currentHourMinute = now.format('HH:mm');
                const allTasksToday = getTasksForDay(todayKey);
                allTasksToday.forEach(task => {
                    if (!task.completed && task.time === currentHourMinute && !task.notifiedThisMinute) {
                        const lang = localStorage.getItem('goatify-lang') || 'es';
                        const notificationTitle = translations[lang].notification_title;
                        const notificationBody = `<p class="glowing-text text-xl">${translations[lang].notification_task_due} ${task.text} (${task.time})</p>`;
                        
                        showInAppNotification(
                            `<i class="fas fa-bell animate-tada text-yellow-400 mr-2"></i> ${notificationTitle}`,
                            notificationBody,
                            null, // Keep on screen until dismissed by user
                            task.id // Pass task ID for snooze/done functionality
                        );

                        // Also send native push notification if permission granted
                        if (Notification.permission === "granted") {
                            // Ensure service worker is registered for push notifications
                            navigator.serviceWorker.ready.then(registration => {
                                registration.showNotification(notificationTitle, {
                                    body: `${translations[lang].notification_task_due} ${task.text} (${task.time})`,
                                    icon: './Logos HD.png',
                                    vibrate: [200, 100, 200],
                                    tag: task.id // Tag to replace existing notifications for this task
                                });
                            });
                        }
                        
                        updateTaskNotifiedFlag(task.id, true);
                    }
                });
                allTasksToday.forEach(task => {
                    // Reset notifiedThisMinute flag if time has passed
                    if (task.notifiedThisMinute && task.time !== currentHourMinute) {
                        updateTaskNotifiedFlag(task.id, false);
                    }
                });
                saveState();
                updateNotificationBadge();
            }

            function updateTaskNotifiedFlag(taskId, isNotified) {
                const found = findTask(taskId);
                if (found) {
                    found.task.notifiedThisMinute = isNotified;
                }
            }


            function renderCalendarView() {
                 dom.dayViewContainer.style.display = currentCalendarView === 'day' ? 'block' : 'none';
                dom.weekViewContainer.style.display = currentCalendarView === 'week' ? 'block' : 'none';
                dom.monthViewContainer.style.display = currentCalendarView === 'month' ? 'block' : 'none';
                
                dom.dayViewBtn.classList.toggle('active', currentCalendarView === 'day');
                dom.weekViewBtn.classList.toggle('active', currentCalendarView === 'week');
                dom.monthViewBtn.classList.toggle('active', currentCalendarView === 'month');

                if (currentCalendarView === 'day') renderDayView();
                if (currentCalendarView === 'week') renderWeekView();
                if (currentCalendarView === 'month') renderMonthView();
            }

            // Check for notifications every 10 seconds
            setInterval(checkAndNotifyTasks, 10 * 1000);

            function setupNotifications() {
                if ("Notification" in window) {
                    if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                        Notification.requestPermission().then(permission => {
                            if (permission === "denied") {
                                console.warn("El usuario ha denegado los permisos de notificacin.");
                            } else if (permission === "granted") {
                                // Also attempt to register for Push API if supported
                                requestPushNotificationPermission();
                            }
                        });
                    } else if (Notification.permission === "granted") {
                        requestPushNotificationPermission(); // Ensure push is enabled if already granted
                    } else if (Notification.permission === "denied") {
                         console.warn("Los permisos de notificacin fueron denegados previamente.");
                    }
                } else {
                    console.warn("Este navegador no soporta notificaciones de escritorio.");
                }
            }

            function speak(text) { 
                if (!speechOn || !('speechSynthesis' in window) || !text) return;
                speechSynthesis.cancel();
                micWasOnBeforeSpeaking = isRecognizing;
                if (isRecognizing) { recognition.stop(); }
                const cleanText = text.replace(/<[^>]*>/g, '').replace(/[*_`#~[\]()]|(-{3,})/g, '');
                const utterance = new SpeechSynthesisUtterance(cleanText); 
                if (selectedVoice) { utterance.voice = selectedVoice;
                }
                utterance.rate = 1.5; // Increased speech rate
                utterance.onend = () => {
                    if (micWasOnBeforeSpeaking) {
                        if (recognition && !isRecognizing) {
                            try { recognition.start(); } catch(e) { console.error("Error restarting recognition:", e); }
                        }
                        micWasOnBeforeSpeaking = false;
                    }
                    toggleVoiceSelectorVisibility(false);
                };
                utterance.onerror = (e) => {
                    console.error('Speech synthesis error:', e);
                    if (micWasOnBeforeSpeaking) {
                        if (recognition && !isRecognizing) {
                           try { recognition.start(); } catch(e) { console.error("Error restarting recognition on error:", e); }
                        }
                        micWasOnBeforeSpeaking = false;
                    }
                     toggleVoiceSelectorVisibility(false);
                }
                speechSynthesis.speak(utterance);
            }

            function populateVoiceList() {
                const setVoices = () => {
                    if (typeof speechSynthesis === 'undefined') { return; }
                    availableVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('es-') || v.lang.startsWith('en-'));
                    const preferredVoices = [ "Microsoft Sabina Online (Natural) - Spanish (Mexico)", "Paulina", "Google espaol de Estados Unidos", "Google espaol" ];
                    availableVoices.sort((a, b) => {
                        let aIdx = preferredVoices.indexOf(a.name); let bIdx = preferredVoices.indexOf(b.name);
                        if (aIdx === -1) aIdx = Infinity; if (bIdx === -1) bIdx = Infinity;
                        if (aIdx !== bIdx) return aIdx - bIdx;
                        return a.name.localeCompare(b.name);
                    });
                    
                    if (availableVoices.length > 0) {
                        dom.voiceSelector.innerHTML = '';
                        availableVoices.forEach(voice => {
                            const option = document.createElement('option');
                            const displayName = voice.name.replace('Microsoft', '').replace('Online (Natural) -', '').replace('Google', '').replace('Spanish (Mexico)','Mex').trim();
                            option.textContent = `${displayName || voice.lang} (${voice.lang})`;
                            option.value = voice.name;
                            dom.voiceSelector.appendChild(option);
                        });
                        selectedVoice = availableVoices[0];
                        if (selectedVoice) dom.voiceSelector.value = selectedVoice.name;
                    }
                }
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = setVoices;
                }
                setVoices();
            }

            function getModelForRequest(workflow, hasFile, assistantType) {
                let selector;
                switch (assistantType) {
                    case 'project':
                        selector = document.getElementById('project-model-selector');
                        break;
                    case 'financial':
                        selector = document.getElementById('financial-model-selector');
                        break;
                    case 'notepad':
                        selector = document.getElementById('notepad-model-selector');
                        break;
                    default:
                        selector = dom.modelSelector;
                }

                if (workflow === "design-web") return "gpt-4o-mini";
                if (hasFile) return "gpt-4o-mini"; 
                
                const selectedModel = selector.value;
                const currentGoatXProLimit = getGoatXProDailyLimit(); // Get dynamic limit

                if (selectedModel === 'gpt-4o' && currentGoatXProLimit !== Infinity && goatXProUsage >= currentGoatXProLimit) {
                    showModal({
                        title: 'Lmite de Uso Alcanzado para GOAT X PRO',
                        body: `Has alcanzado el lmite de ${currentGoatXProLimit} usos diarios para el modelo GOAT X PRO. Por favor, usa el modelo GOAT X (General) o espera hasta maana para volver a usar GOAT X PRO.`,
                        confirmText: 'Entendido',
                        showCancel: false
                    }).then(() => {
                        selector.value = 'gpt-3.5-turbo-1106'; 
                    });
                    return 'gpt-3.5-turbo-1106'; // Force switch to default model
                }

                if (selectedModel === 'gpt-4o' && (!currentUser || (currentUser.app_metadata?.plan || 'free') === 'free')) { 
                     showInAppNotification("Acceso Restringido", "El modelo GOAT X PRO est disponible solo para usuarios con un plan de pago.", 3000); 
                     selector.value = 'gpt-3.5-turbo-1106'; 
                     return 'gpt-3.5-turbo-1106';
                }
                return selectedModel;
            }

            async function getAIResponse(prompt, history, image, pdf, model, workflow, userName, financialData = null, noteContent = null) {
                const name = (userName || '').split(' ')[0];
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }
                const body = { 
                    prompt, history, model,
                    workflow, userName: name, title,
                    imageData: image, pdfText: pdf, 
                    financialData, noteContent,
                 };
                try {
                    const response = await fetch('/.netlify/functions/get-ai-response', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(body),
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({details: 'Error desconocido en el servidor'}));
                        console.error("Backend Error:", errorData);
                        throw new Error(errorData.details || `Error del servidor: ${response.status}.`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("Fetch Error:", error);
                    throw error;
                }
            }
            
            function getCreditCount() {
                if (!currentUser) { // Guest user
                    const usageData = JSON.parse(localStorage.getItem('guest_usage')) || { count: 0 };
                    return { remaining: Math.max(0, GUEST_CREDIT_LIMIT - usageData.count), limit: GUEST_CREDIT_LIMIT };
                }

                // Logged-in user
                const plan = currentUser.app_metadata?.plan || 'free';
                let limit;
                switch (plan) {
                    case 'boost': limit = BOOST_PLAN_CREDIT_LIMIT; break;
                    case 'pro': limit = PRO_PLAN_CREDIT_LIMIT; break;
                    default: limit = FREE_PLAN_CREDIT_LIMIT;
                }

                const usageKey = `usage_monthly_${currentUser.id}`;
                const currentMonth = dayjs().format('YYYY-MM');
                const usageData = JSON.parse(localStorage.getItem(usageKey)) || { count: 0, month: '' };

                if (usageData.month !== currentMonth) {
                    return { remaining: limit, limit }; // New month, full credits
                }
                
                return { remaining: Math.max(0, limit - usageData.count), limit };
            }

            function spendCredits(cost, modelUsed) {
                const currentGoatXProLimit = getGoatXProDailyLimit(); // Get dynamic limit

                // Check daily GOAT X PRO limit first
                if (modelUsed === 'gpt-4o' && currentGoatXProLimit !== Infinity) {
                    const today = dayjs().format('YYYY-MM-DD');
                    const proUsageKey = `goat_x_pro_usage_${currentUser?.id || 'guest'}_${today}`;
                    goatXProUsage = parseInt(localStorage.getItem(proUsageKey) || '0');

                    if (goatXProUsage >= currentGoatXProLimit) {
                        showModal({
                            title: 'Lmite de Uso Alcanzado para GOAT X PRO',
                            body: `Has alcanzado el lmite de ${currentGoatXProLimit} usos diarios para el modelo GOAT X PRO. Por favor, usa el modelo GOAT X (General) o espera hasta maana para volver a usar GOAT X PRO.`,
                            confirmText: 'Entendido',
                            showCancel: false
                        }).then(() => {
                            // Automatically switch back to default model after showing popup
                            dom.modelSelector.value = 'gpt-3.5-turbo-1106';
                            if (document.getElementById('project-model-selector')) document.getElementById('project-model-selector').value = 'gpt-3.5-turbo-1106';
                            if (document.getElementById('financial-model-selector')) document.getElementById('financial-model-selector').value = 'gpt-3.5-turbo-1106';
                            if (document.getElementById('notepad-model-selector')) document.getElementById('notepad-model-selector').value = 'gpt-3.5-turbo-1106';
                        });
                        return false;
                    }
                }

                // Gamification coins can only be used by logged-in users
                if (currentUser && gamificationState.credits >= cost) {
                    gamificationState.credits -= cost;
                    saveGamificationState();
                    updateCreditCounter();
                    showInAppNotification("Crdito de Recompensa Usado", `Se ha utilizado un crdito de recompensa. Te quedan ${gamificationState.credits}.`, 500); // Shorter duration
                    
                    if (modelUsed === 'gpt-4o' && currentGoatXProLimit !== Infinity) { // Only increment if not unlimited
                        const today = dayjs().format('YYYY-MM-DD');
                        const proUsageKey = `goat_x_pro_usage_${currentUser?.id || 'guest'}_${today}`;
                        goatXProUsage++;
                        localStorage.setItem(proUsageKey, goatXProUsage.toString());
                    }
                    return true;
                }

                // Guest credit logic
                if (!currentUser) {
                    const usageKey = 'guest_usage';
                    let usageData = JSON.parse(localStorage.getItem(usageKey)) || { count: 0 };
                    if (usageData.count + cost > GUEST_CREDIT_LIMIT) {
                         showModal({
                            title: 'Crditos de Invitado Agotados',
                            body: `<p>Has utilizado tus ${GUEST_CREDIT_LIMIT} crditos de invitado. <strong>Inicia sesin para obtener 50 crditos mensuales ms, gratis!</strong></p><p class="mt-2 text-sm text-text-medium">Tambin puedes usar este link para agendar una reunin y conocer nuestros planes.</p>`, // Added text for meeting
                            confirmText: 'Iniciar Sesin',
                            cancelText: 'Ms Tarde',
                            extraButtons: [{ // Added extra button for meeting
                                id: 'guest-meeting-btn',
                                classes: 'px-4 py-2 rounded bg-primary text-white',
                                text: 'Agendar Reunin',
                                action: () => {
                                    window.open('https://calendly.com/goatify', '_blank');
                                    hideModal(); // Close modal after action
                                }
                            }]
                        }).then(res => { if (res.confirmed) { netlifyIdentity.open('login'); } });
                        return false;
                    }
                    usageData.count += cost;
                    localStorage.setItem(usageKey, JSON.stringify(usageData));
                    updateCreditCounter();

                    if (modelUsed === 'gpt-4o' && currentGoatXProLimit !== Infinity) { // Only increment if not unlimited
                        const today = dayjs().format('YYYY-MM-DD');
                        const proUsageKey = `goat_x_pro_usage_${currentUser?.id || 'guest'}_${today}`;
                        goatXProUsage++;
                        localStorage.setItem(proUsageKey, goatXProUsage.toString());
                    }
                    return true;
                }

                // Logged-in user credit logic
                const { remaining } = getCreditCount();
                if (remaining < cost) {
                    showModal({
                        title: 'Crditos Insuficientes',
                        body: 'No tienes suficientes crditos este mes. Mejora tu plan para obtener ms o espera al prximo mes.',
                        confirmText: 'Ver Planes'
                    }).then(res => { if (res.confirmed) showPricingModal(); });
                    return false;
                }

                const usageKey = `usage_monthly_${currentUser.id}`;
                const currentMonth = dayjs().format('YYYY-MM');
                let usageData = JSON.parse(localStorage.getItem(usageKey)) || { count: 0, month: '' };

                if (usageData.month !== currentMonth) {
                    usageData = { count: 0, month: currentMonth };
                }
                
                usageData.count += cost;
                localStorage.setItem(usageKey, JSON.stringify(usageData));
                updateCreditCounter();

                if (modelUsed === 'gpt-4o' && currentGoatXProLimit !== Infinity) { // Only increment if not unlimited
                    const today = dayjs().format('YYYY-MM-DD');
                    const proUsageKey = `goat_x_pro_usage_${currentUser?.id || 'guest'}_${today}`;
                    goatXProUsage++;
                    localStorage.setItem(proUsageKey, goatXProUsage.toString());
                }
                return true;
            }

            async function loadStateForUser() {
                const loadLocalStorage = (key) => {
                    const saved = localStorage.getItem(key);
                    return saved ? JSON.parse(saved) : {};
                };

                if (!currentUser) {
                    const guestData = loadLocalStorage('guestState');
                    state = guestData.state || { chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
                    currentChatId = guestData.currentChatId || null;
                } else {
                     try {
                        const response = await fetch('/.netlify/functions/load-chats', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId: currentUser.id }),
                        });
                        if (!response.ok) { throw new Error(`Server error: ${response.status}`); }
                        const dbState = await response.json();
                        state = dbState.state || { chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
                        currentChatId = dbState.currentChatId;
                    } catch (error) {
                        console.error("Could not load from DB, falling back to localStorage:", error);
                        const userLocalData = loadLocalStorage(`goatbotState_${currentUser.id}`);
                        state = userLocalData.state || { chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
                        currentChatId = userLocalData.currentChatId;
                    }
                }

                state.calendar = state.calendar || {};
                state.projects = state.projects || {};
                state.chats = state.chats || {};
                state.structure = state.structure || [];
                state.notes = state.notes || [];

                // Ensure notepad-assistant-chat exists and is not deletable
                if (!state.chats['notepad-assistant-chat']) {
                    state.chats['notepad-assistant-chat'] = {
                        id: 'notepad-assistant-chat',
                        title: 'Asistente de Redaccin',
                        messages: [{ role: 'assistant', content: 'Hola! Soy tu asistente de redaccin. Pega tu texto aqu o pdeme ideas para empezar. Tambin puedo corregir tu ortografa y gramtica.' }], /* Updated message */
                        workflow: 'notepad-assistant',
                        isDeletable: false,
                    };
                }

                // Initialize goatXProUsage for the current day
                const today = dayjs().format('YYYY-MM-DD');
                const proUsageKey = `goat_x_pro_usage_${currentUser?.id || 'guest'}_${today}`;
                goatXProUsage = parseInt(localStorage.getItem(proUsageKey) || '0');

                loadGamificationState();
                renderSidebar();
                selectChat(currentChatId);
            }

            async function saveState() {
                const stateData = { state, currentChatId };
                const key = currentUser ? `goatbotState_${currentUser.id}` : 'guestState';
                
                try {
                    localStorage.setItem(key, JSON.stringify(stateData));
                    if(currentUser) {
                        await fetch('/.netlify/functions/save-chats', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId: currentUser.id, stateToSave: stateData }),
                        });
                    }
                } catch (error) {
                    console.error("Failed to save state:", error);
                }
            }
            
            function updateUserUI() {
                const goatXProModels = document.querySelectorAll('.goat-x-pro-model');
                if (currentUser) {
                    dom.loginView.classList.add('hidden');
                    dom.userMenuView.classList.remove('hidden');
                    dom.genericWelcome.classList.add('hidden');
                    dom.personalizedWelcome.classList.remove('hidden');
                    const userName = currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.email.split('@')[0];
                    dom.userEmail.textContent = currentUser.user_metadata?.full_name || currentUser.email;
                    dom.userName.textContent = userName;
                    dom.upgradePlanContainer.classList.toggle('hidden', (currentUser.app_metadata?.plan || 'free') !== 'free');
                    goatXProModels.forEach(option => option.disabled = false);

                } else {
                    dom.loginView.classList.remove('hidden');
                    dom.userMenuView.classList.add('hidden');
                    dom.genericWelcome.classList.remove('hidden');
                    dom.personalizedWelcome.classList.add('hidden');
                    dom.upgradePlanContainer.classList.add('hidden');
                    goatXProModels.forEach(option => option.disabled = true);
                }
                updateCreditCounter();
            }

            function updateCreditCounter() {
                const { remaining, limit } = getCreditCount();
                const gamCredits = (currentUser && gamificationState.credits) ? gamificationState.credits : 0;
                let displayLimit = limit === Infinity ? '' : limit;

                // Update individual spans for plan and reward credits
                if (dom.planCreditsDisplay) dom.planCreditsDisplay.textContent = `${remaining}/${displayLimit}`;
                if (dom.rewardCreditsDisplay) dom.rewardCreditsDisplay.textContent = `${gamCredits}`;
                
                // Ensure the counter is visible on desktop
                if (dom.messageCounterEl) {
                    if (window.innerWidth >= 768) { // Only show on desktop
                        dom.messageCounterEl.style.display = 'block';
                    } else {
                        dom.messageCounterEl.style.display = 'none';
                    }
                }
            }

            function setTheme(isDark) { 
                document.body.className = 'w-screen overflow-x-hidden';
                document.body.classList.add(isDark ? 'dark-theme' : 'light-theme');
                dom.themeIcon.className = `fas fa-${isDark ? 'sun' : 'moon'}`; 
                if (dom.settingsThemeIcon) dom.settingsThemeIcon.className = `fas fa-${isDark ? 'moon' : 'sun'} mr-2`;
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            }

            function toggleSidebar(show) {
                const sidebar = dom.sidebar;
                if (show) {
                    sidebar.classList.add('is-open');
                    sidebar.classList.remove('collapsed'); 
                    dom.sidebarOverlay.classList.remove('opacity-0', 'pointer-events-none');
                    dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-right', 'fa-chevron-left');
                } else {
                    sidebar.classList.remove('is-open');
                    dom.sidebarOverlay.classList.add('opacity-0', 'pointer-events-none');
                    // In collapsed state, the arrow should point right (when sidebar is hidden)
                    dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-left', 'fa-chevron-right');
                }
            }

            function createNewChat(options = {}) {
                const id = 'chat-' + crypto.randomUUID();
                const name = currentUser ? (currentUser.user_metadata.full_name?.split(' ')[0] || 'T') : 'viajero';
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }
                
                let initialMessages;
                initialMessages = options.initialMessages ||
                [{ 
                    role: 'assistant', 
                    content: `Saludos, ${title}. Soy Goatify IA, aqu para servirte. Cada idea tuya es una estrella a punto de nacer. En qu universo nos sumergimos hoy?` 
                }];

                state.chats[id] = { 
                    id, 
                    title: options.title || "Conversacin Csmica", 
                    messages: initialMessages,
                    workflow: options.workflow || null,
                    model: options.model || 'gpt-3.5-turbo-1106'
                };

                if (options.workflow === 'project-management') {
                    state.chats[id].projectData = {
                        title: options.title,
                        columns: [
                             { id: 'todo', title: 'Por Hacer', tasks: [] },
                            { id: 'doing', title: 'En Progreso', tasks: [] },
                            { id: 'done', title: 'Hecho', tasks: [] }
                         ],
                        currentView: 'list' 
                    };
                }

                state.structure.unshift(id); 
                selectChat(id); 
                saveState();
                renderSidebar(); 
                dom.modelSelector.value = options.model || 'gpt-3.5-turbo-1106';
                if (window.innerWidth < 768) toggleSidebar(false);
                
                const chatType = options.title || 'chat';
                showInAppNotification("xito", `Has creado un nuevo ${chatType}.`, 500); // Shorter duration

                return id;
            }

            function selectChat(chatId) { 
                currentChatId = chatId;
                if (isSelectModeActive) return;

                dom.notepadViewContainer.classList.remove('mobile-editor-active'); 

                if (!chatId || (!state.chats[chatId] && !state.notes.find(n => n.id === chatId) && chatId !== 'notepad-app')) { 
                    resetChatView(); 
                    return; 
                } 
                
                // Keep notes panel always expanded, no need to toggle classes based on selection
                // if (chatId !== 'notepad-app' && !dom.notesListPanel.classList.contains('collapsed')) {
                //     dom.notesListPanel.classList.add('collapsed');
                //     dom.notesListToggle.querySelector('i').classList.replace('fa-chevron-left', 'fa-chevron-right'); // Ensure arrow points right
                // }


                dom.chatMessages.style.display = 'none';
                dom.projectManagementView.style.display = 'none';
                dom.financialAssistantView.style.display = 'none';
                dom.notepadViewContainer.style.display = 'none';
                dom.inputArea.style.display = 'none'; 
                
                if (chatId.startsWith('note-') || chatId === 'notepad-app') {
                    dom.chatTitle.textContent = "Bloc de Notas";
                    dom.mobileChatTitle.textContent = "Bloc de Notas";
                    showNotepadView();
                    // Ensure notepad panel is always expanded visually
                    dom.notesListPanel.classList.remove('collapsed'); 

                    if (chatId.startsWith('note-')) { 
                        selectNote(chatId);
                    } else { 
                        if (state.notes.length > 0) {
                            selectNote(state.notes[0].id);
                        } else {
                            dom.noteEditorPanel.classList.add('hidden');
                        }
                    }
                } else {
                    const chat = state.chats[chatId]; 
                    if (chat.workflow === 'project-management') {
                        dom.projectManagementView.style.display = 'flex';
                        renderProjectView(chatId);
                    } else if (chat.workflow === 'financial-assistant') {
                        dom.financialAssistantView.style.display = 'flex';
                        renderFinancialAssistant(chatId);
                    } else {
                        dom.chatMessages.style.display = 'block';
                        dom.inputArea.style.display = 'block';
                        dom.chatMessages.innerHTML = ''; 
                        chat.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, msg.image, index, dom.chatMessages));
                        dom.initialMessageContainer.style.display = 'none';
                    }

                    dom.chatTitle.textContent = chat.title;
                    dom.mobileChatTitle.textContent = chat.title;
                    dom.modelSelector.value = chat.model || 'gpt-3.5-turbo-1106';
                    updateContextualFooter(chat.workflow);
                }

                updateActiveChatHighlight(); 
                saveState();
                if (window.innerWidth < 768) toggleSidebar(false);
            }
            
            function resetChatView() { 
                currentChatId = null;
                dom.chatTitle.textContent = "Goatify IA";
                dom.mobileChatTitle.textContent = "Goatify IA";

                dom.chatMessages.style.display = 'block';
                dom.inputArea.style.display = 'block';
                dom.projectManagementView.style.display = 'none';
                dom.financialAssistantView.style.display = 'none';
                dom.notepadViewContainer.style.display = 'none';

                dom.chatMessages.innerHTML = '';
                dom.initialMessageContainer.style.display = 'flex'; 
                updateUserUI(); 
                updateActiveChatHighlight(); 
                dom.modelSelector.value = 'gpt-3.5-turbo-1106';
                updateContextualFooter(null);
                // Ensure notepad panel is always expanded visually
                dom.notesListPanel.classList.remove('collapsed');
            }

            function addMessageToUI(role, content, imageSrc, messageIndex, container) {
                if (!container) return null;
                const wrapper = document.createElement('div');
                wrapper.className = `chat-bubble-wrapper group flex items-start gap-2 my-2 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const bubble = document.createElement('div');
                bubble.className = `p-3 md:p-4 rounded-xl max-w-lg md:max-w-xl ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot'}`;
                if (imageSrc) {
                    const img = document.createElement('img');
                    img.src = imageSrc;
                    img.className = 'rounded-lg mb-2 max-w-full h-auto';
                    bubble.appendChild(img);
                }
                const contentDiv = document.createElement('div');
                contentDiv.className = 'markdown-content';
                contentDiv.innerHTML = content === '' ? `<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .2s;"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .4s;"></div></div>` : marked.parse(content || "");
                bubble.appendChild(contentDiv);

                if (role === 'user' && container === dom.chatMessages) { 
                    const editBtn = document.createElement('button');
                    editBtn.className = 'p-1 text-text-medium opacity-100 transition-opacity';
                    editBtn.innerHTML = '<i class="fas fa-pencil-alt fa-xs"></i>';
                    editBtn.title = 'Editar mensaje';
                    editBtn.onclick = (e) => { e.stopPropagation(); handleEditMessage(messageIndex); };
                    wrapper.insertBefore(editBtn, wrapper.firstChild);
                }
                
                if (role === 'assistant') { // Add speaker icon for AI responses
                    const speakerBtn = document.createElement('button');
                    speakerBtn.className = 'p-1 text-text-medium opacity-100 transition-opacity ml-2';
                    speakerBtn.innerHTML = '<i class="fas fa-volume-up fa-xs"></i>';
                    speakerBtn.title = 'Leer mensaje';
                    speakerBtn.onclick = (e) => { e.stopPropagation(); speak(content); }; // Read this specific message
                    bubble.appendChild(speakerBtn); // Append to the bubble itself
                }

                if (role === 'assistant' && /<\/?[a-z][\s\S]*>/i.test(content)) {
                    const previewButton = document.createElement('button');
                    previewButton.innerHTML = '<i class="fas fa-eye mr-2"></i>Vista Previa';
                    previewButton.className = 'btn-primary text-xs font-semibold px-3 py-1 rounded-md mt-3';
                    previewButton.addEventListener('click', () => {
                        const match = content.match(/```html\n([\s\S]*?)```/);
                        const htmlToPreview = match ? match[1] : content;
                        dom.htmlPreviewIframe.srcdoc = htmlToPreview;
                         dom.htmlPreviewModal.classList.remove('hidden');
                        dom.htmlPreviewModal.classList.add('flex');
                    });
                    bubble.appendChild(previewButton);
                }

                wrapper.appendChild(bubble); 
                container.appendChild(wrapper);
                container.scrollTop = container.scrollHeight;
                return bubble;
            }
            
            async function handleEditMessage(index) {
                const chat = state.chats[currentChatId];
                if (!chat || !chat.messages[index]) return;
                const originalContent = chat.messages[index].content;
                const result = await showModal({ 
                    title: 'Editar Mensaje', 
                    body: `<textarea id="edit-msg-textarea" class="w-full p-2 rounded bg-input border border-themed h-28">${originalContent}</textarea>`,
                    confirmText: 'Guardar Cambios'
                 });
                if (result.confirmed && result.data['edit-msg-textarea'] && result.data['edit-msg-textarea'].trim() !== originalContent.trim()) {
                    chat.messages[index].content = result.data['edit-msg-textarea'].trim();
                    await saveState();
                    selectChat(currentChatId);
                }
            }

            function updateMessageInUI(bubble, content, imageSrc, container) {
                if (!bubble) return;
                const newBubble = addMessageToUI('assistant', content, imageSrc, null, container);
                if (bubble && bubble.parentElement) {
                    bubble.parentElement.replaceWith(newBubble.parentElement);
                }
            }
            
            function renderSidebar() { 
                dom.sidebarContent.innerHTML = '';
                const frag = document.createDocumentFragment(); 
                
                const itemMap = new Map();
                // Filter out notepad-assistant-chat from the main chat list
                Object.values(state.chats).filter(chat => chat.isDeletable !== false).forEach(chat => itemMap.set(chat.id, { type: 'chat', data: chat })); 
                Object.values(state.notes).forEach(note => itemMap.set(note.id, { type: 'note', data: note }));
                Object.values(state.projects).forEach(proj => itemMap.set(proj.id, { type: 'project', data: proj }));

                const renderStructure = (structure, isSubItem = false) => {
                    structure.forEach(id => {
                        const item = itemMap.get(id);
                        if (!item) return;

                        if(item.type === 'chat') frag.appendChild(createChatItemElement(id, isSubItem));
                        else if(item.type === 'note') frag.appendChild(createNoteItemElement(id, isSubItem));
                        else if(item.type === 'project') {
                            const projectEl = createProjectElement(id);
                            frag.appendChild(projectEl);
                        }
                    });
                };
                
                // Render folders first
                const foldersCategory = document.createElement('div');
                foldersCategory.className = 'folders-category border-t border-themed pt-4 default-open';
                foldersCategory.innerHTML = `
                    <div class="folder-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                        <i class="fas fa-chevron-right folder-arrow mr-2 transition-transform text-xs"></i>
                        <i class="fas fa-folder-open mr-2 text-yellow-500"></i>
                        <span class="text-sm font-bold" data-translate-key="my_folders">Mis Carpetas</span>
                    </div>
                    <div class="folders-content pl-4 pt-1 space-y-1">
                        <button id="new-folder-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg bg-input w-full"><i class="fas fa-folder-plus mr-2"></i><span data-translate-key="new_folder">Nueva Carpeta</span></button>
                        <div id="folders-list" class="space-y-1"></div>
                    </div>
                `;
                frag.appendChild(foldersCategory);
                const foldersListEl = foldersCategory.querySelector('#folders-list');

                const folderIds = state.structure.filter(id => id.startsWith('project-'));
                folderIds.forEach(folderId => {
                    foldersListEl.appendChild(createProjectElement(folderId));
                });
                // Then render other items (chats and notes) directly below the folders category or workflows.
                // Filter out projects from the main structure rendering to avoid duplication.
                const nonFolderItems = state.structure.filter(id => !id.startsWith('project-'));
                nonFolderItems.forEach(id => {
                    const item = itemMap.get(id);
                    if (item && item.data.isDeletable !== false) { // Ensure notepad-assistant-chat is not duplicated and is only in workflows
                        if (item.type === 'chat') {
                            frag.appendChild(createChatItemElement(id));
                        } else if (item.type === 'note') {
                            frag.appendChild(createNoteItemElement(id));
                        }
                    }
                });

                dom.sidebarContent.appendChild(frag); 
                updateActiveChatHighlight(); 
            }

            function createChatItemElement(id, isSubItem = false) { 
                const chat = state.chats[id];
                if (!chat || chat.isDeletable === false) return document.createDocumentFragment(); 

                const item = document.createElement('div'); 
                item.className = `chat-item group flex items-center justify-between p-2 rounded-md cursor-pointer ${isSubItem ? 'pl-8' : ''}`;
                item.dataset.id = id; 
                item.dataset.type = 'chat';
                
                if (isSelectModeActive) {
                    item.draggable = false;
                    const isSelected = chatsToDelete.has(id);
                    item.innerHTML = `<i class="far ${isSelected ? 'fa-check-square' : 'fa-square'} mr-2 text-primary"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span>`;
                    if (isSelected) item.classList.add('selected-for-delete');
                    item.addEventListener('click', () => {
                        if (chatsToDelete.has(id)) {
                            chatsToDelete.delete(id);
                            item.querySelector('i').classList.replace('fa-check-square', 'fa-square');
                             item.classList.remove('selected-for-delete');
                        } else {
                            chatsToDelete.add(id);
                            item.querySelector('i').classList.replace('fa-square', 'fa-check-square');
                            item.classList.add('selected-for-delete');
                        }
                        dom.deleteSelectedBtn.disabled = chatsToDelete.size === 0;
                    });
                } else {
                    const isMobileView = window.innerWidth < 768;
                    const actionsOpacityClass = isMobileView ? 'opacity-100' : 'opacity-0 group-hover:opacity-100';

                    item.draggable = true;
                    item.innerHTML = `<i class="far fa-comment-dots mr-2"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span>
                    <div class="chat-item-actions flex-shrink-0 ${actionsOpacityClass} transition-opacity">
                        <button class="move-btn text-text-medium hover:text-primary p-1" title="Mover a carpeta"><i class="fas fa-folder-open fa-xs"></i></button>
                        <button class="rename-btn text-text-medium hover:text-primary p-1" title="Renombrar"><i class="fas fa-pencil-alt fa-xs"></i></button>
                        <button class="delete-btn text-text-medium hover:text-red-500 p-1" title="Eliminar"><i class="fas fa-trash-alt fa-xs"></i></button>
                    </div>`;
                    item.addEventListener('click', e => { if (!e.target.closest('.chat-item-actions')) selectChat(id); }); 
                    item.addEventListener('dragstart', e => handleDragStart(e, id));
                    item.querySelector('.move-btn').addEventListener('click', (e) => { e.stopPropagation(); moveItemToProject(id); });
                    item.querySelector('.rename-btn').addEventListener('click', (e) => { e.stopPropagation(); renameItem('chat', id); });
                    item.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteItem('chat', id); });
                }
                return item;
            }

            function createNoteItemElement(id, isSubItem = false) {
                const note = state.notes.find(n => n.id === id);
                if (!note) return document.createDocumentFragment();

                const item = document.createElement('div');
                // Use a class for general sidebar items but specific styles for notes
                item.className = `chat-item group flex items-center justify-between p-2 rounded-md cursor-pointer ${isSubItem ? 'pl-8' : ''}`; 
                item.dataset.id = note.id;
                item.dataset.type = 'note';

                const isMobileView = window.innerWidth < 768;
                const actionsOpacityClass = isMobileView ? 'opacity-100' : 'opacity-0 group-hover:opacity-100';
                
                if (isSelectModeActive) {
                    item.draggable = false;
                    const isSelected = chatsToDelete.has(id); // Using chatsToDelete for notes too
                    item.innerHTML = `<i class="far ${isSelected ? 'fa-check-square' : 'fa-square'} mr-2 text-primary"></i><span class="flex-grow truncate text-sm font-medium">${note.title}</span>`;
                    if (isSelected) item.classList.add('selected-for-delete');
                    item.addEventListener('click', () => {
                        if (chatsToDelete.has(id)) {
                            chatsToDelete.delete(id);
                            item.querySelector('i').classList.replace('fa-check-square', 'fa-square');
                             item.classList.remove('selected-for-delete');
                        } else {
                            chatsToDelete.add(id);
                            item.querySelector('i').classList.replace('fa-square', 'fa-check-square');
                            item.classList.add('selected-for-delete');
                        }
                        dom.deleteSelectedBtn.disabled = chatsToDelete.size === 0;
                    });
                } else {
                    item.draggable = true;
                    // Adjusted text-sm and font-medium for notes to match other sidebar items, no specific "note-item" class for thickness
                    item.innerHTML = `
                        <i class="fas ${note.type === 'drawing' ? 'fa-paint-brush' : 'fa-file-alt'} mr-2"></i>
                        <span class="flex-grow truncate text-sm font-medium">${note.title}</span> 
                        <div class="chat-item-actions flex-shrink-0 ${actionsOpacityClass} transition-opacity">
                            <button class="move-btn text-text-medium hover:text-primary p-1" title="Mover a carpeta"><i class="fas fa-folder-open fa-xs"></i></button>
                            <button class="rename-btn text-text-medium hover:text-primary p-1" title="Renombrar"><i class="fas fa-pencil-alt fa-xs"></i></button>
                            <button class="delete-btn text-text-medium hover:text-red-500 p-1" title="Eliminar"><i class="fas fa-trash-alt fa-xs"></i></button>
                        </div>
                    `;
                    item.addEventListener('click', e => { 
                        if (!e.target.closest('.chat-item-actions')) {
                            selectChat(id);
                            if (window.innerWidth < 768) {
                                dom.notepadViewContainer.classList.add('mobile-editor-active');
                            }
                        }
                    });
                    item.addEventListener('dragstart', e => handleDragStart(e, id));
                    item.querySelector('.move-btn').addEventListener('click', (e) => { e.stopPropagation(); moveItemToProject(id); });
                    item.querySelector('.rename-btn').addEventListener('click', (e) => { e.stopPropagation(); renameItem('note', id); });
                    item.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteItem('note', id); });
                }
                return item;
            }

            function createProjectElement(id) {
                const project = state.projects[id];
                if (!project) return document.createDocumentFragment();
                const div = document.createElement('div'); div.className = 'project folders-category'; div.dataset.id = id; // Changed class to folders-category
                const header = document.createElement('div');
                header.className = 'folder-header group flex items-center p-2 rounded-md cursor-pointer';

                const isMobileView = window.innerWidth < 768;
                const actionsOpacityClass = isMobileView ? 'opacity-100' : 'opacity-0 group-hover:opacity-100';

                header.innerHTML = `<i class="fas fa-chevron-right folder-arrow mr-2 transition-transform"></i><i class="fas fa-folder mr-2 text-yellow-500"></i><span class="flex-grow truncate text-sm font-bold">${project.title}</span><div class="chat-item-actions flex-shrink-0 ${actionsOpacityClass} transition-opacity"><button class="rename-btn text-text-medium hover:text-primary p-1" title="Renombrar"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-text-medium hover:text-red-500 p-1" title="Eliminar"><i class="fas fa-trash-alt fa-xs"></i></button></div>`;
                const content = document.createElement('div'); content.className = 'folders-content pt-1 space-y-1 pl-4'; // Changed class to folders-content
                (project.itemIds || []).forEach(itemId => {
                    // Filter out notepad-assistant-chat from project folders
                    if (itemId.startsWith('chat-') && itemId !== 'notepad-assistant-chat') content.appendChild(createChatItemElement(itemId, true));
                    if (itemId.startsWith('note-')) content.appendChild(createNoteItemElement(itemId, true));
                });
                div.append(header, content);
                header.addEventListener('click', e => { if (!e.target.closest('.chat-item-actions')) div.classList.toggle('open'); });
                header.addEventListener('dragover', e => handleDragOver(e, header));
                header.addEventListener('dragleave', e => handleDragLeave(e, header));
                header.addEventListener('drop', e => handleDrop(e, id, header));
                header.querySelector('.rename-btn').addEventListener('click', (e) => { e.stopPropagation(); renameItem('project', id);});
                header.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteItem('project', id);});
                return div;
            }
            let draggedItemId = null;
            function handleDragStart(e, id) { 
                draggedItemId = id; 
                e.dataTransfer.effectAllowed = 'move'; 
                e.dataTransfer.setData('text/plain', id); 
            } 
            function handleDragOver(e, el) { e.preventDefault(); el.classList.add('drag-over'); } 
            function handleDragLeave(e, el) { el.classList.remove('drag-over'); }
            function handleDrop(e, targetProjectId, targetElement) {
                e.preventDefault();
                if (targetElement) targetElement.classList.remove('drag-over');
                const sourceItemId = e.dataTransfer.getData('text/plain');
                if (!sourceItemId || targetProjectId === sourceItemId) return;
                
                moveItemToProject(sourceItemId, targetProjectId);
            }

            function moveItemToProject(itemId, targetProjectId = null) {
                // Determine the item's current type
                let itemType;
                if (itemId.startsWith('chat-')) itemType = 'chat';
                else if (itemId.startsWith('note-')) itemType = 'note';
                else if (itemId.startsWith('project-')) itemType = 'project';
                else return; // Unknown item type

                // Remove from current location in the main structure or another project
                state.structure = state.structure.filter(id => id !== itemId);
                Object.values(state.projects).forEach(p => {
                    if (p.itemIds) {
                        p.itemIds = p.itemIds.filter(id => id !== itemId);
                    }
                });

                // Add to new project (or to a specific sorted position in the root if targetProjectId is null)
                if(targetProjectId && state.projects[targetProjectId]){ 
                    if(!state.projects[targetProjectId].itemIds) state.projects[targetProjectId].itemIds = [];
                    state.projects[targetProjectId].itemIds.unshift(itemId); 
                } else {
                    // Add to root, keeping folders at the top if they exist
                    let insertIndex = 0;
                    // Find the insertion point right after all current folders in the root structure
                    for (let i = 0; i < state.structure.length; i++) {
                        if (state.structure[i].startsWith('project-')) {
                            insertIndex = i + 1;
                        } else {
                            break; // Stop if we hit a non-folder item
                        }
                    }
                    state.structure.splice(insertIndex, 0, itemId);
                }
                
                saveState(); 
                renderSidebar(); 
                // If the currently viewed chat/note was moved, re-select it to update the view
                if (currentChatId === itemId) {
                    selectChat(currentChatId);
                }
            }

            async function renameItem(type, id) {
                let item;
                if(type === 'chat') item = state.chats[id];
                else if(type === 'project') item = state.projects[id];
                else if(type === 'note') item = state.notes.find(n => n.id === id);
                if(!item) return;

                const result = await showModal({ 
                    title: `Renombrar ${type === 'chat' ? 'Conversacin' : (type === 'project' ? 'Proyecto' : 'Nota')}`, 
                    body: `<input type="text" id="rename-input" class="w-full p-2 rounded bg-input border border-themed" value="${item.title}">`,
                    confirmText: 'Renombrar'
                 });
                if (result.confirmed && result.data['rename-input'] && result.data['rename-input'].trim()) {
                    item.title = result.data['rename-input'].trim();
                    if (type === 'chat' && currentChatId === id) {
                        dom.chatTitle.textContent = item.title;
                        if (dom.mobileChatTitle) dom.mobileChatTitle.textContent = item.title;
                        if(state.chats[id].workflow === 'project-management') {
                            state.chats[id].projectData.title = item.title;
                            dom.projectViewTitle.textContent = item.title;
                        }
                    } else if (type === 'note' && currentNoteId === id) {
                        dom.noteTitleInput.value = item.title;
                    }
                    saveState();
                    renderSidebar();
                }
            }
            async function deleteItem(type, id) { 
                let item, childrenIds = [];
                if(type === 'chat') item = state.chats[id];
                else if(type === 'project') {
                    item = state.projects[id];
                    childrenIds = item.itemIds || [];
                }
                else if(type === 'note') item = state.notes.find(n => n.id === id);
                if(!item) return;

                let body = 'Esta accin no se puede deshacer.';
                if(type === 'project' && childrenIds.length > 0) {
                    body += ` Tambin se eliminarn los ${childrenIds.length} elementos que contiene.`
                }

                const confResult = await showModal({ 
                    title: `Eliminar ${item.title}?`, 
                    body: body, 
                    confirmText: 'Eliminar', 
                    dangerConfirm: true 
                });
                
                if (confResult.confirmed) { 
                    const idsToDelete = [id, ...childrenIds];
                    idsToDelete.forEach(deleteId => {
                        state.structure = state.structure.filter(i => i !== deleteId);
                        if (deleteId.startsWith('chat-')) delete state.chats[deleteId];
                        if (deleteId.startsWith('note-')) state.notes = state.notes.filter(n => n.id !== deleteId);
                        if (deleteId.startsWith('project-')) delete state.projects[deleteId];

                        Object.values(state.projects).forEach(p => { 
                            if(p.itemIds) p.itemIds = p.itemIds.filter(cid => cid !== deleteId)
                        });

                        if (currentChatId === deleteId) resetChatView(); 
                        if (currentNoteId === deleteId) { // If currentNoteId is deleted, clear editor
                            currentNoteId = null;
                            dom.noteEditorPanel.classList.add('hidden');
                        }
                    });
                    
                    saveState(); 
                    renderSidebar();
                } 
            }
            
            function updateActiveChatHighlight() { 
                document.querySelectorAll('.chat-item, .note-item').forEach(item => {
                    item.classList.toggle('selected-chat', item.dataset.id === currentChatId);
                    item.classList.toggle('active', item.dataset.id === currentNoteId); // For notepad active state
                });
            }

            function clearImageData() { 
                dom.imageUploadInput.value = ''; 
                dom.imagePreviewContainer.classList.add('hidden'); 
                dom.filePreviewArea.style.display = "none";
                selectedImageBase64 = null; 
            }
            function clearPdfData() { 
                dom.pdfUploadInput.value = ''; 
                dom.pdfPreviewContainer.classList.add('hidden');
                dom.filePreviewArea.style.display = "none"; 
                selectedPdfText = null; 
            }
            function hasFile() { return selectedImageBase64 || selectedPdfText; }
            async function sendMessage(forceSend = false, spokenMessage = null, { assistantType = 'main' } = {}) {
                let inputEl, messageContainer, financialData = null, noteContent = null;
                let chatIdToUpdate = currentChatId;
                let modelToUse;

                switch(assistantType) {
                    case 'project':
                        inputEl = dom.projectMsgInput;
                        messageContainer = dom.projectChatMessages;
                        modelToUse = getModelForRequest(state.chats[chatIdToUpdate]?.workflow, false, 'project');
                        break;
                    case 'financial':
                        inputEl = document.getElementById('financial-msg');
                        messageContainer = document.getElementById('financial-chat-messages');
                        financialData = state.chats[currentChatId].financialData;
                        modelToUse = getModelForRequest(state.chats[chatIdToUpdate]?.workflow, false, 'financial');
                        break;
                    case 'notepad':
                        inputEl = dom.notepadMsgInput;
                        messageContainer = dom.notepadChatMessages;
                        chatIdToUpdate = 'notepad-assistant-chat';
                        noteContent = dom.noteContentEditor.innerHTML; // Get HTML content for notepad assistant
                        modelToUse = getModelForRequest(state.chats[chatIdToUpdate]?.workflow, false, 'notepad');
                        break;
                    default: // main
                        inputEl = dom.msgInput;
                        messageContainer = dom.chatMessages;
                        if (!chatIdToUpdate) chatIdToUpdate = createNewChat({});
                        modelToUse = getModelForRequest(state.chats[chatIdToUpdate]?.workflow, hasFile(), 'main');
                }

                const userMessage = spokenMessage || inputEl.value.trim();
                if (!userMessage && !selectedImageBase64 && !selectedPdfText) return;
                
                const currentChat = state.chats[chatIdToUpdate];
                if (!currentChat) return;

                const webSearchTriggers = ['busca', 'investiga', 'en internet', 'tiempo real', 'qu da es hoy', 'qu fecha es hoy', 'cul es el precio de', 'quin es', 'qu es', 'noticias sobre'];
                const requiresWebSearch = webSearchTriggers.some(trigger => userMessage.toLowerCase().startsWith(trigger));
                if (requiresWebSearch && !hasFile() && !currentChat.workflow) { modelToUse = 'sonar'; }
                
                let cost = COSTS.GENERAL;
                if(modelToUse === 'sonar') cost = COSTS.SEARCH;
                if(currentChat.workflow) cost = COSTS.WORKFLOW;
                if(selectedPdfText) cost = COSTS.PDF_ANALYSIS;
                if(selectedImageBase64) cost = COSTS.IMAGE_ANALYSIS;
                if(modelToUse === 'gpt-4o') cost = COSTS.GPT4O; // Specific cost for GPT-4o

                if (!spendCredits(cost, modelToUse)) return; // Pass modelUsed to spendCredits

                if(currentChat.title === 'Conversacin Csmica' && userMessage.length > 5 && assistantType === 'main') {
                    currentChat.title = userMessage.split(' ').slice(0, 4).join(' ');
                    renderSidebar();
                }

                const [image, pdf] = [selectedImageBase64, selectedPdfText];
                currentChat.messages.push({ role: 'user', content: userMessage, image, pdfText: pdf });
                addMessageToUI('user', userMessage, image, currentChat.messages.length - 1, messageContainer);
                const thinkingBubble = addMessageToUI('assistant', '', null, null, messageContainer);
                inputEl.value = '';
                inputEl.style.height = 'auto'; 
                if(assistantType === 'main') {
                    clearImageData(); 
                    clearPdfData();
                }

                try {
                    const userNameForCall = currentUser ? (currentUser.user_metadata.full_name || currentUser.email) : 'viajero';
                    const responseData = await getAIResponse(userMessage, currentChat.messages.slice(0, -1), image, pdf, modelToUse, currentChat.workflow, userNameForCall, financialData, noteContent);
                    
                    updateCreditCounter();
                    currentChat.messages.push({ role: 'assistant', content: responseData.reply });
                    updateMessageInUI(thinkingBubble, responseData.reply, null, messageContainer);
                    speak(responseData.reply);

                    if (currentChat.workflow && currentChat.workflow !== 'notepad-assistant') {
                        completeMission(currentChat.workflow, chatIdToUpdate);
                    }

                    if (assistantType === 'project' && responseData.projectUpdate && responseData.projectUpdate.tasks) {
                        const todoColumn = currentChat.projectData.columns.find(c => c.id === 'todo');
                        if (todoColumn) {
                            if (!todoColumn.tasks) todoColumn.tasks = [];
                             responseData.projectUpdate.tasks.forEach(task => {
                                 todoColumn.tasks.push({ id: `proj-${crypto.randomUUID()}`, content: task.content, completed: false, labels: task.labels || [], urgent: false });
                            });
                        }
                        renderProjectBoard(chatIdToUpdate);
                    }
                    
                    saveState();
                } catch (error) {
                    updateMessageInUI(thinkingBubble, ` **Error de Conexin**<br><small>${error.message || 'No se pudo conectar al servidor.'}</small>`, null, messageContainer);
                }
            }
            async function generateImage() {
                const result = await showModal({ title: 'Crear Imagen', body: 'Describe la imagen que quieres crear:<br><input type="text" id="img-prompt" class="w-full p-2 rounded bg-input border border-themed mt-2" placeholder="Ej: Un astronauta en un caballo csmico">', confirmText: 'Generar' });
                if (!result.confirmed || !result.data['img-prompt']) return;
                
                if (!spendCredits(COSTS.IMAGE_GENERATION, 'dall-e-2')) return; // Pass model name for pro usage check
                
                let chatIdToUpdate = currentChatId || createNewChat({});
                const currentChat = state.chats[chatIdToUpdate];
                currentChat.messages.push({ role: 'user', content: `Generar imagen: "${result.data['img-prompt']}"` });
                addMessageToUI('user', `Generar imagen: "${result.data['img-prompt']}"`, null, currentChat.messages.length - 1, dom.chatMessages);
                const thinkingBubble = addMessageToUI('assistant', 'Creando tu visin con DALLE 2...', null, null, dom.chatMessages);
                try {
                    const response = await fetch('/.netlify/functions/generate-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ prompt: result.data['img-prompt'], model: 'dall-e-2' })
                    });
                    if (!response.ok) { throw new Error((await response.json()).error || 'Error del servidor'); }
                    const { imageData } = await response.json();
                    const imageContent = `Aqu est tu creacin, Jefe/a!`;
                    currentChat.messages.push({ role: 'assistant', content: imageContent, image: imageData });
                    updateMessageInUI(thinkingBubble, imageContent, imageData, dom.chatMessages);
                    completeMission('image-generated');
                    saveState();
                } catch (error) {
                    updateMessageInUI(thinkingBubble, ` **Error al crear la imagen:**<br><small>${error.message}</small>`, null, dom.chatMessages);
                }
            }
            function toggleSelectMode(active) {
                isSelectModeActive = active;
                dom.selectChatsBtn.classList.toggle('hidden', active);
                dom.deleteModeControls.classList.toggle('hidden', !active);
                if (!active) {
                    chatsToDelete.clear();
                    dom.deleteSelectedBtn.disabled = true;
                }
                renderSidebar();
            }
             
            // --- NOTEPAD FUNCTIONS START ---

            function showNotepadView() {
                dom.notepadViewContainer.style.display = 'flex';
                dom.notepadChatContainer.classList.toggle('hidden', window.innerWidth < 768);
                updateContextualFooter('notepad-app');
                
                // Hide the internal notes list within the notepad view
                dom.notesList.style.display = 'none';

                const notepadChat = state.chats['notepad-assistant-chat'];
                dom.notepadChatMessages.innerHTML = '';
                notepadChat.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, msg.image, index, dom.notepadChatMessages));


                if (state.notes.length === 0) {
                     dom.noteEditorPanel.classList.add('hidden');
                } else if (!currentNoteId || !state.notes.find(n => n.id === currentNoteId)) {
                    selectNote(state.notes[0].id);
                } else {
                    selectNote(currentNoteId);
                }
                
                const notepadModelSelector = document.getElementById('notepad-model-selector');
                if (notepadModelSelector) {
                    const goatXProOption = notepadModelSelector.querySelector('.goat-x-pro-model');
                    if (goatXProOption) goatXProOption.disabled = !currentUser;
                }
            }
            
            function renderNotesList() {
                // This function is now primarily for updating the external sidebar's list of notes
                // The internal notes-list element (dom.notesList) is hidden as per new requirements.
                dom.sidebarContent.innerHTML = '';
                const frag = document.createDocumentFragment(); 
                
                const itemMap = new Map();
                // Filter out notepad-assistant-chat from the main chat list
                Object.values(state.chats).filter(chat => chat.isDeletable !== false).forEach(chat => itemMap.set(chat.id, { type: 'chat', data: chat })); 
                Object.values(state.notes).forEach(note => itemMap.set(note.id, { type: 'note', data: note }));
                Object.values(state.projects).forEach(proj => itemMap.set(proj.id, { type: 'project', data: proj }));

                const renderStructure = (structure, isSubItem = false) => {
                    structure.forEach(id => {
                        const item = itemMap.get(id);
                        if (!item) return;

                        if(item.type === 'chat') frag.appendChild(createChatItemElement(id, isSubItem));
                        else if(item.type === 'note') frag.appendChild(createNoteItemElement(id, isSubItem));
                        else if(item.type === 'project') {
                            const projectEl = createProjectElement(id);
                            frag.appendChild(projectEl);
                        }
                    });
                };
                
                // Render folders first
                const foldersCategory = document.createElement('div');
                foldersCategory.className = 'folders-category border-t border-themed pt-4 default-open';
                foldersCategory.innerHTML = `
                    <div class="folder-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                        <i class="fas fa-chevron-right folder-arrow mr-2 transition-transform text-xs"></i>
                        <i class="fas fa-folder-open mr-2 text-yellow-500"></i>
                        <span class="text-sm font-bold" data-translate-key="my_folders">Mis Carpetas</span>
                    </div>
                    <div class="folders-content pl-4 pt-1 space-y-1">
                        <button id="new-folder-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg bg-input w-full"><i class="fas fa-folder-plus mr-2"></i><span data-translate-key="new_folder">Nueva Carpeta</span></button>
                        <div id="folders-list" class="space-y-1"></div>
                    </div>
                `;
                frag.appendChild(foldersCategory);
                const foldersListEl = foldersCategory.querySelector('#folders-list');

                const folderIds = state.structure.filter(id => id.startsWith('project-'));
                folderIds.forEach(folderId => {
                    foldersListEl.appendChild(createProjectElement(folderId));
                });
                // Then render other items (chats and notes) directly below the folders category or workflows.
                // Filter out projects from the main structure rendering to avoid duplication.
                const nonFolderItems = state.structure.filter(id => !id.startsWith('project-'));
                nonFolderItems.forEach(id => {
                    const item = itemMap.get(id);
                    if (item && item.data.isDeletable !== false) { // Ensure notepad-assistant-chat is not duplicated and is only in workflows
                        if (item.type === 'chat') {
                            frag.appendChild(createChatItemElement(id));
                        } else if (item.type === 'note') {
                            frag.appendChild(createNoteItemElement(id));
                        }
                    }
                });

                dom.sidebarContent.appendChild(frag); 
                updateActiveChatHighlight(); 
            }


            function selectNote(noteId) {
                const noteExists = state.notes.find(n => n.id === noteId);
                if (!noteExists) {
                    currentNoteId = null;
                    dom.noteEditorPanel.classList.add('hidden');
                    return;
                }
                dom.noteEditorPanel.classList.remove('hidden');
                currentNoteId = noteId;
                loadNoteIntoEditor(noteId);
                // No need to call renderNotesList() here as the internal list is hidden
                updateActiveChatHighlight(); // To update the 'active' class in the sidebar
            }

            function createNewNote(type = 'text') {
                const newNote = {
                    id: 'note-' + crypto.randomUUID(),
                    title: type === 'text' ? 'Nueva Nota' : 'Nuevo Dibujo',
                    content: type === 'text' ? '' : null, 
                    type: type,
                    createdAt: new Date().toISOString()
                };
                state.notes.unshift(newNote);
                state.structure.unshift(newNote.id);
                selectNote(newNote.id);
                saveState();
                renderSidebar();

                showInAppNotification("xito", `Se ha creado: "${newNote.title}"`, 500); // Shorter duration
                if (window.innerWidth < 768) {
                    dom.notepadViewContainer.classList.add('mobile-editor-active');
                }
            }

            function loadNoteIntoEditor(noteId) {
                const note = state.notes.find(n => n.id === noteId);
                if (!note) return;
                
                currentNoteId = noteId; // Ensure currentNoteId is set
                
                dom.noteTitleInput.value = note.title;
                const isDrawing = note.type === 'drawing';

                dom.noteContentEditor.style.display = isDrawing ? 'none' : 'block';
                dom.noteCanvas.style.display = isDrawing ? 'block' : 'none';
                dom.noteContentEditor.innerHTML = isDrawing ? '' : note.content;

                dom.textTools.style.display = isDrawing ? 'none' : 'flex';
                dom.drawingTools.style.display = isDrawing ? 'flex' : 'none';
                
                if (isDrawing) {
                    setupCanvas(note);
                }
            }

            function setupCanvas(note) {
                const canvas = dom.noteCanvas;
                const ctx = canvas.getContext('2d');
                const toolbar = dom.drawingTools;
                
                // Set canvas size to match its parent's rendered size (which handles responsiveness)
                // This must be done every time the canvas or its parent's size might change
                const resizeCanvas = () => {
                    const rect = canvas.parentElement.getBoundingClientRect();
                    canvas.width = rect.width;
                    canvas.height = rect.height;
                    // When canvas is resized, its content is cleared. Redraw if content exists.
                    if (note.content) {
                        const img = new Image();
                        img.onload = () => { ctx.drawImage(img, 0, 0, canvas.width, canvas.height); } // Ensure drawing scales with canvas
                        img.src = note.content;
                    }
                };
                
                // Initial resize and redraw
                resizeCanvas();
                // Add event listener for window resize to make canvas responsive
                window.addEventListener('resize', resizeCanvas);


                let isDrawing = false;
                let lastX = 0;
                let lastY = 0;
                let currentTool = 'pencil'; 
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (note.content) {
                    const img = new Image();
                    img.onload = () => { ctx.drawImage(img, 0, 0, canvas.width, canvas.height); }
                    img.src = note.content;
                }

                const getCoords = (e) => {
                    // Use clientX/Y for both mouse and touch events
                    const event = e.touches ? e.touches[0] : e; 
                    const canvasRect = canvas.getBoundingClientRect();
                    return [event.clientX - canvasRect.left, event.clientY - canvasRect.top];
                }

                const startDrawing = (e) => { 
                    isDrawing = true; 
                    [lastX, lastY] = getCoords(e);
                    ctx.beginPath(); 
                    ctx.moveTo(lastX, lastY);
                };
                const draw = (e) => {
                    if (!isDrawing) return;
                    e.preventDefault(); // Prevent scrolling on touch devices
                    
                    const [currentX, currentY] = getCoords(e);
                    ctx.lineTo(currentX, currentY);
                    ctx.strokeStyle = toolbar.querySelector('#drawing-color').value;
                    ctx.lineWidth = toolbar.querySelector('#drawing-line-width').value;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
                    ctx.stroke();
                    [lastX, lastY] = [currentX, currentY];
                };
                const stopDrawing = () => {
                    if (!isDrawing) return;
                    isDrawing = false;
                    ctx.closePath(); 
                    const activeNote = state.notes.find(n => n.id === currentNoteId);
                    if (activeNote) {
                        activeNote.content = canvas.toDataURL(); // Save drawing
                        saveState();
                    }
                };

                // Desktop events
                canvas.onmousedown = startDrawing;
                canvas.onmousemove = draw;
                canvas.onmouseup = stopDrawing;
                canvas.onmouseout = stopDrawing;
                // Mobile/Touch events - crucial for touch screen drawing
                canvas.ontouchstart = (e) => { e.preventDefault(); startDrawing(e); }; 
                canvas.ontouchmove = (e) => { e.preventDefault(); draw(e); };
                canvas.ontouchend = stopDrawing;
                
                toolbar.querySelector('#tool-pencil').onclick = () => { currentTool = 'pencil'; setActiveTool('tool-pencil'); };
                toolbar.querySelector('#tool-eraser').onclick = () => { currentTool = 'eraser'; setActiveTool('tool-eraser'); };
                toolbar.querySelector('#clear-canvas-btn').onclick = () => {
                     ctx.clearRect(0, 0, canvas.width, canvas.height);
                     const activeNote = state.notes.find(n => n.id === currentNoteId);
                     if (activeNote) {
                         activeNote.content = null;
                         saveState();
                     }
                };
                 const setActiveTool = (toolId) => {
                    toolbar.querySelectorAll('.drawing-tool').forEach(t => t.classList.remove('active'));
                    toolbar.querySelector(`#${toolId}`).classList.add('active');
                }
            }
            
            function handleChecklistItem(target) {
                if(!target.matches('.checklist-item-checkbox')) return;
                const isChecked = target.checked;
                const textSpan = target.nextElementSibling;
                if (textSpan && textSpan.matches('.checklist-item-text')) {
                    textSpan.dataset.checked = isChecked;
                }
                const currentNote = state.notes.find(n => n.id === currentNoteId);
                if(currentNote) {
                    currentNote.content = dom.noteContentEditor.innerHTML;
                    saveState();
                }
            }

            async function shareNote() {
                const lang = localStorage.getItem('goatify-lang') || 'es';
                const result = await showModal({
                    title: translations[lang].share_note,
                    body: `<p>${translations[lang].share_note_desc}</p>
                           <input type="email" id="share-email-input" class="w-full p-2 rounded bg-input border border-themed mt-2" placeholder="${translations[lang].share_note_email_placeholder}">
                           <p class="text-xs text-text-medium mt-2">${translations[lang].share_note_info}</p>`,
                    confirmText: translations[lang].share_note_button
                });

                if (result.confirmed && result.data['share-email-input']) {
                    console.log(`(DEMO) Sharing note ${currentNoteId} with ${result.data['share-email-input']}. Backend implementation needed.`);
                    showInAppNotification("Funcin en Desarrollo", "La colaboracin en tiempo real estar disponible pronto.", 500); // Shorter duration
                }
            }

            // --- NOTEPAD FUNCTIONS END ---


            function setupModalClickOutside(modalElement, hideFunction) {
                if (!modalElement) return;
                modalElement.addEventListener('click', (e) => {
                    // Only hide if the click is directly on the overlay, not on the content itself
                    if (e.target === modalElement) {
                        hideFunction();
                    }
                });
            }

            function toggleVoiceSelectorVisibility(show) {
                dom.voiceSelectorContainer.classList.toggle('hidden', !show);
                dom.actionButtonsContainer.classList.toggle('hidden', show);
            }

            function showMotivationModal() {
                dom.motivationModal.classList.remove('hidden');
                dom.motivationModal.classList.add('flex');
                
                const randomIndex = Math.floor(Math.random() * MOTIVATIONAL_MESSAGES.length);
                const randomButtonText = MOTIVATION_BUTTON_TEXTS[Math.floor(Math.random() * MOTIVATION_BUTTON_TEXTS.length)];

                dom.motivationTitle.style.fontWeight = 'normal';
                dom.motivationQuote.textContent = MOTIVATIONAL_MESSAGES[randomIndex];
                dom.motivationQuote.style.fontWeight = 'bold';
                dom.motivationQuote.classList.add('shimmer-text');
                dom.closeMotivationModal.textContent = randomButtonText;

                setTimeout(() => dom.motivationQuote.classList.remove('shimmer-text'), 2500);

                const toggle = dom.motivationToggle;
                toggle.checked = motivationEnabled;
            }

            function hideMotivationModal() {
                dom.motivationModal.classList.add('hidden');
                dom.motivationModal.classList.remove('flex');
            }

            function setupMotivationInterval() {
                if (motivationInterval) clearInterval(motivationInterval);
                if (!motivationEnabled) return;

                // Send every 30 minutes
                motivationInterval = setInterval(() => {
                    if (!motivationEnabled) {
                        clearInterval(motivationInterval);
                        return;
                    }
                    const randomIndex = Math.floor(Math.random() * MOTIVATIONAL_MESSAGES.length);
                    const message = MOTIVATIONAL_MESSAGES[randomIndex];
                    showInAppNotification(
                        `<i class="fas fa-lightbulb text-yellow-400 mr-2"></i> Dosis de Motivacin!`,
                        `<p class="text-md">${message}</p>`,
                        4000 // Short duration for motivation popups
                    );
                }, 30 * 60 * 1000); // Every 30 minutes
            }

            function setupEventListeners() {
                dom.inAppNotificationClose?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dom.inAppNotification.classList.remove('show');
                });
                dom.notificationDoneBtn?.addEventListener('click', () => {
                    // Handled by showInAppNotification
                });
                dom.notificationSnoozeBtn?.addEventListener('click', () => {
                    // Handled by showInAppNotification
                });


                const motivationClickHandler = () => showMotivationModal();
                dom.motivationBtnHeader?.addEventListener('click', motivationClickHandler);
                dom.motivationBtnMobile?.addEventListener('click', motivationClickHandler);

                dom.closeMotivationModal?.addEventListener('click', hideMotivationModal);
                // Close motivation modal on outside click
                dom.motivationModal.addEventListener('click', (e) => {
                    if (e.target === dom.motivationModal) {
                        hideMotivationModal();
                    }
                });

                dom.motivationToggle?.addEventListener('change', () => {
                    motivationEnabled = dom.motivationToggle.checked;
                    localStorage.setItem('goatify-motivation-enabled', motivationEnabled);
                    if(motivationEnabled) {
                        setupMotivationInterval(); 
                    } else {
                        if(motivationInterval) clearInterval(motivationInterval); 
                    }
                });

                dom.sendBtn?.addEventListener('click', () => sendMessage(false, null, { assistantType: 'main' }));
                
                const setupAssistantInput = (inputId, sendId, assistantType) => {
                    const inputEl = document.getElementById(inputId);
                    document.getElementById(sendId)?.addEventListener('click', () => {
                         sendMessage(false, null, { assistantType });
                    });
                     inputEl?.addEventListener('keydown', e => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            sendMessage(false, null, { assistantType });
                        }
                    });
                };

                setupAssistantInput('project-msg', 'project-send', 'project');
                setupAssistantInput('financial-msg', 'financial-send', 'financial');
                setupAssistantInput('notepad-msg', 'notepad-send', 'notepad');


                dom.msgInput?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                         sendMessage(false, null, { assistantType: 'main' });
                    }
                });
                dom.msgInput?.addEventListener('input', () => {
                    dom.msgInput.style.height = 'auto';
                    dom.msgInput.style.height = (dom.msgInput.scrollHeight) + 'px';
                });

                const newChatHandler = () => createNewChat();
                dom.newChatBtn?.addEventListener('click', newChatHandler);
                dom.newChatIconBtn?.addEventListener('click', newChatHandler);
                
                dom.newFolderBtn?.addEventListener('click', async () => { const result = await showModal({ title: 'Crear Nueva Carpeta', body: '<input type="text" id="project-name" class="w-full p-2 rounded bg-input border border-themed" placeholder="Nombre de la Carpeta...">', confirmText: 'Crear' }); if (result.confirmed && result.data['project-name'].trim()) { const id = 'project-' + crypto.randomUUID(); state.projects[id] = { id, title: result.data['project-name'].trim(), itemIds: [] }; state.structure.unshift(id); saveState(); renderSidebar(); } });
                dom.newFolderIconBtn?.addEventListener('click', async () => { 
                    const result = await showModal({ 
                        title: 'Crear Nueva Carpeta', 
                        body: '<input type="text" id="project-name" class="w-full p-2 rounded bg-input border border-themed" placeholder="Nombre de la Carpeta...">', 
                        confirmText: 'Crear' 
                    }); 
                    if (result.confirmed && result.data['project-name'].trim()) { 
                        const id = 'project-' + crypto.randomUUID(); 
                        state.projects[id] = { id, title: result.data['project-name'].trim(), itemIds: [] }; 
                        // Folders now go specifically into the folders-list, which is part of sidebarContent
                        // No need to directly manage 'state.structure' here for folders anymore, as renderSidebar will handle it
                        // by looking at state.projects.
                        saveState(); 
                        renderSidebar(); 
                        showInAppNotification("xito", `Carpeta "${result.data['project-name'].trim()}" creada.`, 500); // Shorter duration
                    } 
                });

                dom.upgradePlanBtn?.addEventListener('click', showPricingModal);
                dom.closePricingModalBtn?.addEventListener('click', hidePricingModal);
                dom.themeToggle?.addEventListener('click', () => setTheme(!document.body.classList.contains('dark-theme')));
                dom.loginBtn?.addEventListener('click', () => netlifyIdentity.open('login'));
                
                dom.desktopChatTitleWrapper?.addEventListener('click', (e) => { if(!e.target.closest('#motivation-btn-header') && currentChatId && currentChatId.startsWith('chat-')) renameItem('chat', currentChatId); });
                dom.mobileChatTitleWrapper?.addEventListener('click', (e) => { if(!e.target.closest('#motivation-btn-mobile') && currentChatId && currentChatId.startsWith('chat-')) renameItem('chat', currentChatId); });
                dom.imageGenBtn?.addEventListener('click', generateImage);
                dom.pdfUploadBtn?.addEventListener('click', () => dom.pdfUploadInput.click());
                dom.imageUploadBtn?.addEventListener('click', () => dom.imageUploadInput.click());
                if (SR && dom.micBtn) {
                    recognition = new SR();
                    recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'es-ES';
                    recognition.onstart = () => { isRecognizing = true; dom.micBtn.classList.add('glowing-mic'); toggleVoiceSelectorVisibility(true);};
                    recognition.onend = () => { isRecognizing = false; dom.micBtn.classList.remove('glowing-mic'); if (!speechSynthesis.speaking) toggleVoiceSelectorVisibility(false); };
                    recognition.onerror = (e) => { console.error("Speech recognition error", e); isRecognizing = false; dom.micBtn.classList.remove('glowing-mic'); toggleVoiceSelectorVisibility(false); };
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        const activeView = document.querySelector('#view-container > div:not(.hidden)');
                        let assistantType = 'main';
                        if(activeView) {
                            if(activeView.id === 'project-management-view') assistantType = 'project';
                            else if(activeView.id === 'financial-assistant-view') assistantType = 'financial';
                            else if(activeView.id === 'notepad-view-container') assistantType = 'notepad';
                        }
                        
                        let activeInput = dom.msgInput;
                        if(assistantType === 'project') activeInput = dom.projectMsgInput;
                        else if(assistantType === 'financial') activeInput = document.getElementById('financial-msg');
                        else if(assistantType === 'notepad') activeInput = dom.notepadMsgInput;

                        activeInput.value = transcript; 
                        sendMessage(false, null, { assistantType });
                    };
                    dom.micBtn.addEventListener('click', () => {
                        if(isRecognizing) { recognition.stop(); } 
                        else { if (speechSynthesis.speaking) { speechSynthesis.cancel(); } try { recognition.start(); } catch(e) {console.error("Could not start recognition", e)} }
                    });
                } else { if(dom.micBtn) dom.micBtn.style.display = 'none'; }
                
                dom.ttsToggle?.addEventListener('click', () => {
                    speechOn = !speechOn;
                    const icon = dom.ttsToggle.querySelector('i');
                     icon.classList.toggle('fa-volume-high', speechOn);
                    icon.classList.toggle('fa-volume-mute', !speechOn);
                    if (!speechOn) {
                        speechSynthesis.cancel();
                    }
                 });

                dom.modelSelector?.addEventListener('change', () => {
                    // Re-run the model selection logic to check for limits/plans
                    getModelForRequest(state.chats[currentChatId]?.workflow, hasFile(), 'main'); 
                });
                
                dom.clearImageBtn?.addEventListener('click', clearImageData);
                dom.clearPdfBtn?.addEventListener('click', clearPdfData);
                dom.imageUploadInput?.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { dom.filePreviewArea.style.display = "block"; clearPdfData(); const reader = new FileReader(); reader.onload = (ev) => { selectedImageBase64 = ev.target.result; dom.imagePreview.src = selectedImageBase64; dom.imagePreviewContainer.classList.remove('hidden'); }; reader.readAsDataURL(e.target.files[0]); } });
                dom.pdfUploadInput?.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file || file.type !== 'application/pdf') return; dom.filePreviewArea.style.display = "block"; clearImageData(); dom.pdfNameEl.textContent = file.name; dom.pdfStatusEl.textContent = 'Leyendo...'; dom.pdfPreviewContainer.classList.remove('hidden'); const reader = new FileReader(); reader.onload = async (ev) => { dom.pdfStatusEl.textContent = 'Procesando...'; try { const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(ev.target.result) }).promise; let text = ''; for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const content = await page.getTextContent(); text += content.items.map(item => item.str).join(' ') + '\n'; } selectedPdfText = text; dom.pdfStatusEl.textContent = ` Listo (${pdf.numPages} pg.)`; } catch (err) { console.error("Error al procesar el PDF:", err); dom.pdfStatusEl.textContent = ' Error al leer PDF.'; selectedPdfText = null; setTimeout(clearPdfData, 2000); } }; reader.readAsArrayBuffer(file); });
                dom.menuToggle?.addEventListener('click', (e) => { e.stopPropagation(); toggleSidebar(true); });
                dom.sidebarOverlay?.addEventListener('click', () => toggleSidebar(false));
                dom.sidebarToggleArrow?.addEventListener('click', () => {
                    dom.sidebar.classList.toggle('collapsed');
                    // Toggle arrow direction based on collapsed state
                    if (dom.sidebar.classList.contains('collapsed')) {
                        dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-left', 'fa-chevron-right');
                    } else {
                        dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-right', 'fa-chevron-left');
                    }
                });
                dom.sidebar.querySelector('#logo-space')?.addEventListener('click', () => {
                    if (window.innerWidth >= 768) {
                        dom.sidebar.classList.toggle('collapsed');
                         if (dom.sidebar.classList.contains('collapsed')) {
                            dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-left', 'fa-chevron-right');
                        } else {
                            dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-right', 'fa-chevron-left');
                        }
                    }
                });

                // Notepad list toggle for desktop - this button is removed from Notepad UI
                // dom.notesListToggle?.addEventListener('click', () => { 
                //     dom.notesListPanel.classList.toggle('collapsed');
                //     // Toggle visibility of the notes list based on panel collapse state
                //     if (dom.notesListPanel.classList.contains('collapsed')) {
                //         dom.notesList.style.display = 'none'; // Hide list when panel collapses
                //         dom.notesListToggle.querySelector('i').classList.replace('fa-chevron-left', 'fa-chevron-right');
                //     } else {
                //         dom.notesList.style.display = 'flex'; // Show list when panel expands
                //         dom.notesListToggle.querySelector('i').classList.replace('fa-chevron-right', 'fa-chevron-left');
                //     }
                // });
                
                dom.userMenuBtn?.addEventListener('click', (e) => { e.stopPropagation(); dom.userMenuPopup.classList.toggle('hidden'); });
                dom.logoutBtn?.addEventListener('click', () => { netlifyIdentity.logout(); dom.userMenuPopup.classList.add('hidden');});
                
                const workflowConfigs = {
                    'project-management': { title: "Asistente de Proyectos", workflow: 'project-management', initialMessages: [{ role: 'assistant', content: 'Excelente! Vamos a estructurar este proyecto como un profesional. Para empezar, **cul es el objetivo final y medible que quieres alcanzar con este proyecto?** Descrbelo y luego definiremos los entregables clave.' }] },
                    'financial-assistant': { title: "Asistente Financiero", workflow: 'financial-assistant', initialMessages: [{ role: 'assistant', content: 'Vamos a organizar tus finanzas! Utiliza la tabla de arriba para aadir tus ingresos y gastos. Luego, puedes hacerme preguntas aqu sobre tus finanzas, como por ejemplo: "En qu categora estoy gastando ms?" o "Proyecta mis ahorros para los prximos 6 meses".' }] },
                    'notepad-app': { title: "Bloc de Notas", workflow: 'notepad-app' },
                    'create-full-post': { title: "Post para Redes", workflow: 'create-full-post', initialMessages: [{ role: 'assistant', content: 'Claro! Vamos a crear un post increble. Para qu red social lo necesitas (Instagram, Facebook, LinkedIn, etc.)?' }] },
                    'persuasive-copy': { title: "Copy Persuasivo", workflow: 'persuasive-copy', initialMessages: [{ role: 'assistant', content: 'Estoy listo para redactar textos que vendan. Para qu necesitas este copy? (ej: Anuncio de Facebook, Post de Venta, Descripcin de Producto)' }] },
                    'post-ideas': { title: "Lluvia de Ideas", workflow: 'post-ideas', initialMessages: [{ role: 'assistant', content: 'Acabemos con el bloqueo creativo! Dime un tema y te dar 7 ideas de contenido excelentes.' }] },
                    'brand-strategy': { title: "Estratega de Marca", workflow: 'brand-strategy', initialMessages: [{ role: 'assistant', content: 'Definamos el corazn de tu marca. Cul es el nombre de tu negocio y a qu se dedica?' }] },
                    'competitor-analysis': { title: "Anlisis de Competencia", workflow: 'competitor-analysis', model: 'sonar', initialMessages: [{ role: 'assistant', content: "Estoy listo para analizar a tu competencia usando el buscador web. Por favor, pega la URL (direccin web) de la pgina que quieres que investigue para entregarte un anlisis DAFO simplificado." }] },
                    'buyer-persona': { title: "Cliente Ideal", workflow: 'buyer-persona', initialMessages: [{ role: 'assistant', content: "Vamos a definir a tu cliente ideal (Buyer Persona). Describe tu producto o servicio, y te har preguntas para construir el perfil detallado paso a paso." }] },
                    'brand-names': { title: "Nombres para Marca", workflow: 'brand-names', initialMessages: [{ role: 'assistant', content: "Excelente! Busquemos un nombre increble. Describe brevemente tu idea de negocio, tu pblico y el estilo que buscas (ej. moderno, clsico, divertido) para generar nombres y slogans." }] },
                    'sales-assistant': { title: "Ventas para tu Negocio", workflow: 'sales-assistant', initialMessages: [{ role: 'assistant', content: 'Para ayudarte a cerrar esa venta, pega aqu el mensaje de tu cliente.' }] }, /* Updated text */
                    'email-writing': { title: "Redaccin de Email", workflow: 'email-writing', initialMessages: [{ role: 'assistant', content: 'Creemos un email que convierta. Cul es el objetivo principal de este correo?' }] },
                    'english-teacher-translate': { title: "Traductor de Ingls", workflow: 'english-teacher-translate', initialMessages: [{ role: 'assistant', content: 'Of course! Please provide the text you want me to translate or correct.' }] },
                    'english-teacher-vocabulary': { title: "Creador de Vocabulario", workflow: 'english-teacher-vocabulary', initialMessages: [{ role: 'assistant', content: 'Excellent! Let\'s learn some new vocabulary. What topic are you interested in? (e.g., "business negotiations", "travel")' }] },
                    'english-teacher-practice': { title: "Prctica de Ingls", workflow: 'english-teacher-practice', initialMessages: [{ role: 'assistant', content: 'Great! Let\'s practice our conversation. So, tell me about your day.' }] },
                    'social-skills': { title: "Consejero Social", workflow: 'social-skills', initialMessages: [{ role: 'assistant', content: 'Las habilidades sociales son clave. En qu situacin te gustara mejorar tu comunicacin? (Ej: una reunin de networking, una conversacin difcil, etc.)' }] },
                    'design-web': { title: "Diseador Web", workflow: 'design-web', model: 'gpt-4o', initialMessages: [{ role: 'assistant', content: 'Estoy listo para disear con cdigo. Describe la pgina o componente que quieres crear, y lo programar para ti.' }] },
                    'conflict-resolution': { title: "Mediador de Conflictos", workflow: 'conflict-resolution', initialMessages: [{ role: 'assistant', content: 'Entiendo. Las situaciones difciles requieren una comunicacin clara. Por favor, describe el conflicto objetivamente: quines estn involucrados y cul es el punto principal de desacuerdo?' }] },
                    'decision-lab': { title: "Laboratorio de Decisiones", workflow: 'decision-lab', initialMessages: [{ role: 'assistant', content: 'Bienvenido al Laboratorio de Decisiones. Recuerda que una decisin puede cambiar el rumbo de tu vida. Para ayudarte a analizar tu situacin, por favor, dime: Cul es la decisin que necesitas tomar y qu opciones ests considerando?' }] },
                };
                
                document.body.addEventListener('click', e => { 
                    const workflowHeader = e.target.closest('.workflow-header');
                    if (workflowHeader) {
                        const workflowCategory = workflowHeader.closest('.workflow-category');
                        if(workflowCategory) workflowCategory.classList.toggle('open');
                    }
                    const actionsHeader = e.target.closest('.actions-header');
                    if(actionsHeader) {
                        actionsHeader.closest('.actions-category').classList.toggle('open');
                    }
                    const folderHeader = e.target.closest('.folder-header'); // New: for folders category
                    if(folderHeader) {
                        folderHeader.closest('.folders-category').classList.toggle('open');
                    }

                    const workflowButton = e.target.closest('[data-workflow]');
                    if (workflowButton) {
                        const workflowKey = workflowButton.dataset.workflow;
                        const config = workflowConfigs[workflowKey];
                         if (config) {
                            if (workflowKey === 'notepad-app') {
                                selectChat('notepad-app');
                            } else {
                                createNewChat(config);
                            }
                        }
                    }
                });
                
                dom.webLaunchOfferBtn.addEventListener('click', () => { const offerTitle = `<i class="fas fa-gift mr-2"></i>Tu Oferta de Lanzamiento Exclusiva`; const offerMessage = `<p class="font-bold mb-2">Al suscribirte a nuestro Plan Pro por $17/mes, desbloqueas:</p><ul class="list-disc list-inside space-y-2 text-left"><li><strong>Acceso Ilimitado a Goatify IA:</strong> Todos los modelos y workflows sin restricciones.</li><li><strong>Construccin de tu Pgina Web Profesional:</strong> Nosotros construiremos la primera versin, gratis!</li></ul><p class="font-bold mt-4 mb-2">Cmo funciona?</p><ol class="list-decimal list-inside space-y-1 text-left"><li><strong>Agenda tu Sesin Estratgica:</strong> Al confirmar, agenda tu llamada de 20 min.</li><li><strong>Co-creacin:</strong> En la llamada definiremos objetivos y crearemos el borrador con IA.</li><li><strong>Entrega:</strong> Nuestro equipo lo pulir y te entregar una web de una seccin, lista.</li></ol><p class="text-xs mt-4 italic"><strong>Importante:</strong> La web es tuya para siempre. Para mantenerla online con nuestro hosting, necesitas tu suscripcin Pro activa. Si cancelas, te entregamos el cdigo completo.</p>`; showModal({ title: offerTitle, body: offerMessage, confirmText: 'Agendar Sesin Estratgica' }).then(res => { if (res.confirmed) { window.open('https://calendly.com/goatify', '_blank'); } });
                });
                dom.freeGuidesLink.addEventListener('click', (e) => { e.preventDefault(); const isPaidUser = currentUser && currentUser.app_metadata?.plan && currentUser.app_metadata.plan !== 'free'; if (isPaidUser) { window.open('https://goatify.app/guiasIA', '_blank'); } else { const title = 'Acceso Exclusivo para Suscriptores'; const message = 'Estas guas se actualizan semanalmente con estrategias de negocio que te ayudarn a crecer un montn. Son un beneficio exclusivo para nuestros suscriptores. nete a un plan para desbloquearlas!'; showModal({ title, body: message, confirmText: 'Ver Planes' }).then(res => { if (res.confirmed) { showPricingModal(); } }); } });
                dom.closeHtmlPreviewModalBtn?.addEventListener('click', () => { dom.htmlPreviewModal.classList.add('hidden'); dom.htmlPreviewModal.classList.remove('flex'); });
                
                dom.voiceSelector?.addEventListener('change', (e) => { selectedVoice = availableVoices.find(voice => voice.name === e.target.value); });

                document.addEventListener('click', (e) => { 
                    if (dom.userMenuBtn && dom.userMenuPopup && !dom.userMenuBtn.contains(e.target) && !dom.userMenuPopup.contains(e.target)) { dom.userMenuPopup.classList.add('hidden'); } 
                    
                    const servicesMenu = dom.servicesMenu;
                    const servicesMenuBtn = dom.servicesMenuBtn;
                    if (servicesMenu && servicesMenuBtn && servicesMenu.classList.contains('show') && !servicesMenuBtn.contains(e.target) && !servicesMenu.contains(e.target)) {
                        servicesMenu.classList.remove('show');
                    }
                    if (dom.tagFilterDropdown && dom.tagFilterBtn && !dom.tagFilterBtn.contains(e.target) && !dom.tagFilterDropdown.contains(e.target)) {
                        dom.tagFilterDropdown.classList.add('hidden');
                    }
                });

                const solutionLinks = {
                    "sol-web": "Hola, estoy interesado en su servicio de 'Pginas Web que Convierten'. Podran darme ms informacin?",
                    "sol-auto": "Hola, me interesa saber ms sobre 'Ventas en Piloto Automtico' con IA. Cmo funciona?",
                    "sol-social": "Hola, quisiera informacin sobre los 'Avatares para Redes Sociales' y las estrategias de contenido.",
                    "sol-consult": "Hola, estoy interesado en la consultora para 'Escalar mi Empresa con IA'. Cules son los siguientes pasos?"
                };

                Object.entries(solutionLinks).forEach(([id, message]) => {
                    const linkEl = document.getElementById(id);
                    if (linkEl) {
                        linkEl.addEventListener('click', (e) => {
                            e.preventDefault();
                            const whatsappUrl = `https://wa.me/17439106116?text=${encodeURIComponent(message)}`;
                            window.open(whatsappUrl, '_blank');
                        });
                    }
                });

                dom.servicesMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dom.servicesMenu.classList.toggle('show');
                });

                const setAppHeight = () => { const app = document.getElementById('app-container'); if(app) app.style.height = `${window.innerHeight}px`; };
                setAppHeight();
                window.addEventListener('resize', setAppHeight);
                dom.selectChatsBtn?.addEventListener('click', () => toggleSelectMode(true));
                dom.cancelSelectModeBtn?.addEventListener('click', () => toggleSelectMode(false));
                dom.deleteSelectedBtn?.addEventListener('click', async () => { if (chatsToDelete.size === 0) return; const confirm = await showModal({ title: `Eliminar ${chatsToDelete.size} elemento(s)`, body: 'Esta accin es irreversible. Confirmas la eliminacin?', confirmText: 'Eliminar', dangerConfirm: true }); if (confirm.confirmed) { chatsToDelete.forEach(id => deleteItem(id.split('-')[0], id)); toggleSelectMode(false); } });
                dom.settingsBtn?.addEventListener('click', showSettingsModal);
                dom.closeSettingsModal?.addEventListener('click', hideSettingsModal);
                dom.settingsUpgradePlanBtn?.addEventListener('click', () => { hideSettingsModal(); showPricingModal(); });
                dom.fontSizeSlider?.addEventListener('input', (e) => {
                    // Update CSS variable directly
                    document.documentElement.style.setProperty('--base-font-size', `${e.target.value}px`);
                    dom.fontSizeValue.textContent = `${e.target.value}px`;
                });
                dom.settingsThemeToggle?.addEventListener('click', () => {
                    setTheme(!document.body.classList.contains('dark-theme'));
                });
                dom.notificationsToggle?.addEventListener('change', () => {
                    notificationsEnabled = dom.notificationsToggle.checked;
                    localStorage.setItem('goatify-notifications-enabled', notificationsEnabled);
                     if (notificationsEnabled) {
                        setupNotifications();
                     }
                });
                dom.languageSelector?.addEventListener('change', (e) => {
                    setLanguage(e.target.value);
                });
                dom.connectWhatsappBtn?.addEventListener('click', () => {
                    window.open('https://wa.me/17439106116?text=Hola%2C%20me%20gustar%C3%ADa%20conectar%20mi%20cuenta%20de%20Goatify%20IA%20a%20WhatsApp.', '_blank');
                });
                dom.scheduleMeetingBtn?.addEventListener('click', () => {
                    window.open('https://calendly.com/goatify', '_blank');
                });
                dom.freePlanButton?.addEventListener('click', showPricingModal);

                const calendarClickHandler = () => showCalendarModal();
                dom.calendarBtn?.addEventListener('click', calendarClickHandler);

                dom.projectCalendarBtn?.addEventListener('click', showCalendarModal);
                dom.closeCalendarModal?.addEventListener('click', hideCalendarModal);
                
                dom.prevMonthBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.subtract(1, 'month'); renderCalendarView(); });
                dom.nextMonthBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.add(1, 'month'); renderCalendarView(); });
                dom.prevWeekBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.subtract(1, 'week'); renderCalendarView(); });
                dom.nextWeekBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.add(1, 'week'); renderCalendarView(); });
                dom.prevDayBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.subtract(1, 'day'); renderCalendarView(); });
                dom.nextDayBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.add(1, 'day'); renderCalendarView(); });

                dom.monthViewBtn.addEventListener('click', () => { currentCalendarView = 'month'; renderCalendarView(); });
                dom.weekViewBtn.addEventListener('click', () => { currentCalendarView = 'week'; renderCalendarView(); });
                dom.dayViewBtn.addEventListener('click', () => { currentCalendarView = 'day'; renderCalendarView(); });
                dom.addTaskBtn?.addEventListener('click', () => editCalendarTask(null, selectedCalendarDate.format('YYYY-MM-DD')));

                dom.viewToggleKanban.addEventListener('click', () => {
                    if (!currentChatId) return;
                    const chat = state.chats[currentChatId];
                    if (!chat || !chat.projectData) return;
                    chat.projectData.currentView = 'kanban';
                     renderProjectBoard(currentChatId);
                });
                dom.viewToggleList.addEventListener('click', () => {
                    if (!currentChatId) return;
                    const chat = state.chats[currentChatId];
                    if (!chat || !chat.projectData) return;
                    chat.projectData.currentView = 'list';
                     renderProjectBoard(currentChatId);
                });
                 dom.addTaskListViewBtn.addEventListener('click', () => {
                    if (currentChatId) {
                        editProjectTask(currentChatId, null, 'todo');
                    }
                });
                
                document.body.addEventListener('click', e => {
                    const toggleAndContainer = [
                        { header: '#project-chat-container-header', container: dom.projectChatContainer },
                        { header: '#financial-chat-header', container: document.getElementById('financial-chat-container') },
                        { header: '#notepad-chat-header', container: dom.notepadChatContainer }
                    ];

                    toggleAndContainer.forEach(item => {
                        if (e.target.closest(item.header)) {
                             item.container?.classList.toggle('collapsed');
                        }
                    });
                });

                // NOTEPAD Event Listeners
                dom.addNewNoteBtn?.addEventListener('click', () => createNewNote('text'));
                dom.addNewDrawingBtn?.addEventListener('click', () => createNewNote('drawing'));
                dom.deleteNoteBtn?.addEventListener('click', () => deleteItem('note', currentNoteId));
                dom.shareNoteBtn?.addEventListener('click', shareNote);
                dom.noteBackBtn?.addEventListener('click', () => {
                    dom.notepadViewContainer.classList.remove('mobile-editor-active');
                });
                dom.noteTitleInput?.addEventListener('input', (e) => {
                    const note = state.notes.find(n => n.id === currentNoteId);
                    if (note && note.title !== e.target.value) {
                        note.title = e.target.value;
                        saveState();
                        renderSidebar();
                    }
                });
                dom.noteContentEditor?.addEventListener('input', () => {
                    const note = state.notes.find(n => n.id === currentNoteId);
                     if (note && note.type === 'text') {
                        note.content = dom.noteContentEditor.innerHTML;
                        saveState();
                    }
                });
                dom.addChecklistItemBtn?.addEventListener('click', () => {
                    const selection = window.getSelection();
                    const range = selection.getRangeAt(0);
                    const currentContainer = selection.focusNode?.parentElement?.closest('#note-content-editor, .checklist-item-text');

                    // Create the checklist item HTML structure with proper spacing and checkbox position
                    const newChecklistItemHTML = `<div class="checklist-item"><input type="checkbox" class="checklist-item-checkbox"><span contenteditable="true" class="checklist-item-text"></span></div>`;
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = newChecklistItemHTML;
                    const newChecklistItemNode = tempDiv.firstChild;

                    if (currentContainer && dom.noteContentEditor.contains(currentContainer)) {
                        range.deleteContents(); // Remove any selected text

                        if (currentContainer.classList.contains('checklist-item-text')) {
                            // If cursor is within a checklist item, insert the new item after its parent
                            const parentChecklistItem = currentContainer.closest('.checklist-item');
                            parentChecklistItem.parentNode.insertBefore(newChecklistItemNode, parentChecklistItem.nextSibling);
                        } else {
                            // If cursor is in the main editor, insert at the current range
                            range.insertNode(newChecklistItemNode);
                        }
                        
                        // Set cursor to the new text span and focus
                        const newTextSpan = newChecklistItemNode.querySelector('.checklist-item-text');
                        if (newTextSpan) {
                            range.setStart(newTextSpan, 0);
                            range.setEnd(newTextSpan, 0);
                            selection.removeAllRanges();
                            selection.addRange(range);
                            newTextSpan.focus();
                        }
                    } else {
                        // Fallback to appending if no selection or not in editor
                        dom.noteContentEditor.innerHTML += newChecklistItemHTML;
                        const newChecklistItem = dom.noteContentEditor.lastElementChild;
                        const newTextSpan = newChecklistItem.querySelector('.checklist-item-text');
                        if (newTextSpan) {
                            newTextSpan.focus();
                        }
                    }

                    const note = state.notes.find(n => n.id === currentNoteId);
                    if (note) {
                        note.content = dom.noteContentEditor.innerHTML;
                        saveState();
                    }
                });

                dom.noteContentEditor?.addEventListener('click', e => {
                    handleChecklistItem(e.target);
                });
                dom.noteContentEditor?.addEventListener('keydown', e => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        const selection = window.getSelection();
                        const range = selection.getRangeAt(0);
                        const currentChecklistItem = range.startContainer.closest('.checklist-item');

                        if (currentChecklistItem) {
                            e.preventDefault(); // Prevent default Enter behavior

                            const newChecklistItem = document.createElement('div');
                            newChecklistItem.className = 'checklist-item';
                            newChecklistItem.innerHTML = `<input type="checkbox" class="checklist-item-checkbox"><span contenteditable="true" class="checklist-item-text"></span>`;

                            // Insert the new checklist item after the current one
                            currentChecklistItem.parentNode.insertBefore(newChecklistItem, currentChecklistItem.nextSibling);

                            // Set cursor to the new text span
                            const newTextSpan = newChecklistItem.querySelector('.checklist-item-text');
                            if (newTextSpan) {
                                newTextSpan.focus();
                            }
                            
                            // Save state after adding new checklist item
                            const note = state.notes.find(n => n.id === currentNoteId);
                            if (note) {
                                note.content = dom.noteContentEditor.innerHTML;
                                saveState();
                            }
                        }
                    }
                });

                document.querySelectorAll('.plan-details-toggle').forEach(button => {
                    button.addEventListener('click', () => {
                        const details = button.nextElementSibling;
                        details.classList.toggle('open');
                    });
                 });

                setupModalClickOutside(dom.genericModal, ()=>hideModal({confirmed: false}));
                setupModalClickOutside(dom.pricingModal, hidePricingModal);
                setupModalClickOutside(dom.settingsModal, hideSettingsModal);
                // Calendar modal is now positioned in the center, so no need for specific positioning logic
                setupModalClickOutside(dom.calendarModalOverlay, hideCalendarModal); 
                setupModalClickOutside(dom.motivationModal, hideMotivationModal);
                setupModalClickOutside(dom.htmlPreviewModal, () => {
                    dom.htmlPreviewModal.classList.add('hidden');
                    dom.htmlPreviewModal.classList.remove('flex');
                });
                dom.gamificationBtn?.addEventListener('click', () => {
                    if(!currentUser) {
                        showInAppNotification("Funcin Exclusiva", "La gamificacin est disponible para usuarios logueados.", 3000);
                        return;
                    }
                    renderGamificationModal();
                    dom.gamificationModal.classList.remove('hidden');
                    dom.gamificationModal.classList.add('flex');
                     setTimeout(() => dom.gamificationModal.querySelector('.modal-content').classList.remove('scale-95'), 10);
                });
                dom.closeGamificationModal?.addEventListener('click', () => {
                    dom.gamificationModal.querySelector('.modal-content').classList.add('scale-95');
                    setTimeout(() => { dom.gamificationModal.classList.add('hidden'); dom.gamificationModal.classList.remove('flex'); }, 300);
                });
                // Event listener for clicking outside the gamification modal content to close it
                dom.gamificationModal.addEventListener('click', (e) => {
                    if (e.target === dom.gamificationModal) { // Check if the click was directly on the overlay
                        dom.closeGamificationModal.click(); // Simulate click on the close button
                    }
                });

                dom.gamificationRulesBtn?.addEventListener('click', () => {
                    dom.gamificationRulesModal.classList.remove('hidden');
                    dom.gamificationRulesModal.classList.add('flex');
                });
                dom.closeGamificationRulesModal?.addEventListener('click', () => {
                    dom.gamificationRulesModal.classList.add('hidden');
                    dom.gamificationRulesModal.classList.remove('flex');
                });
                setupModalClickOutside(dom.gamificationRulesModal, () => {
                    dom.gamificationRulesModal.classList.add('hidden');
                    dom.gamificationRulesModal.classList.remove('flex');
                });
                dom.gamificationModal.querySelectorAll('.gamification-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        dom.gamificationModal.querySelector('.gamification-tab.active').classList.remove('active');
                        tab.classList.add('active');
                        dom.gamificationModal.querySelectorAll('.gamification-tab-content').forEach(content => content.classList.add('hidden'));
                         dom.gamificationModal.querySelector(`#gamification-tab-${tab.dataset.tab}`).classList.remove('hidden');
                    });
                });
                dom.missionsContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-mission-id]');
                    if (button && !button.disabled) {
                        const missionId = button.dataset.missionId;
                        const mission = MISSIONS[missionId];
                        if (mission && mission.workflow) {
                            const workflowButton = document.querySelector(`[data-workflow="${mission.workflow}"]`);
                            if(workflowButton) {
                                workflowButton.click();
                                dom.closeGamificationModal.click();
                            }
                        }
                    }
                });

                dom.planCreditsBtn?.addEventListener('click', () => {
                    dom.planCreditsInfoModal.classList.remove('hidden');
                    dom.planCreditsInfoModal.classList.add('flex');
                });
                dom.closePlanCreditsInfoModal?.addEventListener('click', () => {
                    dom.planCreditsInfoModal.classList.add('hidden');
                    dom.planCreditsInfoModal.classList.remove('flex');
                });
                setupModalClickOutside(dom.planCreditsInfoModal, () => {
                    dom.planCreditsInfoModal.classList.add('hidden');
                    dom.planCreditsInfoModal.classList.remove('flex');
                });
            }

            function renderProjectView(chatId) {
                const chat = state.chats[chatId];
                if (!chat) return;

                if (!chat.projectData) {
                    chat.projectData = {
                        title: chat.title,
                        columns: [
                             { id: 'todo', title: 'Por Hacer', tasks: [] },
                            { id: 'doing', title: 'En Progreso', tasks: [] },
                            { id: 'done', title: 'Hecho', tasks: [] }
                         ],
                        currentView: 'list'
                    };
                }

                dom.projectViewTitle.textContent = chat.projectData.title;
                const projectChatMessages = document.getElementById('project-chat-messages');
                if(projectChatMessages) {
                    projectChatMessages.innerHTML = '';
                    chat.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, msg.image, index, projectChatMessages));
                }
                
                if (window.innerWidth < 768) {
                    dom.projectChatContainer.classList.add('collapsed');
                } else {
                    dom.projectChatContainer.classList.remove('collapsed');
                }
                renderProjectBoard(chatId);
                
                const projectModelSelector = document.getElementById('project-model-selector');
                if (projectModelSelector) {
                    const goatXProOption = projectModelSelector.querySelector('.goat-x-pro-model');
                    if (goatXProOption) goatXProOption.disabled = !currentUser;
                }
            }
            
            function renderProjectBoard(chatId) {
                const chat = state.chats[chatId];
                if(!chat || !chat.projectData) return;
                const { projectData } = chat;
                const isMobile = window.innerWidth < 768;

                const isKanban = projectData.currentView === 'kanban';
                dom.viewToggleKanban.classList.toggle('active', isKanban);
                dom.viewToggleList.classList.toggle('active', !isKanban);

                dom.kanbanView.style.display = isKanban ? 'grid' : 'none';
                dom.listView.style.display = (!isKanban && !isMobile) ? 'flex' : 'none';
                dom.listViewMobile.style.display = (!isKanban && isMobile) ? 'block' : 'none';
                dom.addTaskListViewBtn.style.display = isKanban ? 'none' : 'block';
                
                if (isKanban) {
                    renderKanbanView(chatId);
                } else {
                    if (isMobile) {
                        renderListViewMobile(chatId);
                    } else {
                        renderListView(chatId);
                    }
                }
                renderTagFilter(chatId);
            }

            function renderKanbanView(chatId) {
                const { projectData } = state.chats[chatId];
                dom.kanbanView.innerHTML = '';

                projectData.columns.forEach(column => {
                    const columnEl = document.createElement('div');
                    columnEl.className = 'kanban-column';
                    columnEl.innerHTML = `<h3 class="kanban-column-title">
                        <span>${column.title}</span>
                         <button class="add-task-to-column-btn text-lg hover:text-primary" data-column-id="${column.id}">+</button>
                    </h3><div class="kanban-cards" data-column-id="${column.id}"></div>`;
                    
                    const cardsContainer = columnEl.querySelector('.kanban-cards');
                     
                    const tasksToRender = (column.tasks || []).filter(task => !activeTagFilter || (task.labels && task.labels.includes(activeTagFilter)));

                    tasksToRender.forEach(task => {
                        const cardEl = document.createElement('div');
                         cardEl.className = 'kanban-card';
                        if (task.urgent) cardEl.classList.add('urgent');
                        if (task.completed) cardEl.classList.add('task-item-completed');
                        cardEl.draggable = true;
                        cardEl.dataset.taskId = task.id;
                        
                        const labelsHtml = (task.labels || []).map(label => `<span class="task-label" style="background-color: ${getLabelColor(label)}; color: white;">${label}</span>`).join('');
                        cardEl.innerHTML = `
                        <i class="fas fa-times delete-task-icon" data-task-id="${task.id}"></i>
                        <div class="flex justify-between items-start">
                            <p>${task.content}</p>
                            ${task.urgent ? '<i class="fas fa-flag text-red-500 ml-2" title="Urgente"></i>' : ''}
                        </div>
                        <div class="task-labels">${labelsHtml}</div>
                        <div class="card-footer">
                             <span>${task.dueDate ? `<i class="fas fa-calendar-alt mr-1"></i> ${dayjs(task.dueDate).format('D MMM')}` : ''}</span>
                            <span>${task.time || ''}</span>
                        </div>`;
                        cardEl.addEventListener('dragstart', e => {
                            e.dataTransfer.setData('text/plain', task.id);
                            e.dataTransfer.effectAllowed = 'move';
                        });
                        cardEl.addEventListener('touchstart', handleTouchStart, {passive: false});

                        cardEl.addEventListener('click', (e) => {
                            if (e.target.classList.contains('delete-task-icon')) {
                                e.stopPropagation();
                                deleteTask(task.id, chatId);
                            } else {
                                editProjectTask(chatId, task.id);
                            }
                        });
                        
                        cardsContainer.appendChild(cardEl);
                    });

                    cardsContainer.addEventListener('dragover', e => { e.preventDefault(); cardsContainer.classList.add('drag-over'); });
                    cardsContainer.addEventListener('dragleave', () => { cardsContainer.classList.remove('drag-over'); });
                    cardsContainer.addEventListener('drop', e => {
                        e.preventDefault();
                        cardsContainer.classList.remove('drag-over');
                        const taskId = e.dataTransfer.getData('text/plain');
                        if (!taskId.startsWith('proj-')) return;
                         moveTask(chatId, taskId, column.id);
                    });
                    dom.kanbanView.appendChild(columnEl);
                });

                dom.kanbanView.querySelectorAll('.add-task-to-column-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const columnId = e.currentTarget.dataset.columnId;
                        editProjectTask(chatId, null, columnId);
                    });
                });
            }

            function renderListView(chatId) {
                const { projectData } = state.chats[chatId];
                dom.listView.innerHTML = ''; 

                const header = document.createElement('div');
                header.className = 'list-view-header flex-shrink-0';
                header.innerHTML = `
                     <span class="truncate">Nombre</span>
                    <span class="truncate">Fecha y Hora</span>
                    <span class="truncate">Prioridad</span>
                    <span class="truncate">Etiquetas</span>
                    <span class="truncate"></span>
                `;
                dom.listView.appendChild(header);

                const listContent = document.createElement('div');
                listContent.className = 'list-view-content';

                projectData.columns.forEach(column => {
                    const columnTitle = document.createElement('h4');
                    columnTitle.className = 'font-bold text-text-medium p-2 bg-current-bg-light mt-2 rounded cursor-pointer';
                    columnTitle.textContent = column.title;
                    columnTitle.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-primary)'; });
                    columnTitle.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    columnTitle.addEventListener('drop', e => {
                        e.preventDefault();
                        e.currentTarget.style.backgroundColor = '';
                        const taskId = e.dataTransfer.getData('text/plain');
                        if (taskId) {
                            moveTask(chatId, taskId, column.id);
                        }
                    });
                    listContent.appendChild(columnTitle);
                    
                    const tasksToRender = (column.tasks || []).filter(task => !activeTagFilter || (task.labels && task.labels.includes(activeTagFilter)));

                    tasksToRender.forEach(task => {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'list-view-task';
                        if(column.id !== 'done') taskEl.draggable = true;
                        taskEl.dataset.taskId = task.id;
                        
                        const labelsHtml = (task.labels || []).map(label => `<span class="task-label" style="background-color: ${getLabelColor(label)}; color: white;">${label}</span>`).join('');
                        
                        // Use a contenteditable span instead of a read-only one for direct editing
                        taskEl.innerHTML = `
                            <span contenteditable="true" class="truncate task-content-list ${task.urgent ? 'urgent' : ''}" data-task-id="${task.id}">${task.content}</span>
                            <span class="text-sm truncate flex items-center gap-2">
                                <input type="date" class="task-date-input" value="${task.dueDate || ''}" data-task-id="${task.id}">
                                <input type="time" class="task-time-input" value="${task.time || ''}" data-task-id="${task.id}">
                            </span>
                            <div class="priority-cell" data-task-id="${task.id}">
                                ${task.urgent ? '<i class="fas fa-flag text-red-500" title="Urgente"></i>' : '<i class="far fa-flag text-text-medium" title="No urgente"></i>'}
                            </div>
                            <div class="task-labels truncate">${labelsHtml || ''}</div>
                            <div class="text-center">
                                <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1" data-task-id="${task.id}"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        `;
                        
                        taskEl.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', task.id); });
                        taskEl.addEventListener('touchstart', handleTouchStart, {passive: false});
                        listContent.appendChild(taskEl);
                    });

                    const newRowEl = document.createElement('div');
                    newRowEl.className = 'list-view-task';
                    newRowEl.innerHTML = `
                        <button class="add-task-to-list-btn text-left text-text-medium hover:text-primary"><i class="fas fa-plus mr-2"></i>Aadir tarea</button>
                        <span/><span/><span/><span/>
                    `;
                    newRowEl.querySelector('.add-task-to-list-btn').addEventListener('click', () => {
                        editProjectTask(chatId, null, column.id);
                    });
                    listContent.appendChild(newRowEl);
                });
                
                dom.listView.appendChild(listContent);
                
                dom.listView.querySelectorAll('.task-content-list').forEach(span => {
                    // Re-attaching event listeners for direct editing on span
                    span.addEventListener('input', (e) => {
                        const taskId = e.currentTarget.dataset.taskId;
                        updateTaskStatus(taskId, { content: e.currentTarget.textContent.trim() });
                    });
                    span.addEventListener('blur', (e) => {
                        const taskId = e.currentTarget.dataset.taskId;
                        updateTaskStatus(taskId, { content: e.currentTarget.textContent.trim() });
                    });
                    span.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            e.currentTarget.blur(); // Save changes and unfocus
                        }
                    });
                });
                 dom.listView.querySelectorAll('.task-date-input, .task-time-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                         const taskId = e.currentTarget.dataset.taskId;
                         const field = e.currentTarget.classList.contains('task-date-input') ? 'dueDate' : 'time';
                         updateTaskStatus(taskId, { [field]: e.currentTarget.value });
                    });
                });
                dom.listView.querySelectorAll('.priority-cell').forEach(cell => {
                     cell.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const taskId = e.currentTarget.dataset.taskId;
                        const task = findTask(taskId)?.task;
                        if(task) updateTaskStatus(taskId, { urgent: !task.urgent });
                    });
                });
                dom.listView.querySelectorAll('.delete-task-icon').forEach(btn => {
                     btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteTask(e.currentTarget.dataset.taskId, chatId);
                    });
                });
            }

            function renderListViewMobile(chatId) {
                const { projectData } = state.chats[chatId];
                dom.listViewMobile.innerHTML = ''; 

                projectData.columns.forEach(column => {
                    const columnEl = document.createElement('div');
                    columnEl.className = "list-view-column-mobile my-2";
                    columnEl.dataset.columnId = column.id;
                    const columnTitle = document.createElement('h4');
                    columnTitle.className = 'font-bold text-text-medium p-2 bg-current-bg-light mt-2 rounded-t-md';
                    columnTitle.textContent = column.title;
                    columnEl.appendChild(columnTitle);

                    const tasksContainer = document.createElement('div');
                    const tasksToRender = (column.tasks || []).filter(task => !activeTagFilter || (task.labels && task.labels.includes(activeTagFilter)));
                    
                    tasksToRender.forEach(task => {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'list-view-task-mobile';
                        taskEl.draggable = true;
                        taskEl.dataset.taskId = task.id;
                         if (task.completed) taskEl.classList.add('task-item-completed');
                        
                        const labelsHtml = (task.labels || []).map(label => `<span class="task-label" style="background-color: ${getLabelColor(label)}; color: white;">${label}</span>`).join('');

                        // Use a contenteditable span for direct editing
                        taskEl.innerHTML = `
                            <div class="list-view-task-mobile-header">
                                <span contenteditable="true" class="task-content-list flex-grow ${task.urgent ? 'urgent' : ''}" data-task-id="${task.id}">${task.content}</span>
                                <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1 flex-shrink-0" data-task-id="${task.id}"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <div class="list-view-task-mobile-footer">
                                <div class="task-labels truncate">${labelsHtml || ''}</div>
                                <div class="task-time-date-inputs">
                                     <input type="time" class="task-time-input" value="${task.time || ''}" data-task-id="${task.id}">
                                     <input type="date" class="task-date-input" value="${task.dueDate || ''}" data-task-id="${task.id}">
                                </div>
                            </div>
                        `;
                        taskEl.addEventListener('touchstart', handleTouchStart, {passive: false});
                        tasksContainer.appendChild(taskEl);
                    });

                    const addTaskBtn = document.createElement('button');
                    addTaskBtn.className = 'add-task-to-list-btn text-left text-text-medium hover:text-primary p-2 w-full';
                    addTaskBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Aadir tarea';
                    addTaskBtn.onclick = () => {
                         editProjectTask(chatId, null, column.id);
                    };
                    tasksContainer.appendChild(addTaskBtn);
                    
                    columnEl.appendChild(tasksContainer);
                    columnEl.addEventListener('dragover', e => { e.preventDefault(); columnEl.style.backgroundColor = 'rgba(138, 79, 255, 0.1)'; });
                    columnEl.addEventListener('dragleave', e => { columnEl.style.backgroundColor = ''; });
                    columnEl.addEventListener('drop', e => {
                         e.preventDefault();
                         columnEl.style.backgroundColor = '';
                         const taskId = e.dataTransfer.getData('text/plain');
                         if(taskId.startsWith('proj-')) {
                            moveTask(chatId, taskId, column.id);
                         }
                    });
                    dom.listViewMobile.appendChild(columnEl);
                });

                dom.listViewMobile.querySelectorAll('.task-content-list').forEach(span => {
                    // Re-attaching event listeners for direct editing on span
                    span.addEventListener('input', (e) => {
                        const taskId = e.currentTarget.dataset.taskId;
                        updateTaskStatus(taskId, { content: e.currentTarget.textContent.trim() });
                    });
                    span.addEventListener('blur', (e) => {
                        const taskId = e.currentTarget.dataset.taskId;
                        updateTaskStatus(taskId, { content: e.currentTarget.textContent.trim() });
                    });
                    span.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            e.currentTarget.blur(); // Save changes and unfocus
                        }
                    });
                });
                dom.listViewMobile.querySelectorAll('.task-date-input, .task-time-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                         const taskId = e.currentTarget.dataset.taskId;
                         const field = e.currentTarget.classList.contains('task-date-input') ? 'dueDate' : 'time';
                         updateTaskStatus(taskId, { [field]: e.currentTarget.value });
                    });
                });
                dom.listViewMobile.querySelectorAll('.delete-task-icon').forEach(btn => {
                     btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteTask(e.currentTarget.dataset.taskId, chatId);
                    });
                });
            }

            function makeEditable(element, field) {
                // This function is now mainly for text content that is NOT input elements
                // For date/time/priority, direct input/button clicks are handled
                if (element.contentEditable === 'true') {
                    // It's already contenteditable, just ensure focus if needed
                    element.focus();
                    return;
                }

                const taskId = element.dataset.taskId;
                const originalText = element.textContent;
                
                element.contentEditable = 'true';
                element.focus();
                // Select all text when it becomes editable
                const range = document.createRange();
                range.selectNodeContents(element);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);

                const save = () => {
                    element.contentEditable = 'false';
                    const newText = element.textContent.trim() || originalText;
                    updateTaskStatus(taskId, { [field]: newText });
                };
                
                element.addEventListener('blur', save, { once: true });
                element.addEventListener('keydown', (ev) => { 
                    if(ev.key === 'Enter') {
                        ev.preventDefault(); // Prevent new line
                        save(); 
                    }
                }, { once: true });
            }

            async function deleteTask(taskId, chatId) {
                const lang = localStorage.getItem('goatify-lang') || 'es';
                const result = await showModal({
                    title: translations[lang].delete_task_confirm_title,
                    body: translations[lang].delete_task_confirm_body,
                    confirmText: translations[lang].delete_btn,
                    dangerConfirm: true
                });

                if (result.confirmed) {
                    const found = findTask(taskId);
                    if (!found) return;

                    if (found.type === 'personal') {
                        const { dayKey, taskIndex } = found;
                        state.calendar[dayKey].splice(taskIndex, 1);
                        if(state.calendar[dayKey].length === 0) delete state.calendar[dayKey];
                    } else if (found.type === 'project') {
                        const { column, taskIndex } = found;
                        column.tasks.splice(taskIndex, 1);
                    }
                    saveState();
                    if (dom.calendarModalOverlay.classList.contains('flex')) renderCalendarView();
                    if (dom.projectManagementView.style.display === 'flex') renderProjectBoard(chatId || currentChatId);
                }
            }
            
            async function editProjectTask(chatId, taskId, columnIdForNew) {
                const task = taskId ? findTask(taskId)?.task : null;
                const isNew = !task;
                
                const result = await showModal({
                    title: isNew ? 'Nueva Tarea de Proyecto' : 'Editar Tarea',
                    body: `
                        <div class="space-y-4">
                            <div><label for="task-content-edit" class="block text-sm font-medium text-text-light mb-1">Contenido:</label><textarea id="task-content-edit" class="w-full p-2 rounded bg-input border border-themed h-24">${isNew ? '' : task.content}</textarea></div>
                            <div class="flex gap-4"><div class="flex-1"><label for="task-due-date" class="block text-sm font-medium text-text-light mb-1">Fecha:</label><input type="date" id="task-due-date" value="${isNew ? '' : task.dueDate || ''}" class="w-full p-2 rounded bg-input border border-themed"></div><div class="flex-1"><label for="task-due-time" class="block text-sm font-medium text-text-light mb-1">Hora:</label><input type="time" id="task-due-time" value="${isNew ? '' : task.time || ''}" class="w-full p-2 rounded bg-input border border-themed"></div></div>
                            <div><label for="task-labels-input" class="block text-sm font-medium text-text-light mb-1">Etiquetas (separadas por coma):</label><input type="text" id="task-labels-input" value="${isNew ? '' : (task.labels || []).join(', ')}" class="w-full p-2 rounded bg-input border border-themed"></div>
                            <div><label class="flex items-center cursor-pointer"><input type="checkbox" id="task-urgent-checkbox" class="rounded bg-input border-themed" ${isNew ? '' : (task.urgent ? 'checked' : '')}><span class="ml-2 text-sm text-text-light">Marcar como Urgente</span><i class="fas fa-flag text-red-500 ml-2"></i></label></div>
                        </div>`,
                    confirmText: 'Guardar'
                });

                if (result.confirmed) {
                    const newContent = result.data['task-content-edit'];
                    if (newContent.trim()) {
                        const updatedTaskData = {
                            content: newContent.trim(),
                            dueDate: result.data['task-due-date'] || null,
                            time: result.data['task-due-time'] || null,
                            labels: result.data['task-labels-input'].split(',').map(l => l.trim()).filter(Boolean),
                            urgent: result.data['task-urgent-checkbox']
                        };
                        if (isNew) {
                            const column = state.chats[chatId].projectData.columns.find(c => c.id === columnIdForNew);
                            if (column) {
                                if (!column.tasks) column.tasks = [];
                                column.tasks.push({ id: `proj-${crypto.randomUUID()}`, ...updatedTaskData, completed: false });
                                saveState();
                                renderProjectBoard(chatId);
                            }
                        } else {
                            updateTaskStatus(taskId, updatedTaskData);
                        }
                    }
                }
            }
            
            async function editCalendarTask(taskId, preselectedDate = null, preselectedTime = null) {
                const task = taskId ? findTask(taskId)?.task : null;
                const taskDayKey = taskId ? findTask(taskId)?.dayKey : null;
                const isNew = !task;

                const createProjectFromTask = async (modalBody) => {
                    const content = modalBody.querySelector('#cal-task-content-edit').value;
                    if (!content.trim()) return;
                    hideModal();
                    
                    setTimeout(async () => {
                         const projResult = await showModal({
                            title: 'Crear Nuevo Proyecto',
                            body: `<p>Ingresa un nombre para el nuevo proyecto basado en la tarea "${content.substring(0,30)}...".</p>
                                <input type="text" id="new-proj-name" class="w-full p-2 rounded bg-input border border-themed mt-2" value="${content.split(' ').slice(0,4).join(' ')}">`,
                            confirmText: 'Crear Proyecto'
                        });

                        if(projResult.confirmed && projResult.data['new-proj-name']) {
                            const newProjectId = 'project-' + crypto.randomUUID();
                            state.projects[newProjectId] = { id: newProjectId, title: projResult.data['new-proj-name'], itemIds: [] };
                            state.structure.unshift(newProjectId);
                            
                            const newTaskChatId = createNewChat({title: projResult.data['new-proj-name'], workflow: 'project-management'});
                            state.projects[newProjectId].itemIds.push(newTaskChatId);
                            
                            const taskDataFromModal = {
                                content: content,
                                dueDate: modalBody.querySelector('#cal-task-date').value || null,
                                time: modalBody.querySelector('#cal-task-time').value || null,
                                labels: [], urgent: false, completed: false
                            };
                            const todoColumn = state.chats[newTaskChatId].projectData.columns.find(c => c.id === 'todo');
                            todoColumn.tasks.push({ id: `proj-${crypto.randomUUID()}`, ...taskDataFromModal });

                            await saveState();
                            renderSidebar();
                            selectChat(newTaskChatId);
                        }
                    }, 250);
                };
                
                const result = await showModal({
                    title: isNew ? 'Nueva Tarea Personal' : 'Editar Tarea Personal',
                    body: `
                    <div class="space-y-4">
                        <div><label for="cal-task-content-edit" class="block text-sm font-medium text-text-light mb-1">Contenido:</label><textarea id="cal-task-content-edit" class="w-full p-2 rounded bg-input border border-themed h-24">${isNew ? '' : task.content}</textarea></div>
                        <div class="flex gap-4"><div class="flex-1"><label for="cal-task-date" class="block text-sm font-medium text-text-light mb-1">Fecha:</label><input type="date" id="cal-task-date" value="${isNew ? preselectedDate || '' : taskDayKey}" class="w-full p-2 rounded bg-input border border-themed"></div><div class="flex-1"><label for="cal-task-time" class="block text-sm font-medium text-text-light mb-1">Hora:</label><input type="time" id="cal-task-time" value="${isNew ? preselectedTime || '' : task.time || ''}" class="w-full p-2 rounded bg-input border border-themed"></div></div>
                        ${isNew ? `<div><label class="flex items-center cursor-pointer"><input type="checkbox" id="create-project-checkbox" class="rounded bg-input border-themed"><span class="ml-2 text-sm text-text-light">Crear un nuevo tablero de proyecto con esta tarea</span></label></div>` : ''}
                    </div>`,
                    confirmText: 'Guardar'
                });

                if (result.confirmed) {
                    const newContent = result.data['cal-task-content-edit'];
                    const newDate = result.data['cal-task-date'];

                    if (newContent.trim() && newDate) {
                        if(isNew && result.data['create-project-checkbox']) {
                             const tempModalBody = document.createElement('div');
                             tempModalBody.innerHTML = dom.genericModal.querySelector('#modal-body').innerHTML;
                             tempModalBody.querySelector('#cal-task-content-edit').value = newContent;
                             tempModalBody.querySelector('#cal-task-date').value = newDate;
                             tempModalBody.querySelector('#cal-task-time').value = result.data['cal-task-time'];
                             await createProjectFromTask(tempModalBody);
                             return;
                        }

                        const updatedTaskData = {
                            content: newContent.trim(),
                            time: result.data['cal-task-time'] || null,
                            date: newDate
                        };
                        
                        if (isNew) {
                            const newId = `cal-${crypto.randomUUID()}`;
                            const newTask = { id: newId, completed: false, ...updatedTaskData };
                            if (!state.calendar[newDate]) state.calendar[newDate] = [];
                            state.calendar[newDate].push(newTask);
                        } else {
                            updateTaskStatus(taskId, updatedTaskData);
                        }
                        saveState();
                        renderCalendarView();
                    }
                }
            }

            function moveTask(chatId, taskId, targetColumnId) {
                const found = findTask(taskId);
                if (!found || found.type !== 'project' || found.column.id === targetColumnId) return;

                const [taskToMove] = found.column.tasks.splice(found.taskIndex, 1);
                taskToMove.completed = targetColumnId === 'done';

                const targetColumn = state.chats[chatId].projectData.columns.find(c => c.id === targetColumnId);
                if (targetColumn) {
                    if (!targetColumn.tasks) targetColumn.tasks = [];
                    targetColumn.tasks.push(taskToMove);
                }
                
                saveState();
                renderProjectBoard(chatId);
            }

            function getLabelColor(label) {
                if (label === 'Personal') return 'var(--primary)';
                if (label === 'default') return 'var(--text-medium)';
                let hash = 0;
                for (let i = 0; i < label.length; i++) {
                    hash = label.charCodeAt(i) + ((hash << 5) - hash);
                }
                let color = '#';
                for (let i = 0; i < 3; i++) {
                    let value = (hash >> (i * 8)) & 0xCF; 
                    color += ('00' + value.toString(16)).substr(-2);
                }
                return color;
            }

            function renderTagFilter(chatId) {
                const { projectData } = state.chats[chatId];
                const allTasks = projectData.columns.flatMap(c => c.tasks || []);
                const allTags = [...new Set(allTasks.flatMap(t => t.labels || []))];
                
                dom.tagFilterDropdown.innerHTML = '';
                const allBtn = document.createElement('button');
                allBtn.className = 'block w-full text-left p-2 hover:bg-medium rounded-md text-sm';
                allBtn.textContent = 'Todas las Etiquetas';
                allBtn.onclick = () => {
                    activeTagFilter = null;
                    dom.tagFilterBtn.innerHTML = '<i class="fas fa-tag mr-1"></i> Filtrar';
                    dom.tagFilterDropdown.classList.add('hidden');
                    renderProjectBoard(chatId);
                };
                dom.tagFilterDropdown.appendChild(allBtn);
                allTags.forEach(tag => {
                    const btn = document.createElement('button');
                    btn.className = 'block w-full text-left p-2 hover:bg-medium rounded-md text-sm';
                    btn.innerHTML = `<span class="task-label inline-block mr-2" style="background-color: ${getLabelColor(tag)}; color: white;">${tag}</span>`;
                     btn.onclick = () => {
                        activeTagFilter = tag;
                        dom.tagFilterBtn.innerHTML = `<span class="task-label inline-block mr-2" style="background-color: ${getLabelColor(tag)}; color: white;">${tag}</span>`;
                        dom.tagFilterDropdown.classList.add('hidden');
                         renderProjectBoard(chatId);
                    };
                    dom.tagFilterDropdown.appendChild(btn);
                });
                dom.tagFilterBtn.onclick = () => {
                    dom.tagFilterDropdown.classList.toggle('hidden');
                };
            }

            function renderFinancialAssistant(chatId) {
                const chat = state.chats[chatId];
                if (!chat) return;
                if (!chat.financialData) {
                    chat.financialData = {
                        incomeCategories: [], 
                        expenseCategories: []
                    };
                }

                dom.financialAssistantView.innerHTML = `
                     <div id="financial-tools-container">
                         <div class="finance-summary">
                            <div>
                                <h4>Ingresos Totales</h4>
                                <p id="total-income" class="text-green-400">$0.00</p>
                            </div>
                            <div>
                                <h4>Gastos Totales</h4>
                                <p id="total-expenses" class="text-red-400">$0.00</p>
                            </div>
                            <div>
                                <h4>Balance Neto</h4>
                                <p id="net-balance">$0.00</p>
                            </div>
                        </div>

                        <div id="finance-unified-view" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="finance-section">
                                <div class="finance-section-header">
                                    <h3 class="text-green-400">Ingresos</h3>
                                    <button id="add-income-category-btn" class="text-sm btn-primary p-1 px-2"><i class="fas fa-folder-plus mr-1"></i> Nueva Carpeta</button>
                                    <button id="share-income-data-btn" title="Compartir Datos de Ingresos" class="p-1 rounded-md bg-gray-600 text-white text-xs ml-2"><i class="fas fa-share-alt"></i></button>
                                </div>
                                <div id="income-categories-list" class="space-y-3"></div>
                            </div>
                            <div class="finance-section">
                                <div class="finance-section-header">
                                    <h3 class="text-red-400">Gastos</h3>
                                    <button id="add-expense-category-btn" class="text-sm btn-primary p-1 px-2"><i class="fas fa-folder-plus mr-1"></i> Nueva Carpeta</button>
                                    <button id="share-expense-data-btn" title="Compartir Datos de Gastos" class="p-1 rounded-md bg-gray-600 text-white text-xs ml-2"><i class="fas fa-share-alt"></i></button>
                                </div>
                                <div id="expense-categories-list" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                    <div id="financial-chat-container">
                        <div id="financial-chat-header" class="flex justify-between items-center cursor-pointer p-2 border-t md:border-t-0 md:border-b border-themed">
                            <h3 class="text-lg font-semibold text-primary">Asistente Financiero</h3>
                            <button id="financial-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-up"></i></button>
                        </div>
                        <div class="financial-chat-body">
                            <div id="financial-chat-messages" class="chat-bubble-bot"></div>
                            <div id="financial-input-area" class="mt-auto pt-2 p-2">
                                <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                                     <div class="flex items-center space-x-2">
                                        <label for="financial-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1">Modelo:</label>
                                        <div class="model-selector-wrapper">
                                            <select id="financial-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                                 <option value="gpt-3.5-turbo-1106">GOAT X</option> <option value="sonar">Bsqueda Web</option>
                                                 <option value="gpt-4o" class="goat-x-pro-model">GOAT X PRO</option>
                                             </select>
                                              <i class="fas fa-chevron-down text-xs"></i>
                                        </div>
                                     </div>
                                </div>
                                <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                    <textarea id="financial-msg" placeholder="Pregntale a la IA sobre tus finanzas..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm"></textarea>
                                    <button id="financial-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                renderFinancialData(chatId);
                attachFinancialListeners(chatId);
                if (window.innerWidth < 768) {
                    document.getElementById('financial-chat-container').classList.add('collapsed');
                }
                
                const financialModelSelector = document.getElementById('financial-model-selector');
                if (financialModelSelector) {
                    const goatXProOption = financialModelSelector.querySelector('.goat-x-pro-model');
                    if (goatXProOption) goatXProOption.disabled = !currentUser;
                }

            }

            function renderFinancialData(chatId) {
                const chat = state.chats[chatId];
                const { incomeCategories = [], expenseCategories = [] } = chat.financialData;

                const incomeList = dom.financialAssistantView.querySelector('#income-categories-list');
                const expenseList = dom.financialAssistantView.querySelector('#expense-categories-list');
                if(!incomeList || !expenseList) return;

                const renderCategory = (category, type) => {
                    const categoryEl = document.createElement('div');
                    categoryEl.className = 'finance-category';
                    categoryEl.dataset.categoryId = category.id;
                    categoryEl.dataset.type = type;

                    let itemsHTML = (category.items || []).map(item => `
                        <div class="finance-item-row" data-item-id="${item.id}">
                            <input type="text" class="finance-item-input" data-field="description" value="${item.description}" placeholder="Descripcin...">
                            <input type="number" class="finance-item-input text-right" data-field="amount" value="${item.amount}" placeholder="0.00">
                            <button class="delete-finance-item-btn text-red-500 p-1"><i class="fas fa-times"></i></button>
                        </div>
                    `).join('');

                    categoryEl.innerHTML = `
                        <div class="finance-category-header">
                            <input type="text" class="finance-category-name-input" value="${category.name}">
                            <div>
                                <button class="add-finance-item-btn text-primary p-1 mr-2"><i class="fas fa-plus-circle"></i></button>
                                <button class="delete-finance-category-btn text-red-500 p-1"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <div class="finance-category-content">
                            ${itemsHTML}
                        </div>`;
                    return categoryEl;
                };

                incomeList.innerHTML = '';
                incomeCategories.forEach(cat => incomeList.appendChild(renderCategory(cat, 'income')));
                if(incomeList.innerHTML === '') incomeList.innerHTML = '<p class="text-xs text-text-medium italic p-2" data-translate-key="income_categories_empty">Crea carpetas para organizar tus ingresos.</p>';

                expenseList.innerHTML = '';
                expenseCategories.forEach(cat => expenseList.appendChild(renderCategory(cat, 'expense')));
                if(expenseList.innerHTML === '') expenseList.innerHTML = '<p class="text-xs text-text-medium italic p-2" data-translate-key="expense_categories_empty">Crea carpetas para organizar tus gastos.</p>';

                recalculateFinances(chatId);
            }
            function attachFinancialListeners(chatId) {
                const view = dom.financialAssistantView;
                if (!view) return;

                const chat = state.chats[chatId];
                
                view.addEventListener('input', (e) => {
                    if (e.target.classList.contains('finance-category-name-input')) {
                        const catEl = e.target.closest('.finance-category');
                        const catId = catEl.dataset.categoryId;
                        const type = catEl.dataset.type;
                        const category = chat.financialData[`${type}Categories`].find(c => c.id === catId);
                        if (category) {
                            category.name = e.target.value;
                            saveState();
                        }
                    } else if (e.target.classList.contains('finance-item-input')) {
                        const itemRow = e.target.closest('.finance-item-row');
                        const catEl = e.target.closest('.finance-category');
                        const catId = catEl.dataset.categoryId;
                        const itemId = itemRow.dataset.itemId;
                        const type = catEl.dataset.type;
                        const category = chat.financialData[`${type}Categories`].find(c => c.id === catId);
                        const item = category?.items.find(i => i.id === itemId);
                        if (item) {
                           item[e.target.dataset.field] = e.target.type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value;
                           recalculateFinances(chatId);
                           saveState();
                        }
                    }
                });

                view.addEventListener('click', async (e) => {
                    const chat = state.chats[chatId];
                    if (!chat || !chat.financialData) return;

                    const addItemBtn = e.target.closest('.add-finance-item-btn');
                    if(addItemBtn) {
                        const catEl = addItemBtn.closest('.finance-category');
                        const catId = catEl.dataset.categoryId;
                        const type = catEl.dataset.type;
                        const category = chat.financialData[`${type}Categories`].find(c => c.id === catId);
                        if (category) {
                            if (!category.items) category.items = [];
                            category.items.push({ id: `fin-${crypto.randomUUID()}`, description: '', amount: 0 });
                            renderFinancialData(chatId);
                            attachFinancialListeners(chatId);
                            saveState();
                        }
                        return;
                    }

                    const deleteItemBtn = e.target.closest('.delete-finance-item-btn');
                    if (deleteItemBtn) {
                        const itemRow = deleteItemBtn.closest('.finance-item-row');
                        const catEl = deleteItemBtn.closest('.finance-category');
                        const catId = catEl.dataset.categoryId;
                        const itemId = itemRow.dataset.itemId;
                        const type = catEl.dataset.type;
                        const category = chat.financialData[`${type}Categories`].find(c => c.id === catId);
                        if (category) {
                            category.items = (category.items || []).filter(i => i.id !== itemId);
                            renderFinancialData(chatId);
                            attachFinancialListeners(chatId);
                            saveState();
                        }
                        return;
                    }

                    const deleteCategoryBtn = e.target.closest('.delete-finance-category-btn');
                    if (deleteCategoryBtn) {
                        const catEl = deleteCategoryBtn.closest('.finance-category');
                        const catId = catEl.dataset.categoryId;
                        const type = catEl.dataset.type;
                        chat.financialData[`${type}Categories`] = chat.financialData[`${type}Categories`].filter(c => c.id !== catId);
                        renderFinancialData(chatId);
                        attachFinancialListeners(chatId);
                        saveState();
                        return;
                    }

                    const shareIncomeBtn = e.target.closest('#share-income-data-btn');
                    if (shareIncomeBtn) {
                        const lang = localStorage.getItem('goatify-lang') || 'es';
                        const result = await showModal({
                            title: translations[lang].share_financial_data,
                            body: `<p>${translations[lang].share_financial_data_desc}</p>
                                   <input type="email" id="share-email-input" class="w-full p-2 rounded bg-input border border-themed mt-2" placeholder="${translations[lang].share_note_email_placeholder}">
                                   <p class="text-xs text-text-medium mt-2">${translations[lang].share_financial_data_info}</p>`,
                            confirmText: translations[lang].share_note_button
                        });
                        if (result.confirmed && result.data['share-email-input']) {
                            console.log(`(DEMO) Sharing income data for chat ${chatId} with ${result.data['share-email-input']}. Backend needed.`);
                            showInAppNotification("Funcin en Desarrollo", `Datos de ingresos sern compartidos con ${result.data['share-email-input']}.`, 500); // Shorter duration
                        }
                        return;
                    }
                    
                    const shareExpenseBtn = e.target.closest('#share-expense-data-btn');
                    if (shareExpenseBtn) {
                        const lang = localStorage.getItem('goatify-lang') || 'es';
                        const result = await showModal({
                            title: translations[lang].share_financial_data,
                            body: `<p>${translations[lang].share_financial_data_desc}</p>
                                   <input type="email" id="share-email-input" class="w-full p-2 rounded bg-input border border-themed mt-2" placeholder="${translations[lang].share_note_email_placeholder}">
                                   <p class="text-xs text-text-medium mt-2">${translations[lang].share_financial_data_info}</p>`,
                            confirmText: translations[lang].share_note_button
                        });
                        if (result.confirmed && result.data['share-email-input']) {
                            console.log(`(DEMO) Sharing expense data for chat ${chatId} with ${result.data['share-email-input']}. Backend needed.`);
                            showInAppNotification("Funcin en Desarrollo", `Datos de gastos sern compartidos con ${result.data['share-email-input']}.`, 500); // Shorter duration
                        }
                        return;
                    }
                });

                view.querySelector('#add-income-category-btn')?.addEventListener('click', () => {
                    const newCategory = { id: `fin-cat-${crypto.randomUUID()}`, name: 'Nueva Carpeta de Ingresos', items: [] };
                    if (!chat.financialData.incomeCategories) chat.financialData.incomeCategories = [];
                    chat.financialData.incomeCategories.push(newCategory);
                    renderFinancialData(chatId);
                    attachFinancialListeners(chatId);
                    saveState();
                });

                view.querySelector('#add-expense-category-btn')?.addEventListener('click', () => {
                    const newCategory = { id: `fin-cat-${crypto.randomUUID()}`, name: 'Nueva Carpeta de Gastos', items: [] };
                    if (!chat.financialData.expenseCategories) chat.financialData.expenseCategories = [];
                    chat.financialData.expenseCategories.push(newCategory);
                    renderFinancialData(chatId);
                    attachFinancialListeners(chatId);
                    saveState();
                });

                const chatMessagesContainer = view.querySelector('#financial-chat-messages');
                if (chatMessagesContainer) {
                    chatMessagesContainer.innerHTML = '';
                    chat.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, msg.image, index, chatMessagesContainer));
                }
            }

            function recalculateFinances(chatId) {
                const view = dom.financialAssistantView;
                const chat = state.chats[chatId];
                if (!chat || !chat.financialData || !view.querySelector('#total-income')) return;

                const sumItems = (categories) => (categories || [])
                    .flatMap(cat => cat.items || [])
                    .reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

                let totalIncome = sumItems(chat.financialData.incomeCategories);
                let totalExpenses = sumItems(chat.financialData.expenseCategories);

                const netBalance = totalIncome - totalExpenses;
                
                view.querySelector('#total-income').textContent = `$${totalIncome.toFixed(2)}`;
                view.querySelector('#total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
                const netBalanceEl = view.querySelector('#net-balance');
                netBalanceEl.textContent = `$${netBalance.toFixed(2)}`;
                netBalanceEl.style.color = netBalance >= 0 ? '#22c55e' : '#ef4444';
            }

            function checkWeekOrganized() {
                const startOfWeek = dayjs().startOf('isoWeek');
                for (let i = 0; i < 7; i++) {
                    const dayKey = startOfWeek.add(i, 'day').format('YYYY-MM-DD');
                    if (getTasksForDay(dayKey).length === 0) return false;
                }
                return true;
            }
            function checkProjectCreated(chatId, taskCount) {
                const chat = state.chats[chatId];
                if (!chat || !chat.projectData) return false;
                const totalTasks = chat.projectData.columns.reduce((sum, col) => sum + (col.tasks?.length || 0), 0);
                return totalTasks >= taskCount;
            }

            function getDefaultGamificationState() {
                return {
                    xp: 0,
                     credits: 0,
                    level: 1,
                    dailyStreak: 0,
                    lastLogin: null,
                    completedMissions: [],
                     unlockedAchievements: []
                };
            }

            function loadGamificationState() {
                if(!currentUser) {
                    gamificationState = getDefaultGamificationState();
                    return;
                }
                const key = `gamificationState_${currentUser.id}`;
                const savedState = localStorage.getItem(key);
                gamificationState = savedState ? JSON.parse(savedState) : getDefaultGamificationState();
                checkDailyStreak();
            }

            function saveGamificationState() {
                if(!currentUser) return;
                const key = `gamificationState_${currentUser.id}`;
                localStorage.setItem(key, JSON.stringify(gamificationState));
                renderGamificationModal();
                updateCreditCounter();
            }

            function addXp(amount) {
                if(!currentUser) return;
                gamificationState.xp += amount;
                const currentLevel = gamificationState.level;
                if (currentLevel >= LEVEL_NAMES.length) return; 

                const nextLevelXp = XP_FOR_LEVEL[currentLevel];
                if (gamificationState.xp >= nextLevelXp) {
                    gamificationState.level++;
                    const newLevelName = LEVEL_NAMES[gamificationState.level - 1];
                    showModal({
                        title: `<i class="fas fa-sparkles fa-lg text-gold animate-pulse mr-2"></i> Nivel Subido! <i class="fas fa-sparkles fa-lg text-gold animate-pulse ml-2"></i>`,
                        body: `<div class="text-center">
                                <p class="text-lg">Felicidades! Has ascendido al</p>
                                <p class="text-3xl font-bold text-primary my-2">Nivel ${gamificationState.level}</p>
                                <p class="text-2xl font-semibold">${newLevelName}</p>
                                <p class="mt-4 text-text-medium">Sigue as en tu camino para ser un G.O.A.T.!</p>
                               </div>`,
                        confirmText: 'Genial!',
                        showCancel: false
                    });
                }
                saveGamificationState();
            }

            function addCredits(amount) {
                if(!currentUser) return;
                gamificationState.credits += amount;
                saveGamificationState();
            }

            function checkDailyStreak() {
                if(!currentUser) return;
                const today = dayjs().format('YYYY-MM-DD');
                const lastLogin = gamificationState.lastLogin;

                if (lastLogin === today) return;
                
                const yesterday = dayjs().subtract(1, 'day').format('YYYY-MM-DD');
                if (lastLogin === yesterday) {
                    gamificationState.dailyStreak++;
                } else {
                    gamificationState.dailyStreak = 1;
                }
                
                gamificationState.lastLogin = today;
                const streak = gamificationState.dailyStreak;
                let xpReward = 10, creditReward = 5;
                if (streak > 3 && streak <=6) { xpReward = 20; creditReward = 10; }
                
                if (streak === 7) {
                    addXp(100);
                    openGoatChest();
                    gamificationState.dailyStreak = 0; 
                } else {
                    addXp(xpReward);
                    addCredits(creditReward);
                }
                
                if (gamificationState.dailyStreak >= 30) {
                    unlockAchievement('streak-30');
                }

                saveGamificationState();
            }
            
            function openGoatChest() {
                const rand = Math.random();
                let rewardTitle, rewardBody;

                if (rand < 0.01) { 
                    rewardTitle = ' recompensa LEGENDARIA!';
                    rewardBody = 'Increble! Has ganado una <strong>Asesora Estratgica de 30 minutos GRATIS</strong> con un experto de Goatify. Nos pondremos en contacto contigo!';
                } else if (rand < 0.1) { 
                    rewardTitle = ' recompensa PICA!';
                    rewardBody = 'Genial! Has ganado un <strong>cupn del 25% de descuento</strong> en cualquiera de nuestros servicios.';
                } else if (rand < 0.4) { 
                    addCredits(150);
                    rewardTitle = ' recompensa RARA!';
                    rewardBody = `Has ganado <strong>150 Crditos de Recompensa</strong> extra. Sigue as!`;
                } else { 
                    addCredits(50);
                    rewardTitle = ' recompensa COMN!';
                    rewardBody = `Has ganado <strong>50 Crditos de Recompensa</strong>. Buen trabajo!`;
                }

                showModal({
                    title: `<i class="fas fa-gift text-gold mr-2"></i>Cofre GOAT Abierto!`,
                    body: `<p class="text-lg text-center">Completaste la racha de 7 das y obtuviste una${rewardTitle}</p><p class="mt-4 text-center">${rewardBody}</p>`,
                    confirmText: 'Fantstico!',
                     showCancel: false
                });
            }

            function completeMission(missionId, contextId = null) {
                if (!currentUser || gamificationState.completedMissions.includes(missionId)) return;
                const mission = MISSIONS[missionId];
                if (!mission) return;

                let isCompleted = false;
                if (mission.condition) {
                    isCompleted = mission.condition(contextId);
                } else {
                    const chat = state.chats[contextId];
                    if (chat && chat.messages.length > 1) { 
                        isCompleted = true;
                    }
                }
                
                if (isCompleted) {
                    gamificationState.completedMissions.push(missionId);
                    addXp(mission.xp);
                    addCredits(mission.credits);
                    showModal({
                        title: `<i class="fas fa-check-circle text-green-400 mr-2"></i> Misin Completada`,
                        body: `<p class="text-lg text-center">Completaste "${mission.text}"!</p><p class="text-center font-bold mt-2">+${mission.xp} XP | +${mission.credits} Crditos de Recompensa</p>`,
                        confirmText: 'Vamos!',
                         showCancel: false
                    });
                    saveGamificationState();
                }
            }
            
            function unlockAchievement(achievementId) {
                if (!currentUser || gamificationState.unlockedAchievements.includes(achievementId)) return;
                const achievement = ACHIEVEMENTS[achievementId];
                if (!achievement) return;

                gamificationState.unlockedAchievements.push(achievementId);
                addXp(achievement.xp);
                if (achievement.credits) addCredits(achievement.credits);
                showModal({
                    title: `<i class="fas fa-medal text-gold mr-2"></i> Logro Desbloqueado!`,
                    body: `<p class="text-xl text-center font-bold">${achievement.title}</p><p class="text-center mt-2">${achievement.description}</p><p class="text-center font-bold mt-4">+${achievement.xp} XP ${achievement.reward ? `| ${achievement.reward}` : ''}</p>`,
                    confirmText: 'Impresionante!',
                     showCancel: false
                });
                saveGamificationState();
            }

            function renderGamificationModal() {
                if(!currentUser) return;
                const level = gamificationState.level;
                const currentXp = gamificationState.xp;
                const xpForCurrentLevel = XP_FOR_LEVEL[level - 1];
                const xpForNextLevel = XP_FOR_LEVEL[level];
                dom.gamificationLevelName.textContent = `Nivel ${level}: ${LEVEL_NAMES[level - 1]}`;
                // Sum all credits for total display in gamification modal
                const totalCredits = getCreditCount().remaining + gamificationState.credits; 
                dom.gamificationCredits.innerHTML = `<i class="fas fa-coins mr-1"></i>${totalCredits} Crditos (Plan + Recompensa)`; // Display combined credits
                if (level < LEVEL_NAMES.length) {
                    const progress = ((currentXp - xpForCurrentLevel) / (xpForNextLevel - xpForCurrentLevel)) * 100;
                    dom.gamificationXp.textContent = `${currentXp} / ${xpForNextLevel} XP`;
                    dom.gamificationXpBar.style.width = `${Math.min(100, progress)}%`;
                } else {
                    dom.gamificationXp.textContent = `Nivel Mximo!`;
                    dom.gamificationXpBar.style.width = `100%`;
                }

                dom.dailyStreakContainer.innerHTML = '';
                for (let i = 1; i <= 7; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'streak-day p-4 rounded-lg flex flex-col items-center justify-center';
                    const isCompleted = i <= gamificationState.dailyStreak;
                    const isActive = i === gamificationState.dailyStreak + 1 && dayjs().format('YYYY-MM-DD') !== gamificationState.lastLogin;
                    
                    if (isCompleted) dayEl.classList.add('completed');
                    if (isActive) dayEl.classList.add('active');

                    let rewardText;
                    if (i <= 3) rewardText = '+10 XP';
                    else if (i <= 6) rewardText = '+20 XP';
                    else rewardText = '<i class="fas fa-gift fa-2x"></i>';

                    dayEl.innerHTML = `
                        <p class="font-bold text-lg">${i === 7 ? '' : `Da ${i}`}</p>
                        <div class="text-2xl my-2">${rewardText}</div>
                        <p class="text-xs">${i <= 3 ? '+5 Crditos' : (i <= 6 ? '+10 Crditos' : 'Cofre GOAT')}</p>
                    `;
                    dom.dailyStreakContainer.appendChild(dayEl);
                }

                dom.missionsContainer.innerHTML = '';
                Object.values(MISSIONS).forEach(mission => {
                    const isCompleted = gamificationState.completedMissions.includes(mission.id);
                    const missionEl = document.createElement('div');
                    missionEl.className = `mission-item p-4 rounded-lg flex items-center justify-between bg-input ${isCompleted ? 'completed' : ''}`;
                     missionEl.innerHTML = `
                        <div>
                            <p class="font-semibold">${mission.text}</p>
                            <p class="text-sm text-text-medium">+${mission.xp} XP | +${mission.credits} Crditos</p>
                         </div>
                        <button class="btn-primary px-4 py-2 rounded-lg text-sm font-bold" data-mission-id="${mission.id}" ${isCompleted ? 'disabled' : ''}>
                            ${isCompleted ? 'Hecho' : 'Empezar'}
                         </button>
                    `;
                    dom.missionsContainer.appendChild(missionEl);
                });

                dom.achievementsContainer.innerHTML = '';
                Object.values(ACHIEVEMENTS).forEach(ach => {
                    const isUnlocked = gamificationState.unlockedAchievements.includes(ach.id);
                    const achEl = document.createElement('div');
                    achEl.className = `achievement-badge p-4 rounded-lg text-center flex flex-col items-center justify-center ${isUnlocked ? 'unlocked' : ''}`;
                     achEl.innerHTML = `
                        <i class="fas ${ach.icon} fa-3x mb-2"></i>
                        <p class="font-bold">${ach.title}</p>
                        <p class="text-xs text-text-medium mt-1">${ach.description}</p>
                     `;
                    dom.achievementsContainer.appendChild(achEl);
                });
            }

            let initFired = false;
            const finishInitialization = (user) => {
                if (initFired) return;
                initFired = true;
                currentUser = user;
                
                try {
                    updateUserUI();
                    loadStateForUser();
                    populateVoiceList();
                    setupEventListeners();
                    setupNotifications();
                    updateContextualFooter(null);
                    setupMotivationInterval();

                    dom.appContainer.classList.remove('opacity-0');
                    dom.loadingOverlay.style.display = 'none';

                    if (currentChatId && (state.chats[currentChatId] || state.notes.find(n => n.id === currentChatId))) {
                        selectChat(currentChatId);
                    } else {
                        resetChatView();
                    }
                    updateNotificationBadge();
                    if (currentUser && !localStorage.getItem('goatify-gamification-rules-seen')) {
                        setTimeout(() => {
                            dom.gamificationRulesModal.classList.remove('hidden');
                            dom.gamificationRulesModal.classList.add('flex');
                            localStorage.setItem('goatify-gamification-rules-seen', 'true');
                        }, 2000);
                    }
                } catch (e) {
                    console.error("Error during finishInitialization:", e);
                    dom.loadingOverlay.innerHTML = `<div class="text-red-500 text-center">Error al cargar la aplicacin.<br>Por favor, recarga la pgina.<br><small>${e.message}</small></div>`;
                }
            };

            const savedLang = localStorage.getItem('goatify-lang') || 'es';
            setLanguage(savedLang);
            setTheme(localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches));

            // Set initial font size from local storage or default
            const savedFontSize = localStorage.getItem('goatify-font-size');
            if (savedFontSize) {
                document.documentElement.style.setProperty('--base-font-size', `${savedFontSize}px`);
            }


            const unlockAudio = () => {
                const silence = new SpeechSynthesisUtterance('');
                silence.volume = 0;
                window.speechSynthesis.speak(silence);
                document.body.removeEventListener('touchstart', unlockAudio);
                document.body.removeEventListener('click', unlockAudio);
            };
            document.body.addEventListener('touchstart', unlockAudio, { once: true });
            document.body.addEventListener('click', unlockAudio, { once: true });
            
            if (window.netlifyIdentity) {
                netlifyIdentity.on('init', (user) => finishInitialization(user));
                netlifyIdentity.on('login', (user) => {
                    netlifyIdentity.close(); 
                    currentUser = user;
                    updateUserUI(); 
                    loadStateForUser();
                });
                netlifyIdentity.on('logout', () => {
                    currentUser = null;
                    updateUserUI(); 
                    loadStateForUser(); 
                    resetChatView();
                });
                netlifyIdentity.on('error', (err) => {
                    console.error("Netlify Identity Error:", err);
                    if (!initFired) finishInitialization(null); 
                });
            } else {
                 console.warn("Netlify Identity widget not found. Proceeding as guest.");
                 finishInitialization(null);
            }

            setTimeout(() => {
                if (!initFired) {
                    console.warn("Netlify Identity 'init' event did not fire within timeout. Forcing app initialization.");
                    finishInitialization(window.netlifyIdentity ? netlifyIdentity.currentUser() : null);
                 }
            }, 3000);
        });
        //<-- END OF SCRIPT -->
    </script>
</body>
</html>
