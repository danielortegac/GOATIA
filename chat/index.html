<!DOCTYPE html><html lang="es"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Goatify AI</title>
    <link rel="icon" type="image/png" href="./Logos HD.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
    </script>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <style>
        :root {
            --bg-dark: #121212;
            --bg-medium: #1e1e1e;
            --bg-light: #2c2c2c;
            --primary: #8a4fff;
            --primary-hover: #7b46e6;
            --text-light: #e0e0e0;
            --text-medium: #b3b3b3;
            --border-color: #3a3a3a;

            --light-bg-dark: #f7f7f8;
            --light-bg-medium: #ffffff;
            --light-bg-light: #f0f0f0;
            --light-primary: #7c40e6;
            --light-primary-hover: #6a37d3;
            --light-text-dark: #1f2937;
            --light-text-medium: #6b7280;
            --light-border-color: #e5e7eb;
            
            --base-font-size: 16px;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            transition: background-color: 0.3s ease, color: 0.3s ease;
            font-size: var(--base-font-size);
        }

        .dark-theme {
            --current-bg-dark: var(--bg-dark);
            --current-bg-medium: var(--bg-medium);
            --current-bg-light: var(--bg-light);
            --current-primary: var(--primary);
            --current-primary-hover: var(--primary-hover);
            --current-text-light: var(--text-light);
            --current-text-medium: var(--text-medium);
            --current-border-color: var(--border-color);
            background-color: var(--current-bg-dark);
            color: var(--text-light);
        }

        .light-theme {
            --current-bg-dark: var(--light-bg-dark);
            --current-bg-medium: var(--light-bg-medium);
            --current-bg-light: var(--light-bg-light);
            --current-primary: var(--light-primary);
            --current-primary-hover: var(--light-primary-hover);
            --current-text-light: var(--light-text-dark);
            --current-text-medium: var(--light-text-medium);
            --current-border-color: var(--light-border-color);
            background-color: var(--light-bg-dark);
            color: var(--light-text-dark);
        }
        
        #sidebar { background-color: var(--current-bg-dark); border-right: 1px solid var(--current-border-color); }
        #main-chat-area, .modal-content { background-color: var(--current-bg-medium); }
        .chat-bubble-bot, .bg-input, #pdf-preview-container, .chat-item, .project-header, #user-menu-popup, #services-menu, .pro-controls-bg { background-color: var(--current-bg-light); }
        .border-themed { border-color: var(--current-border-color); }
        .chat-bubble-user { background-color: var(--current-primary); color: white; }
        .btn-primary { background-color: var(--current-primary); color: white; }
        .btn-primary:hover { background-color: var(--current-primary-hover); }
        .plan-card-highlight { border-color: var(--current-primary); box-shadow: 0 0 15px rgba(138, 79, 255, 0.3); }
        .placeholder-themed::placeholder { color: var(--current-text-medium); }
        .text-primary { color: var(--current-primary); }
        .glowing-mic { animation: pulse 1.5s infinite; color: var(--primary) !important; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(138, 79, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0); }
        }

        .project .project-content { display: none; }
        .project.open .project-content { display: block; }
        .project.open .project-arrow { transform: rotate(90deg); }
        .project-header.drag-over { background-color: var(--current-primary); }
        #sidebar.is-open { transform: translateX(0); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        #app-container { height: 100vh; height: -webkit-fill-available; }
        #pricing-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .chat-item.selected-for-delete { background-color: var(--primary) !important; color: white; }
        #model-selector, #voice-selector { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: none !important; padding-right: 1.75rem; }
        .workflow-content { display: none; }
        .workflow-category.open .workflow-content { display: block; }
        .workflow-category.open .workflow-arrow { transform: rotate(90deg); }
        .plan-card { background-color: var(--current-bg-light); }
        #pdf-preview-container { padding: 0.5rem; }
        
        @keyframes sweep {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(200%) skewX(-15deg); }
        }
        .cool-light-effect { position: relative; overflow: hidden; }
        .cool-light-effect::before {
            content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(138, 79, 255, 0.25) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-150%) skewX(-15deg); transition: transform 0.8s ease; pointer-events: none;
        }
        .cool-light-effect:hover::before { animation: sweep 2s infinite linear; }

        .input-wrapper { border: 2px solid transparent; transition: box-shadow 0.3s ease, border-color 0.3s ease; }
        .input-wrapper:focus-within { box-shadow: 0 0 10px 0px rgba(138, 79, 255, 0.5); border-color: var(--current-primary-hover); }

        #chat-title {
            color: var(--primary);
            font-weight: 700;
            transition: color 0.3s ease;
        }
        #chat-title-wrapper:hover #chat-title {
            color: var(--primary-hover);
        }
        
        #chat-title-wrapper {
            position: relative;
            padding-left: 24px;
        }
        #chat-title-wrapper .edit-icon {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.6; 
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        #chat-title-wrapper:hover .edit-icon {
            opacity: 1;
            transform: translateY(-50%) scale(1.1);
        }

        .model-selector-wrapper { position: relative; display: flex; align-items: center; }
        .model-selector-wrapper i { position: absolute; right: 0.5rem; pointer-events: none; color: var(--current-text-medium); transition: transform 0.2s ease; }
        .model-selector-wrapper:hover i { transform: scale(1.1); }
        
        .btn-disabled { background-color: #3a3a3a !important; color: #888 !important; cursor: not-allowed !important; border-color: #3a3a3a !important;}

        /* IMPROVEMENT: Sidebar chat item text colors */
        .chat-item.selected-chat {
            background-color: var(--current-primary);
            color: white !important; /* Important to override theme color */
        }
        .chat-item.selected-chat .text-sm {
             color: white !important;
        }
        .light-theme .chat-item {
            color: var(--light-text-dark); /* Ensure high contrast in light mode */
        }

        /* IMPROVEMENT: Thinner model bar on mobile */
        @media (max-width: 640px) {
            .pro-controls-bg {
                padding: 0.125rem 0.25rem;
            }
            .pro-controls-bg label,
            .pro-controls-bg select {
                font-size: 0.75rem; /* 12px */
                padding-top: 0.125rem;
                padding-bottom: 0.125rem;
            }
        }
    </style>
</head>
<body class="w-screen overflow-x-hidden dark-theme">

    <div id="loading-overlay" class="fixed inset-0 bg-bg-dark bg-opacity-95 flex flex-col items-center justify-center z-[100] transition-opacity duration-300">
        <img src="./Logos HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mb-6 animate-pulse" onerror="this.onerror=null;this.src='https://placehold.co/96x96/121212/e0e0e0?text=LOGO';">
        <div class="text-text-light text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3 text-lg font-semibold" data-translate-key="initializing">Inicializando...</p>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden opacity-0 pointer-events-none"></div>

    <div id="app-container" class="flex w-full relative opacity-0 transition-opacity duration-300">
        <aside id="sidebar" class="w-72 flex-shrink-0 flex flex-col p-3 transition-transform duration-300 -translate-x-full md:translate-x-0 absolute md:relative z-30 h-full">
            <div id="logo-space" class="w-24 h-24 rounded-lg mx-auto mb-4 flex-shrink-0 flex items-center justify-center overflow-hidden bg-input">
                <img src="./Logos HD.png" alt="Goatify Logo" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
            </div>
            <div class="flex-grow overflow-y-auto min-h-0">
                <div class="flex-shrink-0">
                    <div class="flex flex-col space-y-2 mb-4">
                        <button id="new-chat-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-plus mr-2"></i><span data-translate-key="new_chat">Nuevo Chat</span></button>
                        <button id="new-project-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg bg-input"><i class="fas fa-folder-plus mr-2"></i><span data-translate-key="new_project">Nuevo Proyecto</span></button>
                        <button id="web-launch-offer-btn" class="w-full text-left font-semibold text-sm p-3 rounded-lg btn-primary transition-colors animate-pulse" data-translate-key="web_offer">
                            🚀 ¡Lanza tu Negocio, te regalamos una pg web Gratis con tu suscripcion!
                        </button>
                        <div id="upgrade-plan-container" class="hidden text-center p-2 bg-yellow-400 rounded-lg">
                            <button id="upgrade-plan-btn" class="text-xs font-semibold text-black hover:text-gray-800">
                                <i class="fas fa-rocket mr-1"></i>
                                <span data-translate-key="upgrade_plan">Mejorar Plan</span>
                            </button>
                        </div>
                        <div class="text-center p-2 bg-input rounded-lg">
                            <a href="#" id="free-guides-link" class="text-xs font-semibold text-primary hover:underline">
                                <i class="fas fa-book-open mr-1"></i>
                                <span data-translate-key="free_guides">Guías de IA Gratis</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="flex-grow">
                    <div class="border-t border-b border-themed my-3 py-3">
                        <h3 class="text-xs font-semibold uppercase text-text-medium mb-2 px-2" data-translate-key="workflows">Workflows</h3>
                        <div id="workflows-container" class="space-y-1">
                             <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                    <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-share-alt w-6 mr-2 text-pink-400"></i>
                                    <span class="text-sm font-bold" data-translate-key="wf_social">Potenciador de Redes Sociales</span>
                                </div>
                                <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="create-full-post" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_1">Crear un Post Completo</button>
                                    <button data-workflow="persuasive-copy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_2">Redacción de Copys</button>
                                    <button data-workflow="post-ideas" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_3">Lluvia de Ideas para Posts</button>
                                    <button data-workflow="brand-strategy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_4">Definir Estrategia de Marca</button>
                                </div>
                            </div>
                            <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                    <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-chart-pie w-6 mr-2 text-blue-400"></i>
                                    <span class="text-sm font-bold" data-translate-key="wf_business">Análisis de Negocio</span>
                                </div>
                                <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="competitor-analysis" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_1">Análisis de tu Competencia</button>
                                    <button data-workflow="buyer-persona" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_2">Definir mi Cliente Ideal</button>
                                    <button data-workflow="brand-names" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_3">Lluvia de Nombres para Marca</button>
                                </div>
                            </div>
                            <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                    <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-headset w-6 mr-2 text-green-400"></i>
                                    <span class="text-sm font-bold" data-translate-key="wf_sales">Comunicación y Ventas</span>
                                </div>
                                <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="sales-assistant" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_1">Asistente de Ventas 24/7</button>
                                    <button data-workflow="email-writing" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_2">Redacción de Email</button>
                                    <button data-workflow="design-web" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_3">Diseño Web</button>
                                </div>
                            </div>
                            <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                    <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-language w-6 mr-2 text-red-400"></i>
                                    <span class="text-sm font-bold">English Teacher</span>
                                </div>
                                <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="english-teacher-translate" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_1">Traducir/Corregir Texto</button>
                                    <button data-workflow="english-teacher-vocabulary" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_2">Aprender Vocabulario Nuevo</button>
                                    <button data-workflow="english-teacher-practice" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_3">Practicar Conversación</button>
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-themed pt-2 mt-2">
                            <button id="select-chats-btn" class="w-full text-sm p-2 rounded hover:bg-light flex items-center justify-center">
                                <i class="fas fa-tasks mr-2"></i><span data-translate-key="select_chats">Seleccionar Múltiples Chats</span>
                            </button>
                        </div>
                    </div>
                    <div id="delete-mode-controls" class="hidden flex space-x-2 mb-2 px-2">
                        <button id="delete-selected-btn" class="flex-1 flex items-center justify-center font-semibold p-2 rounded-lg bg-red-600 text-white disabled:opacity-50" disabled><i class="fas fa-trash-alt mr-2"></i><span data-translate-key="delete">Borrar</span></button>
                        <button id="cancel-select-mode-btn" class="p-2 rounded-lg bg-gray-600 text-white"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="sidebar-content" class="pr-1 space-y-1"></div>
                </div>
                <div id="user-section" class="flex-shrink-0 border-t border-themed mt-auto pt-3">
                    <div id="login-view" class="hidden">
                        <button id="login-btn" class="w-full flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-sign-in-alt mr-2"></i><span data-translate-key="login">Iniciar Sesión</span></button>
                    </div>
                    <div id="user-menu-view" class="hidden relative">
                        <button id="user-menu-btn" class="w-full flex items-center text-left p-2 rounded-lg hover:bg-light transition-colors">
                            <span id="user-email" class="flex-grow truncate text-sm font-semibold"></span>
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <div id="user-menu-popup" class="absolute bottom-full left-0 w-full mb-2 rounded-lg p-2 border border-themed shadow-lg hidden">
                            <button id="settings-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-cog w-6 mr-2"></i><span data-translate-key="settings">Configuración</span></button>
                            <button id="logout-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-sign-out-alt w-6 mr-2"></i><span data-translate-key="logout">Cerrar Sesión</span></button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <main id="main-chat-area" class="flex-1 flex flex-col h-full overflow-hidden">
            <header class="flex items-center justify-between p-3 md:p-4 border-b border-themed flex-shrink-0 relative">
                <button id="menu-toggle" class="md:hidden text-xl p-2"><i class="fas fa-bars"></i></button>
                <div id="chat-title-wrapper" class="hidden sm:flex items-center group cursor-pointer mx-2 flex-1 min-w-0" title="Renombrar Chat">
                    <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                    <h1 id="chat-title" class="text-lg truncate">Goatify AI</h1>
                </div>
                <div class="flex items-center space-x-1 sm:space-x-2 flex-shrink-0 ml-auto">
                    <button id="new-chat-icon-btn" title="Nuevo Chat" class="text-xl p-2 hover:opacity-80 transition-opacity"><i class="fas fa-plus-circle text-primary"></i></button>
                    <button id="services-menu-btn" title="Potenciar mi Negocio" class="text-xl p-2 hover:opacity-80 transition-opacity flex items-center gap-2">
                        <i class="fas fa-rocket text-primary"></i>
                        <span class="text-sm font-semibold text-primary" data-translate-key="solutions">Soluciones</span>
                    </button>
                    <a href="https://wa.me/17439106116" target="_blank" title="Hablar con un Estratega" class="text-green-500 hover:text-green-400 p-2 transition-colors"><i class="fab fa-whatsapp text-xl"></i></a>
                    <a href="https://calendly.com/goatify" target="_blank" title="Agendar Sesión Estratégica" class="text-sky-400 hover:text-sky-300 p-2 transition-colors"><i class="fas fa-calendar-days text-xl"></i></a>
                    <div id="message-counter" class="text-xs font-mono whitespace-nowrap"></div>
                    <button id="theme-toggle" title="Cambiar Tema" class="text-xl p-2"><i class="fas fa-moon" id="theme-icon"></i></button>
                </div>
                <div id="services-menu" class="absolute top-full right-4 mt-2 w-80 rounded-xl shadow-lg border border-themed z-30 p-4 transition-all duration-300 ease-in-out opacity-0 scale-95 -translate-y-2 pointer-events-none origin-top-right">
                    <h4 class="font-bold text-lg mb-1 text-text-light" data-translate-key="ally_title">Somos tu Aliado Estratégico</h4>
                    <p class="text-sm text-text-medium mb-4" data-translate-key="ally_desc">Goatify no es solo un chat. Somos una IA personalizada con un equipo de expertos listos para ayudarte a escalar tu negocio.</p>
                </div>
            </header>
            <div class="block sm:hidden text-center py-1.5 border-b border-themed bg-current-bg-dark shadow-sm flex-shrink-0">
                <div id="mobile-chat-title-wrapper" class="flex items-center justify-center group cursor-pointer px-4" title="Renombrar Chat">
                    <i class="fas fa-pencil-alt text-xs mr-2 text-text-medium edit-icon"></i>
                    <h2 id="mobile-chat-title" class="text-sm font-semibold truncate">Goatify AI</h2>
                </div>
            </div>

            <div id="chat-messages" class="flex-1 overflow-y-auto p-3 sm:p-6">
                <div class="flex justify-center items-center h-full" id="initial-message-container">
                    <div id="welcome-message-wrapper" class="text-center text-text-medium">
                        <img src="./Logos HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                        <h2 class="text-3xl font-bold text-text-light">Goatify AI</h2>
                        <div id="personalized-welcome" class="hidden"><p class="text-lg mt-1"><span data-translate-key="welcome_user">¡Hola, </span><span id="user-name"></span><span data-translate-key="welcome_user_2">! Hoy es un gran día para crear algo increíble.</span></p></div>
                        <div id="generic-welcome" class="hidden"><p class="text-xl" data-translate-key="welcome_guest">¿Cómo puedo ayudarte hoy?</p></div>
                    </div>
                </div>
            </div>
            <div id="input-area" class="p-2 sm:p-4 border-t border-themed flex-shrink-0">
                <div id="file-preview-area" class="mb-2 space-y-2 px-1 sm:px-0">
                    <div id="image-preview-container" class="hidden relative w-24 h-24 sm:w-32 sm:h-32 rounded-lg overflow-hidden border border-themed"><img id="image-preview" src="#" alt="Image Preview" class="w-full h-full object-contain"><button id="clear-image-btn" class="absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs z-10"><i class="fas fa-times"></i></button></div>
                    <div id="pdf-preview-container" class="hidden relative rounded-lg border-themed">
                        <div class="flex items-center">
                            <i class="fas fa-file-pdf text-red-500 text-3xl mr-4 flex-shrink-0"></i>
                            <div class="flex-grow min-w-0">
                                <p id="pdf-name" class="text-sm font-medium truncate"></p><p id="pdf-status" class="text-xs font-mono"></p>
                            </div>
                        </div>
                        <button id="clear-pdf-btn" class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs z-10"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="pro-controls-bg rounded-lg p-1 mb-2 cool-light-effect inline-block">
                    <div class="flex items-center space-x-2">
                        <div class="flex items-center space-x-2">
                            <label for="model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1" data-translate-key="model">Modelo:</label>
                            <div class="model-selector-wrapper">
                                <select id="model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light border-none">
                                    <option value="gpt-3.5-turbo-1106" data-translate-key="model_general">Chat General (Turbo)</option>
                                    <option value="sonar" data-translate-key="model_web">Búsqueda Web</option>
                                </select><i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                        <div id="voice-selector-container" class="hidden items-center space-x-2">
                            <label for="voice-selector" class="font-medium text-xs text-text-medium" data-translate-key="voice">Voz:</label>
                             <div class="model-selector-wrapper">
                                <select id="voice-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light border-none w-24"></select>
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                        <div class="flex sm:hidden items-center space-x-1">
                            <button id="image-gen-btn-mobile" title="Crear Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fas fa-paint-brush text-lg"></i></button>
                            <button id="pdf-upload-btn-mobile" title="Subir PDF" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-file-pdf text-lg"></i></button>
                            <button id="image-upload-btn-mobile" title="Subir Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-image text-lg"></i></button>
                        </div>
                    </div>
                </div>
                <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                    <input type="file" id="pdf-upload" accept=".pdf,application/pdf" class="hidden"><input type="file" id="image-upload" accept="image/*" class="hidden">
                    <button id="image-gen-btn" title="Crear Imagen" class="hidden sm:block p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fas fa-paint-brush text-xl"></i></button>
                    <button id="pdf-upload-btn" title="Subir PDF" class="hidden sm:block p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-file-pdf text-xl"></i></button>
                    <button id="image-upload-btn" title="Subir Imagen" class="hidden sm:block p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-image text-xl"></i></button>
                    <button id="mic-btn" title="Activar Micrófono" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-microphone text-xl"></i></button>
                    <button id="tts-toggle" title="Activar/Desactivar Voz" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-volume-mute text-xl"></i></button>
                    <textarea id="msg" placeholder="Escribe tu mensaje..." class="flex-1 bg-transparent p-2 h-12 max-h-32 resize-none outline-none placeholder-themed" rows="1" data-translate-key="placeholder_main"></textarea>
                    <button id="send" title="Enviar" class="p-2 sm:p-4 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i id="send-icon" class="fa fa-paper-plane text-xl"></i></button>
                </div>
                <div id="contextual-footer" class="text-center text-xs text-text-medium mt-2 px-2 h-4"></div>
            </div>
        </main>
    </div>

    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4"><div class="modal-content rounded-lg w-full max-w-md p-6 relative"><h3 id="modal-title" class="text-lg font-bold mb-4"></h3><div id="modal-message" class="mb-4 text-text-medium text-sm"></div><textarea id="modal-textarea" class="w-full p-2 rounded mb-4 hidden bg-input border border-themed h-28" placeholder=""></textarea><input type="text" id="modal-input" class="w-full p-2 rounded mb-4 hidden bg-input border border-themed" placeholder=""><div id="modal-buttons-container" class="flex justify-end space-x-2"><button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded" data-translate-key="cancel">Cancelar</button><button id="modal-confirm" class="px-4 py-2 rounded text-white btn-primary" data-translate-key="confirm">Confirmar</button></div></div></div>
    <div id="pricing-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4"><div class="modal-content rounded-2xl w-full max-w-5xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300"><div class="flex-shrink-0 flex items-center justify-between mb-6"><h2 class="text-3xl md:text-4xl font-extrabold text-center flex-grow" data-translate-key="plans_title">Planes Goatify</h2><button id="close-pricing-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button></div><div class="modal-content-body flex-grow overflow-y-auto px-2"><div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-text-light"><div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col"><h3 class="text-2xl font-bold">Free</h3><p class="text-5xl font-extrabold my-3">$0</p><p class="text-sm text-text-medium mb-4" data-translate-key="plan_free_sub">Para Siempre</p><button id="free-plan-btn" class="w-full p-3 rounded-lg font-semibold border-2 border-primary text-primary hover:bg-primary hover:text-white transition-colors" data-translate-key="plan_free_cta">Empezar Gratis</button><ul class="space-y-3 text-sm flex-grow mt-6 mb-4"><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span data-translate-key="plan_feat_ltd_chat">Acceso limitado al chat</span></li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span data-translate-key="plan_feat_ltd_hist">Historial limitado</span></li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span data-translate-key="plan_feat_ltd_proj">Organización por proyectos (Limitado)</span></li></ul></div><div class="plan-card border-2 rounded-xl p-6 flex flex-col bg-current-bg-dark plan-card-highlight"><h3 class="text-2xl font-bold">GOAT <span class="text-primary">BOOST</span></h3><p class="text-5xl font-extrabold my-3">$7</p><p class="text-sm text-text-medium mb-4">/ mes</p><button data-plan="boost" class="select-plan-btn w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_boost_cta">Obtener Boost</button><ul class="space-y-3 text-sm flex-grow mt-6 mb-4"><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i><span data-translate-key="plan_feat_fast">Respuestas ultrarrápidas ⚡️</span></li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i><span data-translate-key="plan_feat_unl_hist">Historial ilimitado</span></li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i><span data-translate-key="plan_feat_proj">Organización por Proyectos</span></li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>English Teacher</li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i><span data-translate-key="plan_feat_ltd_wf">Workflows Limitados</span></li></ul></div><div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col"><h3 class="text-2xl font-bold">GOAT <span class="text-primary">PRO</span></h3><p class="text-5xl font-extrabold my-3">$17</p><p class="text-sm text-text-medium mb-4">/ mes</p><button data-plan="pro" class="select-plan-btn w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_pro_cta">Quiero mi Plan Pro + Web</button><ul class="space-y-3 text-sm flex-grow mt-6 mb-4"><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span data-translate-key="plan_feat_all_boost">Todo lo de Boost</span> y más</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span data-translate-key="plan_feat_all_models">Acceso a todos los modelos de IA</span></li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span data-translate-key="plan_feat_all_wf">Acceso a todos los Workflows</span></li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span data-translate-key="plan_feat_community">Comunidad privada y webinars</span></li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span data-translate-key="plan_feat_support">Asistencia prioritaria 1-a-1</span></li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span class="font-bold" data-translate-key="plan_feat_free_web">Página Web Gratis</span> para Fundadores</li></ul></div></div></div></div></div>
    <div id="html-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4"><div class="modal-content rounded-2xl w-full h-full max-w-4xl p-2 md:p-4 relative flex flex-col"><div class="flex-shrink-0 flex items-center justify-between mb-2"><h3 class="text-lg font-bold" data-translate-key="preview">Vista Previa</h3><button id="close-html-preview-modal" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button></div><iframe id="html-preview-iframe" class="w-full flex-grow h-full border-2 border-themed rounded-lg bg-white"></iframe></div></div>
    
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative">
            <h3 class="text-lg font-bold mb-4" data-translate-key="settings">Configuración</h3>
            <div class="space-y-4 text-sm">
                <div>
                    <p class="font-semibold" data-translate-key="settings_email">Correo Electrónico:</p>
                    <p id="settings-user-email" class="text-text-medium"></p>
                </div>
                <div>
                    <p class="font-semibold" data-translate-key="settings_plan">Plan de Suscripción:</p>
                    <p id="settings-user-plan" class="text-text-medium"></p>
                    <button id="settings-upgrade-plan-btn" class="text-primary hover:underline mt-1 text-xs" data-translate-key="upgrade_plan">Mejorar Plan</button>
                </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_fontsize">Tamaño de Letra:</p>
                    <input type="range" id="font-size-slider" min="14" max="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg dark:bg-gray-700">
                    <span id="font-size-value" class="text-xs text-text-medium">16px</span>
                </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_theme">Personalización:</p>
                    <button id="settings-theme-toggle" class="flex items-center p-2 rounded hover:bg-medium w-full text-left">
                        <i class="fas fa-moon mr-2" id="settings-theme-icon"></i>
                        <span data-translate-key="settings_dark_mode">Modo Oscuro</span>
                    </button>
                </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_lang">Idioma:</p>
                    <select id="language-selector" class="w-full p-2 rounded bg-input border border-themed">
                        <option value="es">Español</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div>
                    <button id="connect-whatsapp-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                        <i class="fab fa-whatsapp mr-2"></i><span data-translate-key="settings_whatsapp">Conectarse a WhatsApp</span>
                    </button>
                </div>
            </div>
            <button id="close-settings-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        window.addEventListener('DOMContentLoaded', () => {
            const translations = {
                es: {
                    initializing: "Inicializando...", new_chat: "Nuevo Chat", new_project: "Nuevo Proyecto",
                    web_offer: "🚀 ¡Lanza tu Negocio, te regalamos una pg web Gratis con tu suscripcion!",
                    upgrade_plan: "Mejorar Plan", free_guides: "Guías de IA Gratis", workflows: "Workflows",
                    wf_social: "Potenciador de Redes Sociales", wf_social_1: "Crear un Post Completo", wf_social_2: "Redacción de Copys",
                    wf_social_3: "Lluvia de Ideas para Posts", wf_social_4: "Definir Estrategia de Marca",
                    wf_business: "Análisis de Negocio", wf_business_1: "Análisis de tu Competencia", wf_business_2: "Definir mi Cliente Ideal",
                    wf_business_3: "Lluvia de Nombres para Marca", wf_sales: "Comunicación y Ventas", wf_sales_1: "Asistente de Ventas 24/7",
                    wf_sales_2: "Redacción de Email", wf_sales_3: "Diseño Web", wf_eng_1: "Traducir/Corregir Texto",
                    wf_eng_2: "Aprender Vocabulario Nuevo", wf_eng_3: "Practicar Conversación", select_chats: "Seleccionar Múltiples Chats",
                    delete: "Borrar", login: "Iniciar Sesión", settings: "Configuración", logout: "Cerrar Sesión",
                    solutions: "Soluciones", ally_title: "Somos tu Aliado Estratégico",
                    ally_desc: "Goatify no es solo un chat. Somos una IA personalizada con un equipo de expertos listos para ayudarte a escalar tu negocio.",
                    welcome_user: "¡Hola, ", welcome_user_2: "! Hoy es un gran día para crear algo increíble.",
                    welcome_guest: "¿Cómo puedo ayudarte hoy?", model: "Modelo:", model_general: "Chat General (Turbo)",
                    model_web: "Búsqueda Web", voice: "Voz:", placeholder_main: "Escribe tu mensaje...", cancel: "Cancelar",
                    confirm: "Confirmar", plans_title: "Planes Goatify", plan_free_sub: "Para Siempre", plan_free_cta: "Empezar Gratis",
                    plan_feat_ltd_chat: "Acceso limitado al chat", plan_feat_ltd_hist: "Historial limitado", plan_feat_ltd_proj: "Organización por proyectos (Limitado)",
                    plan_boost_cta: "Obtener Boost", plan_feat_fast: "Respuestas ultrarrápidas ⚡️", plan_feat_unl_hist: "Historial ilimitado",
                    plan_feat_proj: "Organización por Proyectos", plan_feat_ltd_wf: "Workflows Limitados", plan_pro_cta: "Quiero mi Plan Pro + Web",
                    plan_feat_all_boost: "Todo lo de Boost y más", plan_feat_all_models: "Acceso a todos los modelos de IA",
                    plan_feat_all_wf: "Acceso a todos los Workflows", plan_feat_community: "Comunidad privada y webinars", plan_feat_support: "Asistencia prioritaria 1-a-1",
                    plan_feat_free_web: "Página Web Gratis", preview: "Vista Previa", settings_email: "Correo Electrónico:", settings_plan: "Plan de Suscripción:",
                    settings_fontsize: "Tamaño de Letra:", settings_theme: "Personalización:", settings_dark_mode: "Modo Oscuro",
                    settings_lang: "Idioma:", settings_whatsapp: "Conectarse a WhatsApp", current_plan: "Tu Plan Actual",
                },
                en: {
                    initializing: "Initializing...", new_chat: "New Chat", new_project: "New Project",
                    web_offer: "🚀 Launch your Business, get a free website with your subscription!",
                    upgrade_plan: "Upgrade Plan", free_guides: "Free AI Guides", workflows: "Workflows",
                    wf_social: "Social Media Booster", wf_social_1: "Create a Full Post", wf_social_2: "Copywriting",
                    wf_social_3: "Brainstorm Post Ideas", wf_social_4: "Define Brand Strategy",
                    wf_business: "Business Analysis", wf_business_1: "Analyze your Competition", wf_business_2: "Define my Ideal Customer",
                    wf_business_3: "Brainstorm Brand Names", wf_sales: "Communication & Sales", wf_sales_1: "24/7 Sales Assistant",
                    wf_sales_2: "Email Writing", wf_sales_3: "Web Design", wf_eng_1: "Translate/Correct Text",
                    wf_eng_2: "Learn New Vocabulary", wf_eng_3: "Practice Conversation", select_chats: "Select Multiple Chats",
                    delete: "Delete", login: "Login", settings: "Settings", logout: "Logout",
                    solutions: "Solutions", ally_title: "We are your Strategic Ally",
                    ally_desc: "Goatify is not just a chat. We are a custom AI with a team of experts ready to help you scale your business.",
                    welcome_user: "Hello, ", welcome_user_2: "! Today is a great day to create something amazing.",
                    welcome_guest: "How can I help you today?", model: "Model:", model_general: "General Chat (Turbo)",
                    model_web: "Web Search", voice: "Voice:", placeholder_main: "Type your message...", cancel: "Cancel",
                    confirm: "Confirm", plans_title: "Goatify Plans", plan_free_sub: "Forever", plan_free_cta: "Get Started for Free",
                    plan_feat_ltd_chat: "Limited chat access", plan_feat_ltd_hist: "Limited history", plan_feat_ltd_proj: "Project organization (Limited)",
                    plan_boost_cta: "Get Boost", plan_feat_fast: "Ultrafast responses ⚡️", plan_feat_unl_hist: "Unlimited history",
                    plan_feat_proj: "Project Organization", plan_feat_ltd_wf: "Limited Workflows", plan_pro_cta: "Get Pro Plan + Web",
                    plan_feat_all_boost: "Everything in Boost and more", plan_feat_all_models: "Access to all AI models",
                    plan_feat_all_wf: "Access to all Workflows", plan_feat_community: "Private community & webinars", plan_feat_support: "1-on-1 priority support",
                    plan_feat_free_web: "Free Website", preview: "Preview", settings_email: "Email Address:", settings_plan: "Subscription Plan:",
                    settings_fontsize: "Font Size:", settings_theme: "Personalization:", settings_dark_mode: "Dark Mode",
                    settings_lang: "Language:", settings_whatsapp: "Connect to WhatsApp", current_plan: "Current Plan",
                }
            };
            
            const GUEST_CREDIT_LIMIT = 5;
            const FREE_PLAN_CREDIT_LIMIT = 15;
            const COSTS = { WEB_PAGE: 2, COPYWRITING: 2, SALES_RESPONSE: 2, NEBULA: 2, GENERAL: 1, SEARCH: 1, ENGLISH_TEACHER: 1, IMAGE: 5 };
            let state = { chats: {}, projects: {}, structure: [] };
            let currentChatId = null, currentUser = null, speechOn = false, availableVoices = [], selectedVoice = null, isRecognizing = false, selectedImageBase64 = null, selectedPdfText = null;
            let micWasOnBeforeSpeaking = false;
            let modalResolve = null;
            let isSelectModeActive = false;
            let chatsToDelete = new Set();
            const dom = {};
            
            const fullDom = {
                appContainer: document.getElementById('app-container'), msgInput: document.getElementById('msg'), sendBtn: document.getElementById('send'),
                messageCounterEl: document.getElementById('message-counter'), upgradePlanContainer: document.getElementById('upgrade-plan-container'),
                upgradePlanBtn: document.getElementById('upgrade-plan-btn'), newChatBtn: document.getElementById('new-chat-btn'), newProjectBtn: document.getElementById('new-project-btn'),
                pricingModal: document.getElementById('pricing-modal'), closePricingModalBtn: document.getElementById('close-pricing-modal'),
                genericModal: document.getElementById('generic-modal'), chatMessages: document.getElementById('chat-messages'),
                chatTitle: document.getElementById('chat-title'), mobileChatTitle: document.getElementById('mobile-chat-title'),
                chatTitleWrapper: document.getElementById('chat-title-wrapper'), mobileChatTitleWrapper: document.getElementById('mobile-chat-title-wrapper'),
                initialMessageContainer: document.getElementById('initial-message-container'), themeToggle: document.getElementById('theme-toggle'), themeIcon: document.getElementById('theme-icon'),
                micBtn: document.getElementById('mic-btn'), ttsToggle: document.getElementById('tts-toggle'), modelSelector: document.getElementById('model-selector'),
                imageUploadBtn: document.getElementById('image-upload-btn'), imageUploadInput: document.getElementById('image-upload'),
                imagePreviewContainer: document.getElementById('image-preview-container'), imagePreview: document.getElementById('image-preview'),
                clearImageBtn: document.getElementById('clear-image-btn'), pdfUploadBtn: document.getElementById('pdf-upload-btn'), pdfUploadInput: document.getElementById('pdf-upload'),
                pdfPreviewContainer: document.getElementById('pdf-preview-container'), pdfNameEl: document.getElementById('pdf-name'), pdfStatusEl: document.getElementById('pdf-status'), clearPdfBtn: document.getElementById('clear-pdf-btn'),
                sidebar: document.getElementById('sidebar'), menuToggle: document.getElementById('menu-toggle'), sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarContent: document.getElementById('sidebar-content'), loginView: document.getElementById('login-view'), userMenuView: document.getElementById('user-menu-view'),
                loginBtn: document.getElementById('login-btn'), userMenuBtn: document.getElementById('user-menu-btn'), userMenuPopup: document.getElementById('user-menu-popup'), userEmail: document.getElementById('user-email'),
                logoutBtn: document.getElementById('logout-btn'), webLaunchOfferBtn: document.getElementById('web-launch-offer-btn'),
                workflowsContainer: document.getElementById('workflows-container'), freeGuidesLink: document.getElementById('free-guides-link'),
                personalizedWelcome: document.getElementById('personalized-welcome'), genericWelcome: document.getElementById('generic-welcome'), userName: document.getElementById('user-name'),
                loadingOverlay: document.getElementById('loading-overlay'), htmlPreviewModal: document.getElementById('html-preview-modal'),
                closeHtmlPreviewModalBtn: document.getElementById('close-html-preview-modal'), htmlPreviewIframe: document.getElementById('html-preview-iframe'),
                voiceSelector: document.getElementById('voice-selector'), voiceSelectorContainer: document.getElementById('voice-selector-container'),
                selectChatsBtn: document.getElementById('select-chats-btn'), deleteModeControls: document.getElementById('delete-mode-controls'),
                deleteSelectedBtn: document.getElementById('delete-selected-btn'), cancelSelectModeBtn: document.getElementById('cancel-select-mode-btn'),
                imageGenBtn: document.getElementById('image-gen-btn'), servicesMenuBtn: document.getElementById('services-menu-btn'), servicesMenu: document.getElementById('services-menu'),
                contextualFooter: document.getElementById('contextual-footer'), imageGenBtnMobile: document.getElementById('image-gen-btn-mobile'),
                pdfUploadBtnMobile: document.getElementById('pdf-upload-btn-mobile'), imageUploadBtnMobile: document.getElementById('image-upload-btn-mobile'),
                newChatIconBtn: document.getElementById('new-chat-icon-btn'), settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'), closeSettingsModal: document.getElementById('close-settings-modal'),
                settingsUserEmail: document.getElementById('settings-user-email'), settingsUserPlan: document.getElementById('settings-user-plan'),
                settingsUpgradePlanBtn: document.getElementById('settings-upgrade-plan-btn'), fontSizeSlider: document.getElementById('font-size-slider'),
                fontSizeValue: document.getElementById('font-size-value'), settingsThemeToggle: document.getElementById('settings-theme-toggle'),
                settingsThemeIcon: document.getElementById('settings-theme-icon'), languageSelector: document.getElementById('language-selector'),
                connectWhatsappBtn: document.getElementById('connect-whatsapp-btn'), freePlanBtn: document.getElementById('free-plan-btn')
            };
            Object.assign(dom, fullDom);

            function setLanguage(lang) {
                const translationData = translations[lang];
                if (!translationData) return;
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    if (translationData[key]) {
                         if (el.tagName === 'TEXTAREA' || (el.tagName === 'INPUT' && el.type === 'text')) {
                            el.placeholder = translationData[key];
                        } else {
                            el.textContent = translationData[key];
                        }
                    }
                });
                document.documentElement.lang = lang;
                localStorage.setItem('goatify-lang', lang);
                const currentModalConfirm = dom.genericModal.querySelector('#modal-confirm');
                if (currentModalConfirm) {
                    dom.genericModal.querySelector('#modal-cancel').textContent = translationData.cancel;
                }
            }

            function updateContextualFooter(workflowKey) {
                if (!dom.contextualFooter) return;
                const workflowTexts = {
                    'create-full-post': 'Modo Redes Sociales: Define tu red social y tema para un post completo.',
                    'persuasive-copy': 'Modo Copywriter: Dime qué vendes y para dónde es el texto.',
                    'brand-strategy': 'Modo Estratega: Dime el nombre y rubro de tu negocio para empezar.',
                    'competitor-analysis': 'Modo Analista: Pega la URL de tu competencia para investigarla.',
                    'sales-assistant': 'Modo Asistente de Ventas: Pega el mensaje de tu cliente para responder.',
                    'english-teacher-practice': 'Practice mode: Let\'s talk. How was your day?',
                    'design-web': 'Modo Diseñador Web: Describe el componente visual y lo crearé en HTML.'
                };
                const currentChat = state.chats[currentChatId];
                const key = workflowKey || (currentChat ? currentChat.workflow : null);
                dom.contextualFooter.textContent = workflowTexts[key] || 'Tu copiloto de IA para hacer crecer tu negocio.';
            }

            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            function showModal({ title, message = '', useInput = false, useTextarea = false, placeholder = '', confirmText = 'Confirmar', initialValue = '' }) {
                const modalTitle = dom.genericModal.querySelector('#modal-title');
                const modalMessage = dom.genericModal.querySelector('#modal-message');
                const modalInput = dom.genericModal.querySelector('#modal-input');
                const modalTextarea = dom.genericModal.querySelector('#modal-textarea');
                const modalButtonsContainer = dom.genericModal.querySelector('#modal-buttons-container');
                const lang = localStorage.getItem('goatify-lang') || 'es';
                
                modalTitle.innerHTML = title; 
                modalMessage.innerHTML = message;
                modalMessage.style.display = message ? 'block' : 'none';
                
                modalInput.style.display = useInput ? 'block' : 'none';
                modalTextarea.style.display = useTextarea ? 'block' : 'none';
                
                modalInput.value = initialValue;
                modalTextarea.value = initialValue;
                modalInput.placeholder = placeholder;
                modalTextarea.placeholder = placeholder;
                
                modalButtonsContainer.innerHTML = `<button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded">${translations[lang].cancel}</button><button id="modal-confirm" class="px-4 py-2 rounded text-white btn-primary">${confirmText}</button>`;
                dom.genericModal.querySelector('#modal-confirm').addEventListener('click', () => hideModal(useInput ? modalInput.value : (useTextarea ? modalTextarea.value : true)), { once: true });
                dom.genericModal.querySelector('#modal-cancel').addEventListener('click', () => hideModal(null), { once: true });
                
                dom.genericModal.classList.remove('hidden');
                dom.genericModal.classList.add('flex');
                if (useInput) modalInput.focus();
                if (useTextarea) modalTextarea.focus();
                
                return new Promise(resolve => { modalResolve = resolve; });
            }
            function hideModal(resolveWith = null) { if(modalResolve) { modalResolve(resolveWith); modalResolve = null; } dom.genericModal.classList.add('hidden'); dom.genericModal.classList.remove('flex');  }
            
            function showPricingModal() { 
                dom.pricingModal.classList.remove('hidden'); 
                dom.pricingModal.classList.add('flex'); 
                setTimeout(() => { dom.pricingModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
                
                const lang = localStorage.getItem('goatify-lang') || 'es';
                const isFree = !currentUser || (currentUser.app_metadata?.plan || 'free') === 'free';
                
                if (isFree) {
                    dom.freePlanBtn.textContent = translations[lang].current_plan;
                    dom.freePlanBtn.disabled = true;
                    dom.freePlanBtn.classList.add('btn-disabled');
                } else {
                    dom.freePlanBtn.textContent = translations[lang].plan_free_cta;
                    dom.freePlanBtn.disabled = false;
                    dom.freePlanBtn.classList.remove('btn-disabled');
                }
            }
            function hidePricingModal() { dom.pricingModal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => { dom.pricingModal.classList.add('hidden'); dom.pricingModal.classList.remove('flex'); }, 300); }

            function showSettingsModal() {
                dom.settingsModal.classList.remove('hidden');
                dom.settingsModal.classList.add('flex');
                if (currentUser) {
                    dom.settingsUserEmail.textContent = currentUser.email;
                    const userPlan = currentUser.app_metadata?.plan || 'free';
                    dom.settingsUserPlan.textContent = userPlan.charAt(0).toUpperCase() + userPlan.slice(1);
                    dom.settingsUpgradePlanBtn.classList.toggle('hidden', userPlan !== 'free');
                } else {
                    dom.settingsUserEmail.textContent = 'Not logged in';
                    dom.settingsUserPlan.textContent = 'Free (Guest)';
                    dom.settingsUpgradePlanBtn.classList.remove('hidden');
                }
                dom.fontSizeSlider.value = parseInt(getComputedStyle(document.body).getPropertyValue('--base-font-size')) || 16;
                dom.fontSizeValue.textContent = `${dom.fontSizeSlider.value}px`;
                dom.settingsThemeIcon.className = `fas fa-${document.body.classList.contains('dark-theme') ? 'moon' : 'sun'} mr-2`;
                dom.languageSelector.value = localStorage.getItem('goatify-lang') || 'es';
            }

            function hideSettingsModal() {
                dom.settingsModal.classList.add('hidden');
                dom.settingsModal.classList.remove('flex');
            }

            function speak(text) { 
                if (!speechOn || !('speechSynthesis' in window) || !text) return; 
                speechSynthesis.cancel();
                micWasOnBeforeSpeaking = isRecognizing;
                if (isRecognizing) { recognition.stop(); }
                const cleanText = text.replace(/<[^>]*>/g, '').replace(/[*_`#~[\]()🔍]|(-{3,})/g, ''); 
                const utterance = new SpeechSynthesisUtterance(cleanText); 
                if (selectedVoice) { utterance.voice = selectedVoice; }
                utterance.rate = 1.15;
                utterance.onend = () => {
                    if (micWasOnBeforeSpeaking) {
                        if (recognition && !isRecognizing) {
                            try { recognition.start(); } catch(e) { console.error("Error restarting recognition:", e); }
                        }
                        micWasOnBeforeSpeaking = false;
                    }
                };
                utterance.onerror = (e) => {
                    console.error('Speech synthesis error:', e);
                     if (micWasOnBeforeSpeaking) {
                        if (recognition && !isRecognizing) {
                           try { recognition.start(); } catch(e) { console.error("Error restarting recognition on error:", e); }
                        }
                        micWasOnBeforeSpeaking = false;
                    }
                }
                speechSynthesis.speak(utterance); 
            }

            function populateVoiceList() {
                if(!dom.voiceSelector) return;
                const setVoices = () => {
                    if (typeof speechSynthesis === 'undefined') {
                        return;
                    }
                    availableVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('es-'));
                    const preferredVoices = [ "Microsoft Sabina Online (Natural) - Spanish (Mexico)", "Paulina", "Google español de Estados Unidos", "Google español" ];
                     availableVoices.sort((a, b) => {
                        let aIdx = preferredVoices.indexOf(a.name); let bIdx = preferredVoices.indexOf(b.name);
                        if (aIdx === -1) aIdx = Infinity; if (bIdx === -1) bIdx = Infinity;
                        if (aIdx !== bIdx) return aIdx - bIdx;
                        return a.name.localeCompare(b.name);
                    });
                    dom.voiceSelector.innerHTML = '';
                    if(availableVoices.length > 0) {
                             dom.voiceSelector.disabled = false;
                        availableVoices.forEach(voice => {
                            const option = document.createElement('option');
                            const displayName = voice.name.replace('Microsoft', '').replace('Online (Natural) -', '').replace('Google', '').replace('Spanish (Mexico)','Mex').trim();
                            option.textContent = displayName || voice.lang;
                            option.value = voice.name;
                            dom.voiceSelector.appendChild(option);
                        });
                        selectedVoice = availableVoices[0];
                        if (selectedVoice) dom.voiceSelector.value = selectedVoice.name;
                    } 
                }
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = setVoices;
                }
                setTimeout(setVoices, 200);
            }

            function updateModelSelectorState() {}

            function createSubtleUpsell(workflowKey) {
                const upsells = {
                     'create-full-post': "Tip de experto: La clave es la constancia. Si quieres un calendario de contenido para todo el mes, nuestros planes de gestión de redes son para ti.",
                     'persuasive-copy': "Un buen copy es el corazón de un anuncio ganador. Cuando estés listo para lanzar una campaña de publicidad completa con segmentación y presupuesto optimizado, nuestro equipo de marketing puede gestionarla por ti.",
                     'post-ideas': "Usa estas ideas para no quedarte en blanco. Recuerda que si necesitas llevar tu marca al siguiente nivel, podemos crear avatares con IA que hablen en videos. Es algo que nos diferencia.",
                     'brand-strategy': "Esta es la base. Para desarrollar una estrategia de marketing digital completa con anuncios y embudos, lo ideal es una sesión con nuestros consultores.",
                     'sales-assistant': "Tip Pro: ¿Sabías que podemos crear un bot que haga esto por ti 24/7, cualificando clientes mientras duermes? Si te interesa, hablemos de automatización.",
                     'email-writing': "El poder real de estos emails se desata al integrarlos en un sistema de marketing automático. Si quieres que te construyamos todo el sistema, contacta a nuestros especialistas.",
                     'english-teacher-practice': "Your English is improving! Quick tip: Strong communication is key in business. Our copywriting services help clients ensure their message is perfect for international markets."
                };
                const upsellText = upsells[workflowKey];
                if (upsellText) {
                    const upsellDiv = document.createElement('div');
                    upsellDiv.className = 'mt-3 pt-3 border-t border-themed text-xs text-text-medium italic';
                    upsellDiv.innerHTML = upsellText;
                    return upsellDiv;
                }
                return null;
            }

            function getModelForRequest(workflow, hasFile) {
                if (workflow === "design-web") return "gpt-4o-mini";
                if (hasFile) return "gpt-4o-mini";
                return dom.modelSelector.value;
            }

            async function getAIResponse(prompt, history, image, pdf, model, workflow, userName) {
                const name = (userName || '').split(' ')[0];
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }
                const body = { 
                    prompt, history, model,
                    workflow, userName: name, title,
                    imageData: image, pdfText: pdf, 
                };
                try {
                    const response = await fetch('/.netlify/functions/get-ai-response', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({details: 'Error desconocido en el servidor'}));
                        console.error("Backend Error:", errorData);
                        throw new Error(errorData.details || `Error del servidor: ${response.status}.`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("Fetch Error:", error);
                    throw error;
                }
            }
            
            function getCreditCount() {
                if (currentUser) {
                    const credits = localStorage.getItem(`userCredits_${currentUser.id}`);
                    return credits === null ? FREE_PLAN_CREDIT_LIMIT : parseInt(credits, 10);
                } else {
                    const credits = localStorage.getItem('guestCreditCount');
                    return credits === null ? GUEST_CREDIT_LIMIT : parseInt(credits, 10);
                }
            }
            
            function setCreditCount(newCount) {
                const count = Math.max(0, newCount);
                if (currentUser) {
                    localStorage.setItem(`userCredits_${currentUser.id}`, count);
                } else {
                    localStorage.setItem('guestCreditCount', count);
                }
                updateCreditCounter();
            }

            async function loadStateForUser() {
                if (!currentUser) {
                    const saved = localStorage.getItem('guestState');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        state = parsed.state || { chats: {}, projects: {}, structure: [] };
                        currentChatId = parsed.currentChatId;
                    } else {
                        state = { chats: {}, projects: {}, structure: [] };
                        currentChatId = null;
                    }
                    renderSidebar();
                    selectChat(currentChatId);
                    return;
                }

                try {
                    const response = await fetch('/.netlify/functions/load-chats', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: currentUser.id }),
                    });

                    if (!response.ok) { throw new Error(`Server error: ${response.status}`); }
                    const dbState = await response.json();
                    state = dbState.state || { chats: {}, projects: {}, structure: [] };
                    currentChatId = dbState.currentChatId;
                } catch (error) {
                    console.error("Could not load from DB, falling back to localStorage:", error);
                    const saved = localStorage.getItem(`goatbotState_${currentUser.id}`);
                    state = saved ? (JSON.parse(saved).state || { chats: {}, projects: {}, structure: [] }) : { chats: {}, projects: {}, structure: [] };
                    currentChatId = saved ? JSON.parse(saved).currentChatId : null;
                }
                
                renderSidebar();
                selectChat(currentChatId);
            }

            async function saveState() {
                if (!currentUser) {
                    try {
                        localStorage.setItem('guestState', JSON.stringify({ state, currentChatId }));
                    } catch (e) { console.error("Guest localStorage is full.", e); }
                    return;
                }
                try {
                    const stateToSave = { state, currentChatId };
                    await fetch('/.netlify/functions/save-chats', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            userId: currentUser.id,
                            stateToSave: stateToSave
                        }),
                    });
                } catch (error) {
                    console.error("Failed to save state to DB:", error);
                }
            }
            
            function updateUserUI() {
                if (currentUser) {
                    dom.loginView.classList.add('hidden');
                    dom.userMenuView.classList.remove('hidden');
                    dom.genericWelcome.classList.add('hidden');
                    dom.personalizedWelcome.classList.remove('hidden');
                    const userName = currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.email.split('@')[0];
                    dom.userEmail.textContent = currentUser.user_metadata?.full_name || currentUser.email;
                    dom.userName.textContent = userName;
                    dom.upgradePlanContainer.classList.toggle('hidden', (currentUser.app_metadata?.plan || 'free') !== 'free');
                } else {
                    dom.loginView.classList.remove('hidden');
                    dom.userMenuView.classList.add('hidden');
                    dom.genericWelcome.classList.remove('hidden');
                    dom.personalizedWelcome.classList.add('hidden');
                    dom.upgradePlanContainer.classList.add('hidden');
                }
                updateCreditCounter();
            }

            function updateCreditCounter() {
                const count = getCreditCount();
                const limit = currentUser ? FREE_PLAN_CREDIT_LIMIT : GUEST_CREDIT_LIMIT;
                dom.messageCounterEl.innerHTML = `${count}/${limit} <span class="hidden sm:inline">créditos</span>`;
            }

            function setTheme(isDark) { 
                document.body.className = 'w-screen overflow-x-hidden';
                document.body.classList.add(isDark ? 'dark-theme' : 'light-theme');
                dom.themeIcon.className = `fas fa-${isDark ? 'sun' : 'moon'}`; 
                if (dom.settingsThemeIcon) {
                    dom.settingsThemeIcon.className = `fas fa-${isDark ? 'moon' : 'sun'} mr-2`;
                }
                localStorage.setItem('theme', isDark ? 'dark' : 'light'); 
            }

            function toggleSidebar(show) {
                if (show) {
                    dom.sidebar.classList.add('is-open');
                    dom.sidebarOverlay.classList.remove('pointer-events-none');
                    dom.sidebarOverlay.classList.add('opacity-50');
                } else {
                    dom.sidebar.classList.remove('is-open');
                    dom.sidebarOverlay.classList.remove('opacity-50');
                    dom.sidebarOverlay.classList.add('pointer-events-none');
                }
            }
            
            function createNewChat(options = {}) {
                const id = 'chat-' + crypto.randomUUID();
                const name = currentUser ? (currentUser.user_metadata.full_name?.split(' ')[0] || 'Tú') : 'viajero';
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }
                const initialMessages = options.initialMessages || [{ 
                    role: 'assistant', 
                    content: `Saludos, ${title}. Soy Goatify AI, aquí para servirte. Cada idea tuya es una estrella a punto de nacer. ¿En qué universo nos sumergimos hoy?` 
                }];
                state.chats[id] = { 
                    id, 
                    title: options.title || "Conversación Cósmica", 
                    messages: initialMessages,
                    workflow: options.workflow || null,
                    model: options.model || 'gpt-3.5-turbo-1106'
                }; 
                state.structure.unshift(id); 
                selectChat(id); 
                saveState(); 
                renderSidebar(); 
                dom.modelSelector.value = options.model || 'gpt-3.5-turbo-1106';
                updateModelSelectorState();
                if (window.innerWidth < 768) toggleSidebar(false);
                return id; 
            }

            function selectChat(chatId) { 
                if (isSelectModeActive) return; 
                if (!chatId || !state.chats[chatId]) { resetChatView(); return; } 
                currentChatId = chatId; 
                dom.initialMessageContainer.style.display = 'none'; 
                dom.chatMessages.innerHTML = ''; 
                const chat = state.chats[chatId]; 
                dom.chatTitle.textContent = chat.title;
                if (dom.mobileChatTitle) dom.mobileChatTitle.textContent = chat.title;
                chat.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, msg.image, index)); 
                dom.modelSelector.value = chat.model || 'gpt-3.5-turbo-1106';
                updateActiveChatHighlight(); 
                saveState();
                updateModelSelectorState();
                updateContextualFooter(chat.workflow);
                if (window.innerWidth < 768) toggleSidebar(false);
            }

            function resetChatView() { 
                currentChatId = null; 
                dom.chatTitle.textContent = "Goatify AI";
                if (dom.mobileChatTitle) dom.mobileChatTitle.textContent = "Goatify AI";
                dom.chatMessages.innerHTML = ''; 
                dom.initialMessageContainer.style.display = 'flex'; 
                updateUserUI(); 
                updateActiveChatHighlight(); 
                dom.modelSelector.value = 'gpt-3.5-turbo-1106';
                updateModelSelectorState();
                updateContextualFooter(null);
            }

            function addMessageToUI(role, content, imageSrc, messageIndex) {
                const wrapper = document.createElement('div');
                wrapper.className = `chat-bubble-wrapper group flex items-center gap-2 my-2 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const bubble = document.createElement('div');
                bubble.className = `p-3 md:p-4 rounded-xl max-w-lg md:max-w-xl ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot'}`;

                if (imageSrc) {
                    const img = document.createElement('img');
                    img.src = imageSrc;
                    img.className = 'rounded-lg mb-2 max-w-full h-auto';
                    bubble.appendChild(img);
                }
                const contentDiv = document.createElement('div');
                contentDiv.className = 'markdown-content';
                contentDiv.innerHTML = content === '…' ? `<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .2s;"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .4s;"></div></div>` : marked.parse(content || "");
                bubble.appendChild(contentDiv);

                if (role === 'user') {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'p-1 text-text-medium opacity-0 group-hover:opacity-60 hover:!opacity-100 transition-opacity';
                    editBtn.innerHTML = '<i class="fas fa-pencil-alt fa-xs"></i>';
                    editBtn.title = 'Editar mensaje';
                    editBtn.onclick = (e) => { e.stopPropagation(); handleEditMessage(messageIndex); };
                    wrapper.insertBefore(editBtn, wrapper.firstChild); // Add button before the bubble
                }
                
                if (role === 'assistant' && /<\/?[a-z][\s\S]*>/i.test(content)) {
                    const previewButton = document.createElement('button');
                    previewButton.innerHTML = '<i class="fas fa-eye mr-2"></i>Vista Previa';
                    previewButton.className = 'btn-primary text-xs font-semibold px-3 py-1 rounded-md mt-3';
                    previewButton.addEventListener('click', () => {
                        const match = content.match(/```html\n([\s\S]*?)```/);
                        const htmlToPreview = match ? match[1] : content;
                        dom.htmlPreviewIframe.srcdoc = htmlToPreview;
                        dom.htmlPreviewModal.classList.remove('hidden');
                        dom.htmlPreviewModal.classList.add('flex');
                    });
                    bubble.appendChild(previewButton);
                }

                wrapper.appendChild(bubble); // Add the bubble after the (possible) button
                dom.chatMessages.appendChild(wrapper);
                dom.chatMessages.scrollTop = dom.chatMessages.scrollHeight;
                return bubble;
            }
            
            async function handleEditMessage(index) {
                const chat = state.chats[currentChatId];
                if (!chat || !chat.messages[index]) return;
                const originalContent = chat.messages[index].content;
                const newContent = await showModal({
                    title: 'Editar Mensaje',
                    useTextarea: true,
                    initialValue: originalContent,
                    confirmText: 'Guardar Cambios'
                });
                if (newContent && newContent.trim() !== originalContent.trim()) {
                    chat.messages[index].content = newContent.trim();
                    await saveState();
                    selectChat(currentChatId);
                }
            }

            function updateMessageInUI(bubble, content, imageSrc) {
                const newBubble = addMessageToUI('assistant', content, imageSrc);
                if (bubble && bubble.parentElement) {
                    bubble.parentElement.replaceWith(newBubble.parentElement);
                }
            }
            
            function renderSidebar() { 
                dom.sidebarContent.innerHTML = ''; 
                const frag = document.createDocumentFragment(); 
                (state.structure || []).forEach(id => { 
                    if (id.startsWith('project-')) {
                        frag.appendChild(createProjectElement(id));
                    } else if (id.startsWith('chat-')) {
                             frag.appendChild(createChatItemElement(id));
                    }
                }); 
                dom.sidebarContent.appendChild(frag); 
                updateActiveChatHighlight(); 
            }
            function createChatItemElement(id, isSubItem = false) { 
                const chat = state.chats[id]; 
                if (!chat) return document.createDocumentFragment(); 
                const item = document.createElement('div'); 
                item.className = `chat-item group flex items-center justify-between p-2 rounded-md cursor-pointer ${isSubItem ? 'pl-5' : ''}`; item.dataset.id = id; 
                if (isSelectModeActive) {
                    item.draggable = false;
                    const isSelected = chatsToDelete.has(id);
                    item.innerHTML = `<i class="far ${isSelected ? 'fa-check-square' : 'fa-square'} mr-2 text-primary"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span>`;
                    if (isSelected) item.classList.add('selected-for-delete');
                    item.addEventListener('click', () => {
                        if (chatsToDelete.has(id)) {
                            chatsToDelete.delete(id);
                            item.querySelector('i').classList.replace('fa-check-square', 'fa-square');
                            item.classList.remove('selected-for-delete');
                        } else {
                            chatsToDelete.add(id);
                            item.querySelector('i').classList.replace('fa-square', 'fa-check-square');
                            item.classList.add('selected-for-delete');
                        }
                        dom.deleteSelectedBtn.disabled = chatsToDelete.size === 0;
                    });
                } else {
                    item.draggable = true;
                    item.innerHTML = `<i class="far fa-comment-dots mr-2"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span><div class="chat-item-actions flex-shrink-0"><button class="rename-btn text-text-medium hover:text-primary p-1"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-text-medium hover:text-red-500 p-1"><i class="fas fa-trash-alt fa-xs"></i></button></div>`; 
                    item.addEventListener('click', e => { if (!e.target.closest('.chat-item-actions')) selectChat(id); }); 
                    item.addEventListener('dragstart', e => handleDragStart(e, id)); item.querySelector('.rename-btn').addEventListener('click', () => renameItem('chat', id)); item.querySelector('.delete-btn').addEventListener('click', () => deleteItem('chat', id));
                }
                return item; 
            }
            function createProjectElement(id) {
                const project = state.projects[id];
                if (!project) return document.createDocumentFragment();
                const div = document.createElement('div'); div.className = 'project'; div.dataset.id = id;
                const header = document.createElement('div'); header.className = 'project-header group flex items-center p-2 rounded-md cursor-pointer';
                header.innerHTML = `<i class="fas fa-chevron-right project-arrow mr-2 transition-transform"></i><i class="fas fa-folder mr-2 text-yellow-500"></i><span class="flex-grow truncate text-sm font-bold">${project.title}</span><div class="chat-item-actions flex-shrink-0"><button class="rename-btn text-text-medium hover:text-primary p-1"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-text-medium hover:text-red-500 p-1"><i class="fas fa-trash-alt fa-xs"></i></button></div>`;
                const content = document.createElement('div'); content.className = 'project-content pl-2 pt-1 space-y-1';
                (project.chatIds || []).forEach(chatId => content.appendChild(createChatItemElement(chatId, true)));
                div.append(header, content);
                header.addEventListener('click', e => { if (!e.target.closest('.chat-item-actions')) div.classList.toggle('open'); });
                header.addEventListener('dragover', e => handleDragOver(e, header));
                header.addEventListener('dragleave', e => handleDragLeave(e, header));
                header.addEventListener('drop', e => handleDrop(e, id, header));
                header.querySelector('.rename-btn').addEventListener('click', () => renameItem('project', id));
                header.querySelector('.delete-btn').addEventListener('click', () => deleteItem('project', id));
                return div;
            }
            let draggedItemId = null; function handleDragStart(e, id) { draggedItemId = id; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', id); } function handleDragOver(e, el) { e.preventDefault(); el.classList.add('drag-over'); } function handleDragLeave(e, el) { el.classList.remove('drag-over'); }
            function handleDrop(e, targetProjectId, targetElement) {
                e.preventDefault(); if (targetElement) targetElement.classList.remove('drag-over');
                const sourceChatId = e.dataTransfer.getData('text/plain');
                if (!sourceChatId || !sourceChatId.startsWith('chat-') || targetProjectId === sourceChatId) return;
                state.structure = state.structure.filter(id => id !== sourceChatId); 
                Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(id => id !== sourceChatId) }); 
                if(state.projects[targetProjectId]){ 
                    if(!state.projects[targetProjectId].chatIds) state.projects[targetProjectId].chatIds = [];
                    state.projects[targetProjectId].chatIds.unshift(sourceChatId); 
                } 
                saveState(); renderSidebar(); 
            }
            async function renameItem(type, id) {
                const item = type === 'chat' ? state.chats[id] : state.projects[id];
                if(!item) return;
                const newName = await showModal({ title: `Renombrar ${type === 'chat' ? 'Conversación' : 'Proyecto'}`, useInput: true, placeholder: item.title, initialValue: item.title });
                if (newName && newName.trim()) {
                    item.title = newName.trim();
                    if (type === 'chat' && currentChatId === id) {
                        dom.chatTitle.textContent = item.title;
                        if (dom.mobileChatTitle) dom.mobileChatTitle.textContent = item.title;
                    }
                    saveState();
                    renderSidebar();
                }
            }
            async function deleteItem(type, id) { const item = type === 'chat' ? state.chats[id] : state.projects[id]; const conf = await showModal({ title: `Eliminar ${item.title}?`, message: 'Esta acción no se puede deshacer.', confirmText: 'Eliminar' }); if (conf) { state.structure = state.structure.filter(i => i !== id); if (type === 'project') { (item.chatIds || []).forEach(cid => delete state.chats[cid]); delete state.projects[id]; } else { delete state.chats[id]; Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(cid => cid !== id)}); } if(currentChatId === id || (type === 'project' && (item.chatIds || []).includes(currentChatId))) resetChatView(); saveState(); renderSidebar(); } }
            
            function updateActiveChatHighlight() { 
                document.querySelectorAll('.chat-item').forEach(item => {
                    if (item.dataset.id === currentChatId) {
                        item.classList.add('selected-chat');
                    } else {
                        item.classList.remove('selected-chat');
                    }
                }); 
            }

            function clearImageData() { dom.imageUploadInput.value = ''; dom.imagePreviewContainer.classList.add('hidden'); selectedImageBase64 = null; updateModelSelectorState(); }
            function clearPdfData() { dom.pdfUploadInput.value = ''; dom.pdfPreviewContainer.classList.add('hidden'); selectedPdfText = null; updateModelSelectorState(); }
            function hasFile() { return selectedImageBase64 || selectedPdfText; }
            async function sendMessage(forceSend = false, spokenMessage = null) {
                const userMessage = spokenMessage || dom.msgInput.value.trim();
                if (!userMessage && !selectedImageBase64 && !selectedPdfText) return;
                let chatIdToUpdate = currentChatId || createNewChat({});
                const currentChat = state.chats[chatIdToUpdate];
                if (!currentChat) return;
                let modelToUse = getModelForRequest(currentChat.workflow, hasFile());
                const webSearchTriggers = ['busca', 'investiga', 'en internet', 'tiempo real', 'qué día es hoy', 'qué fecha es hoy', 'cuál es el precio de', 'quién es', 'qué es', 'noticias sobre'];
                const requiresWebSearch = webSearchTriggers.some(trigger => userMessage.toLowerCase().startsWith(trigger));
                if (requiresWebSearch && !hasFile() && !currentChat.workflow) { modelToUse = 'sonar'; }
                let cost = COSTS.GENERAL;
                if (currentChat.workflow) { cost = COSTS.COPYWRITING; }
                if (modelToUse === 'sonar') { cost = COSTS.SEARCH; }
                else if (modelToUse.includes('gpt-4') && hasFile()) { cost = COSTS.NEBULA; }
                let count = getCreditCount();
                if (count < cost && !forceSend) {
                    if (currentUser) { showPricingModal(); } 
                    else { showModal({ title: 'Créditos Agotados', message: `Por favor, inicia sesión para obtener más créditos.`, confirmText: 'Iniciar Sesión' }).then(login => { if (login) netlifyIdentity.open('login'); });}
                    return;
                }
                if(currentChat.title === 'Conversación Cósmica' && userMessage.length > 5) {
                    currentChat.title = userMessage.split(' ').slice(0, 4).join(' ');
                    renderSidebar();
                }
                setCreditCount(count - cost);
                const [image, pdf] = [selectedImageBase64, selectedPdfText];
                currentChat.messages.push({ role: 'user', content: userMessage, image, pdfText: pdf });
                addMessageToUI('user', userMessage, image, currentChat.messages.length - 1);
                const thinkingBubble = addMessageToUI('assistant', '…');
                dom.msgInput.value = ''; dom.msgInput.style.height = 'auto'; clearImageData(); clearPdfData();
                try {
                    const userNameForCall = currentUser ? (currentUser.user_metadata.full_name || currentUser.email) : 'viajero';
                    const responseData = await getAIResponse(userMessage, currentChat.messages.slice(0, -1), image, pdf, modelToUse, currentChat.workflow, userNameForCall);
                    if (responseData.error === 'LIMIT_REACHED') {
                        updateMessageInUI(thinkingBubble, `Has alcanzado el límite de créditos de tu plan. ¡Actualiza para continuar!`);
                        setCreditCount(0); showPricingModal(); return;
                    }
                    if (responseData.reply) {
                        updateCreditCounter();
                        currentChat.messages.push({ role: 'assistant', content: responseData.reply });
                        updateMessageInUI(thinkingBubble, responseData.reply);
                        speak(responseData.reply);
                        saveState();
                    } else if (responseData.error) {
                        updateMessageInUI(thinkingBubble, `❌ **Error**<br><small>${responseData.details || 'Error del servidor.'}</small>`);
                        setCreditCount(count);
                    }
                } catch (error) {
                    updateMessageInUI(thinkingBubble, `❌ **Error de Conexión**<br><small>${error.message || 'No se pudo conectar al servidor.'}</small>`);
                    setCreditCount(count);
                }
            }
            async function generateImage() {
                const prompt = await showModal({ title: 'Crear Imagen', message: 'Describe la imagen que quieres crear:', useInput: true, placeholder: 'Ej: Un astronauta en un caballo cósmico', confirmText: 'Generar' });
                if (!prompt) { hideModal(); return; }
                hideModal();
                let count = getCreditCount();
                if (count < COSTS.IMAGE) {
                    showModal({ title: 'Créditos Insuficientes', message: `Necesitas ${COSTS.IMAGE} créditos para generar una imagen.` });
                    return;
                }
                setCreditCount(count - COSTS.IMAGE);
                let chatIdToUpdate = currentChatId || createNewChat({});
                const currentChat = state.chats[chatIdToUpdate];
                currentChat.messages.push({ role: 'user', content: `Generar imagen: "${prompt}"` });
                addMessageToUI('user', `Generar imagen: "${prompt}"`, null, currentChat.messages.length - 1);
                const thinkingBubble = addMessageToUI('assistant', 'Creando tu visión con DALL·E 2...');
                try {
                    const response = await fetch('/.netlify/functions/generate-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: 'dall-e-2' })
                    });
                     if (!response.ok) {
                        let errorText;
                        try {
                            const errorData = await response.json();
                            errorText = errorData.error || 'No se pudo generar la imagen.';
                        } catch (e) {
                            errorText = `Error del servidor (${response.status}). Inténtalo de nuevo.`;
                        }
                        throw new Error(errorText);
                    }
                    const { imageData } = await response.json();
                    const imageContent = `¡Aquí está tu creación, Jefe/a!`;
                    currentChat.messages.push({ role: 'assistant', content: imageContent, image: imageData });
                    updateMessageInUI(thinkingBubble, imageContent, imageData);
                    saveState();
                } catch (error) {
                    updateMessageInUI(thinkingBubble, `❌ **Error al crear la imagen:**<br><small>${error.message}</small>`);
                    setCreditCount(count);
                }
            }
            function toggleSelectMode(active) {
                isSelectModeActive = active;
                dom.selectChatsBtn.classList.toggle('hidden', active);
                dom.deleteModeControls.classList.toggle('hidden', !active);
                if (!active) {
                    chatsToDelete.clear();
                    dom.deleteSelectedBtn.disabled = true;
                }
                renderSidebar();
            }

            function setupEventListeners() {
                dom.sendBtn?.addEventListener('click', () => sendMessage());
                const stopSpeech = () => { if(speechSynthesis.speaking) speechSynthesis.cancel(); };
                dom.msgInput?.addEventListener('keydown', (e) => { 
                    stopSpeech();
                    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } 
                });
                dom.msgInput?.addEventListener('input', () => { 
                    stopSpeech();
                    dom.msgInput.style.height = 'auto'; 
                    dom.msgInput.style.height = (dom.msgInput.scrollHeight) + 'px';
                });
                dom.newChatBtn?.addEventListener('click', () => createNewChat());
                dom.newChatIconBtn?.addEventListener('click', () => createNewChat());
                dom.newProjectBtn?.addEventListener('click', async () => { const name = await showModal({ title: 'Crear Proyecto', useInput: true, placeholder: 'Nombre del Proyecto...' }); if (name && name.trim()) { const id = 'project-' + crypto.randomUUID(); state.projects[id] = { id, title: name.trim(), chatIds: [] }; state.structure.unshift(id); saveState(); renderSidebar(); } });
                dom.upgradePlanBtn?.addEventListener('click', showPricingModal);
                dom.closePricingModalBtn?.addEventListener('click', hidePricingModal);
                dom.themeToggle?.addEventListener('click', () => setTheme(!document.body.classList.contains('dark-theme')));
                dom.loginBtn?.addEventListener('click', () => netlifyIdentity.open('login'));
                
                dom.chatTitleWrapper?.addEventListener('click', () => { if(currentChatId) renameItem('chat', currentChatId); });
                dom.mobileChatTitleWrapper?.addEventListener('click', () => { if(currentChatId) renameItem('chat', currentChatId); });

                dom.imageGenBtn?.addEventListener('click', generateImage);
                dom.imageGenBtnMobile?.addEventListener('click', generateImage);
                dom.pdfUploadBtn?.addEventListener('click', () => dom.pdfUploadInput.click());
                dom.pdfUploadBtnMobile?.addEventListener('click', () => dom.pdfUploadInput.click());
                dom.imageUploadBtn?.addEventListener('click', () => dom.imageUploadInput.click());
                dom.imageUploadBtnMobile?.addEventListener('click', () => dom.imageUploadInput.click());
                
                if (SR && dom.micBtn) {
                    recognition = new SR(); 
                    recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'es-ES'; 
                    recognition.onstart = () => { 
                        isRecognizing = true; 
                        dom.micBtn.classList.add('glowing-mic');
                        dom.voiceSelectorContainer.classList.remove('hidden');
                        dom.voiceSelectorContainer.classList.add('flex');
                    };
                    recognition.onend = () => { 
                        isRecognizing = false; 
                        dom.micBtn.classList.remove('glowing-mic'); 
                        dom.voiceSelectorContainer.classList.add('hidden');
                        dom.voiceSelectorContainer.classList.remove('flex');
                    };
                    recognition.onerror = (e) => { console.error("Speech recognition error", e); isRecognizing = false; dom.micBtn.classList.remove('glowing-mic'); };
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        if(transcript) { dom.msgInput.value = transcript; sendMessage(); }
                    };
                    dom.micBtn.addEventListener('click', () => { 
                        if(isRecognizing) {
                            recognition.stop();
                        } else {
                            if (speechSynthesis.speaking) { speechSynthesis.cancel(); }
                            try { recognition.start(); } catch(e) {console.error("Could not start recognition", e)}
                        }
                    });
                } else { if(dom.micBtn) dom.micBtn.style.display = 'none'; }
                
                dom.ttsToggle?.addEventListener('click', () => {
                    speechOn = !speechOn;
                    const icon = dom.ttsToggle.querySelector('i');
                    icon.classList.toggle('fa-volume-high', speechOn);
                    icon.classList.toggle('fa-volume-mute', !speechOn);
                    if (!speechOn) {
                        speechSynthesis.cancel();
                    }
                });

                dom.modelSelector?.addEventListener('change', () => { updateModelSelectorState(); });
                dom.clearImageBtn?.addEventListener('click', clearImageData);
                dom.clearPdfBtn?.addEventListener('click', clearPdfData);
                dom.imageUploadInput?.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { clearPdfData(); const reader = new FileReader(); reader.onload = (ev) => { selectedImageBase64 = ev.target.result; dom.imagePreview.src = selectedImageBase64; dom.imagePreviewContainer.classList.remove('hidden'); updateModelSelectorState(); }; reader.readAsDataURL(e.target.files[0]); } });
                dom.pdfUploadInput?.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file || file.type !== 'application/pdf') return; clearImageData(); dom.pdfNameEl.textContent = file.name; dom.pdfStatusEl.textContent = 'Leyendo...'; dom.pdfPreviewContainer.classList.remove('hidden'); const reader = new FileReader(); reader.onload = async (ev) => { dom.pdfStatusEl.textContent = 'Procesando...'; try { const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(ev.target.result) }).promise; let text = ''; for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const content = await page.getTextContent(); text += content.items.map(item => item.str).join(' ') + '\n'; } selectedPdfText = text; dom.pdfStatusEl.textContent = `✅ Listo (${pdf.numPages} pág.)`; updateModelSelectorState(); } catch (err) { console.error("Error al procesar el PDF:", err); dom.pdfStatusEl.textContent = '❌ Error al leer PDF.'; selectedPdfText = null; setTimeout(clearPdfData, 2000); } }; reader.readAsArrayBuffer(file); });
                dom.menuToggle?.addEventListener('click', (e) => { e.stopPropagation(); toggleSidebar(true); });
                dom.sidebarOverlay?.addEventListener('click', () => toggleSidebar(false));
                dom.userMenuBtn?.addEventListener('click', (e) => { e.stopPropagation(); dom.userMenuPopup.classList.toggle('hidden'); });
                dom.logoutBtn?.addEventListener('click', () => { netlifyIdentity.logout(); dom.userMenuPopup.classList.add('hidden');});
                
                const workflowConfigs = {
                    'create-full-post': { title: "Creador de Posts", workflow: 'create-full-post', initialMessages: [{ role: 'assistant', content: '¡Claro! Vamos a crear un post increíble. ¿Para qué red social lo necesitas (Instagram, Facebook, LinkedIn, etc.)?' }] },
                    'persuasive-copy': { title: "Redactor de Copys", workflow: 'persuasive-copy', initialMessages: [{ role: 'assistant', content: 'Estoy listo para redactar textos que vendan. ¿Para qué necesitas este copy? (ej: Anuncio de Facebook, Post de Venta, Descripción de Producto)' }] },
                    'post-ideas': { title: "Lluvia de Ideas", workflow: 'post-ideas', initialMessages: [{ role: 'assistant', content: '¡Acabemos con el bloqueo creativo! Dime un tema y te daré 7 ideas de contenido excelentes.' }] },
                    'brand-strategy': { title: "Estratega de Marca", workflow: 'brand-strategy', initialMessages: [{ role: 'assistant', content: 'Definamos el corazón de tu marca. ¿Cuál es el nombre de tu negocio y a qué se dedica?' }] },
                    'competitor-analysis': { title: "Análisis de Competencia", workflow: 'competitor-analysis', model: 'sonar', initialMessages: [{ role: 'assistant', content: "Estoy listo para analizar a tu competencia usando el buscador web. Por favor, pega la URL (dirección web) de la página que quieres que investigue para entregarte un análisis DAFO simplificado." }] },
                    'buyer-persona': { title: "Creación de Cliente Ideal", workflow: 'buyer-persona', initialMessages: [{ role: 'assistant', content: "Vamos a definir a tu cliente ideal (Buyer Persona). Describe tu producto o servicio, y te haré preguntas para construir el perfil detallado paso a paso." }] },
                    'brand-names': { title: "Nombres para Marca", workflow: 'brand-names', initialMessages: [{ role: 'assistant', content: "¡Excelente! Busquemos un nombre increíble. Describe brevemente tu idea de negocio, tu público y el estilo que buscas (ej. moderno, clásico, divertido) para generar nombres y slogans." }] },
                    'sales-assistant': { title: "Asistente de Ventas", workflow: 'sales-assistant', initialMessages: [{ role: 'assistant', content: 'Para ayudarte a cerrar esa venta, pega aquí el mensaje de tu cliente.' }] },
                    'email-writing': { title: "Redactor de Emails", workflow: 'email-writing', initialMessages: [{ role: 'assistant', content: 'Creemos un email que convierta. ¿Cuál es el objetivo principal de este correo?' }] },
                    'english-teacher-translate': { title: "English Translator", workflow: 'english-teacher-translate', initialMessages: [{ role: 'assistant', content: 'Of course! Please provide the text you want me to translate or correct.' }] },
                    'english-teacher-vocabulary': { title: "Vocabulary Builder", workflow: 'english-teacher-vocabulary', initialMessages: [{ role: 'assistant', content: 'Excellent! Let\'s learn some new vocabulary. What topic are you interested in? (e.g., "business negotiations", "travel")' }] },
                    'english-teacher-practice': { title: "Conversation Practice", workflow: 'english-teacher-practice', initialMessages: [{ role: 'assistant', content: 'Great! Let\'s practice our conversation. So, tell me about your day.' }] },
                    'design-web': { title: "Diseñador Web", workflow: 'design-web', model: 'gpt-4o-mini', initialMessages: [{ role: 'assistant', content: 'Estoy listo para diseñar con código. Describe la página o componente que quieres crear, y lo programaré para ti.' }] },
                };

                document.querySelectorAll('[data-workflow]').forEach(button => {
                    button.addEventListener('click', () => {
                        const workflowKey = button.dataset.workflow;
                        const config = workflowConfigs[workflowKey];
                        if (config) {
                            createNewChat({
                                title: config.title,
                                workflow: config.workflow,
                                model: config.model,
                                initialMessages: config.initialMessages
                            });
                        }
                    });
                });
                
                dom.workflowsContainer.addEventListener('click', e => { const header = e.target.closest('.workflow-header'); if (header) { const category = header.closest('.workflow-category'); if (category) category.classList.toggle('open'); } });
                dom.webLaunchOfferBtn.addEventListener('click', () => { const offerTitle = `<i class="fas fa-gift mr-2"></i>Tu Oferta de Lanzamiento Exclusiva`; const offerMessage = `<p class="font-bold mb-2">Al suscribirte a nuestro Plan Pro por $17/mes, desbloqueas:</p><ul class="list-disc list-inside space-y-2 text-left"><li><strong>Acceso Ilimitado a Goatify AI:</strong> Todos los modelos y workflows sin restricciones.</li><li><strong>Construcción de tu Página Web Profesional:</strong> Nosotros construiremos la primera versión, ¡gratis!</li></ul><p class="font-bold mt-4 mb-2">¿Cómo funciona?</p><ol class="list-decimal list-inside space-y-1 text-left"><li><strong>Agenda tu Sesión Estratégica:</strong> Al confirmar, agenda tu llamada de 20 min.</li><li><strong>Co-creación:</b> En la llamada definiremos objetivos y crearemos el borrador con IA.</li><li><strong>Entrega:</strong> Nuestro equipo lo pulirá y te entregará una web de una sección, lista.</li></ol><p class="text-xs mt-4 italic"><strong>Importante:</strong> La web es tuya para siempre. Para mantenerla online con nuestro hosting, necesitas tu suscripción Pro activa. Si cancelas, te entregamos el código completo.</p>`; showModal({ title: offerTitle, message: offerMessage, confirmText: 'Agendar Sesión Estratégica' }).then(confirmed => { if (confirmed) { window.open('https://calendly.com/goatify', '_blank'); } }); });
                dom.freeGuidesLink.addEventListener('click', (e) => { e.preventDefault(); const isPaidUser = currentUser && currentUser.app_metadata?.plan && currentUser.app_metadata.plan !== 'free'; if (isPaidUser) { window.open('https://goatify.app/guiasIA', '_blank'); } else { const title = 'Acceso Exclusivo para Suscriptores'; const message = 'Estas guías se actualizan semanalmente con estrategias de negocio que te ayudarán a crecer un montón. Son un beneficio exclusivo para nuestros suscriptores. ¡Únete a un plan para desbloquearlas!'; showModal({ title, message, confirmText: 'Ver Planes' }).then(confirmed => { if (confirmed) { showPricingModal(); } }); } });
                dom.closeHtmlPreviewModalBtn?.addEventListener('click', () => { dom.htmlPreviewModal.classList.add('hidden'); dom.htmlPreviewModal.classList.remove('flex'); });
                dom.voiceSelector?.addEventListener('change', (e) => { selectedVoice = availableVoices.find(voice => voice.name === e.target.value); });
                dom.servicesMenuBtn?.addEventListener('click', (e) => { e.stopPropagation(); const menu = dom.servicesMenu; const isHidden = menu.classList.contains('opacity-0'); if (isHidden) { menu.classList.remove('opacity-0', 'scale-95', '-translate-y-2', 'pointer-events-none'); } else { menu.classList.add('opacity-0', 'scale-95', '-translate-y-2', 'pointer-events-none'); } });
                document.addEventListener('click', (e) => { if (dom.userMenuBtn && dom.userMenuPopup && !dom.userMenuBtn.contains(e.target) && !dom.userMenuPopup.contains(e.target)) { dom.userMenuPopup.classList.add('hidden'); } if (dom.servicesMenu && !dom.servicesMenu.classList.contains('opacity-0') && !dom.servicesMenuBtn.contains(e.target) && !dom.servicesMenu.contains(e.target)) { dom.servicesMenu.classList.add('opacity-0', 'scale-95', '-translate-y-2', 'pointer-events-none'); } if (dom.sidebar && window.innerWidth < 768 && !dom.sidebar.contains(e.target) && dom.sidebar.classList.contains('is-open')) { toggleSidebar(false); } });
                const setAppHeight = () => { const app = document.getElementById('app-container'); if(app) app.style.height = `${window.innerHeight}px`; };
                setAppHeight();
                window.addEventListener('resize', setAppHeight);
                dom.selectChatsBtn?.addEventListener('click', () => toggleSelectMode(true));
                dom.cancelSelectModeBtn?.addEventListener('click', () => toggleSelectMode(false));
                dom.deleteSelectedBtn?.addEventListener('click', async () => { if (chatsToDelete.size === 0) return; const confirm = await showModal({ title: `Eliminar ${chatsToDelete.size} chat(s)`, message: 'Esta acción es irreversible. ¿Confirmas la eliminación?', confirmText: 'Eliminar' }); if (confirm) { chatsToDelete.forEach(id => { state.structure = state.structure.filter(i => i !== id); delete state.chats[id]; Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(cid => cid !== id) }); if (currentChatId === id) resetChatView(); }); saveState(); toggleSelectMode(false); } hideModal(); });

                dom.settingsBtn?.addEventListener('click', showSettingsModal);
                dom.closeSettingsModal?.addEventListener('click', hideSettingsModal);
                dom.settingsUpgradePlanBtn?.addEventListener('click', () => { hideSettingsModal(); showPricingModal(); });
                dom.fontSizeSlider?.addEventListener('input', (e) => {
                    const fontSize = e.target.value;
                    document.body.style.setProperty('--base-font-size', `${fontSize}px`);
                    dom.fontSizeValue.textContent = `${fontSize}px`;
                });
                dom.settingsThemeToggle?.addEventListener('click', () => {
                    setTheme(!document.body.classList.contains('dark-theme'));
                });
                dom.languageSelector?.addEventListener('change', (e) => {
                    setLanguage(e.target.value);
                });
                dom.connectWhatsappBtn?.addEventListener('click', () => {
                    window.open('https://wa.me/17439106116?text=Hola%2C%20me%20gustar%C3%ADa%20conectar%20mi%20cuenta%20de%20Goatify%20AI%20a%20WhatsApp.', '_blank');
                });
                dom.freePlanBtn?.addEventListener('click', (e) => {
                    if (!e.target.disabled) {
                        hidePricingModal();
                    }
                });
            }
            
            function initApp() {
                const savedLang = localStorage.getItem('goatify-lang') || 'es';
                setLanguage(savedLang);

                setTheme(localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches));
                const unlockAudio = () => {
                    const silence = new SpeechSynthesisUtterance('');
                    silence.volume = 0;
                    window.speechSynthesis.speak(silence);
                    document.body.removeEventListener('touchstart', unlockAudio);
                    document.body.removeEventListener('click', unlockAudio);
                };
                document.body.addEventListener('touchstart', unlockAudio, { once: true });
                document.body.addEventListener('click', unlockAudio, { once: true });
                let initFired = false;
                const finishInitialization = (user) => {
                    if (initFired) return;
                    initFired = true;
                    currentUser = user;
                    updateUserUI();
                    loadStateForUser();
                    updateModelSelectorState();
                    updateContextualFooter(null);
                    dom.appContainer.classList.remove('opacity-0');
                    dom.loadingOverlay.style.display = 'none';
                };
                netlifyIdentity.on('init', (user) => finishInitialization(user));
                setTimeout(() => { if (!initFired) { finishInitialization(netlifyIdentity.currentUser()); } }, 1500);
                netlifyIdentity.on('login', (user) => {
                    netlifyIdentity.close(); 
                    currentUser = user;
                    updateUserUI(); 
                    loadStateForUser();
                });
                netlifyIdentity.on('logout', () => { 
                    currentUser = null; 
                    updateUserUI(); 
                    loadStateForUser(); 
                    resetChatView();
                });
                populateVoiceList();
                setupEventListeners();
                updateModelSelectorState();
            }
            initApp();
        });
    </script></body></html>
