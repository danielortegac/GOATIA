<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GOATBOT Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
    </script>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <style>
        :root {
            --bg-dark: #121212; --bg-medium: #1e1e1e; --bg-light: #2c2c2c; --primary: #8a4fff; --primary-hover: #7b46e6; --text-light: #e0e0e0; --text-medium: #b3b3b3; --border-color: #3a3a3a;
            --light-bg-dark: #f7f7f8; --light-bg-medium: #ffffff; --light-bg-light: #f0f0f0; --light-primary: #7c40e6; --light-primary-hover: #6a37d3; --light-text-dark: #1f2937; --light-text-medium: #6b7280; --light-border-color: #e5e7eb;
        }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; font-size: 16px; }
        .dark-theme { --current-bg-dark: var(--bg-dark); --current-bg-medium: var(--bg-medium); --current-bg-light: var(--bg-light); --current-primary: var(--primary); --current-primary-hover: var(--primary-hover); --current-text-light: var(--text-light); --current-text-medium: var(--text-medium); --current-border-color: var(--border-color); background-color: var(--current-bg-dark); color: var(--text-light); }
        .light-theme { --current-bg-dark: var(--light-bg-dark); --current-bg-medium: var(--light-bg-medium); --current-bg-light: var(--light-bg-light); --current-primary: var(--light-primary); --current-primary-hover: var(--light-primary-hover); --current-text-light: var(--light-text-dark); --current-text-medium: var(--light-text-medium); --current-border-color: var(--light-border-color); background-color: var(--light-bg-dark); color: var(--light-text-dark); }
        #sidebar { background-color: var(--current-bg-dark); border-right: 1px solid var(--current-border-color); }
        #main-chat-area, .modal-content { background-color: var(--current-bg-medium); }
        .chat-bubble-bot, .bg-input, #pdf-preview-container, .chat-item, .project-header, #user-menu-popup { background-color: var(--current-bg-light); }
        .border-themed { border-color: var(--current-border-color); }
        .chat-bubble-user { background-color: var(--current-primary); color: white; }
        .btn-primary { background-color: var(--current-primary); color: white; }
        .btn-primary:hover { background-color: var(--current-primary-hover); }
        .plan-card-highlight { border-color: var(--current-primary); box-shadow: 0 0 15px rgba(138, 79, 255, 0.3); }
        .placeholder-themed::placeholder { color: var(--current-text-medium); }
        .text-primary { color: var(--current-primary); }
        .glowing-mic { animation: pulse 1.5s infinite; color: var(--primary) !important; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(138, 79, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0); } }
        .project .project-content { display: none; }
        .project.open .project-content { display: block; }
        .project.open .project-arrow { transform: rotate(90deg); }
        .project-header.drag-over { background-color: var(--current-primary); }
        .code-block { background-color: #0d1117; border: 1px solid var(--current-border-color); border-radius: 0.5rem; overflow: hidden; margin-top: 1rem; }
        .code-block-header { display: flex; align-items: center; justify-content: space-between; background-color: #161b22; padding: 0.5rem 1rem; font-size: 0.8rem; color: var(--text-medium); }
        .code-block-header span { font-family: monospace; }
        .code-block-header button { background-color: transparent; border: none; color: var(--text-medium); cursor: pointer; padding: 0.25rem; border-radius: 0.25rem; }
        .code-block-header button:hover { background-color: rgba(255, 255, 255, 0.1); }
        .code-block-body { padding: 1rem; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.875rem; white-space: pre-wrap; color: var(--text-light); }
        #sidebar.is-open { transform: translateX(0); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        #app-container { height: 100vh; height: -webkit-fill-available; }
        #pricing-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .chat-item.selected-for-delete { background-color: var(--primary) !important; color: white; }
    </style>
</head>
<body class="w-screen overflow-x-hidden dark-theme">

    <div id="loading-overlay" class="fixed inset-0 bg-bg-dark bg-opacity-95 flex flex-col items-center justify-center z-[100] transition-opacity duration-300">
        <img src="./logo-goatify-header.png" alt="GOATIFY Logo" class="w-24 h-24 object-contain mb-6 animate-pulse" onerror="this.onerror=null;this.src='https://placehold.co/96x96/121212/e0e0e0?text=LOGO';">
        <div class="text-text-light text-center">
             <i class="fas fa-spinner fa-spin fa-2x"></i>
             <p class="mt-3 text-lg font-semibold">Inicializando...</p>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden opacity-0 pointer-events-none"></div>

    <div id="app-container" class="flex w-full relative opacity-0 transition-opacity duration-300">
        <aside id="sidebar" class="w-72 flex-shrink-0 flex flex-col p-3 transition-transform duration-300 -translate-x-full md:translate-x-0 absolute md:relative z-30 h-full">
            <div class="flex-shrink-0">
                <div id="logo-space" class="w-24 h-24 rounded-lg mx-auto mb-4 flex items-center justify-center overflow-hidden bg-input">
                    <img src="./logo-goatify-header.png" alt="GOATIFY Logo" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                </div>
                <div class="flex flex-col space-y-2 mb-4">
                    <button id="new-chat-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-plus mr-2"></i><span>Nuevo Chat</span></button>
                    <button id="new-project-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg bg-input"><i class="fas fa-folder-plus mr-2"></i><span>Nuevo Proyecto</span></button>
                    <button id="upgrade-plan-btn" class="hidden flex items-center justify-center font-semibold p-3 rounded-lg bg-yellow-500 text-black hover:bg-yellow-400"><i class="fas fa-rocket mr-2"></i><span>Mejorar Plan</span></button>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto min-h-0">
                <div class="border-t border-b border-themed my-3 py-3">
                    <div class="flex justify-between items-center mb-2 px-2">
                        <h3 class="text-xs font-semibold uppercase text-text-medium">Workflows</h3>
                        <div id="multi-select-controls">
                            <button id="select-chats-btn" title="Seleccionar M√∫ltiples Chats" class="p-2 rounded-lg hover:bg-light"><i class="fas fa-tasks text-sm"></i></button>
                        </div>
                    </div>
                    <div id="delete-mode-controls" class="hidden flex space-x-2 mb-2 px-2">
                        <button id="delete-selected-btn" class="flex-1 flex items-center justify-center font-semibold p-2 rounded-lg bg-red-600 text-white disabled:opacity-50" disabled><i class="fas fa-trash-alt mr-2"></i><span>Borrar</span></button>
                        <button id="cancel-select-mode-btn" class="p-2 rounded-lg bg-gray-600 text-white"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="space-y-1">
                        <button id="copywriting-workflow-btn" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center"><i class="fas fa-pencil-alt w-6 mr-2"></i>Copywriting</button>
                        <button id="sales-response-workflow-btn" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center"><i class="fas fa-handshake w-6 mr-2"></i>Respuestas de Ventas</button>
                        <button id="web-page-workflow-btn" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center"><i class="fas fa-code w-6 mr-2"></i>P√°gina Web</button>
                        <button id="english-teacher-workflow-btn" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center"><i class="fas fa-language w-6 mr-2"></i>English Teacher</button>
                    </div>
                </div>
                <div id="sidebar-content" class="pr-1 space-y-1"></div>
            </div>

            <div id="user-section" class="flex-shrink-0 border-t border-themed mt-2 pt-3">
                <div id="login-view" class="hidden">
                    <button id="login-btn" class="w-full flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-sign-in-alt mr-2"></i><span>Iniciar Sesi√≥n</span></button>
                </div>
                <div id="user-menu-view" class="hidden relative">
                    <button id="user-menu-btn" class="w-full flex items-center text-left p-2 rounded-lg hover:bg-light transition-colors">
                        <span id="user-email" class="flex-grow truncate text-sm font-semibold"></span>
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <div id="user-menu-popup" class="absolute bottom-full left-0 w-full mb-2 rounded-lg p-2 border border-themed shadow-lg hidden">
                        <button id="logout-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-sign-out-alt w-6 mr-2"></i>Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </div>
        </aside>

        <main id="main-chat-area" class="flex-1 flex flex-col h-full overflow-hidden">
           <header class="flex items-center justify-between p-2 md:p-4 border-b border-themed flex-shrink-0">
                <button id="menu-toggle" class="md:hidden text-xl p-2"><i class="fas fa-bars"></i></button>
                <h1 id="chat-title" class="text-lg font-semibold truncate cursor-pointer mx-2 flex-1 min-w-0" title="Renombrar Chat">GOATBOT Pro</h1>
                <div class="flex items-center space-x-1 sm:space-x-2 flex-shrink-0">
                    <div id="voice-selector-container" class="hidden sm:flex items-center space-x-2">
                        <select id="voice-selector" class="rounded-md p-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-purple-500 bg-input text-text-light border border-themed"></select>
                    </div>
                    <div id="message-counter" class="text-xs font-mono whitespace-nowrap"></div>
                    <button id="ttsToggle" title="Activar/Desactivar Voz" class="text-xl hover:opacity-80 transition-colors p-2 text-text-medium"><i class="fa fa-volume-mute"></i></button>
                    <button id="theme-toggle" title="Cambiar Tema" class="text-xl p-2"><i class="fas fa-moon" id="theme-icon"></i></button>
                </div>
            </header>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-3 sm:p-6">
                <div class="flex justify-center items-center h-full" id="initial-message-container">
                    <div id="welcome-message-wrapper" class="text-center text-text-medium">
                        <img src="./logo-goatify-header.png" alt="GOATIFY Logo" class="w-24 h-24 object-contain mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                        <div id="personalized-welcome" class="hidden">
                            <h2 class="text-2xl font-bold">¬°Hola, <span id="user-name"></span>!</h2>
                            <p class="text-lg mt-1">Hoy es un gran d√≠a. ¬°Puedes con todo!</p>
                        </div>
                        <div id="generic-welcome" class="hidden">
                            <p class="text-xl">¬øC√≥mo puedo ayudarte hoy?</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="input-area" class="p-2 sm:p-4 border-t border-themed flex-shrink-0">
                <div id="file-preview-area" class="mb-3 space-y-2 px-1 sm:px-0">
                    <div id="image-preview-container" class="hidden relative w-24 h-24 sm:w-32 sm:h-32 rounded-lg overflow-hidden border border-themed">
                        <img id="image-preview" src="#" alt="Image Preview" class="w-full h-full object-contain">
                        <button id="clear-image-btn" class="absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs z-10"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="pdf-preview-container" class="hidden relative p-3 rounded-lg border-themed">
                         <div class="flex items-center"><i class="fas fa-file-pdf text-red-500 text-3xl mr-4 flex-shrink-0"></i><div class="flex-grow min-w-0"><p id="pdf-name" class="text-sm font-medium truncate"></p><p id="pdf-status" class="text-xs font-mono"></p></div></div><button id="clear-pdf-btn" class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs z-10"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="flex items-center space-x-3 mb-3 px-1 sm:px-2">
                    <label for="model-selector" class="font-medium text-sm text-text-medium">Modelo:</label>
                    <select id="model-selector" class="rounded-md p-1.5 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm bg-input text-text-light border border-themed">
                        <option value="gpt-3.5-turbo-1106">Chat General (Turbo)</option>
                        <option value="gpt-4o">An√°lisis Premium (Archivos)</option>
                        <option value="sonar">B√∫squeda Web (Sonar)</option>
                    </select>
                </div>
                <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2">
                    <button id="image-gen-btn" title="Crear Imagen" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fas fa-paint-brush text-xl"></i></button>
                    <button id="pdf-upload-btn" title="Subir PDF" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-file-pdf text-xl"></i></button>
                    <button id="image-upload-btn" title="Subir Imagen" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-image text-xl"></i></button>
                    <button id="web-search-btn" title="Activar B√∫squeda Web" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-globe text-xl"></i></button>
                    <button id="voice" title="Hablar" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-microphone text-xl"></i></button>
                    <textarea id="msg" placeholder="Escribe tu mensaje..." class="flex-1 bg-transparent p-2 h-12 resize-none outline-none placeholder-themed" rows="1"></textarea>
                    <button id="send" title="Enviar" class="p-2 sm:p-4 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i id="send-icon" class="fa fa-paper-plane text-xl"></i></button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-sm p-6 relative">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3><p id="modal-message" class="mb-4 text-text-medium"></p>
            <input type="text" id="modal-input" class="w-full p-2 rounded mb-4 hidden bg-input border border-themed" placeholder="">
            <div class="flex justify-end space-x-2">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded">Cancelar</button><button id="modal-confirm" class="px-4 py-2 rounded text-white btn-primary">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="pricing-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-6">
                 <h2 class="text-3xl md:text-4xl font-extrabold text-center flex-grow">Elige tu Plan</h2>
                 <button id="close-pricing-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="modal-content-body flex-grow overflow-y-auto">
                 <p class="text-lg text-text-medium text-center mb-8">Desbloquea todo el potencial de Goatify.</p>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col"><h3 class="text-2xl font-bold">Free Ride</h3><p class="text-4xl font-extrabold my-4">$0<span class="text-lg font-medium text-text-medium"> / mes</span></p><ul class="space-y-3 text-sm flex-grow mb-6"><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>15 cr√©ditos / mes</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Organizaci√≥n por Proyectos</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Acceso a Workflows</li><li class="flex items-center"><i class="fas fa-times-circle text-red-500 mr-2"></i>Soporte prioritario</li></ul><button class="mt-auto w-full p-3 rounded-lg font-semibold bg-input cursor-default">Tu Plan Actual</button></div>
                    <div class="plan-card border-2 rounded-xl p-6 flex flex-col plan-card-highlight relative"><span class="absolute -top-3.5 left-1/2 -translate-x-1/2 bg-primary text-white text-xs font-bold px-3 py-1 rounded-full">M√ÅS POPULAR</span><h3 class="text-2xl font-bold">GoatBoost</h3><p class="text-4xl font-extrabold my-4">$7<span class="text-lg font-medium text-text-medium"> / mes</span></p><ul class="space-y-3 text-sm flex-grow mb-6"><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>300 cr√©ditos / mes</li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Workflows Pro</li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Modelo Web Pro (GPT-4o)</li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Hist√≥rico ilimitado</li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Soporte v√≠a email</li></ul><button data-plan="boost" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors">Seleccionar Plan</button></div>
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col"><h3 class="text-2xl font-bold">GoatForce Pro</h3><p class="text-4xl font-extrabold my-4">$17<span class="text-lg font-medium text-text-medium"> / mes</span></p><ul class="space-y-3 text-sm flex-grow mb-6"><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>3,000 cr√©ditos / mes</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Acceso a todos los modelos</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>API key propia (Opcional)</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Webinars mensuales</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Comunidad privada</li></ul><button data-plan="pro" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors">Seleccionar Plan</button></div>
                 </div>
            </div>
        </div>
    </div>
    <div id="html-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full h-full max-w-4xl p-2 md:p-4 relative flex flex-col">
            <div class="flex-shrink-0 flex items-center justify-between mb-2">
                <h3 class="text-lg font-bold">Vista Previa</h3>
                <button id="close-html-preview-modal" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <iframe id="html-preview-iframe" class="w-full flex-grow h-full border-2 border-themed rounded-lg bg-white"></iframe>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        window.addEventListener('DOMContentLoaded', () => {
            
            const GUEST_CREDIT_LIMIT = 5;
            const FREE_PLAN_CREDIT_LIMIT = 15;
            const COSTS = { WEB_PAGE: 2, COPYWRITING: 2, SALES_RESPONSE: 2, NEBULA: 2, GENERAL: 1, SEARCH: 1, ENGLISH_TEACHER: 1, IMAGE: 5 };
            let state = { chats: {}, projects: {}, structure: [] };
            let currentChatId = null, currentUser = null, speechOn = false, availableVoices = [], selectedVoice = null, isRecognizing = false, selectedImageBase64 = null, selectedPdfText = null, isWebSearchMode = false;
            let micWasOnBeforeSpeaking = false;
            let modalResolve = null;
            let isSelectModeActive = false;
            let chatsToDelete = new Set();

            const dom = {
                appContainer: document.getElementById('app-container'),
                msgInput: document.getElementById('msg'), sendBtn: document.getElementById('send'),
                messageCounterEl: document.getElementById('message-counter'), upgradePlanBtn: document.getElementById('upgrade-plan-btn'),
                newChatBtn: document.getElementById('new-chat-btn'), newProjectBtn: document.getElementById('new-project-btn'),
                pricingModal: document.getElementById('pricing-modal'), closePricingModalBtn: document.getElementById('close-pricing-modal'),
                genericModal: document.getElementById('generic-modal'), chatMessages: document.getElementById('chat-messages'),
                chatTitle: document.getElementById('chat-title'), initialMessageContainer: document.getElementById('initial-message-container'),
                themeToggle: document.getElementById('theme-toggle'), themeIcon: document.getElementById('theme-icon'),
                voiceBtn: document.getElementById('voice'), ttsToggle: document.getElementById('ttsToggle'),
                modelSelector: document.getElementById('model-selector'),
                imageUploadBtn: document.getElementById('image-upload-btn'), imageUploadInput: document.getElementById('image-upload'),
                imagePreviewContainer: document.getElementById('image-preview-container'), imagePreview: document.getElementById('image-preview'),
                clearImageBtn: document.getElementById('clear-image-btn'),
                pdfUploadBtn: document.getElementById('pdf-upload-btn'), pdfUploadInput: document.getElementById('pdf-upload'),
                pdfPreviewContainer: document.getElementById('pdf-preview-container'), pdfNameEl: document.getElementById('pdf-name'),
                pdfStatusEl: document.getElementById('pdf-status'), clearPdfBtn: document.getElementById('clear-pdf-btn'),
                sidebar: document.getElementById('sidebar'), menuToggle: document.getElementById('menu-toggle'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarContent: document.getElementById('sidebar-content'),
                loginView: document.getElementById('login-view'), userMenuView: document.getElementById('user-menu-view'),
                loginBtn: document.getElementById('login-btn'), userMenuBtn: document.getElementById('user-menu-btn'),
                userMenuPopup: document.getElementById('user-menu-popup'), userEmail: document.getElementById('user-email'),
                logoutBtn: document.getElementById('logout-btn'),
                copywritingWorkflowBtn: document.getElementById('copywriting-workflow-btn'),
                salesResponseWorkflowBtn: document.getElementById('sales-response-workflow-btn'),
                webPageWorkflowBtn: document.getElementById('web-page-workflow-btn'),
                englishTeacherWorkflowBtn: document.getElementById('english-teacher-workflow-btn'),
                personalizedWelcome: document.getElementById('personalized-welcome'),
                genericWelcome: document.getElementById('generic-welcome'),
                userName: document.getElementById('user-name'),
                loadingOverlay: document.getElementById('loading-overlay'),
                htmlPreviewModal: document.getElementById('html-preview-modal'),
                closeHtmlPreviewModalBtn: document.getElementById('close-html-preview-modal'),
                htmlPreviewIframe: document.getElementById('html-preview-iframe'),
                voiceSelector: document.getElementById('voice-selector'),
                webSearchBtn: document.getElementById('web-search-btn'),
                selectChatsBtn: document.getElementById('select-chats-btn'),
                deleteModeControls: document.getElementById('delete-mode-controls'),
                deleteSelectedBtn: document.getElementById('delete-selected-btn'),
                cancelSelectModeBtn: document.getElementById('cancel-select-mode-btn'),
                imageGenBtn: document.getElementById('image-gen-btn'),
            };
            
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            function showModal({ title, message, useInput = false, placeholder = '', confirmText = 'Confirmar' }) {
                const modalTitle = dom.genericModal.querySelector('#modal-title'), modalMessage = dom.genericModal.querySelector('#modal-message'), modalInput = dom.genericModal.querySelector('#modal-input'), modalConfirm = dom.genericModal.querySelector('#modal-confirm');
                modalTitle.textContent = title; modalMessage.textContent = message; modalMessage.style.display = message ? 'block' : 'none'; modalInput.style.display = useInput ? 'block' : 'none'; modalInput.value = ''; modalInput.placeholder = placeholder; modalConfirm.textContent = confirmText;
                dom.genericModal.classList.remove('hidden'); dom.genericModal.classList.add('flex');
                if (useInput) modalInput.focus();
                return new Promise(resolve => { modalResolve = resolve; });
            }
            function hideModal(resolveWith = null) { if(modalResolve) { modalResolve(resolveWith); modalResolve = null; } dom.genericModal.classList.add('hidden'); dom.genericModal.classList.remove('flex');  }
            
            function showPricingModal() { dom.pricingModal.classList.remove('hidden'); dom.pricingModal.classList.add('flex'); setTimeout(() => { dom.pricingModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10); }
            function hidePricingModal() { dom.pricingModal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => { dom.pricingModal.classList.add('hidden'); dom.pricingModal.classList.remove('flex'); }, 300); }

            function speak(text) { 
                if (!speechOn || !('speechSynthesis' in window) || !text) return; 
                speechSynthesis.cancel();
                micWasOnBeforeSpeaking = isRecognizing;
                if (isRecognizing) {
                    recognition.stop();
                }
                const cleanText = text.replace(/[*_`#~[\]()üîç]|(-{3,})|(\*\*Fuente:\*\*.*)/g, ''); 
                const utterance = new SpeechSynthesisUtterance(cleanText); 
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }
                utterance.rate = 1.15;
                utterance.onend = () => {
                    if (micWasOnBeforeSpeaking) {
                        if (recognition && !isRecognizing) {
                            try { recognition.start(); } catch(e) { console.error("Error restarting recognition:", e); }
                        }
                        micWasOnBeforeSpeaking = false;
                    }
                };
                utterance.onerror = (e) => {
                    console.error('Speech synthesis error:', e);
                     if (micWasOnBeforeSpeaking) {
                        if (recognition && !isRecognizing) {
                           try { recognition.start(); } catch(e) { console.error("Error restarting recognition on error:", e); }
                        }
                        micWasOnBeforeSpeaking = false;
                    }
                }
                speechSynthesis.speak(utterance); 
            }

            function populateVoiceList() {
                const voiceContainer = dom.voiceSelector.parentElement;
                const setVoices = () => {
                    if (typeof speechSynthesis === 'undefined') {
                        voiceContainer.style.display = 'none';
                        return;
                    }
                    const allVoices = speechSynthesis.getVoices();
                    const preferredVoices = [ "Microsoft Sabina Online (Natural) - Spanish (Mexico)", "Paulina", "Google espa√±ol de Estados Unidos", "Google espa√±ol" ];
                    availableVoices = allVoices.filter(v => v.lang.startsWith('es-') && !v.lang.startsWith('es-ES'));
                    if (availableVoices.length === 0) {
                        availableVoices = allVoices.filter(v => v.lang.startsWith('es-'));
                    }
                    availableVoices.sort((a, b) => {
                        let aIdx = preferredVoices.indexOf(a.name); let bIdx = preferredVoices.indexOf(b.name);
                        if (aIdx === -1) aIdx = Infinity; if (bIdx === -1) bIdx = Infinity;
                        if (aIdx !== bIdx) return aIdx - bIdx;
                        return a.name.localeCompare(b.name);
                    });
                    dom.voiceSelector.innerHTML = '';
                    if(availableVoices.length > 0) {
                         voiceContainer.classList.remove('hidden');
                         voiceContainer.classList.add('sm:flex');
                         dom.voiceSelector.disabled = false;
                        availableVoices.forEach(voice => {
                            const option = document.createElement('option');
                            const displayName = voice.name.replace('Microsoft', '').replace('Online (Natural) -', '').replace('Google', '').replace('Spanish (Mexico)','Mex').trim();
                            option.textContent = displayName || voice.lang;
                            option.value = voice.name;
                            dom.voiceSelector.appendChild(option);
                        });
                        selectedVoice = availableVoices[0];
                        if (selectedVoice) dom.voiceSelector.value = selectedVoice.name;
                    } else {
                        voiceContainer.style.display = 'none';
                    }
                }
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = setVoices;
                }
                setTimeout(setVoices, 200);
            }
            
            function getModelForRequest(workflow, hasFile) {
                if (workflow === "web-page") return "gpt-4-turbo";
                if (workflow === "copywriting" || workflow === "sales-response") return "gpt-4o";
                if (hasFile) return "gpt-4o";
                
                const selectedModel = dom.modelSelector.value;
                if (selectedModel === 'sonar') return 'sonar';
                if (selectedModel === 'gpt-4o') return 'gpt-4o';
                return 'gpt-3.5-turbo-1106';
            }

            async function getAIResponse(prompt, history, image, pdf, model, workflow, userName) {
                const token = currentUser ? await currentUser.jwt() : null;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minutes timeout
                const name = (userName || '').split(' ')[0];
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }
                const body = { 
                    prompt, history, model,
                    imageData: image, pdfText: pdf, 
                    workflow, userName: name, title,
                    includeLinks: model === 'sonar'
                };
                try {
                    const response = await fetch('/.netlify/functions/get-ai-response', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...(token && { 'Authorization': `Bearer ${token}` }) },
                        body: JSON.stringify(body),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    if (response.status === 403) { return { error: 'LIMIT_REACHED' }; }
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({details: 'Error desconocido en el servidor'}));
                        console.error("Backend Error:", errorData);
                        throw new Error(errorData.details || `Error del servidor: ${response.status}.`);
                    }
                    return await response.json();
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('La solicitud tard√≥ demasiado y fue cancelada. Por favor, intenta de nuevo.');
                    }
                    throw error;
                }
            }
            
            function getCreditCount() {
                if (currentUser) {
                    const credits = localStorage.getItem(`userCredits_${currentUser.id}`);
                    return credits === null ? FREE_PLAN_CREDIT_LIMIT : parseInt(credits, 10);
                } else {
                    const credits = localStorage.getItem('guestCreditCount');
                    return credits === null ? GUEST_CREDIT_LIMIT : parseInt(credits, 10);
                }
            }
            
            function setCreditCount(newCount) {
                const count = Math.max(0, newCount);
                if (currentUser) {
                    localStorage.setItem(`userCredits_${currentUser.id}`, count);
                } else {
                    localStorage.setItem('guestCreditCount', count);
                }
                updateCreditCounter();
            }

            function loadStateForUser() {
                const key = currentUser ? `goatbotState_${currentUser.id}` : 'guestState';
                const saved = localStorage.getItem(key);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    state = parsed.state || { chats: {}, projects: {}, structure: [] };
                    currentChatId = parsed.currentChatId;
                } else {
                    state = { chats: {}, projects: {}, structure: [] };
                    currentChatId = null;
                }
                renderSidebar();
                selectChat(currentChatId);
            }

            function saveState() { localStorage.setItem(currentUser ? `goatbotState_${currentUser.id}` : 'guestState', JSON.stringify({ state, currentChatId })); }
            
            function updateUserUI() {
                if (currentUser) {
                    dom.loginView.classList.add('hidden');
                    dom.userMenuView.classList.remove('hidden');
                    dom.genericWelcome.classList.add('hidden');
                    dom.personalizedWelcome.classList.remove('hidden');
                    const userName = currentUser.user_metadata.full_name?.split(' ')[0] || currentUser.email.split('@')[0];
                    dom.userEmail.textContent = currentUser.user_metadata.full_name || currentUser.email;
                    dom.userName.textContent = userName;
                    dom.upgradePlanBtn.classList.toggle('hidden', (currentUser.app_metadata.plan || 'free') !== 'free');
                } else {
                    dom.loginView.classList.remove('hidden');
                    dom.userMenuView.classList.add('hidden');
                    dom.genericWelcome.classList.remove('hidden');
                    dom.personalizedWelcome.classList.add('hidden');
                    dom.upgradePlanBtn.classList.add('hidden');
                }
                updateCreditCounter();
            }

            function updateCreditCounter() {
                const count = getCreditCount();
                const limit = currentUser ? FREE_PLAN_CREDIT_LIMIT : GUEST_CREDIT_LIMIT;
                dom.messageCounterEl.textContent = `${count}/${limit} cr√©ditos`;
            }

            function setTheme(isDark) { 
                document.body.className = 'w-screen overflow-x-hidden';
                document.body.classList.add(isDark ? 'dark-theme' : 'light-theme');
                dom.themeIcon.className = `fas fa-${isDark ? 'sun' : 'moon'}`; 
                localStorage.setItem('theme', isDark ? 'dark' : 'light'); 
            }

            function toggleSidebar(show) {
                if (show) {
                    dom.sidebar.classList.add('is-open');
                    dom.sidebarOverlay.classList.remove('pointer-events-none');
                    dom.sidebarOverlay.classList.add('opacity-50');
                } else {
                    dom.sidebar.classList.remove('is-open');
                    dom.sidebarOverlay.classList.remove('opacity-50');
                    dom.sidebarOverlay.classList.add('pointer-events-none');
                }
            }
            
            function createNewChat(options = {}) {
                const id = 'chat-' + crypto.randomUUID();
                const name = currentUser ? (currentUser.user_metadata.full_name?.split(' ')[0] || 'T√∫') : 'viajero';
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }
                const initialMessages = options.initialMessages || [{ 
                    role: 'assistant', 
                    content: `Saludos, ${title}. Soy un eco del cosmos, aqu√≠ para servirte. Cada idea tuya es una estrella a punto de nacer. ¬øEn qu√© universo nos sumergimos hoy?` 
                }];
                state.chats[id] = { 
                    id, 
                    title: options.title || "Conversaci√≥n C√≥smica", 
                    messages: initialMessages,
                    workflow: options.workflow || null,
                    model: options.model || 'gpt-3.5-turbo-1106'
                }; 
                state.structure.unshift(id); 
                selectChat(id); 
                saveState(); 
                renderSidebar(); 
                dom.modelSelector.value = options.model || 'gpt-3.5-turbo-1106';
                updateWebSearchButtonState();
                if (window.innerWidth < 768) toggleSidebar(false);
                return id; 
            }

            function selectChat(chatId) { 
                if (isSelectModeActive) return;
                if (!chatId || !state.chats[chatId]) { 
                    resetChatView(); 
                    return; 
                } 
                currentChatId = chatId; 
                dom.initialMessageContainer.style.display = 'none'; 
                dom.chatMessages.innerHTML = ''; 
                const chat = state.chats[chatId]; 
                dom.chatTitle.textContent = chat.title; 
                chat.messages.forEach((msg) => addMessageToUI(msg.role, msg.content, msg.image)); 
                dom.modelSelector.value = chat.model || 'gpt-3.5-turbo-1106';
                updateWebSearchButtonState();
                updateActiveChatHighlight(); 
                saveState();
                if (window.innerWidth < 768) toggleSidebar(false);
            }
            function resetChatView() { currentChatId = null; dom.chatTitle.textContent = "GOATBOT Pro"; dom.chatMessages.innerHTML = ''; dom.initialMessageContainer.style.display = 'flex'; updateUserUI(); updateActiveChatHighlight(); dom.modelSelector.value = 'gpt-3.5-turbo-1106'; updateWebSearchButtonState(); }
            
            function renderCodeBlock(content) {
                const codeBlock = document.createElement('div');
                codeBlock.className = 'code-block';
                const header = document.createElement('div');
                header.className = 'code-block-header';
                header.innerHTML = `<span>HTML</span><button title="Copiar c√≥digo"><i class="fas fa-copy"></i></button>`;
                const body = document.createElement('pre');
                body.className = 'code-block-body';
                body.textContent = content;
                header.querySelector('button').addEventListener('click', (e) => {
                    const textarea = document.createElement('textarea');
                    textarea.value = content;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                      document.execCommand('copy');
                      e.currentTarget.innerHTML = '<i class="fas fa-check"></i> ¬°Copiado!';
                    } catch (err) {
                      e.currentTarget.innerHTML = '<i class="fas fa-times"></i> Error';
                    }
                    document.body.removeChild(textarea);
                    setTimeout(() => e.currentTarget.innerHTML = '<i class="fas fa-copy"></i>', 2000);
                });
                codeBlock.append(header, body);
                return codeBlock;
            }

            function addMessageToUI(role, content, imageSrc) {
                const wrapper = document.createElement('div');
                wrapper.className = `chat-bubble-wrapper flex items-start gap-2 my-2 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                const bubble = document.createElement('div');
                bubble.className = `p-3 md:p-4 rounded-xl max-w-lg md:max-w-xl ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot'}`;
                if (imageSrc) {
                    const img = document.createElement('img');
                    img.src = imageSrc;
                    img.className = 'rounded-lg mb-2 max-w-full h-auto';
                    bubble.appendChild(img);
                }
                const contentDiv = document.createElement('div');
                contentDiv.className = 'markdown-content';
                const currentChat = state.chats[currentChatId];
                if (role === 'assistant' && currentChat?.workflow === 'web-page' && /<\/?[a-z][\s\S]*>/i.test(content)) {
                    contentDiv.innerHTML = 'He aqu√≠ el c√≥digo que ha nacido de tu visi√≥n:';
                    contentDiv.appendChild(renderCodeBlock(content));
                } else {
                    contentDiv.innerHTML = content === '‚Ä¶' ? `<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .2s;"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .4s;"></div></div>` : marked.parse(content || "");
                }
                bubble.appendChild(contentDiv);
                if (role === 'assistant' && currentChat?.workflow === 'web-page' && /<\/?[a-z][\s\S]*>/i.test(content)) {
                    const actionsWrapper = document.createElement('div');
                    actionsWrapper.className = 'mt-3 pt-3 border-t border-themed flex items-center gap-2';
                    const previewBtn = document.createElement('button');
                    previewBtn.innerHTML = '<i class="fas fa-eye mr-2"></i>Vista Previa';
                    previewBtn.className = 'text-xs font-semibold py-1 px-2 rounded bg-input hover:bg-opacity-70';
                    previewBtn.onclick = () => {
                        const blob = new Blob([content], { type: 'text/html' });
                        const url = URL.createObjectURL(blob);
                        dom.htmlPreviewIframe.src = url;
                        dom.htmlPreviewModal.classList.remove('hidden');
                        dom.htmlPreviewIframe.onload = () => URL.revokeObjectURL(url);
                    };
                    actionsWrapper.appendChild(previewBtn);
                    bubble.appendChild(actionsWrapper);
                }
                wrapper.appendChild(bubble);
                dom.chatMessages.appendChild(wrapper);
                dom.chatMessages.scrollTop = dom.chatMessages.scrollHeight;
                return bubble;
            }
            
            function updateMessageInUI(bubble, content, imageSrc) {
                 const newBubble = addMessageToUI('assistant', content, imageSrc);
                 if (bubble && bubble.parentElement) {
                     bubble.parentElement.replaceWith(newBubble.parentElement);
                 }
            }

            function renderSidebar() { 
                dom.sidebarContent.innerHTML = ''; 
                const frag = document.createDocumentFragment(); 
                (state.structure || []).forEach(id => { 
                    if (id.startsWith('project-')) {
                        frag.appendChild(createProjectElement(id));
                    } else if (id.startsWith('chat-')) {
                         frag.appendChild(createChatItemElement(id));
                    }
                }); 
                dom.sidebarContent.appendChild(frag); 
                updateActiveChatHighlight(); 
            }
            function createChatItemElement(id, isSubItem = false) { 
                const chat = state.chats[id]; 
                if (!chat) return document.createDocumentFragment(); 
                const item = document.createElement('div'); 
                item.className = `chat-item group flex items-center justify-between p-2 rounded-md cursor-pointer ${isSubItem ? 'pl-5' : ''}`; item.dataset.id = id; 
                if (isSelectModeActive) {
                    item.draggable = false;
                    const isSelected = chatsToDelete.has(id);
                    item.innerHTML = `<i class="far ${isSelected ? 'fa-check-square' : 'fa-square'} mr-2 text-primary"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span>`;
                    if (isSelected) item.classList.add('selected-for-delete');
                    item.addEventListener('click', () => {
                        if (chatsToDelete.has(id)) {
                            chatsToDelete.delete(id);
                            item.querySelector('i').classList.replace('fa-check-square', 'fa-square');
                            item.classList.remove('selected-for-delete');
                        } else {
                            chatsToDelete.add(id);
                            item.querySelector('i').classList.replace('fa-square', 'fa-check-square');
                            item.classList.add('selected-for-delete');
                        }
                        dom.deleteSelectedBtn.disabled = chatsToDelete.size === 0;
                    });
                } else {
                    item.draggable = true;
                    item.innerHTML = `<i class="far fa-comment-dots mr-2"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span><div class="chat-item-actions flex-shrink-0"><button class="rename-btn text-text-medium hover:text-primary p-1"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-text-medium hover:text-red-500 p-1"><i class="fas fa-trash-alt fa-xs"></i></button></div>`; 
                    item.addEventListener('click', e => { if (!e.target.closest('.chat-item-actions')) selectChat(id); }); 
                    item.addEventListener('dragstart', e => handleDragStart(e, id)); item.querySelector('.rename-btn').addEventListener('click', () => renameItem('chat', id)); item.querySelector('.delete-btn').addEventListener('click', () => deleteItem('chat', id));
                }
                return item; 
            }
            function createProjectElement(id) {
                const project = state.projects[id];
                if (!project) return document.createDocumentFragment();
                const div = document.createElement('div'); div.className = 'project'; div.dataset.id = id;
                const header = document.createElement('div'); header.className = 'project-header group flex items-center p-2 rounded-md cursor-pointer';
                header.innerHTML = `<i class="fas fa-chevron-right project-arrow mr-2 transition-transform"></i><i class="fas fa-folder mr-2 text-yellow-500"></i><span class="flex-grow truncate text-sm font-bold">${project.title}</span><div class="chat-item-actions flex-shrink-0"><button class="rename-btn text-text-medium hover:text-primary p-1"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-text-medium hover:text-red-500 p-1"><i class="fas fa-trash-alt fa-xs"></i></button></div>`;
                const content = document.createElement('div'); content.className = 'project-content pl-2 pt-1 space-y-1';
                (project.chatIds || []).forEach(chatId => content.appendChild(createChatItemElement(chatId, true)));
                div.append(header, content);
                header.addEventListener('click', e => { if (!e.target.closest('.chat-item-actions')) div.classList.toggle('open'); });
                header.addEventListener('dragover', e => handleDragOver(e, header));
                header.addEventListener('dragleave', e => handleDragLeave(e, header));
                header.addEventListener('drop', e => handleDrop(e, id, header));
                header.querySelector('.rename-btn').addEventListener('click', () => renameItem('project', id));
                header.querySelector('.delete-btn').addEventListener('click', () => deleteItem('project', id));
                return div;
            }
            let draggedItemId = null; function handleDragStart(e, id) { draggedItemId = id; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', id); } function handleDragOver(e, el) { e.preventDefault(); el.classList.add('drag-over'); } function handleDragLeave(e, el) { el.classList.remove('drag-over'); }
            function handleDrop(e, targetProjectId, targetElement) {
                e.preventDefault(); if (targetElement) targetElement.classList.remove('drag-over');
                const sourceChatId = e.dataTransfer.getData('text/plain');
                if (!sourceChatId || !sourceChatId.startsWith('chat-') || targetProjectId === sourceChatId) return;
                state.structure = state.structure.filter(id => id !== sourceChatId); 
                Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(id => id !== sourceChatId) }); 
                if(state.projects[targetProjectId]){ 
                    if(!state.projects[targetProjectId].chatIds) state.projects[targetProjectId].chatIds = [];
                    state.projects[targetProjectId].chatIds.unshift(sourceChatId); 
                } 
                saveState(); renderSidebar(); 
            }
            async function renameItem(type, id) { const item = type === 'chat' ? state.chats[id] : state.projects[id]; if(!item) return; const newName = await showModal({ title: `Renombrar ${type === 'chat' ? 'Conversaci√≥n' : 'Proyecto'}`, useInput: true, placeholder: item.title }); if (newName && newName.trim()) { item.title = newName.trim(); if (type === 'chat' && currentChatId === id) dom.chatTitle.textContent = item.title; saveState(); renderSidebar(); } hideModal(); }
            async function deleteItem(type, id) { const item = type === 'chat' ? state.chats[id] : state.projects[id]; const conf = await showModal({ title: `Eliminar ${item.title}?`, message: 'Esta acci√≥n no se puede deshacer.', confirmText: 'Eliminar' }); if (conf) { state.structure = state.structure.filter(i => i !== id); if (type === 'project') { (item.chatIds || []).forEach(cid => delete state.chats[cid]); delete state.projects[id]; } else { delete state.chats[id]; Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(cid => cid !== id)}); } if(currentChatId === id || (type === 'project' && (item.chatIds || []).includes(currentChatId))) resetChatView(); saveState(); renderSidebar(); } hideModal(); }
            function updateActiveChatHighlight() { document.querySelectorAll('.chat-item').forEach(item => { item.style.backgroundColor = item.dataset.id === currentChatId ? 'var(--current-primary)' : 'transparent'; }); }
            
            function clearImageData() { dom.imageUploadInput.value = ''; dom.imagePreviewContainer.classList.add('hidden'); selectedImageBase64 = null; }
            function clearPdfData() { dom.pdfUploadInput.value = ''; dom.pdfPreviewContainer.classList.add('hidden'); selectedPdfText = null; }
            function hasFile() { return selectedImageBase64 || selectedPdfText; }
            
            async function sendMessage(forceSend = false, spokenMessage = null) {
                const userMessage = spokenMessage || dom.msgInput.value.trim();
                if (!userMessage && !selectedImageBase64 && !selectedPdfText) return;
                let chatIdToUpdate = currentChatId || createNewChat({});
                const currentChat = state.chats[chatIdToUpdate];
                if (!currentChat) return;
                
                const model = getModelForRequest(currentChat.workflow, hasFile());
                let cost = COSTS.GENERAL;
                if (currentChat.workflow === 'web-page') { cost = COSTS.WEB_PAGE; }
                else if (currentChat.workflow === 'copywriting') { cost = COSTS.COPYWRITING; }
                else if (currentChat.workflow === 'sales-response') { cost = COSTS.SALES_RESPONSE; }
                else if (currentChat.workflow === 'english-teacher') { cost = COSTS.ENGLISH_TEACHER; }
                else if (model === 'sonar') { cost = COSTS.SEARCH; }
                else if (model === 'gpt-4o' && hasFile()) { cost = COSTS.NEBULA; }
                
                let count = getCreditCount();
                if (count < cost && !forceSend) {
                    if (currentUser) { showPricingModal(); } 
                    else { showModal({ title: 'Cr√©ditos Agotados', message: `Por favor, inicia sesi√≥n para obtener m√°s cr√©ditos.`, confirmText: 'Iniciar Sesi√≥n' }).then(login => { if (login) netlifyIdentity.open('login'); });}
                    return;
                }
                if(currentChat.title === 'Conversaci√≥n C√≥smica' && userMessage.length > 5) {
                    currentChat.title = userMessage.split(' ').slice(0, 4).join(' ');
                    renderSidebar();
                }
                setCreditCount(count - cost);
                const [image, pdf] = [selectedImageBase64, selectedPdfText];
                currentChat.messages.push({ role: 'user', content: userMessage, image, pdfText: pdf });
                addMessageToUI('user', userMessage, image);
                const thinkingBubble = addMessageToUI('assistant', '‚Ä¶');
                dom.msgInput.value = ''; dom.msgInput.style.height = 'auto'; clearImageData(); clearPdfData();
                try {
                    const userNameForCall = currentUser ? (currentUser.user_metadata.full_name || currentUser.email) : 'viajero';
                    const responseData = await getAIResponse(userMessage, currentChat.messages.slice(0, -1), image, pdf, model, currentChat.workflow, userNameForCall);
                    if (responseData.error === 'LIMIT_REACHED') {
                        updateMessageInUI(thinkingBubble, `Has alcanzado el l√≠mite de cr√©ditos de tu plan. ¬°Actualiza para continuar!`);
                        setCreditCount(0); showPricingModal(); return;
                    }
                    if (responseData.reply) {
                        updateCreditCounter();
                        currentChat.messages.push({ role: 'assistant', content: responseData.reply });
                        updateMessageInUI(thinkingBubble, responseData.reply);
                        speak(responseData.reply);
                        saveState();
                    } else if (responseData.error) {
                        updateMessageInUI(thinkingBubble, `‚ùå **Error**<br><small>${responseData.details || 'Error del servidor.'}</small>`);
                        setCreditCount(count);
                    }
                } catch (error) {
                    updateMessageInUI(thinkingBubble, `‚ùå **Error de Conexi√≥n**<br><small>${error.message || 'No se pudo conectar al servidor.'}</small>`);
                    setCreditCount(count);
                }
            }

            async function generateImage() {
                const prompt = await showModal({ title: 'Crear Imagen', message: 'Describe la imagen que quieres crear:', useInput: true, placeholder: 'Ej: Un astronauta en un caballo c√≥smico', confirmText: 'Generar' });
                if (!prompt) { hideModal(); return; }
                hideModal();

                let count = getCreditCount();
                if (count < COSTS.IMAGE) {
                    showModal({ title: 'Cr√©ditos Insuficientes', message: `Necesitas ${COSTS.IMAGE} cr√©ditos para generar una imagen.` });
                    return;
                }
                setCreditCount(count - COSTS.IMAGE);

                let chatIdToUpdate = currentChatId || createNewChat({});
                const currentChat = state.chats[chatIdToUpdate];
                currentChat.messages.push({ role: 'user', content: `Generar imagen: "${prompt}"` });
                addMessageToUI('user', `Generar imagen: "${prompt}"`);
                const thinkingBubble = addMessageToUI('assistant', 'Creando tu visi√≥n...');

                try {
                    const token = currentUser ? await currentUser.jwt() : null;
                    const response = await fetch('/.netlify/functions/generate-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...(token && { 'Authorization': `Bearer ${token}` }) },
                        body: JSON.stringify({ prompt })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'No se pudo generar la imagen.');
                    }
                    const { imageData } = await response.json();
                    const imageContent = `¬°Aqu√≠ est√° tu creaci√≥n, Jefe/a!`;
                    currentChat.messages.push({ role: 'assistant', content: imageContent, image: imageData });
                    updateMessageInUI(thinkingBubble, imageContent, imageData);
                    saveState();
                } catch (error) {
                    updateMessageInUI(thinkingBubble, `‚ùå **Error al crear la imagen:**<br><small>${error.message}</small>`);
                    setCreditCount(count); // Refund credits
                }
            }

            function updateWebSearchButtonState() {
                dom.webSearchBtn.classList.toggle('text-primary', dom.modelSelector.value === 'sonar');
                dom.webSearchBtn.classList.toggle('text-text-medium', dom.modelSelector.value !== 'sonar');
            }
            
            function toggleSelectMode(active) {
                isSelectModeActive = active;
                dom.selectChatsBtn.classList.toggle('hidden', active);
                dom.deleteModeControls.classList.toggle('hidden', !active);
                if (!active) {
                    chatsToDelete.clear();
                    dom.deleteSelectedBtn.disabled = true;
                }
                renderSidebar();
            }

            function setupEventListeners() {
                dom.genericModal?.querySelector('#modal-confirm').addEventListener('click', () => { const input = dom.genericModal.querySelector('#modal-input'); hideModal(input.style.display !== 'none' ? input.value : true); });
                dom.genericModal?.querySelector('#modal-cancel').addEventListener('click', () => hideModal(null));
                dom.sendBtn?.addEventListener('click', () => sendMessage());
                const stopSpeech = () => { if(speechSynthesis.speaking) speechSynthesis.cancel(); };
                dom.msgInput?.addEventListener('keydown', (e) => { 
                    stopSpeech();
                    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } 
                });
                dom.msgInput?.addEventListener('input', () => { 
                    stopSpeech();
                    dom.msgInput.style.height = 'auto'; 
                    dom.msgInput.style.height = (dom.msgInput.scrollHeight) + 'px';
                });
                dom.newChatBtn?.addEventListener('click', () => createNewChat());
                dom.newProjectBtn?.addEventListener('click', async () => { const name = await showModal({ title: 'Crear Proyecto', useInput: true, placeholder: 'Nombre del Proyecto...' }); if (name && name.trim()) { const id = 'project-' + crypto.randomUUID(); state.projects[id] = { id, title: name.trim(), chatIds: [] }; state.structure.unshift(id); saveState(); renderSidebar(); } hideModal(); });
                dom.upgradePlanBtn?.addEventListener('click', showPricingModal);
                dom.closePricingModalBtn?.addEventListener('click', hidePricingModal);
                dom.themeToggle?.addEventListener('click', () => setTheme(!document.body.classList.contains('dark-theme')));
                dom.loginBtn?.addEventListener('click', () => netlifyIdentity.open('login'));
                dom.chatTitle.addEventListener('click', () => { if(currentChatId) renameItem('chat', currentChatId); });
                dom.imageGenBtn.addEventListener('click', generateImage);

                if (SR && dom.voiceBtn) {
                    recognition = new SR(); 
                    recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'es-ES'; 
                    recognition.onstart = () => { isRecognizing = true; dom.voiceBtn.classList.add('glowing-mic'); };
                    recognition.onend = () => { isRecognizing = false; dom.voiceBtn.classList.remove('glowing-mic'); };
                    recognition.onerror = (e) => { console.error("Speech recognition error", e); isRecognizing = false; dom.voiceBtn.classList.remove('glowing-mic'); };
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        if(transcript) { sendMessage(false, transcript); }
                    };
                    dom.voiceBtn.addEventListener('click', () => { 
                        if(isRecognizing) {
                            recognition.stop();
                        } else {
                            if (speechSynthesis.speaking) { speechSynthesis.cancel(); }
                            try { recognition.start(); } catch(e) {console.error("Could not start recognition", e)}
                        }
                    });
                } else { if(dom.voiceBtn) dom.voiceBtn.style.display = 'none'; }
                
                if (dom.ttsToggle) {
                    const ttsIcon = dom.ttsToggle.querySelector('i');
                    dom.ttsToggle.addEventListener('click', () => { 
                        speechOn = !speechOn;
                        ttsIcon.classList.toggle('fa-volume-high', speechOn);
                        ttsIcon.classList.toggle('fa-volume-mute', !speechOn);
                        dom.ttsToggle.classList.toggle('text-yellow-400', speechOn);
                        dom.ttsToggle.classList.toggle('text-text-medium', !speechOn);
                        if (!speechOn) speechSynthesis.cancel();
                    });
                }
                
                dom.modelSelector?.addEventListener('change', () => {
                   updateWebSearchButtonState();
                });
                dom.webSearchBtn.addEventListener('click', () => {
                    dom.modelSelector.value = dom.modelSelector.value === 'sonar' ? 'gpt-3.5-turbo-1106' : 'sonar';
                    updateWebSearchButtonState();
                });

                dom.imageUploadBtn?.addEventListener('click', () => dom.imageUploadInput.click());
                dom.pdfUploadBtn?.addEventListener('click', () => dom.pdfUploadInput.click());
                dom.clearImageBtn?.addEventListener('click', clearImageData);
                dom.clearPdfBtn?.addEventListener('click', clearPdfData);
                dom.imageUploadInput?.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { clearPdfData(); const reader = new FileReader(); reader.onload = (ev) => { selectedImageBase64 = ev.target.result; dom.imagePreview.src = selectedImageBase64; dom.imagePreviewContainer.classList.remove('hidden'); dom.modelSelector.value = 'gpt-4o'; }; reader.readAsDataURL(e.target.files[0]); } });
                dom.pdfUploadInput?.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file || file.type !== 'application/pdf') return; clearImageData(); dom.pdfNameEl.textContent = file.name; dom.pdfStatusEl.textContent = 'Leyendo...'; dom.pdfPreviewContainer.classList.remove('hidden'); const reader = new FileReader(); reader.onload = async (ev) => { dom.pdfStatusEl.textContent = 'Procesando...'; try { const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(ev.target.result) }).promise; let text = ''; for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const content = await page.getTextContent(); text += content.items.map(item => item.str).join(' ') + '\n'; } selectedPdfText = text; dom.pdfStatusEl.textContent = `‚úÖ Listo (${pdf.numPages} p√°g.)`; dom.modelSelector.value = 'gpt-4o'; } catch (err) { console.error("Error al procesar el PDF:", err); dom.pdfStatusEl.textContent = '‚ùå Error al leer PDF.'; selectedPdfText = null; setTimeout(clearPdfData, 2000); } }; reader.readAsArrayBuffer(file); });
                
                dom.menuToggle?.addEventListener('click', (e) => { e.stopPropagation(); toggleSidebar(true); });
                dom.sidebarOverlay?.addEventListener('click', () => toggleSidebar(false));
                dom.userMenuBtn?.addEventListener('click', (e) => { e.stopPropagation(); dom.userMenuPopup.classList.toggle('hidden'); });
                dom.logoutBtn?.addEventListener('click', () => { netlifyIdentity.logout(); dom.userMenuPopup.classList.add('hidden');});
                
                const createWorkflowChat = (opts) => { createNewChat(opts); if (window.innerWidth < 768) toggleSidebar(false); };
                dom.copywritingWorkflowBtn?.addEventListener('click', () => createWorkflowChat({ title: "Nuevo Copy", workflow: "copywriting", initialMessages: [{ role: 'assistant', content: `A la orden, Jefe/a. Para forjar el copy perfecto (costo: ${COSTS.COPYWRITING} cr√©ditos), solo necesito la esencia de tu idea. Pega el texto o describe el concepto, y le dar√© vida.` }] }));
                dom.salesResponseWorkflowBtn?.addEventListener('click', () => createWorkflowChat({ title: "Respuesta de Venta", workflow: "sales-response", initialMessages: [{ role: 'assistant', content: `Entendido, Jefe/a. Para dise√±ar la respuesta de venta ideal (costo: ${COSTS.SALES_RESPONSE} cr√©ditos), simplemente pega el mensaje de tu cliente. Yo me encargo de transformarlo en una oportunidad.` }] }));
                dom.webPageWorkflowBtn?.addEventListener('click', () => createWorkflowChat({ title: "Nueva P√°gina Web", workflow: "web-page", initialMessages: [{ role: 'assistant', content: `Perfecto, Jefe/a. Usaremos el motor m√°s potente para materializar tu p√°gina web (costo: ${COSTS.WEB_PAGE} cr√©ditos). **Describe con detalle la p√°gina que imaginas y la construir√© para ti.**` }] }));
                dom.englishTeacherWorkflowBtn?.addEventListener('click', () => createWorkflowChat({ title: "English Teacher", workflow: "english-teacher", initialMessages: [{ role: 'assistant', content: "Hello! I am here to assist you. Do you wish to translate something, or perhaps learn something new today?" }] }));

                dom.closeHtmlPreviewModalBtn?.addEventListener('click', () => dom.htmlPreviewModal.classList.add('hidden'));
                dom.voiceSelector?.addEventListener('change', (e) => { selectedVoice = availableVoices.find(voice => voice.name === e.target.value); });
                document.addEventListener('click', (e) => {
                    if (dom.userMenuBtn && dom.userMenuPopup && !dom.userMenuBtn.contains(e.target) && !dom.userMenuPopup.contains(e.target)) { dom.userMenuPopup.classList.add('hidden'); }
                    if (dom.sidebar && window.innerWidth < 768 && !dom.sidebar.contains(e.target) && dom.sidebar.classList.contains('is-open')) { toggleSidebar(false); }
                });
                const setAppHeight = () => { const app = document.getElementById('app-container'); if(app) app.style.height = `${window.innerHeight}px`; };
                setAppHeight();
                window.addEventListener('resize', setAppHeight);
                dom.selectChatsBtn.addEventListener('click', () => toggleSelectMode(true));
                dom.cancelSelectModeBtn.addEventListener('click', () => toggleSelectMode(false));
                dom.deleteSelectedBtn.addEventListener('click', async () => {
                    if (chatsToDelete.size === 0) return;
                    const confirm = await showModal({ title: `Eliminar ${chatsToDelete.size} chat(s)`, message: 'Esta acci√≥n es irreversible. ¬øConfirmas la eliminaci√≥n?', confirmText: 'Eliminar' });
                    if (confirm) {
                        chatsToDelete.forEach(id => {
                            state.structure = state.structure.filter(i => i !== id);
                            delete state.chats[id];
                             Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(cid => cid !== id) });
                            if (currentChatId === id) resetChatView();
                        });
                        saveState();
                        toggleSelectMode(false);
                    }
                     hideModal();
                });
            }
            
            function initApp() {
                setTheme(localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches));
                const unlockAudio = () => {
                    const silence = new SpeechSynthesisUtterance('');
                    silence.volume = 0;
                    window.speechSynthesis.speak(silence);
                    document.body.removeEventListener('touchstart', unlockAudio);
                    document.body.removeEventListener('click', unlockAudio);
                };
                document.body.addEventListener('touchstart', unlockAudio, { once: true });
                document.body.addEventListener('click', unlockAudio, { once: true });
                let initFired = false;
                const finishInitialization = (user) => {
                    if (initFired) return;
                    initFired = true;
                    currentUser = user;
                    if (user) {
                        if (localStorage.getItem(`userCredits_${user.id}`) === null) {
                            localStorage.setItem(`userCredits_${user.id}`, FREE_PLAN_CREDIT_LIMIT);
                        }
                    } else {
                        if (localStorage.getItem('guestCreditCount') === null) {
                            localStorage.setItem('guestCreditCount', GUEST_CREDIT_LIMIT);
                        }
                    }
                    updateUserUI();
                    loadStateForUser();
                    dom.appContainer.classList.remove('opacity-0');
                    dom.loadingOverlay.style.display = 'none';
                };
                netlifyIdentity.on('init', (user) => finishInitialization(user));
                setTimeout(() => { if (!initFired) { finishInitialization(netlifyIdentity.currentUser()); } }, 1500);
                netlifyIdentity.on('login', (user) => {
                    netlifyIdentity.close(); 
                    currentUser = user;
                    localStorage.setItem('hasLoggedInBefore', 'true');
                    if (localStorage.getItem(`userCredits_${user.id}`) === null) {
                        localStorage.setItem(`userCredits_${user.id}`, FREE_PLAN_CREDIT_LIMIT);
                    }
                    localStorage.removeItem('guestCreditCount');
                    updateUserUI(); 
                    loadStateForUser();
                });
                netlifyIdentity.on('logout', () => { 
                    currentUser = null; 
                    localStorage.setItem('guestCreditCount', '0');
                    updateUserUI(); 
                    loadStateForUser(); 
                    resetChatView();
                    showModal({ title: 'Sesi√≥n Cerrada', message: `Has cerrado sesi√≥n. Para continuar, por favor, inicia sesi√≥n de nuevo.`, confirmText: 'Iniciar Sesi√≥n' })
                        .then(wantsToLogin => { if (wantsToLogin) netlifyIdentity.open('login'); });
                });
                populateVoiceList();
                setupEventListeners();
                updateWebSearchButtonState();
            }

            initApp();
        });
    </script>
</body>
</html>
