<!DOCTYPE html>
<html data-theme="light" lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<title>Goatify IA v5.4 ‚Äî Edici√≥n Definitiva</title>
<!-- SEO Meta Tags -->
<meta content="Goatify IA v5.4 es tu sistema operativo de negocios con IA. Gestiona proyectos, marketing, y tu carrera profesional con herramientas potenciadas por IA, ahora con un dise√±o totalmente responsivo." name="description"/>
<meta content="project management, crm, business os, project os, marketing agency, content calendar, cronopost, inline editing, goatify ia, responsive design" name="keywords"/>
<meta content="Goatify" name="author"/>
<!-- Open Graph Meta Tags -->
<meta content="Goatify IA v5.4 ‚Äî Edici√≥n Definitiva" property="og:title"/>
<meta content="website" property="og:type"/>
<meta content="Goatify IA v5.4, ahora totalmente responsivo y con m√≥dulos redise√±ados para una m√°xima productividad en cualquier dispositivo." property="og:description"/>
<meta content="#f6f7fb" name="theme-color"/>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  :root{
    --bg:#0b0f19; --surface:#0f172a; --muted:#1e293b; --line:#334155;
    --text:#e2e8f0; --sub:#94a3b8; --brand:#a78bfa; --brand2:#8b5cf6; --accent:#38bdf8;
    --danger:#f87171; --warn:#fbbf24; --success:#22c55e; --info:#60a5fa;
    --shadow:0 20px 60px rgba(0,0,0,.45);
    --radius:12px; --xs:10px; --sm:12px; --md:13.5px; --lg:15.5px; --xl:18px;
    --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  [data-theme="light"]{
    --bg:#f8fafc; --surface:#ffffff; --muted:#f1f5f9; --line:#e2e8f0;
    --text:#0f172a; --sub:#64748b; --brand:#6d28d9; --brand2:#8b5cf6; --accent:#0ea5e9;
    --shadow:0 10px 25px rgba(15, 23, 42,.08);
  }
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
  *{box-sizing:border-box; transition: background .15s ease, color .15s ease, border-color .15s ease, transform .15s ease, box-shadow .15s ease}
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font: var(--md)/1.5 var(--font-sans);}
  a{color:var(--brand);text-decoration:none}
  .container{display:grid;grid-template-columns:280px 1fr;min-height:100%}
  aside{border-right:1px solid var(--line);background:var(--surface);padding:10px;position:relative;z-index:30; display: flex; flex-direction: column;}
  header.app{position:sticky;top:0;z-index:40;background:color-mix(in hsl, var(--surface) 85%, transparent);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);padding:8px 10px;display:flex;gap:10px;align-items:center}
  .brand{display:flex;gap:8px;align-items:center;font-weight:800; font-size: var(--lg);}
  .badge{padding:2px 8px;border-radius:999px;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;font-size:var(--xs)}
  .btn{border-radius:var(--radius);border:1px solid var(--line);background:var(--surface);color:var(--text);padding:8px 12px;cursor:pointer;display:inline-flex;gap:8px;align-items:center; font-weight: 600; white-space: nowrap;}
  .btn:hover{transform:translateY(-1px); border-color: var(--brand); box-shadow: var(--shadow);} .btn:active{transform:translateY(0); box-shadow: none;}
  .btn[disabled] { cursor: not-allowed; opacity: 0.5; } .btn[disabled]:hover { transform: none; box-shadow: none; border-color: var(--line); }
  .btn-primary{border:none;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff}
  .btn-ghost{background:transparent; border-color: transparent; box-shadow: none;}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border:1px solid transparent;border-radius:999px;background:var(--muted); cursor: pointer;}
  .chip:hover { border-color: var(--brand); }
  input,select,textarea{border:1px solid var(--line);border-radius:10px;background:var(--muted);color:var(--text);padding:8px 12px;outline:none; width: 100%;}
  input:focus, select:focus, textarea:focus { border-color: var(--brand); background: var(--surface); box-shadow: 0 0 0 3px color-mix(in hsl, var(--brand) 20%, transparent); }
  .projList{display:flex;flex-direction:column;gap:6px}
  .navBtn{display:flex;gap:10px;align-items:center;border:1px solid transparent;border-radius:10px;background:transparent;padding:10px;cursor:pointer; font-weight: 500; color: var(--text)}
  .navBtn:hover{background:var(--muted);}
  .navBtn.active {background: var(--brand); color: #fff; font-weight: 700;}
  .projItem { display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 10px; border: 1px solid transparent; cursor: pointer; }
  .projItem .proj-actions { display: none; margin-left: auto;}
  .projItem:hover { background: var(--muted); }
  .projItem:hover .proj-actions { display: flex; }
  .projItem.active { background: color-mix(in hsl, var(--brand) 15%, transparent); border-color: var(--brand); font-weight: 600; }
  .panel{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden; animation: fadeIn .3s ease; display:flex; flex-direction: column;}
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}
  .section{padding:16px;border-top:1px solid var(--line);}
  .card{border:1px solid var(--line);border-radius:12px;background:var(--muted);padding:16px; animation: fadeIn .4s ease both; }
  .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
  .stat-card { background: var(--muted); padding: 16px; border-radius: var(--radius); cursor: pointer; }
  .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
  .stat-card h4 { margin: 0 0 8px 0; color: var(--sub); }
  .stat-card p { margin: 0; font-size: var(--xl); font-weight: 700; }
  .tip { padding: 12px; background: color-mix(in hsl, var(--info) 10%, transparent); border-left: 3px solid var(--info); border-radius: 8px; margin: 10px 0; display: flex; gap: 10px; align-items: flex-start;}
  .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; color: var(--sub); border: 2px dashed var(--line); border-radius: var(--radius); text-align: center; }
  .empty-state i { width: 48px; height: 48px; margin-bottom: 16px; stroke-width: 1.5; }
  .tabs{display:flex;gap:6px;padding:12px;border-bottom:1px solid var(--line); flex-wrap: wrap;}
  .tab{all:unset;cursor:pointer;padding:8px 14px;border:1px solid var(--line);border-radius:999px;background:var(--muted); font-weight: 600;}
  .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
  .board{display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:16px;padding:16px}
  .col{background:var(--muted);border:1px solid var(--line);border-radius:12px;min-height:220px;padding:8px}
  .col.dragover { outline: 2px dashed var(--brand); background: color-mix(in hsl, var(--brand) 10%, transparent); }
  .task{background:var(--surface);border:1px solid var(--line);border-radius:10px;padding:12px;margin:8px 4px;cursor:grab;box-shadow:var(--shadow)}
  .task:hover{transform:scale(1.03)}
  #cronopost-grid { display: grid; grid-template-columns: 1fr 320px; gap: 16px; padding: 16px; flex-grow: 1; }
  #cpCalendarContainer { background: var(--surface); border: 1px solid var(--line); border-radius: var(--radius); padding: 10px; display: flex; flex-direction: column; }
  .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 600; color: var(--sub); padding-bottom: 10px; border-bottom: 1px solid var(--line); }
  #cpCalendar { display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: minmax(100px, 1fr); gap: 5px; flex-grow: 1; }
  .day { border-radius: 10px; background: var(--surface); border: 1px solid var(--line); padding: 6px; display: flex; flex-direction: column; gap: 4px; transition: background .2s; overflow-y: auto; }
  .day:hover { background: var(--muted); }
  .day.other-month { background: var(--muted); opacity: 0.6; }
  .day-number { font-weight: 600; font-size: var(--sm); text-align: right; margin-bottom: 4px; }
  .cp-post { font-size: var(--sm); border-left: 3px solid var(--brand); background: var(--muted); border-radius: 6px; padding: 4px 8px; cursor: grab; animation: fadeIn .2s; transition: transform .2s, box-shadow .2s; word-break: break-word; }
  .cp-post:hover { transform: scale(1.05); box-shadow: var(--shadow); }
  #cpIdeas { background: var(--surface); border: 1px solid var(--line); border-radius: var(--radius); padding: 16px; display: flex; flex-direction: column; }
  .cp-idea { background: var(--muted); border: 1px dashed var(--line); border-radius: 8px; padding: 8px; margin-bottom: 8px; cursor: grab; transition: border-color .2s, background .2s; }
  .cp-idea:hover { border-color: var(--brand); background: var(--surface); }
  .hub-grid{display:grid; grid-template-columns: 320px 1fr; gap: 16px; padding: 16px;}
  .profile-card { padding: 20px; background: var(--surface); border: 1px solid var(--line); border-radius: var(--radius); }
  .avatar { width: 80px; height: 80px; border-radius: 999px; object-fit: cover; border: 3px solid var(--brand); margin: 0 auto 10px; display: block;}
  .job-item, .market-item, .monet-step { background: var(--surface); border: 1px solid var(--line); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
  .job-item:hover, .market-item:hover, .monet-step:hover { border-color: var(--brand); box-shadow: var(--shadow); transform: translateY(-2px); }
  .gchat-grid { display: grid; grid-template-columns: 260px 1fr; gap: 16px; padding: 16px; }
  .user-list .user-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; }
  .user-list .user-item:hover { background: var(--muted); }
  .presence-dot { width: 10px; height: 10px; border-radius: 50%; }
  .presence-dot.online { background: var(--success); }
  .presence-dot.offline { background: var(--sub); }
  .chat-log .msg { margin-bottom: 12px; }
  .chat-log .msg small { color: var(--sub); }
  .chat-log .msg-body { background: var(--surface); padding: 8px 12px; border-radius: 12px; display: inline-block; max-width: 80%; }
  .chat-log .msg.mine .msg-body { background: var(--brand); color: #fff; }
  .mindset-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
  .mindset-card { background: var(--surface); border: 1px solid var(--line); border-radius: var(--radius); padding: 24px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .mindset-card h3 { margin-top: 0; color: var(--brand); }
  #breathing-circle { width: 150px; height: 150px; border-radius: 50%; background: var(--brand); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; margin: 20px 0; transition: transform 4s ease-in-out; }
  .breathing { animation: breathe 8s ease-in-out infinite; }
  @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
  dialog { border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); max-width: 600px; padding: 0; }
  dialog[open] { animation: fadeIn .2s ease; }
  dialog::backdrop { background: rgba(0,0,0,.5); backdrop-filter: blur(4px); }
  #toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 999px; z-index: 100; font-weight: 600; box-shadow: var(--shadow); opacity: 0; transition: opacity .3s, bottom .3s; }
  #toast.show { opacity: 1; bottom: 30px; }
  #toast.info { background: linear-gradient(90deg, var(--brand), var(--brand2)); color: #fff; }
  #toast.success { background: linear-gradient(90deg, var(--success), #16a34a); color: #fff; }
  #toast.warn { background: linear-gradient(90deg, var(--warn), #d97706); color: #fff; }

  /* ====== RESPONSIVE DESIGN ====== */
  main { padding: 0; overflow-x: hidden; }
  
  @media (max-width: 1180px){ 
    .container{grid-template-columns:1fr} 
    aside{position:fixed;inset:0;transform:translateX(-101%);transition:.3s ease;z-index:99; width: 300px;} 
    body.aside-open aside{transform:translateX(0)} 
    body.aside-open::before { content: ''; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 29; }
  }

  @media (max-width: 960px){ 
    .hub-grid, #cronopost-grid, .gchat-grid {grid-template-columns:1fr} 
    #cronopost-grid { height: auto; }
    .day { min-height: 120px; }
    .mindset-grid { grid-template-columns: 1fr; }
  }

  /* Responsive Tables and Boards for Mobile */
  @media (max-width: 768px) {
    main { padding: 10px; }
    .panel { margin: 0; }
    .board { grid-template-columns: 1fr; }
    .row { gap: 8px; }
    #p-tab-tasks .row { flex-direction: column; align-items: stretch; }
    .tabs { overflow-x: auto; padding-bottom: 8px; scrollbar-width: none; }
    .tabs::-webkit-scrollbar { display: none; }

    /* Responsive Tables */
    table.responsive-table thead { display: none; }
    table.responsive-table tr {
        display: block;
        margin-bottom: 16px;
        border-radius: var(--radius);
        border: 1px solid var(--line);
        box-shadow: var(--shadow);
        background: var(--surface);
        padding: 8px;
    }
    table.responsive-table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-align: right;
        border-bottom: 1px solid var(--line);
        position: relative;
        padding: 10px;
    }
    table.responsive-table td:last-child { border-bottom: 0; }
    table.responsive-table td::before {
        content: attr(data-label);
        text-align: left;
        font-weight: 600;
        color: var(--sub);
    }
    /* Make complex tables like Sheets scrollable */
    #sheetWrap {
        overflow-x: auto;
    }
  }

</style>
</head>
<body>
<header class="app">
<button class="btn btn-ghost" id="menuBtn"><i data-lucide="menu"></i></button>
<div class="brand">Goatify <span style="color:var(--brand)">IA</span> <span class="badge">v5.4</span></div>
<div class="spacer"></div>
<div class="chip" id="walletChip" title="Ver Billetera"><i data-lucide="wallet"></i> <span id="wallet-amount">$0</span></div>
<div class="chip" id="intisChip" title="Tus Intis (puntos de gamificaci√≥n)"><i data-lucide="sparkles"></i> <span id="intis-amount">0</span></div>
<div class="chip" id="creditsChip" title="Haz clic para ver los beneficios de la membres√≠a"><i data-lucide="star"></i> <span id="credits-amount">100</span> cr√©ditos</div>
<button class="btn btn-ghost" id="themeBtn"><i data-lucide="sun"></i></button>
<button class="btn btn-ghost" id="tourBtn"><i data-lucide="help-circle"></i></button>
</header>
<div class="container">
<aside>
<div>
<div class="search row"><i data-lucide="search"></i><input id="q" placeholder="Buscar en todo‚Ä¶"/></div>
<div class="row" style="padding: 10px 0;"><b>Proyectos</b><span class="spacer"></span><button class="btn" id="newProject"><i data-lucide="plus"></i> Nuevo</button></div>
<div class="projList" id="projList"></div>
</div>
<div class="spacer" style="min-height: 20px;"></div>
<div>
<hr style="border-color:var(--line); margin: 10px 0;"/>
<div id="nav-list" class="projList">
<a class="navBtn" data-nav="cronopost" href="#cronopost"><i data-lucide="calendar-days"></i> Calendario General</a>
<a class="navBtn" data-nav="hub" href="#hub"><i data-lucide="globe-2"></i> Hub Profesional</a>
<a class="navBtn" data-nav="marketing" href="#marketing"><i data-lucide="rocket"></i> Marketing Pro</a>
<a class="navBtn" data-nav="gchat" href="#gchat"><i data-lucide="messages-square"></i> Chat Global</a>
<a class="navBtn" data-nav="monet" href="#monet"><i data-lucide="dollar-sign"></i> Asistente de Monetizaci√≥n</a>
<a class="navBtn" data-nav="mindset" href="#mindset"><i data-lucide="brain-circuit"></i> Balance y Mindset</a>
<a class="navBtn" data-nav="admin" href="#admin"><i data-lucide="shield"></i> Admin</a>
<a class="navBtn" id="changeIndustryBtn" href="#"><i data-lucide="factory"></i> Cambiar Industria</a>
<a class="navBtn" data-nav="settings" href="#settings"><i data-lucide="settings"></i> Ajustes</a>
</div>
</div>
</aside>
<main id="main">
<!-- PROJECT SHELL -->
<section class="panel" id="projectShell" style="display:none">
<div class="tabs">
<button class="tab active" data-ptab="overview">Overview</button>
<button class="tab" data-ptab="tasks">Tareas</button>
<button class="tab" data-ptab="calendar">Calendario</button>
<button class="tab" data-ptab="tables">Tablas</button>
<button class="tab" data-ptab="notes">Notas</button>
<button class="tab" data-ptab="drawings">Dibujos</button>
<button class="tab" data-ptab="files">Archivos</button>
<button class="tab" data-ptab="chat">Chat IA</button>
<button class="tab" data-ptab="finance">Finanzas</button>
<div class="spacer"></div>
<div class="chip" id="projectNameChip">Proyecto</div>
<button class="btn" id="addFolder"><i data-lucide="folder-plus"></i> Subcarpeta</button>
<select id="folderSel"></select>
<button class="btn btn-primary" id="quickAdd"><i data-lucide="plus"></i> A√±adir</button>
</div>
<!-- OVERVIEW -->
<div id="p-tab-overview" style="padding:16px">
    <div id="ovr" class="overview-grid"></div>
</div>
<!-- TASKS -->
<div id="p-tab-tasks" style="display:none;">
    <div class="row" style="padding:16px; border-bottom: 1px solid var(--line); align-items: stretch;">
        <div class="card" style="flex: 1;">
            <b style="display: block; margin-bottom: 8px;">Nueva Tarea</b>
            <input id="qaTitle" placeholder="T√≠tulo de la nueva tarea‚Ä¶" style="margin-bottom: 8px;"/>
            <div class="row" style="gap: 8px;">
                <input id="qaDue" style="flex: 1;" type="datetime-local"/>
                <select id="qaPriority" style="flex: 1;"><option>Baja</option><option selected>Media</option><option>Alta</option></select>
                <select id="qaFolder" style="flex: 1;"></select>
            </div>
            <button class="btn btn-primary" id="qaCreate" style="width: 100%; margin-top: 8px;">Crear Tarea</button>
        </div>
        <div class="card" style="flex: 1; justify-content: center;">
            <b>Vista de Tareas</b>
            <div class="row" style="margin-top: 8px;">
                <button class="btn active" id="vKanban" style="flex: 1;"><i data-lucide="layout-grid"></i> Kanban</button>
                <button class="btn" id="vList" style="flex: 1;"><i data-lucide="list"></i> Lista</button>
            </div>
        </div>
    </div>
    <div class="board" id="kanban"></div>
    <div class="list" id="list" style="display:none;padding:16px; overflow-x: auto;">
        <table id="listTable" class="responsive-table" style="width:100%; border-collapse: separate; border-spacing: 0 8px;">
            <thead>
                <tr><th style="padding: 8px;">‚úì</th><th style="padding: 8px;">Tarea</th><th style="padding: 8px;">Prioridad</th><th style="padding: 8px;">Vence</th><th style="padding: 8px;">Asignado</th><th style="padding: 8px;">Estado</th><th style="padding: 8px;">Subcarpeta</th><th style="padding: 8px;"></th></tr>
            </thead>
            <tbody id="listBody"></tbody>
        </table>
    </div>
</div>
<!-- CALENDAR -->
<div id="p-tab-calendar" style="display:none; padding:16px; flex-grow: 1; display: flex; flex-direction: column;">
<div class="row"><b>Calendario del proyecto</b><span class="spacer"></span><button class="btn" id="prevM"><i data-lucide="chevron-left"></i></button><div class="chip" id="monthLbl">Mes</div><button class="btn" id="nextM"><i data-lucide="chevron-right"></i></button></div>
<div class="tip"><i data-lucide="info"></i>Haz doble clic en cualquier d√≠a para agregar una nueva tarea. Arrastra tareas para reagendarlas.</div>
<div id="calGridContainer" style="flex-grow:1; display:flex; flex-direction: column;">
    <div class="calendar-header"></div>
    <div class="calendar" id="calGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: 1fr; gap: 5px; flex-grow: 1;"></div>
</div>
</div>
<!-- TABLES -->
<div id="p-tab-tables" style="display:none; padding:16px;">
<div class="row"><b>Tablas</b><span class="spacer"></span><button class="btn" id="newSheet"><i data-lucide="plus"></i> Nueva Tabla</button><select id="tableSel" class="btn"></select><button class="btn" id="addCol"><i data-lucide="plus"></i> Columna</button><button class="btn" id="addRow"><i data-lucide="plus"></i> Fila</button><button class="btn" id="exportCSV">Exportar CSV</button></div>
<div class="section" id="sheetWrap" style="overflow:auto; padding:0; margin-top: 16px;"></div>
</div>
<!-- NOTES -->
<div id="p-tab-notes" style="display:none">
<div class="hub-grid" style="padding:16px">
<div class="card">
<div class="row"><b>Notas</b><span class="spacer"></span><button class="btn" id="newNote"><i data-lucide="plus"></i> Nueva Nota</button></div>
<div class="listSlim" id="noteList" style="margin-top:8px"></div>
</div>
<div class="card">
<div class="row" style="margin-bottom:8px; flex-wrap: wrap;">
<button class="btn" data-cmd="bold"><b>B</b></button>
<button class="btn" data-cmd="italic"><i>I</i></button>
<button class="btn" data-cmd="underline"><u>U</u></button>
<button class="btn" data-cmd="insertUnorderedList">‚Ä¢ Lista</button>
<button class="btn" data-cmd="insertOrderedList">1. Lista</button>
<button class="btn" id="h1Btn">H1</button><button class="btn" id="h2Btn">H2</button>
<select id="noteFolder"></select>
<button class="btn" id="noteMove">Mover</button>
</div>
<div class="section" contenteditable="true" id="noteEditor" style="min-height:50vh; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--line); padding: 12px;"></div>
</div>
</div>
</div>
<!-- DRAWINGS -->
<div id="p-tab-drawings" style="display:none; padding:16px;">
    <div class="row"><b>Dibujos y Bocetos</b><span class="spacer"></span><button class="btn" id="newDrawing"><i data-lucide="plus"></i> Nuevo Dibujo</button><select id="drawingSel" class="btn"></select><button class="btn" id="saveDrawing">Guardar</button><button class="btn" id="clearCanvas">Limpiar</button></div>
    <div style="margin-top: 16px; border: 1px solid var(--line); border-radius: var(--radius); overflow: hidden;">
        <canvas id="drawingCanvas"></canvas>
    </div>
</div>
<!-- FILES -->
<div id="p-tab-files" style="display:none;padding:16px">
<div class="row"><b>Archivos</b><span class="spacer"></span><button onclick="$('#fileInput').click()" class="btn btn-primary"><i data-lucide="upload"></i> Subir Archivos</button><input id="fileInput" multiple="" type="file" style="display: none;"/></div>
<div id="fileList" style="margin-top:10px"></div>
</div>
<!-- CHAT IA -->
<div id="p-tab-chat" style="display:none">
<div class="gchat-grid">
<div>
<div class="card">
    <div class="row"><b>Hilos de Chat</b><span class="spacer"></span><button class="btn" id="newChat"><i data-lucide="plus"></i> Nuevo</button></div>
    <div class="chatList" id="chatList" style="margin-top: 10px;"></div>
</div>
</div>
<div>
<div id="chatLog" style="height:65vh;overflow:auto;border: 1px solid var(--line); border-radius: var(--radius); padding:10px; background: var(--muted);"></div>
<div class="row" style="padding:10px 0;">
    <input class="spacer" id="chatMsg" placeholder="Escribe‚Ä¶"/>
    <button class="btn btn-primary" id="sendMsg"><i data-lucide="send"></i></button>
    <button class="btn" title="Convertir √∫ltimo mensaje en tarea" id="chatToTasks"><i data-lucide="list-plus"></i></button>
</div>
</div>
</div>
</div>
<!-- FINANZAS -->
<div id="p-tab-finance" style="display:none; padding: 16px;">
    <div class="row"><b>Finanzas del Proyecto</b><span class="spacer"></span><button class="btn btn-primary" id="finNew"><i data-lucide="plus"></i> Movimiento</button><button class="btn" id="finExport">CSV</button></div>
    <div class="overview-grid" style="padding: 16px 0;">
        <div class="stat-card"><h4>Ingresos Totales</h4><p id="finIn" style="color: var(--success);">0</p></div>
        <div class="stat-card"><h4>Egresos Totales</h4><p id="finOut" style="color: var(--danger);">0</p></div>
        <div class="stat-card"><h4>Balance Neto</h4><p id="finBal">0</p></div>
    </div>
    <div>
        <table id="finTable" class="responsive-table" style="width:100%; border-collapse: collapse;">
            <thead><tr><th style="text-align: left; padding: 8px;">Fecha</th><th style="text-align: left; padding: 8px;">Tipo</th><th style="text-align: right; padding: 8px;">Monto</th><th style="text-align: left; padding: 8px;">Categor√≠a</th><th style="text-align: left; padding: 8px;">Nota</th><th></th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
</section>
<!-- CRONOPOST -->
<section class="panel" id="cronopost" style="display:none;">
    <div class="row" style="padding:16px; border-bottom: 1px solid var(--line); flex-wrap: nowrap;">
        <b>Calendario General</b><span class="spacer"></span>
        <select id="cpProjectFilter" class="btn" style="max-width: 200px;"></select>
        <button class="btn" id="cpPrevM"><i data-lucide="chevron-left"></i></button>
        <div class="chip" id="cpMonthLbl" style="min-width: 150px; justify-content: center;">Mes</div>
        <button class="btn" id="cpNextM"><i data-lucide="chevron-right"></i></button>
    </div>
    <div id="cronopost-grid">
        <div id="cpCalendarContainer">
            <div class="calendar-header"></div>
            <div id="cpCalendar"></div>
        </div>
        <div id="cpIdeas">
            <div class="row">
                <b>üí° Banco de Ideas</b>
                <span class="spacer"></span>
                <span class="chip" id="cpIdeasProjectName"></span>
            </div>
            <div id="cpIdeasList" style="margin: 10px 0; flex-grow: 1; overflow-y: auto;"></div>
            <textarea id="cpNewIdeaInput" placeholder="Escribe una nueva idea..." style="margin-bottom: 8px;" rows="3"></textarea>
            <button class="btn" id="cpAddIdeaBtn" style="width: 100%;">+ A√±adir Idea</button>
            <button class="btn btn-primary" id="cpGenAIIdeas" style="width: 100%; margin-top: 8px;"><i data-lucide="sparkles"></i> Generar Ideas con IA</button>
        </div>
    </div>
</section>
<!-- MARKETING PRO -->
<section class="panel" id="marketing" style="display:none;padding:16px">
<div class="row" style="padding-bottom:10px;">
    <b>Marketing Pro</b>
    <span class="spacer"></span>
</div>
<div class="tip"><i data-lucide="info"></i>Este m√≥dulo te ayuda a definir la estrategia central de tu marca o proyecto. Un buen "brief" es el mapa para todas tus acciones de marketing.</div>
<div class="tabs">
<button class="tab active" data-mtab="brief">Brief Estrat√©gico</button>
<button class="tab" data-mtab="ofertas">Ofertas y UTMs</button>
<button class="tab" data-mtab="assets">Assets de Marca</button>
</div>
<div class="section" id="m-mtab-brief">
<div class="row"><input id="brandName" placeholder="Marca / Proyecto"/><input class="spacer" id="target" placeholder="P√∫blico objetivo"/><select id="funnel"><option>Awareness</option><option>Consideration</option><option>Conversion</option></select><button class="btn btn-primary" id="briefSave">Guardar</button></div>
<textarea id="briefNotes" placeholder="Mensaje clave, tono de voz, promesas, objeciones‚Ä¶" rows="6" style="width:100%; margin-top: 8px;"></textarea>
</div>
<div class="section" id="m-mtab-ofertas" style="display:none">
<div class="row"><input id="offerName" placeholder="Oferta"/><input class="spacer" id="offerURL" placeholder="URL base"/><button class="btn" id="genUTM">Generar UTM</button></div>
<div class="tip" id="utmOut" style="margin-top:6px; word-break: break-all;"></div>
</div>
<div class="section" id="m-mtab-assets" style="display:none">
<div class="row"><b>Repositorio de Marca</b><span class="spacer"></span><button class="btn btn-primary" onclick="$('#mktFileInput').click()"><i data-lucide="upload"></i> Subir Archivos</button><input id="mktFileInput" multiple type="file" style="display:none;"/></div>
<div class="row" id="mktList" style="margin-top:8px"></div>
</div>
</section>
<!-- HUB REDESIGN -->
<section class="panel" id="hub" style="display:none">
<div class="tabs">
<button class="tab active" data-htab="perfil">Mi Perfil Profesional</button>
<button class="tab" data-htab="jobs">Bolsa de Empleos</button>
<button class="tab" data-htab="market">Mercado de Servicios</button>
</div>
<div id="h-htab-perfil">
<div class="hub-grid">
    <div class="profile-card" style="text-align: center;">
        <img alt="avatar" class="avatar" id="avatar" src="https://placehold.co/80x80/dde2ed/0b132a?text=:)"/>
        <h3 id="pNombreDisplay" style="margin: 0;">Tu Nombre</h3>
        <p id="pRoleDisplay" class="muted" style="margin: 4px 0 16px;">Tu Rol Profesional</p>
        <p id="pBioDisplay">Tu biograf√≠a profesional. Habla sobre tu experiencia, tus habilidades y lo que buscas.</p>
        <button class="btn" id="editProfileBtn" style="width: 100%;"><i data-lucide="edit-3"></i> Editar Perfil</button>
    </div>
    <div class="card">
        <b>Portafolio y Enlaces</b>
        <div class="row" style="margin:8px 0"><input class="spacer" id="pfURL" placeholder="URL de tu proyecto, web, LinkedIn..."/><button class="btn" id="addPf">A√±adir Enlace</button></div>
        <div class="listSlim" id="pfList"></div>
    </div>
</div>
</div>
<div id="h-htab-jobs" style="display:none; padding:16px;">
    <div class="card" style="margin-bottom: 16px;">
      <b>Publicar una nueva oferta de empleo</b>
      <div class="row"><input id="jobTitle" placeholder="T√≠tulo del empleo"/><input id="jobCompany" placeholder="Empresa"/><input id="jobPay" placeholder="Pago (Ej: $2000/mes)"/></div>
      <textarea id="jobDesc" placeholder="Descripci√≥n del puesto, requisitos, beneficios..." rows="4" style="width:100%; margin: 8px 0;"></textarea>
      <button class="btn btn-primary" id="addJob">Publicar Empleo</button>
    </div>
    <div class="list-view" id="jobsList"></div>
</div>
<div id="h-htab-market" style="display:none; padding:16px;">
    <div class="card" style="margin-bottom: 16px;">
      <b>Publicar un nuevo producto o servicio</b>
      <div class="row"><input id="mkName" placeholder="Nombre del Producto/Servicio"/><input id="mkPrice" placeholder="Precio (Ej: $500)" type="number"/></div>
      <textarea id="mkDesc" placeholder="Describe tu servicio, qu√© incluye, para qui√©n es ideal..." rows="4" style="width:100%; margin: 8px 0;"></textarea>
      <button class="btn btn-primary" id="addMK">Publicar en Mercado</button>
    </div>
    <div class="list-view" id="mkList"></div>
</div>
</section>
<!-- GLOBAL CHAT -->
<section class="panel" id="gchat" style="display:none">
    <div class="row" style="padding:16px"><b>Chat Global</b><span class="spacer"></span><button class="btn" id="newRoom"><i data-lucide="plus"></i> Sala</button></div>
    <div class="tip" style="margin: 0 16px;"><i data-lucide="info"></i><b>Reglas del Chat:</b> Mant√©n la conversaci√≥n profesional y respetuosa. Este es un espacio para colaborar, hacer networking y mejorar tus habilidades sociales.</div>
    <div class="gchat-grid">
        <div class="card">
            <b>Usuarios Conectados</b>
            <div id="gUserList" class="user-list"></div>
        </div>
        <div>
            <div id="roomLog" class="chat-log" style="height:55vh;overflow:auto;border: 1px solid var(--line); border-radius: var(--radius); padding:10px; background: var(--muted);"></div>
            <div class="row" style="padding:10px 0;"><input class="spacer" id="roomMsg" placeholder="Escribe en #general..."/><button class="btn btn-primary" id="sendRoom"><i data-lucide="send"></i></button></div>
        </div>
    </div>
</section>
<!-- MONETIZATION WIZARD -->
<section class="panel" id="monet" style="display:none; padding: 16px;">
    <div class="row" style="padding-bottom:10px;">
        <b>Asistente de Monetizaci√≥n "Quantum"</b>
        <span class="spacer"></span>
    </div>
    <div id="monet-container"></div>
</section>
<!-- MINDSET -->
<section class="panel" id="mindset" style="display:none; padding: 16px;">
    <div class="row" style="padding-bottom:10px;">
        <b>Balance y Mindset</b>
    </div>
    <div class="tip"><i data-lucide="zap"></i> El √©xito no es solo trabajo duro. Es el balance entre la ambici√≥n, la salud y la calma. Cuida tu mente y tu cuerpo para alcanzar tu m√°ximo potencial.</div>
    <div class="mindset-grid">
        <div class="mindset-card">
            <i data-lucide="wind" style="width:48px; height: 48px; color: var(--accent);"></i>
            <h3>Respira</h3>
            <p class="muted">Toma una pausa consciente. La claridad mental empieza con una respiraci√≥n.</p>
            <div id="breathing-circle">Inhala</div>
            <button class="btn" id="startBreathingBtn">Comenzar Ejercicio</button>
        </div>
        <div class="mindset-card">
            <i data-lucide="move" style="width:48px; height: 48px; color: var(--accent);"></i>
            <h3>Estira y Entrena</h3>
            <p class="muted">Tu cuerpo es tu veh√≠culo. Mantenlo en movimiento para una mente √°gil y creativa.</p>
            <a href="https://www.goatify.app/fit" target="_blank" class="btn btn-primary" style="margin-top: 20px;">
                <i data-lucide="external-link"></i> Ir a goatiFIT
            </a>
            <small class="muted" style="margin-top: 8px;">Rutinas de ejercicio y estiramiento gratuitas.</small>
        </div>
        <div class="mindset-card">
            <i data-lucide="coffee" style="width:48px; height: 48px; color: var(--accent);"></i>
            <h3>Rel√°jate y Dispersa</h3>
            <p class="muted">Desconectar es productivo. Habla con otros, aprende algo nuevo, mejora tus habilidades sociales.</p>
             <button class="btn" onclick="show('gchat')" style="margin-top: 20px;">
                <i data-lucide="messages-square"></i> Ir al Chat Global
            </button>
            <small class="muted" style="margin-top: 8px;">Conecta con otros profesionales.</small>
        </div>
    </div>
</section>
<!-- ADMIN -->
<section class="panel" id="admin" style="display:none">
<div class="tabs">
<button class="tab active" data-atab="publish">Publisher</button>
<button class="tab" data-atab="roles">Roles</button>
<button class="tab" data-atab="data">Data</button>
</div>
<div class="section" id="a-atab-publish">
<div class="row"><input id="tplTitle" placeholder="T√≠tulo de plantilla"/><select id="tplTarget"><option value="marketing">Marketing</option><option value="cronopost">CronoPOST</option><option value="jobs">Jobs</option><option value="market">Mercado</option></select><button class="btn btn-primary" id="pushTpl">Publicar a usuarios</button></div>
<textarea id="tplBody" placeholder="Contenido / instrucci√≥n / preset" rows="5" style="width:100%; margin-top: 8px;"></textarea>
<div class="tip" style="margin-top:8px"><i data-lucide="info"></i> Las plantillas se env√≠an y aparecen autom√°ticamente en la secci√≥n objetivo.</div>
</div>
<div class="section" id="a-atab-roles" style="display:none">
<div class="row"><b>Roles simples</b><span class="spacer"></span><select id="roleSel"><option>Owner</option><option>Admin</option><option>Editor</option><option>Viewer</option></select><button class="btn" id="saveRole">Guardar</button></div>
<div class="tip" id="roleOut" style="margin-top:8px"></div>
</div>
<div class="section" id="a-atab-data" style="display:none">
<div class="row"><button class="btn" id="dumpJSON">Export JSON</button><input accept="application/json" id="importJSON" type="file"/><button class="btn" id="resetApp">Reset total</button></div>
<pre class="section" id="jsonOut" style="white-space:pre-wrap;background:var(--muted);border-radius:12px; max-height: 40vh; overflow: auto;"></pre>
</div>
</section>
<!-- SETTINGS -->
<section class="panel" id="settings" style="display:none;padding:16px">
<div class="row"><b>Ajustes</b><span class="spacer"></span></div>
<div class="hub-grid">
<div class="card">
<b>Preferencias</b>
<div class="row" style="margin-top:8px"><label class="chip"><input checked="" id="setSingleProfile" type="checkbox"/> Forzar perfil √∫nico</label><label class="chip"><input checked="" id="setHints" type="checkbox"/> Mostrar ayudas/contexto</label></div>
<div class="row" style="margin-top:8px"><button class="btn" id="clearHints">Ocultar ayudas</button><button class="btn" id="showHints">Mostrar ayudas</button></div>
</div>
<div class="card">
<b>Import/Export</b>
<div class="row" style="margin-top:8px"><button class="btn" id="btnExport">Exportar .json</button><input accept="application/json" id="btnImport" type="file"/></div>
</div>
</div>
<div class="section tip"><i data-lucide="database"></i> Todo guarda offline en tu navegador (localStorage).</div>
</section>
<!-- MODALS -->
<dialog id="newProjectModal">
    <div style="padding: 24px;">
        <h3 style="margin-top:0">Crear Nuevo Proyecto</h3>
        <p class="muted">Dale un nombre a tu nuevo espacio de trabajo.</p>
        <input id="newProjectName" placeholder="Ej: Lanzamiento de App M√≥vil" style="margin: 16px 0;"/>
        <div class="row">
            <button class="btn" onclick="$('#newProjectModal').close()">Cancelar</button>
            <span class="spacer"></span>
            <button class="btn btn-primary" id="newProjectCreate">Crear Proyecto</button>
        </div>
    </div>
</dialog>
<dialog id="profileModal">
    <div style="padding: 24px;">
        <h3 style="margin-top:0">Editar Perfil Profesional</h3>
        <input id="pNombre" placeholder="Tu nombre" style="margin-top: 8px;"/>
        <input id="pRole" placeholder="Rol (Ej: Frontend Developer)" style="margin: 8px 0;"/>
        <textarea id="pBio" placeholder="Bio corta" rows="3" style="margin-bottom: 8px;"></textarea>
        <div class="row">
            <button class="btn" onclick="$('#profileModal').close()">Cancelar</button>
            <span class="spacer"></span>
            <button class="btn btn-primary" id="savePerfil">Guardar Perfil</button>
        </div>
    </div>
</dialog>
<dialog id="industryModal" style="padding: 0; overflow: hidden;">
    <div style="background: var(--surface); padding: 24px;">
        <div class="row">
            <h2 style="margin: 0;">Bienvenido a Goatify IA v5.4</h2>
            <span class="spacer"></span>
            <button class="btn btn-ghost" onclick="$('#industryModal').close()"><i data-lucide="x"></i></button>
        </div>
        <p class="muted">Para empezar, cu√©ntanos sobre tu negocio. Cargaremos plantillas y herramientas personalizadas para ti.</p>
        <div class="card" style="margin-top: 16px;">
            <b>Elige tu industria principal</b>
            <select id="industrySel" style="width: 100%; margin: 12px 0;">
                <option value="agency">Agencia de Marketing / Servicios Digitales</option>
                <option value="freelancer">Freelancer / Creativo</option>
                <option value="startup">Startup Tecnol√≥gica</option>
                <option value="hostel">Hosteler√≠a (Hoteles, Hostels, Glamping)</option>
                <option value="ecommerce">E-commerce / Tienda Online</option>
                <option value="real_estate">Bienes Ra√≠ces / Construcci√≥n</option>
                <option value="other">Otra</option>
            </select>
            <button class="btn btn-primary" id="loadIndustry" style="width: 100%;">Cargar Plantilla y Empezar</button>
        </div>
    </div>
</dialog>
<dialog id="creditsModal">
    <div style="padding: 24px; text-align: center;">
        <div class="row" style="margin-bottom: 16px;">
            <i data-lucide="sparkles" style="color: var(--brand);"></i>
            <h2 style="margin: 0;">Plan Gratuito y Cr√©ditos</h2>
            <span class="spacer"></span>
            <button class="btn btn-ghost" onclick="$('#creditsModal').close()"><i data-lucide="x"></i></button>
        </div>
        <p class="muted" style="margin-bottom: 16px;">El plan gratuito te da <b>100 cr√©ditos iniciales</b> para probar las funciones de IA. Cuando se acaben, ciertas acciones estar√°n limitadas. Los <b>Intis (‚ú®)</b> son puntos de gamificaci√≥n que ganas al usar la app, ¬°demuestran tu productividad!</p>
        <div class="card" style="text-align: left; margin-bottom: 16px;">
            <h4 style="margin-top:0;">Coste de Acciones con IA</h4>
            <ul>
                <li><b>Generar Ideas con IA (CronoPOST):</b> 1 cr√©dito</li>
                <li><b>Generar Respuesta de Chat IA:</b> 1 cr√©dito</li>
                <li><b>Generar Imagen (Pr√≥ximamente):</b> 5 cr√©ditos</li>
            </ul>
        </div>
         <div class="card" style="text-align: left;">
            <h4 style="margin-top:0;">C√≥mo ganar Intis (‚ú®)</h4>
            <ul>
                <li><b>Crear un proyecto:</b> +50 Intis</li>
                <li><b>Crear una tarea/nota/tabla/etc.:</b> +5 Intis</li>
                <li><b>Completar una tarea:</b> +10 Intis</li>
                <li><b>Publicar en el Hub:</b> +20 Intis</li>
            </ul>
        </div>
        <div class="card" style="text-align: left; background: color-mix(in hsl, var(--brand) 8%, transparent); border-left: 4px solid var(--brand); margin-top: 16px;">
            <h3 style="margin-top:0;">Membres√≠a PRO - $4/mes</h3>
            <ul style="padding-left: 20px;">
                <li>‚úÖ <b>Cr√©ditos Ilimitados</b> para todas las funciones IA.</li>
                <li>‚úÖ <b>Plantillas PRO</b> y estrategias avanzadas.</li>
                <li>‚úÖ <b>Soporte prioritario</b> por email.</li>
                <li>‚úÖ Acceso anticipado a <b>nuevas funcionalidades</b>.</li>
            </ul>
        </div>
        <button class="btn btn-primary" style="width: 100%; margin-top: 16px; padding: 12px;">Obtener Goatify PRO (Demo)</button>
    </div>
</dialog>

<!-- TOAST NOTIFICATION -->
<div id="toast" class="info"></div>
</main>
</div>
<script>
// ====== State ======
var S = {
  version:'5.4',
  industry: null,
  projects: [],
  activeProject: null,
  activeNav: 'hub',
  folders: {},
  tasks: {},
  chats: {},
  tables: {},
  notes: {},
  drawings: {},
  files: {},
  fin: {},
  overview: {},
  cronopost: { ideas: {}, posts: {} },
  marketing: { brief:{}, ofertas:[], assets:[]},
  hub: { perfil:null, portafolio:[], jobs:[], market:[] },
  chat: { 
    rooms:[{id:'r1', name: '#general'}, {id:'r2', name: '#marketing'}, {id:'r3', name: '#random'}], 
    messages:{'r1': [], 'r2':[], 'r3':[]}, 
    activeRoom: 'r1',
    users: [ {name: 'Ana', online: true}, {name: 'Carlos', online: false}, {name: 'Elena', online: true}, {name: 'David', online: true} ]
  },
  monet: { completedSteps: [] },
  admin: { role:'Owner' },
  wallet: { movs:[] },
  intis: 100,
  credits: 100,
  hints:true,
  singleProfile:true,
};
const initialState = JSON.parse(JSON.stringify(S));
const projectColors = ['#38bdf8', '#fbbf24', '#22c55e', '#a78bfa', '#f87171', '#60a5fa', '#f472b6'];

function save(){ localStorage.setItem('goatify_v54', JSON.stringify(S)); syncHeader(); }
function load(){
  const raw = localStorage.getItem('goatify_v54');
  if(raw){  
      try {
        const loadedState = JSON.parse(raw);
        if (loadedState && typeof loadedState === 'object') {
            Object.assign(S, loadedState);
        }
      } catch (e) {
        console.error("Error parsing saved state:", e);
        localStorage.removeItem('goatify_v54');
      }
  }
  syncHeader();
}
function syncHeader(){
  const w = (S.wallet.movs || []).reduce((a,m)=>a+(m.tipo==='Ingreso'?+m.monto:-m.monto),0);
  $('#wallet-amount').textContent = '$'+w.toFixed(2);
  $('#intis-amount').textContent = S.intis;
  $('#credits-amount').textContent = `${S.credits} cr√©ditos`;
  $('#creditsChip').style.color = S.credits > 0 ? 'var(--text)' : 'var(--danger)';
}

// ====== Helpers ======
const $ = sel=>document.querySelector(sel);
const $$ = sel=>Array.from(document.querySelectorAll(sel));
function el(tag, attrs={}, ...kids){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='dataset'){ Object.entries(v).forEach(([dk,dv])=>e.dataset[dk]=dv); }
    else if(k==='html'){ e.innerHTML = v; }
    else if(k==='text'){ e.textContent = v; }
    else if(k.startsWith('on')) { e[k] = v; }
    else e.setAttribute(k,v);
  });
  kids.forEach(k=>{ if(k) e.append(k); });
  return e;
}
function todayISO(){ return new Date().toISOString().slice(0,10); }
function fmtDate(d){ const dt = new Date(d); return dt.toLocaleString('es-EC', { dateStyle: 'short', timeStyle: 'short' }); }
function csv(rows){ return rows.map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n'); }
function download(filename, text){
  const a = el('a',{href:URL.createObjectURL(new Blob([text],{type:'text/plain'})), download:filename});
  document.body.appendChild(a); a.click(); a.remove();
}
function monthGrid(ref=new Date()){
  const y=ref.getFullYear(), m=ref.getMonth();
  const first=new Date(y,m,1);
  const start = new Date(first); start.setDate(1-((first.getDay()+6)%7));
  const days=[]; let cur=new Date(start);
  while(days.length < 42){
    days.push(new Date(cur));
    cur.setDate(cur.getDate()+1);
  }
  return days;
}
let toastTimeout;
function showToast(message, type = 'info') {
    const toast = $('#toast');
    if (!toast) return;
    toast.textContent = message;
    toast.className = '';
    toast.classList.add(type, 'show');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => {
        toast.classList.remove('show');
    }, 2500);
}
function addIntis(points, reason) {
    S.intis += points;
    save();
    showToast(`+${points} Intis ‚ú® (${reason})`, 'info');
}
function useCredit(amount) {
    if (S.credits < amount) {
        showToast('Cr√©ditos de IA agotados. ¬°Actualiza a PRO!', 'warn');
        $('#creditsModal').showModal();
        return false;
    }
    S.credits -= amount;
    save();
    showToast(`-${amount} cr√©dito utilizado`, 'info');
    return true;
}

// ====== UI: Navigation & Title ======
function renderAside(){
  const list = $('#projList'); list.innerHTML='';
  S.projects.forEach(p=>{
    const item = el('div',{class:'projItem', dataset: {id: p.id}}, 
        el('span', {style: `width: 12px; height: 12px; border-radius: 50%; background-color: ${p.color || 'var(--brand)'}`}),
        el('span',{text:p.name, style:'flex:1', onclick: ()=> openProject(p.id)}),
        el('div', {class: 'proj-actions'},
            el('button', {class: 'btn btn-ghost', onclick: (e) => { e.stopPropagation(); renameProject(p.id); }}, el('i', {'data-lucide': 'edit-3', 'width': 16})),
            el('button', {class: 'btn btn-ghost', onclick: (e) => { e.stopPropagation(); deleteProject(p.id); }}, el('i', {'data-lucide': 'trash-2', 'width': 16}))
        )
    );
    if (p.id === S.activeProject) item.classList.add('active');
    list.appendChild(item);
  });
  lucide.createIcons();
  $$('.navBtn[data-nav]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.nav === S.activeNav && !S.activeProject);
  });
}
function show(sectionId){
  $$('main > section').forEach(s => s.style.display = 'none');
  const s = $('#'+sectionId);  
  if(s) s.style.display='flex';
  S.activeNav = sectionId;
  S.activeProject = null;
  save();
  renderAside();
  updateTitle();
  document.body.classList.remove('aside-open');
}
function openProject(id){
  S.activeProject = id;
  S.activeNav = null;
  save();
  $$('main > section').forEach(s => s.style.display = 'none');
  $('#projectShell').style.display='flex';
  const p = S.projects.find(x=>x.id===id);
  $('#projectNameChip').textContent = p?.name || 'Proyecto';
  const selOptions = (S.folders[id]||['General']).map(f=>el('option',{text:f}));
  ['#folderSel', '#qaFolder', '#noteFolder'].forEach(selId => {
      const sel = $(selId);
      if (sel) {
        sel.innerHTML = '';
        selOptions.forEach(opt => sel.append(opt.cloneNode(true)));
      }
  });
  renderAside();
  updateTitle();
  renderProject();
  const firstTab = $('#projectShell .tabs .tab[data-ptab="overview"]');
  firstTab?.click();
}
function renderProject() {
    renderOverview(); renderTasks(); renderCalendar(); renderTables(); renderNotes(); renderDrawings(); renderFiles(); renderProjectChat(); renderFin();
}
function updateTitle() {
    if (S.activeProject) {
        const p = S.projects.find(x => x.id === S.activeProject);
        document.title = `Goatify | ${p?.name || 'Proyecto'}`;
    } else if (S.activeNav) {
        const navBtn = $(`.navBtn[data-nav="${S.activeNav}"]`);
        document.title = `Goatify | ${navBtn?.textContent.trim() || 'Dashboard'}`;
    } else {
        document.title = 'Goatify IA v5.4 ‚Äî Edici√≥n Definitiva';
    }
}
function wireTabs(scopeSelector, prefix, contentPrefix, callback){
  const root=$(scopeSelector);
  if (!root) return;
  root.querySelectorAll(`.tabs .tab[data-${prefix}]`).forEach(btn=>{
    btn.addEventListener('click',()=>{
      root.querySelectorAll(`.tabs .tab[data-${prefix}]`).forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset[prefix];
      root.querySelectorAll(`[id^="${contentPrefix}-"]`).forEach(p=>p.style.display='none');
      const pane = root.querySelector(`#${contentPrefix}-${target}`);
      if(pane) {
          if(['calendar', 'drawings'].includes(target)){
              pane.style.display='flex';
              pane.style.flexDirection='column';
          } else {
              pane.style.display='block';
          }
      }
      if(callback) callback(target);
    });
  });
}

// ====== Projects CRUD ======
function createNewProject() {
    const nameInput = $('#newProjectName');
    const name = nameInput.value.trim();
    if(!name) { showToast('Por favor, ingresa un nombre para el proyecto.', 'warn'); return; }
    const id = 'p' + Date.now();
    const color = projectColors[S.projects.length % projectColors.length];
    S.projects.push({id, name, color});  
    S.folders[id]=['General']; S.tasks[id]=[]; S.notes[id]={list:[], active:null, bodies:{}}; S.drawings[id]={list:[], active:null, bodies:{}}; S.chats[id]={threads:[], messages:{}, activeThread: null}; S.fin[id]={rows:[]}; S.tables[id]={list:[], active:null, bodies:{}}; S.files[id]=[]; S.cronopost.ideas[id] = [];
    addIntis(50, 'Nuevo Proyecto');
    save(); renderAside(); openProject(id);
    nameInput.value = ''; $('#newProjectModal').close();
}
function renameProject(id) {
    const proj = S.projects.find(p => p.id === id);
    if (!proj) return;
    const newName = prompt('Nuevo nombre del proyecto:', proj.name);
    if (newName && newName.trim()) {
        proj.name = newName.trim();
        save(); renderAside();
        if (S.activeProject === id) {
            $('#projectNameChip').textContent = proj.name; updateTitle();
        }
    }
}
function deleteProject(id) {
    if (confirm('¬øEst√°s seguro de que quieres eliminar este proyecto y todos sus datos? Esta acci√≥n es irreversible.')) {
        S.projects = S.projects.filter(p => p.id !== id);
        delete S.tasks[id]; delete S.folders[id]; delete S.notes[id]; delete S.drawings[id]; delete S.chats[id]; delete S.fin[id]; delete S.tables[id]; delete S.files[id]; delete S.cronopost.ideas[id];
        Object.keys(S.cronopost.posts).forEach(date => { S.cronopost.posts[date] = S.cronopost.posts[date].filter(p => p.projectId !== id); });
        if (S.activeProject === id) { S.activeProject = null; show('hub'); }
        addIntis(5, 'Proyecto eliminado'); save(); renderAside();
    }
}

// ====== PROJECT SUB-MODULES ======
function renderOverview(){
  const id=S.activeProject; if(!id) return;
  const wrap=$('#ovr'); wrap.innerHTML = '';
  const tasks = S.tasks[id] || [];
  const finance = S.fin[id] || {rows:[]};
  const files = S.files[id] || [];
  const done = tasks.filter(x=>x.status==='Hecho').length;
  const totalTasks = tasks.length;
  const progress = totalTasks > 0 ? Math.round(done/totalTasks*100) : 0;
  const sumIn=finance.rows.filter(x=>x.tipo==='Ingreso').reduce((a,b)=>a+Number(b.monto),0);
  const sumOut=finance.rows.filter(x=>x.tipo==='Egreso').reduce((a,b)=>a+Number(b.monto),0);
  const balance = sumIn - sumOut;
  const navigateToTab = (tabName) => $(`#projectShell .tabs .tab[data-ptab="${tabName}"]`).click();
  
  wrap.append(
    el('div',{class:'stat-card', onclick: () => navigateToTab('tasks')}, 
      el('h4', {text:'Progreso de Tareas'}), el('p', {text:`${progress}%`}),
      el('div', {style:'width: 100%; background: var(--line); border-radius: 99px; height: 8px; margin-top: 8px;'}, el('div', {style: `width: ${progress}%; background: var(--success); height: 100%; border-radius: 99px;`}))
    ),
    el('div',{class:'stat-card', onclick: () => navigateToTab('tasks')}, el('h4', {text:'Tareas Totales'}), el('p', {text: totalTasks})),
    el('div',{class:'stat-card', onclick: () => navigateToTab('finance')}, el('h4', {text:'Balance Neto'}), el('p', {text: `$${balance.toFixed(2)}`, style: `color: ${balance >= 0 ? 'var(--success)' : 'var(--danger)'}`})),
    el('div',{class:'stat-card', onclick: () => navigateToTab('files')}, el('h4', {text:'Archivos'}), el('p', {text: files.length}))
  );
}

function renderTasks(){
  const id=S.activeProject; if(!id) return;
  const tasks=S.tasks[id]||[];
  const cols=['Backlog','En curso','Bloqueado','Hecho'];
  
  const colEl=$('#kanban'); colEl.innerHTML='';
  cols.forEach(c=>{
    const cEl=el('div',{class:'col',dataset:{status:c}}, el('div',{class:'row'}, el('b',{text:c}), el('span',{class:'spacer'})));
    cEl.ondragover=e=>{e.preventDefault(); cEl.classList.add('dragover');};
    cEl.ondragleave=()=>cEl.classList.remove('dragover');
    cEl.ondrop=e=>{
      cEl.classList.remove('dragover');
      const tid=e.dataTransfer.getData('text'); const t=tasks.find(x=>x.id===tid);
      if (t) { t.status=c; addIntis(2, 'Tarea movida'); save(); renderTasks(); renderOverview(); }
    };
    tasks.filter(t=>t.status===c).forEach(t=>{
      const tEl=el('div',{class:'task',draggable:'true', ondblclick: () => editTask(t.id)},
        el('div',{class: 'row'},
            el('span',{text:t.title, style: 'flex: 1;'}),
            el('button', {class:'btn btn-ghost', style: 'padding: 4px;', onclick: (e) => { e.stopPropagation(); deleteTask(t.id);}}, el('i', {'data-lucide':'trash-2', width:14}))
        ),
        el('small',{class:'sub',text:(t.pri||'')+(t.due? ' ‚Ä¢ '+new Date(t.due).toLocaleDateString():'')}));
      tEl.ondragstart=e=>e.dataTransfer.setData('text',t.id);
      cEl.appendChild(tEl);
    });
    colEl.appendChild(cEl);
  });
  
  const tbody=$('#listBody'); tbody.innerHTML='';
  const headers = ['‚úì', 'Tarea', 'Prioridad', 'Vence', 'Asignado', 'Estado', 'Subcarpeta', ''];
  tasks.forEach(t=>{
    const tr=el('tr', {},
      el('td',{}, el('input',{type:'checkbox',checked:t.status==='Hecho',onchange:()=>{
          t.status=t.status==='Hecho'?'Backlog':'Hecho'; 
          if(t.status === 'Hecho') addIntis(10, 'Tarea completada');
          save(); renderTasks(); renderOverview();
      }})),
      el('td',{text:t.title, ondblclick: (e) => inlineEdit(e.target, t.id, 'title')}),
      el('td',{ondblclick: (e) => inlineEdit(e.target, t.id, 'pri', ['Baja', 'Media', 'Alta'])}, el('span', {class: 'chip', text: t.pri})),
      el('td',{text:t.due ? new Date(t.due).toLocaleDateString() : '-', ondblclick: (e) => inlineEdit(e.target, t.id, 'due', 'date')}),
      el('td',{text:t.asg||'-', ondblclick: (e) => inlineEdit(e.target, t.id, 'asg')}),
      el('td',{ondblclick: (e) => inlineEdit(e.target, t.id, 'status', cols)}, el('span', {class: 'chip', text: t.status})),
      el('td',{text:t.folder, ondblclick: (e) => inlineEdit(e.target, t.id, 'folder', S.folders[id])}),
      el('td', {}, el('button', {class:'btn btn-ghost', onclick: () => deleteTask(t.id)}, el('i', {'data-lucide': 'trash-2', width:16})))
    );
    $$('td', tr).forEach((td, i) => { if(headers[i]) td.dataset.label = headers[i]; });
    tbody.appendChild(tr);
  });
  lucide.createIcons();
}
function deleteTask(taskId) {
    if (!confirm('¬øSeguro que quieres eliminar esta tarea?')) return;
    const projId = S.activeProject;
    if (!projId || !S.tasks[projId]) return;
    S.tasks[projId] = S.tasks[projId].filter(t => t.id !== taskId);
    save(); renderTasks(); renderOverview(); showToast('Tarea eliminada', 'success');
}
function editTask(taskId) {
    const projId = S.activeProject;
    const task = S.tasks[projId].find(t => t.id === taskId);
    if (!task) return;
    const newTitle = prompt('Editar t√≠tulo de la tarea:', task.title);
    if (newTitle !== null) { task.title = newTitle; save(); renderTasks(); }
}
function inlineEdit(cell, taskId, field, options = null) {
    const originalHTML = cell.innerHTML;
    cell.innerHTML = '';
    let editor;
    const task = S.tasks[S.activeProject].find(t => t.id === taskId);

    const saveChange = () => {
        let newValue = editor.value;
        if (options === 'date' && newValue) {
            newValue = new Date(newValue).toISOString();
        }
        task[field] = newValue;
        addIntis(1, 'Tarea editada');
        save(); renderTasks();
    };

    if (Array.isArray(options)) {
        editor = el('select', {class:'btn'}, ...options.map(o => el('option', {text: o, selected: o === task[field]})));
    } else if (options === 'date') {
        editor = el('input', {type: 'date'});
        editor.value = task.due ? task.due.split('T')[0] : '';
    } else {
        editor = el('input', {value: task[field]});
    }

    editor.onblur = saveChange;
    editor.onkeydown = (e) => {
        if (e.key === 'Enter') saveChange();
        if (e.key === 'Escape') cell.innerHTML = originalHTML;
    };
    cell.appendChild(editor);
    editor.focus();
}

$('#qaCreate').onclick = () => {
  const id=S.activeProject; if(!id) return;
  const title=$('#qaTitle').value.trim(); if(!title) return;
  const t={id:'t'+Date.now(), title, status:'Backlog', pri:$('#qaPriority').value, due:$('#qaDue').value, asg:'', folder:$('#qaFolder').value||'General'};
  (S.tasks[id]=S.tasks[id]||[]).push(t);
  addIntis(5, 'Tarea creada');
  save(); $('#qaTitle').value=''; renderTasks(); renderOverview(); renderCalendar();
};

let calRef=new Date();
function renderCalendar(){
  const id=S.activeProject; if(!id) return;
  $('#monthLbl').textContent = calRef.toLocaleString('es', {month:'long', year:'numeric'});
  const grid=$('#calGrid'); grid.innerHTML='';
  const header = $('#calGridContainer .calendar-header'); header.innerHTML = '';
  ['L', 'M', 'X', 'J', 'V', 'S', 'D'].forEach(day => header.append(el('div', { text: day })));

  monthGrid(calRef).forEach(d=>{
    const dateStr = d.toISOString().split('T')[0];
    const day=el('div',{class:'day', dataset:{date: dateStr}});
    if(d.getMonth() !== calRef.getMonth()) day.classList.add('other-month');
    day.append(el('div',{class:'day-number',text:d.getDate()}));
    (S.tasks[id]||[]).filter(t=>t.due && new Date(t.due).toDateString()===d.toDateString()).forEach(t=>{
      day.append(el('div',{class:'cp-post', draggable: true, text:t.title, dataset: {id: t.id},
        ondragstart: e => e.dataTransfer.setData('text/plain', JSON.stringify({type: 'task', id: t.id}))
      }));
    });
    day.ondblclick = () => {
        const title = prompt(`Nueva tarea para ${dateStr}:`);
        if (!title) return;
        S.tasks[id].push({id:'t'+Date.now(), title, status:'Backlog', pri:'Media', due: new Date(dateStr).toISOString()});
        addIntis(5, 'Tarea creada desde calendario');
        save(); renderCalendar(); renderTasks();
    };
    day.ondragover = e => e.preventDefault();
    day.ondrop = e => {
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        if (data.type === 'task') {
            const task = S.tasks[id].find(t => t.id === data.id);
            if (task) {
                task.due = new Date(dateStr).toISOString();
                save(); renderCalendar(); renderTasks();
            }
        }
    };
    grid.append(day);
  });
}
function renderTables(){
  const id=S.activeProject; if(!id) return;
  const T=S.tables[id]||(S.tables[id]={list:[], active:null, bodies:{}});
  
  const sel = $('#tableSel'); sel.innerHTML = '';
  if(T.list.length === 0) sel.style.display = 'none';
  else sel.style.display = 'inline-flex';
  T.list.forEach(t => sel.append(el('option', {value: t.id, text: t.title, selected: t.id === T.active})));
  
  const wrap=$('#sheetWrap'); wrap.innerHTML='';
  if (!T.active || !T.bodies[T.active]) {
      wrap.innerHTML = `<div class="empty-state"><i data-lucide="table-2"></i><h4>No hay tablas seleccionadas.</h4><p>Crea o selecciona una tabla para empezar.</p></div>`;
      lucide.createIcons(); return;
  }
  const data = T.bodies[T.active];
  const tbl=el('table',{style:'width:100%; border-collapse: collapse;'});
  const thead=el('thead',{}, el('tr',{}, ...(data.cols||[]).map(c=>el('th',{text:c, style:'border: 1px solid var(--line); padding: 8px;'}))));
  const tbody=el('tbody',{});
  (data.rows || []).forEach(r=>{
    const tr=el('tr',{}, ...(data.cols||[]).map((c,ci)=>el('td',{style:'border: 1px solid var(--line); padding: 0;'}, el('input',{value:r[ci]||'', style:'border:none; background:transparent; padding: 8px; width: 100%;', onchange:(e)=>{r[ci]=e.target.value; save();}}))));
    tbody.appendChild(tr);
  });
  tbl.append(thead,tbody);
  wrap.append(tbl);
}
function renderNotes(){
    const id=S.activeProject; if(!id) return;
    const N=S.notes[id]||(S.notes[id]={list:[], active:null, bodies:{}});
    const list=$('#noteList'); list.innerHTML='';
    if (N.list.length === 0) {
        list.innerHTML = `<p class="muted" style="padding: 10px;">No hay notas aqu√≠. ¬°Crea la primera!</p>`;
    } else {
        N.list.forEach(n=>{
            const it=el('div',{class:'projItem', text:n.title, onclick:()=>{N.active=n.id; save(); renderNotes();}});
            if(n.id===N.active) it.classList.add('active');
            list.append(it);
        });
    }
    if(!N.active && N.list.length > 0) N.active=N.list[0].id;
    const editor = $('#noteEditor');
    editor.innerHTML = (N.active? (N.bodies[N.active]||'') : 'Selecciona o crea una nota para empezar a escribir.');
    editor.oninput=()=>{ if(N.active){ N.bodies[N.active]=editor.innerHTML; save(); } };
}
let drawingCtx, isDrawing = false, lastX, lastY;
function renderDrawings() {
    const id = S.activeProject; if (!id) return;
    const D = S.drawings[id] || (S.drawings[id] = { list: [], active: null, bodies: {} });
    const sel = $('#drawingSel'); sel.innerHTML = '';
    sel.style.display = D.list.length > 0 ? 'inline-flex' : 'none';
    D.list.forEach(d => sel.append(el('option', { value: d.id, text: d.title, selected: d.id === D.active })));

    const canvas = $('#drawingCanvas');
    const container = canvas.parentElement;
    if (container.offsetWidth === 0) return; // Don't render if not visible
    canvas.width = container.offsetWidth;
    canvas.height = 400; 
    drawingCtx = canvas.getContext('2d');
    
    if (D.active && D.bodies[D.active]) {
        const img = new Image();
        img.onload = () => drawingCtx.drawImage(img, 0, 0);
        img.src = D.bodies[D.active];
    } else {
        drawingCtx.clearRect(0, 0, canvas.width, canvas.height);
    }
}
function renderFiles(){
  const id=S.activeProject; if(!id) return;
  const L=S.files[id]||[]; const wrap=$('#fileList'); wrap.innerHTML='';
  if (L.length === 0) {
      wrap.innerHTML = `<div class="empty-state"><i data-lucide="file-stack"></i><h4>Este proyecto no tiene archivos.</h4><p>Sube documentos, im√°genes o cualquier recurso relevante.</p></div>`;
      lucide.createIcons();
      return;
  }
  L.forEach((f,idx)=>{
      const fileChip = el('div', {class:'chip'},  
        el('a',{href:f.url,download:f.name, text:f.name}),
        el('button', {class: 'btn btn-ghost', text:'üóë', onclick:()=>{ L.splice(idx,1); addIntis(1,'Archivo eliminado'); save(); renderFiles(); }})
      );
      wrap.append(fileChip);
  });
}
function renderProjectChat() {
    const pid = S.activeProject; if (!pid) return;
    const C = S.chats[pid] || (S.chats[pid] = { threads: [], messages: {}, activeThread: null });
    const list = $('#chatList'); list.innerHTML = '';
    if (C.threads.length === 0) {
        list.innerHTML = `<p class="muted" style="padding: 10px;">Inicia una conversaci√≥n con la IA.</p>`;
    } else {
        C.threads.forEach(th => {
            const it = el('div', { class: 'projItem', dataset: { id: th.id }, text: th.title, onclick: () => { C.activeThread = th.id; save(); renderProjectChat(); } });
            if (th.id === C.activeThread) it.classList.add('active');
            list.append(it);
        });
    }

    if (!C.activeThread && C.threads.length > 0) C.activeThread = C.threads[0].id;
    const log = $('#chatLog'); log.innerHTML = '';
    if (C.activeThread) {
        (C.messages[C.activeThread] || []).forEach(m => {
            const div = el('div', {style:'margin-bottom: 8px;'}, el('small', { class: 'sub', text: `${m.who} ‚Ä¢ ${new Date(m.at).toLocaleTimeString()}` }), el('div', { text: m.text, style:'background: var(--surface); padding: 8px; border-radius: 8px;'}));
            log.append(div);
        });
        log.scrollTop = log.scrollHeight;
    } else {
        log.innerHTML = `<div class="empty-state" style="padding: 20px;"><h4>Selecciona o crea un hilo</h4></div>`;
    }
    lucide.createIcons();
}
function renderFin(){
  const id=S.activeProject; if(!id) return;
  const F=S.fin[id]||(S.fin[id]={rows:[]}); const tbody=$('#finTable tbody'); tbody.innerHTML='';
  const headers = ['Fecha', 'Tipo', 'Monto', 'Categor√≠a', 'Nota', ''];
  F.rows.forEach((r,i)=>{
    const tr=el('tr',{}, 
        el('td',{text:fmtDate(r.fecha)}), 
        el('td',{text:r.tipo}), 
        el('td',{text:'$'+Number(r.monto).toFixed(2), style:'text-align:right;'}), 
        el('td',{text:r.cat}), 
        el('td',{text:r.nota}),
        el('td',{}, el('button',{class:'btn btn-ghost',text:'üóë',onclick:()=>{F.rows.splice(i,1); save(); renderFin(); renderOverview();}}))
    );
    $$('td', tr).forEach((td, i) => { if(headers[i]) td.dataset.label = headers[i]; });
    tbody.appendChild(tr);
  });
  const sumIn=F.rows.filter(x=>x.tipo==='Ingreso').reduce((a,b)=>a+Number(b.monto),0);
  const sumOut=F.rows.filter(x=>x.tipo==='Egreso').reduce((a,b)=>a+Number(b.monto),0);
  $('#finIn').textContent='$'+sumIn.toFixed(2);
  $('#finOut').textContent='$'+sumOut.toFixed(2);
  $('#finBal').textContent='$'+(sumIn-sumOut).toFixed(2);
}

// ====== GLOBAL MODULES ======
let cpRef = new Date();
function renderCronoPOST() {
    $('#cpMonthLbl').textContent = cpRef.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
    const projectFilter = $('#cpProjectFilter');
    const currentFilterValue = projectFilter.value;
    projectFilter.innerHTML = '';
    projectFilter.append(el('option', {value: 'all', text: 'Todos los Proyectos'}));
    S.projects.forEach(p => projectFilter.append(el('option', {value: p.id, text: p.name})));
    projectFilter.value = (S.projects.some(p => p.id === currentFilterValue)) ? currentFilterValue : 'all';
    
    const calendarEl = $('#cpCalendar'); calendarEl.innerHTML = '';
    const calendarHeader = $('#cpCalendarContainer .calendar-header');
    if (!calendarHeader) return;
    calendarHeader.innerHTML = '';
    ['L', 'M', 'X', 'J', 'V', 'S', 'D'].forEach(day => calendarHeader.append(el('div', { text: day })));

    monthGrid(cpRef).forEach(d => {
        const dateStr = d.toISOString().split('T')[0];
        const dayEl = el('div', { class: 'day', dataset: { date: dateStr }});
        if (d.getMonth() !== cpRef.getMonth()) dayEl.classList.add('other-month');
        dayEl.append(el('div', { class: 'day-number', text: d.getDate() }));
        
        const selectedProjectId = projectFilter.value;
        const projectsToDisplay = selectedProjectId === 'all' ? S.projects : S.projects.filter(p => p.id === selectedProjectId);

        projectsToDisplay.forEach(proj => {
            (S.tasks[proj.id] || []).forEach(task => {
                if (task.due && new Date(task.due).toDateString() === d.toDateString()) {
                    const taskEl = el('div', { class: 'cp-post', text: task.title, style: `border-color: ${proj.color}; opacity: 0.7;`});
                    dayEl.append(taskEl);
                }
            });
        });

        const postsForDay = S.cronopost.posts[dateStr] || [];
        postsForDay.filter(p => selectedProjectId === 'all' || p.projectId === selectedProjectId)
        .forEach(p => {
            const project = S.projects.find(proj => proj.id === p.projectId);
            const postEl = el('div', {
                class: 'cp-post', draggable: 'true', text: p.title, dataset: { id: p.id },
                style: `border-color: ${project ? project.color : 'var(--brand)'};`,
                ondragstart: e => e.dataTransfer.setData('text/plain', JSON.stringify({type: 'post', id: p.id, from: dateStr}))
            });
            dayEl.append(postEl);
        });
        
        if (selectedProjectId !== 'all') {
            dayEl.ondragover = e => { e.preventDefault(); dayEl.style.background = 'var(--muted)'; };
            dayEl.ondragleave = () => { dayEl.style.background = 'var(--surface)'; };
            dayEl.ondrop = e => { handleDrop(e, dateStr); dayEl.style.background = 'var(--surface)'; };
        }
        calendarEl.append(dayEl);
    });
    
    renderCronoPOSTIdeas();
}

function renderCronoPOSTIdeas() {
    const ideasList = $('#cpIdeasList');
    const ideasProjectName = $('#cpIdeasProjectName');
    const selectedProjectId = $('#cpProjectFilter').value;
    const activeProjectForIdeas = S.projects.find(p => p.id === selectedProjectId);
    
    ideasList.innerHTML = '';
    if (selectedProjectId !== 'all' && activeProjectForIdeas) {
        ideasProjectName.textContent = activeProjectForIdeas.name;
        ideasProjectName.style.display = 'inline-flex';
        const ideas = S.cronopost.ideas[selectedProjectId] || [];
        if (ideas.length === 0) {
            ideasList.innerHTML = `<div class="empty-state" style="padding: 20px 0; border:none;"><i data-lucide="lightbulb"></i><p>No hay ideas para este proyecto.</p></div>`;
        } else {
            ideas.forEach(idea => {
                const ideaEl = el('div', {
                    class: 'cp-idea', draggable: 'true', text: idea.title, dataset: { id: idea.id },
                    ondragstart: e => e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'idea', id: idea.id, projectId: selectedProjectId }))
                });
                ideasList.append(ideaEl);
            });
        }
        $('#cpNewIdeaInput').disabled = false;
        $('#cpAddIdeaBtn').disabled = false;
        $('#cpGenAIIdeas').disabled = false;
    } else {
        ideasProjectName.style.display = 'none';
        ideasList.innerHTML = `<div class="empty-state" style="padding: 20px 0; border:none;"><i data-lucide="filter"></i><p>Selecciona un proyecto para ver y a√±adir ideas.</p></div>`;
        $('#cpNewIdeaInput').disabled = true;
        $('#cpAddIdeaBtn').disabled = true;
        $('#cpGenAIIdeas').disabled = true;
    }
     lucide.createIcons();
}
function handleDrop(e, targetDate) {
    e.preventDefault();
    try {
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        if (data.type === 'idea') {
            const projectId = data.projectId;
            if (!projectId) return;

            const ideaIndex = (S.cronopost.ideas[projectId] || []).findIndex(i => i.id === data.id);
            if (ideaIndex > -1) {
                const [idea] = S.cronopost.ideas[projectId].splice(ideaIndex, 1);
                const newPost = { id: 'cp' + Date.now(), title: idea.title, projectId: projectId };
                if (!S.cronopost.posts[targetDate]) S.cronopost.posts[targetDate] = [];
                S.cronopost.posts[targetDate].push(newPost);
                addIntis(10, 'Post agendado');
            }
        } else if (data.type === 'post') {
            const fromDate = data.from;
            const postIndex = (S.cronopost.posts[fromDate] || []).findIndex(p => p.id === data.id);
            if (postIndex > -1) {
                const [post] = S.cronopost.posts[fromDate].splice(postIndex, 1);
                if (!S.cronopost.posts[targetDate]) S.cronopost.posts[targetDate] = [];
                S.cronopost.posts[targetDate].push(post);
            }
        }
        save();
        renderCronoPOST();
    } catch (err) { console.error("Drop failed:", err); }
}
function renderMkt(){
    const M = S.marketing;
    $('#brandName').value = M.brief?.brand || '';
    $('#target').value = M.brief?.target || '';
    $('#funnel').value = M.brief?.funnel || 'Awareness';
    $('#briefNotes').value = M.brief?.notes || '';
    const list = $('#mktList'); list.innerHTML=''; 
    (M.assets || []).forEach(a=>list.append(el('a',{class:'chip',href:a.url,download:a.name,text:a.name})));
}
function renderHub(){
  const H = S.hub;
  const P=H.perfil;
  $('#pNombreDisplay').textContent=P?.nombre||'Tu Nombre';
  $('#pRoleDisplay').textContent=P?.rol||'Tu Rol Profesional';
  $('#pBioDisplay').textContent=P?.bio||'Tu biograf√≠a profesional.';
  const pf=$('#pfList'); pf.innerHTML=''; (H.portafolio||[]).forEach((x,i)=>pf.append(el('div',{class:'projItem'}, el('a',{href:x.url,text:x.url,target:'_blank'}), el('div',{class:'spacer'}), el('button',{class:'btn btn-ghost',text:'üóë',onclick:()=>{H.portafolio.splice(i,1); save(); renderHub();}}))));
  const jl=$('#jobsList'); jl.innerHTML=''; (H.jobs||[]).forEach((j,i)=>jl.append(el('div',{class:'job-item'}, el('div', {class: 'row'}, el('b',{text:j.title}), el('span', {class: 'chip', text: j.company || 'Empresa'})), el('p', {text: j.desc || '', class: 'muted'}), el('div',{class:'row'}, el('span',{class:'sub',text:j.pay}), el('div',{class:'spacer'}), el('button',{class:'btn',text:'Postular'}), el('button',{class:'btn btn-ghost',text:'üóë',onclick:()=>{H.jobs.splice(i,1); save(); renderHub();}})) )));
  const mk=$('#mkList'); mk.innerHTML=''; (H.market||[]).forEach((m,i)=>mk.append(el('div',{class:'market-item'}, el('b',{text:m.name}), el('p', {text: m.desc || '', class: 'muted'}), el('div',{class:'row'}, el('span',{class:'sub', text:'Precio: $'+m.price}), el('div',{class:'spacer'}), el('button',{class:'btn',text:'Contactar'}), el('button',{class:'btn btn-ghost',text:'üóë',onclick:()=>{H.market.splice(i,1); save(); renderHub();}})) )));
}
function renderChat(){
    const C = S.chat;
    const userList = $('#gUserList'); userList.innerHTML = '';
    const myName = S.hub.perfil?.nombre || 'T√∫';
    userList.append(el('div', {class: 'user-item'}, el('div', {class: 'presence-dot online'}), el('b', {text: `${myName} (T√∫)`})));
    (C.users || []).forEach(u => userList.append(el('div', {class: 'user-item'}, el('div', {class: `presence-dot ${u.online ? 'online' : 'offline'}`}), el('span', {text: u.name}))));

    const log = $('#roomLog'); log.innerHTML = '';
    const activeRoomId = C.activeRoom || 'r1';
    (C.messages[activeRoomId] || []).forEach(m => {
        const msgWrapper = el('div', {class: 'msg'});
        if (m.who === myName) { msgWrapper.classList.add('mine'); msgWrapper.style.textAlign = 'right'; }
        msgWrapper.append(el('div', {}, el('small', {text: `${m.who} ‚Ä¢ ${new Date(m.at).toLocaleTimeString()}`}), el('div', {class: 'msg-body', text: m.text})));
        log.append(msgWrapper);
    });
    log.scrollTop = log.scrollHeight;
}
function renderMonetization() {
    const steps = [
        { id: 'idea', title: '1. Valida tu Idea', content: 'Encuentra un problema real para un nicho espec√≠fico. Tu idea debe ser una soluci√≥n por la que la gente pagar√≠a.', actions: ['Hablar con 10 clientes potenciales', 'Analizar 3 competidores', 'Definir Propuesta √önica de Valor (PUV)'] },
        { id: 'offer', title: '2. Crea una Oferta Irresistible', content: 'Empaqueta tu soluci√≥n de forma que sea dif√≠cil de rechazar. No vendas el producto, vende la transformaci√≥n.', actions: ['Definir entregables del producto/servicio', 'A√±adir 2+ bonos de alto valor', 'Establecer una garant√≠a s√≥lida'] },
        { id: 'web', title: '3. Construye tu Landing Page', content: 'Crea una p√°gina √∫nica y simple que explique tu oferta y capture el inter√©s (y los correos electr√≥nicos) de tus visitantes.', actions: ['Escribir el copy (titular, beneficios, etc.)', 'Dise√±ar un llamado a la acci√≥n (CTA) claro', 'Configurar formulario de captura de emails'] },
        { id: 'marketing', title: '4. Atrae Tr√°fico Inicial', content: 'Elige UN canal y enf√≥cate en √©l. Publica contenido de valor que resuene con tu nicho y dirija a tu landing page.', actions: ['Publicar 3 piezas de contenido de valor', 'Promocionar en 2 comunidades online relevantes', 'Lanzar una mini-campa√±a de anuncios ($10)'] },
        { id: 'scale', title: '5. Lanza, Aprende y Optimiza', content: 'Lanza tu oferta a tu lista de correos. No busques la perfecci√≥n, busca feedback. Cada venta es una validaci√≥n.', actions: ['Enviar secuencia de lanzamiento por email', 'Analizar m√©tricas (visitas, conversiones)', 'Recopilar testimonios de primeros clientes'] },
    ];
    const container = $('#monet-container');
    container.innerHTML = '';
    const completedCount = S.monet.completedSteps.length;
    const totalSteps = steps.map(s => s.actions.length).reduce((a, b) => a + b, 0);
    const progress = totalSteps > 0 ? Math.round((completedCount / totalSteps) * 100) : 0;
    
    container.append(el('div', {class: 'card', style: 'margin-bottom: 16px;'},
        el('h4', {text: `Progreso Total de Monetizaci√≥n: ${progress}%`, style: 'margin:0 0 8px 0;'}),
        el('div', {style:'width: 100%; background: var(--line); border-radius: 99px; height: 8px;'},
            el('div', {style: `width: ${progress}%; background: linear-gradient(90deg, var(--brand), var(--brand2)); height: 100%; border-radius: 99px; transition: width .3s ease;`})
        )
    ));

    steps.forEach((step, index) => {
        const stepEl = el('div', {class:'monet-step'},
            el('div', {class:'row'},
                el('span', {style: 'font-size: 24px; font-weight: 800; color: var(--brand2);'}, `0${index + 1}`),
                el('div', {style: 'flex: 1;'},
                    el('h4', {text: step.title, style: 'margin:0;'}),
                    el('p', {text: step.content, class:'muted', style:'margin:4px 0 0;'})
                )
            ),
            el('div', {style: 'margin-top: 16px; border-top: 1px solid var(--line); padding-top: 16px; display: flex; flex-direction: column; gap: 8px;'},
                ...step.actions.map(action => {
                    const actionId = `${step.id}-${action.replace(/\s+/g, '-')}`;
                    const isCompleted = S.monet.completedSteps.includes(actionId);
                    return el('label', {class: 'chip', style: `cursor: pointer; ${isCompleted ? 'background: var(--success); color: white;' : ''}`},
                        el('input', {type:'checkbox', checked: isCompleted, style: 'display:none;', onchange: (e) => {
                            if (e.target.checked) {
                                S.monet.completedSteps.push(actionId);
                                addIntis(25, `Acci√≥n de monetizaci√≥n completada`);
                            } else {
                                S.monet.completedSteps = S.monet.completedSteps.filter(s => s !== actionId);
                            }
                            save(); renderMonetization();
                        }}),
                        isCompleted ? el('i', {'data-lucide':'check-circle', width: 16}) : el('i', {'data-lucide':'circle', width: 16}),
                        el('span', {text: action})
                    );
                })
            )
        );
        container.append(stepEl);
    });
    lucide.createIcons();
}

// ====== Industry Template Loader ======
function loadIndustryTemplate(industry) {
    if (S.projects.length > 0 && !confirm("¬øCargar plantilla? Esto reemplazar√° tus proyectos y datos actuales.")) { return; }
    const userProfile = S.hub.perfil || {nombre: 'Nuevo Usuario', rol: 'Emprendedor', bio: 'Listo para empezar.'};
    Object.assign(S, JSON.parse(JSON.stringify(initialState)));
    S.hub.perfil = userProfile; S.industry = industry;
    let p = { id: 'p' + Date.now(), color: projectColors[0] };

    if(industry === 'agency') {
        p.name = 'Proyectos de Agencia Digital';
        S.projects.push(p);
        S.folders[p.id] = ['General', 'Cliente TechCorp', 'Cliente Foodie', 'Prospecci√≥n'];
        S.tasks[p.id] = [ {id:'t'+Date.now(), title:'Enviar propuesta a Acme Inc.', status:'En curso', pri:'Alta', folder: 'Prospecci√≥n'}, {id:'t'+Date.now()+1, title:'Dise√±ar borradores para campa√±a Foodie', status:'Backlog', pri:'Media', folder: 'Cliente Foodie'}, ];
        S.notes[p.id] = {list: [{id:'n1', title:'Plantilla de Brief Creativo'}], active:'n1', bodies:{'n1': '<h2>Objetivo de la Campa√±a:</h2><p>...</p>'}};
        S.fin[p.id] = { rows: [ {fecha:new Date(), tipo: 'Ingreso', monto: 1500, cat: 'Anticipo Cliente', nota: 'Factura #001 TechCorp'}]};
    } else { // Generic fallback
        p.name = `Proyecto de ${industry}`;
        S.projects.push(p);
        S.folders[p.id] = ['General', 'Marketing', 'Desarrollo'];
        S.tasks[p.id] = [ {id:'t'+Date.now(), title:'Definir objetivos Q4', status:'Backlog', pri:'Alta', folder: 'General'}, {id:'t'+Date.now()+1, title:'Lanzar campa√±a en redes', status:'En curso', pri:'Media', folder: 'Marketing'}, ];
    }
    
    S.cronopost.ideas[p.id] = [{id:'i1', title:'Caso de estudio: √âxito del Cliente'}, {id:'i2', title:'Tip r√°pido del sector'}];
    addIntis(100, `Plantilla ${industry} cargada`);
    save(); init(true);
}

// ====== INIT & EVENT LISTENERS ======
function init(isReload = false){
  load();
  lucide.createIcons();
  if (!S.industry && !isReload) {
      setTimeout(() => $('#industryModal').showModal(), 500);
  }
  
  const handleNav = (hash) => {
    const view = hash.replace('#', '');
    if (view && $(`[data-nav="${view}"]`)) {
      show(view);
    } else if (S.projects.length > 0) {
      const initialProject = S.activeProject && S.projects.find(p => p.id === S.activeProject) ? S.activeProject : S.projects[0].id;
      openProject(initialProject);
    } else {
      show(S.activeNav || 'hub');
    }
  };
  
  $('#nav-list').addEventListener('click', (e) => {
      const link = e.target.closest('a.navBtn');
      if (link && link.dataset.nav) {
          e.preventDefault();
          const view = link.dataset.nav;
          history.pushState({view}, '', `#${view}`);
          show(view);
      }
  });

  window.addEventListener('popstate', (e) => {
      if(e.state && e.state.view) { show(e.state.view); } 
      else { handleNav(window.location.hash); }
  });

  handleNav(window.location.hash);
  renderAside(); renderCronoPOST(); renderMkt(); renderHub(); renderChat(); renderMonetization(); updateTitle();
}

// --- Global Listeners ---
$('#newProject').onclick = () => { $('#newProjectModal').showModal(); };
$('#newProjectCreate').onclick = createNewProject;
$('#creditsChip').onclick = () => $('#creditsModal').showModal();
$('#changeIndustryBtn').onclick = (e) => {e.preventDefault(); $('#industryModal').showModal()};
$('#loadIndustry').onclick = () => {
    const industry = $('#industrySel').value;
    loadIndustryTemplate(industry);
    $('#industryModal').close();
};
$('#themeBtn').onclick=()=>{ 
    const h=document.documentElement; const newTheme = h.getAttribute('data-theme')==='light'?'dark':'light'; h.setAttribute('data-theme', newTheme);
    $('#themeBtn').innerHTML = newTheme === 'light' ? '<i data-lucide="sun"></i>' : '<i data-lucide="moon"></i>';
    lucide.createIcons();
};
$('#menuBtn').onclick=()=>document.body.classList.toggle('aside-open');
$('body').addEventListener('click', e => {
    if(document.body.classList.contains('aside-open') && !e.target.closest('aside') && !e.target.closest('#menuBtn')) {
        document.body.classList.remove('aside-open');
    }
});
wireTabs('#hub', 'htab', 'h-htab');
wireTabs('#marketing', 'mtab', 'm-mtab');
wireTabs('#admin', 'atab', 'a-atab');
wireTabs('#projectShell', 'ptab', 'p-tab', (activeTab) => {
    const btn = $('#quickAdd');
    const textMap = { tasks: 'Nueva Tarea', tables: 'Nueva Tabla', notes: 'Nueva Nota', drawings: 'Nuevo Dibujo', files: 'Subir Archivo', chat: 'Nuevo Chat', finance: 'Nuevo Movimiento'};
    if (textMap[activeTab]) {
        btn.style.display = 'inline-flex';
        btn.innerHTML = `<i data-lucide="plus"></i> ${textMap[activeTab]}`;
        lucide.createIcons();
    } else { btn.style.display = 'none'; }
    if (activeTab === 'drawings') renderDrawings();
    if (activeTab === 'calendar') renderCalendar();
});

// --- Project Listeners ---
$('#addFolder').onclick=()=>{ const id=S.activeProject; if(!id)return; const name=prompt('Nombre de la subcarpeta:'); if(name) { (S.folders[id]=S.folders[id]||[]).push(name); save(); openProject(id); }};
$('#quickAdd').onclick=()=>{
    const activeTab = $('#projectShell .tabs .tab.active').dataset.ptab;
    const handler = { tasks: '#qaCreate', tables: '#newSheet', notes: '#newNote', drawings: '#newDrawing', files: () => $('#fileInput').click(), chat: '#newChat', finance: '#finNew'}[activeTab];
    if (typeof handler === 'string') $(handler).click();
    else if (typeof handler === 'function') handler();
};
$('#vKanban').onclick=()=>{ $('#kanban').style.display='grid'; $('#list').style.display='none'; $('#vKanban').classList.add('active'); $('#vList').classList.remove('active'); };
$('#vList').onclick=()=>{ $('#kanban').style.display='none'; $('#list').style.display='block'; $('#vKanban').classList.remove('active'); $('#vList').classList.add('active'); };
$('#prevM').onclick=()=>{calRef.setMonth(calRef.getMonth()-1); renderCalendar();};
$('#nextM').onclick=()=>{calRef.setMonth(calRef.getMonth()+1); renderCalendar();};
// Notes
$('#newNote').onclick=()=>{ const id=S.activeProject; if(!id) return; const N=S.notes[id]; const t=prompt('T√≠tulo de la nota'); if(!t) return; const nid='n'+Date.now(); N.list.push({id:nid,title:t,folder:'General'}); N.active=nid; N.bodies[nid]=''; addIntis(5, 'Nota creada'); save(); renderNotes();};
$$('#p-tab-notes [data-cmd]').forEach(btn=>btn.onclick=()=>document.execCommand(btn.getAttribute('data-cmd'), false, null));
$('#h1Btn').onclick=()=>document.execCommand('formatBlock',false,'h1');
$('#h2Btn').onclick=()=>document.execCommand('formatBlock',false,'h2');
// Drawings
const setupCanvas = () => {
    const canvas = $('#drawingCanvas');
    canvas.addEventListener('mousedown', (e) => { isDrawing = true; [lastX, lastY] = [e.offsetX, e.offsetY]; });
    canvas.addEventListener('mousemove', (e) => { if (isDrawing) { drawingCtx.beginPath(); drawingCtx.moveTo(lastX, lastY); drawingCtx.lineTo(e.offsetX, e.offsetY); drawingCtx.stroke(); [lastX, lastY] = [e.offsetX, e.offsetY]; }});
    canvas.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('mouseout', () => isDrawing = false);
}
$('#newDrawing').onclick = () => { const id = S.activeProject; if (!id) return; const title = prompt("T√≠tulo del dibujo:"); if (!title) return; const did = 'd' + Date.now(); S.drawings[id].list.push({ id: did, title }); S.drawings[id].active = did; S.drawings[id].bodies[did] = null; addIntis(5, 'Dibujo creado'); save(); renderDrawings(); };
$('#drawingSel').onchange = (e) => { S.drawings[S.activeProject].active = e.target.value; save(); renderDrawings(); };
$('#saveDrawing').onclick = () => { const id = S.activeProject; const active = S.drawings[id].active; if (!id || !active) return; S.drawings[id].bodies[active] = $('#drawingCanvas').toDataURL(); save(); showToast('Dibujo guardado', 'success'); };
$('#clearCanvas').onclick = () => renderDrawings();
// Files
$('#fileInput').onchange=(e)=>{ const id=S.activeProject; if(!id) return; for(const f of e.target.files){ S.files[id].push({name:f.name,url:URL.createObjectURL(f), size:f.size}); } addIntis(5, 'Archivo subido'); save(); renderFiles();};
// Chat
$('#newChat').onclick=()=>{ const id=S.activeProject; if(!id)return; const t=prompt('Nuevo hilo de Chat:'); if(t) {S.chats[id].threads.push({id:'c'+Date.now(), title:t}); S.chats[id].activeThread = 'c'+Date.now(); S.chats[id].messages[S.chats[id].activeThread] = [{who: 'GoatX', at: new Date(), text: '¬°Claro! ¬øEn qu√© puedo ayudarte con este tema?'}]; save(); renderProjectChat();}};
$('#sendMsg').onclick=()=>{ const id=S.activeProject; if(!id||!S.chats[id].activeThread)return; const msg=$('#chatMsg').value.trim(); if(!msg)return; if(!useCredit(1)) return; const C=S.chats[id]; if(!C.messages[C.activeThread]) C.messages[C.activeThread] = []; C.messages[C.activeThread].push({who:'T√∫',at:new Date(),text:msg}); C.messages[C.activeThread].push({who:'GoatX',at:new Date(),text:'Esta es una respuesta simulada de la IA.'}); $('#chatMsg').value=''; save(); renderProjectChat();};
$('#chatToTasks').onclick=()=>{ const id=S.activeProject; if(!id)return; const C=S.chats[id]; if(!C.activeThread || C.messages[C.activeThread].length === 0) return showToast('No hay mensajes para convertir', 'warn'); const msg = C.messages[C.activeThread].slice(-1)[0]; if(msg) { S.tasks[id].push({id:'t'+Date.now(),title:'Desde Chat: '+msg.text,status:'Backlog',pri:'Media'}); showToast('Tarea creada desde el chat', 'success'); save(); renderTasks();}};
// Finance
$('#finNew').onclick=()=>{ const id=S.activeProject; if(!id) return; const F=S.fin[id]; const tipo=prompt('Ingreso/Egreso','Ingreso'); const monto=Number(prompt('Monto','0')); const cat=prompt('Categor√≠a','General'); const nota=prompt('Nota',''); if(!monto) return; F.rows.push({fecha:new Date(), tipo, monto, cat, nota}); addIntis(5, 'Movimiento financiero'); save(); renderFin(); renderOverview(); };
// Tables
$('#newSheet').onclick=()=>{ const id=S.activeProject; if(!id) return; const T=S.tables[id]; const title = prompt("T√≠tulo de la tabla:"); if (!title) return; const tid = 'tbl' + Date.now(); T.list.push({id: tid, title}); T.bodies[tid] = {cols:['Columna 1','Columna 2'], rows:[['Dato 1','Dato 2']]}; T.active = tid; addIntis(10, 'Tabla creada'); save(); renderTables();};
$('#tableSel').onchange = (e) => { S.tables[S.activeProject].active = e.target.value; save(); renderTables(); };
// CronoPOST
$('#cpProjectFilter').onchange = renderCronoPOST;
$('#cpPrevM').onclick = () => { cpRef.setMonth(cpRef.getMonth() - 1); renderCronoPOST(); };
$('#cpNextM').onclick = () => { cpRef.setMonth(cpRef.getMonth() + 1); renderCronoPOST(); };
$('#cpGenAIIdeas').onclick = () => {
    const selectedProjectId = $('#cpProjectFilter').value;
    if (selectedProjectId === 'all') { showToast('Por favor, selecciona un proyecto para generar ideas.', 'warn'); return; }
    if (!useCredit(1)) return;
    const project = S.projects.find(p => p.id === selectedProjectId);
    const ideas = [`5 tips sobre ${project.name}`, `C√≥mo ${project.name} puede ayudarte a...`, `Un error com√∫n sobre ${project.name}`];
    const projectIdeas = S.cronopost.ideas[selectedProjectId] || (S.cronopost.ideas[selectedProjectId] = []);
    ideas.forEach(idea => projectIdeas.push({id: 'i' + Date.now() + Math.random(), title: idea}));
    addIntis(10, 'Ideas IA generadas'); save(); renderCronoPOST(); showToast('¬°Nuevas ideas generadas por IA!', 'success');
};
// Hub
$('#editProfileBtn').onclick = () => {
    const P = S.hub.perfil;
    $('#pNombre').value = P?.nombre || '';
    $('#pRole').value = P?.rol || '';
    $('#pBio').value = P?.bio || '';
    $('#profileModal').showModal();
}
$('#savePerfil').onclick=()=>{
  const isNew = !(S.singleProfile && S.hub.perfil && S.hub.perfil.id);
  const nombre = $('#pNombre').value; S.hub.perfil = {id:'u1', nombre: nombre, rol:$('#pRole').value, bio:$('#pBio').value};
  if(isNew) addIntis(50, 'Perfil Creado'); save(); renderHub(); renderChat(); showToast("Perfil guardado.", "success");
  $('#profileModal').close();
};
$('#addJob').onclick=()=>{ const t=$('#jobTitle').value; if(!t) return; S.hub.jobs.push({id:'j'+Date.now(), title:t, company:$('#jobCompany').value, pay:$('#jobPay').value, desc:$('#jobDesc').value}); addIntis(20, 'Empleo publicado'); save(); renderHub(); };
$('#addMK').onclick=()=>{ const n=$('#mkName').value; if(!n) return; S.hub.market.push({id:'m'+Date.now(), name:n, price:Number($('#mkPrice').value||0), desc:$('#mkDesc').value}); addIntis(20, 'Servicio publicado'); save(); renderHub(); };
// Global Chat
$('#sendRoom').onclick = () => { const msg = $('#roomMsg').value.trim(); if (!msg) return; const myName = S.hub.perfil?.nombre || 'T√∫'; const activeRoomId = S.chat.activeRoom || 'r1'; if (!S.chat.messages[activeRoomId]) S.chat.messages[activeRoomId] = []; S.chat.messages[activeRoomId].push({ who: myName, at: new Date(), text: msg }); addIntis(2, 'Mensaje enviado'); save(); renderChat(); $('#roomMsg').value = ''; };
// Mindset
$('#startBreathingBtn').onclick = () => {
    const circle = $('#breathing-circle'); const btn = $('#startBreathingBtn');
    btn.disabled = true; circle.classList.add('breathing'); circle.textContent = 'Inhala';
    setTimeout(() => { circle.textContent = 'Exhala'; }, 4000);
    setTimeout(() => { circle.classList.remove('breathing'); circle.textContent = 'Inhala'; btn.disabled = false; addIntis(5, 'Ejercicio de respiraci√≥n'); }, 8000);
};

init();
setupCanvas();
</script>
</body>
</html>

