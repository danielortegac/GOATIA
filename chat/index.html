<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Goatify AI</title>
    <link rel="icon" type="image/png" href="./Logos HD.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script> <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <style>
        :root {
            --bg-dark: #121212;
            --bg-medium: #1e1e1e;
            --bg-light: #2c2c2c;
            --primary: #8a4fff;
            --primary-hover: #7b46e6;
            --text-light: #e0e0e0;
            --text-medium: #b3b3b3;
            --border-color: #3a3a3a;

            --light-bg-dark: #f7f7f8;
            --light-bg-medium: #ffffff;
            --light-bg-light: #f0f0f0;
            --light-primary: #7c40e6;
            --light-primary-hover: #6a37d3;
            --light-text-dark: #1f2937;
            --light-text-medium: #6b7280;
            --light-border-color: #e5e7eb;

            /* Font size variable for user customization */
            --base-font-size: 16px;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        /* Applied Montserrat font family */
        body {
            font-family: 'Montserrat', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: var(--base-font-size); /* Apply custom font size */
        }

        .dark-theme {
            --current-bg-dark: var(--bg-dark);
            --current-bg-medium: var(--bg-medium);
            --current-bg-light: var(--bg-light);
            --current-primary: var(--primary);
            --current-primary-hover: var(--primary-hover);
            --current-text-light: var(--text-light);
            --current-text-medium: var(--text-medium);
            --current-border-color: var(--border-color);
            background-color: var(--current-bg-dark);
            color: var(--text-light);
        }

        .light-theme {
            --current-bg-dark: var(--light-bg-dark);
            --current-bg-medium: var(--light-bg-medium);
            --current-bg-light: var(--light-bg-light);
            --current-primary: var(--light-primary);
            --current-primary-hover: var(--light-primary-hover);
            --current-text-light: var(--light-text-dark);
            --current-text-medium: var(--light-text-medium);
            --current-border-color: var(--light-border-color);
            background-color: var(--light-bg-dark);
            color: var(--light-text-dark);
        }

        #sidebar {
            background-color: var(--current-bg-dark);
            border-right: 1px solid var(--current-border-color);
        }

        #main-chat-area,
        .modal-content {
            background-color: var(--current-bg-medium);
        }

        .chat-bubble-bot,
        .bg-input,
        .chat-item,
        .project-header,
        #user-menu-popup,
        #services-menu,
        .pro-controls-bg {
            background-color: var(--current-bg-light);
        }

        .border-themed {
            border-color: var(--current-border-color);
        }

        .chat-bubble-user {
            background-color: var(--current-primary);
            color: white;
        }

        .btn-primary {
            background-color: var(--current-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--current-primary-hover);
        }

        .plan-card-highlight {
            border-color: var(--current-primary);
            box-shadow: 0 0 15px rgba(138, 79, 255, 0.3);
        }

        .placeholder-themed::placeholder {
            color: var(--current-text-medium);
        }

        .text-primary {
            color: var(--current-primary);
        }

        .glowing-mic {
            animation: pulse 1.5s infinite;
            color: var(--primary) !important;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(138, 79, 255, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(138, 79, 255, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(138, 79, 255, 0);
            }
        }

        .project .project-content {
            display: none;
        }

        .project.open .project-content {
            display: block;
        }

        .project.open .project-arrow {
            transform: rotate(90deg);
        }

        .project-header.drag-over {
            background-color: var(--current-primary);
        }

        #sidebar.is-open {
            transform: translateX(0);
        }

        #sidebar-overlay {
            transition: opacity 0.3s ease-in-out;
        }

        #app-container {
            height: 100vh;
            height: -webkit-fill-available;
        }

        #pricing-modal .modal-content-body {
            max-height: 80vh;
            overflow-y: auto;
        }

        .chat-item.selected-for-delete {
            background-color: var(--primary) !important;
            color: white;
        }

        /* Subtle purple glow effect on hover for selectable items */
        .pro-controls-bg select:hover,
        .chat-item:hover:not(.selected-for-delete):not([data-id="${currentChatId}"]),
        .project-header:hover,
        #settings-theme-toggle:hover,
        #language-selector:hover,
        #connect-whatsapp-btn:hover {
            box-shadow: 0 0 8px rgba(138, 79, 255, 0.4);
            transition: box-shadow 0.3s ease-in-out;
        }

        /* Refined model selector and voice selector background + thinner */
        .pro-controls-bg select { /* Target both model and voice selectors with this */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            background-image: linear-gradient(to right, rgba(138, 79, 255, 0.1), rgba(138, 79, 255, 0.05));
            height: 32px; /* Adjusted height to be thinner */
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem; /* text-sm */
            border: none; /* Remove default border */
            outline: none; /* Remove outline on focus */
        }
        /* Ensure dropdown arrow is visible on model/voice selectors */
        .pro-controls-bg select::-ms-expand {
            display: none;
        }


        .workflow-content {
            display: none;
        }

        .workflow-category.open .workflow-content {
            display: block;
        }

        .workflow-category.open .workflow-arrow {
            transform: rotate(90deg);
        }

        .plan-card {
            background-color: var(--current-bg-light);
        }

        /* Minimalist File Preview Containers - hidden by default, shown by JS */
        #pdf-preview-container,
        #image-preview-container {
            display: none; /* Hidden by default */
            padding: 0.4rem 0.6rem; /* Reduced padding */
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
            background-color: var(--current-bg-light);
            font-size: 0.75rem; /* text-xs */
            align-items: center;
            gap: 0.5rem;
            max-width: 250px; /* Constrain width */
        }

        #image-preview {
            height: 24px; /* Small icon size */
            width: 24px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* Subtle glow effect on chat title for edit hint */
        #chat-title:hover,
        #mobile-chat-title:hover {
            color: var(--current-primary);
            text-shadow: 0 0 5px rgba(138, 79, 255, 0.5);
            transition: all 0.3s ease;
        }

        /* Style for the inline edit icon */
        .chat-title-edit-icon {
            font-size: 0.75rem; /* text-xs */
            margin-left: 0.5rem;
            opacity: 0.5; /* Subtle by default */
            transition: opacity 0.3s ease;
        }

        #chat-title:hover .chat-title-edit-icon,
        #mobile-chat-title:hover .chat-title-edit-icon {
            opacity: 1; /* Fully visible on hover */
        }

        /* Calendar styles (simplified for this example) */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day {
            padding: 8px;
            border-radius: 4px;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .calendar-day:hover {
            background-color: var(--current-bg-light);
        }
        .calendar-day.current-month {
            color: var(--current-text-light);
        }
        .calendar-day.other-month {
            color: var(--current-text-medium);
            opacity: 0.5;
        }
        .calendar-day.selected {
            background-color: var(--current-primary);
            color: white;
        }
        .calendar-day.has-tasks {
            border: 1px solid var(--primary);
            box-shadow: 0 0 5px rgba(138, 79, 255, 0.3);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        @media (max-width: 640px) {
            body {
                font-size: 15px;
            }
            /* Even thinner on mobile */
            .pro-controls-bg select {
                height: 28px;
                font-size: 0.75rem;
                padding-right: 1.8rem;
            }
        }
    </style>
</head>
<body class="w-screen overflow-x-hidden dark-theme">

    <div id="loading-overlay" class="fixed inset-0 bg-bg-dark bg-opacity-95 flex flex-col items-center justify-center z-[100] transition-opacity duration-300">
        <img src="./Logos HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mb-6 animate-pulse" onerror="this.onerror=null;this.src='https://placehold.co/96x96/121212/e0e0e0?text=LOGO';">
        <div class="text-text-light text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3 text-lg font-semibold">Inicializando...</p>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden opacity-0 pointer-events-none"></div>

    <div id="app-container" class="flex w-full relative opacity-0 transition-opacity duration-300">
        <aside id="sidebar" class="w-72 flex-shrink-0 flex flex-col p-3 transition-transform duration-300 -translate-x-full md:translate-x-0 absolute md:relative z-30 h-full">
            <div id="logo-space" class="w-24 h-24 rounded-lg mx-auto mb-4 flex-shrink-0 flex items-center justify-center overflow-hidden bg-input">
                <img src="./Logos HD.png" alt="Goatify Logo" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
            </div>
            <div class="flex-grow overflow-y-auto min-h-0">
                <div class="flex-shrink-0">
                    <div class="flex flex-col space-y-2 mb-4">
                        <button id="new-chat-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-plus mr-2"></i><span>Nuevo Chat</span></button>
                        <button id="new-project-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg bg-input"><i class="fas fa-folder-plus mr-2"></i><span>Nuevo Proyecto</span></button>
                        <button id="web-launch-offer-btn" class="w-full text-left font-semibold text-sm p-3 rounded-lg btn-primary transition-colors animate-pulse">
                            🚀 ¡Lanza tu Negocio, te regalamos una pg web Gratis con tu suscripcion!
                        </button>
                        <div id="upgrade-plan-container" class="hidden text-center p-2 bg-yellow-400 rounded-lg">
                            <button id="upgrade-plan-btn" class="text-xs font-semibold text-black hover:text-gray-800">
                                <i class="fas fa-rocket mr-1"></i>
                                <span>Mejorar Plan</span>
                            </button>
                        </div>
                        <div class="text-center p-2 bg-input rounded-lg">
                            <a href="#" id="free-guides-link" class="text-xs font-semibold text-primary hover:underline">
                                <i class="fas fa-book-open mr-1"></i>
                                Guías de IA Gratis
                            </a>
                        </div>
                    </div>
                </div>
                <div class="flex-grow">
                    <div class="border-t border-b border-themed my-3 py-3">
                        <h3 class="text-xs font-semibold uppercase text-text-medium mb-2 px-2">Workflows</h3>
                        <div id="workflows-container" class="space-y-1">
                            <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                    <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i>
                                    <i class="fas fa-share-alt w-6 mr-2 text-pink-400"></i>
                                    <span class="text-sm font-bold">Potenciador de Redes Sociales</span>
                                </div>
                                <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="create-full-post" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Crear un Post Completo</button>
                                    <button data-workflow="persuasive-copy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Redacción de Copys</button>
                                    <button data-workflow="post-ideas" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Lluvia de Ideas para Posts</button>
                                    <button data-workflow="brand-strategy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Definir Estrategia de Marca</button>
                                </div>
                            </div>
                            <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                    <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i>
                                    <i class="fas fa-chart-pie w-6 mr-2 text-blue-400"></i>
                                    <span class="text-sm font-bold">Análisis de Negocio</span>
                                </div>
                                <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="competitor-analysis" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Análisis de tu Competencia</button>
                                    <button data-workflow="buyer-persona" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Definir mi Cliente Ideal</button>
                                    <button data-workflow="brand-names" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Lluvia de Nombres para Marca</button>
                                </div>
                            </div>
                            <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                    <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i>
                                    <i class="fas fa-headset w-6 mr-2 text-green-400"></i>
                                    <span class="text-sm font-bold">Comunicación y Ventas</span>
                                </div>
                                <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="sales-assistant" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Asistente de Ventas 24/7</button>
                                    <button data-workflow="email-writing" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Redacción de Email</button>
                                    <button data-workflow="design-web" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Diseño Web</button>
                                </div>
                            </div>
                            <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                    <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i>
                                    <i class="fas fa-language w-6 mr-2 text-red-400"></i>
                                    <span class="text-sm font-bold">English Teacher</span>
                                </div>
                                <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="english-teacher-translate" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Traducir/Corregir Texto</button>
                                    <button data-workflow="english-teacher-vocabulary" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Aprender Vocabulario Nuevo</button>
                                    <button data-workflow="english-teacher-practice" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Practicar Conversación</button>
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-themed pt-2 mt-2">
                            <button id="select-chats-btn" class="w-full text-sm p-2 rounded hover:bg-light flex items-center justify-center">
                                <i class="fas fa-tasks mr-2"></i><span>Seleccionar Múltiples Chats</span>
                            </button>
                        </div>
                    </div>
                    <div id="delete-mode-controls" class="hidden flex space-x-2 mb-2 px-2">
                        <button id="delete-selected-btn" class="flex-1 flex items-center justify-center font-semibold p-2 rounded-lg bg-red-600 text-white disabled:opacity-50" disabled><i class="fas fa-trash-alt mr-2"></i><span>Borrar</span></button>
                        <button id="cancel-select-mode-btn" class="p-2 rounded-lg bg-gray-600 text-white"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="sidebar-content" class="pr-1 space-y-1"></div>
                </div>
                <div id="user-section" class="flex-shrink-0 border-t border-themed mt-auto pt-3">
                    <div id="login-view" class="hidden">
                        <button id="login-btn" class="w-full flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-sign-in-alt mr-2"></i><span>Iniciar Sesión</span></button>
                    </div>
                    <div id="user-menu-view" class="hidden relative">
                        <button id="user-menu-btn" class="w-full flex items-center text-left p-2 rounded-lg hover:bg-light transition-colors">
                            <span id="user-email" class="flex-grow truncate text-sm font-semibold"></span>
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <div id="user-menu-popup" class="absolute bottom-full left-0 w-full mb-2 rounded-lg p-2 border border-themed shadow-lg hidden">
                            <button id="settings-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-cog w-6 mr-2"></i>Configuración</button>
                            <button id="logout-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-sign-out-alt w-6 mr-2"></i>Cerrar Sesión</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <main id="main-chat-area" class="flex-1 flex flex-col h-full overflow-hidden">
            <header class="flex items-center justify-between p-3 md:p-4 border-b border-themed flex-shrink-0 relative">
                <button id="menu-toggle" class="md:hidden text-xl p-2"><i class="fas fa-bars"></i></button>
                <h1 id="chat-title" class="hidden sm:flex items-center text-lg font-semibold truncate cursor-pointer mx-2 flex-1 min-w-0" title="Renombrar Chat">
                    Goatify AI <i id="chat-title-edit-icon-desktop" class="fas fa-pencil-alt chat-title-edit-icon"></i>
                </h1>
                <div class="flex items-center space-x-1 sm:space-x-2 flex-shrink-0 ml-auto">
                    <button id="new-chat-icon-btn" title="Nuevo Chat" class="text-xl p-2 hover:opacity-80 transition-opacity">
                        <i class="fas fa-plus-circle text-primary"></i>
                    </button>
                    <button id="services-menu-btn" title="Potenciar mi Negocio" class="text-xl p-2 hover:opacity-80 transition-opacity flex items-center gap-2">
                        <i class="fas fa-rocket text-primary"></i>
                        <span class="text-sm font-semibold text-primary">Soluciones</span>
                    </button>
                    <a href="#" id="calendar-btn" title="Agendar Sesión Estratégica" class="text-sky-400 hover:text-sky-300 p-2 transition-colors">
                        <i class="fas fa-calendar-days text-xl"></i>
                    </a>
                    <a href="https://wa.me/17439106116?text=Hola%2C%20estoy%20interesado%2Fa%20en%20contratar%20uno%20de%20sus%20paquetes%20de%20soluciones%20con%20IA%20para%20mi%20negocio.%20%C2%BFPodr%C3%ADan%20darme%20m%C3%A1s%20informaci%C3%B3n%3F" target="_blank" title="Hablar con un Estratega" class="text-green-500 hover:text-green-400 p-2 transition-colors">
                        <i class="fab fa-whatsapp text-xl"></i>
                    </a>
                    <div id="message-counter" class="text-xs font-mono whitespace-nowrap"></div>
                    <button id="theme-toggle" title="Cambiar Tema" class="text-xl p-2"><i class="fas fa-moon" id="theme-icon"></i></button>
                </div>
                <div id="services-menu" class="absolute top-full right-4 mt-2 w-80 rounded-xl shadow-lg border border-themed z-30 p-4 transition-all duration-300 ease-in-out opacity-0 scale-95 -translate-y-2 pointer-events-none origin-top-right">
                    <h4 class="font-bold text-lg mb-1 text-text-light">Somos tu Aliado Estratégico</h4>
                    <p class="text-sm text-text-medium mb-4">Goatify no es solo un chat. Somos una IA personalizada con un equipo de expertos listos para ayudarte a escalar tu negocio.</p>
                    <ul class="space-y-3">
                        <li><a href="https://www.goatify.app/diseno-web" target="_blank" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Páginas Web que Convierten</p><p class="text-sm text-text-medium">Transformamos tus ideas en webs y tiendas online diseñadas para vender.</p></a></li>
                        <li><a href="https://www.goatify.app/automatizacion" target="_blank" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Ventas en Piloto Automático</p><p class="text-sm text-text-medium">Implementamos sistemas de IA para automatizar tus ventas y procesos clave.</p></a></li>
                        <li><a href="https://www.goatify.app/redes-sociales" target="_blank" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Avatares para Redes Sociales</p><p class="text-sm text-text-medium">Creamos avatares hiperrealistas con IA y estrategias de contenido que captan la atención.</p></a></li>
                        <li><a href="https://www.goatify.app/consultoria" target="_blank" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Escala tu Empresa con IA</p><p class="text-sm text-text-medium">Obtén consultoría experta para integrar la IA en el ADN de tu negocio.</p></a></li>
                    </ul>
                </div>
            </header>
            <div class="block sm:hidden text-center py-1.5 border-b border-themed bg-current-bg-dark shadow-sm flex-shrink-0">
                <h2 id="mobile-chat-title" class="text-sm font-semibold truncate px-4 cursor-pointer flex items-center justify-center" title="Renombrar Chat">
                    Goatify AI <i id="chat-title-edit-icon-mobile" class="fas fa-pencil-alt chat-title-edit-icon"></i>
                </h2>
            </div>

            <div id="chat-messages" class="flex-1 overflow-y-auto p-3 sm:p-6">
                <div class="flex justify-center items-center h-full" id="initial-message-container">
                    <div id="welcome-message-wrapper" class="text-center text-text-medium">
                        <img src="./Logos HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                        <h2 class="text-3xl font-bold text-text-light">Goatify AI</h2>
                        <div id="personalized-welcome" class="hidden"><p class="text-lg mt-1">¡Hola, <span id="user-name"></span>! Hoy es un gran día para crear algo increíble.</p></div>
                        <div id="generic-welcome" class="hidden"><p class="text-xl">¿Cómo puedo ayudarte hoy?</p></div>
                    </div>
                </div>
            </div>
            <div id="input-area" class="p-2 sm:p-4 border-t border-themed flex-shrink-0">
                <div id="file-preview-area" class="mb-2 space-y-2 px-1 sm:px-0">
                    <div id="image-preview-container">
                        <img id="image-preview" src="#" alt="Image Preview">
                        <span id="image-name" class="text-xs text-text-medium truncate flex-grow"></span>
                        <button id="clear-image-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                    <div id="pdf-preview-container">
                        <i class="fas fa-file-pdf text-red-500 text-xl"></i>
                        <div class="flex-grow min-w-0">
                            <p id="pdf-name" class="font-medium truncate"></p>
                            <p id="pdf-status" class="text-xxs font-mono"></p>
                        </div>
                        <button id="clear-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                </div>
                <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                    <div class="flex items-center justify-between space-x-2">
                        <div class="flex items-center space-x-2">
                            <label for="model-selector" class="font-medium text-xs text-text-medium pl-2">Modelo:</label>
                            <select id="model-selector" class="rounded-md p-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-text-light">
                                <option value="gpt-3.5-turbo-1106">Chat General (Turbo)</option>
                                <option value="sonar">Búsqueda Web</option>
                            </select>
                        </div>
                        <div id="voice-selector-container" class="hidden items-center space-x-2">
                            <label for="voice-selector" class="font-medium text-xs text-text-medium">Voz:</label>
                            <select id="voice-selector" class="rounded-md p-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-text-light w-24"></select>
                        </div>
                        <div class="flex sm:hidden items-center space-x-1">
                            <button id="image-gen-btn-mobile" title="Crear Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fas fa-paint-brush text-lg"></i></button>
                            <button id="pdf-upload-btn-mobile" title="Subir PDF" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-file-pdf text-lg"></i></button>
                            <button id="image-upload-btn-mobile" title="Subir Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-image text-lg"></i></button>
                        </div>
                    </div>
                </div>
                <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2">
                    <input type="file" id="pdf-upload" accept=".pdf,application/pdf" class="hidden">
                    <input type="file" id="image-upload" accept="image/*" class="hidden">
                    <button id="image-gen-btn" title="Crear Imagen" class="hidden sm:block p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fas fa-paint-brush text-xl"></i></button>
                    <button id="pdf-upload-btn" title="Subir PDF" class="hidden sm:block p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-file-pdf text-xl"></i></button>
                    <button id="image-upload-btn" title="Subir Imagen" class="hidden sm:block p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-image text-xl"></i></button>
                    <button id="mic-btn" title="Activar Micrófono" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-microphone text-xl"></i></button>
                    <button id="tts-toggle" title="Activar/Desactivar Voz" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-volume-mute text-xl"></i></button>
                    <textarea id="msg" placeholder="Escribe tu mensaje..." class="flex-1 bg-transparent p-2 h-12 max-h-32 resize-none outline-none placeholder-themed" rows="1"></textarea>
                    <button id="send" title="Enviar" class="p-2 sm:p-4 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i id="send-icon" class="fa fa-paper-plane text-xl"></i></button>
                </div>
                <div id="contextual-footer" class="text-center text-xs text-text-medium mt-2 px-2 h-4"></div>
            </div>
        </main>
    </div>

    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4"><div class="modal-content rounded-lg w-full max-w-md p-6 relative"><h3 id="modal-title" class="text-lg font-bold mb-4"></h3><div id="modal-message" class="mb-4 text-text-medium text-sm"></div><textarea id="modal-textarea" class="w-full p-2 rounded mb-4 hidden bg-input border border-themed h-28" placeholder=""></textarea><input type="text" id="modal-input" class="w-full p-2 rounded mb-4 hidden bg-input border border-themed" placeholder=""><div id="modal-buttons-container" class="flex justify-end space-x-2"><button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded">Cancelar</button><button id="modal-confirm" class="px-4 py-2 rounded text-white btn-primary">Confirmar</button></div></div></div>
    <div id="pricing-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4"><div class="modal-content rounded-2xl w-full max-w-5xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300"><div class="flex-shrink-0 flex items-center justify-between mb-6"><h2 class="text-3xl md:text-4xl font-extrabold text-center flex-grow">Planes Goatify</h2><button id="close-pricing-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button></div><div class="modal-content-body flex-grow overflow-y-auto px-2"><div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-text-light"><div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col"><h3 class="text-2xl font-bold">Free</h3><p class="text-5xl font-extrabold my-3">$0</p><p class="text-sm text-text-medium mb-4">Para Siempre</p><button id="free-plan-button" class="w-full p-3 rounded-lg font-semibold border-2 border-primary text-primary hover:bg-primary hover:text-white transition-colors">Empezar Gratis</button><ul class="space-y-3 text-sm flex-grow mt-6 mb-4"><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Acceso limitado al chat</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Historial limitado</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Organización por proyectos (Limitado)</li></ul><div class="text-center text-text-medium text-xs mt-auto cursor-pointer hover:text-text-light" onclick="this.nextElementSibling.classList.toggle('hidden')">▼ Ver detalles de uso</div><div class="hidden mt-2 border-t border-themed pt-2 space-y-1 text-xs text-left"><p>Mensajes de texto: <span class="font-bold float-right">100 / mes</span></p><p>Búsquedas web: <span class="font-bold float-right">10 / mes</span></p><p>Archivos / Imágenes: <span class="font-bold float-right">-</span></p></div></div><div class="plan-card border-2 rounded-xl p-6 flex flex-col bg-current-bg-dark plan-card-highlight"><h3 class="text-2xl font-bold">GOAT <span class="text-primary">BOOST</span></h3><p class="text-5xl font-extrabold my-3">$7</p><p class="text-sm text-text-medium mb-4">/ mes</p><button data-plan="boost" class="select-plan-btn w-full p-3 rounded-lg font-semibold btn-primary transition-colors">Obtener Boost</button><ul class="space-y-3 text-sm flex-grow mt-6 mb-4"><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Respuestas ultrarrápidas ⚡️</li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Historial ilimitado</li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Organización por Proyectos</li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>English Teacher</li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>Workflows Limitados</li></ul><div class="text-center text-text-medium text-xs mt-auto cursor-pointer hover:text-text-light" onclick="this.nextElementSibling.classList.toggle('hidden')">▼ Ver detalles de uso</div><div class="hidden mt-2 border-t border-themed pt-2 space-y-1 text-xs text-left"><p>Mensajes de texto: <span class="font-bold float-right">500 / mes</span></p><p>Búsquedas web: <span class="font-bold float-right">70 / mes</span></p><p>Archivos / Imágenes: <span class="font-bold float-right">10 / mes</span></p></div></div><div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col"><h3 class="text-2xl font-bold">GOAT <span class="text-primary">PRO</span></h3><p class="text-5xl font-extrabold my-3">$17</p><p class="text-sm text-text-medium mb-4">/ mes</p><button data-plan="pro" class="select-plan-btn w-full p-3 rounded-lg font-semibold btn-primary transition-colors">Quiero mi Plan Pro + Web</button><ul class="space-y-3 text-sm flex-grow mt-6 mb-4"><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span class="font-bold">Todo lo de Boost</span> y más</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Acceso a todos los modelos de IA</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Acceso a todos los Workflows</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Comunidad privada y webinars</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Asistencia prioritaria 1-a-1</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span class="font-bold">Página Web Gratis</span> para Fundadores</li></ul><div class="text-center text-text-medium text-xs mt-auto cursor-pointer hover:text-text-light" onclick="this.nextElementSibling.classList.toggle('hidden')">▼ Ver detalles de uso</div><div class="hidden mt-2 border-t border-themed pt-2 space-y-1 text-xs text-left"><p>Mensajes de texto: <span class="font-bold float-right">1,200 / mes</span></p><p>Búsquedas web: <span class="font-bold float-right">150 / mes</span></p><p>Archivos / Imágenes: <span class="font-bold float-right">30 / mes</span></p></div></div></div></div></div></div>
    <div id="html-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4"><div class="modal-content rounded-2xl w-full h-full max-w-4xl p-2 md:p-4 relative flex flex-col"><div class="flex-shrink-0 flex items-center justify-between mb-2"><h3 class="text-lg font-bold">Vista Previa</h3><button id="close-html-preview-modal" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button></div><iframe id="html-preview-iframe" class="w-full flex-grow h-full border-2 border-themed rounded-lg bg-white"></iframe></div></div>
    
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative">
            <h3 class="text-lg font-bold mb-4">Configuración</h3>
            <div class="space-y-4 text-sm">
                <div>
                    <p class="font-semibold">Correo Electrónico:</p>
                    <p id="settings-user-email" class="text-text-medium"></p>
                </div>
                <div>
                    <p class="font-semibold">Plan de Suscripción:</p>
                    <p id="settings-user-plan" class="text-text-medium"></p>
                    <button id="settings-upgrade-plan-btn" class="text-primary hover:underline mt-1 text-xs">Mejorar Plan</button>
                </div>
                <div>
                    <p class="font-semibold mb-2">Tamaño de Letra:</p>
                    <input type="range" id="font-size-slider" min="14" max="20" value="16" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg dark:bg-gray-700">
                    <span id="font-size-value" class="text-xs text-text-medium">16px</span>
                </div>
                <div>
                    <p class="font-semibold mb-2">Personalización:</p>
                    <button id="settings-theme-toggle" class="flex items-center p-2 rounded hover:bg-medium w-full text-left">
                        <i class="fas fa-moon mr-2" id="settings-theme-icon"></i>
                        Modo Oscuro
                    </button>
                </div>
                <div>
                    <p class="font-semibold mb-2">Idioma:</p>
                    <select id="language-selector" class="w-full p-2 rounded bg-input border border-themed">
                        <option value="es">Español</option>
                        <option value="en">English</option>
                        </select>
                </div>
                <div>
                    <button id="connect-whatsapp-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                        <i class="fab fa-whatsapp mr-2"></i> Conectarse a WhatsApp
                    </button>
                </div>
            </div>
            <button id="close-settings-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>

    <div id="calendar-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-2xl p-6 relative">
            <h3 class="text-lg font-bold mb-4">Mi Calendario y Tareas</h3>
            <div class="calendar-header">
                <button id="prev-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                <h4 id="current-month-year" class="text-xl font-semibold"></h4>
                <button id="next-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-grid mb-4">
                <div class="font-bold text-primary">Lun</div>
                <div class="font-bold text-primary">Mar</div>
                <div class="font-bold text-primary">Mié</div>
                <div class="font-bold text-primary">Jue</div>
                <div class="font-bold text-primary">Vie</div>
                <div class="font-bold text-primary">Sáb</div>
                <div class="font-bold text-primary">Dom</div>
            </div>
            <div id="calendar-days-grid" class="calendar-grid">
                </div>

            <div class="mt-6">
                <h4 class="font-semibold mb-2">Tareas para <span id="selected-date-display"></span>:</h4>
                <div id="tasks-list" class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                    <p class="text-text-medium italic" id="no-tasks-message">No hay tareas para este día.</p>
                </div>
                <input type="text" id="new-task-input" class="w-full p-2 rounded bg-input border border-themed mb-2" placeholder="Añadir nueva tarea o recordatorio...">
                <button id="add-task-btn" class="w-full btn-primary p-2 rounded-lg">Añadir Tarea</button>
            </div>

            <button id="close-calendar-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        window.addEventListener('DOMContentLoaded', () => {
            
            const GUEST_CREDIT_LIMIT = 5;
            const FREE_PLAN_CREDIT_LIMIT = 15;
            const COSTS = { WEB_PAGE: 2, COPYWRITING: 2, SALES_RESPONSE: 2, NEBULA: 2, GENERAL: 1, SEARCH: 1, ENGLISH_TEACHER: 1, IMAGE: 5 };
            let state = { chats: {}, projects: {}, structure: [], calendar: {} }; // Added calendar to state
            let currentChatId = null, currentUser = null, speechOn = false, availableVoices = [], selectedVoice = null, isRecognizing = false, selectedImageBase64 = null, selectedPdfText = null;
            let micWasOnBeforeSpeaking = false;
            let modalResolve = null;
            let isSelectModeActive = false;
            let chatsToDelete = new Set();

            let currentMonth = dayjs(); // For calendar navigation
            let selectedCalendarDate = dayjs(); // For task display
            
            const dom = {};
            
            const fullDom = {
                appContainer: document.getElementById('app-container'),
                msgInput: document.getElementById('msg'), sendBtn: document.getElementById('send'),
                messageCounterEl: document.getElementById('message-counter'), 
                upgradePlanContainer: document.getElementById('upgrade-plan-container'),
                upgradePlanBtn: document.getElementById('upgrade-plan-btn'),
                newChatBtn: document.getElementById('new-chat-btn'), newProjectBtn: document.getElementById('new-project-btn'),
                pricingModal: document.getElementById('pricing-modal'), closePricingModalBtn: document.getElementById('close-pricing-modal'),
                genericModal: document.getElementById('generic-modal'), chatMessages: document.getElementById('chat-messages'),
                chatTitle: document.getElementById('chat-title'),
                mobileChatTitle: document.getElementById('mobile-chat-title'),
                initialMessageContainer: document.getElementById('initial-message-container'),
                themeToggle: document.getElementById('theme-toggle'), themeIcon: document.getElementById('theme-icon'),
                micBtn: document.getElementById('mic-btn'),
                ttsToggle: document.getElementById('tts-toggle'),
                modelSelector: document.getElementById('model-selector'),
                imageUploadBtn: document.getElementById('image-upload-btn'), imageUploadInput: document.getElementById('image-upload'),
                imagePreviewContainer: document.getElementById('image-preview-container'), imagePreview: document.getElementById('image-preview'),
                clearImageBtn: document.getElementById('clear-image-btn'),
                pdfUploadBtn: document.getElementById('pdf-upload-btn'), pdfUploadInput: document.getElementById('pdf-upload'),
                pdfPreviewContainer: document.getElementById('pdf-preview-container'), pdfNameEl: document.getElementById('pdf-name'),
                pdfStatusEl: document.getElementById('pdf-status'), clearPdfBtn: document.getElementById('clear-pdf-btn'),
                sidebar: document.getElementById('sidebar'), menuToggle: document.getElementById('menu-toggle'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarContent: document.getElementById('sidebar-content'),
                loginView: document.getElementById('login-view'), userMenuView: document.getElementById('user-menu-view'),
                loginBtn: document.getElementById('login-btn'), userMenuBtn: document.getElementById('user-menu-btn'),
                userMenuPopup: document.getElementById('user-menu-popup'), userEmail: document.getElementById('user-email'),
                logoutBtn: document.getElementById('logout-btn'),
                webLaunchOfferBtn: document.getElementById('web-launch-offer-btn'),
                workflowsContainer: document.getElementById('workflows-container'),
                freeGuidesLink: document.getElementById('free-guides-link'),
                personalizedWelcome: document.getElementById('personalized-welcome'),
                genericWelcome: document.getElementById('generic-welcome'),
                userName: document.getElementById('user-name'),
                loadingOverlay: document.getElementById('loading-overlay'),
                htmlPreviewModal: document.getElementById('html-preview-modal'),
                closeHtmlPreviewModalBtn: document.getElementById('close-html-preview-modal'),
                htmlPreviewIframe: document.getElementById('html-preview-iframe'),
                voiceSelector: document.getElementById('voice-selector'),
                voiceSelectorContainer: document.getElementById('voice-selector-container'),
                selectChatsBtn: document.getElementById('select-chats-btn'),
                deleteModeControls: document.getElementById('delete-mode-controls'),
                deleteSelectedBtn: document.getElementById('delete-selected-btn'),
                cancelSelectModeBtn: document.getElementById('cancel-select-mode-btn'),
                imageGenBtn: document.getElementById('image-gen-btn'),
                servicesMenuBtn: document.getElementById('services-menu-btn'),
                servicesMenu: document.getElementById('services-menu'),
                contextualFooter: document.getElementById('contextual-footer'),
                imageGenBtnMobile: document.getElementById('image-gen-btn-mobile'),
                pdfUploadBtnMobile: document.getElementById('pdf-upload-btn-mobile'),
                imageUploadBtnMobile: document.getElementById('image-upload-btn-mobile'),
                // New elements for settings modal
                newChatIconBtn: document.getElementById('new-chat-icon-btn'),
                settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'),
                closeSettingsModal: document.getElementById('close-settings-modal'),
                settingsUserEmail: document.getElementById('settings-user-email'),
                settingsUserPlan: document.getElementById('settings-user-plan'),
                settingsUpgradePlanBtn: document.getElementById('settings-upgrade-plan-btn'),
                fontSizeSlider: document.getElementById('font-size-slider'),
                fontSizeValue: document.getElementById('font-size-value'),
                settingsThemeToggle: document.getElementById('settings-theme-toggle'),
                settingsThemeIcon: document.getElementById('settings-theme-icon'),
                languageSelector: document.getElementById('language-selector'),
                connectWhatsappBtn: document.getElementById('connect-whatsapp-btn'),
                chatTitleEditIconDesktop: document.getElementById('chat-title-edit-icon-desktop'),
                chatTitleEditIconMobile: document.getElementById('chat-title-edit-icon-mobile'),
                imageNameEl: document.getElementById('image-name'), // Added image name element

                // Calendar elements
                calendarBtn: document.getElementById('calendar-btn'),
                calendarModal: document.getElementById('calendar-modal'),
                closeCalendarModal: document.getElementById('close-calendar-modal'),
                prevMonthBtn: document.getElementById('prev-month'),
                nextMonthBtn: document.getElementById('next-month'),
                currentMonthYear: document.getElementById('current-month-year'),
                calendarDaysGrid: document.getElementById('calendar-days-grid'),
                selectedDateDisplay: document.getElementById('selected-date-display'),
                tasksList: document.getElementById('tasks-list'),
                newTaskInput: document.getElementById('new-task-input'),
                addTaskBtn: document.getElementById('add-task-btn'),
                noTasksMessage: document.getElementById('no-tasks-message'),
                freePlanButton: document.getElementById('free-plan-button') // Added for direct click
            };

            Object.assign(dom, fullDom);

            function updateContextualFooter(workflowKey) {
                if (!dom.contextualFooter) return;
                const workflowTexts = {
                    'create-full-post': 'Modo Redes Sociales: Define tu red social y tema para un post completo.',
                    'persuasive-copy': 'Modo Copywriter: Dime qué vendes y para dónde es el texto.',
                    'brand-strategy': 'Modo Estratega: Dime el nombre y rubro de tu negocio para empezar.',
                    'competitor-analysis': 'Modo Analista: Pega la URL de tu competencia para investigarla.',
                    'sales-assistant': 'Modo Asistente de Ventas: Pega el mensaje de tu cliente para responder.',
                    'english-teacher-practice': 'Practice mode: Let\'s talk. How was your day?',
                    'design-web': 'Modo Diseñador Web: Describe el componente visual y lo crearé en HTML.'
                };
                const currentChat = state.chats[currentChatId];
                const key = workflowKey || (currentChat ? currentChat.workflow : null);
                dom.contextualFooter.textContent = workflowTexts[key] || 'Tu copiloto de IA para hacer crecer tu negocio.';
            }

            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            function showModal({ title, message = '', useInput = false, useTextarea = false, placeholder = '', confirmText = 'Confirmar', initialValue = '' }) {
                const modalTitle = dom.genericModal.querySelector('#modal-title');
                const modalMessage = dom.genericModal.querySelector('#modal-message');
                const modalInput = dom.genericModal.querySelector('#modal-input');
                const modalTextarea = dom.genericModal.querySelector('#modal-textarea');
                const modalButtonsContainer = dom.genericModal.querySelector('#modal-buttons-container');
                
                modalTitle.innerHTML = title; 
                modalMessage.innerHTML = message;
                modalMessage.style.display = message ? 'block' : 'none';
                
                modalInput.style.display = useInput ? 'block' : 'none';
                modalTextarea.style.display = useTextarea ? 'block' : 'none';
                
                modalInput.value = initialValue;
                modalTextarea.value = initialValue;
                modalInput.placeholder = placeholder;
                modalTextarea.placeholder = placeholder;
                
                modalButtonsContainer.innerHTML = `<button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded">Cancelar</button><button id="modal-confirm" class="px-4 py-2 rounded text-white btn-primary">${confirmText}</button>`;
                dom.genericModal.querySelector('#modal-confirm').addEventListener('click', () => hideModal(useInput ? modalInput.value : (useTextarea ? modalTextarea.value : true)), { once: true });
                dom.genericModal.querySelector('#modal-cancel').addEventListener('click', () => hideModal(null), { once: true });
                
                dom.genericModal.classList.remove('hidden');
                dom.genericModal.classList.add('flex');
                if (useInput) modalInput.focus();
                if (useTextarea) modalTextarea.focus();
                
                return new Promise(resolve => { modalResolve = resolve; });
            }
            function hideModal(resolveWith = null) { if(modalResolve) { modalResolve(resolveWith); modalResolve = null; } dom.genericModal.classList.add('hidden'); dom.genericModal.classList.remove('flex');  }
            
            function showPricingModal() { dom.pricingModal.classList.remove('hidden'); dom.pricingModal.classList.add('flex'); setTimeout(() => { dom.pricingModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10); }
            function hidePricingModal() { dom.pricingModal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => { dom.pricingModal.classList.add('hidden'); dom.pricingModal.classList.remove('flex'); }, 300); }

            // Function to show settings modal
            function showSettingsModal() {
                dom.settingsModal.classList.remove('hidden');
                dom.settingsModal.classList.add('flex');
                if (currentUser) {
                    dom.settingsUserEmail.textContent = currentUser.email;
                    const userPlan = currentUser.app_metadata?.plan || 'Gratuito';
                    dom.settingsUserPlan.textContent = userPlan.charAt(0).toUpperCase() + userPlan.slice(1);
                    dom.settingsUpgradePlanBtn.classList.toggle('hidden', userPlan !== 'free');
                } else {
                    dom.settingsUserEmail.textContent = 'No logueado';
                    dom.settingsUserPlan.textContent = 'Gratuito (Invitado)';
                    dom.settingsUpgradePlanBtn.classList.remove('hidden');
                }
                // Ensure font size slider reflects current font size
                const currentFontSize = parseFloat(getComputedStyle(document.body).fontSize);
                dom.fontSizeSlider.value = currentFontSize;
                dom.fontSizeValue.textContent = `${currentFontSize}px`;

                dom.settingsThemeIcon.className = `fas fa-${document.body.classList.contains('dark-theme') ? 'moon' : 'sun'}`;
            }

            // Function to hide settings modal
            function hideSettingsModal() {
                dom.settingsModal.classList.add('hidden');
                dom.settingsModal.classList.remove('flex');
            }

            // Calendar functions
            function showCalendarModal() {
                dom.calendarModal.classList.remove('hidden');
                dom.calendarModal.classList.add('flex');
                renderCalendar();
                updateTasksDisplay();
            }

            function hideCalendarModal() {
                dom.calendarModal.classList.add('hidden');
                dom.calendarModal.classList.remove('flex');
            }

            function renderCalendar() {
                dom.calendarDaysGrid.innerHTML = '';
                dom.currentMonthYear.textContent = currentMonth.format('MMMM YYYY');

                const startOfMonth = currentMonth.startOf('month');
                const endOfMonth = currentMonth.endOf('month');
                const firstDayOfWeek = startOfMonth.day(); // 0 for Sunday, 1 for Monday etc. (Day.js default)
                
                // Adjust first day to be Monday (1)
                const startDayOffset = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1; 

                const startDate = startOfMonth.subtract(startDayOffset, 'day');

                for (let i = 0; i < 42; i++) { // 6 weeks to cover all days
                    const day = startDate.add(i, 'day');
                    const dayEl = document.createElement('div');
                    dayEl.classList.add('calendar-day');
                    dayEl.textContent = day.date();

                    if (day.month() === currentMonth.month()) {
                        dayEl.classList.add('current-month');
                    } else {
                        dayEl.classList.add('other-month');
                    }

                    // Check if this day has tasks
                    const dayKey = day.format('YYYY-MM-DD');
                    if (state.calendar[dayKey] && state.calendar[dayKey].length > 0) {
                        dayEl.classList.add('has-tasks');
                    }

                    if (day.isSame(selectedCalendarDate, 'day')) {
                        dayEl.classList.add('selected');
                    }

                    dayEl.addEventListener('click', () => {
                        selectedCalendarDate = day;
                        renderCalendar(); // Re-render to update selection
                        updateTasksDisplay();
                    });

                    dom.calendarDaysGrid.appendChild(dayEl);
                }
                updateTasksDisplay(); // Update tasks for the newly selected date
            }

            function updateTasksDisplay() {
                dom.selectedDateDisplay.textContent = selectedCalendarDate.format('DD/MM/YYYY');
                dom.tasksList.innerHTML = '';
                const dayKey = selectedCalendarDate.format('YYYY-MM-DD');
                const tasks = state.calendar[dayKey] || [];

                if (tasks.length === 0) {
                    dom.noTasksMessage.style.display = 'block';
                } else {
                    dom.noTasksMessage.style.display = 'none';
                    tasks.forEach((task, index) => {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'flex items-center justify-between p-2 rounded-md bg-current-bg-light';
                        taskEl.innerHTML = `
                            <span>${task}</span>
                            <button class="text-red-500 hover:text-red-400 delete-task-btn" data-index="${index}">
                                <i class="fas fa-trash-alt fa-sm"></i>
                            </button>
                        `;
                        dom.tasksList.appendChild(taskEl);
                    });

                    // Add event listeners for delete buttons
                    dom.tasksList.querySelectorAll('.delete-task-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const indexToDelete = parseInt(e.currentTarget.dataset.index);
                            state.calendar[dayKey].splice(indexToDelete, 1);
                            if (state.calendar[dayKey].length === 0) {
                                delete state.calendar[dayKey]; // Clean up empty array
                            }
                            saveState();
                            renderCalendar(); // Re-render calendar to update task indicators
                        });
                    });
                }
            }

            function addTask() {
                const taskText = dom.newTaskInput.value.trim();
                if (taskText) {
                    const dayKey = selectedCalendarDate.format('YYYY-MM-DD');
                    if (!state.calendar[dayKey]) {
                        state.calendar[dayKey] = [];
                    }
                    state.calendar[dayKey].push(taskText);
                    dom.newTaskInput.value = '';
                    saveState();
                    renderCalendar(); // Re-render calendar to update task indicators
                }
            }
            // End Calendar functions

            function speak(text) { 
                if (!speechOn || !('speechSynthesis' in window) || !text) return; 
                speechSynthesis.cancel();
                micWasOnBeforeSpeaking = isRecognizing;
                if (isRecognizing) { recognition.stop(); }
                const cleanText = text.replace(/<[^>]*>/g, '').replace(/[*_`#~[\]()🔍]|(-{3,})/g, ''); 
                const utterance = new SpeechSynthesisUtterance(cleanText); 
                if (selectedVoice) { utterance.voice = selectedVoice; }
                utterance.rate = 1.15;
                utterance.onend = () => {
                    if (micWasOnBeforeSpeaking) {
                        if (recognition && !isRecognizing) {
                            try { recognition.start(); } catch(e) { console.error("Error restarting recognition:", e); }
                        }
                        micWasOnBeforeSpeaking = false;
                    }
                };
                utterance.onerror = (e) => {
                    console.error('Speech synthesis error:', e);
                     if (micWasOnBeforeSpeaking) {
                        if (recognition && !isRecognizing) {
                           try { recognition.start(); } catch(e) { console.error("Error restarting recognition on error:", e); }
                        }
                        micWasOnBeforeSpeaking = false;
                    }
                }
                speechSynthesis.speak(utterance); 
            }

            function populateVoiceList() {
                if(!dom.voiceSelector) return;
                const setVoices = () => {
                    if (typeof speechSynthesis === 'undefined') {
                        return;
                    }
                    availableVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('es-'));
                    const preferredVoices = [ "Microsoft Sabina Online (Natural) - Spanish (Mexico)", "Paulina", "Google español de Estados Unidos", "Google español" ];
                     availableVoices.sort((a, b) => {
                        let aIdx = preferredVoices.indexOf(a.name); let bIdx = preferredVoices.indexOf(b.name);
                        if (aIdx === -1) aIdx = Infinity; if (bIdx === -1) bIdx = Infinity;
                        if (aIdx !== bIdx) return aIdx - bIdx;
                        return a.name.localeCompare(b.name);
                    });
                    dom.voiceSelector.innerHTML = '';
                    if(availableVoices.length > 0) {
                             dom.voiceSelector.disabled = false;
                        availableVoices.forEach(voice => {
                            const option = document.createElement('option');
                            const displayName = voice.name.replace('Microsoft', '').replace('Online (Natural) -', '').replace('Google', '').replace('Spanish (Mexico)','Mex').trim();
                            option.textContent = displayName || voice.lang;
                            option.value = voice.name;
                            dom.voiceSelector.appendChild(option);
                        });
                        selectedVoice = availableVoices[0];
                        if (selectedVoice) dom.voiceSelector.value = selectedVoice.name;
                    } 
                }
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = setVoices;
                }
                setTimeout(setVoices, 200);
            }

            function createSubtleUpsell(workflowKey) {
                const upsells = {
                     'create-full-post': "Tip de experto: La clave es la constancia. Si quieres un calendario de contenido para todo el mes, nuestros planes de gestión de redes son para ti.",
                     'persuasive-copy': "Un buen copy es el corazón de un anuncio ganador. Cuando estés listo para lanzar una campaña de publicidad completa con segmentación y presupuesto optimizado, nuestro equipo de marketing puede gestionarla por ti.",
                     'post-ideas': "Usa estas ideas para no quedarte en blanco. Recuerda que si necesitas llevar tu marca al siguiente nivel, podemos crear avatares con IA que hablen en videos. Es algo que nos diferencia.",
                     'brand-strategy': "Esta es la base. Para desarrollar una estrategia de marketing digital completa con anuncios y embudos, lo ideal es una sesión con nuestros consultores.",
                     'sales-assistant': "Tip Pro: ¿Sabías que podemos crear un bot que haga esto por ti 24/7, cualificando clientes mientras duermes? Si te interesa, hablemos de automatización.",
                     'email-writing': "El poder real de estos emails se desata al integrarlos en un sistema de marketing automático. Si quieres que te construyamos todo el sistema, contacta a nuestros especialistas.",
                     'english-teacher-practice': "Your English is improving! Quick tip: Strong communication is key in business. Our copywriting services help clients ensure their message is perfect for international markets."
                };
                const upsellText = upsells[workflowKey];
                if (upsellText) {
                    const upsellDiv = document.createElement('div');
                    upsellDiv.className = 'mt-3 pt-3 border-t border-themed text-xs text-text-medium italic';
                    upsellDiv.innerHTML = upsellText;
                    return upsellDiv;
                }
                return null;
            }

            function getModelForRequest(workflow, hasFile) {
                if (workflow === "design-web") return "gpt-4o-mini";
                if (hasFile) return "gpt-4o-mini";
                return dom.modelSelector.value;
            }

            async function getAIResponse(prompt, history, image, pdf, model, workflow, userName) {
                const name = (userName || '').split(' ')[0];
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }
                const body = { 
                    prompt, history, model,
                    workflow, userName: name, title,
                    imageData: image, pdfText: pdf, 
                };
                try {
                    const response = await fetch('/.netlify/functions/get-ai-response', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({details: 'Error desconocido en el servidor'}));
                        console.error("Backend Error:", errorData);
                        throw new Error(errorData.details || `Error del servidor: ${response.status}.`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("Fetch Error:", error);
                    throw error;
                }
            }
            
            function getCreditCount() {
                if (currentUser) {
                    const credits = localStorage.getItem(`userCredits_${currentUser.id}`);
                    return credits === null ? FREE_PLAN_CREDIT_LIMIT : parseInt(credits, 10);
                } else {
                    const credits = localStorage.getItem('guestCreditCount');
                    return credits === null ? GUEST_CREDIT_LIMIT : parseInt(credits, 10);
                }
            }
            
            function setCreditCount(newCount) {
                const count = Math.max(0, newCount);
                if (currentUser) {
                    localStorage.setItem(`userCredits_${currentUser.id}`, count);
                } else {
                    localStorage.setItem('guestCreditCount', count);
                }
                updateCreditCounter();
            }

            async function loadStateForUser() {
                if (!currentUser) {
                    const saved = localStorage.getItem('guestState');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        state = parsed.state || { chats: {}, projects: {}, structure: {}, calendar: {} };
                        currentChatId = parsed.currentChatId;
                    } else {
                        state = { chats: {}, projects: {}, structure: {}, calendar: {} };
                        currentChatId = null;
                    }
                    renderSidebar();
                    selectChat(currentChatId);
                    return;
                }

                try {
                    const response = await fetch('/.netlify/functions/load-chats', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: currentUser.id }),
                    });

                    if (!response.ok) { throw new Error(`Server error: ${response.status}`); }
                    const dbState = await response.json();
                    // Ensure calendar property exists and defaults if not present from DB
                    state = dbState.state || { chats: {}, projects: {}, structure: {}, calendar: {} };
                    if (!state.calendar) {
                        state.calendar = {};
                    }
                    currentChatId = dbState.currentChatId;
                } catch (error) {
                    console.error("Could not load from DB, falling back to localStorage:", error);
                    const saved = localStorage.getItem(`goatbotState_${currentUser.id}`);
                    state = saved ? (JSON.parse(saved).state || { chats: {}, projects: {}, structure: {}, calendar: {} }) : { chats: {}, projects: {}, structure: {}, calendar: {} };
                    if (!state.calendar) {
                        state.calendar = {};
                    }
                    currentChatId = saved ? JSON.parse(saved).currentChatId : null;
                }
                
                renderSidebar();
                selectChat(currentChatId);
            }

            async function saveState() {
                if (!currentUser) {
                    try {
                        localStorage.setItem('guestState', JSON.stringify({ state, currentChatId }));
                    } catch (e) { console.error("Guest localStorage is full.", e); }
                    return;
                }
                try {
                    const stateToSave = { state, currentChatId };
                    await fetch('/.netlify/functions/save-chats', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            userId: currentUser.id,
                            stateToSave: stateToSave
                        }),
                    });
                } catch (error) {
                    console.error("Failed to save state to DB:", error);
                }
            }
            
            function updateUserUI() {
                if (currentUser) {
                    dom.loginView.classList.add('hidden');
                    dom.userMenuView.classList.remove('hidden');
                    dom.genericWelcome.classList.add('hidden');
                    dom.personalizedWelcome.classList.remove('hidden');
                    const userName = currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.email.split('@')[0];
                    dom.userEmail.textContent = currentUser.user_metadata?.full_name || currentUser.email;
                    dom.userName.textContent = userName;
                    dom.upgradePlanContainer.classList.toggle('hidden', (currentUser.app_metadata?.plan || 'free') !== 'free');
                } else {
                    dom.loginView.classList.remove('hidden');
                    dom.userMenuView.classList.add('hidden');
                    dom.genericWelcome.classList.remove('hidden');
                    dom.personalizedWelcome.classList.add('hidden');
                    dom.upgradePlanContainer.classList.add('hidden');
                }
                updateCreditCounter();
            }

            function updateCreditCounter() {
                const count = getCreditCount();
                const limit = currentUser ? FREE_PLAN_CREDIT_LIMIT : GUEST_CREDIT_LIMIT;
                dom.messageCounterEl.innerHTML = `${count}/${limit} <span class="hidden sm:inline">créditos</span>`;
            }

            function setTheme(isDark) { 
                document.body.className = 'w-screen overflow-x-hidden';
                document.body.classList.add(isDark ? 'dark-theme' : 'light-theme');
                dom.themeIcon.className = `fas fa-${isDark ? 'sun' : 'moon'}`; 
                if (dom.settingsThemeIcon) dom.settingsThemeIcon.className = `fas fa-${isDark ? 'moon' : 'sun'}`; // Update settings modal icon
                localStorage.setItem('theme', isDark ? 'dark' : 'light'); 
            }

            function toggleSidebar(show) {
                if (show) {
                    dom.sidebar.classList.add('is-open');
                    dom.sidebarOverlay.classList.remove('pointer-events-none');
                    dom.sidebarOverlay.classList.add('opacity-50');
                } else {
                    dom.sidebar.classList.remove('is-open');
                    dom.sidebarOverlay.classList.remove('opacity-50');
                    dom.sidebarOverlay.classList.add('pointer-events-none');
                }
            }
            
            function createNewChat(options = {}) {
                const id = 'chat-' + crypto.randomUUID();
                const name = currentUser ? (currentUser.user_metadata.full_name?.split(' ')[0] || 'Tú') : 'viajero';
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }
                const initialMessages = options.initialMessages || [{ 
                    role: 'assistant', 
                    content: `Saludos, ${title}. Soy Goatify AI, aquí para servirte. Cada idea tuya es una estrella a punto de nacer. ¿En qué universo nos sumergimos hoy?` 
                }];
                state.chats[id] = { 
                    id, 
                    title: options.title || "Conversación Cósmica", 
                    messages: initialMessages,
                    workflow: options.workflow || null,
                    model: options.model || 'gpt-3.5-turbo-1106'
                }; 
                state.structure.unshift(id); 
                selectChat(id); 
                saveState(); 
                renderSidebar(); 
                dom.modelSelector.value = options.model || 'gpt-3.5-turbo-1106';
                updateModelSelectorState();
                if (window.innerWidth < 768) toggleSidebar(false);
                return id; 
            }

            function selectChat(chatId) { 
                if (isSelectModeActive) return;
                if (!chatId || !state.chats[chatId]) { resetChatView(); return; } 
                currentChatId = chatId; 
                dom.initialMessageContainer.style.display = 'none'; 
                dom.chatMessages.innerHTML = ''; 
                const chat = state.chats[chatId]; 
                
                // Update the text content of the h1/h2 elements and ensure icon is present
                dom.chatTitle.childNodes[0].nodeValue = chat.title + ' '; 
                if (!dom.chatTitle.querySelector('.chat-title-edit-icon')) { // Add icon if not present
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-pencil-alt chat-title-edit-icon';
                    icon.id = 'chat-title-edit-icon-desktop';
                    dom.chatTitle.appendChild(icon);
                }

                if (dom.mobileChatTitle) {
                    dom.mobileChatTitle.childNodes[0].nodeValue = chat.title + ' ';
                    if (!dom.mobileChatTitle.querySelector('.chat-title-edit-icon')) { // Add icon if not present
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-pencil-alt chat-title-edit-icon';
                        icon.id = 'chat-title-edit-icon-mobile';
                        dom.mobileChatTitle.appendChild(icon);
                    }
                }

                chat.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, msg.image, index)); 
                dom.modelSelector.value = chat.model || 'gpt-3.5-turbo-1106';
                updateActiveChatHighlight(); 
                saveState();
                updateModelSelectorState();
                updateContextualFooter(chat.workflow);
                if (window.innerWidth < 768) toggleSidebar(false);
            }

            function resetChatView() { 
                currentChatId = null; 
                dom.chatTitle.childNodes[0].nodeValue = "Goatify AI "; // Reset text and keep space for icon
                if (dom.mobileChatTitle) dom.mobileChatTitle.childNodes[0].nodeValue = "Goatify AI ";
                dom.chatMessages.innerHTML = ''; 
                dom.initialMessageContainer.style.display = 'flex'; 
                updateUserUI(); 
                updateActiveChatHighlight(); 
                dom.modelSelector.value = 'gpt-3.5-turbo-1106';
                updateModelSelectorState();
                updateContextualFooter(null);
            }

            function addMessageToUI(role, content, imageSrc, messageIndex) {
                const wrapper = document.createElement('div');
                wrapper.className = `chat-bubble-wrapper flex items-start gap-2 my-2 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                const bubble = document.createElement('div');
                bubble.className = `p-3 md:p-4 rounded-xl max-w-lg md:max-w-xl ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot'}`;
                if (role === 'user') { bubble.classList.add('group', 'relative'); }
                if (imageSrc) {
                    const img = document.createElement('img');
                    img.src = imageSrc;
                    img.className = 'rounded-lg mb-2 max-w-full h-auto';
                    bubble.appendChild(img);
                }
                const contentDiv = document.createElement('div');
                contentDiv.className = 'markdown-content';
                contentDiv.innerHTML = content === '…' ? `<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .2s;"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .4s;"></div></div>` : marked.parse(content || "");
                bubble.appendChild(contentDiv);

                if (role === 'user') {
                    const actionsWrapper = document.createElement('div');
                    actionsWrapper.className = 'absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity';
                    const editBtn = document.createElement('button');
                    editBtn.className = 'p-1 text-white/70 hover:text-white';
                    editBtn.innerHTML = '<i class="fas fa-pencil-alt fa-xs"></i>';
                    editBtn.title = 'Editar mensaje';
                    editBtn.onclick = (e) => { e.stopPropagation(); handleEditMessage(messageIndex); };
                    actionsWrapper.appendChild(editBtn);
                    bubble.appendChild(actionsWrapper);
                }

                if (role === 'assistant' && /<\/?[a-z][\s\S]*>/i.test(content)) {
                    const previewButton = document.createElement('button');
                    previewButton.innerHTML = '<i class="fas fa-eye mr-2"></i>Vista Previa';
                    previewButton.className = 'btn-primary text-xs font-semibold px-3 py-1 rounded-md mt-3';
                    previewButton.addEventListener('click', () => {
                        const match = content.match(/```html\n([\s\S]*?)```/);
                        const htmlToPreview = match ? match[1] : content;
                        dom.htmlPreviewIframe.srcdoc = htmlToPreview;
                        dom.htmlPreviewModal.classList.remove('hidden');
                        dom.htmlPreviewModal.classList.add('flex');
                    });
                    bubble.appendChild(previewButton);
                }
                const currentChat = state.chats[currentChatId];
                if (role === 'assistant' && currentChat?.workflow) {
                    if (currentChat.messages.filter(m => m.role === 'assistant').length > 1 || currentChat.messages.filter(m => m.role === 'user').length > 0) {
                             const upsellElement = createSubtleUpsell(currentChat.workflow);
                             if (upsellElement) {
                                 setTimeout(() => { bubble.appendChild(upsellElement); }, 50);
                             }
                    }
                }
                wrapper.appendChild(bubble);
                dom.chatMessages.appendChild(wrapper);
                dom.chatMessages.scrollTop = dom.chatMessages.scrollHeight;
                return bubble;
            }
            
            async function handleEditMessage(index) {
                const chat = state.chats[currentChatId];
                if (!chat || !chat.messages[index]) return;
                const originalContent = chat.messages[index].content;
                const newContent = await showModal({
                    title: 'Editar Mensaje',
                    useTextarea: true,
                    initialValue: originalContent,
                    confirmText: 'Guardar Cambios'
                });
                if (newContent && newContent.trim() !== originalContent.trim()) {
                    chat.messages[index].content = newContent.trim();
                    await saveState();
                    selectChat(currentChatId);
                }
            }

            function updateMessageInUI(bubble, content, imageSrc) {
                const newBubble = addMessageToUI('assistant', content, imageSrc);
                if (bubble && bubble.parentElement) {
                    bubble.parentElement.replaceWith(newBubble.parentElement);
                }
            }
            
            function renderSidebar() { 
                dom.sidebarContent.innerHTML = ''; 
                const frag = document.createDocumentFragment(); 
                (state.structure || []).forEach(id => { 
                    if (id.startsWith('project-')) {
                        frag.appendChild(createProjectElement(id));
                    } else if (id.startsWith('chat-')) {
                             frag.appendChild(createChatItemElement(id));
                    }
                }); 
                dom.sidebarContent.appendChild(frag); 
                updateActiveChatHighlight(); 
            }
            function createChatItemElement(id, isSubItem = false) { 
                const chat = state.chats[id]; 
                if (!chat) return document.createDocumentFragment(); 
                const item = document.createElement('div'); 
                item.className = `chat-item group flex items-center justify-between p-2 rounded-md cursor-pointer ${isSubItem ? 'pl-5' : ''}`; item.dataset.id = id; 
                if (isSelectModeActive) {
                    item.draggable = false;
                    const isSelected = chatsToDelete.has(id);
                    item.innerHTML = `<i class="far ${isSelected ? 'fa-check-square' : 'fa-square'} mr-2 text-primary"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span>`;
                    if (isSelected) item.classList.add('selected-for-delete');
                    item.addEventListener('click', () => {
                        if (chatsToDelete.has(id)) {
                            chatsToDelete.delete(id);
                            item.querySelector('i').classList.replace('fa-check-square', 'fa-square');
                            item.classList.remove('selected-for-delete');
                        } else {
                            chatsToDelete.add(id);
                            item.querySelector('i').classList.replace('fa-square', 'fa-check-square');
                            item.classList.add('selected-for-delete');
                        }
                        dom.deleteSelectedBtn.disabled = chatsToDelete.size === 0;
                    });
                } else {
                    item.draggable = true;
                    item.innerHTML = `<i class="far fa-comment-dots mr-2"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span><div class="chat-item-actions flex-shrink-0"><button class="rename-btn text-text-medium hover:text-primary p-1"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-text-medium hover:text-red-500 p-1"><i class="fas fa-trash-alt fa-xs"></i></button></div>`; 
                    item.addEventListener('click', e => { if (!e.target.closest('.chat-item-actions')) selectChat(id); }); 
                    item.addEventListener('dragstart', e => handleDragStart(e, id)); item.querySelector('.rename-btn').addEventListener('click', () => renameItem('chat', id)); item.querySelector('.delete-btn').addEventListener('click', () => deleteItem('chat', id));
                }
                return item; 
            }
            function createProjectElement(id) {
                const project = state.projects[id];
                if (!project) return document.createDocumentFragment();
                const div = document.createElement('div'); div.className = 'project'; div.dataset.id = id;
                const header = document.createElement('div'); header.className = 'project-header group flex items-center p-2 rounded-md cursor-pointer';
                header.innerHTML = `<i class="fas fa-chevron-right project-arrow mr-2 transition-transform"></i><i class="fas fa-folder mr-2 text-yellow-500"></i><span class="flex-grow truncate text-sm font-bold">${project.title}</span><div class="chat-item-actions flex-shrink-0"><button class="rename-btn text-text-medium hover:text-primary p-1"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-text-medium hover:text-red-500 p-1"><i class="fas fa-trash-alt fa-xs"></i></button></div>`;
                const content = document.createElement('div'); content.className = 'project-content pl-2 pt-1 space-y-1';
                (project.chatIds || []).forEach(chatId => content.appendChild(createChatItemElement(chatId, true)));
                div.append(header, content);
                header.addEventListener('click', e => { if (!e.target.closest('.chat-item-actions')) div.classList.toggle('open'); });
                header.addEventListener('dragover', e => handleDragOver(e, header));
                header.addEventListener('dragleave', e => handleDragLeave(e, header));
                header.addEventListener('drop', e => handleDrop(e, id, header));
                header.querySelector('.rename-btn').addEventListener('click', () => renameItem('project', id));
                header.querySelector('.delete-btn').addEventListener('click', () => deleteItem('project', id));
                return div;
            }
            let draggedItemId = null; function handleDragStart(e, id) { draggedItemId = id; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', id); } function handleDragOver(e, el) { e.preventDefault(); el.classList.add('drag-over'); } function handleDragLeave(e, el) { el.classList.remove('drag-over'); }
            function handleDrop(e, targetProjectId, targetElement) {
                e.preventDefault(); if (targetElement) targetElement.classList.remove('drag-over');
                const sourceChatId = e.dataTransfer.getData('text/plain');
                if (!sourceChatId || !sourceChatId.startsWith('chat-') || targetProjectId === sourceChatId) return;
                state.structure = state.structure.filter(id => id !== sourceChatId); 
                Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(id => id !== sourceChatId) }); 
                if(state.projects[targetProjectId]){ 
                    if(!state.projects[targetProjectId].chatIds) state.projects[targetProjectId].chatIds = [];
                    state.projects[targetProjectId].chatIds.unshift(sourceChatId); 
                } 
                saveState(); renderSidebar(); 
            }
            async function renameItem(type, id) {
                const item = type === 'chat' ? state.chats[id] : state.projects[id];
                if(!item) return;
                const newName = await showModal({ title: `Renombrar ${type === 'chat' ? 'Conversación' : 'Proyecto'}`, useInput: true, placeholder: item.title, initialValue: item.title });
                if (newName && newName.trim()) {
                    item.title = newName.trim();
                    if (type === 'chat' && currentChatId === id) {
                        dom.chatTitle.childNodes[0].nodeValue = item.title + ' '; // Update text node directly
                        if (dom.mobileChatTitle) dom.mobileChatTitle.childNodes[0].nodeValue = item.title + ' '; // Update mobile too
                    }
                    saveState();
                    renderSidebar();
                }
            }
            async function deleteItem(type, id) { const item = type === 'chat' ? state.chats[id] : state.projects[id]; const conf = await showModal({ title: `Eliminar ${item.title}?`, message: 'Esta acción no se puede deshacer.', confirmText: 'Eliminar' }); if (conf) { state.structure = state.structure.filter(i => i !== id); if (type === 'project') { (item.chatIds || []).forEach(cid => delete state.chats[cid]); delete state.projects[id]; } else { delete state.chats[id]; Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(cid => cid !== id) }); } if(currentChatId === id || (type === 'project' && (item.chatIds || []).includes(currentChatId))) resetChatView(); saveState(); renderSidebar(); } }
            function updateActiveChatHighlight() { document.querySelectorAll('.chat-item').forEach(item => { item.style.backgroundColor = item.dataset.id === currentChatId ? 'var(--current-primary)' : 'transparent'; }); }
            
            // Modified file clear functions
            function clearImageData() {
                dom.imageUploadInput.value = '';
                dom.imagePreviewContainer.style.display = 'none'; // Hide the container
                selectedImageBase64 = null;
                dom.imageNameEl.textContent = ''; // Clear image name
            }

            function clearPdfData() {
                dom.pdfUploadInput.value = '';
                dom.pdfPreviewContainer.style.display = 'none'; // Hide the container
                selectedPdfText = null;
                dom.pdfNameEl.textContent = ''; // Clear PDF name
                dom.pdfStatusEl.textContent = ''; // Clear PDF status
            }

            function hasFile() { return selectedImageBase64 || selectedPdfText; }
            async function sendMessage(forceSend = false, spokenMessage = null) {
                const userMessage = spokenMessage || dom.msgInput.value.trim();
                if (!userMessage && !selectedImageBase64 && !selectedPdfText) return;
                let chatIdToUpdate = currentChatId || createNewChat({});
                const currentChat = state.chats[chatIdToUpdate];
                if (!currentChat) return;
                let modelToUse = getModelForRequest(currentChat.workflow, hasFile());
                const webSearchTriggers = ['busca', 'investiga', 'en internet', 'tiempo real', 'qué día es hoy', 'qué fecha es hoy', 'cuál es el precio de', 'quién es', 'qué es', 'noticias sobre'];
                const requiresWebSearch = webSearchTriggers.some(trigger => userMessage.toLowerCase().startsWith(trigger));
                if (requiresWebSearch && !hasFile() && !currentChat.workflow) { modelToUse = 'sonar'; }
                let cost = COSTS.GENERAL;
                if (currentChat.workflow) { cost = COSTS.COPYWRITING; }
                if (modelToUse === 'sonar') { cost = COSTS.SEARCH; }
                else if (modelToUse.includes('gpt-4') && hasFile()) { cost = COSTS.NEBULA; }
                let count = getCreditCount();
                if (count < cost && !forceSend) {
                    if (currentUser) { showPricingModal(); } 
                    else { showModal({ title: 'Créditos Agotados', message: `Por favor, inicia sesión para obtener más créditos.`, confirmText: 'Iniciar Sesión' }).then(login => { if (login) netlifyIdentity.open('login'); });}
                    return;
                }
                if(currentChat.title === 'Conversación Cósmica' && userMessage.length > 5) {
                    currentChat.title = userMessage.split(' ').slice(0, 4).join(' ');
                    renderSidebar();
                }
                setCreditCount(count - cost);
                const [image, pdf] = [selectedImageBase64, selectedPdfText];
                currentChat.messages.push({ role: 'user', content: userMessage, image, pdfText: pdf });
                addMessageToUI('user', userMessage, image, currentChat.messages.length - 1);
                const thinkingBubble = addMessageToUI('assistant', '…');
                dom.msgInput.value = ''; dom.msgInput.style.height = 'auto'; clearImageData(); clearPdfData();
                try {
                    const userNameForCall = currentUser ? (currentUser.user_metadata.full_name || currentUser.email) : 'viajero';
                    const responseData = await getAIResponse(userMessage, currentChat.messages.slice(0, -1), image, pdf, modelToUse, currentChat.workflow, userNameForCall);
                    if (responseData.error === 'LIMIT_REACHED') {
                        updateMessageInUI(thinkingBubble, `Has alcanzado el límite de créditos de tu plan. ¡Actualiza para continuar!`);
                        setCreditCount(0); showPricingModal(); return;
                    }
                    if (responseData.reply) {
                        updateCreditCounter();
                        currentChat.messages.push({ role: 'assistant', content: responseData.reply });
                        updateMessageInUI(thinkingBubble, responseData.reply);
                        speak(responseData.reply);
                        saveState();
                    } else if (responseData.error) {
                        updateMessageInUI(thinkingBubble, `❌ **Error**<br><small>${responseData.details || 'Error del servidor.'}</small>`);
                        setCreditCount(count);
                    }
                } catch (error) {
                    updateMessageInUI(thinkingBubble, `❌ **Error de Conexión**<br><small>${error.message || 'No se pudo conectar al servidor.'}</small>`);
                    setCreditCount(count);
                }
            }
            async function generateImage() {
                const prompt = await showModal({ title: 'Crear Imagen', message: 'Describe la imagen que quieres crear:', useInput: true, placeholder: 'Ej: Un astronauta en un caballo cósmico', confirmText: 'Generar' });
                if (!prompt) { hideModal(); return; }
                hideModal();
                let count = getCreditCount();
                if (count < COSTS.IMAGE) {
                    showModal({ title: 'Créditos Insuficientes', message: `Necesitas ${COSTS.IMAGE} créditos para generar una imagen.` });
                    return;
                }
                setCreditCount(count - COSTS.IMAGE);
                let chatIdToUpdate = currentChatId || createNewChat({});
                const currentChat = state.chats[chatIdToUpdate];
                currentChat.messages.push({ role: 'user', content: `Generar imagen: "${prompt}"` });
                addMessageToUI('user', `Generar imagen: "${prompt}"`, null, currentChat.messages.length - 1);
                const thinkingBubble = addMessageToUI('assistant', 'Creando tu visión con DALL·E 2...');
                try {
                    const response = await fetch('/.netlify/functions/generate-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: 'dall-e-2' })
                    });
                     if (!response.ok) {
                        let errorText;
                        try {
                            const errorData = await response.json();
                            errorText = errorData.error || 'No se pudo generar la imagen.';
                        } catch (e) {
                            errorText = `Error del servidor (${response.status}). Inténtalo de nuevo.`;
                        }
                        throw new Error(errorText);
                    }
                    const { imageData } = await response.json();
                    const imageContent = `¡Aquí está tu creación, Jefe/a!`;
                    currentChat.messages.push({ role: 'assistant', content: imageContent, image: imageData });
                    updateMessageInUI(thinkingBubble, imageContent, imageData);
                    saveState();
                } catch (error) {
                    updateMessageInUI(thinkingBubble, `❌ **Error al crear la imagen:**<br><small>${error.message}</small>`);
                    setCreditCount(count);
                }
            }
            function toggleSelectMode(active) {
                isSelectModeActive = active;
                dom.selectChatsBtn.classList.toggle('hidden', active);
                dom.deleteModeControls.classList.toggle('hidden', !active);
                if (!active) {
                    chatsToDelete.clear();
                    dom.deleteSelectedBtn.disabled = true;
                }
                renderSidebar();
            }

            function setupEventListeners() {
                dom.sendBtn?.addEventListener('click', () => sendMessage());
                const stopSpeech = () => { if(speechSynthesis.speaking) speechSynthesis.cancel(); };
                dom.msgInput?.addEventListener('keydown', (e) => { 
                    stopSpeech();
                    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } 
                });
                dom.msgInput?.addEventListener('input', () => { 
                    stopSpeech();
                    dom.msgInput.style.height = 'auto'; 
                    dom.msgInput.style.height = (dom.msgInput.scrollHeight) + 'px';
                });
                dom.newChatBtn?.addEventListener('click', () => createNewChat());
                // New Chat icon click event
                dom.newChatIconBtn?.addEventListener('click', () => createNewChat());
                dom.newProjectBtn?.addEventListener('click', async () => { const name = await showModal({ title: 'Crear Proyecto', useInput: true, placeholder: 'Nombre del Proyecto...' }); if (name && name.trim()) { const id = 'project-' + crypto.randomUUID(); state.projects[id] = { id, title: name.trim(), chatIds: [] }; state.structure.unshift(id); saveState(); renderSidebar(); } });
                dom.upgradePlanBtn?.addEventListener('click', showPricingModal);
                dom.closePricingModalBtn?.addEventListener('click', hidePricingModal);
                dom.themeToggle?.addEventListener('click', () => setTheme(!document.body.classList.contains('dark-theme')));
                dom.loginBtn?.addEventListener('click', () => netlifyIdentity.open('login'));
                
                // Event listener for chat title edit (desktop)
                dom.chatTitle.addEventListener('click', (e) => { 
                    // Only trigger if the click is on the title text or the icon itself
                    if (e.target === dom.chatTitle || e.target === dom.chatTitle.querySelector('.chat-title-edit-icon')) {
                        if(currentChatId) renameItem('chat', currentChatId); 
                    }
                });
                // Event listener for mobile chat title edit
                dom.mobileChatTitle?.addEventListener('click', (e) => { 
                     // Only trigger if the click is on the title text or the icon itself
                    if (e.target === dom.mobileChatTitle || e.target === dom.mobileChatTitle.querySelector('.chat-title-edit-icon')) {
                        if(currentChatId) renameItem('chat', currentChatId); 
                    }
                });

                dom.imageGenBtn?.addEventListener('click', generateImage);
                dom.imageGenBtnMobile?.addEventListener('click', generateImage);
                dom.pdfUploadBtn?.addEventListener('click', () => dom.pdfUploadInput.click());
                dom.pdfUploadBtnMobile?.addEventListener('click', () => dom.pdfUploadInput.click());
                dom.imageUploadBtn?.addEventListener('click', () => dom.imageUploadInput.click());
                dom.imageUploadBtnMobile?.addEventListener('click', () => dom.imageUploadInput.click());
                
                if (SR && dom.micBtn) {
                    recognition = new SR(); 
                    recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'es-ES'; 
                    recognition.onstart = () => { 
                        isRecognizing = true; 
                        dom.micBtn.classList.add('glowing-mic');
                        dom.voiceSelectorContainer.classList.remove('hidden');
                        dom.voiceSelectorContainer.classList.add('flex');
                    };
                    recognition.onend = () => { 
                        isRecognizing = false; 
                        dom.micBtn.classList.remove('glowing-mic'); 
                        dom.voiceSelectorContainer.classList.add('hidden');
                        dom.voiceSelectorContainer.classList.remove('flex');
                    };
                    recognition.onerror = (e) => { console.error("Speech recognition error", e); isRecognizing = false; dom.micBtn.classList.remove('glowing-mic'); };
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        if(transcript) { dom.msgInput.value = transcript; sendMessage(); }
                    };
                    dom.micBtn.addEventListener('click', () => { 
                        if(isRecognizing) {
                            recognition.stop();
                        } else {
                            if (speechSynthesis.speaking) { speechSynthesis.cancel(); }
                            try { recognition.start(); } catch(e) {console.error("Could not start recognition", e)}
                        }
                    });
                } else { if(dom.micBtn) dom.micBtn.style.display = 'none'; }
                
                dom.ttsToggle?.addEventListener('click', () => {
                    speechOn = !speechOn;
                    const icon = dom.ttsToggle.querySelector('i');
                    icon.classList.toggle('fa-volume-high', speechOn);
                    icon.classList.toggle('fa-volume-mute', !speechOn);
                    if (!speechOn) {
                        speechSynthesis.cancel();
                    }
                });

                dom.modelSelector?.addEventListener('change', () => { updateModelSelectorState(); });
                dom.clearImageBtn?.addEventListener('click', clearImageData);
                dom.clearPdfBtn?.addEventListener('click', clearPdfData);
                
                // Updated image upload logic
                dom.imageUploadInput?.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        clearPdfData(); // Clear PDF if image is uploaded
                        const file = e.target.files[0];
                        dom.imageNameEl.textContent = file.name; // Display file name
                        dom.imagePreviewContainer.style.display = 'flex'; // Show container as flex

                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            selectedImageBase64 = ev.target.result;
                            dom.imagePreview.src = selectedImageBase64; // Set image src
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                // Updated PDF upload logic
                dom.pdfUploadInput?.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file || file.type !== 'application/pdf') return;
                    clearImageData(); // Clear image if PDF is uploaded
                    dom.pdfNameEl.textContent = file.name;
                    dom.pdfStatusEl.textContent = 'Leyendo...';
                    dom.pdfPreviewContainer.style.display = 'flex'; // Show container as flex

                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        dom.pdfStatusEl.textContent = 'Procesando...';
                        try {
                            const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(ev.target.result) }).promise;
                            let text = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const content = await page.getTextContent();
                                text += content.items.map(item => item.str).join(' ') + '\n';
                            }
                            selectedPdfText = text;
                            dom.pdfStatusEl.textContent = `✅ Listo (${pdf.numPages} pág.)`;
                        } catch (err) {
                            console.error("Error al procesar el PDF:", err);
                            dom.pdfStatusEl.textContent = '❌ Error al leer PDF.';
                            selectedPdfText = null;
                            setTimeout(clearPdfData, 2000);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });

                dom.menuToggle?.addEventListener('click', (e) => { e.stopPropagation(); toggleSidebar(true); });
                dom.sidebarOverlay?.addEventListener('click', () => toggleSidebar(false));
                dom.userMenuBtn?.addEventListener('click', (e) => { e.stopPropagation(); dom.userMenuPopup.classList.toggle('hidden'); });
                dom.logoutBtn?.addEventListener('click', () => { netlifyIdentity.logout(); dom.userMenuPopup.classList.add('hidden');});
                
                const workflowConfigs = {
                    'create-full-post': { title: "Creador de Posts", workflow: 'create-full-post', initialMessages: [{ role: 'assistant', content: '¡Claro! Vamos a crear un post increíble. ¿Para qué red social lo necesitas (Instagram, Facebook, LinkedIn, etc.)?' }] },
                    'persuasive-copy': { title: "Redactor de Copys", workflow: 'persuasive-copy', initialMessages: [{ role: 'assistant', content: 'Estoy listo para redactar textos que vendan. ¿Para qué necesitas este copy? (ej: Anuncio de Facebook, Post de Venta, Descripción de Producto)' }] },
                    'post-ideas': { title: "Lluvia de Ideas", workflow: 'post-ideas', initialMessages: [{ role: 'assistant', content: '¡Acabemos con el bloqueo creativo! Dime un tema y te daré 7 ideas de contenido excelentes.' }] },
                    'brand-strategy': { title: "Estratega de Marca", workflow: 'brand-strategy', initialMessages: [{ role: 'assistant', content: 'Definamos el corazón de tu marca. ¿Cuál es el nombre de tu negocio y a qué se dedica?' }] },
                    'competitor-analysis': { title: "Análisis de Competencia", workflow: 'competitor-analysis', model: 'sonar', initialMessages: [{ role: 'assistant', content: "Estoy listo para analizar a tu competencia usando el buscador web. Por favor, pega la URL (dirección web) de la página que quieres que investigue para entregarte un análisis DAFO simplificado." }] },
                    'buyer-persona': { title: "Creación de Cliente Ideal", workflow: 'buyer-persona', initialMessages: [{ role: 'assistant', content: "Vamos a definir a tu cliente ideal (Buyer Persona). Describe tu producto o servicio, y te haré preguntas para construir el perfil detallado paso a paso." }] },
                    'brand-names': { title: "Nombres para Marca", workflow: 'brand-names', initialMessages: [{ role: 'assistant', content: "¡Excelente! Busquemos un nombre increíble. Describe brevemente tu idea de negocio, tu público y el estilo que buscas (ej. moderno, clásico, divertido) para generar nombres y slogans." }] },
                    'sales-assistant': { title: "Asistente de Ventas", workflow: 'sales-assistant', initialMessages: [{ role: 'assistant', content: 'Para ayudarte a cerrar esa venta, pega aquí el mensaje de tu cliente.' }] },
                    'email-writing': { title: "Redactor de Emails", workflow: 'email-writing', initialMessages: [{ role: 'assistant', content: 'Creemos un email que convierta. ¿Cuál es el objetivo principal de este correo?' }] },
                    'english-teacher-translate': { title: "English Translator", workflow: 'english-teacher-translate', initialMessages: [{ role: 'assistant', content: 'Of course! Please provide the text you want me to translate or correct.' }] },
                    'english-teacher-vocabulary': { title: "Vocabulary Builder", workflow: 'english-teacher-vocabulary', initialMessages: [{ role: 'assistant', content: 'Excellent! Let\'s learn some new vocabulary. What topic are you interested in? (e.g., "business negotiations", "travel")' }] },
                    'english-teacher-practice': { title: "Conversation Practice", workflow: 'english-teacher-practice', initialMessages: [{ role: 'assistant', content: 'Great! Let\'s practice our conversation. So, tell me about your day.' }] },
                    'design-web': { title: "Diseñador Web", workflow: 'design-web', model: 'gpt-4o-mini', initialMessages: [{ role: 'assistant', content: 'Estoy listo para diseñar con código. Describe la página o componente que quieres crear, y lo programaré para ti.' }] },
                };

                document.querySelectorAll('[data-workflow]').forEach(button => {
                    button.addEventListener('click', () => {
                        const workflowKey = button.dataset.workflow;
                        const config = workflowConfigs[workflowKey];
                        if (config) {
                            createNewChat({
                                title: config.title,
                                workflow: config.workflow,
                                model: config.model,
                                initialMessages: config.initialMessages
                            });
                        }
                    });
                });
                
                dom.workflowsContainer.addEventListener('click', e => { const header = e.target.closest('.workflow-header'); if (header) { const category = header.closest('.workflow-category'); if (category) category.classList.toggle('open'); } });
                dom.webLaunchOfferBtn.addEventListener('click', () => { const offerTitle = `<i class="fas fa-gift mr-2"></i>Tu Oferta de Lanzamiento Exclusiva`; const offerMessage = `<p class="font-bold mb-2">Al suscribirte a nuestro Plan Pro por $17/mes, desbloqueas:</p><ul class="list-disc list-inside space-y-2 text-left"><li><strong>Acceso Ilimitado a Goatify AI:</strong> Todos los modelos y workflows sin restricciones.</li><li><strong>Construcción de tu Página Web Profesional:</strong> Nosotros construiremos la primera versión, ¡gratis!</li></ul><p class="font-bold mt-4 mb-2">¿Cómo funciona?</p><ol class="list-decimal list-inside space-y-1 text-left"><li><strong>Agenda tu Sesión Estratégica:</strong> Al confirmar, agenda tu llamada de 20 min.</li><li><strong>Co-creación:</strong> En la llamada definiremos objetivos y crearemos el borrador con IA.</li><li><strong>Entrega:</strong> Nuestro equipo lo pulirá y te entregará una web de una sección, lista.</li></ol><p class="text-xs mt-4 italic"><strong>Importante:</strong> La web es tuya para siempre. Para mantenerla online con nuestro hosting, necesitas tu suscripción Pro activa. Si cancelas, te entregamos el código completo.</p>`; showModal({ title: offerTitle, message: offerMessage, confirmText: 'Agendar Sesión Estratégica' }).then(confirmed => { if (confirmed) { window.open('https://calendly.com/goatify', '_blank'); } }); });
                dom.freeGuidesLink.addEventListener('click', (e) => { e.preventDefault(); const isPaidUser = currentUser && currentUser.app_metadata?.plan && currentUser.app_metadata.plan !== 'free'; if (isPaidUser) { window.open('https://goatify.app/guiasIA', '_blank'); } else { const title = 'Acceso Exclusivo para Suscriptores'; const message = 'Estas guías se actualizan semanalmente con estrategias de negocio que te ayudarán a crecer un montón. Son un beneficio exclusivo para nuestros suscriptores. ¡Únete a un plan para desbloquearlas!'; showModal({ title, message, confirmText: 'Ver Planes' }).then(confirmed => { if (confirmed) { showPricingModal(); } }); } });
                dom.closeHtmlPreviewModalBtn?.addEventListener('click', () => { dom.htmlPreviewModal.classList.add('hidden'); dom.htmlPreviewModal.classList.remove('flex'); });
                dom.voiceSelector?.addEventListener('change', (e) => { selectedVoice = availableVoices.find(voice => voice.name === e.target.value); });
                dom.servicesMenuBtn?.addEventListener('click', (e) => { e.stopPropagation(); const menu = dom.servicesMenu; const isHidden = menu.classList.contains('opacity-0'); if (isHidden) { menu.classList.remove('opacity-0', 'scale-95', '-translate-y-2', 'pointer-events-none'); } else { menu.classList.add('opacity-0', 'scale-95', '-translate-y-2', 'pointer-events-none'); } });
                document.addEventListener('click', (e) => { if (dom.userMenuBtn && dom.userMenuPopup && !dom.userMenuBtn.contains(e.target) && !dom.userMenuPopup.contains(e.target)) { dom.userMenuPopup.classList.add('hidden'); } if (dom.servicesMenu && !dom.servicesMenu.classList.contains('opacity-0') && !dom.servicesMenuBtn.contains(e.target) && !dom.servicesMenu.contains(e.target)) { dom.servicesMenu.classList.add('opacity-0', 'scale-95', '-translate-y-2', 'pointer-events-none'); } if (dom.sidebar && window.innerWidth < 768 && !dom.sidebar.contains(e.target) && dom.sidebar.classList.contains('is-open')) { toggleSidebar(false); } });
                const setAppHeight = () => { const app = document.getElementById('app-container'); if(app) app.style.height = `${window.innerHeight}px`; };
                setAppHeight();
                window.addEventListener('resize', setAppHeight);
                dom.selectChatsBtn?.addEventListener('click', () => toggleSelectMode(true));
                dom.cancelSelectModeBtn?.addEventListener('click', () => toggleSelectMode(false));
                dom.deleteSelectedBtn?.addEventListener('click', async () => { if (chatsToDelete.size === 0) return; const confirm = await showModal({ title: `Eliminar ${chatsToDelete.size} chat(s)`, message: 'Esta acción es irreversible. ¿Confirmas la eliminación?', confirmText: 'Eliminar' }); if (confirm) { chatsToDelete.forEach(id => { state.structure = state.structure.filter(i => i !== id); delete state.chats[id]; Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(cid => cid !== id) }); if (currentChatId === id) resetChatView(); }); saveState(); toggleSelectMode(false); } hideModal(); });

                // Event listeners for new settings modal
                dom.settingsBtn?.addEventListener('click', showSettingsModal);
                dom.closeSettingsModal?.addEventListener('click', hideSettingsModal);
                dom.settingsUpgradePlanBtn?.addEventListener('click', () => { hideSettingsModal(); showPricingModal(); });
                dom.fontSizeSlider?.addEventListener('input', (e) => {
                    const fontSize = e.target.value;
                    document.documentElement.style.setProperty('--base-font-size', `${fontSize}px`); // Use document.documentElement for global css variable
                    dom.fontSizeValue.textContent = `${fontSize}px`;
                });
                dom.settingsThemeToggle?.addEventListener('click', () => {
                    setTheme(!document.body.classList.contains('dark-theme'));
                });
                dom.languageSelector?.addEventListener('change', (e) => {
                    // This is a placeholder. Full translation would require a more robust i18n solution.
                    alert(`Idioma cambiado a: ${e.target.value}. (Funcionalidad completa de traducción en desarrollo)`);
                    // In a real app, you would load translations here
                });
                dom.connectWhatsappBtn?.addEventListener('click', () => {
                    window.open('https://wa.me/17439106116?text=Hola%2C%20me%20gustar%C3%ADa%20conectar%20mi%20cuenta%20de%20Goatify%20AI%20a%20WhatsApp.', '_blank');
                });

                // Calendar event listeners
                dom.calendarBtn?.addEventListener('click', showCalendarModal);
                dom.closeCalendarModal?.addEventListener('click', hideCalendarModal);
                dom.prevMonthBtn?.addEventListener('click', () => {
                    currentMonth = currentMonth.subtract(1, 'month');
                    renderCalendar();
                });
                dom.nextMonthBtn?.addEventListener('click', () => {
                    currentMonth = currentMonth.add(1, 'month');
                    renderCalendar();
                });
                dom.addTaskBtn?.addEventListener('click', addTask);
                dom.newTaskInput?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addTask();
                    }
                });

                // Free plan button directly opens pricing modal
                dom.freePlanButton?.addEventListener('click', showPricingModal);

            }
            
            function initApp() {
                setTheme(localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches));
                const unlockAudio = () => {
                    const silence = new SpeechSynthesisUtterance('');
                    silence.volume = 0;
                    window.speechSynthesis.speak(silence);
                    document.body.removeEventListener('touchstart', unlockAudio);
                    document.body.removeEventListener('click', unlockAudio);
                };
                document.body.addEventListener('touchstart', unlockAudio, { once: true });
                document.body.addEventListener('click', unlockAudio, { once: true });
                let initFired = false;
                const finishInitialization = (user) => {
                    if (initFired) return;
                    initFired = true;
                    currentUser = user;
                    updateUserUI();
                    loadStateForUser();
                    updateModelSelectorState();
                    updateContextualFooter(null);
                    dom.appContainer.classList.remove('opacity-0');
                    dom.loadingOverlay.style.display = 'none';
                };
                netlifyIdentity.on('init', (user) => finishInitialization(user));
                setTimeout(() => { if (!initFired) { finishInitialization(netlifyIdentity.currentUser()); } }, 1500);
                netlifyIdentity.on('login', (user) => {
                    netlifyIdentity.close(); 
                    currentUser = user;
                    updateUserUI(); 
                    loadStateForUser();
                });
                netlifyIdentity.on('logout', () => { 
                    currentUser = null; 
                    updateUserUI(); 
                    loadStateForUser(); 
                    resetChatView();
                });
                populateVoiceList();
                setupEventListeners();
                // Ensure the chat title has the edit icon on initial load if a chat is selected
                if (currentChatId && state.chats[currentChatId]) {
                    if (!dom.chatTitle.querySelector('.chat-title-edit-icon')) {
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-pencil-alt chat-title-edit-icon';
                        icon.id = 'chat-title-edit-icon-desktop';
                        dom.chatTitle.appendChild(icon);
                    }
                     if (dom.mobileChatTitle && !dom.mobileChatTitle.querySelector('.chat-title-edit-icon')) {
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-pencil-alt chat-title-edit-icon';
                        icon.id = 'chat-title-edit-icon-mobile';
                        dom.mobileChatTitle.appendChild(icon);
                    }
                }
            }
            initApp();
        });
    </script>
</body>
</html>
