<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Goatify AI</title>
    <link rel="icon" type="image/png" href="./Logos HD.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #121212;
            --bg-medium: #1e1e1e;
            --bg-light: #2c2c2c;
            --primary: #8a4fff;
            --primary-hover: #7b46e6;
            --text-light: #e0e0e0;
            --text-medium: #b3b3b3;
            --border-color: #3a3a3a;

            --light-bg-dark: #f7f7f8;
            --light-bg-medium: #ffffff;
            --light-bg-light: #f0f0f0;
            --light-primary: #7c40e6;
            --light-primary-hover: #6a37d3;
            --light-text-dark: #1f2937;
            --light-text-medium: #6b7280;
            --light-border-color: #e5e7eb;

            --base-font-size: 16px;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: var(--base-font-size);
        }

        .dark-theme {
            --current-bg-dark: var(--bg-dark);
            --current-bg-medium: var(--bg-medium);
            --current-bg-light: var(--bg-light);
            --current-primary: var(--primary);
            --current-primary-hover: var(--primary-hover);
            --current-text-light: var(--text-light);
            --current-text-medium: var(--text-medium);
            --current-border-color: var(--border-color);
            background-color: var(--current-bg-dark);
            color: var(--text-light);
        }

        .light-theme {
            --current-bg-dark: var(--light-bg-dark);
            --current-bg-medium: var(--light-bg-medium);
            --current-bg-light: var(--light-bg-light);
            --current-primary: var(--light-primary);
            --current-primary-hover: var(--light-primary-hover);
            --current-text-light: var(--light-text-dark);
            --current-text-medium: var(--light-text-medium);
            --current-border-color: var(--light-border-color);
            background-color: var(--light-bg-dark);
            color: var(--light-text-dark);
        }
        
        /* Fixed user-section to not scroll */
        #sidebar { 
            background-color: var(--current-bg-dark); 
            border-right: 1px solid var(--current-border-color); 
            display: flex;
            flex-direction: column;
            height: 100%; /* Ensure sidebar takes full height */
        }
        /* Make content area above user section scrollable */
        #sidebar > div:nth-child(2) { /* This targets the flex-grow overflow-y-auto div */
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0; /* Necessary for overflow to work in flex container */
        }
        #user-section {
            flex-shrink: 0; /* Prevent shrinking */
            border-top: 1px solid var(--current-border-color);
            padding-top: 0.75rem;
            margin-top: auto; /* Push to the bottom */
            background-color: var(--current-bg-dark); /* Ensure it matches sidebar background */
            z-index: 10; /* Ensure it stays above scrolling content */
        }


        #main-chat-area, .modal-content { background-color: var(--current-bg-medium); }
        .chat-bubble-bot, .bg-input, #pdf-preview-container, .chat-item, .project-header, #user-menu-popup, #services-menu, .pro-controls-bg { background-color: var(--current-bg-light); }
        .border-themed { border-color: var(--current-border-color); }
        .chat-bubble-user { background-color: var(--current-primary); color: white; }
        .btn-primary { background-color: var(--current-primary); color: white; }
        .btn-primary:hover { background-color: var(--current-primary-hover); }
        .plan-card-highlight { border-color: var(--current-primary); box-shadow: 0 0 15px rgba(138, 79, 255, 0.3); }
        .placeholder-themed::placeholder { color: var(--current-text-medium); }
        .text-primary { color: var(--current-primary); }
        .glowing-mic { animation: pulse 1.5s infinite; color: var(--primary) !important; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(138, 79, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0); }
        }

        .project .project-content { display: none; }
        .project.open .project-content { display: block; }
        .project.open .project-arrow { transform: rotate(90deg); }
        .project-header.drag-over { background-color: var(--current-primary); }
        #sidebar.is-open { transform: translateX(0); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        #app-container { height: 100vh; height: -webkit-fill-available; }
        #pricing-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .chat-item.selected-for-delete { background-color: var(--primary) !important; color: white; }
        
        /* Model/Voice Selectors - Adjust width to fit content and ensure dropdown arrow */
        .model-selector-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .model-selector-wrapper select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%233a3a3a' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); /* Darker dropdown arrow for contrast */
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; /* Space for dropdown icon */
            background-image: linear-gradient(to right, rgba(138, 79, 255, 0.1), rgba(138, 79, 255, 0.05));
            height: 32px; /* Thinner */
            font-size: 0.875rem;
            line-height: 1.25rem;
            border: none;
            outline: none;
            cursor: pointer;
            min-width: 120px;
            color: var(--current-text-light);
        }

        /* Ensure .pro-controls-bg adjusts its width to content */
        .pro-controls-bg {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.375rem;
            border-radius: 0.5rem;
            overflow: hidden; 
            width: fit-content;
            max-width: 100%;
            gap: 0.5rem;
        }
        
        .pro-controls-bg > div:first-child {
            display: flex; 
            align-items: center;
            gap: 0.5rem;
        }


        .workflow-content { display: none; }
        .workflow-category.open .workflow-content { display: block; }
        .workflow-category.open .workflow-arrow { transform: rotate(90deg); }
        .plan-card { background-color: var(--current-bg-light); }
        #pdf-preview-container { padding: 0.5rem; }
        
        @keyframes sweep {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(200%) skewX(-15deg); }
        }
        .cool-light-effect { position: relative; overflow: hidden; }
        .cool-light-effect::before {
            content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(138, 79, 255, 0.25) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-150%) skewX(-15deg); transition: transform 0.8s ease; pointer-events: none;
        }
        .cool-light-effect:hover::before { animation: sweep 2s infinite linear; }

        .input-wrapper { border: 2px solid transparent; transition: box-shadow 0.3s ease, border-color 0.3s ease; }
        .input-wrapper:focus-within { box-shadow: 0 0 10px 0px rgba(138, 79, 255, 0.5); border-color: var(--current-primary-hover); }

        #chat-title {
            color: var(--primary);
            font-weight: 700;
            transition: color 0.3s ease;
        }
        #chat-title-wrapper:hover #chat-title {
            color: var(--primary-hover);
        }
        
        #chat-title-wrapper {
            position: relative;
            padding-left: 24px;
        }
        /* Make edit icon always visible for chat titles */
        #chat-title-wrapper .edit-icon,
        #mobile-chat-title-wrapper .edit-icon {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            opacity: 1; /* Always visible */
            transition: transform 0.2s ease;
        }
        #chat-title-wrapper:hover .edit-icon,
        #mobile-chat-title-wrapper:hover .edit-icon {
            transform: translateY(-50%) scale(1.1); /* Subtle scale on hover */
        }

        .btn-disabled { background-color: #3a3a3a !important; color: #888 !important; cursor: not-allowed !important; border-color: #3a3a3a !important;}

        /* Sidebar chat item text colors */
        .chat-item.selected-chat {
            background-color: var(--current-primary);
            color: white !important; /* Important to override theme color */
        }
        .chat-item.selected-chat .text-sm {
            color: white !important;
        }
        .light-theme .chat-item {
            color: var(--light-text-dark); /* Ensure high contrast in light mode */
        }

        /* Thinner model bar on mobile */
        @media (max-width: 640px) {
            .pro-controls-bg {
                padding: 0.125rem 0.25rem;
            }
            .pro-controls-bg label,
            .pro-controls-bg select {
                font-size: 0.75rem; /* 12px */
                padding-top: 0.125rem;
                padding-bottom: 0.125rem;
            }

            /* Solutions menu adjustment for mobile */
            #services-menu {
                max-height: 80vh; 
                overflow-y: auto; 
                top: auto; 
                bottom: 10px; 
                left: 10px; 
                right: 10px; 
                width: auto; 
                transform: none; 
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out, bottom 0.3s ease-in-out;
            }
            #services-menu.show { 
                 bottom: 10px; 
                 opacity: 1;
                 visibility: visible;
            }
        }

        /* Calendar styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day {
            padding: 8px;
            border-radius: 4px;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
        }
        .calendar-day:hover {
            background-color: var(--current-bg-light);
        }
        .calendar-day.current-month {
            color: var(--current-text-light);
        }
        .calendar-day.other-month {
            color: var(--current-text-medium);
            opacity: 0.5;
        }
        .calendar-day.selected {
            background-color: var(--current-primary);
            color: white;
        }
        .calendar-day.has-tasks {
            border: 1px solid var(--primary);
            box-shadow: 0 0 5px rgba(138, 79, 255, 0.3);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-item-completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .notification-bell-icon {
            position: relative;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7em;
            line-height: 1;
            min-width: 18px;
            text-align: center;
        }

        /* In-app notification box */
        #in-app-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #in-app-notification.show {
            opacity: 1;
            visibility: visible;
        }

        /* Calendar View Toggle */
        .calendar-view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .calendar-view-toggle button {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            font-weight: 600;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        .calendar-view-toggle button.active {
            background-color: var(--current-primary);
            color: white;
            box-shadow: 0 0 8px rgba(138, 79, 255, 0.4);
        }
        .calendar-view-toggle button:hover:not(.active) {
            background-color: var(--current-bg-medium);
        }

        /* Month View Specific Styles */
        #month-view-container {
            display: block; /* Default to block */
        }
        /* Week View Specific Styles */
        #week-view-container {
            display: none; /* Hidden by default */
            max-height: 400px; 
            overflow-y: auto;
            border: 1px solid var(--current-border-color);
            border-radius: 8px;
            padding: 10px;
        }
        .week-day-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--current-border-color);
        }
        .week-day-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .week-day-section h5 {
            font-weight: 700;
            color: var(--current-primary);
            margin-bottom: 5px;
        }
        .week-day-section .task-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 0;
        }
        .week-day-section .task-item.task-item-completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        /* Day View Modal/Container */
        #day-detail-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.7);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 900;
        }

        #day-detail-modal .modal-content {
            background-color: var(--current-bg-medium);
            border-radius: 0.5rem;
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            position: relative;
        }
        #day-detail-modal h4 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--current-text-light);
        }
        #day-detail-tasks-list {
            max-height: 200px;
            overflow-y: auto;
        }
        #day-detail-tasks-list .task-item {
            display: flex; /* Ensure task items are flex for checkbox alignment */
            align-items: center;
            gap: 0.5rem; /* Space between checkbox and text */
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--current-border-color);
        }
        #day-detail-tasks-list .task-item:last-child {
            border-bottom: none;
        }
        #day-detail-tasks-list .task-item.task-item-completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        /* New Project Management Dashboard styles */
        #project-dashboard-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .project-section {
            background-color: var(--current-bg-light);
            border-radius: 8px;
            padding: 15px;
        }

        .project-section h4 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            margin-bottom: 10px;
            color: var(--current-primary);
        }

        .task-card {
            background-color: var(--current-bg-medium);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border: 1px solid var(--current-border-color);
        }

        .task-card.completed {
            opacity: 0.7;
            text-decoration: line-through;
        }

        .task-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-card-header .task-title {
            font-weight: 500;
        }

        .task-card-details {
            font-size: 0.75rem; /* text-xs */
            color: var(--current-text-medium);
        }

        .task-card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 5px;
        }

        .task-card-actions button {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            transition: background-color 0.2s ease;
        }

        .task-card-actions button:hover {
            background-color: var(--current-primary-hover);
            color: white;
        }

        .add-task-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background-color: var(--current-bg-light);
            border-radius: 8px;
        }
        .add-task-form input[type="text"],
        .add-task-form input[type="date"],
        .add-task-form input[type="time"],
        .add-task-form select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--current-border-color);
            background-color: var(--current-bg-medium);
            color: var(--current-text-light);
        }
        .add-task-form button {
            padding: 10px;
            border-radius: 6px;
        }

    </style>
</head>
<body class="w-screen overflow-x-hidden dark-theme">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script type="text/javascript">
        // IMPORTANT: Direct initialization of Netlify Identity
        // This is crucial for fixing the "Inicializando" screen.
        console.log("Directly calling netlifyIdentity.init() early in <body>.");
        netlifyIdentity.init();
    </script>

    <div id="loading-overlay" class="fixed inset-0 bg-bg-dark bg-opacity-95 flex flex-col items-center justify-center z-[100] transition-opacity duration-300">
        <img src="./Logos HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mb-6 animate-pulse" onerror="this.onerror=null;this.src='https://placehold.co/96x96/121212/e0e0e0?text=LOGO';">
        <div class="text-text-light text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3 text-lg font-semibold" data-translate-key="initializing">Inicializando...</p>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden opacity-0 pointer-events-none"></div>

    <div id="app-container" class="flex w-full relative opacity-0 transition-opacity duration-300">
        <aside id="sidebar" class="w-72 flex-shrink-0 flex flex-col p-3 transition-transform duration-300 -translate-x-full md:translate-x-0 absolute md:relative z-30 h-full">
            <div id="logo-space" class="w-24 h-24 rounded-lg mx-auto mb-4 flex-shrink-0 flex items-center justify-center overflow-hidden bg-input">
                <img src="./Logos HD.png" alt="Goatify Logo" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
            </div>
            <div class="flex-grow overflow-y-auto min-height-0"> <div class="flex-shrink-0">
                    <div class="flex flex-col space-y-2 mb-4">
                        <button id="new-chat-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-plus mr-2"></i><span data-translate-key="new_chat">Nuevo Chat</span></button>
                        <button id="new-project-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg bg-input"><i class="fas fa-folder-plus mr-2"></i><span data-translate-key="new_project">Nuevo Proyecto</span></button>
                        <button id="web-launch-offer-btn" class="w-full text-left font-semibold text-sm p-3 rounded-lg btn-primary transition-colors animate-pulse" data-translate-key="web_offer">
                            üöÄ ¬°Lanza tu Negocio, te regalamos una pg web Gratis con tu suscripcion!
                        </button>
                        <div id="upgrade-plan-container" class="hidden text-center p-2 bg-yellow-400 rounded-lg">
                            <button id="upgrade-plan-btn" class="text-xs font-semibold text-black hover:text-gray-800">
                                <i class="fas fa-rocket mr-1"></i>
                                <span data-translate-key="upgrade_plan">Mejorar Plan</span>
                            </button>
                        </div>
                        <div class="text-center p-2 bg-input rounded-lg">
                            <a href="#" id="free-guides-link" class="text-xs font-semibold text-primary hover:underline">
                                <i class="fas fa-book-open mr-1"></i>
                                <span data-translate-key="free_guides">Gu√≠as de IA Gratis</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="flex-grow">
                    <div class="border-t border-b border-themed my-3 py-3">
                        <h3 class="text-xs font-semibold uppercase text-text-medium mb-2 px-2" data-translate-key="workflows">Workflows</h3>
                        <div id="workflows-container" class="space-y-1">
                            <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                    <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-share-alt w-6 mr-2 text-pink-400"></i>
                                    <span class="text-sm font-bold" data-translate-key="wf_social">Potenciador de Redes Sociales</span>
                                </div>
                                <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="create-full-post" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_1">Crear un Post Completo</button>
                                    <button data-workflow="persuasive-copy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_2">Redacci√≥n de Copys</button>
                                    <button data-workflow="post-ideas" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_3">Lluvia de Ideas para Posts</button>
                                    <button data-workflow="brand-strategy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_4">Definir Estrategia de Marca</button>
                                </div>
                            </div>
                            <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                    <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-chart-pie w-6 mr-2 text-blue-400"></i>
                                    <span class="text-sm font-bold" data-translate-key="wf_business">An√°lisis de Negocio</span>
                                </div>
                                <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="competitor-analysis" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_1">An√°lisis de tu Competencia</button>
                                    <button data-workflow="buyer-persona" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_2">Definir mi Cliente Ideal</button>
                                    <button data-workflow="brand-names" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_3">Lluvia de Nombres para Marca</button>
                                </div>
                            </div>
                            <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                    <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-headset w-6 mr-2 text-green-400"></i>
                                    <span class="text-sm font-bold" data-translate-key="wf_sales">Comunicaci√≥n y Ventas</span>
                                </div>
                                <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="sales-assistant" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_1">Asistente de Ventas 24/7</button>
                                    <button data-workflow="email-writing" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_2">Redacci√≥n de Email</button>
                                    <button data-workflow="design-web" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_3">Dise√±o Web</button>
                                </div>
                            </div>
                            <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                    <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-language w-6 mr-2 text-red-400"></i>
                                    <span class="text-sm font-bold">English Teacher</span>
                                </div>
                                <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="english-teacher-translate" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_1">Traducir/Corregir Texto</button>
                                    <button data-workflow="english-teacher-vocabulary" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_2">Aprender Vocabulario Nuevo</button>
                                    <button data-workflow="english-teacher-practice" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_3">Practicar Conversaci√≥n</button>
                                </div>
                            </div>
                            <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                    <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-project-diagram w-6 mr-2 text-purple-400"></i>
                                    <span class="text-sm font-bold" data-translate-key="wf_project_management">Direcci√≥n de Proyectos</span>
                                </div>
                                <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="project-management-dashboard" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_project_dashboard">Panel de Proyectos</button>
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-themed pt-2 mt-2">
                            <button id="select-chats-btn" class="w-full text-sm p-2 rounded hover:bg-light flex items-center justify-center">
                                <i class="fas fa-tasks mr-2"></i><span data-translate-key="select_chats">Seleccionar M√∫ltiples Chats</span>
                            </button>
                        </div>
                    </div>
                    <div id="delete-mode-controls" class="hidden flex space-x-2 mb-2 px-2">
                        <button id="delete-selected-btn" class="flex-1 flex items-center justify-center font-semibold p-2 rounded-lg bg-red-600 text-white disabled:opacity-50" disabled><i class="fas fa-trash-alt mr-2"></i><span data-translate-key="delete">Borrar</span></button>
                        <button id="cancel-select-mode-btn" class="p-2 rounded-lg bg-gray-600 text-white"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="sidebar-content" class="pr-1 space-y-1"></div>
                </div>
                <div id="user-section" class="flex-shrink-0 border-top border-themed pt-3"> <div id="login-view" class="hidden">
                        <button id="login-btn" class="w-full flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-sign-in-alt mr-2"></i><span data-translate-key="login">Iniciar Sesi√≥n</span></button>
                    </div>
                    <div id="user-menu-view" class="hidden relative">
                        <button id="user-menu-btn" class="w-full flex items-center text-left p-2 rounded-lg hover:bg-light transition-colors">
                            <span id="user-email" class="flex-grow truncate text-sm font-semibold"></span>
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <div id="user-menu-popup" class="absolute bottom-full left-0 w-full mb-2 rounded-lg p-2 border border-themed shadow-lg hidden">
                            <button id="settings-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-cog w-6 mr-2"></i><span data-translate-key="settings">Configuraci√≥n</span></button>
                            <button id="logout-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-sign-out-alt w-6 mr-2"></i><span data-translate-key="logout">Cerrar Sesi√≥n</span></button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <main id="main-chat-area" class="flex-1 flex flex-col h-full overflow-hidden">
            <header class="flex items-center justify-between p-3 md:p-4 border-b border-themed flex-shrink-0 relative">
                <button id="menu-toggle" class="md:hidden text-xl p-2"><i class="fas fa-bars"></i></button>
                <div id="chat-title-wrapper" class="hidden sm:flex items-center group cursor-pointer mx-2 flex-1 min-w-0" title="Renombrar Chat">
                    <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                    <h1 id="chat-title" class="text-lg font-semibold truncate">Goatify AI</h1>
                </div>
                <div class="flex items-center space-x-1 sm:space-x-2 flex-shrink-0 ml-auto">
                    <button id="new-chat-icon-btn" title="Nuevo Chat" class="text-xl p-2 hover:opacity-80 transition-opacity"><i class="fas fa-plus-circle text-primary"></i></button>
                    <button id="services-menu-btn" title="Potenciar mi Negocio" class="text-xl p-2 hover:opacity-80 transition-opacity flex items-center gap-2">
                        <i class="fas fa-rocket text-primary"></i>
                        <span class="text-sm font-semibold text-primary" data-translate-key="solutions">Soluciones</span>
                    </button>
                    <button id="calendar-btn" title="Mi Calendario y Tareas" class="text-sky-400 hover:text-sky-300 p-2 transition-colors notification-bell-icon">
                        <i class="fas fa-calendar-days text-xl"></i>
                        <span id="notification-badge" class="notification-badge hidden">0</span>
                    </button>
                    <a href="https://wa.me/17439106116?text=Hola%2C%20estoy%2Fa%20en%20contratar%20uno%20de%20sus%20paquetes%20de%20soluciones%20con%20IA%20para%20mi%20negocio.%20%C2%BFPodr%C3%ADan%20darme%20m%C3%A1s%20informaci%C3%B3n%3F" target="_blank" title="Hablar con un Estratega" class="text-green-500 hover:text-green-400 p-2 transition-colors"><i class="fab fa-whatsapp text-xl"></i></a>
                    <div id="message-counter" class="text-xs font-mono whitespace-nowrap"></div>
                    <button id="theme-toggle" title="Cambiar Tema" class="text-xl p-2"><i class="fas fa-moon" id="theme-icon"></i></button>
                </div>
                <div id="services-menu" class="absolute top-full right-4 mt-2 w-80 rounded-xl shadow-lg border border-themed z-30 p-4 transition-all duration-300 ease-in-out opacity-0 scale-95 -translate-y-2 pointer-events-none origin-top-right">
                    <h4 class="font-bold text-lg mb-1 text-text-light" data-translate-key="ally_title">Somos tu Aliado Estrat√©gico</h4>
                    <p class="text-sm text-text-medium mb-4" data-translate-key="ally_desc">Goatify no es solo un chat. Somos una IA personalizada con un equipo de expertos listos para ayudarte a escalar tu negocio.</p>
                    <ul class="space-y-3">
                        <li><a href="https://www.goatify.app/diseno-web" target="_blank" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">P√°ginas Web que Convierten</p><p class="text-sm text-text-medium">Transformamos tus ideas en webs y tiendas online dise√±adas para vender.</p></a></li>
                        <li><a href="https://www.goatify.app/automatizacion" target="_blank" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Ventas en Piloto Autom√°tico</p><p class="text-sm text-text-medium">Implementamos sistemas de IA para automatizar tus ventas y procesos clave.</p></a></li>
                        <li><a href="https://www.goatify.app/redes-sociales" target="_blank" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Avatares para Redes Sociales</p><p class="text-sm text-text-medium">Creamos avatares hiperrealistas con IA y estrategias de contenido que captan la atenci√≥n.</p></a></li>
                        <li><a href="https://www.goatify.app/consultoria" target="_blank" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Escala tu Empresa con IA</p><p class="text-sm text-text-medium">Obt√©n consultor√≠a experta para integrar la IA en el ADN de tu negocio.</p></a></li>
                    </ul>
                </div>
            </header>
            <div class="block sm:hidden text-center py-1.5 border-b border-themed bg-current-bg-dark shadow-sm flex-shrink-0">
                <div id="mobile-chat-title-wrapper" class="flex items-center justify-center group cursor-pointer px-4" title="Renombrar Chat">
                    <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                    <h2 id="mobile-chat-title" class="text-sm font-semibold truncate">Goatify AI</h2>
                </div>
            </div>

            <div id="chat-messages" class="flex-1 overflow-y-auto p-3 sm:p-6">
                <div class="flex justify-center items-center h-full" id="initial-message-container">
                    <div id="welcome-message-wrapper" class="text-center text-text-medium">
                        <img src="./Logos HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                        <h2 class="text-3xl font-bold text-text-light">Goatify AI</h2>
                        <div id="personalized-welcome" class="hidden"><p class="text-lg mt-1"><span data-translate-key="welcome_user">¬°Hola, </span><span id="user-name"></span><span data-translate-key="welcome_user_2">! Hoy es un gran d√≠a para crear algo incre√≠ble.</span></p></div>
                        <div id="generic-welcome" class="hidden"><p class="text-xl" data-translate-key="welcome_guest">¬øC√≥mo puedo ayudarte hoy?</p></div>
                    </div>
                </div>
            </div>
            <div id="input-area" class="p-2 sm:p-4 border-t border-themed flex-shrink-0">
                <div id="file-preview-area" class="mb-2 space-y-2 px-1 sm:px-0">
                    <div id="image-preview-container" class="hidden relative">
                        <img id="image-preview" src="#" alt="Image Preview">
                        <span id="image-name" class="text-xs text-text-medium truncate flex-grow"></span>
                        <button id="clear-image-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                    <div id="pdf-preview-container" class="hidden relative">
                        <i class="fas fa-file-pdf text-red-500 text-xl"></i>
                        <div class="flex-grow min-w-0">
                            <p id="pdf-name" class="font-medium truncate"></p>
                            <p id="pdf-status" class="text-xxs font-mono"></p>
                        </div>
                        <button id="clear-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                </div>
                <div class="pro-controls-bg rounded-lg p-1.5 mb-2 cool-light-effect">
                    <div class="flex items-center space-x-2">
                        <div class="flex items-center space-x-2">
                            <label for="model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1" data-translate-key="model">Modelo:</label>
                            <div class="model-selector-wrapper">
                                <select id="model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                    <option value="gpt-3.5-turbo-1106" data-translate-key="model_general">Chat General (Turbo)</option>
                                    <option value="sonar" data-translate-key="model_web">B√∫squeda Web</option>
                                </select>
                            </div>
                        </div>
                        <div id="voice-selector-container" class="hidden items-center space-x-2">
                            <label for="voice-selector" class="font-medium text-xs text-text-medium" data-translate-key="voice">Voz:</label>
                             <div class="model-selector-wrapper">
                                <select id="voice-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light w-24"></select>
                            </div>
                        </div>
                        <div class="flex sm:hidden items-center space-x-1">
                            <button id="image-gen-btn-mobile" title="Crear Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fas fa-paint-brush text-lg"></i></button>
                            <button id="pdf-upload-btn-mobile" title="Subir PDF" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-file-pdf text-lg"></i></button>
                            <button id="image-upload-btn-mobile" title="Subir Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-image text-lg"></i></button>
                        </div>
                    </div>
                </div>
                <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                    <input type="file" id="pdf-upload" accept=".pdf,application/pdf" class="hidden"><input type="file" id="image-upload" accept="image/*" class="hidden">
                    <button id="image-gen-btn" title="Crear Imagen" class="hidden sm:block p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fas fa-paint-brush text-xl"></i></button>
                    <button id="pdf-upload-btn" title="Subir PDF" class="hidden sm:block p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-file-pdf text-xl"></i></button>
                    <button id="image-upload-btn" title="Subir Imagen" class="hidden sm:block p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-image text-xl"></i></button>
                    <button id="mic-btn" title="Activar Micr√≥fono" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-microphone text-xl"></i></button>
                    <button id="tts-toggle" title="Activar/Desactivar Voz" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-volume-mute text-xl"></i></button>
                    <textarea id="msg" placeholder="Escribe tu mensaje..." class="flex-1 bg-transparent p-2 h-12 max-h-32 resize-none outline-none placeholder-themed" rows="1" data-translate-key="placeholder_main"></textarea>
                    <button id="send" title="Enviar" class="p-2 sm:p-4 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i id="send-icon" class="fa fa-paper-plane text-xl"></i></button>
                </div>
                <div id="contextual-footer" class="text-center text-xs text-text-medium mt-2 px-2 h-4"></div>
            </div>
        </main>
    </div>

    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4"><div class="modal-content rounded-lg w-full max-w-md p-6 relative"><h3 id="modal-title" class="text-lg font-bold mb-4"></h3><div id="modal-message" class="mb-4 text-text-medium text-sm"></div><textarea id="modal-textarea" class="w-full p-2 rounded mb-4 hidden bg-input border border-themed h-28" placeholder=""></textarea><input type="text" id="modal-input" class="w-full p-2 rounded mb-4 hidden bg-input border border-themed" placeholder=""><div id="modal-buttons-container" class="flex justify-end space-x-2"><button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded" data-translate-key="cancel">Cancelar</button><button id="modal-confirm" class="px-4 py-2 rounded text-white btn-primary" data-translate-key="confirm">Confirmar</button></div></div></div>
    <div id="pricing-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4"><div class="modal-content rounded-2xl w-full max-w-5xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300"><div class="flex-shrink-0 flex items-center justify-between mb-6"><h2 class="text-3xl md:text-4xl font-extrabold text-center flex-grow" data-translate-key="plans_title">Planes Goatify</h2><button id="close-pricing-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button></div><div class="modal-content-body flex-grow overflow-y-auto px-2"><div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-text-light"><div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col"><h3 class="text-2xl font-bold">Free</h3><p class="text-5xl font-extrabold my-3">$0</p><p class="text-sm text-text-medium mb-4" data-translate-key="plan_free_sub">Para Siempre</p><button id="free-plan-button" class="w-full p-3 rounded-lg font-semibold border-2 border-primary text-primary hover:bg-primary hover:text-white transition-colors" data-translate-key="plan_free_cta">Empezar Gratis</button><ul class="space-y-3 text-sm flex-grow mt-6 mb-4"><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span data-translate-key="plan_feat_ltd_chat">Acceso limitado al chat</span></li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span data-translate-key="plan_feat_ltd_hist">Historial limitado</span></li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span data-translate-key="plan_feat_ltd_proj">Organizaci√≥n por proyectos (Limitado)</span></li></ul><div class="text-center text-text-medium text-xs mt-auto cursor-pointer hover:text-text-light" onclick="this.nextElementSibling.classList.toggle('hidden')">‚ñº Ver detalles de uso</div><div class="hidden mt-2 border-t border-themed pt-2 space-y-1 text-xs text-left"><p>Mensajes de texto: <span class="font-bold float-right">100 / mes</span></p><p>B√∫squedas web: <span class="font-bold float-right">10 / mes</span></p><p>Archivos / Im√°genes: <span class="font-bold float-right">-</span></p></div></div><div class="plan-card border-2 rounded-xl p-6 flex flex-col bg-current-bg-dark plan-card-highlight"><h3 class="text-2xl font-bold">GOAT <span class="text-primary">BOOST</span></h3><p class="text-5xl font-extrabold my-3">$7</p><p class="text-sm text-text-medium mb-4">/ mes</p><button data-plan="boost" class="select-plan-btn w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_boost_cta">Obtener Boost</button><ul class="space-y-3 text-sm flex-grow mt-6 mb-4"><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i><span data-translate-key="plan_feat_fast">Respuestas ultrarr√°pidas ‚ö°Ô∏è</span></li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i><span data-translate-key="plan_feat_unl_hist">Historial ilimitado</span></li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i><span data-translate-key="plan_feat_proj">Organizaci√≥n por Proyectos</span></li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i>English Teacher</li><li class="flex items-center"><i class="fas fa-check-circle text-primary mr-2"></i><span data-translate-key="plan_feat_ltd_wf">Workflows Limitados</span></li></ul><div class="text-center text-text-medium text-xs mt-auto cursor-pointer hover:text-text-light" onclick="this.nextElementSibling.classList.toggle('hidden')">‚ñº Ver detalles de uso</div><div class="hidden mt-2 border-t border-themed pt-2 space-y-1 text-xs text-left"><p>Mensajes de texto: <span class="font-bold float-right">500 / mes</span></p><p>B√∫squedas web: <span class="font-bold float-right">70 / mes</span></p><p>Archivos / Im√°genes: <span class="font-bold float-right">10 / mes</span></p></div></div><div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col"><h3 class="text-2xl font-bold">GOAT <span class="text-primary">PRO</span></h3><p class="text-5xl font-extrabold my-3">$17</p><p class="text-sm text-text-medium mb-4">/ mes</p><button data-plan="pro" class="select-plan-btn w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_pro_cta">Quiero mi Plan Pro + Web</button><ul class="space-y-3 text-sm flex-grow mt-6 mb-4"><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span class="font-bold" data-translate-key="plan_feat_all_boost">Todo lo de Boost</span> y m√°s</li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span data-translate-key="plan_feat_all_models">Acceso a todos los modelos de IA</span></li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span data-translate-key="plan_feat_all_wf">Acceso a todos los Workflows</span></li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span data-translate-key="plan_feat_community">Comunidad privada y webinars</span></li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span data-translate-key="plan_feat_support">Asistencia prioritaria 1-a-1</span></li><li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i><span class="font-bold" data-translate-key="plan_feat_free_web">P√°gina Web Gratis</span> para Fundadores</li></ul><div class="text-center text-text-medium text-xs mt-auto cursor-pointer hover:text-text-light" onclick="this.nextElementSibling.classList.toggle('hidden')">‚ñº Ver detalles de uso</div><div class="hidden mt-2 border-t border-themed pt-2 space-y-1 text-xs text-left"><p>Mensajes de texto: <span class="font-bold float-right">1,200 / mes</span></p><p>B√∫squedas web: <span class="font-bold float-right">150 / mes</span></p><p>Archivos / Im√°genes: <span class="font-bold float-right">30 / mes</span></p></div></div></div></div></div>
    <div id="html-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4"><div class="modal-content rounded-2xl w-full h-full max-w-4xl p-2 md:p-4 relative flex flex-col"><h3 class="text-lg font-bold" data-translate-key="preview">Vista Previa</h3><button id="close-html-preview-modal" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button></div><iframe id="html-preview-iframe" class="w-full flex-grow h-full border-2 border-themed rounded-lg bg-white"></iframe></div>
    
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative">
            <h3 class="text-lg font-bold mb-4" data-translate-key="settings">Configuraci√≥n</h3>
            <div class="space-y-4 text-sm">
                <div>
                    <p class="font-semibold" data-translate-key="settings_email">Correo Electr√≥nico:</p>
                    <p id="settings-user-email" class="text-text-medium"></p>
                </div>
                <div>
                    <p class="font-semibold" data-translate-key="settings_plan">Plan de Suscripci√≥n:</p>
                    <p id="settings-user-plan" class="text-text-medium"></p>
                    <button id="settings-upgrade-plan-btn" class="text-primary hover:underline mt-1 text-xs" data-translate-key="upgrade_plan">Mejorar Plan</button>
                </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_fontsize">Tama√±o de Letra:</p>
                    <input type="range" id="font-size-slider" min="14" max="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg dark:bg-gray-700">
                    <span id="font-size-value" class="text-xs text-text-medium">16px</span>
                </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_theme">Personalizaci√≥n:</p>
                    <button id="settings-theme-toggle" class="flex items-center p-2 rounded hover:bg-medium w-full text-left">
                        <i class="fas fa-moon mr-2" id="settings-theme-icon"></i>
                        <span data-translate-key="settings_dark_mode">Modo Oscuro</span>
                    </button>
                </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_lang">Idioma:</p>
                    <select id="language-selector" class="w-full p-2 rounded bg-input border border-themed">
                        <option value="es">Espa√±ol</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div>
                    <button id="connect-whatsapp-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center mb-2">
                        <i class="fab fa-whatsapp mr-2"></i><span data-translate-key="settings_whatsapp">Conectarse a WhatsApp</span>
                    </button>
                    <a href="https://calendly.com/goatify" target="_blank" id="schedule-meeting-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar-alt mr-2"></i><span data-translate-key="settings_schedule_meeting">Agendar Reuni√≥n</span>
                    </a>
                </div>
                 <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_notifications">Notificaciones:</p>
                    <button id="notification-toggle-btn" class="w-full p-2 rounded-lg bg-input flex items-center justify-center">
                        <i class="fas fa-bell mr-2"></i> <span id="notification-toggle-text">Habilitar Notificaciones</span>
                    </button>
                </div>
            </div>
            <button id="close-settings-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>

    <div id="calendar-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-2xl p-6 relative">
            <h3 class="text-lg font-bold mb-4" data-translate-key="calendar_my_calendar">Mi Calendario y Tareas</h3>
            <div class="calendar-view-toggle">
                <button id="month-view-btn" class="active" data-translate-key="calendar_day_view">Vista de Mes</button> <button id="week-view-btn" data-translate-key="calendar_week_view">Vista de Semana</button>
            </div>
            
            <div id="month-view-container">
                <div class="calendar-header">
                    <button id="prev-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-month-year" class="text-xl font-semibold"></h4>
                    <button id="next-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid mb-4">
                    <div class="font-bold text-primary" data-translate-key="calendar_mon">Lun</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_tue">Mar</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_wed">Mi√©</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_thu">Jue</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_fri">Vie</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_sat">S√°b</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_sun">Dom</div>
                </div>
                <div id="calendar-days-grid" class="calendar-grid">
                    </div>
            </div>

            <div id="week-view-container">
                <div class="calendar-header">
                    <button id="prev-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-week-range" class="text-xl font-semibold"></h4>
                    <button id="next-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="week-days-content"></div>
            </div>

            <div class="mt-6">
                <h4 class="font-semibold mb-2" data-translate-key="calendar_tasks_for">Tareas para <span id="selected-date-display"></span>:</h4>
                <div id="tasks-list" class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                    <p class="text-text-medium italic" id="no-tasks-message" data-translate-key="calendar_no_tasks">No hay tareas para este d√≠a.</p>
                </div>
                <div class="flex space-x-2 mb-2">
                    <input type="text" id="new-task-input" class="flex-grow p-2 rounded bg-input border border-themed" placeholder="A√±adir nueva tarea..." data-translate-key="calendar_add_task_placeholder">
                    <input type="time" id="new-task-time" class="p-2 rounded bg-input border border-themed">
                </div>
                <button id="add-task-btn" class="w-full btn-primary p-2 rounded-lg" data-translate-key="calendar_add_task_btn">A√±adir Tarea</button>
            </div>

            <button id="close-calendar-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>

    <div id="day-detail-modal" class="hidden">
        <div class="modal-content">
            <h4 id="day-detail-date"></h4>
            <div id="day-detail-tasks-list" class="space-y-2">
                </div>
            <button id="close-day-detail-modal" class="absolute top-2 right-2 text-gray-400 hover:text-text-light"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <div id="project-dashboard-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-4xl p-6 relative flex flex-col h-full max-h-[90vh]">
            <h3 class="text-lg font-bold mb-4" data-translate-key="wf_project_management">Direcci√≥n de Proyectos</h3>
            
            <div id="project-dashboard-content" class="flex-grow">
                <div class="add-task-form">
                    <input type="text" id="project-task-name" placeholder="Nombre de la Tarea" data-translate-key="project_task_name_placeholder" required>
                    <input type="date" id="project-task-date" title="Fecha de Vencimiento" required>
                    <input type="time" id="project-task-time" title="Hora de Vencimiento">
                    <select id="project-task-status">
                        <option value="todo" data-translate-key="project_status_todo">Por Hacer</option>
                        <option value="in-progress" data-translate-key="project_status_in_progress">En Progreso</option>
                        <option value="done" data-translate-key="project_status_done">Completada</option>
                    </select>
                    <input type="text" id="project-task-project-name" placeholder="Nombre del Proyecto (opcional)" data-translate-key="project_task_project_name_placeholder">
                    <button id="add-project-task-btn" class="btn-primary">A√±adir Tarea de Proyecto</button>
                </div>

                <div class="project-section">
                    <h4 data-translate-key="project_status_todo">Por Hacer</h4>
                    <div id="tasks-todo-list"></div>
                </div>

                <div class="project-section">
                    <h4 data-translate-key="project_status_in_progress">En Progreso</h4>
                    <div id="tasks-in-progress-list"></div>
                </div>

                <div class="project-section">
                    <h4 data-translate-key="project_status_done">Completadas</h4>
                    <div id="tasks-done-list"></div>
                </div>
            </div>

            <button id="close-project-dashboard-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>


    <div id="in-app-notification" class="hidden">
        <i class="fas fa-bell"></i>
        <span id="notification-message"></span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        window.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired.");
            
            const translations = {
                es: {
                    initializing: "Inicializando...", new_chat: "Nuevo Chat", new_project: "Nuevo Proyecto",
                    web_offer: "üöÄ ¬°Lanza tu Negocio, te regalamos una pg web Gratis con tu suscripcion!",
                    upgrade_plan: "Mejorar Plan", free_guides: "Gu√≠as de IA Gratis", workflows: "Workflows",
                    wf_social: "Potenciador de Redes Sociales", wf_social_1: "Crear un Post Completo", wf_social_2: "Redacci√≥n de Copys",
                    wf_social_3: "Lluvia de Ideas para Posts", wf_social_4: "Definir Estrategia de Marca",
                    wf_business: "An√°lisis de Negocio", wf_business_1: "An√°lisis de tu Competencia", wf_business_2: "Definir mi Cliente Ideal",
                    wf_business_3: "Lluvia de Nombres para Marca", wf_sales: "Comunicaci√≥n y Ventas", wf_sales_1: "Asistente de Ventas 24/7",
                    wf_sales_2: "Redacci√≥n de Email", wf_sales_3: "Dise√±o Web", wf_eng_1: "Traducir/Corregir Texto",
                    wf_eng_2: "Aprender Vocabulario Nuevo", wf_eng_3: "Practicar Conversaci√≥n", select_chats: "Seleccionar M√∫ltiples Chats",
                    delete: "Borrar", login: "Iniciar Sesi√≥n", settings: "Configuraci√≥n", logout: "Cerrar Sesi√≥n",
                    solutions: "Soluciones", ally_title: "Somos tu Aliado Estrat√©gico",
                    ally_desc: "Goatify no es solo un chat. Somos una IA personalizada con un equipo de expertos listos para ayudarte a escalar tu negocio.",
                    welcome_user: "¬°Hola, ", welcome_user_2: "! Hoy es un gran d√≠a para crear algo incre√≠ble.",
                    welcome_guest: "¬øC√≥mo puedo ayudarte hoy?", model: "Modelo:", model_general: "Chat General (Turbo)",
                    model_web: "B√∫squeda Web", voice: "Voz:", placeholder_main: "Escribe tu mensaje...", cancel: "Cancelar",
                    confirm: "Confirmar", plans_title: "Planes Goatify", plan_free_sub: "Para Siempre", plan_free_cta: "Empezar Gratis",
                    plan_feat_ltd_chat: "Acceso limitado al chat", plan_feat_ltd_hist: "Historial limitado", plan_feat_ltd_proj: "Organizaci√≥n por proyectos (Limitado)",
                    plan_boost_cta: "Obtener Boost", plan_feat_fast: "Respuestas ultrarr√°pidas ‚ö°Ô∏è", plan_feat_unl_hist: "Historial ilimitado",
                    plan_feat_proj: "Organizaci√≥n por Proyectos", plan_feat_ltd_wf: "Workflows Limitados", plan_pro_cta: "Quiero mi Plan Pro + Web",
                    plan_feat_all_boost: "Todo lo de Boost y m√°s", plan_feat_all_models: "Acceso a todos los modelos de IA",
                    plan_feat_all_wf: "Acceso a todos los Workflows", plan_feat_community: "Comunidad privada y webinars", plan_feat_support: "Asistencia prioritaria 1-a-1",
                    plan_feat_free_web: "P√°gina Web Gratis", preview: "Vista Previa", settings_email: "Correo Electr√≥nico:", settings_plan: "Plan de Suscripci√≥n:",
                    settings_fontsize: "Tama√±o de Letra:", settings_theme: "Personalizaci√≥n:", settings_dark_mode: "Modo Oscuro",
                    settings_lang: "Idioma:", settings_whatsapp: "Conectarse a WhatsApp", current_plan: "Tu Plan Actual",
                    calendar_today: "Hoy", calendar_this_week: "Esta Semana", calendar_mon: "Lun", calendar_tue: "Mar", calendar_wed: "Mi√©",
                    calendar_thu: "Jue", calendar_fri: "Vie", calendar_sat: "S√°b", calendar_sun: "Dom",
                    calendar_no_tasks: "No hay tareas para este d√≠a.", calendar_add_task_placeholder: "A√±adir nueva tarea...",
                    calendar_add_task_btn: "A√±adir Tarea", calendar_my_calendar: "Mi Calendario y Tareas",
                    calendar_day_view: "Vista de Mes", calendar_week_view: "Vista de Semana", /* Renamed to Month View */
                    notification_task_due: "Es hora de: ",
                    settings_schedule_meeting: "Agendar Reuni√≥n",
                    wf_project_management: "Direcci√≥n de Proyectos", wf_project_task: "Crear Tarea de Proyecto",
                    wf_project_dashboard: "Panel de Proyectos", /* New translation key */
                    day_detail_title: "Tareas para ",
                    settings_notifications: "Notificaciones",
                    settings_enable_notifications: "Habilitar Notificaciones",
                    settings_disable_notifications: "Deshabilitar Notificaciones",
                    project_task_name_placeholder: "Nombre de la Tarea",
                    project_task_project_name_placeholder: "Nombre del Proyecto (opcional)",
                    project_status_todo: "Por Hacer",
                    project_status_in_progress: "En Progreso",
                    project_status_done: "Completada"
                },
                en: {
                    initializing: "Initializing...", new_chat: "New Chat", new_project: "New Project",
                    web_offer: "üöÄ Launch your Business, get a free website with your subscription!",
                    upgrade_plan: "Upgrade Plan", free_guides: "Free AI Guides", workflows: "Workflows",
                    wf_social: "Social Media Booster", wf_social_1: "Create a Full Post", wf_social_2: "Copywriting",
                    wf_social_3: "Brainstorm Post Ideas", wf_social_4: "Define Brand Strategy",
                    wf_business: "Business Analysis", wf_business_1: "Analyze your Competition", wf_business_2: "Define my Ideal Customer",
                    wf_business_3: "Brainstorm Brand Names", wf_sales: "Communication & Sales", wf_sales_1: "24/7 Sales Assistant",
                    wf_sales_2: "Email Writing", wf_sales_3: "Web Design", wf_eng_1: "Translate/Correct Text",
                    wf_eng_2: "Learn New Vocabulary", wf_eng_3: "Practice Conversation", select_chats: "Select Multiple Chats",
                    delete: "Delete", login: "Login", settings: "Settings", logout: "Logout",
                    solutions: "Solutions", ally_title: "We are your Strategic Ally",
                    ally_desc: "Goatify is not just a chat. We are a custom AI with a team of experts ready to help you scale your business.",
                    welcome_user: "Hello, ", welcome_user_2: "! Today is a great day to create something amazing.",
                    welcome_guest: "How can I help you today?", model: "Model:", model_general: "General Chat (Turbo)",
                    model_web: "Web Search", voice: "Voice:", placeholder_main: "Type your message...", cancel: "Cancel",
                    confirm: "Confirm", plans_title: "Goatify Plans", plan_free_sub: "Forever", plan_free_cta: "Get Started for Free",
                    plan_feat_ltd_chat: "Limited chat access", plan_feat_ltd_hist: "Limited history", plan_feat_ltd_proj: "Project organization (Limited)",
                    plan_boost_cta: "Get Boost", plan_feat_fast: "Ultrafast responses ‚ö°Ô∏è", plan_feat_unl_hist: "Unlimited history",
                    plan_feat_proj: "Project Organization", plan_feat_ltd_wf: "Limited Workflows", plan_pro_cta: "Get Pro Plan + Web",
                    plan_feat_all_boost: "Everything in Boost and more", plan_feat_all_models: "Access to all AI models",
                    plan_feat_all_wf: "Access to all Workflows", plan_feat_community: "Private community & webinars", plan_feat_support: "1-on-1 priority support",
                    plan_feat_free_web: "Free Website", preview: "Preview", settings_email: "Email Address:", settings_plan: "Subscription Plan:",
                    settings_fontsize: "Font Size:", settings_theme: "Personalization:", settings_dark_mode: "Dark Mode",
                    settings_lang: "Language:", settings_whatsapp: "Connect to WhatsApp", current_plan: "Current Plan",
                    calendar_today: "Today", calendar_this_week: "This Week", calendar_mon: "Mon", calendar_tue: "Tue", calendar_wed: "Wed",
                    calendar_thu: "Thu", calendar_fri: "Fri", calendar_sat: "Sat", calendar_sun: "Sun",
                    calendar_no_tasks: "No tasks for this day.", calendar_add_task_placeholder: "Add new task...",
                    calendar_add_task_btn: "Add Task", calendar_my_calendar: "My Calendar & Tasks",
                    calendar_day_view: "Month View", calendar_week_view: "Week View",
                    notification_task_due: "Time for: ",
                    settings_schedule_meeting: "Schedule Meeting",
                    wf_project_management: "Project Management", wf_project_task: "Create Project Task",
                    wf_project_dashboard: "Project Dashboard",
                    day_detail_title: "Tasks for ",
                    settings_notifications: "Notifications",
                    settings_enable_notifications: "Enable Notifications",
                    settings_disable_notifications: "Disable Notifications",
                    project_task_name_placeholder: "Task Name",
                    project_task_project_name_placeholder: "Project Name (optional)",
                    project_status_todo: "To Do",
                    project_status_in_progress: "In Progress",
                    project_status_done: "Done"
                }
            };
            
            const GUEST_CREDIT_LIMIT = 5;
            const FREE_PLAN_CREDIT_LIMIT = 15;
            const COSTS = { WEB_PAGE: 2, COPYWRITING: 2, SALES_RESPONSE: 2, NEBULA: 2, GENERAL: 1, SEARCH: 1, ENGLISH_TEACHER: 1, IMAGE: 5 };
            // Ensure calendar is part of the state initialization
            let state = { chats: {}, projects: {}, structure: [], calendar: {} }; 
            let currentChatId = null, currentUser = null, speechOn = false, availableVoices = [], selectedVoice = null, isRecognizing = false, selectedImageBase64 = null, selectedPdfText = null;
            let micWasOnBeforeSpeaking = false;
            let modalResolve = null;
            let isSelectModeActive = false;
            let chatsToDelete = new Set();

            let currentMonth = dayjs(); 
            let currentWeek = dayjs(); 
            let selectedCalendarDate = dayjs(); 
            let currentCalendarView = 'month'; // 'month' or 'week'

            let notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true'; // Initialize from localStorage

            const dom = {};
            
            const fullDom = {
                appContainer: document.getElementById('app-container'),
                msgInput: document.getElementById('msg'), sendBtn: document.getElementById('send'),
                messageCounterEl: document.getElementById('message-counter'), 
                upgradePlanContainer: document.getElementById('upgrade-plan-container'),
                upgradePlanBtn: document.getElementById('upgrade-plan-btn'),
                newChatBtn: document.getElementById('new-chat-btn'), newProjectBtn: document.getElementById('new-project-btn'),
                pricingModal: document.getElementById('pricing-modal'), closePricingModalBtn: document.getElementById('close-pricing-modal'),
                genericModal: document.getElementById('generic-modal'), chatMessages: document.getElementById('chat-messages'),
                chatTitle: document.getElementById('chat-title'), mobileChatTitle: document.getElementById('mobile-chat-title'),
                chatTitleWrapper: document.getElementById('chat-title-wrapper'), mobileChatTitleWrapper: document.getElementById('mobile-chat-title-wrapper'),
                initialMessageContainer: document.getElementById('initial-message-container'), themeToggle: document.getElementById('theme-toggle'), themeIcon: document.getElementById('theme-icon'),
                micBtn: document.getElementById('mic-btn'), ttsToggle: document.getElementById('tts-toggle'), modelSelector: document.getElementById('model-selector'),
                imageUploadBtn: document.getElementById('image-upload-btn'), imageUploadInput: document.getElementById('image-upload'),
                imagePreviewContainer: document.getElementById('image-preview-container'), imagePreview: document.getElementById('image-preview'),
                clearImageBtn: document.getElementById('clear-image-btn'), pdfUploadBtn: document.getElementById('pdf-upload-btn'), pdfUploadInput: document.getElementById('pdf-upload'),
                pdfPreviewContainer: document.getElementById('pdf-preview-container'), pdfNameEl: document.getElementById('pdf-name'), pdfStatusEl: document.getElementById('pdf-status'), clearPdfBtn: document.getElementById('clear-pdf-btn'),
                sidebar: document.getElementById('sidebar'), menuToggle: document.getElementById('menu-toggle'), sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarContent: document.getElementById('sidebar-content'), loginView: document.getElementById('login-view'), userMenuView: document.getElementById('user-menu-view'),
                loginBtn: document.getElementById('login-btn'), userMenuBtn: document.getElementById('user-menu-btn'), userMenuPopup: document.getElementById('user-menu-popup'), userEmail: document.getElementById('user-email'),
                logoutBtn: document.getElementById('logout-btn'), webLaunchOfferBtn: document.getElementById('web-launch-offer-btn'),
                workflowsContainer: document.getElementById('workflows-container'), freeGuidesLink: document.getElementById('free-guides-link'),
                personalizedWelcome: document.getElementById('personalized-welcome'), genericWelcome: document.getElementById('generic-welcome'), userName: document.getElementById('user-name'),
                loadingOverlay: document.getElementById('loading-overlay'), htmlPreviewModal: document.getElementById('html-preview-modal'),
                closeHtmlPreviewModalBtn: document.getElementById('close-html-preview-modal'), htmlPreviewIframe: document.getElementById('html-preview-iframe'),
                voiceSelector: document.getElementById('voice-selector'), voiceSelectorContainer: document.getElementById('voice-selector-container'),
                selectChatsBtn: document.getElementById('select-chats-btn'), deleteModeControls: document.getElementById('delete-mode-controls'),
                deleteSelectedBtn: document.getElementById('delete-selected-btn'), cancelSelectModeBtn: document.getElementById('cancel-select-mode-btn'),
                imageGenBtn: document.getElementById('image-gen-btn'), servicesMenuBtn: document.getElementById('services-menu-btn'), servicesMenu: document.getElementById('services-menu'),
                contextualFooter: document.getElementById('contextual-footer'), imageGenBtnMobile: document.getElementById('image-gen-btn-mobile'),
                pdfUploadBtnMobile: document.getElementById('pdf-upload-btn-mobile'), imageUploadBtnMobile: document.getElementById('image-upload-btn-mobile'),
                newChatIconBtn: document.getElementById('new-chat-icon-btn'), settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'), closeSettingsModal: document.getElementById('close-settings-modal'),
                settingsUserEmail: document.getElementById('settings-user-email'), settingsUserPlan: document.getElementById('settings-user-plan'),
                settingsUpgradePlanBtn: document.getElementById('settings-upgrade-plan-btn'), fontSizeSlider: document.getElementById('font-size-slider'),
                fontSizeValue: document.getElementById('font-size-value'), settingsThemeToggle: document.getElementById('settings-theme-toggle'),
                settingsThemeIcon: document.getElementById('settings-theme-icon'), languageSelector: document.getElementById('language-selector'),
                connectWhatsappBtn: document.getElementById('connect-whatsapp-btn'), scheduleMeetingBtn: document.getElementById('schedule-meeting-btn'), freePlanButton: document.getElementById('free-plan-button'),
                notificationToggleBtn: document.getElementById('notification-toggle-btn'), notificationToggleText: document.getElementById('notification-toggle-text'),

                // Calendar elements
                calendarBtn: document.getElementById('calendar-btn'),
                calendarModal: document.getElementById('calendar-modal'),
                closeCalendarModal: document.getElementById('close-calendar-modal'),
                prevMonthBtn: document.getElementById('prev-month'),
                nextMonthBtn: document.getElementById('next-month'),
                currentMonthYear: document.getElementById('current-month-year'),
                calendarDaysGrid: document.getElementById('calendar-days-grid'),
                selectedDateDisplay: document.getElementById('selected-date-display'),
                tasksList: document.getElementById('tasks-list'),
                newTaskInput: document.getElementById('new-task-input'),
                newTaskTime: document.getElementById('new-task-time'), 
                addTaskBtn: document.getElementById('add-task-btn'),
                noTasksMessage: document.getElementById('no-tasks-message'),
                notificationBadge: document.getElementById('notification-badge'),
                inAppNotification: document.getElementById('in-app-notification'),
                notificationMessage: document.getElementById('notification-message'),
                monthViewContainer: document.getElementById('month-view-container'),
                weekViewContainer: document.getElementById('week-view-container'),
                monthViewBtn: document.getElementById('month-view-btn'), 
                weekViewBtn: document.getElementById('week-view-btn'),
                prevWeekBtn: document.getElementById('prev-week'),
                nextWeekBtn: document.getElementById('next-week'),
                currentWeekRange: document.getElementById('current-week-range'),
                weekDaysContent: document.getElementById('week-days-content'),
                dayDetailModal: document.getElementById('day-detail-modal'), 
                closeDayDetailModal: document.getElementById('close-day-detail-modal'),
                dayDetailDate: document.getElementById('day-detail-date'),
                dayDetailTasksList: document.getElementById('day-detail-tasks-list'),

                // Project Management Dashboard elements
                projectDashboardModal: document.getElementById('project-dashboard-modal'),
                closeProjectDashboardModal: document.getElementById('close-project-dashboard-modal'),
                projectDashboardContent: document.getElementById('project-dashboard-content'),
                projectTaskName: document.getElementById('project-task-name'),
                projectTaskDate: document.getElementById('project-task-date'),
                projectTaskTime: document.getElementById('project-task-time'),
                projectTaskStatus: document.getElementById('project-task-status'),
                projectTaskProjectName: document.getElementById('project-task-project-name'),
                addProjectTaskBtn: document.getElementById('add-project-task-btn'),
                tasksTodoList: document.getElementById('tasks-todo-list'),
                tasksInProgressList: document.getElementById('tasks-in-progress-list'),
                tasksDoneList: document.getElementById('tasks-done-list')
            };
            Object.assign(dom, fullDom);

            function setLanguage(lang) {
                const translationData = translations[lang];
                if (!translationData) return;
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    if (translationData[key]) {
                            if (el.tagName === 'TEXTAREA' || el.type === 'text' || el.type === 'date' || el.type === 'time' || el.tagName === 'SELECT') {
                                el.placeholder = translationData[key];
                            } else {
                                el.textContent = translationData[key];
                            }
                    }
                });
                // Special handling for placeholder attributes not covered by textContent
                if (dom.newTaskInput) dom.newTaskInput.placeholder = translationData.calendar_add_task_placeholder;
                if (dom.projectTaskName) dom.projectTaskName.placeholder = translationData.project_task_name_placeholder;
                if (dom.projectTaskProjectName) dom.projectTaskProjectName.placeholder = translationData.project_task_project_name_placeholder;
                
                // Update select options if necessary (e.g., status options in project dashboard)
                if (dom.projectTaskStatus) {
                    Array.from(dom.projectTaskStatus.options).forEach(option => {
                        const statusKey = `project_status_${option.value.replace('-', '_')}`;
                        if (translationData[statusKey]) {
                            option.textContent = translationData[statusKey];
                        }
                    });
                }

                if (dom.notificationToggleText) {
                    dom.notificationToggleText.textContent = notificationsEnabled ? translationData.settings_disable_notifications : translationData.settings_enable_notifications;
                }

                document.documentElement.lang = lang;
                localStorage.setItem('goatify-lang', lang);
                const currentModalConfirm = dom.genericModal.querySelector('#modal-confirm');
                if (currentModalConfirm) {
                    dom.genericModal.querySelector('#modal-cancel').textContent = translationData.cancel;
                }
                renderCalendarView(); // Re-render calendar to update day names if language changes
            }
            
            function updateContextualFooter(workflowKey) {
                if (!dom.contextualFooter) return;
                const workflowTexts = {
                    'create-full-post': 'Modo Redes Sociales: Define tu red social y tema para un post completo.',
                    'persuasive-copy': 'Modo Copywriter: Dime qu√© vendes y para d√≥nde es el texto.',
                    'brand-strategy': 'Modo Estratega: Dime el nombre y rubro de tu negocio para empezar.',
                    'competitor-analysis': 'Modo Analista: Pega la URL de tu competencia para investigarla.',
                    'sales-assistant': 'Modo Asistente de Ventas: Pega el mensaje de tu cliente para responder.',
                    'english-teacher-practice': 'Practice mode: Let\'s talk. How was your day?',
                    'design-web': 'Modo Dise√±ador Web: Describe el componente visual y lo crear√© en HTML.'
                };
                const currentChat = state.chats[currentChatId];
                const key = workflowKey || (currentChat ? currentChat.workflow : null);
                dom.contextualFooter.textContent = workflowTexts[key] || 'Tu copiloto de IA para hacer crecer tu negocio.';
            }

            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            function showModal({ title, message = '', useInput = false, useTextarea = false, placeholder = '', confirmText = 'Confirmar', initialValue = '' }) {
                const modalTitle = dom.genericModal.querySelector('#modal-title');
                const modalMessage = dom.genericModal.querySelector('#modal-message');
                const modalInput = dom.genericModal.querySelector('#modal-input');
                const modalTextarea = dom.genericModal.querySelector('#modal-textarea');
                const modalButtonsContainer = dom.genericModal.querySelector('#modal-buttons-container');
                const lang = localStorage.getItem('goatify-lang') || 'es';
                
                modalTitle.innerHTML = title; 
                modalMessage.innerHTML = message;
                modalMessage.style.display = message ? 'block' : 'none';
                
                modalInput.style.display = useInput ? 'block' : 'none';
                modalTextarea.style.display = useTextarea ? 'block' : 'none';
                
                modalInput.value = initialValue;
                modalTextarea.value = initialValue;
                modalInput.placeholder = placeholder;
                modalTextarea.placeholder = placeholder;
                
                modalButtonsContainer.innerHTML = `<button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded" data-translate-key="cancel">${translations[lang].cancel}</button><button id="modal-confirm" class="px-4 py-2 rounded text-white btn-primary" data-translate-key="confirm">${confirmText}</button>`;
                dom.genericModal.querySelector('#modal-confirm').addEventListener('click', () => hideModal(useInput ? modalInput.value : (useTextarea ? modalTextarea.value : true)), { once: true });
                dom.genericModal.querySelector('#modal-cancel').addEventListener('click', () => hideModal(null), { once: true });
                
                dom.genericModal.classList.remove('hidden');
                dom.genericModal.classList.add('flex');
                if (useInput) modalInput.focus();
                if (useTextarea) modalTextarea.focus();
                
                return new Promise(resolve => { modalResolve = resolve; });
            }
            function hideModal(resolveWith = null) { if(modalResolve) { modalResolve(resolveWith); modalResolve = null; } dom.genericModal.classList.add('hidden'); dom.genericModal.classList.remove('flex');  }
            
            function showPricingModal() { 
                dom.pricingModal.classList.remove('hidden'); 
                dom.pricingModal.classList.add('flex'); 
                setTimeout(() => { dom.pricingModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
                
                const lang = localStorage.getItem('goatify-lang') || 'es';
                const isFree = !currentUser || (currentUser.app_metadata?.plan || 'free') === 'free';
                
                if (isFree) {
                    dom.freePlanButton.textContent = translations[lang].current_plan;
                    dom.freePlanButton.disabled = true;
                    dom.freePlanButton.classList.add('btn-disabled');
                } else {
                    dom.freePlanButton.textContent = translations[lang].plan_free_cta;
                    dom.freePlanButton.disabled = false;
                    dom.freePlanButton.classList.remove('btn-disabled');
                }
            }
            function hidePricingModal() { dom.pricingModal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => { dom.pricingModal.classList.add('hidden'); dom.pricingModal.classList.remove('flex'); }, 300); }

            function showSettingsModal() {
                dom.settingsModal.classList.remove('hidden');
                dom.settingsModal.classList.add('flex');
                if (currentUser) {
                    dom.settingsUserEmail.textContent = currentUser.email;
                    const userPlan = currentUser.app_metadata?.plan || 'free';
                    dom.settingsUserPlan.textContent = userPlan.charAt(0).toUpperCase() + userPlan.slice(1);
                    dom.settingsUpgradePlanBtn.classList.toggle('hidden', userPlan !== 'free');
                } else {
                    dom.settingsUserEmail.textContent = 'Not logged in';
                    dom.settingsUserPlan.textContent = 'Free (Guest)';
                    dom.settingsUpgradePlanBtn.classList.remove('hidden');
                }
                dom.fontSizeSlider.value = parseInt(getComputedStyle(document.body).getPropertyValue('--base-font-size')) || 16;
                dom.fontSizeValue.textContent = `${dom.fontSizeSlider.value}px`;
                dom.settingsThemeIcon.className = `fas fa-${document.body.classList.contains('dark-theme') ? 'moon' : 'sun'} mr-2`;
                dom.languageSelector.value = localStorage.getItem('goatify-lang') || 'es';
                
                // Update notification toggle button text
                dom.notificationToggleText.textContent = notificationsEnabled ? translations[localStorage.getItem('goatify-lang') || 'es'].settings_disable_notifications : translations[localStorage.getItem('goatify-lang') || 'es'].settings_enable_notifications;
            }

            function hideSettingsModal() {
                dom.settingsModal.classList.add('hidden');
                dom.settingsModal.classList.remove('flex');
            }

            // Calendar functions
            function showCalendarModal() {
                dom.calendarModal.classList.remove('hidden');
                dom.calendarModal.classList.add('flex');
                // Ensure correct view is rendered on open
                if (!currentCalendarView) currentCalendarView = 'month'; 
                
                renderCalendarView();
                // Task list updates inside renderCalendarView
            }

            function hideCalendarModal() {
                dom.calendarModal.classList.add('hidden');
                dom.calendarModal.classList.remove('flex');
            }

            function renderMonthView() {
                dom.calendarDaysGrid.innerHTML = '';
                dom.currentMonthYear.textContent = currentMonth.format('MMMMYYYY'); 

                const startOfMonth = currentMonth.startOf('month');
                
                let firstDayIndex = startOfMonth.day(); // 0 (Sunday) - 6 (Saturday)
                let daysToPrepend = (firstDayIndex === 0) ? 6 : firstDayIndex - 1; // Adjust for Monday start

                const startDate = startOfMonth.subtract(daysTo prepend, 'day');

                for (let i = 0; i < 42; i++) { // 6 weeks to cover all days
                    const day = startDate.add(i, 'day');
                    const dayEl = document.createElement('div');
                    dayEl.classList.add('calendar-day');
                    dayEl.textContent = day.date();

                    if (day.month() === currentMonth.month()) {
                        dayEl.classList.add('current-month');
                    } else {
                        dayEl.classList.add('other-month');
                    }

                    const dayKey = day.format('YYYY-MM-DD');
                    if (state.calendar[dayKey] && state.calendar[dayKey].length > 0) {
                        dayEl.classList.add('has-tasks');
                    }

                    if (day.isSame(selectedCalendarDate, 'day')) {
                        dayEl.classList.add('selected');
                    }

                    dayEl.addEventListener('click', () => {
                        selectedCalendarDate = day;
                        showDayDetailModal(day); /* Open day detail on click */
                    });

                    dom.calendarDaysGrid.appendChild(dayEl);
                }
            }

            function renderWeekView() {
                dom.weekDaysContent.innerHTML = '';
                // Adjust currentWeek to start on Monday for consistent week view
                let startOfWeek = currentWeek.startOf('week'); 
                if (startOfWeek.day() === 0) { 
                    startOfWeek = startOfWeek.add(1, 'day');
                } else { 
                    startOfWeek = startOfWeek.subtract(startOfWeek.day() - 1, 'day');
                }

                const endOfWeek = startOfWeek.add(6, 'day'); 

                dom.currentWeekRange.textContent = `${startOfWeek.format('D MMM')} - ${endOfWeek.format('D MMMYYYY')}`; /* Display full year for range */

                for (let i = 0; i < 7; i++) {
                    const day = startOfWeek.add(i, 'day');
                    const dayKey = day.format('YYYY-MM-DD');
                    const tasks = state.calendar[dayKey] || [];
                    const lang = localStorage.getItem('goatify-lang') || 'es';
                    const dayNames = [
                        translations[lang].calendar_sun, translations[lang].calendar_mon, translations[lang].calendar_tue, translations[lang].calendar_wed,
                        translations[lang].calendar_thu, translations[lang].calendar_fri, translations[lang].calendar_sat
                    ];
                    const displayDayName = dayNames[day.day()]; 
                    const displayDate = day.format('D MMM');

                    const daySection = document.createElement('div');
                    daySection.className = 'week-day-section';
                    daySection.innerHTML = `
                        <h5>${displayDayName}, ${displayDate}</h5>
                        <div class="space-y-1">
                            ${tasks.length === 0 ? `<p class="text-xs text-text-medium italic">${translations[lang].calendar_no_tasks}</p>` : ''}
                            ${tasks.map((task, idx) => `
                                <div class="task-item ${task.completed ? 'task-item-completed' : ''}">
                                    <input type="checkbox" class="task-checkbox-week" data-date="${dayKey}" data-index="${idx}" ${task.completed ? 'checked' : ''}>
                                    <span>${task.text} ${task.time ? `(${task.time})` : ''}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    dom.weekDaysContent.appendChild(daySection);
                }

                dom.weekDaysContent.querySelectorAll('.task-checkbox-week').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const dateKey = e.currentTarget.dataset.date;
                        const indexToToggle = parseInt(e.currentTarget.dataset.index);
                        if (state.calendar[dateKey] && state.calendar[dateKey][indexToToggle]) {
                            state.calendar[dateKey][indexToToggle].completed = e.currentTarget.checked;
                            saveState();
                            renderWeekView(); // Re-render week view
                            updateNotificationBadge();
                        }
                    });
                });
            }


            function updateTasksDisplay() {
                dom.selectedDateDisplay.textContent = selectedCalendarDate.format('DD/MM/YYYY');
                dom.tasksList.innerHTML = '';
                const dayKey = selectedCalendarDate.format('YYYY-MM-DD');
                const tasks = state.calendar[dayKey] || [];

                if (tasks.length === 0) {
                    dom.noTasksMessage.style.display = 'block';
                } else {
                    dom.noTasksMessage.style.display = 'none';
                    tasks.sort((a, b) => (a.time || '').localeCompare(b.time || '')); // Sort tasks by time
                    tasks.forEach((task, index) => {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'flex items-center justify-between p-2 rounded-md bg-current-bg-light';
                        taskEl.classList.toggle('task-item-completed', task.completed); // Apply strikethrough if completed

                        taskEl.innerHTML = `
                            <div class="flex items-center">
                                <input type="checkbox" class="task-checkbox mr-2" data-index="${index}" ${task.completed ? 'checked' : ''}>
                                <span>${task.text} ${task.time ? `<span class="text-xs text-text-medium ml-1">(${task.time})</span>` : ''}</span>
                            </div>
                            <button class="text-red-500 hover:text-red-400 delete-task-btn" data-index="${index}">
                                <i class="fas fa-trash-alt fa-sm"></i>
                            </button>
                        `;
                        dom.tasksList.appendChild(taskEl);
                    });

                    dom.tasksList.querySelectorAll('.delete-task-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const indexToDelete = parseInt(e.currentTarget.dataset.index);
                            state.calendar[dayKey].splice(indexToDelete, 1);
                            if (state.calendar[dayKey].length === 0) {
                                delete state.calendar[dayKey]; // Clean up empty array
                            }
                            saveState();
                            renderCalendarView(); // Render current view type
                        });
                    });

                    dom.tasksList.querySelectorAll('.task-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', (e) => {
                            const indexToToggle = parseInt(e.currentTarget.dataset.index);
                            state.calendar[dayKey][indexToToggle].completed = e.currentTarget.checked;
                            saveState();
                            updateTasksDisplay(); // Re-render to apply strikethrough and re-sort
                        });
                    });
                }
                updateNotificationBadge();
            }

            function addTask() {
                const taskText = dom.newTaskInput.value.trim();
                const taskTime = dom.newTaskTime.value.trim(); 
                if (taskText) {
                    const dayKey = selectedCalendarDate.format('YYYY-MM-DD');
                    if (!state.calendar[dayKey]) {
                        state.calendar[dayKey] = [];
                    }
                    state.calendar[dayKey].push({ id: crypto.randomUUID(), text: taskText, time: taskTime, completed: false, notifiedThisMinute: false, type: 'calendar' }); 
                    dom.newTaskInput.value = '';
                    dom.newTaskTime.value = ''; 
                    saveState();
                    renderCalendarView(); 
                }
            }
            
            function updateNotificationBadge() {
                let pendingNotifications = 0;
                const now = dayjs();
                const todayKey = now.format('YYYY-MM-DD');

                if (state.calendar[todayKey]) {
                    state.calendar[todayKey].forEach(task => {
                        // Count uncompleted tasks whose time has arrived or passed
                        if (!task.completed && task.time) {
                            const taskDateTime = dayjs(`${todayKey}T${task.time}`);
                            if (taskDateTime.isSame(now, 'minute') || taskDateTime.isBefore(now, 'minute')) {
                                pendingNotifications++;
                            }
                        }
                    });
                }

                if (pendingNotifications > 0) {
                    dom.notificationBadge.textContent = pendingNotifications;
                    dom.notificationBadge.classList.remove('hidden');
                } else {
                    dom.notificationBadge.classList.add('hidden');
                }
            }

            function showInAppNotification(message) {
                dom.notificationMessage.textContent = message;
                dom.inAppNotification.classList.remove('hidden');
                setTimeout(() => dom.inAppNotification.classList.add('show'), 10); 
                setTimeout(() => {
                    dom.inAppNotification.classList.remove('show');
                    setTimeout(() => dom.inAppNotification.classList.add('hidden'), 300); 
                }, 5000); 
            }

            function checkAndNotifyTasks() {
                if (!notificationsEnabled) return; /* Check if notifications are enabled */

                const now = dayjs();
                const todayKey = now.format('YYYY-MM-DD');
                const currentHourMinute = now.format('HH:mm');

                if (state.calendar[todayKey]) {
                    state.calendar[todayKey].forEach(task => {
                        // Notify if not completed, time matches current minute, and hasn't been notified for this minute
                        if (!task.completed && task.time === currentHourMinute && !task.notifiedThisMinute) {
                            // Browser notification
                            if (Notification.permission === "granted") {
                                new Notification("Goatify AI - Tarea Pendiente!", {
                                    body: `${translations[localStorage.getItem('goatify-lang') || 'es'].notification_task_due} ${task.text} (${task.time})`,
                                    icon: './Logos HD.png'
                                });
                            } else if (Notification.permission !== "denied") {
                                Notification.requestPermission().then(permission => {
                                    if (permission === "granted") {
                                        new Notification("Goatify AI - Tarea Pendiente!", {
                                            body: `${translations[localStorage.getItem('goatify-lang') || 'es'].notification_task_due} ${task.text} (${task.time})`,
                                            icon: './Logos HD.png'
                                        });
                                    }
                                });
                            }
                            // In-app notification
                            showInAppNotification(`${translations[localStorage.getItem('goatify-lang') || 'es'].notification_task_due} ${task.text} (${task.time})`);
                            
                            task.notifiedThisMinute = true; // Mark as notified for this minute
                        }
                    });
                    // Reset notifiedThisMinute flag for tasks that are no longer due in the *current* minute
                    state.calendar[todayKey].forEach(task => {
                        if (task.notifiedThisMinute && task.time !== currentHourMinute) {
                            task.notifiedThisMinute = false;
                        }
                    });
                    saveState(); // Save state after updating notified flags
                }
                updateNotificationBadge(); // Always update badge after checking tasks
            }

            // Function to render the correct calendar view
            function renderCalendarView() {
                if (currentCalendarView === 'month') {
                    dom.monthViewContainer.style.display = 'block';
                    dom.weekViewContainer.style.display = 'none';
                    dom.monthViewBtn.classList.add('active');
                    dom.weekViewBtn.classList.remove('active');
                    renderMonthView();
                } else {
                    dom.monthViewContainer.style.display = 'none';
                    dom.weekViewContainer.style.display = 'block';
                    dom.monthViewBtn.classList.remove('active');
                    dom.weekViewBtn.classList.add('active');
                    renderWeekView();
                }
                updateTasksDisplay(); // Always update tasks list for current selected date/week
            }

            // Day Detail Modal Functions
            function showDayDetailModal(date) {
                dom.dayDetailDate.textContent = `${translations[localStorage.getItem('goatify-lang') || 'es'].day_detail_title} ${date.format('DD/MM/YYYY')}`;
                dom.dayDetailTasksList.innerHTML = '';
                const dayKey = date.format('YYYY-MM-DD');
                const tasks = state.calendar[dayKey] || [];

                if (tasks.length === 0) {
                    dom.dayDetailTasksList.innerHTML = `<p class="text-text-medium italic">${translations[localStorage.getItem('goatify-lang') || 'es'].calendar_no_tasks}</p>`;
                } else {
                    tasks.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
                    tasks.forEach((task, index) => {
                        const taskEl = document.createElement('div');
                        taskEl.className = `flex items-center justify-between p-2 rounded-md ${task.completed ? 'task-item-completed' : ''}`;
                        taskEl.innerHTML = `
                            <div class="flex items-center">
                                <input type="checkbox" class="task-checkbox-detail mr-2" data-date="${dayKey}" data-index="${index}" ${task.completed ? 'checked' : ''}>
                                <span>${task.text} ${task.time ? `(${task.time})` : ''}</span>
                            </div>
                            <button class="text-red-500 hover:text-red-400 delete-task-btn-detail" data-date="${dayKey}" data-index="${index}">
                                <i class="fas fa-trash-alt fa-sm"></i>
                            </button>
                        `;
                        dom.dayDetailTasksList.appendChild(taskEl);
                    });

                    dom.dayDetailTasksList.querySelectorAll('.delete-task-btn-detail').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const dateKey = e.currentTarget.dataset.date;
                            const indexToDelete = parseInt(e.currentTarget.dataset.index);
                            state.calendar[dateKey].splice(indexToDelete, 1);
                            if (state.calendar[dateKey].length === 0) {
                                delete state.calendar[dateKey];
                            }
                            saveState();
                            renderCalendarView();
                            showDayDetailModal(date); // Re-open detail view to reflect changes
                        });
                    });

                    dom.dayDetailTasksList.querySelectorAll('.task-checkbox-detail').forEach(checkbox => {
                        checkbox.addEventListener('change', (e) => {
                            const dateKey = e.currentTarget.dataset.date;
                            const indexToToggle = parseInt(e.currentTarget.dataset.index);
                            state.calendar[dateKey][indexToToggle].completed = e.currentTarget.checked;
                            saveState();
                            renderCalendarView();
                            showDayDetailModal(date); // Re-open detail view to reflect changes
                        });
                    });
                }
                dom.dayDetailModal.style.display = 'flex';
            }

            function hideDayDetailModal() {
                dom.dayDetailModal.style.display = 'none';
            }

            // Project Management Functions
            function showProjectDashboard() {
                dom.projectDashboardModal.classList.remove('hidden');
                dom.projectDashboardModal.classList.add('flex');
                renderProjectTasks();
            }

            function hideProjectDashboard() {
                dom.projectDashboardModal.classList.add('hidden');
                dom.projectDashboardModal.classList.remove('flex');
            }

            function addProjectTask() {
                const taskName = dom.projectTaskName.value.trim();
                const taskDate = dom.projectTaskDate.value;
                const taskTime = dom.projectTaskTime.value;
                const taskStatus = dom.projectTaskStatus.value;
                const projectName = dom.projectTaskProjectName.value.trim();

                if (!taskName || !taskDate) {
                    alert("Por favor, ingresa el nombre de la tarea y la fecha.");
                    return;
                }

                const task = {
                    id: crypto.randomUUID(),
                    text: taskName,
                    date: taskDate,
                    time: taskTime,
                    status: taskStatus,
                    projectName: projectName,
                    completed: status === 'done'
                };

                // Add to calendar state
                if (!state.calendar[task.date]) {
                    state.calendar[task.date] = [];
                }
                state.calendar[task.date].push(task);

                // Clear form
                dom.projectTaskName.value = '';
                dom.projectTaskDate.value = '';
                dom.projectTaskTime.value = '';
                dom.projectTaskStatus.value = 'todo';
                dom.projectTaskProjectName.value = '';

                saveState();
                renderProjectTasks();
                renderCalendarView(); // Update calendar to show new tasks
            }

            function renderProjectTasks() {
                dom.tasksTodoList.innerHTML = '';
                dom.tasksInProgressList.innerHTML = '';
                dom.tasksDoneList.innerHTML = '';

                const allTasks = [];
                for (const date in state.calendar) {
                    // Only add tasks that have a 'status' to the project dashboard view
                    state.calendar[date].forEach(task => {
                        if (task.status) { // Assuming tasks with 'status' property are project tasks
                            allTasks.push(task);
                        }
                    });
                }

                allTasks.sort((a, b) => {
                    const dateA = dayjs(`${a.date} ${a.time || '00:00'}`);
                    const dateB = dayjs(`${b.date} ${b.time || '00:00'}`);
                    return dateA.diff(dateB);
                });

                const lang = localStorage.getItem('goatify-lang') || 'es';

                allTasks.forEach(task => {
                    const taskCard = document.createElement('div');
                    taskCard.className = `task-card ${task.status === 'done' ? 'completed' : ''}`;
                    taskCard.innerHTML = `
                        <div class="task-card-header">
                            <span class="task-title">${task.text}</span>
                            <input type="checkbox" class="project-task-checkbox" data-id="${task.id}" ${task.status === 'done' ? 'checked' : ''}>
                        </div>
                        <div class="task-card-details">
                            ${task.projectName ? `Proyecto: ${task.projectName}<br>` : ''}
                            Vencimiento: ${dayjs(task.date).format('DD/MM/YYYY')} ${task.time ? `(${task.time})` : ''}
                        </div>
                        <div class="task-card-actions">
                            <button class="update-project-task-status-btn" data-id="${task.id}" data-status="todo">${translations[lang].project_status_todo}</button>
                            <button class="update-project-task-status-btn" data-id="${task.id}" data-status="in-progress">${translations[lang].project_status_in_progress}</button>
                            <button class="update-project-task-status-btn" data-id="${task.id}" data-status="done">${translations[lang].project_status_done}</button>
                            <button class="delete-project-task-btn" data-id="${task.id}"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;

                    if (task.status === 'todo') dom.tasksTodoList.appendChild(taskCard);
                    else if (task.status === 'in-progress') dom.tasksInProgressList.appendChild(taskCard);
                    else if (task.status === 'done') dom.tasksDoneList.appendChild(taskCard);
                });

                document.querySelectorAll('.delete-project-task-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const taskId = e.currentTarget.dataset.id;
                        for (const date in state.calendar) {
                            state.calendar[date] = state.calendar[date].filter(task => task.id !== taskId);
                            if (state.calendar[date].length === 0) {
                                delete state.calendar[date];
                            }
                        }
                        saveState();
                        renderProjectTasks();
                        renderCalendarView();
                    });
                });

                document.querySelectorAll('.update-project-task-status-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const taskId = e.currentTarget.dataset.id;
                        const newStatus = e.currentTarget.dataset.status;
                        for (const date in state.calendar) {
                            const task = state.calendar[date].find(t => t.id === taskId);
                            if (task) {
                                task.status = newStatus;
                                task.completed = (newStatus === 'done');
                                break;
                            }
                        }
                        saveState();
                        renderProjectTasks();
                        renderCalendarView();
                    });
                });

                document.querySelectorAll('.project-task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const taskId = e.currentTarget.dataset.id;
                        const newStatus = e.currentTarget.checked ? 'done' : 'todo';
                        for (const date in state.calendar) {
                            const task = state.calendar[date].find(t => t.id === taskId);
                            if (task) {
                                task.status = newStatus;
                                task.completed = e.currentTarget.checked;
                                break;
                            }
                        }
                        saveState();
                        renderProjectTasks();
                        renderCalendarView();
                    });
                });
            }

            // --- END Project Management Functions ---

            // Run checkAndNotifyTasks periodically
            setInterval(checkAndNotifyTasks, 10 * 1000); // Check every 10 seconds for responsiveness

            // Request notification permission on load
            if ("Notification" in window) {
                if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                    Notification.requestPermission();
                }
            } else {
                console.warn("Browser does not support desktop notifications.");
            }

            function speak(text) { 
                if (!speechOn || !('speechSynthesis' in window) || !text) return; 
                speechSynthesis.cancel();
                micWasOnBeforeSpeaking = isRecognizing;
                if (isRecognizing) { recognition.stop(); }
                const cleanText = text.replace(/<[^>]*>/g, '').replace(/[*_`#~[\]()üîç]|(-{3,})/g, ''); 
                const utterance = new SpeechSynthesisUtterance(cleanText); 
                if (selectedVoice) { utterance.voice = selectedVoice; }
                utterance.rate = 1.15;
                utterance.onend = () => {
                    if (micWasOnBeforeSpeaking) {
                        if (recognition && !isRecognizing) {
                            try { recognition.start(); } catch(e) { console.error("Error restarting recognition:", e); }
                        }
                        micWasOnBeforeSpeaking = false;
                    }
                };
                utterance.onerror = (e) => {
                    console.error('Speech synthesis error:', e);
                     if (micWasOnBeforeSpeaking) {
                        if (recognition && !isRecognizing) {
                           try { recognition.start(); } catch(e) { console.error("Error restarting recognition on error:", e); }
                        }
                        micWasOnBeforeSpeaking = false;
                    }
                }
                speechSynthesis.speak(utterance); 
            }

            function populateVoiceList() {
                if(!dom.voiceSelector) return;
                const setVoices = () => {
                    if (typeof speechSynthesis === 'undefined') {
                        return;
                    }
                    availableVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('es-'));
                    const preferredVoices = [ "Microsoft Sabina Online (Natural) - Spanish (Mexico)", "Paulina", "Google espa√±ol de Estados Unidos", "Google espa√±ol" ];
                     availableVoices.sort((a, b) => {
                        let aIdx = preferredVoices.indexOf(a.name); let bIdx = preferredVoices.indexOf(b.name);
                        if (aIdx === -1) aIdx = Infinity; if (bIdx === -1) bIdx = Infinity;
                        if (aIdx !== bIdx) return aIdx - bIdx;
                        return a.name.localeCompare(b.name);
                    });
                    dom.voiceSelector.innerHTML = '';
                    if(availableVoices.length > 0) {
                             dom.voiceSelector.disabled = false;
                        availableVoices.forEach(voice => {
                            const option = document.createElement('option');
                            const displayName = voice.name.replace('Microsoft', '').replace('Online (Natural) -', '').replace('Google', '').replace('Spanish (Mexico)','Mex').trim();
                            option.textContent = displayName || voice.lang;
                            option.value = voice.name;
                            dom.voiceSelector.appendChild(option);
                        });
                        selectedVoice = availableVoices[0];
                        if (selectedVoice) dom.voiceSelector.value = selectedVoice.name;
                    } 
                }
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = setVoices;
                }
                setTimeout(setVoices, 200);
            }

            function updateModelSelectorState() { /* No direct action needed here for now, kept for structure */ }

            function createSubtleUpsell(workflowKey) {
                const upsells = {
                     'create-full-post': "Tip de experto: La clave es la constancia. Si quieres un calendario de contenido para todo el mes, nuestros planes de gesti√≥n de redes son para ti.",
                     'persuasive-copy': "Un buen copy es el coraz√≥n de un anuncio ganador. Cuando est√©s listo para lanzar una campa√±a de publicidad completa con segmentaci√≥n y presupuesto optimizado, nuestro equipo de marketing puede gestionarla por ti.",
                     'post-ideas': "Usa estas ideas para no quedarte en blanco. Recuerda que si necesitas llevar tu marca al siguiente nivel, podemos crear avatares con IA que hablen en videos. Es algo que nos diferencia.",
                     'brand-strategy': "Esta es la base. Para desarrollar una estrategia de marketing digital completa con anuncios y embudos, lo ideal es una sesi√≥n con nuestros consultores.",
                     'sales-assistant': "Tip Pro: ¬øSab√≠as que podemos crear un bot que haga esto por ti 24/7, cualificando clientes mientras duermes? Si te interesa, hablemos de automatizaci√≥n.",
                     'email-writing': "El poder real de estos emails se desata al integrarlos en un sistema de marketing autom√°tico. Si quieres que te construyamos todo el sistema, contacta a nuestros especialistas.",
                     'english-teacher-practice': "Your English is improving! Quick tip: Strong communication is key in business. Our copywriting services help clients ensure their message is perfect for international markets."
                };
                const upsellText = upsells[workflowKey];
                if (upsellText) {
                    const upsellDiv = document.createElement('div');
                    upsellDiv.className = 'mt-3 pt-3 border-t border-themed text-xs text-text-medium italic';
                    upsellDiv.innerHTML = upsellText;
                    return upsellDiv;
                }
                return null;
            }

            function getModelForRequest(workflow, hasFile) {
                if (workflow === "design-web") return "gpt-4o-mini";
                if (hasFile) return "gpt-4o-mini";
                return dom.modelSelector.value;
            }

            async function getAIResponse(prompt, history, image, pdf, model, workflow, userName) {
                const name = (userName || '').split(' ')[0];
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }
                const body = { 
                    prompt, history, model,
                    workflow, userName: name, title,
                    imageData: image, pdfText: pdf, 
                };
                try {
                    const response = await fetch('/.netlify/functions/get-ai-response', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({details: 'Error desconocido en el servidor'}));
                        console.error("Backend Error:", errorData);
                        throw new Error(errorData.details || `Error del servidor: ${response.status}.`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("Fetch Error:", error);
                    throw error;
                }
            }
            
            function getCreditCount() {
                if (currentUser) {
                    const credits = localStorage.getItem(`userCredits_${currentUser.id}`);
                    return credits === null ? FREE_PLAN_CREDIT_LIMIT : parseInt(credits, 10);
                } else {
                    const credits = localStorage.getItem('guestCreditCount');
                    return credits === null ? GUEST_CREDIT_LIMIT : parseInt(credits, 10);
                }
            }
            
            function setCreditCount(newCount) {
                const count = Math.max(0, newCount);
                if (currentUser) {
                    localStorage.setItem(`userCredits_${currentUser.id}`, count);
                } else {
                    localStorage.setItem('guestCreditCount', count);
                }
                updateCreditCounter();
            }

            async function loadStateForUser() {
                console.log("loadStateForUser called. Current user:", currentUser ? currentUser.id : "guest");
                if (!currentUser) {
                    const saved = localStorage.getItem('guestState');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        state = parsed.state || { chats: {}, projects: {}, structure: [], calendar: {} };
                        currentChatId = parsed.currentChatId;
                        console.log("Loaded guest state from localStorage:", state);
                    } else {
                        state = { chats: {}, projects: {}, structure: [], calendar: {} };
                        currentChatId = null;
                        console.log("No guest state found, initialized new state.");
                    }
                    renderSidebar();
                    selectChat(currentChatId);
                    return;
                }

                try {
                    const response = await fetch('/.netlify/functions/load-chats', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: currentUser.id }),
                    });

                    if (!response.ok) { throw new Error(`Server error: ${response.status}`); }
                    const dbState = await response.json();
                    state = dbState.state || { chats: {}, projects: {}, structure: [], calendar: {} };
                    if (!state.calendar) {
                        state.calendar = {};
                    }
                    currentChatId = dbState.currentChatId;
                    console.log("Loaded user state from DB:", state);
                } catch (error) {
                    console.error("Could not load from DB, falling back to localStorage:", error);
                    const saved = localStorage.getItem(`goatbotState_${currentUser.id}`);
                    state = saved ? (JSON.parse(saved).state || { chats: {}, projects: {}, structure: [], calendar: {} }) : { chats: {}, projects: {}, structure: {}, calendar: {} };
                    if (!state.calendar) {
                        state.calendar = {};
                    }
                    currentChatId = saved ? JSON.parse(saved).currentChatId : null;
                    console.log("Loaded user state from localStorage (fallback):", state);
                }
                
                renderSidebar();
                selectChat(currentChatId);
            }

            async function saveState() {
                if (!currentUser) {
                    try {
                        localStorage.setItem('guestState', JSON.stringify({ state, currentChatId }));
                    } catch (e) { console.error("Guest localStorage is full.", e); }
                    return;
                }
                try {
                    const stateToSave = { state, currentChatId };
                    await fetch('/.netlify/functions/save-chats', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            userId: currentUser.id,
                            stateToSave: stateToSave
                        }),
                    });
                } catch (error) {
                    console.error("Failed to save state to DB:", error);
                }
            }
            
            function updateUserUI() {
                console.log("updateUserUI called. Current user:", currentUser ? currentUser.email : "none");
                if (currentUser) {
                    dom.loginView.classList.add('hidden');
                    dom.userMenuView.classList.remove('hidden');
                    dom.genericWelcome.classList.add('hidden');
                    dom.personalizedWelcome.classList.remove('hidden');
                    const userName = currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.email.split('@')[0];
                    dom.userEmail.textContent = currentUser.user_metadata?.full_name || currentUser.email;
                    dom.userName.textContent = userName;
                    dom.upgradePlanContainer.classList.toggle('hidden', (currentUser.app_metadata?.plan || 'free') !== 'free');
                } else {
                    dom.loginView.classList.remove('hidden');
                    dom.userMenuView.classList.add('hidden');
                    dom.genericWelcome.classList.remove('hidden');
                    dom.personalizedWelcome.classList.add('hidden');
                    dom.upgradePlanContainer.classList.add('hidden');
                }
                updateCreditCounter();
            }

            function updateCreditCounter() {
                const count = getCreditCount();
                const limit = currentUser ? FREE_PLAN_CREDIT_LIMIT : GUEST_CREDIT_LIMIT;
                dom.messageCounterEl.innerHTML = `${count}/${limit} <span class="hidden sm:inline">cr√©ditos</span>`;
            }

            function setTheme(isDark) { 
                document.body.className = 'w-screen overflow-x-hidden';
                document.body.classList.add(isDark ? 'dark-theme' : 'light-theme');
                dom.themeIcon.className = `fas fa-${isDark ? 'sun' : 'moon'}`; 
                if (dom.settingsThemeIcon) dom.settingsThemeIcon.className = `fas fa-${isDark ? 'moon' : 'sun'} mr-2`; // Update settings modal icon
                localStorage.setItem('theme', isDark ? 'dark' : 'light'); 
            }

            function toggleSidebar(show) {
                if (show) {
                    dom.sidebar.classList.add('is-open');
                    dom.sidebarOverlay.classList.remove('pointer-events-none');
                    dom.sidebarOverlay.classList.add('opacity-50');
                } else {
                    dom.sidebar.classList.remove('is-open');
                    dom.sidebarOverlay.classList.remove('opacity-50');
                    dom.sidebarOverlay.classList.add('pointer-events-none');
                }
            }
            
            function createNewChat(options = {}) {
                const id = 'chat-' + crypto.randomUUID();
                const name = currentUser ? (currentUser.user_metadata.full_name?.split(' ')[0] || 'T√∫') : 'viajero';
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }
                const initialMessages = options.initialMessages || [{ 
                    role: 'assistant', 
                    content: `Saludos, ${title}. Soy Goatify AI, aqu√≠ para servirte. Cada idea tuya es una estrella a punto de nacer. ¬øEn qu√© universo nos sumergimos hoy?` 
                }];
                state.chats[id] = { 
                    id, 
                    title: options.title || "Conversaci√≥n C√≥smica", 
                    messages: initialMessages,
                    workflow: options.workflow || null,
                    model: options.model || 'gpt-3.5-turbo-1106'
                }; 
                state.structure.unshift(id); 
                selectChat(id); 
                saveState(); 
                renderSidebar(); 
                dom.modelSelector.value = options.model || 'gpt-3.5-turbo-1106';
                updateModelSelectorState();
                if (window.innerWidth < 768) toggleSidebar(false);
                return id; 
            }

            function selectChat(chatId) { 
                if (isSelectModeActive) return;
                if (!chatId || !state.chats[chatId]) { resetChatView(); return; } 
                currentChatId = chatId; 
                dom.initialMessageContainer.style.display = 'none'; 
                dom.chatMessages.innerHTML = ''; 
                const chat = state.chats[chatId]; 
                
                // Update the text content of the h1/h2 elements and ensure icon is present
                // Desktop title
                if (dom.chatTitle) {
                    dom.chatTitle.textContent = chat.title; 
                    if (!dom.chatTitle.querySelector('.edit-icon')) { 
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-pencil-alt text-xs text-text-medium edit-icon';
                        dom.chatTitle.prepend(icon); 
                    }
                }

                // Mobile title
                if (dom.mobileChatTitle) {
                    dom.mobileChatTitle.textContent = chat.title; 
                    if (!dom.mobileChatTitle.querySelector('.edit-icon')) { 
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-pencil-alt text-xs text-text-medium edit-icon';
                        dom.mobileChatTitle.prepend(icon); 
                    }
                }

                chat.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, msg.image, index)); 
                dom.modelSelector.value = chat.model || 'gpt-3.5-turbo-1106';
                updateActiveChatHighlight(); 
                saveState();
                updateModelSelectorState();
                updateContextualFooter(chat.workflow);
                if (window.innerWidth < 768) toggleSidebar(false);
            }

            function resetChatView() { 
                currentChatId = null; 
                if (dom.chatTitle) dom.chatTitle.textContent = "Goatify AI";
                // Remove existing edit icon if any (to avoid duplicates on reset)
                const existingDesktopIcon = dom.chatTitle.querySelector('.edit-icon');
                if (existingDesktopIcon) existingDesktopIcon.remove();

                if (dom.mobileChatTitle) dom.mobileChatTitle.textContent = "Goatify AI";
                const existingMobileIcon = dom.mobileChatTitle.querySelector('.edit-icon');
                if (existingMobileIcon) existingMobileIcon.remove();

                dom.chatMessages.innerHTML = ''; 
                dom.initialMessageContainer.style.display = 'flex'; 
                updateUserUI(); 
                updateActiveChatHighlight(); 
                dom.modelSelector.value = 'gpt-3.5-turbo-1106';
                updateModelSelectorState();
                updateContextualFooter(null);
            }

            function addMessageToUI(role, content, imageSrc, messageIndex) {
                const wrapper = document.createElement('div');
                wrapper.className = `chat-bubble-wrapper group flex items-center gap-2 my-2 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const bubble = document.createElement('div');
                bubble.className = `p-3 md:p-4 rounded-xl max-w-lg md:max-w-xl ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot'}`;

                if (imageSrc) {
                    const img = document.createElement('img');
                    img.src = imageSrc;
                    img.className = 'rounded-lg mb-2 max-w-full h-auto';
                    bubble.appendChild(img);
                }
                const contentDiv = document.createElement('div');
                contentDiv.className = 'markdown-content';
                contentDiv.innerHTML = content === '‚Ä¶' ? `<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .2s;"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .4s;"></div></div>` : marked.parse(content || "");
                bubble.appendChild(contentDiv);

                if (role === 'user') {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'p-1 text-text-medium opacity-100 transition-opacity'; 
                    editBtn.innerHTML = '<i class="fas fa-pencil-alt fa-xs"></i>';
                    editBtn.title = 'Editar mensaje';
                    editBtn.onclick = (e) => { e.stopPropagation(); handleEditMessage(messageIndex); };
                    wrapper.insertBefore(editBtn, wrapper.firstChild); 
                }
                
                if (role === 'assistant' && /<\/?[a-z][\s\S]*>/i.test(content)) {
                    const previewButton = document.createElement('button');
                    previewButton.innerHTML = '<i class="fas fa-eye mr-2"></i>Vista Previa';
                    previewButton.className = 'btn-primary text-xs font-semibold px-3 py-1 rounded-md mt-3';
                    previewButton.addEventListener('click', () => {
                        const match = content.match(/```html\n([\s\S]*?)```/);
                        const htmlToPreview = match ? match[1] : content;
                        dom.htmlPreviewIframe.srcdoc = htmlToPreview;
                        dom.htmlPreviewModal.classList.remove('hidden');
                        dom.htmlPreviewModal.classList.add('flex');
                    });
                    bubble.appendChild(previewButton);
                }

                wrapper.appendChild(bubble); 
                dom.chatMessages.appendChild(wrapper);
                dom.chatMessages.scrollTop = dom.chatMessages.scrollHeight;
                return bubble;
            }
            
            async function handleEditMessage(index) {
                const chat = state.chats[currentChatId];
                if (!chat || !chat.messages[index]) return;
                const originalContent = chat.messages[index].content;
                const newContent = await showModal({
                    title: 'Editar Mensaje',
                    useTextarea: true,
                    initialValue: originalContent,
                    confirmText: 'Guardar Cambios'
                });
                if (newContent && newContent.trim() !== originalContent.trim()) {
                    chat.messages[index].content = newContent.trim();
                    await saveState();
                    selectChat(currentChatId);
                }
            }

            function updateMessageInUI(bubble, content, imageSrc) {
                const newBubble = addMessageToUI('assistant', content, imageSrc);
                if (bubble && bubble.parentElement) {
                    bubble.parentElement.replaceWith(newBubble.parentElement);
                }
            }
            
            function renderSidebar() { 
                dom.sidebarContent.innerHTML = ''; 
                const frag = document.createDocumentFragment(); 
                (state.structure || []).forEach(id => { 
                    if (id.startsWith('project-')) {
                        frag.appendChild(createProjectElement(id));
                    } else if (id.startsWith('chat-')) {
                             frag.appendChild(createChatItemElement(id));
                    }
                }); 
                dom.sidebarContent.appendChild(frag); 
                updateActiveChatHighlight(); 
            }
            function createChatItemElement(id, isSubItem = false) { 
                const chat = state.chats[id]; 
                if (!chat) return document.createDocumentFragment(); 
                const item = document.createElement('div'); 
                item.className = `chat-item group flex items-center justify-between p-2 rounded-md cursor-pointer ${isSubItem ? 'pl-5' : ''}`; item.dataset.id = id; 
                if (isSelectModeActive) {
                    item.draggable = false;
                    const isSelected = chatsToDelete.has(id);
                    item.innerHTML = `<i class="far ${isSelected ? 'fa-check-square' : 'fa-square'} mr-2 text-primary"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span>`;
                    if (isSelected) item.classList.add('selected-for-delete');
                    item.addEventListener('click', () => {
                        if (chatsToDelete.has(id)) {
                            chatsToDelete.delete(id);
                            item.querySelector('i').classList.replace('fa-check-square', 'fa-square');
                            item.classList.remove('selected-for-delete');
                        } else {
                            chatsToDelete.add(id);
                            item.querySelector('i').classList.replace('fa-square', 'fa-check-square');
                            item.classList.add('selected-for-delete');
                        }
                        dom.deleteSelectedBtn.disabled = chatsToDelete.size === 0;
                    });
                } else {
                    item.draggable = true;
                    item.innerHTML = `<i class="far fa-comment-dots mr-2"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span><div class="chat-item-actions flex-shrink-0"><button class="rename-btn text-text-medium hover:text-primary p-1"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-text-medium hover:text-red-500 p-1"><i class="fas fa-trash-alt fa-xs"></i></button></div>`; 
                    item.addEventListener('click', e => { if (!e.target.closest('.chat-item-actions')) selectChat(id); }); 
                    item.addEventListener('dragstart', e => handleDragStart(e, id)); item.querySelector('.rename-btn').addEventListener('click', () => renameItem('chat', id)); item.querySelector('.delete-btn').addEventListener('click', () => deleteItem('chat', id));
                }
                return item; 
            }
            function createProjectElement(id) {
                const project = state.projects[id];
                if (!project) return document.createDocumentFragment();
                const div = document.createElement('div'); div.className = 'project'; div.dataset.id = id;
                const header = document.createElement('div'); header.className = 'project-header group flex items-center p-2 rounded-md cursor-pointer';
                header.innerHTML = `<i class="fas fa-chevron-right project-arrow mr-2 transition-transform"></i><i class="fas fa-folder mr-2 text-yellow-500"></i><span class="flex-grow truncate text-sm font-bold">${project.title}</span><div class="chat-item-actions flex-shrink-0"><button class="rename-btn text-text-medium hover:text-primary p-1"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-text-medium hover:text-red-500 p-1"><i class="fas fa-trash-alt fa-xs"></i></button></div>`;
                const content = document.createElement('div'); content.className = 'project-content pl-2 pt-1 space-y-1';
                (project.chatIds || []).forEach(chatId => content.appendChild(createChatItemElement(chatId, true)));
                div.append(header, content);
                header.addEventListener('click', e => { if (!e.target.closest('.chat-item-actions')) div.classList.toggle('open'); });
                header.addEventListener('dragover', e => handleDragOver(e, header));
                header.addEventListener('dragleave', e => handleDragLeave(e, header));
                header.addEventListener('drop', e => handleDrop(e, id, header));
                header.querySelector('.rename-btn').addEventListener('click', () => renameItem('project', id));
                header.querySelector('.delete-btn').addEventListener('click', () => deleteItem('project', id));
                return div;
            }
            let draggedItemId = null; function handleDragStart(e, id) { draggedItemId = id; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', id); } function handleDragOver(e, el) { e.preventDefault(); el.classList.add('drag-over'); } function handleDragLeave(e, el) { el.classList.remove('drag-over'); }
            function handleDrop(e, targetProjectId, targetElement) {
                e.preventDefault(); if (targetElement) targetElement.classList.remove('drag-over');
                const sourceChatId = e.dataTransfer.getData('text/plain');
                if (!sourceChatId || !sourceChatId.startsWith('chat-') || targetProjectId === sourceChatId) return;
                state.structure = state.structure.filter(id => id !== sourceChatId); 
                Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(id => id !== sourceChatId) }); 
                if(state.projects[targetProjectId]){ 
                    if(!state.projects[targetProjectId].chatIds) state.projects[targetProjectId].chatIds = [];
                    state.projects[targetProjectId].chatIds.unshift(sourceChatId); 
                } 
                saveState(); renderSidebar(); 
            }
            async function renameItem(type, id) {
                const item = type === 'chat' ? state.chats[id] : state.projects[id];
                if(!item) return;
                const newName = await showModal({ title: `Renombrar ${type === 'chat' ? 'Conversaci√≥n' : 'Proyecto'}`, useInput: true, placeholder: item.title, initialValue: item.title });
                if (newName && newName.trim()) {
                    item.title = newName.trim();
                    if (type === 'chat' && currentChatId === id) {
                        dom.chatTitle.textContent = item.title;
                        if (dom.mobileChatTitle) dom.mobileChatTitle.textContent = item.title;
                    }
                    saveState();
                    renderSidebar();
                }
            }
            async function deleteItem(type, id) { const item = type === 'chat' ? state.chats[id] : state.projects[id]; const conf = await showModal({ title: `Eliminar ${item.title}?`, message: 'Esta acci√≥n no se puede deshacer.', confirmText: 'Eliminar' }); if (conf) { state.structure = state.structure.filter(i => i !== id); if (type === 'project') { (item.chatIds || []).forEach(cid => delete state.chats[cid]); delete state.projects[id]; } else { delete state.chats[id]; Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(cid => cid !== id)}); } if(currentChatId === id || (type === 'project' && (item.chatIds || []).includes(currentChatId))) resetChatView(); saveState(); renderSidebar(); } }
            
            function updateActiveChatHighlight() { 
                document.querySelectorAll('.chat-item').forEach(item => {
                    if (item.dataset.id === currentChatId) {
                        item.classList.add('selected-chat');
                    } else {
                        item.classList.remove('selected-chat');
                    }
                }); 
            }

            function clearImageData() { dom.imageUploadInput.value = ''; dom.imagePreviewContainer.classList.add('hidden'); selectedImageBase64 = null; updateModelSelectorState(); }
            function clearPdfData() { dom.pdfUploadInput.value = ''; dom.pdfPreviewContainer.classList.add('hidden'); selectedPdfText = null; updateModelSelectorState(); }
            function hasFile() { return selectedImageBase64 || selectedPdfText; }
            async function sendMessage(forceSend = false, spokenMessage = null) {
                const userMessage = spokenMessage || dom.msgInput.value.trim();
                if (!userMessage && !selectedImageBase64 && !selectedPdfText) return;
                let chatIdToUpdate = currentChatId || createNewChat({});
                const currentChat = state.chats[chatIdToUpdate];
                if (!currentChat) return;
                let modelToUse = getModelForRequest(currentChat.workflow, hasFile());
                const webSearchTriggers = ['busca', 'investiga', 'en internet', 'tiempo real', 'qu√© d√≠a es hoy', 'qu√© fecha es hoy', 'cu√°l es el precio de', 'qui√©n es', 'qu√© es', 'noticias sobre'];
                const requiresWebSearch = webSearchTriggers.some(trigger => userMessage.toLowerCase().startsWith(trigger));
                if (requiresWebSearch && !hasFile() && !currentChat.workflow) { modelToUse = 'sonar'; }
                let cost = COSTS.GENERAL;
                if (currentChat.workflow) { cost = COSTS.COPYWRITING; }
                if (modelToUse === 'sonar') { cost = COSTS.SEARCH; }
                else if (modelToUse.includes('gpt-4') && hasFile()) { cost = COSTS.NEBULA; }
                let count = getCreditCount();
                if (count < cost && !forceSend) {
                    if (currentUser) { showPricingModal(); } 
                    else { showModal({ title: 'Cr√©ditos Agotados', message: `Por favor, inicia sesi√≥n para obtener m√°s cr√©ditos.`, confirmText: 'Iniciar Sesi√≥n' }).then(login => { if (login) netlifyIdentity.open('login'); });}
                    return;
                }
                if(currentChat.title === 'Conversaci√≥n C√≥smica' && userMessage.length > 5) {
                    currentChat.title = userMessage.split(' ').slice(0, 4).join(' ');
                    renderSidebar();
                }
                setCreditCount(count - cost);
                const [image, pdf] = [selectedImageBase64, selectedPdfText];
                currentChat.messages.push({ role: 'user', content: userMessage, image, pdfText: pdf });
                addMessageToUI('user', userMessage, image, currentChat.messages.length - 1);
                const thinkingBubble = addMessageToUI('assistant', '‚Ä¶');
                dom.msgInput.value = ''; dom.msgInput.style.height = 'auto'; clearImageData(); clearPdfData();
                try {
                    const userNameForCall = currentUser ? (currentUser.user_metadata.full_name || currentUser.email) : 'viajero';
                    const responseData = await getAIResponse(userMessage, currentChat.messages.slice(0, -1), image, pdf, modelToUse, currentChat.workflow, userNameForCall);
                    if (responseData.error === 'LIMIT_REACHED') {
                        updateMessageInUI(thinkingBubble, `Has alcanzado el l√≠mite de cr√©ditos de tu plan. ¬°Actualiza para continuar!`);
                        setCreditCount(0); showPricingModal(); return;
                    }
                    if (responseData.reply) {
                        updateCreditCounter();
                        currentChat.messages.push({ role: 'assistant', content: responseData.reply });
                        updateMessageInUI(thinkingBubble, responseData.reply);
                        speak(responseData.reply);
                        saveState();
                    } else if (responseData.error) {
                        updateMessageInUI(thinkingBubble, `‚ùå **Error**<br><small>${responseData.details || 'Error del servidor.'}</small>`);
                        setCreditCount(count);
                    }
                } catch (error) {
                    updateMessageInUI(thinkingBubble, `‚ùå **Error de Conexi√≥n**<br><small>${error.message || 'No se pudo conectar al servidor.'}</small>`);
                    setCreditCount(count);
                }
            }
            async function generateImage() {
                const prompt = await showModal({ title: 'Crear Imagen', message: 'Describe la imagen que quieres crear:', useInput: true, placeholder: 'Ej: Un astronauta en un caballo c√≥smico', confirmText: 'Generar' });
                if (!prompt) { hideModal(); return; }
                hideModal();
                let count = getCreditCount();
                if (count < COSTS.IMAGE) {
                    showModal({ title: 'Cr√©ditos Insuficientes', message: `Necesitas ${COSTS.IMAGE} cr√©ditos para generar una imagen.` });
                    return;
                }
                setCreditCount(count - COSTS.IMAGE);
                let chatIdToUpdate = currentChatId || createNewChat({});
                const currentChat = state.chats[chatIdToUpdate];
                currentChat.messages.push({ role: 'user', content: `Generar imagen: "${prompt}"` });
                addMessageToUI('user', `Generar imagen: "${prompt}"`, null, currentChat.messages.length - 1);
                const thinkingBubble = addMessageToUI('assistant', 'Creando tu visi√≥n con DALL¬∑E 2...');
                try {
                    const response = await fetch('/.netlify/functions/generate-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: 'dall-e-2' })
                    });
                     if (!response.ok) {
                        let errorText;
                        try {
                            const errorData = await response.json();
                            errorText = errorData.error || 'No se pudo generar la imagen.';
                        } catch (e) {
                            errorText = `Error del servidor (${response.status}). Int√©ntalo de nuevo.`;
                        }
                        throw new Error(errorText);
                    }
                    const { imageData } = await response.json();
                    const imageContent = `¬°Aqu√≠ est√° tu creaci√≥n, Jefe/a!`;
                    currentChat.messages.push({ role: 'assistant', content: imageContent, image: imageData });
                    updateMessageInUI(thinkingBubble, imageContent, imageData);
                    saveState();
                } catch (error) {
                    updateMessageInUI(thinkingBubble, `‚ùå **Error al crear la imagen:**<br><small>${error.message}</small>`);
                    setCreditCount(count);
                }
            }
            function toggleSelectMode(active) {
                isSelectModeActive = active;
                dom.selectChatsBtn.classList.toggle('hidden', active);
                dom.deleteModeControls.classList.toggle('hidden', !active);
                if (!active) {
                    chatsToDelete.clear();
                    dom.deleteSelectedBtn.disabled = true;
                }
                renderSidebar();
            }

            function setupEventListeners() {
                // Ensure all buttons exist before attaching listeners
                dom.sendBtn?.addEventListener('click', () => sendMessage());
                dom.msgInput?.addEventListener('keydown', (e) => {¬†
                    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }¬†
                });
                dom.msgInput?.addEventListener('input', () => { dom.msgInput.style.height = 'auto'; dom.msgInput.style.height = (dom.msgInput.scrollHeight) + 'px'; });
                dom.newChatBtn?.addEventListener('click', () => createNewChat());
                dom.newChatIconBtn?.addEventListener('click', () => createNewChat());
                dom.newProjectBtn?.addEventListener('click', async () => { const name = await showModal({ title: 'Crear Proyecto', useInput: true, placeholder: 'Nombre del Proyecto...' }); if (name && name.trim()) { const id = 'project-' + crypto.randomUUID(); state.projects[id] = { id, title: name.trim(), chatIds: [] }; state.structure.unshift(id); saveState(); renderSidebar(); } });
                dom.upgradePlanBtn?.addEventListener('click', showPricingModal);
                dom.closePricingModalBtn?.addEventListener('click', hidePricingModal);
                dom.themeToggle?.addEventListener('click', () => setTheme(!document.body.classList.contains('dark-theme')));
                dom.loginBtn?.addEventListener('click', () => netlifyIdentity.open('login'));
                dom.chatTitleWrapper?.addEventListener('click', () => { if(currentChatId) renameItem('chat', currentChatId); });
                dom.mobileChatTitleWrapper?.addEventListener('click', () => { if(currentChatId) renameItem('chat', currentChatId); });
                dom.imageGenBtn?.addEventListener('click', generateImage);
                dom.imageGenBtnMobile?.addEventListener('click', generateImage);
                dom.pdfUploadBtn?.addEventListener('click', () => dom.pdfUploadInput.click());
                dom.pdfUploadBtnMobile?.addEventListener('click', () => dom.pdfUploadInput.click());
                dom.imageUploadBtn?.addEventListener('click', () => dom.imageUploadInput.click());
                dom.imageUploadBtnMobile?.addEventListener('click', () => dom.imageUploadInput.click());
                
                if (SR && dom.micBtn) {
                    recognition = new SR();¬†
                    recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'es-ES';¬†
                    recognition.onstart = () => {¬† isRecognizing = true; dom.micBtn.classList.add('glowing-mic'); dom.voiceSelectorContainer.classList.remove('hidden'); dom.voiceSelectorContainer.classList.add('flex'); };
                    recognition.onend = () => {¬† isRecognizing = false; dom.micBtn.classList.remove('glowing-mic'); dom.voiceSelectorContainer.classList.add('hidden'); dom.voiceSelectorContainer.classList.remove('flex'); };
                    recognition.onerror = (e) => { console.error("Speech recognition error", e); isRecognizing = false; dom.micBtn.classList.remove('glowing-mic'); };
                    recognition.onresult = (event) => { const transcript = event.results[0][0].transcript; if(transcript) { dom.msgInput.value = transcript; sendMessage(); } };
                    dom.micBtn.addEventListener('click', () => {¬† if(isRecognizing) { recognition.stop(); } else { if (speechSynthesis.speaking) { speechSynthesis.cancel(); } try { recognition.start(); } catch(e) {console.error("Could not start recognition", e)} } });
                } else { dom.micBtn?.style.display = 'none'; }
                
                dom.ttsToggle?.addEventListener('click', () => {
                    speechOn = !speechOn;
                    const icon = dom.ttsToggle.querySelector('i');
                    icon.classList.toggle('fa-volume-high', speechOn);
                    icon.classList.toggle('fa-volume-mute', !speechOn);
                    if (!speechOn) { speechSynthesis.cancel(); }
                });

                dom.modelSelector?.addEventListener('change', () => { updateModelSelectorState(); });
                dom.clearImageBtn?.addEventListener('click', clearImageData);
                dom.clearPdfBtn?.addEventListener('click', clearPdfData);
                dom.imageUploadInput?.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { clearPdfData(); const reader = new FileReader(); reader.onload = (ev) => { selectedImageBase64 = ev.target.result; dom.imagePreview.src = selectedImageBase64; dom.imagePreviewContainer.classList.remove('hidden'); updateModelSelectorState(); }; reader.readAsDataURL(e.target.files[0]); } });
                dom.pdfUploadInput?.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file || file.type !== 'application/pdf') return; clearImageData(); dom.pdfNameEl.textContent = file.name; dom.pdfStatusEl.textContent = 'Leyendo...'; dom.pdfPreviewContainer.classList.remove('hidden'); const reader = new FileReader(); reader.onload = async (ev) => { dom.pdfStatusEl.textContent = 'Procesando...'; try { const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(ev.target.result) }).promise; let text = ''; for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const content = await page.getTextContent(); text += content.items.map(item => item.str).join(' ') + '\n'; } selectedPdfText = text; dom.pdfStatusEl.textContent = `‚úÖ Listo (${pdf.numPages} p√°g.)`; updateModelSelectorState(); } catch (err) { console.error("Error al procesar el PDF:", err); dom.pdfStatusEl.textContent = '‚ùå Error al leer PDF.'; selectedPdfText = null; setTimeout(clearPdfData, 2000); } }; reader.readAsArrayBuffer(file); });
                dom.menuToggle?.addEventListener('click', (e) => { e.stopPropagation(); toggleSidebar(true); });
                dom.sidebarOverlay?.addEventListener('click', () => toggleSidebar(false));
                dom.userMenuBtn?.addEventListener('click', (e) => { e.stopPropagation(); dom.userMenuPopup.classList.toggle('hidden'); });
                dom.logoutBtn?.addEventListener('click', () => { netlifyIdentity.logout(); dom.userMenuPopup.classList.add('hidden');});
                
                const workflowConfigs = {
                    'create-full-post': { title: "Creador de Posts", workflow: 'create-full-post', initialMessages: [{ role: 'assistant', content: '¬°Claro! Vamos a crear un post incre√≠ble. ¬øPara qu√© red social lo necesitas (Instagram, Facebook, LinkedIn, etc.)?' }] },
                    'persuasive-copy': { title: "Redactor de Copys", workflow: 'persuasive-copy', initialMessages: [{ role: 'assistant', content: 'Estoy listo para redactar textos que vendan. ¬øPara qu√© necesitas este copy? (ej: Anuncio de Facebook, Post de Venta, Descripci√≥n de Producto)' }] },
                    'post-ideas': { title: "Lluvia de Ideas", workflow: 'post-ideas', initialMessages: [{ role: 'assistant', content: '¬°Acabemos con el bloqueo creativo! Dime un tema y te dar√© 7 ideas de contenido excelentes.' }] },
                    'brand-strategy': { title: "Estratega de Marca", workflow: 'brand-strategy', initialMessages: [{ role: 'assistant', content: 'Definamos el coraz√≥n de tu marca. ¬øCu√°l es el nombre de tu negocio y a qu√© se dedica?' }] },
                    'competitor-analysis': { title: "An√°lisis de Competencia", workflow: 'competitor-analysis', model: 'sonar', initialMessages: [{ role: 'assistant', content: "Estoy listo para analizar a tu competencia usando el buscador web. Por favor, pega la URL (direcci√≥n web) de la p√°gina que quieres que investigue para entregarte un an√°lisis DAFO simplificado." }] },
                    'buyer-persona': { title: "Creaci√≥n de Cliente Ideal", workflow: 'buyer-persona', initialMessages: [{ role: 'assistant', content: "Vamos a definir a tu cliente ideal (Buyer Persona). Describe tu producto o servicio, y te har√© preguntas para construir el perfil detallado paso a paso." }] },
                    'brand-names': { title: "Nombres para Marca", workflow: 'brand-names', initialMessages: [{ role: 'assistant', content: "¬°Excelente! Busquemos un nombre incre√≠ble. Describe brevemente tu idea de negocio, tu p√∫blico y el estilo que buscas (ej. moderno, cl√°sico, divertido) para generar nombres y slogans." }] },
                    'sales-assistant': { title: "Asistente de Ventas", workflow: 'sales-assistant', initialMessages: [{ role: 'assistant', content: 'Para ayudarte a cerrar esa venta, pega aqu√≠ el mensaje de tu cliente.' }] },
                    'email-writing': { title: "Redactor de Emails", workflow: 'email-writing', initialMessages: [{ role: 'assistant', content: 'Creemos un email que convierta. ¬øCu√°l es el objetivo principal de este correo?' }] },
                    'english-teacher-translate': { title: "English Translator", workflow: 'english-teacher-translate', initialMessages: [{ role: 'assistant', content: 'Of course! Please provide the text you want me to translate or correct.' }] },
                    'english-teacher-vocabulary': { title: "Vocabulary Builder", workflow: 'english-teacher-vocabulary', initialMessages: [{ role: 'assistant', content: 'Excellent! Let\'s learn some new vocabulary. What topic are you interested in? (e.g., "business negotiations", "travel")' }] },
                    'english-teacher-practice': { title: "Conversation Practice", workflow: 'english-teacher-practice', initialMessages: [{ role: 'assistant', content: 'Great! Let\'s practice our conversation. So, tell me about your day.' }] },
                    'design-web': { title: "Dise√±ador Web", workflow: 'design-web', model: 'gpt-4o-mini', initialMessages: [{ role: 'assistant', content: 'Estoy listo para dise√±ar con c√≥digo. Describe la p√°gina o componente que quieres crear, y lo programar√© para ti.' }] },
                    'project-management-dashboard': { /* New workflow for project dashboard */
                        title: "Panel de Proyectos", 
                        workflow: 'project-management-dashboard', 
                        initialMessages: [{ role: 'assistant', content: '¬°Bienvenido al panel de proyectos! Aqu√≠ puedes gestionar tus tareas y proyectos.' }] 
                    }
                };

                document.querySelectorAll('[data-workflow]').forEach(button => {
                    button.addEventListener('click', () => {
                        const workflowKey = button.dataset.workflow;
                        const config = workflowConfigs[workflowKey];
                        if (config) {
                            if (workflowKey === 'project-management-dashboard') {
                                showProjectDashboard();
                            } else {
                                createNewChat({
                                    title: config.title,
                                    workflow: config.workflow,
                                    model: config.model,
                                    initialMessages: config.initialMessages
                                });
                            }
                        }
                    });
                });
                
                dom.workflowsContainer.addEventListener('click', e => { const header = e.target.closest('.workflow-header'); if (header) { const category = header.closest('.workflow-category'); if (category) category.classList.toggle('open'); } });
                dom.webLaunchOfferBtn?.addEventListener('click', () => { const offerTitle = `<i class="fas fa-gift mr-2"></i>Tu Oferta de Lanzamiento Exclusiva`; const offerMessage = `<p class="font-bold mb-2">Al suscribirte a nuestro Plan Pro por $17/mes, desbloqueas:</p><ul class="list-disc list-inside space-y-2 text-left"><li><strong>Acceso Ilimitado a Goatify AI:</strong> Todos los modelos y workflows sin restricciones.</li><li><strong>Construcci√≥n de tu P√°gina Web Profesional:</strong> Nosotros construiremos la primera versi√≥n, ¬°gratis!</li></ul><p class="font-bold mt-4 mb-2">¬øC√≥mo funciona?</p><ol class="list-decimal list-inside space-y-1 text-left"><li><strong>Agenda tu Sesi√≥n Estrat√©gica:</strong> Al confirmar, agenda tu llamada de 20 min.</li><li><strong>Co-creaci√≥n:</b> En la llamada definiremos objetivos y crearemos el borrador con IA.</li><li><strong>Entrega:</strong> Nuestro equipo lo pulir√° y te entregar√° una web de una secci√≥n, lista.</li></ol><p class="text-xs mt-4 italic"><strong>Importante:</strong> La web es tuya para siempre. Para mantenerla online con nuestro hosting, necesitas tu suscripci√≥n Pro activa. Si cancelas, te entregamos el c√≥digo completo.</p>`; showModal({ title: offerTitle, message: offerMessage, confirmText: 'Agendar Sesi√≥n Estrat√©gica' }).then(confirmed => { if (confirmed) { window.open('https://calendly.com/goatify', '_blank'); } }); });
                dom.freeGuidesLink?.addEventListener('click', (e) => { e.preventDefault(); const isPaidUser = currentUser && currentUser.app_metadata?.plan && currentUser.app_metadata.plan !== 'free'; if (isPaidUser) { window.open('https://goatify.app/guiasIA', '_blank'); } else { const title = 'Acceso Exclusivo para Suscriptores'; const message = 'Estas gu√≠as se actualizan semanalmente con estrategias de negocio que te ayudar√°n a crecer un mont√≥n. Son un beneficio exclusivo para nuestros suscriptores. ¬°√önete a un plan para desbloquearlas!'; showModal({ title, message, confirmText: 'Ver Planes' }).then(confirmed => { if (confirmed) { showPricingModal(); } }); } });
                dom.closeHtmlPreviewModalBtn?.addEventListener('click', () => { dom.htmlPreviewModal.classList.add('hidden'); dom.htmlPreviewModal.classList.remove('flex'); });
                dom.voiceSelector?.addEventListener('change', (e) => { selectedVoice = availableVoices.find(voice => voice.name === e.target.value); });
                dom.servicesMenuBtn?.addEventListener('click', (e) => { e.stopPropagation(); const menu = dom.servicesMenu; if (menu.classList.contains('show')) { 
                    menu.classList.remove('show');
                } else { 
                    menu.classList.add('show');
                } });
                // Handle clicks outside modals
                document.addEventListener('click', (e) => { 
                    // Use a common class for modals that should close on outside click
                    const closableModals = [dom.genericModal, dom.pricingModal, dom.settingsModal, dom.calendarModal, dom.dayDetailModal, dom.projectDashboardModal];
                    closableModals.forEach(modal => {
                        if (modal && modal.classList.contains('flex') && !modal.querySelector('.modal-content').contains(e.target)) {
                            // Determine which close function to call
                            if (modal === dom.genericModal) hideModal();
                            else if (modal === dom.pricingModal) hidePricingModal();
                            else if (modal === dom.settingsModal) hideSettingsModal();
                            else if (modal === dom.calendarModal) hideCalendarModal();
                            else if (modal === dom.dayDetailModal) hideDayDetailModal();
                            else if (modal === dom.projectDashboardModal) hideProjectDashboard();
                        }
                    });

                    // Specific handling for services menu (not a true modal, but needs to close)
                    if (dom.servicesMenu && dom.servicesMenu.classList.contains('show') && !dom.servicesMenuBtn.contains(e.target) && !dom.servicesMenu.contains(e.target)) { dom.servicesMenu.classList.remove('show'); } 
                    
                    // Close sidebar on outside click for mobile
                    if (dom.sidebar && window.innerWidth < 768 && dom.sidebar.classList.contains('is-open') && !dom.sidebar.contains(e.target) && !dom.menuToggle.contains(e.target)) { toggleSidebar(false); }
                });
                const setAppHeight = () => { const app = document.getElementById('app-container'); if(app) app.style.height = `${window.innerHeight}px`; };
                setAppHeight();
                window.addEventListener('resize', setAppHeight);
                dom.selectChatsBtn?.addEventListener('click', () => toggleSelectMode(true));
                dom.cancelSelectModeBtn?.addEventListener('click', () => toggleSelectMode(false));
                dom.deleteSelectedBtn?.addEventListener('click', async () => { if (chatsToDelete.size === 0) return; const confirm = await showModal({ title: `Eliminar ${chatsToDelete.size} chat(s)`, message: 'Esta acci√≥n es irreversible. ¬øConfirmas la eliminaci√≥n?', confirmText: 'Eliminar' }); if (confirm) { chatsToDelete.forEach(id => { state.structure = state.structure.filter(i => i !== id); delete state.chats[id]; Object.values(state.projects).forEach(p => { if(p.chatIds) p.chatIds = p.chatIds.filter(cid => cid !== id) }); if (currentChatId === id) resetChatView(); }); saveState(); toggleSelectMode(false); } hideModal(); });

                dom.settingsBtn?.addEventListener('click', showSettingsModal);
                dom.closeSettingsModal?.addEventListener('click', hideSettingsModal);
                dom.settingsUpgradePlanBtn?.addEventListener('click', () => { hideSettingsModal(); showPricingModal(); });
                dom.fontSizeSlider?.addEventListener('input', (e) => {
                    const fontSize = e.target.value;
                    document.body.style.setProperty('--base-font-size', `${fontSize}px`);
                    dom.fontSizeValue.textContent = `${fontSize}px`;
                });
                dom.settingsThemeToggle?.addEventListener('click', () => {
                    setTheme(!document.body.classList.contains('dark-theme'));
                });
                dom.languageSelector?.addEventListener('change', (e) => {
                    setLanguage(e.target.value);
                });
                dom.connectWhatsappBtn?.addEventListener('click', () => {
                    window.open('https://wa.me/17439106116?text=Hola%2C%20me%20gustar%C3%ADa%20conectar%20mi%20cuenta%20de%20Goatify%20AI%20a%20WhatsApp.', '_blank');
                });
                dom.scheduleMeetingBtn?.addEventListener('click', () => { 
                    window.open('https://calendly.com/goatify', '_blank');
                });
                dom.freePlanButton?.addEventListener('click', showPricingModal);

                // Notification Toggle
                dom.notificationToggleBtn?.addEventListener('click', () => {
                    notificationsEnabled = !notificationsEnabled;
                    localStorage.setItem('notificationsEnabled', notificationsEnabled);
                    const lang = localStorage.getItem('goatify-lang') || 'es';
                    dom.notificationToggleText.textContent = notificationsEnabled ? translations[lang].settings_disable_notifications : translations[lang].settings_enable_notifications;
                    if (notificationsEnabled && Notification.permission !== "granted" && Notification.permission !== "denied") {
                        Notification.requestPermission();
                    }
                });


                // Calendar event listeners
                dom.calendarBtn?.addEventListener('click', showCalendarModal);
                dom.closeCalendarModal?.addEventListener('click', hideCalendarModal);
                
                dom.prevMonthBtn?.addEventListener('click', () => {
                    currentMonth = currentMonth.subtract(1, 'month');
                    renderCalendarView(); 
                });
                dom.nextMonthBtn?.addEventListener('click', () => {
                    currentMonth = currentMonth.add(1, 'month');
                    renderCalendarView(); 
                });

                dom.prevWeekBtn?.addEventListener('click', () => {
                    currentWeek = currentWeek.subtract(1, 'week');
                    renderCalendarView();
                });
                dom.nextWeekBtn?.addEventListener('click', () => {
                    currentWeek = currentWeek.add(1, 'week');
                    renderCalendarView();
                });

                dom.monthViewBtn?.addEventListener('click', () => { /* Added null check */
                    currentCalendarView = 'month';
                    dom.monthViewBtn.classList.add('active');
                    dom.weekViewBtn.classList.remove('active');
                    renderCalendarView();
                });
                dom.weekViewBtn?.addEventListener('click', () => { /* Added null check */
                    currentCalendarView = 'week';
                    dom.monthViewBtn.classList.remove('active');
                    dom.weekViewBtn.classList.add('active');
                    renderCalendarView();
                });

                dom.addTaskBtn?.addEventListener('click', addTask);
                dom.newTaskInput?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addTask();
                    }
                });

                dom.closeDayDetailModal?.addEventListener('click', hideDayDetailModal);

                // Project Dashboard Listeners
                dom.addProjectTaskBtn?.addEventListener('click', addProjectTask);
                dom.closeProjectDashboardModal?.addEventListener('click', hideProjectDashboard);
            }
            
            let initFired = false;

            const finishInitialization = (user) => {
                if (initFired) {
                    console.warn("finishInitialization called multiple times. Ignoring subsequent calls.");
                    return;
                }
                initFired = true;
                currentUser = user;
                console.log("Netlify Identity Initialization FINISHED. User:", user ? user.email : "guest (null)");

                updateUserUI();
                loadStateForUser(); 
                populateVoiceList();
                setupEventListeners();
                updateContextualFooter(null);

                dom.appContainer.classList.remove('opacity-0');
                dom.loadingOverlay.style.display = 'none';

                if (currentChatId && state.chats[currentChatId]) {
                    selectChat(currentChatId); 
                } else {
                    resetChatView();
                }
                updateNotificationBadge(); 
            };

            const savedLang = localStorage.getItem('goatify-lang') || 'es';
            setLanguage(savedLang);

            notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true'; // Re-initialize from localStorage
            if (dom.notificationToggleText) {
                dom.notificationToggleText.textContent = notificationsEnabled ? translations[savedLang].settings_disable_notifications : translations[savedLang].settings_enable_notifications;
            }


            setTheme(localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches));

            const unlockAudio = () => {
                const silence = new SpeechSynthesisUtterance('');
                silence.volume = 0;
                window.speechSynthesis.speak(silence);
                document.body.removeEventListener('touchstart', unlockAudio);
                document.body.addEventListener('click', unlockAudio); 
            };
            document.body.addEventListener('touchstart', unlockAudio, { once: true });
            document.body.addEventListener('click', unlockAudio, { once: true });
            
            netlifyIdentity.on('init', (user) => {
                console.log("Netlify Identity 'init' event fired by widget.");
                finishInitialization(user);
            });

            netlifyIdentity.on('login', (user) => {
                console.log("Netlify Identity 'login' event fired.");
                netlifyIdentity.close(); 
                currentUser = user;
                updateUserUI(); 
                loadStateForUser();
            });

            netlifyIdentity.on('logout', () => {
                console.log("Netlify Identity 'logout' event fired.");
                currentUser = null;
                updateUserUI(); 
                loadStateForUser(); 
                resetChatView();
            });

            netlifyIdentity.on('error', (err) => {
                console.error("Netlify Identity Error:", err);
                if (!initFired) {
                    console.warn("Netlify Identity failed, attempting to proceed as guest.");
                    finishInitialization(null); 
                }
            });

            // Ensure Netlify Identity is initialized
            console.log("Attempting initial netlifyIdentity.init() call.");
            netlifyIdentity.init();

            // Fallback timeout to ensure app starts even if Identity events don't fire
            setTimeout(() => {
                if (!initFired) {
                    console.warn("Netlify Identity 'init' event did not fire within timeout. Forcing app initialization.");
                    finishInitialization(netlifyIdentity.currentUser());
                }
            }, 1000); // 1 second timeout
        });
    </script>
</body>
</html>
