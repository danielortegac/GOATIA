<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Goatify AI</title>
    <link rel="icon" type="image/png" href="./favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
    </script>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <style>
        :root {
            --bg-dark: #121212; --bg-medium: #1e1e1e; --bg-light: #2c2c2c; --primary: #8a4fff; --primary-hover: #7b46e6; --text-light: #e0e0e0; --text-medium: #b3b3b3; --border-color: #3a3a3a;
            --light-bg-dark: #f7f7f8; --light-bg-medium: #ffffff; --light-bg-light: #f0f0f0; --light-primary: #7c40e6; --light-primary-hover: #6a37d3; --light-text-dark: #1f2937; --light-text-medium: #6b7280; --light-border-color: #e5e7eb;
        }
        html, body { height: 100%; width: 100%; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; transition: background-color: 0.3s ease, color: 0.3s ease; font-size: 16px; }
        .dark-theme { --current-bg-dark: var(--bg-dark); --current-bg-medium: var(--bg-medium); --current-bg-light: var(--bg-light); --current-primary: var(--primary); --current-primary-hover: var(--primary-hover); --current-text-light: var(--text-light); --current-text-medium: var(--text-medium); --current-border-color: var(--border-color); background-color: var(--current-bg-dark); color: var(--text-light); }
        .light-theme { --current-bg-dark: var(--light-bg-dark); --current-bg-medium: var(--light-bg-medium); --current-bg-light: var(--light-bg-light); --current-primary: var(--light-primary); --current-primary-hover: var(--light-primary-hover); --current-text-light: var(--light-text-dark); --current-text-medium: var(--light-text-medium); --current-border-color: var(--light-border-color); background-color: var(--light-bg-dark); color: var(--light-text-dark); }
        #sidebar { background-color: var(--current-bg-dark); border-right: 1px solid var(--current-border-color); }
        #main-chat-area, .modal-content { background-color: var(--current-bg-medium); }
        .chat-bubble-bot, .bg-input, .chat-item, #user-menu-popup { background-color: var(--current-bg-light); }
        .border-themed { border-color: var(--current-border-color); }
        .chat-bubble-user { background-color: var(--current-primary); color: white; }
        .btn-primary { background-color: var(--current-primary); color: white; }
        .btn-primary:hover { background-color: var(--current-primary-hover); }
        .placeholder-themed::placeholder { color: var(--current-text-medium); }
        .text-primary { color: var(--current-primary); }
        .glowing-mic { animation: pulse 1.5s infinite; color: var(--primary) !important; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(138, 79, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0); } }
        #sidebar.is-open { transform: translateX(0); }
        #app-container { height: 100vh; height: -webkit-fill-available; }
        /* Estilos para el nuevo menú de soluciones */
        #services-menu {
            background-color: #252525; /* Un color un poco más claro que el fondo para destacar */
            border: 1px solid var(--current-border-color);
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            padding: 1rem;
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none;
        }
        #services-menu.is-open {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }
        .light-theme #services-menu {
             background-color: #ffffff;
        }
    </style>
</head>
<body class="w-screen overflow-x-hidden dark-theme">

    <div id="loading-overlay" class="fixed inset-0 bg-bg-dark bg-opacity-95 flex flex-col items-center justify-center z-[100]"><img src="./logo-goatify-header.png" alt="Goatify Logo" class="w-24 h-24 object-contain mb-6 animate-pulse"><div class="text-text-light text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-3 text-lg font-semibold">Inicializando...</p></div></div>
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden opacity-0 pointer-events-none"></div>

    <div id="app-container" class="flex w-full relative opacity-0 transition-opacity duration-300">
        <aside id="sidebar" class="w-72 flex-shrink-0 flex flex-col p-3 transition-transform duration-300 -translate-x-full md:translate-x-0 absolute md:relative z-30 h-full">
            <div class="flex-shrink-0"><div id="logo-space" class="w-24 h-24 rounded-lg mx-auto mb-4 flex items-center justify-center overflow-hidden bg-input"><img src="./logo-goatify-header.png" alt="Goatify Logo" class="w-full h-full object-contain"></div><div class="flex flex-col space-y-2 mb-4"><button id="new-chat-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-plus mr-2"></i><span>Nuevo Chat</span></button><button id="upgrade-plan-btn" class="hidden flex items-center justify-center font-semibold p-3 rounded-lg bg-yellow-500 text-black hover:bg-yellow-400"><i class="fas fa-rocket mr-2"></i><span>Mejorar Plan</span></button></div></div>
            <div class="flex-grow overflow-y-auto min-h-0"><div class="border-t border-b border-themed my-3 py-3"><h3 class="text-xs font-semibold uppercase text-text-medium px-2 mb-2">Workflows</h3><div class="space-y-1"><button id="copywriting-workflow-btn" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center"><i class="fas fa-pencil-alt w-6 mr-2"></i>Copywriting</button><button id="sales-response-workflow-btn" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center"><i class="fas fa-handshake w-6 mr-2"></i>Respuestas de Ventas</button><button id="design-web-workflow-btn" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center"><i class="fas fa-code w-6 mr-2"></i>Diseño Web</button><button id="image-gen-workflow-btn" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center"><i class="fas fa-paint-brush w-6 mr-2"></i>Crear Imagen</button></div></div><div id="sidebar-content" class="pr-1 space-y-1"></div></div>
            <div id="user-section" class="flex-shrink-0 border-t border-themed mt-2 pt-3"><div id="login-view" class="hidden"><button id="login-btn" class="w-full flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-sign-in-alt mr-2"></i><span>Iniciar Sesión</span></button></div><div id="user-menu-view" class="hidden relative"><button id="user-menu-btn" class="w-full flex items-center text-left p-2 rounded-lg hover:bg-light transition-colors"><span id="user-email" class="flex-grow truncate text-sm font-semibold"></span><i class="fas fa-ellipsis-h"></i></button><div id="user-menu-popup" class="absolute bottom-full left-0 w-full mb-2 rounded-lg p-2 bg-light border border-themed shadow-lg hidden"><button id="logout-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-sign-out-alt w-6 mr-2"></i>Cerrar Sesión</button></div></div></div>
        </aside>

        <main id="main-chat-area" class="flex-1 flex flex-col h-full overflow-hidden">
           <header class="flex items-center justify-between p-2 md:p-4 border-b border-themed flex-shrink-0 relative">
                <button id="menu-toggle" class="md:hidden text-xl p-2"><i class="fas fa-bars"></i></button>
                <h1 id="chat-title" class="text-lg font-semibold truncate cursor-pointer mx-2 flex-1 min-w-0" title="Renombrar Chat">Goatify AI</h1>
                <div class="flex items-center space-x-2 sm:space-x-3 flex-shrink-0">
                    <button id="services-menu-btn" title="Potenciar mi Negocio" class="flex items-center space-x-2 text-md p-2 hover:text-primary transition-colors rounded-lg hover:bg-light">
                        <i class="fas fa-rocket"></i>
                        <span class="hidden sm:inline font-semibold">Soluciones</span>
                    </button>
                    <div id="message-counter" class="text-xs font-mono whitespace-nowrap"></div>
                    <button id="theme-toggle" title="Cambiar Tema" class="text-xl p-2"><i class="fas fa-moon" id="theme-icon"></i></button>
                </div>
                <div id="services-menu" class="hidden absolute top-full right-4 mt-2 w-80 z-20">
                    <div class="border-b border-themed pb-3 mb-3">
                        <h4 class="font-bold text-md text-text-light">En Goatify te ayudamos a escalar.</h4>
                        <p class="text-sm text-text-medium mt-1">Somos la única IA con soporte de expertos reales para tus proyectos.</p>
                    </div>
                    <ul class="space-y-1">
                        <li><a href="https://www.goatify.app/diseno-web" target="_blank" class="block p-2 rounded-lg hover:bg-medium transition-colors"><strong class="font-semibold text-text-light">¿Necesito una Web que Venda?</strong><p class="text-xs text-text-medium">Diseño Web Profesional y Tiendas Online.</p></a></li>
                        <li><a href="https://www.goatify.app/automatizacion" target="_blank" class="block p-2 rounded-lg hover:bg-medium transition-colors"><strong class="font-semibold text-text-light">¿Cómo Vendo en Automático?</strong><p class="text-xs text-text-medium">Automatización de Ventas y Procesos.</p></a></li>
                        <li><a href="https://www.goatify.app/redes-sociales" target="_blank" class="block p-2 rounded-lg hover:bg-medium transition-colors"><strong class="font-semibold text-text-light">¿Cómo Destaco en Redes Sociales?</strong><p class="text-xs text-text-medium">Avatares con IA y Estrategia de Contenidos.</p></a></li>
                        <li><a href="https://www.goatify.app/consultoria" target="_blank" class="block p-2 rounded-lg hover:bg-medium transition-colors"><strong class="font-semibold text-text-light">¿Cómo Escalo mi Empresa con IA?</strong><p class="text-xs text-text-medium">Consultoría Empresarial y de Inteligencia Artificial.</p></a></li>
                    </ul>
                </div>
           </header>
           <div id="chat-messages" class="flex-1 overflow-y-auto p-3 sm:p-6">
                <div class="flex justify-center items-center h-full" id="initial-message-container">
                    <div id="welcome-message-wrapper" class="text-center text-text-medium">
                        <img src="./logo-goatify-header.png" alt="Goatify Logo" class="w-24 h-24 object-contain mx-auto mb-4">
                        <h2 class="text-3xl font-bold text-text-light">Goatify AI</h2>
                        <div id="personalized-welcome" class="hidden"><p class="text-lg mt-1">¡Hola, <span id="user-name"></span>! Hoy es un gran día para crear algo increíble.</p></div>
                        <div id="generic-welcome" class="hidden"><p class="text-xl">¿Cómo puedo ayudarte hoy?</p></div>
                    </div>
                </div>
            </div>
            <div id="input-area" class="p-2 sm:p-4 border-t border-themed flex-shrink-0">
                <div id="file-preview-area" class="mb-3 space-y-2 px-1 sm:px-0"></div>
                <div class="flex items-center space-x-3 mb-2 px-1 sm:px-2">
                    <label for="model-selector" class="font-medium text-sm text-text-medium">Modelo:</label>
                    <select id="model-selector" class="rounded-md p-1.5 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm bg-input text-text-light border border-themed">
                        <option value="gpt-3.5-turbo-1106">Chat General (Turbo)</option>
                        <option value="sonar">Búsqueda Web (Sonar)</option>
                    </select>
                    <div id="voice-controls" class="flex items-center space-x-2 ml-auto">
                        <button id="voice-btn" title="Hablar" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-microphone text-xl"></i></button>
                        <select id="voice-selector" class="hidden rounded-md p-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-purple-500 bg-light text-text-light border border-themed"></select>
                    </div>
                </div>
                <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2">
                    <input type="file" id="pdf-upload" accept=".pdf,application/pdf" class="hidden">
                    <input type="file" id="image-upload" accept="image/*" class="hidden">
                    <button id="pdf-upload-btn" title="Subir PDF" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-file-pdf text-xl"></i></button>
                    <button id="image-upload-btn" title="Subir Imagen" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-image text-xl"></i></button>
                    <textarea id="msg" placeholder="Escribe un mensaje..." class="flex-1 bg-transparent p-2 h-12 resize-none outline-none placeholder-themed" rows="1"></textarea>
                    <button id="send-btn" title="Enviar" class="p-2 sm:p-4 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i id="send-icon" class="fa fa-paper-plane text-xl"></i></button>
                </div>
            </div>
        </main>
    </div>

    <a id="whatsapp-fab" href="https://wa.me/17439106116?text=w40887983" target="_blank" title="Hablar con un Estratega de Goatify"
       class="fixed bottom-6 right-6 w-16 h-16 bg-green-500 rounded-full flex items-center justify-center text-white shadow-lg hover:bg-green-600 transition-transform hover:scale-110 z-20">
        <i class="fab fa-whatsapp fa-2x"></i>
    </a>
    
    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4"><div class="modal-content rounded-lg w-full max-w-sm p-6 relative"><h3 id="modal-title" class="text-lg font-bold mb-4"></h3><p id="modal-message" class="mb-4 text-text-medium"></p><input type="text" id="modal-input" class="w-full p-2 rounded mb-4 hidden bg-input border border-themed" placeholder=""><div class="flex justify-end space-x-2"><button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded">Cancelar</button><button id="modal-confirm" class="px-4 py-2 rounded text-white btn-primary">Confirmar</button></div></div></div>
    <div id="html-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4"><div class="modal-content rounded-2xl w-full h-full max-w-4xl p-2 md:p-4 relative flex flex-col"><div class="flex-shrink-0 flex items-center justify-between mb-2"><h3 class="text-lg font-bold">Vista Previa</h3><button id="close-html-preview-modal" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button></div><iframe id="html-preview-iframe" class="w-full flex-grow h-full border-2 border-themed rounded-lg bg-white"></iframe></div></div>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        window.addEventListener('DOMContentLoaded', () => {
            let state = { chats: {}, structure: [] };
            let currentChatId = null, currentUser = null, isRecognizing = false;
            let selectedImageBase64 = null, selectedPdfText = null;
            let modalResolve = null;
            let availableVoices = [], selectedVoice = null;

            const dom = {
                appContainer: document.getElementById('app-container'), msgInput: document.getElementById('msg'), sendBtn: document.getElementById('send-btn'),
                messageCounterEl: document.getElementById('message-counter'), newChatBtn: document.getElementById('new-chat-btn'),
                genericModal: document.getElementById('generic-modal'), chatMessages: document.getElementById('chat-messages'),
                chatTitle: document.getElementById('chat-title'), initialMessageContainer: document.getElementById('initial-message-container'),
                themeToggle: document.getElementById('theme-toggle'), themeIcon: document.getElementById('theme-icon'),
                modelSelector: document.getElementById('model-selector'), imageUploadBtn: document.getElementById('image-upload-btn'),
                imageUploadInput: document.getElementById('image-upload'), pdfUploadBtn: document.getElementById('pdf-upload-btn'),
                pdfUploadInput: document.getElementById('pdf-upload'), filePreviewArea: document.getElementById('file-preview-area'),
                sidebar: document.getElementById('sidebar'), menuToggle: document.getElementById('menu-toggle'),
                sidebarOverlay: document.getElementById('sidebar-overlay'), sidebarContent: document.getElementById('sidebar-content'),
                loginView: document.getElementById('login-view'), userMenuView: document.getElementById('user-menu-view'),
                loginBtn: document.getElementById('login-btn'), userMenuBtn: document.getElementById('user-menu-btn'),
                userMenuPopup: document.getElementById('user-menu-popup'), userEmail: document.getElementById('user-email'),
                logoutBtn: document.getElementById('logout-btn'), copywritingWorkflowBtn: document.getElementById('copywriting-workflow-btn'),
                salesResponseWorkflowBtn: document.getElementById('sales-response-workflow-btn'), designWebWorkflowBtn: document.getElementById('design-web-workflow-btn'),
                imageGenWorkflowBtn: document.getElementById('image-gen-workflow-btn'), personalizedWelcome: document.getElementById('personalized-welcome'),
                userName: document.getElementById('user-name'), loadingOverlay: document.getElementById('loading-overlay'),
                htmlPreviewModal: document.getElementById('html-preview-modal'), closeHtmlPreviewModalBtn: document.getElementById('close-html-preview-modal'),
                htmlPreviewIframe: document.getElementById('html-preview-iframe'), servicesMenuBtn: document.getElementById('services-menu-btn'),
                servicesMenu: document.getElementById('services-menu'), whatsappFab: document.getElementById('whatsapp-fab'),
                voiceBtn: document.getElementById('voice-btn'), voiceSelector: document.getElementById('voice-selector'),
                upgradePlanBtn: document.getElementById('upgrade-plan-btn'),
            };
            
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            function showModal({ title, message, useInput = false, placeholder = '', confirmText = 'Confirmar' }) {
                const modalTitle = dom.genericModal.querySelector('#modal-title'), modalMessage = dom.genericModal.querySelector('#modal-message'), modalInput = dom.genericModal.querySelector('#modal-input'), modalConfirm = dom.genericModal.querySelector('#modal-confirm');
                modalTitle.textContent = title; modalMessage.textContent = message; modalMessage.style.display = message ? 'block' : 'none'; modalInput.style.display = useInput ? 'block' : 'none'; modalInput.value = ''; modalInput.placeholder = placeholder; modalConfirm.textContent = confirmText;
                dom.genericModal.classList.remove('hidden'); dom.genericModal.classList.add('flex');
                if (useInput) modalInput.focus();
                return new Promise(resolve => { modalResolve = resolve; });
            }
            function hideModal(resolveWith = null) { if(modalResolve) { modalResolve(resolveWith); modalResolve = null; } dom.genericModal.classList.add('hidden'); dom.genericModal.classList.remove('flex');  }

            function getModelForRequest(hasFile, currentWorkflow) {
                if (hasFile) return "gpt-4o-mini";
                if (currentWorkflow === 'design-web') return "gpt-4o";
                return dom.modelSelector.value;
            }

            async function getAIResponse(prompt, history, image, pdf, model, workflow, userName) {
                const name = (userName || '').split(' ')[0], title = (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) ? 'Jefa' : 'Jefe';
                const body = { prompt, history, model, imageData: image, pdfText: pdf, workflow, userName: name, title };
                const response = await fetch('/.netlify/functions/get-ai-response', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({details: 'Error desconocido'}));
                    throw new Error(errorData.details || `Error del servidor: ${response.status}.`);
                }
                return await response.json();
            }

            async function loadStateForUser() {
                if (!currentUser) {
                    const saved = localStorage.getItem('guestState');
                    if(saved) { const parsed = JSON.parse(saved); state = parsed.state || {}; currentChatId = parsed.currentChatId; }
                } else {
                    try {
                        const response = await fetch('/.netlify/functions/load-chats', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: currentUser.id }) });
                        if (!response.ok) throw new Error(`Server error`);
                        const dbState = await response.json();
                        state = dbState.state || { chats: {}, structure: [] }; currentChatId = dbState.currentChatId;
                    } catch (error) {
                        console.error("Could not load from DB:", error);
                        state = { chats: {}, structure: [] }; currentChatId = null;
                    }
                }
                renderSidebar();
                selectChat(currentChatId);
            }

            async function saveState() {
                if (!currentUser) {
                    try { localStorage.setItem('guestState', JSON.stringify({ state, currentChatId })); } catch(e) { console.error("Guest storage full:", e); }
                    return;
                }
                try {
                    await fetch('/.netlify/functions/save-chats', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: currentUser.id, stateToSave: { state, currentChatId } }) });
                } catch (error) { console.error("Failed to save state to DB:", error); }
            }
            
            function createSubtleUpsell(workflow) {
                let upsellHTML = '';
                const whatsappLink = `<a href="${dom.whatsappFab.href}" target="_blank" class="font-bold hover:text-primary transition-colors">habla con un estratega</a>`;
                switch(workflow) {
                    case 'design-web':
                        upsellHTML = `Este es un excelente punto de partida. Cuando estés listo para un diseño conectado a un sistema que capture clientes, ${whatsappLink}. Hacemos que las webs trabajen para ti.`;
                        break;
                    case 'copywriting':
                         upsellHTML = `Espero que este texto te sirva. Si alguna vez necesitas una estrategia de contenido completa para tus redes, recuerda que en Goatify podemos ayudarte a planificarla.`;
                        break;
                    case 'sales-response':
                        upsellHTML = `Esta es una respuesta sólida. Si quieres implementar un sistema que gestione y automatice tus ventas, ${whatsappLink}.`;
                        break;
                }
                if (upsellHTML) {
                    const upsellDiv = document.createElement('div');
                    upsellDiv.className = 'mt-3 pt-3 border-t border-themed text-xs text-text-medium';
                    upsellDiv.innerHTML = upsellHTML;
                    return upsellDiv;
                }
                return null;
            }

            function addMessageToUI(role, content, imageSrc) {
                const wrapper = document.createElement('div');
                wrapper.className = `chat-bubble-wrapper flex items-start gap-2 my-2 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                const bubble = document.createElement('div');
                bubble.className = `p-3 md:p-4 rounded-xl max-w-lg md:max-w-xl ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot'}`;
                if (imageSrc) { const img = document.createElement('img'); img.src = imageSrc; img.className = 'rounded-lg mb-2 max-w-full h-auto'; bubble.appendChild(img); }
                const contentDiv = document.createElement('div');
                contentDiv.className = 'markdown-content';
                contentDiv.innerHTML = content === '…' ? `<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .2s;"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .4s;"></div></div>` : marked.parse(content || "");
                bubble.appendChild(contentDiv);
                const currentChat = state.chats[currentChatId];
                if(role === 'assistant' && currentChat?.workflow) { const upsellElement = createSubtleUpsell(currentChat.workflow); if (upsellElement) bubble.appendChild(upsellElement); }
                wrapper.appendChild(bubble);
                dom.chatMessages.appendChild(wrapper);
                dom.chatMessages.scrollTop = dom.chatMessages.scrollHeight;
                return bubble;
            }
            
            function updateMessageInUI(bubble, content, imageSrc) { if (bubble && bubble.parentElement) { const newBubble = addMessageToUI('assistant', content, imageSrc); bubble.parentElement.replaceWith(newBubble.parentElement); } }
            function renderSidebar() { dom.sidebarContent.innerHTML = ''; const frag = document.createDocumentFragment(); if (Array.isArray(state.structure)) { state.structure.forEach(id => { if (id.startsWith('chat-')) frag.appendChild(createChatItemElement(id)); }); } dom.sidebarContent.appendChild(frag); updateActiveChatHighlight(); }
            function createChatItemElement(id) { const chat = state.chats[id]; if (!chat) return document.createDocumentFragment(); const item = document.createElement('div'); item.className = 'chat-item group flex items-center justify-between p-2 rounded-md cursor-pointer'; item.dataset.id = id; item.innerHTML = `<i class="far fa-comment-dots mr-2"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span><div class="opacity-0 group-hover:opacity-100 transition-opacity"><button class="delete-btn text-text-medium hover:text-red-500 p-1"><i class="fas fa-trash-alt fa-xs"></i></button></div>`; item.addEventListener('click', e => { if (!e.target.closest('.delete-btn')) selectChat(id); }); item.querySelector('.delete-btn').addEventListener('click', () => deleteItem(id)); return item; }
            function updateActiveChatHighlight() { document.querySelectorAll('.chat-item').forEach(item => { item.style.backgroundColor = item.dataset.id === currentChatId ? 'var(--current-primary)' : ''; }); }
            async function deleteItem(id) { const item = state.chats[id]; if (!item) return; const conf = await showModal({ title: `Eliminar ${item.title}?`, message: 'Esta acción no se puede deshacer.', confirmText: 'Eliminar' }); if (conf) { state.structure = state.structure.filter(i => i !== id); delete state.chats[id]; if(currentChatId === id) resetChatView(); await saveState(); renderSidebar(); } hideModal(); }
            function createNewChat(options = {}) { const id = 'chat-' + crypto.randomUUID(), name = currentUser ? (currentUser.user_metadata.full_name?.split(' ')[0] || 'Tú') : 'viajero'; const initialMessages = [{ role: 'assistant', content: `Saludos, ${name}. Soy Goatify AI. ¿En qué te puedo ayudar a escalar hoy?` }]; state.chats[id] = { id, title: options.title || "Nueva Conversación", messages: initialMessages, workflow: options.workflow || null }; if (!Array.isArray(state.structure)) state.structure = []; state.structure.unshift(id); selectChat(id); return id; }
            function selectChat(chatId) { if (!chatId || !state.chats[chatId]) { resetChatView(); return; } currentChatId = chatId; dom.initialMessageContainer.style.display = 'none'; dom.chatMessages.innerHTML = ''; const chat = state.chats[chatId]; dom.chatTitle.textContent = chat.title; chat.messages.forEach(msg => addMessageToUI(msg.role, msg.content, msg.image)); updateActiveChatHighlight(); if (window.innerWidth < 768) toggleSidebar(false); }
            function resetChatView() { currentChatId = null; dom.chatTitle.textContent = "Goatify AI"; dom.chatMessages.innerHTML = ''; dom.initialMessageContainer.style.display = 'flex'; updateActiveChatHighlight(); dom.modelSelector.value = 'gpt-3.5-turbo-1106'; }
            function clearFilePreviews() { dom.filePreviewArea.innerHTML = ''; selectedImageBase64 = null; selectedPdfText = null; dom.imageUploadInput.value = ''; dom.pdfUploadInput.value = ''; }
            async function sendMessage() {
                const userMessage = dom.msgInput.value.trim();
                if (!userMessage && !selectedImageBase64 && !selectedPdfText) return;
                let chatIdToUpdate = currentChatId; if (!chatIdToUpdate) { chatIdToUpdate = createNewChat(); }
                const currentChat = state.chats[chatIdToUpdate];
                const modelToUse = getModelForRequest(hasFile(), currentChat.workflow);
                if(currentChat.title === 'Nueva Conversación' && userMessage.length > 5) { currentChat.title = userMessage.split(' ').slice(0, 4).join(' '); renderSidebar(); }
                const [image, pdf] = [selectedImageBase64, selectedPdfText];
                currentChat.messages.push({ role: 'user', content: userMessage, image });
                addMessageToUI('user', userMessage, image);
                const thinkingBubble = addMessageToUI('assistant', '…');
                dom.msgInput.value = ''; clearFilePreviews();
                try {
                    const userNameForCall = currentUser ? currentUser.user_metadata.full_name : 'viajero';
                    const responseData = await getAIResponse(userMessage, currentChat.messages.slice(0, -1), image, pdf, modelToUse, currentChat.workflow, userNameForCall);
                    currentChat.messages.push({ role: 'assistant', content: responseData.reply });
                    updateMessageInUI(thinkingBubble, responseData.reply);
                    saveState();
                } catch (error) { updateMessageInUI(thinkingBubble, `❌ **Error de Conexión**<br><small>${error.message || 'No se pudo conectar.'}</small>`); }
            }
            async function generateImage() {
                const prompt = await showModal({ title: 'Crear Imagen', message: 'Describe la imagen que quieres crear:', useInput: true, placeholder: 'Ej: Un gato con botas en un tejado', confirmText: 'Generar' });
                if (!prompt) { hideModal(); return; }
                hideModal();
                const chatIdToUpdate = createNewChat({ title: `Imagen: ${prompt.substring(0, 20)}...` });
                const currentChat = state.chats[chatIdToUpdate];
                currentChat.messages.push({ role: 'user', content: `Generar imagen: "${prompt}"` });
                addMessageToUI('user', `Generar imagen: "${prompt}"`);
                const thinkingBubble = addMessageToUI('assistant', '…');
                try {
                    const response = await fetch('/.netlify/functions/generate-image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt }) });
                    if (!response.ok) { const errorData = await response.json().catch(() => ({})); throw new Error(errorData.error || 'No se pudo generar la imagen.'); }
                    const { imageData } = await response.json();
                    const imageContent = `¡Aquí está tu creación!`;
                    currentChat.messages.push({ role: 'assistant', content: imageContent, image: imageData });
                    updateMessageInUI(thinkingBubble, imageContent, imageData);
                    saveState();
                } catch (error) { updateMessageInUI(thinkingBubble, `❌ **Error al crear la imagen:**<br><small>${error.message}</small>`); }
            }
            function hasFile() { return selectedImageBase64 || selectedPdfText; }
            function setTheme(isDark) { document.body.className = 'w-screen overflow-x-hidden'; document.body.classList.add(isDark ? 'dark-theme' : 'light-theme'); dom.themeIcon.className = `fas fa-${isDark ? 'sun' : 'moon'}`; localStorage.setItem('theme', isDark ? 'dark' : 'light'); }
            function toggleSidebar(show) { if (show) { dom.sidebar.classList.add('is-open'); dom.sidebarOverlay.classList.remove('pointer-events-none','opacity-0'); } else { dom.sidebar.classList.remove('is-open'); dom.sidebarOverlay.classList.add('pointer-events-none','opacity-0'); } }
            function setupEventListeners() {
                dom.sendBtn.addEventListener('click', sendMessage);
                dom.msgInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
                dom.newChatBtn.addEventListener('click', () => createNewChat());
                dom.themeToggle.addEventListener('click', () => setTheme(!document.body.classList.contains('dark-theme')));
                dom.menuToggle.addEventListener('click', (e) => { e.stopPropagation(); toggleSidebar(true); });
                dom.sidebarOverlay.addEventListener('click', () => toggleSidebar(false));
                dom.servicesMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); dom.servicesMenu.classList.toggle('is-open'); dom.servicesMenu.classList.toggle('hidden'); });
                dom.loginBtn.addEventListener('click', () => netlifyIdentity.open('login'));
                dom.logoutBtn.addEventListener('click', () => netlifyIdentity.logout());
                dom.userMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); dom.userMenuPopup.classList.toggle('hidden'); });
                dom.copywritingWorkflowBtn.addEventListener('click', () => createNewChat({ title: "Nuevo Copy", workflow: "copywriting" }));
                dom.salesResponseWorkflowBtn.addEventListener('click', () => createNewChat({ title: "Respuesta de Venta", workflow: "sales-response" }));
                dom.designWebWorkflowBtn.addEventListener('click', () => createNewChat({ title: "Nuevo Diseño Web", workflow: "design-web" }));
                dom.imageGenWorkflowBtn.addEventListener('click', generateImage);
                dom.imageUploadBtn.addEventListener('click', () => dom.imageUploadInput.click());
                dom.pdfUploadBtn.addEventListener('click', () => dom.pdfUploadInput.click());
                dom.imageUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'image'));
                dom.pdfUploadInput.addEventListener('change', (e) => handleFileUpload(e, 'pdf'));
                
                if (SR && dom.voiceBtn) {
                    recognition = new SR();
                    recognition.continuous = false; recognition.lang = 'es-ES';
                    recognition.onstart = () => { isRecognizing = true; dom.voiceBtn.classList.add('glowing-mic'); dom.voiceSelector.classList.remove('hidden'); };
                    recognition.onend = () => { isRecognizing = false; dom.voiceBtn.classList.remove('glowing-mic'); dom.voiceSelector.classList.add('hidden'); };
                    recognition.onerror = (e) => { console.error("Speech recognition error", e); isRecognizing = false; };
                    recognition.onresult = (e) => { dom.msgInput.value = e.results[0][0].transcript; sendMessage(); };
                    dom.voiceBtn.addEventListener('click', () => { isRecognizing ? recognition.stop() : recognition.start(); });
                    dom.voiceSelector.addEventListener('change', (e) => { selectedVoice = availableVoices.find(v => v.name === e.target.value); });
                } else { if (dom.voiceBtn) dom.voiceBtn.style.display = 'none'; }
                document.addEventListener('click', (e) => {
                    if (dom.servicesMenu && !dom.servicesMenu.classList.contains('hidden') && !dom.servicesMenuBtn.contains(e.target) && !e.target.closest('#services-menu')) { dom.servicesMenu.classList.remove('is-open'); dom.servicesMenu.classList.add('hidden'); }
                    if (dom.userMenuPopup && !dom.userMenuPopup.classList.contains('hidden') && !dom.userMenuBtn.contains(e.target)) { dom.userMenuPopup.classList.add('hidden'); }
                });
            }
            function handleFileUpload(e, type) {
                const file = e.target.files[0]; if (!file) return;
                clearFilePreviews();
                const reader = new FileReader();
                const previewId = `preview-${Date.now()}`;
                const previewWrapper = document.createElement('div');
                previewWrapper.id = previewId;
                previewWrapper.className = 'relative';
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '&times;';
                closeBtn.className = 'absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs z-10';
                closeBtn.onclick = () => clearFilePreviews();
                previewWrapper.appendChild(closeBtn);
                if (type === 'image') {
                    const img = document.createElement('img');
                    img.className = 'w-24 h-24 rounded-lg object-contain border border-themed';
                    previewWrapper.insertBefore(img, closeBtn);
                    reader.onload = (ev) => { selectedImageBase64 = ev.target.result; img.src = selectedImageBase64; };
                    reader.readAsDataURL(file);
                } else {
                    const pdfDiv = document.createElement('div');
                    pdfDiv.className = 'p-3 rounded-lg border-themed bg-light flex items-center';
                    pdfDiv.innerHTML = `<i class="fas fa-file-pdf text-red-500 text-3xl mr-4"></i><div><p class="text-sm font-medium truncate">${file.name}</p><p class="text-xs font-mono">Procesando...</p></div>`;
                    previewWrapper.insertBefore(pdfDiv, closeBtn);
                    reader.onload = async (ev) => {
                        try {
                            const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(ev.target.result) }).promise;
                            let text = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i); const content = await page.getTextContent();
                                text += content.items.map(item => item.str).join(' ') + '\n';
                            }
                            selectedPdfText = text;
                            previewDiv.querySelector('.font-mono').textContent = `✅ Listo (${pdf.numPages} pág.)`;
                        } catch (err) { previewDiv.querySelector('.font-mono').textContent = '❌ Error al leer PDF.'; selectedPdfText = null; }
                    };
                    reader.readAsArrayBuffer(file);
                }
                dom.filePreviewArea.appendChild(previewWrapper);
            }
            function initApp() {
                setTheme(localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches));
                let initFired = false;
                const finishInitialization = (user) => {
                    if (initFired) return;
                    initFired = true; currentUser = user; updateUserUI(); loadStateForUser();
                    dom.appContainer.classList.remove('opacity-0'); dom.loadingOverlay.style.display = 'none';
                };
                netlifyIdentity.on('init', (user) => finishInitialization(user));
                setTimeout(() => { if (!initFired) { finishInitialization(netlifyIdentity.currentUser()); } }, 1500);
                netlifyIdentity.on('login', (user) => { netlifyIdentity.close(); currentUser = user; updateUserUI(); loadStateForUser(); });
                netlifyIdentity.on('logout', () => { currentUser = null; updateUserUI(); loadStateForUser(); resetChatView(); });
                setupEventListeners();
                populateVoiceList();
            }
            function updateUserUI() {
                if (currentUser) {
                    dom.loginView.classList.add('hidden'); dom.userMenuView.classList.remove('hidden');
                    dom.personalizedWelcome.classList.remove('hidden'); 
                    if (dom.genericWelcome) dom.genericWelcome.classList.add('hidden');
                    const userName = currentUser.user_metadata.full_name?.split(' ')[0] || currentUser.email.split('@')[0];
                    dom.userEmail.textContent = currentUser.user_metadata.full_name || currentUser.email;
                    dom.userName.textContent = userName;
                } else {
                    dom.loginView.classList.remove('hidden'); dom.userMenuView.classList.add('hidden');
                    dom.personalizedWelcome.classList.add('hidden');
                    if(dom.genericWelcome) dom.genericWelcome.classList.remove('hidden');
                }
            }
            function populateVoiceList() {
                if(!dom.voiceSelector) return;
                const setVoices = () => {
                    if (typeof speechSynthesis === 'undefined') return;
                    availableVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('es-'));
                    if (availableVoices.length === 0) return;
                    dom.voiceSelector.innerHTML = '';
                    availableVoices.forEach(voice => {
                        const option = document.createElement('option');
                        const displayName = voice.name.replace('Microsoft', '').replace('Online (Natural) -', '').replace('Google', '').replace('Spanish (Mexico)','Mex').trim();
                        option.textContent = displayName || voice.lang;
                        option.value = voice.name;
                        dom.voiceSelector.appendChild(option);
                    });
                    selectedVoice = availableVoices[0];
                    if (selectedVoice) dom.voiceSelector.value = selectedVoice.name;
                };
                if (speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = setVoices; }
                setTimeout(setVoices, 200);
            }
            initApp();
        });
    </script>
</body>
</html>
