<!DOCTYPE html>
<html data-theme="light" lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<title>Goatify IA v5.1 — Interactive Edition</title>
<!-- SEO Meta Tags -->
<meta content="Goatify IA v5.1 es tu sistema operativo de negocios con IA. Gestiona proyectos con calendarios y listas interactivas, y planifica contenido con el potente módulo CronoPOST. Todo es editable, rápido e intuitivo." name="description"/>
<meta content="project management, crm, business os, project os, marketing agency, content calendar, cronopost, inline editing, goatify ia" name="keywords"/>
<meta content="Goatify" name="author"/>
<!-- Open Graph Meta Tags -->
<meta content="Goatify IA v5.1 — Interactive Edition" property="og:title"/>
<meta content="website" property="og:type"/>
<meta content="Goatify IA v5.1 es tu sistema operativo de negocios con IA. Gestiona proyectos y marketing con herramientas interactivas y potenciadas con IA." property="og:description"/>
<!--  -->
<meta content="#f6f7fb" name="theme-color"/>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  :root{
    --bg:#0b0f19; --surface:#0f172a; --muted:#1e293b; --line:#334155;
    --text:#e2e8f0; --sub:#94a3b8; --brand:#a78bfa; --brand2:#8b5cf6; --accent:#38bdf8;
    --danger:#f87171; --warn:#fbbf24; --success:#22c55e; --info:#60a5fa;
    --shadow:0 20px 60px rgba(0,0,0,.45);
    --radius:12px; --xs:10px; --sm:12px; --md:13.5px; --lg:15.5px; --xl:18px;
    --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  [data-theme="light"]{
    --bg:#f8fafc; --surface:#ffffff; --muted:#f1f5f9; --line:#e2e8f0;
    --text:#0f172a; --sub:#64748b; --brand:#6d28d9; --brand2:#8b5cf6; --accent:#0ea5e9;
    --shadow:0 10px 25px rgba(15, 23, 42,.08);
  }
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
  *{box-sizing:border-box; transition: background .15s ease, color .15s ease, border-color .15s ease, transform .15s ease, box-shadow .15s ease}
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font: var(--md)/1.5 var(--font-sans);}
  a{color:var(--brand);text-decoration:none}
  .container{display:grid;grid-template-columns:280px 1fr;min-height:100%}
  aside{border-right:1px solid var(--line);background:var(--surface);padding:10px;position:relative;z-index:30; display: flex; flex-direction: column;}
  header.app{position:sticky;top:0;z-index:40;background:color-mix(in hsl, var(--surface) 85%, transparent);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);padding:8px 10px;display:flex;gap:10px;align-items:center}
  .brand{display:flex;gap:8px;align-items:center;font-weight:800; font-size: var(--lg);}
  .badge{padding:2px 8px;border-radius:999px;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;font-size:var(--xs)}
  .btn{border-radius:var(--radius);border:1px solid var(--line);background:var(--surface);color:var(--text);padding:8px 12px;cursor:pointer;display:inline-flex;gap:8px;align-items:center; font-weight: 600; white-space: nowrap;}
  .btn:hover{transform:translateY(-1px); border-color: var(--brand); box-shadow: var(--shadow);} .btn:active{transform:none; box-shadow: none;}
  .btn-primary{border:none;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff}
  .btn-ghost{background:transparent; border-color: transparent; box-shadow: none;}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border:1px solid transparent;border-radius:999px;background:var(--muted); cursor: pointer;}
  .chip:hover { border-color: var(--brand); }
  input,select,textarea{border:1px solid var(--line);border-radius:10px;background:var(--muted);color:var(--text);padding:8px 12px;outline:none; width: 100%;}
  input:focus, select:focus, textarea:focus { border-color: var(--brand); background: var(--surface); box-shadow: 0 0 0 3px color-mix(in hsl, var(--brand) 20%, transparent); }
  .projList{display:flex;flex-direction:column;gap:6px}
  .navBtn{display:flex;gap:10px;align-items:center;border:1px solid transparent;border-radius:10px;background:transparent;padding:10px;cursor:pointer; font-weight: 500; color: var(--text)}
  .navBtn:hover{background:var(--muted);}
  .navBtn.active {background: var(--brand); color: #fff; font-weight: 700;}
  .projItem { display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 10px; border: 1px solid transparent; cursor: pointer; }
  .projItem .proj-actions { display: none; margin-left: auto;}
  .projItem:hover .proj-actions { display: flex; }
  .projItem.active { background: color-mix(in hsl, var(--brand) 15%, transparent); border-color: var(--brand); font-weight: 600; }
  .panel{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);margin:10px;overflow:hidden; animation: fadeIn .3s ease;}
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}
  .section{padding:16px;border-top:1px solid var(--line);}
  .card{border:1px solid var(--line);border-radius:12px;background:var(--muted);padding:16px}
  .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
  .stat-card { background: var(--muted); padding: 16px; border-radius: var(--radius); }
  .stat-card h4 { margin: 0 0 8px 0; color: var(--sub); }
  .stat-card p { margin: 0; font-size: var(--xl); font-weight: 700; }
  .tip { padding: 12px; background: color-mix(in hsl, var(--info) 10%, transparent); border-left: 3px solid var(--info); border-radius: 8px; margin: 10px 0; display: flex; gap: 10px; align-items: flex-start;}
  .empty-state { text-align: center; padding: 40px; color: var(--sub); }
  /* Tabs */
  .tabs{display:flex;gap:6px;padding:12px;border-bottom:1px solid var(--line); flex-wrap: wrap;}
  .tab{all:unset;cursor:pointer;padding:8px 14px;border:1px solid var(--line);border-radius:999px;background:var(--muted); font-weight: 600;}
  .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
  /* Board */
  .board{display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:10px;padding:10px}
  .col{background:var(--muted);border:1px solid var(--line);border-radius:12px;min-height:220px;padding:8px}
  .col.dragover { outline: 2px dashed var(--brand); background: color-mix(in hsl, var(--brand) 10%, transparent); }
  .task{background:var(--surface);border:1px solid var(--line);border-radius:10px;padding:12px;margin:8px 4px;cursor:grab;box-shadow:var(--shadow)}
  .task:hover{transform:scale(1.03)}
  /* Calendar Redesign */
  #cronopost-grid { display: grid; grid-template-columns: 1fr 320px; gap: 10px; padding: 10px; }
  #cpCalendarContainer { background: var(--muted); border-radius: var(--radius); padding: 10px; }
  .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
  .day { min-height: 140px; border: 1px solid var(--line); border-radius: 10px; background: var(--surface); padding: 6px; display: flex; flex-direction: column; gap: 4px; cursor:pointer;}
  .day:hover { background: var(--muted); }
  .day.other-month { background: var(--muted); }
  .cp-post { font-size: 12px; background: var(--surface); border: 1px solid var(--line); border-radius: 8px; padding: 4px 6px; cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,.05); }
  #cpIdeas { background: var(--muted); border-radius: var(--radius); padding: 10px; }
  .cp-idea { background: var(--surface); border: 1px dashed var(--line); border-radius: 10px; padding: 8px; margin-bottom: 8px; cursor: grab; }
  /* Hub Redesign */
  .hub-grid{display:grid; grid-template-columns: 360px 1fr; gap: 10px; padding: 10px;}
  .profile-card { padding: 20px; background: var(--surface); border: 1px solid var(--line); border-radius: var(--radius); }
  .avatar { width: 80px; height: 80px; border-radius: 999px; object-fit: cover; border: 3px solid var(--brand); }
  .job-item, .market-item { background: var(--surface); border: 1px solid var(--line); border-radius: 12px; padding: 16px; cursor: pointer; }
  .job-item:hover, .market-item:hover { border-color: var(--brand); box-shadow: var(--shadow); transform: translateY(-2px); }
  /* GChat Redesign */
  .gchat-grid { display: grid; grid-template-columns: 260px 1fr; gap: 10px; padding: 10px; }
  .user-list .user-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; }
  .user-list .user-item:hover { background: var(--muted); }
  .presence-dot { width: 10px; height: 10px; border-radius: 50%; }
  .presence-dot.online { background: var(--success); }
  .presence-dot.offline { background: var(--sub); }
  .chat-log .msg { margin-bottom: 12px; }
  .chat-log .msg small { color: var(--sub); }
  .chat-log .msg-body { background: var(--surface); padding: 8px 12px; border-radius: 12px; display: inline-block; max-width: 80%; }
  .chat-log .msg.mine .msg-body { background: var(--brand); color: #fff; }
  /* Modals & Toasts */
  dialog { border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); max-width: 600px; }
  dialog[open] { animation: fadeIn .2s ease; }
  dialog::backdrop { background: rgba(0,0,0,.5); backdrop-filter: blur(4px); }
  #toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 999px; z-index: 100; font-weight: 600; box-shadow: var(--shadow); opacity: 0; transition: opacity .3s, bottom .3s; }
  #toast.show { opacity: 1; bottom: 30px; }
  #toast.info { background: linear-gradient(90deg, var(--brand), var(--brand2)); color: #fff; }
  #toast.success { background: linear-gradient(90deg, var(--success), #16a34a); color: #fff; }
  #toast.warn { background: linear-gradient(90deg, var(--warn), #d97706); color: #fff; }
  /* Mobile */
  @media (max-width: 1180px){ .container{grid-template-columns:1fr} aside{position:fixed;inset:0;transform:translateX(-101%);transition:.2s ease;z-index:99} body.aside-open aside{transform:translateX(0)} }
  @media (max-width: 860px){ .board, .hub-grid, #cronopost-grid, .gchat-grid {grid-template-columns:1fr} }
</style>
</head>
<body>
<header class="app">
<button class="btn btn-ghost" id="menuBtn"><i data-lucide="menu"></i></button>
<div class="brand">Goatify <span style="color:var(--brand)">IA</span> <span class="badge">v5.1</span></div>
<div class="spacer"></div>
<div class="chip" id="walletChip" title="Ver Billetera"><i data-lucide="wallet"></i> <span id="wallet-amount">$0</span></div>
<div class="chip" id="intisChip" title="Tus Intis (puntos de gamificación)"><i data-lucide="sparkles"></i> <span id="intis-amount">0</span></div>
<div class="chip" id="creditsChip" title="Haz clic para ver los beneficios de la membresía"><i data-lucide="star"></i> <span id="credits-amount">100</span> créditos</div>
<button class="btn btn-ghost" id="themeBtn"><i data-lucide="sun"></i></button>
<button class="btn btn-ghost" id="tourBtn"><i data-lucide="help-circle"></i></button>
</header>
<div class="container">
<aside>
<div>
<div class="search row"><i data-lucide="search"></i><input id="q" placeholder="Buscar en todo…"/></div>
<div class="row" style="padding: 10px 0;"><b>Proyectos</b><span class="spacer"></span><button class="btn" id="newProject"><i data-lucide="plus"></i> Nuevo</button></div>
<div class="projList" id="projList"></div>
</div>
<div class="spacer" style="min-height: 20px;"></div>
<div>
<hr style="border-color:var(--line); margin: 10px 0;"/>
<div id="nav-list" class="projList">
<a class="navBtn" data-nav="cronopost" href="#cronopost"><i data-lucide="calendar-days"></i> CronoPOST</a>
<a class="navBtn" data-nav="hub" href="#hub"><i data-lucide="globe-2"></i> Hub Profesional</a>
<a class="navBtn" data-nav="marketing" href="#marketing"><i data-lucide="rocket"></i> Marketing Pro</a>
<a class="navBtn" data-nav="gchat" href="#gchat"><i data-lucide="messages-square"></i> Chat Global</a>
<a class="navBtn" data-nav="monet" href="#monet"><i data-lucide="dollar-sign"></i> Asistente de Monetización</a>
<a class="navBtn" data-nav="mindset" href="#mindset"><i data-lucide="brain-circuit"></i> Mindset y Motivación</a>
<a class="navBtn" data-nav="admin" href="#admin"><i data-lucide="shield"></i> Admin</a>
<a class="navBtn" id="changeIndustryBtn" href="#"><i data-lucide="factory"></i> Cambiar Industria</a>
<a class="navBtn" data-nav="settings" href="#settings"><i data-lucide="settings"></i> Ajustes</a>
</div>
</div>
</aside>
<main id="main">
<!-- PROJECT SHELL -->
<section class="panel" id="projectShell" style="display:none">
<div class="tabs">
<button class="tab active" data-ptab="overview">Overview</button>
<button class="tab" data-ptab="tasks">Tareas</button>
<button class="tab" data-ptab="calendar">Calendario</button>
<button class="tab" data-ptab="tables">Tablas</button>
<button class="tab" data-ptab="notes">Notas</button>
<button class="tab" data-ptab="files">Archivos</button>
<button class="tab" data-ptab="chat">Chat IA</button>
<button class="tab" data-ptab="finance">Finanzas</button>
<div class="spacer"></div>
<div class="chip" id="projectNameChip">Proyecto</div>
<button class="btn" id="addFolder"><i data-lucide="folder-plus"></i> Subcarpeta</button>
<select id="folderSel"></select>
<button class="btn btn-primary" id="quickAdd"><i data-lucide="plus"></i> Tarea</button>
</div>
<!-- OVERVIEW -->
<div id="p-tab-overview" style="padding:16px">
    <div id="ovr" class="overview-grid"></div>
</div>
<!-- TASKS -->
<div id="p-tab-tasks" style="display:none;">
<div class="grid">
<div>
<div class="row" style="padding:10px">
<div class="chip">Vista</div>
<button class="btn active" id="vKanban"><i data-lucide="layout-grid"></i> Kanban</button>
<button class="btn" id="vList"><i data-lucide="list"></i> Lista</button>
</div>
<div class="board" id="kanban"></div>
<div class="list" id="list" style="display:none;padding:10px; overflow-x: auto;">
<table style="width:100%; border-collapse: separate; border-spacing: 0 6px;">
<thead><tr><th>✓</th><th>Tarea</th><th>Prioridad</th><th>Vence</th><th>Asignado</th><th>Estado</th><th>Subcarpeta</th><th></th></tr></thead>
<tbody id="listBody"></tbody>
</table>
</div>
</div>
<div>
<div class="card" style="margin: 0 10px;">
    <b>Quick Planner</b>
    <input id="qaTitle" placeholder="Nueva tarea…" style="margin: 8px 0;"/>
    <input id="qaDue" style="margin-bottom: 8px;" type="datetime-local"/>
    <select id="qaPriority" style="margin-bottom: 8px;"><option>Baja</option><option selected>Media</option><option>Alta</option></select>
    <select id="qaFolder" style="margin-bottom: 8px;"></select>
    <button class="btn btn-primary" id="qaCreate" style="width: 100%;">Crear Tarea</button>
</div>
</div>
</div>
</div>
<!-- CALENDAR -->
<div id="p-tab-calendar" style="display:none; padding:10px;">
<div class="row"><b>Calendario del proyecto</b><span class="spacer"></span><button class="btn" id="prevM"><i data-lucide="chevron-left"></i></button><div class="chip" id="monthLbl">Mes</div><button class="btn" id="nextM"><i data-lucide="chevron-right"></i></button></div>
<div class="tip"><i data-lucide="info"></i>Haz clic en cualquier día para agregar una nueva tarea.</div>
<div class="calendar" id="calGrid"></div>
</div>
<!-- TABLES -->
<div id="p-tab-tables" style="display:none; padding:10px;">
<div class="row"><b>Tablas</b><span class="spacer"></span><button class="btn" id="newSheet"><i data-lucide="plus"></i> Tabla</button><button class="btn" id="addCol"><i data-lucide="plus"></i> Columna</button><button class="btn" id="addRow"><i data-lucide="plus"></i> Fila</button><button class="btn" id="exportCSV">CSV</button></div>
<div class="section" id="sheetWrap" style="overflow:auto"></div>
</div>
<!-- NOTES -->
<div id="p-tab-notes" style="display:none">
<div class="hub-grid" style="padding:10px">
<div class="card">
<div class="row"><b>Notas</b><span class="spacer"></span><button class="btn" id="newNote"><i data-lucide="plus"></i> Nota</button></div>
<div class="listSlim" id="noteList" style="margin-top:8px"></div>
</div>
<div class="card">
<div class="row" style="margin-bottom:8px; flex-wrap: wrap;">
<button class="btn" data-cmd="bold"><b>B</b></button>
<button class="btn" data-cmd="italic"><i>I</i></button>
<button class="btn" data-cmd="underline"><u>U</u></button>
<button class="btn" data-cmd="insertUnorderedList">• Lista</button>
<button class="btn" data-cmd="insertOrderedList">1. Lista</button>
<button class="btn" id="h1Btn">H1</button><button class="btn" id="h2Btn">H2</button>
<select id="noteFolder"></select>
<button class="btn" id="noteMove">Mover</button>
</div>
<div class="section" contenteditable="true" id="noteEditor" style="min-height:50vh; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--line); padding: 12px;"></div>
</div>
</div>
</div>
<!-- FILES -->
<div id="p-tab-files" style="display:none;padding:10px">
<div class="row"><b>Archivos</b><span class="spacer"></span><button onclick="$('#fileInput').click()" class="btn btn-primary"><i data-lucide="upload"></i> Subir Archivos</button><input id="fileInput" multiple="" type="file" style="display: none;"/></div>
<div id="fileList" style="margin-top:10px"></div>
</div>
<!-- CHAT IA -->
<div id="p-tab-chat" style="display:none">
<div class="row" style="padding:10px"><b>Goat X (IA de Proyecto)</b><span class="spacer"></span><button class="btn" id="newChat"><i data-lucide="plus"></i> Chat</button><button class="btn" id="chatToTasks"><i data-lucide="list-plus"></i> → Tareas</button></div>
<div class="gchat" style="padding:10px">
<div>
<div class="row"><b>Hilos</b><span class="spacer"></span><button class="btn btn-ghost" id="delChat"><i data-lucide="trash-2"></i></button></div>
<div class="chatList" id="chatList"></div>
</div>
<div>
<div id="chatLog" style="height:55vh;overflow:auto;border: 1px solid var(--line); border-radius: var(--radius); padding:10px; background: var(--muted);"></div>
<div class="row" style="padding:10px 0;">
    <input class="spacer" id="chatMsg" placeholder="Escribe…"/>
    <button class="btn btn-primary" id="sendMsg"><i data-lucide="send"></i></button>
    <button class="btn" title="Generar Imagen (Próximamente)"><i data-lucide="image"></i></button>
    <button class="btn" title="Analizar Archivo (Próximamente)"><i data-lucide="paperclip"></i></button>
</div>
</div>
</div>
</div>
<!-- FINANZAS -->
<div id="p-tab-finance" style="display:none">
    <div class="row" style="padding:10px"><b>Finanzas del Proyecto</b><span class="spacer"></span><button class="btn btn-primary" id="finNew"><i data-lucide="plus"></i> Movimiento</button><button class="btn" id="finExport">CSV</button></div>
    <div class="overview-grid" style="padding: 10px;">
        <div class="stat-card"><h4>Ingresos Totales</h4><p id="finIn" style="color: var(--success);">0</p></div>
        <div class="stat-card"><h4>Egresos Totales</h4><p id="finOut" style="color: var(--danger);">0</p></div>
        <div class="stat-card"><h4>Balance Neto</h4><p id="finBal">0</p></div>
    </div>
    <div style="padding: 10px;">
        <table id="finTable" style="width:100%; border-collapse: collapse;">
            <thead><tr><th style="text-align: left; padding: 8px;">Fecha</th><th style="text-align: left; padding: 8px;">Tipo</th><th style="text-align: right; padding: 8px;">Monto</th><th style="text-align: left; padding: 8px;">Categoría</th><th style="text-align: left; padding: 8px;">Nota</th><th></th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
</section>
<!-- CRONOPOST -->
<section class="panel" id="cronopost" style="display:none;">
    <div class="row" style="padding:12px; border-bottom: 1px solid var(--line);">
        <b>CronoPOST: Calendario de Contenidos</b><span class="spacer"></span>
        <button class="btn" id="cpPrevM"><i data-lucide="chevron-left"></i></button>
        <div class="chip" id="cpMonthLbl" style="min-width: 150px; justify-content: center;">Mes</div>
        <button class="btn" id="cpNextM"><i data-lucide="chevron-right"></i></button>
    </div>
    <div id="cronopost-grid">
        <div id="cpCalendarContainer">
            <div id="cpCalendar"></div>
        </div>
        <div id="cpIdeas">
            <div class="row">
                <b>💡 Banco de Ideas</b>
                <span class="spacer"></span>
                <select id="cpBrandSelect"></select>
            </div>
            <div id="cpIdeasList" style="max-height: 50vh; overflow-y: auto; padding-right: 5px; margin: 10px 0;"></div>
            <input id="cpNewIdeaInput" placeholder="Escribe una nueva idea..." style="margin-bottom: 8px;">
            <button class="btn" id="cpAddIdeaBtn" style="width: 100%;">+ Añadir Idea Manualmente</button>
            <button class="btn btn-primary" id="cpGenAIIdeas" style="width: 100%; margin-top: 8px;"><i data-lucide="sparkles"></i> Generar Ideas con IA</button>
        </div>
    </div>
</section>
<!-- MARKETING PRO -->
<section class="panel" id="marketing" style="display:none;padding:10px">
<div class="row" style="padding-bottom:10px;">
    <b>Marketing Pro</b>
    <span class="spacer"></span>
</div>
<div class="tip"><i data-lucide="info"></i>Este módulo te ayuda a definir la estrategia central de tu marca o proyecto. Un buen "brief" es el mapa para todas tus acciones de marketing.</div>
<div class="tabs">
<button class="tab active" data-mtab="brief">Brief Estratégico</button>
<button class="tab" data-mtab="ofertas">Ofertas y UTMs</button>
<button class="tab" data-mtab="assets">Assets de Marca</button>
</div>
<div class="section" id="m-mtab-brief">
<div class="row"><input id="brandName" placeholder="Marca / Proyecto"/><input class="spacer" id="target" placeholder="Público objetivo"/><select id="funnel"><option>Awareness</option><option>Consideration</option><option>Conversion</option></select><button class="btn btn-primary" id="briefSave">Guardar</button></div>
<textarea id="briefNotes" placeholder="Mensaje clave, tono de voz, promesas, objeciones…" rows="6" style="width:100%; margin-top: 8px;"></textarea>
</div>
<div class="section" id="m-mtab-ofertas" style="display:none">
<div class="row"><input id="offerName" placeholder="Oferta"/><input class="spacer" id="offerURL" placeholder="URL base"/><button class="btn" id="genUTM">Generar UTM</button></div>
<div class="tip" id="utmOut" style="margin-top:6px; word-break: break-all;"></div>
</div>
<div class="section" id="m-mtab-assets" style="display:none">
<div class="row"><b>Repositorio de Marca</b><span class="spacer"></span><button class="btn btn-primary" onclick="$('#mktFileInput').click()"><i data-lucide="upload"></i> Subir Archivos</button><input id="mktFileInput" multiple type="file" style="display:none;"/></div>
<div class="row" id="mktList" style="margin-top:8px"></div>
</div>
</section>
<!-- HUB REDESIGN -->
<section class="panel" id="hub" style="display:none">
<div class="tabs">
<button class="tab active" data-htab="perfil">Mi Perfil Profesional</button>
<button class="tab" data-htab="jobs">Bolsa de Empleos</button>
<button class="tab" data-htab="market">Mercado de Servicios</button>
</div>
<div class="section" id="h-htab-perfil">
<div class="hub-grid">
    <div class="profile-card">
        <div class="profile-header">
            <img alt="avatar" class="avatar" id="avatar" src="https://placehold.co/80x80/dde2ed/0b132a?text=:)"/>
            <div>
                <h3 id="pNombreDisplay" style="margin: 0;">Tu Nombre</h3>
                <p id="pRoleDisplay" class="muted" style="margin: 4px 0 0;">Tu Rol Profesional</p>
            </div>
        </div>
        <p id="pBioDisplay">Tu biografía profesional. Habla sobre tu experiencia, tus habilidades y lo que buscas.</p>
        <hr style="border-color:var(--line-soft)"/>
        <b>Editar Perfil</b>
        <input id="pNombre" placeholder="Tu nombre" style="margin-top: 8px;"/>
        <input id="pRole" placeholder="Rol (Ej: Frontend Developer)" style="margin: 8px 0;"/>
        <textarea id="pBio" placeholder="Bio corta" rows="3" style="margin-bottom: 8px;"></textarea>
        <div class="row"><button class="btn btn-primary" id="savePerfil">Guardar Perfil</button><button class="btn" id="delPerfil">Borrar</button></div>
    </div>
    <div class="card">
        <b>Portafolio y Enlaces</b>
        <div class="row" style="margin:8px 0"><input class="spacer" id="pfURL" placeholder="URL de tu proyecto, web, LinkedIn..."/><button class="btn" id="addPf">Añadir Enlace</button></div>
        <div class="listSlim" id="pfList"></div>
    </div>
</div>
</div>
<div class="section" id="h-htab-jobs" style="display:none; padding:10px;">
    <div class="card" style="margin-bottom: 10px;">
      <b>Publicar una nueva oferta de empleo</b>
      <div class="row"><input id="jobTitle" placeholder="Título del empleo"/><input id="jobCompany" placeholder="Empresa"/><input id="jobPay" placeholder="Pago (Ej: $2000/mes)"/></div>
      <textarea id="jobDesc" placeholder="Descripción del puesto, requisitos, beneficios..." rows="4" style="width:100%; margin: 8px 0;"></textarea>
      <button class="btn btn-primary" id="addJob">Publicar Empleo</button>
    </div>
    <div class="list-view" id="jobsList"></div>
</div>
<div class="section" id="h-htab-market" style="display:none; padding:10px;">
    <div class="card" style="margin-bottom: 10px;">
      <b>Publicar un nuevo producto o servicio</b>
      <div class="row"><input id="mkName" placeholder="Nombre del Producto/Servicio"/><input id="mkPrice" placeholder="Precio (Ej: $500)" type="number"/></div>
      <textarea id="mkDesc" placeholder="Describe tu servicio, qué incluye, para quién es ideal..." rows="4" style="width:100%; margin: 8px 0;"></textarea>
      <button class="btn btn-primary" id="addMK">Publicar en Mercado</button>
    </div>
    <div class="list-view" id="mkList"></div>
</div>
</section>
<!-- GLOBAL CHAT -->
<section class="panel" id="gchat" style="display:none">
    <div class="row" style="padding:10px"><b>Chat Global</b><span class="spacer"></span><button class="btn" id="newRoom"><i data-lucide="plus"></i> Sala</button></div>
    <div class="tip" style="margin: 0 10px;"><i data-lucide="info"></i><b>Reglas del Chat:</b> Mantén la conversación profesional y respetuosa. Este es un espacio para colaborar y hacer networking.</div>
    <div class="gchat-grid">
        <div class="card">
            <b>Usuarios Conectados</b>
            <div id="gUserList" class="user-list"></div>
        </div>
        <div>
            <div id="roomLog" class="chat-log" style="height:55vh;overflow:auto;border: 1px solid var(--line); border-radius: var(--radius); padding:10px; background: var(--muted);"></div>
            <div class="row" style="padding:10px 0;"><input class="spacer" id="roomMsg" placeholder="Escribe en #general..."/><button class="btn btn-primary" id="sendRoom"><i data-lucide="send"></i></button></div>
        </div>
    </div>
</section>
<!-- MONETIZATION WIZARD -->
<section class="panel" id="monet" style="display:none; padding: 10px;">
    <div class="row" style="padding-bottom:10px;">
        <b>Asistente de Monetización "Quantum"</b>
        <span class="spacer"></span>
    </div>
    <div class="card">
        <h3>Tu Camino hacia la Libertad Financiera</h3>
        <p class="muted">Sigue estos pasos para construir un negocio digital rentable y escalable desde cualquier parte del mundo.</p>
        <div id="monet-steps"></div>
    </div>
</section>
<!-- MINDSET -->
<section class="panel" id="mindset" style="display:none; padding: 10px;">
    <div class="row" style="padding-bottom:10px;">
        <b>Mindset y Motivación</b>
        <span class="spacer"></span>
    </div>
    <div class="card">
        <h3>Tu Dosis Diaria de Inspiración</h3>
        <p class="muted">Configura la frecuencia con la que quieres recibir notificaciones con frases y consejos adaptados a tu industria.</p>
        <div class="row" style="margin-top: 16px;">
            <label for="mindset-freq">Frecuencia:</label>
            <select id="mindset-freq">
                <option value="daily">Diariamente</option>
                <option value="thrice">3 veces al día</option>
                <option value="hourly">Cada hora</option>
                <option value="off">Desactivado</option>
            </select>
            <button class="btn btn-primary" id="saveMindset">Guardar Configuración</button>
        </div>
    </div>
</section>
<!-- ADMIN -->
<section class="panel" id="admin" style="display:none">
<div class="tabs">
<button class="tab active" data-atab="publish">Publisher</button>
<button class="tab" data-atab="roles">Roles</button>
<button class="tab" data-atab="data">Data</button>
</div>
<div class="section" id="a-atab-publish">
<div class="row"><input id="tplTitle" placeholder="Título de plantilla"/><select id="tplTarget"><option value="marketing">Marketing</option><option value="cronopost">CronoPOST</option><option value="jobs">Jobs</option><option value="market">Mercado</option></select><button class="btn btn-primary" id="pushTpl">Publicar a usuarios</button></div>
<textarea id="tplBody" placeholder="Contenido / instrucción / preset" rows="5" style="width:100%; margin-top: 8px;"></textarea>
<div class="tip" style="margin-top:8px"><i data-lucide="info"></i> Las plantillas se envían y aparecen automáticamente en la sección objetivo.</div>
</div>
<div class="section" id="a-atab-roles" style="display:none">
<div class="row"><b>Roles simples</b><span class="spacer"></span><select id="roleSel"><option>Owner</option><option>Admin</option><option>Editor</option><option>Viewer</option></select><button class="btn" id="saveRole">Guardar</button></div>
<div class="tip" id="roleOut" style="margin-top:8px"></div>
</div>
<div class="section" id="a-atab-data" style="display:none">
<div class="row"><button class="btn" id="dumpJSON">Export JSON</button><input accept="application/json" id="importJSON" type="file"/><button class="btn" id="resetApp">Reset total</button></div>
<pre class="section" id="jsonOut" style="white-space:pre-wrap;background:var(--muted);border-radius:12px; max-height: 40vh; overflow: auto;"></pre>
</div>
</section>
<!-- SETTINGS -->
<section class="panel" id="settings" style="display:none;padding:10px">
<div class="row"><b>Ajustes</b><span class="spacer"></span></div>
<div class="hub-grid">
<div class="card">
<b>Preferencias</b>
<div class="row" style="margin-top:8px"><label class="chip"><input checked="" id="setSingleProfile" type="checkbox"/> Forzar perfil único</label><label class="chip"><input checked="" id="setHints" type="checkbox"/> Mostrar ayudas/contexto</label></div>
<div class="row" style="margin-top:8px"><button class="btn" id="clearHints">Ocultar ayudas</button><button class="btn" id="showHints">Mostrar ayudas</button></div>
</div>
<div class="card">
<b>Import/Export</b>
<div class="row" style="margin-top:8px"><button class="btn" id="btnExport">Exportar .json</button><input accept="application/json" id="btnImport" type="file"/></div>
</div>
</div>
<div class="section tip"><i data-lucide="database"></i> Todo guarda offline en tu navegador (localStorage).</div>
</section>
<!-- MODALS -->
<dialog id="newProjectModal">
    <div class="card">
        <h3 style="margin-top:0">Crear Nuevo Proyecto</h3>
        <p class="muted">Dale un nombre a tu nuevo espacio de trabajo.</p>
        <input id="newProjectName" placeholder="Ej: Lanzamiento de App Móvil" style="margin: 16px 0;"/>
        <div class="row">
            <button class="btn" id="newProjectCancel">Cancelar</button>
            <span class="spacer"></span>
            <button class="btn btn-primary" id="newProjectCreate">Crear Proyecto</button>
        </div>
    </div>
</dialog>
<dialog id="walletModal">
<div class="section">
<div class="row"><b>Wallet &amp; Intis</b><span class="spacer"></span><button class="btn btn-ghost" id="wClose"><i data-lucide="x"></i></button></div>
<div class="row" style="margin-top:6px; flex-wrap: wrap;"><input id="wMonto" placeholder="Monto" type="number"/><select id="wTipo"><option>Ingreso</option><option>Egreso</option></select><input id="wCat" placeholder="Categoría"/><input class="spacer" id="wNota" placeholder="Nota"/><button class="btn btn-primary" id="wAdd">Añadir</button></div>
<div class="row" style="margin-top:6px">Intis: <input id="iNota" placeholder="Razón"/><input id="iPts" placeholder="+/- puntos" type="number"/><button class="btn" id="iAdd">Aplicar</button></div>
<table style="width:100%;margin-top:10px"><thead><tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Cat</th><th>Nota</th><th></th></tr></thead><tbody id="wBody"></tbody></table>
</div>
</dialog>
<dialog id="industryModal" style="padding: 0; overflow: hidden;">
    <div style="background: var(--surface); padding: 24px;">
        <div class="row">
            <h2 style="margin: 0;">Bienvenido a Goatify IA v5.1</h2>
            <span class="spacer"></span>
            <button class="btn btn-ghost" id="industryClose"><i data-lucide="x"></i></button>
        </div>
        <p class="muted">Para empezar, cuéntanos sobre tu negocio. Cargaremos plantillas y herramientas personalizadas para ti.</p>
        <div class="card" style="margin-top: 16px;">
            <b>Elige tu industria principal</b>
            <select id="industrySel" style="width: 100%; margin: 12px 0;">
                <option value="agency">Agencia de Marketing / Servicios Digitales</option>
                <option value="freelancer">Freelancer / Creativo</option>
                <option value="startup">Startup Tecnológica</option>
                <option value="hostel">Hostelería (Hoteles, Hostels, Glamping)</option>
                <option value="ecommerce">E-commerce / Tienda Online</option>
                <option value="real_estate">Bienes Raíces / Construcción</option>
                <option value="other">Otra</option>
            </select>
            <button class="btn btn-primary" id="loadIndustry" style="width: 100%;">Cargar Plantilla y Empezar</button>
        </div>
    </div>
</dialog>
<dialog id="creditsModal">
    <div style="padding: 24px; text-align: center;">
        <h2 style="margin-top: 0;">🚀 Desbloquea tu Potencial con Goatify PRO</h2>
        <p class="muted">La versión gratuita te da 100 créditos para probar las funciones de IA. Cuando se acaben, ciertas acciones estarán limitadas.</p>
        <div class="card" style="text-align: left; background: color-mix(in hsl, var(--brand) 8%, transparent); border-left: 4px solid var(--brand);">
            <h3 style="margin-top:0;">Membresía PRO - $4/mes</h3>
            <ul style="padding-left: 20px;">
                <li>✅ <b>Créditos Ilimitados</b> para todas las funciones IA.</li>
                <li>✅ <b>Plantillas PRO</b> y estrategias avanzadas.</li>
                <li>✅ <b>Soporte prioritario</b> por email.</li>
                <li>✅ Acceso anticipado a <b>nuevas funcionalidades</b>.</li>
            </ul>
        </div>
        <button class="btn btn-primary" style="width: 100%; margin-top: 16px; padding: 12px;">Obtener Goatify PRO (Demo)</button>
        <button class="btn btn-ghost" id="creditsClose" style="margin-top: 8px;">Cerrar</button>
    </div>
</dialog>

<!-- TOAST NOTIFICATION -->
<div id="toast" class="info"></div>
</main>
</div>
<script>
// ====== State ======
var S = {
  version:'5.1',
  industry: null,
  projects: [],
  activeProject: null,
  activeNav: 'hub',
  folders: {},
  tasks: {},
  chats: {},
  tables: {},
  notes: {},
  files: {},
  fin: {},
  overview: {},
  cronopost: { brands: [], activeBrand: null, ideas: {}, posts: {} },
  marketing: { brief:{}, ofertas:[], assets:[]},
  hub: { perfil:null, portafolio:[], jobs:[], market:[] },
  chat: { 
    rooms:[{id:'r1', name: '#general'}, {id:'r2', name: '#marketing'}, {id:'r3', name: '#random'}], 
    messages:{'r1': [], 'r2':[], 'r3':[]}, 
    activeRoom: 'r1',
    users: [
        {name: 'Ana', online: true}, {name: 'Carlos', online: false},
        {name: 'Elena', online: true}, {name: 'David', online: true}
    ]
  },
  monet: { completedSteps: [] },
  mindset: {
      frequency: 'daily',
      lastMessage: null,
      messages: {
          agency: ["El éxito es la suma de pequeños esfuerzos repetidos día tras día.", "La creatividad es la inteligencia divirtiéndose."],
          freelancer: ["Tu trabajo va a llenar gran parte de tu vida, la única manera de estar realmente satisfecho es hacer lo que crees que es un gran trabajo.", "El único modo de hacer un gran trabajo es amar lo que haces."],
          startup: ["No importa lo lento que vayas mientras no te detengas.", "El secreto para salir adelante es empezar."]
      }
  },
  admin: { role:'Owner' },
  wallet: { movs:[] },
  intis: 0,
  credits: 100,
  hints:true,
  singleProfile:true,
};
const initialState = JSON.parse(JSON.stringify(S));

function save(){ localStorage.setItem('goatify_v51', JSON.stringify(S)); syncHeader(); }
function load(){
  const raw = localStorage.getItem('goatify_v51');
  if(raw){  
      try {
        const loadedState = JSON.parse(raw);
        if (loadedState && typeof loadedState === 'object') {
            Object.assign(S, loadedState);
        }
      } catch (e) {
        console.error("Error parsing saved state:", e);
        localStorage.removeItem('goatify_v51');
      }
  }
  syncHeader();
}
function syncHeader(){
  const w = (S.wallet.movs || []).reduce((a,m)=>a+(m.tipo==='Ingreso'?+m.monto:-m.monto),0);
  $('#wallet-amount').textContent = '$'+w.toFixed(2);
  $('#intis-amount').textContent = S.intis;
  $('#credits-amount').textContent = S.credits > 0 ? `${S.credits} créditos` : 'Créditos agotados';
  if(S.credits <= 0) $('#creditsChip').style.color = 'var(--danger)';
}

// ====== Helpers ======
const $ = sel=>document.querySelector(sel);
const $$ = sel=>Array.from(document.querySelectorAll(sel));
function el(tag, attrs={}, ...kids){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='dataset'){ Object.entries(v).forEach(([dk,dv])=>e.dataset[dk]=dv); }
    else if(k==='html'){ e.innerHTML = v; }
    else if(k==='text'){ e.textContent = v; }
    else if(k.startsWith('on')) { e[k] = v; }
    else e.setAttribute(k,v);
  });
  kids.forEach(k=>{ if(k) e.append(k); });
  return e;
}
function todayISO(){ return new Date().toISOString().slice(0,10); }
function fmtDate(d){ const dt = new Date(d); return dt.toLocaleString('es-EC', { dateStyle: 'short', timeStyle: 'short' }); }
function csv(rows){ return rows.map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n'); }
function download(filename, text){
  const a = el('a',{href:URL.createObjectURL(new Blob([text],{type:'text/plain'})), download:filename});
  document.body.appendChild(a); a.click(); a.remove();
}
function monthGrid(ref=new Date()){
  const y=ref.getFullYear(), m=ref.getMonth();
  const first=new Date(y,m,1);
  const start = new Date(first); start.setDate(1-((first.getDay()+6)%7));
  const days=[]; let cur=new Date(start);
  while(days.length < 42){
    days.push(new Date(cur));
    cur.setDate(cur.getDate()+1);
  }
  return days;
}
let toastTimeout;
function showToast(message, type = 'info') {
    const toast = $('#toast');
    if (!toast) return;
    toast.textContent = message;
    toast.className = '';
    toast.classList.add(type, 'show');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => {
        toast.classList.remove('show');
    }, 2500);
}
function addIntis(points, reason) {
    S.intis += points;
    save();
    showToast(`+${points} Intis ✨ (${reason})`, 'info');
}

// ====== UI: Navigation & Title ======
function renderAside(){
  const list = $('#projList'); list.innerHTML='';
  S.projects.forEach(p=>{
    const item = el('div',{class:'projItem', dataset: {id: p.id}}, 
        el('span',{text:p.name, style:'flex:1', onclick: ()=> openProject(p.id)}),
        el('div', {class: 'proj-actions'},
            el('button', {class: 'btn btn-ghost', onclick: (e) => { e.stopPropagation(); renameProject(p.id); }}, el('i', {'data-lucide': 'edit-3', 'width': 16})),
            el('button', {class: 'btn btn-ghost', onclick: (e) => { e.stopPropagation(); deleteProject(p.id); }}, el('i', {'data-lucide': 'trash-2', 'width': 16}))
        )
    );
    if (p.id === S.activeProject) item.classList.add('active');
    list.appendChild(item);
  });
  lucide.createIcons();
  $$('.navBtn[data-nav]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.nav === S.activeNav && !S.activeProject);
  });
}
function show(sectionId){
  $$('main > section').forEach(s => s.style.display = 'none');
  const s = $('#'+sectionId);  
  if(s) s.style.display='block';
  S.activeNav = sectionId;
  S.activeProject = null;
  save();
  renderAside();
  updateTitle();
  document.body.classList.remove('aside-open');
}
function openProject(id){
  S.activeProject = id;
  S.activeNav = null;
  save();
  $$('main > section').forEach(s => s.style.display = 'none');
  $('#projectShell').style.display='block';
  const p = S.projects.find(x=>x.id===id);
  $('#projectNameChip').textContent = p?.name || 'Proyecto';
  const selOptions = (S.folders[id]||['General']).map(f=>el('option',{text:f}));
  ['#folderSel', '#qaFolder', '#noteFolder'].forEach(selId => {
      const sel = $(selId);
      if (sel) {
        sel.innerHTML = '';
        selOptions.forEach(opt => sel.append(opt.cloneNode(true)));
      }
  });
  renderAside();
  updateTitle();
  renderProject();
  $('#projectShell .tabs .tab[data-ptab="overview"]')?.click();
}
function renderProject() {
    renderOverview(); renderTasks(); renderCalendar(); renderTables(); renderNotes(); renderFiles(); renderProjectChat(); renderFin();
}
function updateTitle() {
    if (S.activeProject) {
        const p = S.projects.find(x => x.id === S.activeProject);
        document.title = `Goatify | ${p?.name || 'Proyecto'}`;
    } else if (S.activeNav) {
        const navBtn = $(`.navBtn[data-nav="${S.activeNav}"]`);
        document.title = `Goatify | ${navBtn?.textContent.trim() || 'Dashboard'}`;
    } else {
        document.title = 'Goatify IA v5.1 — Interactive Edition';
    }
}
function wireTabs(scopeSelector, prefix, contentPrefix){
  const root=$(scopeSelector);
  if (!root) return;
  root.querySelectorAll(`.tabs .tab[data-${prefix}]`).forEach(btn=>{
    btn.addEventListener('click',()=>{
      root.querySelectorAll(`.tabs .tab[data-${prefix}]`).forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset[prefix];
      root.querySelectorAll(`[id^="${contentPrefix}-"]`).forEach(p=>p.style.display='none');
      const pane = root.querySelector(`#${contentPrefix}-${target}`);
      if(pane) pane.style.display='block';
    });
  });
}

// ====== Projects CRUD (Improved & Fixed) ======
function createNewProject() {
    const nameInput = $('#newProjectName');
    const name = nameInput.value.trim();
    if(!name) {
        showToast('Por favor, ingresa un nombre para el proyecto.', 'warn');
        return;
    }
    const id = 'p' + Date.now();
    S.projects.push({id,name});  
    S.folders[id]=['General'];  
    S.tasks[id]=[]; S.notes[id]={list:[], active:null, bodies:{}}; S.chats[id]={threads:[], messages:{}, activeThread: null}; S.fin[id]={rows:[]}; S.tables[id]={cols:['Col 1'], rows:[]}; S.files[id]=[];
    addIntis(50, 'Nuevo Proyecto');
    save();  
    renderAside();  
    openProject(id);
    nameInput.value = '';
    $('#newProjectModal').close();
}
function renameProject(id) {
    const proj = S.projects.find(p => p.id === id);
    if (!proj) return;
    const newName = prompt('Nuevo nombre del proyecto:', proj.name);
    if (newName && newName.trim()) {
        proj.name = newName.trim();
        save();
        renderAside();
        if (S.activeProject === id) {
            $('#projectNameChip').textContent = proj.name;
            updateTitle();
        }
    }
}
function deleteProject(id) {
    if (confirm('¿Estás seguro de que quieres eliminar este proyecto y todos sus datos? Esta acción es irreversible.')) {
        S.projects = S.projects.filter(p => p.id !== id);
        delete S.tasks[id]; delete S.folders[id]; delete S.notes[id]; delete S.chats[id]; delete S.fin[id]; delete S.tables[id]; delete S.files[id];
        if (S.activeProject === id) {
            S.activeProject = null;
            show('hub');
        }
        addIntis(5, 'Proyecto eliminado');
        save();
        renderAside();
    }
}


// ====== PROJECT SUB-MODULES (All functional) ======
function renderOverview(){
  const id=S.activeProject; if(!id) return;
  const wrap=$('#ovr'); 
  const tasks = S.tasks[id] || [];
  const finance = S.fin[id] || {rows:[]};
  
  // Data calculation
  const done = tasks.filter(x=>x.status==='Hecho').length;
  const inProgress = tasks.filter(x=>x.status==='En curso').length;
  const blocked = tasks.filter(x=>x.status==='Bloqueado').length;
  const backlog = tasks.filter(x=>x.status==='Backlog').length;
  const totalTasks = tasks.length;
  const progress = totalTasks > 0 ? Math.round(done/totalTasks*100) : 0;
  
  const sumIn=finance.rows.filter(x=>x.tipo==='Ingreso').reduce((a,b)=>a+Number(b.monto),0);
  const sumOut=finance.rows.filter(x=>x.tipo==='Egreso').reduce((a,b)=>a+Number(b.monto),0);
  const balance = sumIn - sumOut;

  // Charting helper
  const createChartCard = (title, chartHtml) => el('div', {class: 'card', style: 'padding: 16px;'}, el('h4', {text: title, style:'margin-bottom:16px;'}), el('div', {html: chartHtml}));

  // Task Status Chart (Donut Chart)
  const taskChartHtml = `<div style="position:relative; width:120px; height:120px; margin:auto; border-radius:50%; background: conic-gradient(var(--success) ${progress}%, var(--muted) ${progress}%)">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90px; height:90px; background:var(--surface); border-radius:50%; display:flex; align-items:center; justify-content:center; flex-direction:column;">
      <span style="font-size:24px; font-weight:bold;">${progress}%</span>
      <small class="muted">Hecho</small>
    </div>
  </div>
  <div class="row" style="justify-content:center; margin-top:16px; font-size:12px;">
    <span class="chip" style="background:var(--success); color:white;">Hecho: ${done}</span>
    <span class="chip" style="background:var(--info);">En Curso: ${inProgress}</span>
    <span class="chip" style="background:var(--danger);">Bloqueado: ${blocked}</span>
    <span class="chip">Backlog: ${backlog}</span>
  </div>`;
  
  // Finance Chart
  const totalFin = sumIn + sumOut;
  const inPercent = totalFin > 0 ? (sumIn / totalFin * 100) : 0;
  const outPercent = 100 - inPercent;
  const financeChartHtml = `<div style="position:relative; width:120px; height:120px; margin:auto; border-radius:50%; background: conic-gradient(var(--danger) ${outPercent}%, var(--success) ${outPercent}%)">
     <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90px; height:90px; background:var(--surface); border-radius:50%; display:flex; align-items:center; justify-content:center; flex-direction:column;">
      <span style="font-size:18px; font-weight:bold; color:${balance >= 0 ? 'var(--success)' : 'var(--danger)'};">$${balance.toFixed(0)}</span>
      <small class="muted">Balance</small>
    </div>
  </div>
   <div class="row" style="justify-content:center; margin-top:16px; font-size:12px;">
    <span style="display:flex; align-items:center; gap:4px;"><div style="width:10px; height:10px; background:var(--success); border-radius:50%;"></div> Ingresos: $${sumIn.toFixed(0)}</span>
    <span style="display:flex; align-items:center; gap:4px;"><div style="width:10px; height:10px; background:var(--danger); border-radius:50%;"></div> Egresos: $${sumOut.toFixed(0)}</span>
  </div>`;
  
  wrap.innerHTML = '';
  wrap.append(createChartCard('Estado de Tareas', taskChartHtml));
  wrap.append(createChartCard('Resumen Financiero', financeChartHtml));
  wrap.append(el('div',{class:'stat-card'}, el('h4', {text:'Archivos Totales'}), el('p', {text:`${(S.files[id] || []).length}`})));
}

function renderTasks(){
  const id=S.activeProject; if(!id) return;
  const tasks=S.tasks[id]||[];
  const cols=['Backlog','En curso','Bloqueado','Hecho'];
  
  // Render Kanban
  const colEl=$('#kanban'); colEl.innerHTML='';
  cols.forEach(c=>{
    const cEl=el('div',{class:'col',dataset:{status:c}},
      el('div',{class:'row'}, el('b',{text:c}), el('span',{class:'spacer'}), el('button',{class:'btn btn-ghost',text:'＋'})));
    cEl.querySelector('button').onclick=()=>{
      const title=prompt('Tarea:'); if(!title) return;
      tasks.push({id:'t'+Date.now(), title, status:c, pri:'Media', due:'', asg:'', folder:'General'});
      S.tasks[id]=tasks; addIntis(5, 'Tarea creada'); save(); renderTasks(); renderOverview();
    };
    cEl.ondragover=e=>{e.preventDefault(); cEl.classList.add('dragover');};
    cEl.ondragleave=()=>cEl.classList.remove('dragover');
    cEl.ondrop=e=>{
      cEl.classList.remove('dragover');
      const tid=e.dataTransfer.getData('text'); const t=tasks.find(x=>x.id===tid);
      if (t) { t.status=c; addIntis(2, 'Tarea movida'); save(); renderTasks(); renderOverview(); }
    };
    tasks.filter(t=>t.status===c).forEach(t=>{
      const tEl=el('div',{class:'task',draggable:'true'},
        el('div',{class: 'row'},
            el('span',{text:t.title, style: 'flex: 1;'}),
            el('button', {class:'btn btn-ghost', style: 'padding: 4px;', onclick: ()=>editTask(t.id)}, el('i', {'data-lucide':'edit-3', width:14})),
            el('button', {class:'btn btn-ghost', style: 'padding: 4px;', onclick: ()=>deleteTask(t.id)}, el('i', {'data-lucide':'trash-2', width:14}))
        ),
        el('small',{class:'sub',text:(t.pri||'')+(t.due? ' • '+new Date(t.due).toLocaleDateString():'')}));
      tEl.ondragstart=e=>e.dataTransfer.setData('text',t.id);
      cEl.appendChild(tEl);
    });
    colEl.appendChild(cEl);
  });
  
  // Render List
  const tbody=$('#listBody'); tbody.innerHTML='';
  tasks.forEach(t=>{
    const tr=el('tr', {},
      el('td',{}, el('input',{type:'checkbox',checked:t.status==='Hecho',onchange:()=>{t.status=t.status==='Hecho'?'Backlog':'Hecho'; save(); renderTasks();}})),
      el('td',{text:t.title, ondblclick: (e) => inlineEdit(e.target, t.id, 'title')}),
      el('td',{text:t.pri, ondblclick: (e) => inlineEdit(e.target, t.id, 'pri', ['Baja', 'Media', 'Alta'])}),
      el('td',{text:t.due ? new Date(t.due).toLocaleDateString() : '-', ondblclick: (e) => inlineEdit(e.target, t.id, 'due', 'date')}),
      el('td',{text:t.asg||'-', ondblclick: (e) => inlineEdit(e.target, t.id, 'asg')}),
      el('td',{text:t.status, ondblclick: (e) => inlineEdit(e.target, t.id, 'status', cols)}),
      el('td',{text:t.folder, ondblclick: (e) => inlineEdit(e.target, t.id, 'folder', S.folders[id])}),
      el('td', {}, el('button', {class:'btn btn-ghost', onclick: () => deleteTask(t.id)}, el('i', {'data-lucide': 'trash-2', width:16})))
    );
    tbody.appendChild(tr);
  });
  lucide.createIcons();
}

function deleteTask(taskId) {
    if (!confirm('¿Seguro que quieres eliminar esta tarea?')) return;
    const projId = S.activeProject;
    if (!projId || !S.tasks[projId]) return;
    S.tasks[projId] = S.tasks[projId].filter(t => t.id !== taskId);
    save();
    renderTasks();
    renderOverview();
    showToast('Tarea eliminada', 'success');
}

function editTask(taskId) {
    const projId = S.activeProject;
    const task = S.tasks[projId].find(t => t.id === taskId);
    if (!task) return;
    const newTitle = prompt('Editar título de la tarea:', task.title);
    if (newTitle !== null) {
        task.title = newTitle;
        save();
        renderTasks();
    }
}

function inlineEdit(cell, taskId, field, options = null) {
    const originalValue = cell.textContent;
    cell.innerHTML = '';
    let editor;

    if (Array.isArray(options)) {
        editor = el('select', {}, ...options.map(o => el('option', {text: o, selected: o === originalValue})));
    } else if (options === 'date') {
        editor = el('input', {type: 'date'});
        const task = S.tasks[S.activeProject].find(t => t.id === taskId);
        editor.value = task.due ? task.due.split('T')[0] : '';
    }
    else {
        editor = el('input', {value: originalValue});
    }

    editor.onblur = editor.onkeydown = (e) => {
        if (e.type === 'blur' || e.key === 'Enter') {
            const task = S.tasks[S.activeProject].find(t => t.id === taskId);
            let newValue = editor.value;
            if(options === 'date' && newValue) {
                newValue = new Date(newValue).toISOString();
            }
            task[field] = newValue;
            save();
            renderTasks();
        } else if (e.key === 'Escape') {
            renderTasks();
        }
    };
    cell.appendChild(editor);
    editor.focus();
}

$('#qaCreate').onclick = () => {
  const id=S.activeProject; if(!id) return;
  const title=$('#qaTitle').value.trim(); if(!title) return;
  const t={id:'t'+Date.now(), title, status:'Backlog', pri:$('#qaPriority').value, due:$('#qaDue').value, asg:'', folder:$('#qaFolder').value||'General'};
  (S.tasks[id]=S.tasks[id]||[]).push(t);
  addIntis(5, 'Tarea rápida');
  save(); $('#qaTitle').value=''; renderTasks(); renderOverview();
};

let calRef=new Date();
function renderCalendar(){
  const id=S.activeProject; if(!id) return;
  $('#monthLbl').textContent = calRef.toLocaleString('es', {month:'long', year:'numeric'});
  const grid=$('#calGrid'); grid.innerHTML='';
  monthGrid(calRef).forEach(d=>{
    const day=el('div',{class:'day', dataset:{date: d.toISOString().split('T')[0]}});
    if(d.getMonth() !== calRef.getMonth()) day.classList.add('other-month');
    day.append(el('div',{class:'muted',text:d.getDate()}));
    (S.tasks[id]||[]).filter(t=>t.due && new Date(t.due).toDateString()===d.toDateString()).forEach(t=>{
      day.append(el('div',{class:'cp-post',text:t.title}));
    });
    day.onclick = () => {
        $('#qaTitle').focus();
        $('#qaDue').value = day.dataset.date + "T09:00";
    };
    grid.append(day);
  });
}
function renderTables(){
  const id=S.activeProject; if(!id) return;
  const wrap=$('#sheetWrap'); wrap.innerHTML='';
  const T=S.tables[id]||(S.tables[id]={cols:[], rows:[]});
  if (T.cols.length === 0) {
      wrap.innerHTML = `<div class="empty-state"><h4>No hay tablas en este proyecto.</h4><p>Crea tu primera tabla para organizar datos.</p></div>`;
      return;
  }
  const tbl=el('table',{style:'width:100%; border-collapse: collapse;'});
  const thead=el('thead',{}, el('tr',{}, ...T.cols.map(c=>el('th',{text:c, style:'border: 1px solid var(--line); padding: 8px;'}))));
  const tbody=el('tbody',{});
  (T.rows || []).forEach(r=>{
    const tr=el('tr',{}, ...T.cols.map((c,ci)=>el('td',{style:'border: 1px solid var(--line); padding: 0;'}, el('input',{value:r[ci]||'', style:'border:none; background:transparent; padding: 8px; width: 100%;', onchange:(e)=>{r[ci]=e.target.value; save();}}))));
    tbody.appendChild(tr);
  });
  tbl.append(thead,tbody);
  wrap.append(tbl);
}
function renderNotes(){
    const id=S.activeProject; if(!id) return;
    const N=S.notes[id]||(S.notes[id]={list:[], active:null, bodies:{}});
    const list=$('#noteList'); list.innerHTML='';
    if (N.list.length === 0) {
        list.innerHTML = `<p class="muted" style="padding: 10px;">No hay notas aquí. ¡Crea la primera!</p>`;
    } else {
        N.list.forEach(n=>{
            const it=el('div',{class:'projItem', text:n.title, onclick:()=>{N.active=n.id; save(); renderNotes();}});
            if(n.id===N.active) it.classList.add('active');
            list.append(it);
        });
    }
    if(!N.active && N.list.length > 0) N.active=N.list[0].id;
    const editor = $('#noteEditor');
    editor.innerHTML = (N.active? (N.bodies[N.active]||'') : 'Selecciona o crea una nota para empezar a escribir.');
    editor.oninput=()=>{ if(N.active){ N.bodies[N.active]=editor.innerHTML; save(); } };
}
function renderFiles(){
  const id=S.activeProject; if(!id) return;
  const L=S.files[id]||[]; const wrap=$('#fileList'); wrap.innerHTML='';
  if (L.length === 0) {
      wrap.innerHTML = `<div class="empty-state"><h4>Este proyecto no tiene archivos.</h4><p>Sube documentos, imágenes o cualquier recurso relevante.</p></div>`;
      return;
  }
  L.forEach((f,idx)=>{
      const fileChip = el('div', {class:'chip'},  
        el('a',{href:f.url,download:f.name, text:f.name}),
        el('button', {class: 'btn btn-ghost', text:'🗑', onclick:()=>{ L.splice(idx,1); addIntis(1,'Archivo eliminado'); save(); renderFiles(); }})
      );
      wrap.append(fileChip);
  });
}
function renderProjectChat() {
    const pid = S.activeProject; if (!pid) return;
    const C = S.chats[pid] || (S.chats[pid] = { threads: [], messages: {}, activeThread: null });
    const list = $('#chatList'); list.innerHTML = '';
    if (C.threads.length === 0) {
        list.innerHTML = `<p class="muted" style="padding: 10px;">Inicia una conversación con la IA para generar ideas o tareas.</p>`;
    } else {
        C.threads.forEach(th => {
            const it = el('div', { class: 'projItem', dataset: { id: th.id }, text: th.title, onclick: () => { C.activeThread = th.id; save(); renderProjectChat(); } });
            if (th.id === C.activeThread) it.classList.add('active');
            list.append(it);
        });
    }

    if (!C.activeThread && C.threads.length > 0) C.activeThread = C.threads[0].id;
    const log = $('#chatLog'); log.innerHTML = '';
    if (C.activeThread) {
        (C.messages[C.activeThread] || []).forEach(m => {
            const div = el('div', {style:'margin-bottom: 8px;'}, el('small', { class: 'sub', text: `${m.who} • ${new Date(m.at).toLocaleTimeString()}` }), el('div', { text: m.text, style:'background: var(--surface); padding: 8px; border-radius: 8px;'}));
            log.append(div);
        });
        log.scrollTop = log.scrollHeight;
    } else {
        log.innerHTML = `<div class="empty-state"><h4>Selecciona o crea un hilo</h4></div>`;
    }
}
function renderFin(){
  const id=S.activeProject; if(!id) return;
  const F=S.fin[id]||(S.fin[id]={rows:[]}); const tbody=$('#finTable tbody'); tbody.innerHTML='';
  F.rows.forEach((r,i)=>{
    const tr=el('tr',{}, 
        el('td',{text:fmtDate(r.fecha), style:'padding:8px'}), 
        el('td',{text:r.tipo, style:'padding:8px'}), 
        el('td',{text:'$'+Number(r.monto).toFixed(2), style:'text-align:right; padding:8px'}), 
        el('td',{text:r.cat, style:'padding:8px'}), 
        el('td',{text:r.nota, style:'padding:8px'}),
        el('td',{}, el('button',{class:'btn btn-ghost',text:'🗑',onclick:()=>{F.rows.splice(i,1); save(); renderFin(); renderOverview();}}))
    );
    tbody.appendChild(tr);
  });
  const sumIn=F.rows.filter(x=>x.tipo==='Ingreso').reduce((a,b)=>a+Number(b.monto),0);
  const sumOut=F.rows.filter(x=>x.tipo==='Egreso').reduce((a,b)=>a+Number(b.monto),0);
  $('#finIn').textContent='$'+sumIn.toFixed(2);
  $('#finOut').textContent='$'+sumOut.toFixed(2);
  $('#finBal').textContent='$'+(sumIn-sumOut).toFixed(2);
}

// ====== GLOBAL MODULES ======
let cpRef = new Date();
function renderCronoPOST() {
    $('#cpMonthLbl').textContent = cpRef.toLocaleString('es', { month: 'long', year: 'numeric' });
    const calendarEl = $('#cpCalendar'); calendarEl.innerHTML = '';
    ['L', 'M', 'X', 'J', 'V', 'S', 'D'].forEach(day => calendarEl.append(el('div', { text: day, style: 'text-align:center; font-weight: 600; color: var(--sub);' })));
    monthGrid(cpRef).forEach(d => {
        const dayEl = el('div', { class: 'day', dataset: { date: d.toDateString() }, ondragover: e => e.preventDefault(), ondrop: e => handleDrop(e, d.toDateString()) });
        if (d.getMonth() !== cpRef.getMonth()) dayEl.classList.add('other-month');
        dayEl.append(el('div', { text: d.getDate() }));
        (S.cronopost.posts[d.toDateString()] || []).forEach(p => {
            const postEl = el('div', { class: 'cp-post', draggable: 'true', text: p.title, dataset: { id: p.id }, ondragstart: e => e.dataTransfer.setData('text/plain', JSON.stringify({type: 'post', id: p.id, from: d.toDateString()})) });
            dayEl.append(postEl);
        });
        calendarEl.append(dayEl);
    });
    
    // Brands
    const brandSelect = $('#cpBrandSelect');
    brandSelect.innerHTML = '';
    (S.cronopost.brands || []).forEach(b => brandSelect.append(el('option', {text:b.name, value: b.id})));
    if(S.cronopost.activeBrand) brandSelect.value = S.cronopost.activeBrand;

    // Ideas
    const ideasList = $('#cpIdeasList'); ideasList.innerHTML = '';
    const activeBrandId = S.cronopost.activeBrand;
    if(activeBrandId && S.cronopost.ideas[activeBrandId]) {
        S.cronopost.ideas[activeBrandId].forEach(idea => {
            const ideaEl = el('div', { class: 'cp-idea', draggable: 'true', text: idea.title, dataset: { id: idea.id }, ondragstart: e => e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'idea', id: idea.id })) });
            ideasList.append(ideaEl);
        });
    }
}
function handleDrop(e, targetDate) {
    e.preventDefault();
    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
    const activeBrandId = S.cronopost.activeBrand;

    if (data.type === 'idea' && activeBrandId) {
        const ideaIndex = S.cronopost.ideas[activeBrandId].findIndex(i => i.id === data.id);
        if (ideaIndex > -1) {
            const [idea] = S.cronopost.ideas[activeBrandId].splice(ideaIndex, 1);
            const newPost = { id: 'cp' + Date.now(), title: idea.title, brandId: activeBrandId };
            if (!S.cronopost.posts[targetDate]) S.cronopost.posts[targetDate] = [];
            S.cronopost.posts[targetDate].push(newPost);
            addIntis(10, 'Post agendado');
        }
    } else if (data.type === 'post') {
        const fromDate = data.from;
        const postIndex = (S.cronopost.posts[fromDate] || []).findIndex(p => p.id === data.id);
        if (postIndex > -1) {
            const [post] = S.cronopost.posts[fromDate].splice(postIndex, 1);
            if (!S.cronopost.posts[targetDate]) S.cronopost.posts[targetDate] = [];
            S.cronopost.posts[targetDate].push(post);
        }
    }
    save();
    renderCronoPOST();
}
function renderMkt(){
    const M = S.marketing;
    $('#brandName').value = M.brief?.brand || '';
    $('#target').value = M.brief?.target || '';
    $('#funnel').value = M.brief?.funnel || 'Awareness';
    $('#briefNotes').value = M.brief?.notes || '';
    const list = $('#mktList'); list.innerHTML=''; 
    (M.assets || []).forEach(a=>list.append(el('a',{class:'chip',href:a.url,download:a.name,text:a.name})));
}
function renderHub(){
  const H = S.hub;
  const P=H.perfil;
  $('#pNombreDisplay').textContent=P?.nombre||'Tu Nombre';
  $('#pRoleDisplay').textContent=P?.rol||'Tu Rol Profesional';
  $('#pBioDisplay').textContent=P?.bio||'Tu biografía profesional. Habla sobre tu experiencia, tus habilidades y lo que buscas.';
  const pf=$('#pfList'); pf.innerHTML=''; (H.portafolio||[]).forEach((x,i)=>pf.append(el('div',{class:'projItem'}, el('a',{href:x.url,text:x.url,target:'_blank'}), el('div',{class:'spacer'}), el('button',{class:'btn btn-ghost',text:'🗑',onclick:()=>{H.portafolio.splice(i,1); save(); renderHub();}}))));
  const jl=$('#jobsList'); jl.innerHTML=''; (H.jobs||[]).forEach((j,i)=>jl.append(el('div',{class:'job-item'}, el('div', {class: 'row'}, el('b',{text:j.title}), el('span', {class: 'chip', text: j.company || 'Empresa'})), el('p', {text: j.desc || '', class: 'muted'}), el('div',{class:'row'}, el('span',{class:'sub',text:j.pay}), el('div',{class:'spacer'}), el('button',{class:'btn',text:'Postular'}), el('button',{class:'btn btn-ghost',text:'🗑',onclick:()=>{H.jobs.splice(i,1); save(); renderHub();}})) )));
  const mk=$('#mkList'); mk.innerHTML=''; (H.market||[]).forEach((m,i)=>mk.append(el('div',{class:'market-item'}, el('b',{text:m.name}), el('p', {text: m.desc || '', class: 'muted'}), el('div',{class:'row'}, el('span',{class:'sub', text:'Precio: $'+m.price}), el('div',{class:'spacer'}), el('button',{class:'btn',text:'Contactar'}), el('button',{class:'btn btn-ghost',text:'🗑',onclick:()=>{H.market.splice(i,1); save(); renderHub();}})) )));
}
function renderChat(){
    const C = S.chat;
    const userList = $('#gUserList'); userList.innerHTML = '';
    // Add current user to the list
    const myName = S.hub.perfil?.nombre || 'Tú';
    const me = el('div', {class: 'user-item'}, el('div', {class: 'presence-dot online'}), el('b', {text: `${myName} (Tú)`}));
    userList.append(me);

    // Add other simulated users
    (C.users || []).forEach(u => {
        const userEl = el('div', {class: 'user-item'}, 
            el('div', {class: `presence-dot ${u.online ? 'online' : 'offline'}`}),
            el('span', {text: u.name})
        );
        userList.append(userEl);
    });

    // Render messages
    const log = $('#roomLog'); log.innerHTML = '';
    const activeRoomId = C.activeRoom || 'r1';
    (C.messages[activeRoomId] || []).forEach(m => {
        const msgWrapper = el('div', {class: 'msg'});
        if (m.who === myName) {
            msgWrapper.classList.add('mine');
            msgWrapper.style.textAlign = 'right';
        }

        const msgEl = el('div', {},
            el('small', {text: `${m.who} • ${new Date(m.at).toLocaleTimeString()}`}),
            el('div', {class: 'msg-body', text: m.text})
        );
        msgWrapper.append(msgEl);
        log.append(msgWrapper);
    });
    log.scrollTop = log.scrollHeight;
}
function renderMonetization() {
    // This is a new, much more detailed module
    const steps = [
        { id: 'idea', title: '1. Define tu Idea y Nicho', content: 'El primer paso es encontrar un problema que valga la pena resolver para un grupo específico de personas (tu nicho). Una buena idea no es suficiente; necesita ser una solución. <ul><li><b>Investiga:</b> ¿Qué problemas tienen en foros, redes sociales?</li><li><b>Valida:</b> Habla con 10 personas de tu nicho. ¿Pagarían por tu solución?</li><li><b>Diferénciate:</b> ¿Qué harás mejor o diferente a la competencia?</li></ul>' },
        { id: 'brand', title: '2. Construye tu Marca Mínima Viable (MVB)', content: 'No necesitas un logo perfecto. Necesitas claridad. <ul><li><b>Nombre:</b> Algo fácil de recordar y escribir.</li><li><b>Propuesta de Valor:</b> Una frase clara. Ej: "Goatify IA te ayuda a organizar tu negocio para que ganes más dinero."</li><li><b>Identidad Visual:</b> Elige 2-3 colores y una fuente. ¡Nada más por ahora!</li></ul>' },
        { id: 'offer', title: '3. Crea tu Oferta Irresistible', content: 'Tu producto o servicio debe ser tan bueno que la gente se sienta tonta diciendo que no. <ul><li><b>Transformación:</b> No vendas "un curso", vende "la habilidad de conseguir clientes".</li><li><b>Componentes:</b> ¿Qué incluye? (Videos, plantillas, soporte).</li><li><b>Bonos:</b> Añade extras de alto valor (Ej: "Una sesión de consultoría 1-a-1 gratis").</li><li><b>Garantía:</b> Reduce el riesgo (Ej: "Garantía de devolución de 30 días").</li></ul>' },
        { id: 'web', title: '4. Lanza tu Página Web (Tu Tienda 24/7)', content: 'Tu web es tu vendedor automático. <ul><li><b>Landing Page:</b> Una sola página enfocada en vender tu oferta irresistible. Debe tener un llamado a la acción claro (Ej: "Comprar Ahora").</li><li><b>Plataformas:</b> Puedes usar herramientas como Carrd, Gumroad o Webflow para empezar rápido.</li><li><b>E-commerce:</b> Si vendes productos físicos, plataformas como Shopify son el estándar.</li></ul>' },
        { id: 'marketing_monet', title: '5. Atrae Clientes con un Embudo Simple', content: 'No necesitas estar en todas las redes. Elige una y domínala. <ul><li><b>Contenido de Valor:</b> Publica contenido que ayude a tu nicho (posts, videos cortos).</li><li><b>Captación:</b> Ofrece algo gratis (un PDF, una clase) a cambio del email de tus visitantes.</li><li><b>Email Marketing:</b> Envía emails para construir confianza y finalmente, vender tu oferta.</li></ul>' },
        { id: 'scale', title: '6. Escala y Trabaja desde Cualquier Lugar', content: 'Una vez que tienes ventas consistentes, es hora de optimizar. <ul><li><b>Automatiza:</b> Usa herramientas para programar posts, enviar emails, etc.</li><li><b>Delega:</b> Contrata asistentes virtuales para tareas repetitivas.</li><li><b>Nuevos Productos:</b> Crea más ofertas para tus clientes existentes. ¡Felicidades, has creado un negocio digital que te da libertad!</li></ul>' },
    ];
    const container = $('#monet-steps');
    container.innerHTML = '';
    steps.forEach(step => {
        const isCompleted = S.monet.completedSteps.includes(step.id);
        const stepEl = el('div', {class: 'card', style:'margin-bottom: 10px; background: var(--surface)'},
            el('div', {class:'row', style:'cursor:pointer', onclick: () => $(`#${step.id}-content`).style.display = $(`#${step.id}-content`).style.display === 'none' ? 'block' : 'none'},
                el('input', {type:'checkbox', checked: isCompleted, onchange: (e) => {
                    if (e.target.checked) {
                        S.monet.completedSteps.push(step.id);
                        addIntis(50, `Paso de monetización completado`);
                    } else {
                        S.monet.completedSteps = S.monet.completedSteps.filter(s => s !== step.id);
                    }
                    save();
                }}),
                el('b', {text: step.title}),
                el('span', {class:'spacer'}),
                el('i', {'data-lucide':'chevron-down'})
            ),
            el('div', {id: `${step.id}-content`, style:'display:none; padding-top:10px; border-top: 1px solid var(--line); margin-top:10px;', html: step.content})
        );
        container.append(stepEl);
    });
    lucide.createIcons();
}

// ====== Industry Template Loader ======
function loadIndustryTemplate(industry) {
    if (S.projects.length > 1 && !confirm("¿Cargar plantilla? Esto reemplazará tus proyectos y datos actuales.")) {
        return;
    }
    const userProfile = S.hub.perfil || {nombre: 'Nuevo Usuario', rol: 'Emprendedor', bio: 'Listo para empezar.'};
    Object.assign(S, JSON.parse(JSON.stringify(initialState))); // Deep reset
    S.hub.perfil = userProfile;
    S.industry = industry;
    
    let p = { id: 'p' + Date.now() };

    switch(industry) {
        case 'hostel':
            p.name = 'Gestión La Villa';
            S.projects.push(p);
            S.folders[p.id] = ['General', 'Reservas', 'Mantenimiento', 'Marketing', 'Finanzas'];
            S.tasks[p.id] = [
                {id:'t'+Date.now(), title:'Confirmar reserva de Juan Pérez (3 noches)', status:'En curso', pri:'Alta', folder: 'Reservas', due: new Date().toISOString()},
                {id:'t'+Date.now()+1, title:'Planificar post de "Oferta Fin de Semana"', status:'Backlog', pri:'Media', folder: 'Marketing'},
                {id:'t'+Date.now()+2, title:'Reparar fuga en baño de Hab. 101', status:'En curso', pri:'Alta', folder: 'Mantenimiento'},
                {id:'t'+Date.now()+3, title:'Comprar suministros de limpieza', status:'Backlog', pri:'Baja', folder: 'General'},
                {id:'t'+Date.now()+4, title:'Pagar factura de electricidad', status:'Hecho', pri:'Media', folder: 'Finanzas'},
            ];
            S.tables[p.id] = { cols: ['Habitación', 'Cliente', 'Check-in', 'Check-out', 'Estado Limpieza', 'Notas'], rows: [ ['101', 'Juan Pérez', todayISO(), '', 'Pendiente', 'Llega a las 10pm'], ['102', 'Ana Gómez', todayISO(), '', 'OK', ''] ] };
            S.notes[p.id] = {list: [{id:'n1', title:'Checklist de Limpieza Profunda'}], active:'n1', bodies:{'n1': '<h3>Baño</h3><ul><li>Limpiar espejo</li><li>Desinfectar inodoro</li></ul><h3>Habitación</h3><ul><li>Cambiar sábanas</li><li>Aspirar alfombra</li></ul>'}};
            S.fin[p.id] = { rows: [ {fecha:new Date(), tipo: 'Ingreso', monto: 120, cat: 'Alojamiento', nota: 'Reserva #5512 Juan Pérez'}, {fecha:new Date(), tipo: 'Egreso', monto: 30, cat: 'Suministros', nota: 'Limpieza'} ] };
            S.chats[p.id] = { threads: [{id:'c1', title: 'Plan Marketing Q4'}], messages: {'c1': [{who: 'GoatX', text: 'Aquí tienes algunas ideas para la campaña...', at: new Date()}]}};
            break;
        case 'agency':
            p.name = 'Proyectos de Agencia Digital';
            S.projects.push(p);
            S.folders[p.id] = ['General', 'Cliente TechCorp', 'Cliente Foodie', 'Prospección', 'Interno'];
            S.tasks[p.id] = [
                {id:'t'+Date.now(), title:'Enviar propuesta a Acme Inc.', status:'En curso', pri:'Alta', folder: 'Prospección'},
                {id:'t'+Date.now()+1, title:'Diseñar borradores para campaña Foodie', status:'Backlog', pri:'Media', folder: 'Cliente Foodie'},
                {id:'t'+Date.now()+2, title:'Reunión de seguimiento con TechCorp', status:'Hecho', pri:'Alta', folder: 'Cliente TechCorp'},
                {id:'t'+Date.now()+3, title:'Actualizar portafolio de la web', status:'Bloqueado', pri:'Baja', folder: 'Interno'},
            ];
            S.notes[p.id] = {list: [{id:'n1', title:'Plantilla de Brief Creativo'}, {id:'n2', title:'Minuta Reunión TechCorp'}], active:'n1', bodies:{'n1': '<h2>Objetivo de la Campaña:</h2><p>...</p>', 'n2': '<h3>Acuerdos:</h3><p>Se aprueba el presupuesto X.</p>'}};
            S.fin[p.id] = { rows: [ {fecha:new Date(), tipo: 'Ingreso', monto: 1500, cat: 'Anticipo Cliente', nota: 'Factura #001 TechCorp'}, {fecha:new Date(), tipo: 'Egreso', monto: 50, cat: 'Software', nota: 'Suscripción a Figma'} ] };
            break;
    }
    const brandId = 'b' + Date.now();
    S.cronopost.brands = [{id: brandId, name: p.name}];
    S.cronopost.activeBrand = brandId;
    S.cronopost.ideas[brandId] = [{id:'i1', title:'Caso de estudio: Éxito de TechCorp'}, {id:'i2', title:'Tip rápido de marketing digital'}, {id:'i3', title:'Detrás de cámaras de la agencia'}];

    S.hub.jobs = [{id:'j1', title:'Community Manager', company: 'Goatify', pay:'$1,500/mes', desc:'Buscamos a alguien para gestionar nuestras redes sociales.'}];
    S.hub.market = [{id:'m1', name:'Consultoría SEO', price:500, desc: 'Auditoría SEO completa para tu sitio web.'}];
    S.chat.messages = {'r1': [{who: 'Admin', at: new Date(), text: `¡Plantilla para ${industry} cargada! Bienvenidos a todos.`}]};
    addIntis(100, `Plantilla ${industry} cargada`);
    save();
    init(true);
}

// ====== INIT & EVENT LISTENERS ======
function init(isReload = false){
  load();
  lucide.createIcons();
  if (!S.industry && !isReload) industryModal.showModal();
  
  // Navigation Handler
  const handleNav = (hash) => {
    const view = hash.replace('#', '');
    if (view && $(`[data-nav="${view}"]`)) {
      show(view);
    } else if (S.projects.length > 0) {
      const initialProject = S.activeProject && S.projects.find(p => p.id === S.activeProject) ? S.activeProject : S.projects[0].id;
      openProject(initialProject);
    } else {
      show(S.activeNav || 'hub');
    }
  };
  
  $('#nav-list').addEventListener('click', (e) => {
      const link = e.target.closest('a.navBtn');
      if (link && link.dataset.nav) {
          e.preventDefault();
          const view = link.dataset.nav;
          history.pushState({view}, '', `#${view}`);
          show(view);
      }
  });

  window.addEventListener('popstate', (e) => {
      if(e.state && e.state.view) {
          show(e.state.view);
      } else {
          handleNav(window.location.hash);
      }
  });

  handleNav(window.location.hash);

  renderAside();
  
  // Render all global modules to ensure they are populated
  renderCronoPOST();
  renderMkt();
  renderHub();
  renderChat();
  renderMonetization();

  updateTitle();
}


// Wire up all event listeners
$('#newProject').onclick = () => { $('#newProjectModal').showModal(); };
$('#newProjectCancel').onclick = () => { $('#newProjectModal').close(); };
$('#newProjectCreate').onclick = createNewProject;
$('#creditsChip').onclick = () => $('#creditsModal').showModal();
$('#creditsClose').onclick = () => $('#creditsModal').close();
$('#changeIndustryBtn').onclick = (e) => {e.preventDefault(); $('#industryModal').showModal()};
$('#industryClose').onclick = () => $('#industryModal').close();
$('#loadIndustry').onclick = () => {
    const industry = $('#industrySel').value;
    loadIndustryTemplate(industry);
    $('#industryModal').close();
};
$('#themeBtn').onclick=()=>{ 
    const h=document.documentElement; 
    const newTheme = h.getAttribute('data-theme')==='light'?'dark':'light'; 
    h.setAttribute('data-theme', newTheme);
    $('#themeBtn').innerHTML = newTheme === 'light' ? '<i data-lucide="sun"></i>' : '<i data-lucide="moon"></i>';
    lucide.createIcons();
};
$('#menuBtn').onclick=()=>document.body.classList.toggle('aside-open');
wireTabs('#projectShell', 'ptab', 'p-tab');
wireTabs('#hub', 'htab', 'h-htab');
wireTabs('#marketing', 'mtab', 'm-mtab');
wireTabs('#admin', 'atab', 'a-atab');
// Project specific listeners
$('#addFolder').onclick=()=>{ const id=S.activeProject; if(!id)return; const name=prompt('Nombre de la subcarpeta:'); if(name) { (S.folders[id]=S.folders[id]||[]).push(name); save(); openProject(id); }};
$('#quickAdd').onclick=()=>{$('#qaCreate').click()};
$('#vKanban').onclick=()=>{ $('#kanban').style.display='grid'; $('#list').style.display='none'; $('#vKanban').classList.add('active'); $('#vList').classList.remove('active'); };
$('#vList').onclick=()=>{ $('#kanban').style.display='none'; $('#list').style.display='block'; $('#vKanban').classList.remove('active'); $('#vList').classList.add('active'); };

$('#prevM').onclick=()=>{calRef.setMonth(calRef.getMonth()-1); renderCalendar();};
$('#nextM').onclick=()=>{calRef.setMonth(calRef.getMonth()+1); renderCalendar();};
$('#newNote').onclick=()=>{ const id=S.activeProject; if(!id) return; const N=S.notes[id]; const t=prompt('Título de la nota'); if(!t) return; const nid='n'+Date.now(); N.list.push({id:nid,title:t,folder:'General'}); N.active=nid; N.bodies[nid]=''; addIntis(5, 'Nota creada'); save(); renderNotes();};
$$('#p-tab-notes [data-cmd]').forEach(btn=>btn.onclick=()=>document.execCommand(btn.getAttribute('data-cmd'), false, null));
$('#h1Btn').onclick=()=>document.execCommand('formatBlock',false,'h1');
$('#h2Btn').onclick=()=>document.execCommand('formatBlock',false,'h2');
$('#noteMove').onclick=()=>{ const id=S.activeProject; if(!id) return; const note = S.notes[id].list.find(n=>n.id===S.notes[id].active); if(note) { note.folder = $('#noteFolder').value; save(); showToast('Nota movida!', 'success'); }};
$('#fileInput').onchange=(e)=>{ const id=S.activeProject; if(!id) return; for(const f of e.target.files){ S.files[id].push({name:f.name,url:URL.createObjectURL(f), size:f.size}); } addIntis(5, 'Archivo subido'); save(); renderFiles();};
$('#mktFileInput').onchange=(e)=>{ for(const f of e.target.files){ (S.marketing.assets=S.marketing.assets||[]).push({name:f.name,url:URL.createObjectURL(f)}); } save(); renderMkt(); };
$('#newChat').onclick=()=>{ const id=S.activeProject; if(!id)return; const t=prompt('Nuevo hilo de Chat:'); if(t) {S.chats[id].threads.push({id:'c'+Date.now(), title:t}); S.chats[id].messages['c'+Date.now()] = [{who: 'GoatX', at: new Date(), text: '¡Claro! ¿En qué puedo ayudarte con este tema?'}]; save(); renderProjectChat();}};
$('#delChat').onclick=()=>{ const id=S.activeProject; if(!id||!S.chats[id].activeThread||!confirm('¿Borrar hilo?'))return; const C=S.chats[id]; C.threads=C.threads.filter(t=>t.id!==C.activeThread); delete C.messages[C.activeThread]; C.activeThread=null; save(); renderProjectChat();};
$('#sendMsg').onclick=()=>{ const id=S.activeProject; if(!id||!S.chats[id].activeThread)return; const msg=$('#chatMsg').value.trim(); if(!msg)return; const C=S.chats[id]; if(!C.messages[C.activeThread]) C.messages[C.activeThread] = []; C.messages[C.activeThread].push({who:'Tú',at:new Date(),text:msg}); $('#chatMsg').value=''; save(); renderProjectChat();};
$('#chatToTasks').onclick=()=>{ const id=S.activeProject; if(!id)return; const C=S.chats[id]; if(!C.activeThread || C.messages[C.activeThread].length === 0) return showToast('No hay mensajes para convertir', 'warn'); const msg = C.messages[C.activeThread].slice(-1)[0]; if(msg) { S.tasks[id].push({id:'t'+Date.now(),title:'Desde Chat: '+msg.text,status:'Backlog',pri:'Media'}); showToast('Tarea creada desde el chat', 'success'); save(); renderTasks();}};
$('#finNew').onclick=()=>{
  const id=S.activeProject; if(!id) return; const F=S.fin[id];
  const tipo=prompt('Ingreso/Egreso','Ingreso'); const monto=Number(prompt('Monto','0')); const cat=prompt('Categoría','General'); const nota=prompt('Nota','');
  if(!monto) return;
  F.rows.push({fecha:new Date(), tipo, monto, cat, nota}); addIntis(5, 'Movimiento financiero'); save(); renderFin(); renderOverview();
};
$('#finExport').onclick=()=>{ const id=S.activeProject; if(!id) return; const F=S.fin[id]; download(`finanzas_${S.projects.find(p=>p.id===id).name}.csv`, csv([['Fecha','Tipo','Monto','Cat','Nota'], ...F.rows.map(r=>[r.fecha,r.tipo,r.monto,r.cat,r.nota])]));};
$('#newSheet').onclick=()=>{ const id=S.activeProject; if(!id) return; S.tables[id]={cols:['Título','Notas'], rows:[['','']]}; addIntis(10, 'Tabla creada'); save(); renderTables();};
$('#addCol').onclick=()=>{ const id=S.activeProject; if(!id) return; const T=S.tables[id]; const name=prompt('Nombre de columna'); if(!name) return; T.cols.push(name); T.rows.forEach(r=>r.push('')); save(); renderTables();};
$('#addRow').onclick=()=>{ const id=S.activeProject; if(!id) return; const T=S.tables[id]; T.rows.push(new Array(T.cols.length).fill('')); save(); renderTables();};
$('#exportCSV').onclick=()=>{ const id=S.activeProject; if(!id) return; const T=S.tables[id]; download(`tabla_${S.projects.find(p=>p.id===id).name}.csv`, csv([T.cols, ...T.rows]));};
$('#cpAddIdeaBtn').onclick = () => {
    const input = $('#cpNewIdeaInput'); const title = input.value.trim(); if (!title) return;
    const activeBrandId = S.cronopost.activeBrand; if(!activeBrandId) { showToast('Selecciona una marca primero', 'warn'); return; }
    if(!S.cronopost.ideas[activeBrandId]) S.cronopost.ideas[activeBrandId] = [];
    S.cronopost.ideas[activeBrandId].push({ id: 'i' + Date.now(), title });
    addIntis(5, 'Nueva idea de post'); save(); renderCronoPOST(); input.value = '';
};
$('#cpGenAIIdeas').onclick = () => {
    const activeBrandId = S.cronopost.activeBrand; if(!activeBrandId) { showToast('Selecciona una marca primero', 'warn'); return; }
    const brandName = (S.cronopost.brands.find(b=>b.id===activeBrandId) || {}).name || 'tu marca';
    const ideas = [`5 tips sobre ${brandName}`, `Cómo ${brandName} puede ayudarte a...`, `Un error común sobre ${brandName}`];
    if(!S.cronopost.ideas[activeBrandId]) S.cronopost.ideas[activeBrandId] = [];
    ideas.forEach(idea => S.cronopost.ideas[activeBrandId].push({id: 'i'+Date.now()+Math.random(), title: idea}));
    save();
    renderCronoPOST();
    showToast('¡Nuevas ideas generadas por IA!', 'success');
};
$('#cpBrandSelect').onchange = (e) => { S.cronopost.activeBrand = e.target.value; save(); renderCronoPOST(); };
$('#cpPrevM').onclick = () => { cpRef.setMonth(cpRef.getMonth() - 1); renderCronoPOST(); };
$('#cpNextM').onclick = () => { cpRef.setMonth(cpRef.getMonth() + 1); renderCronoPOST(); };
$('#savePerfil').onclick=()=>{
  const isNew = !(S.singleProfile && S.hub.perfil && S.hub.perfil.id);
  const nombre = $('#pNombre').value;
  S.hub.perfil = {id:'u1', nombre: nombre, rol:$('#pRole').value, bio:$('#pBio').value};
  if(isNew) addIntis(50, 'Perfil Creado');
  save(); renderHub(); renderChat(); showToast("Perfil guardado.", "success");
};
$('#addJob').onclick=()=>{ const t=$('#jobTitle').value; if(!t) return; S.hub.jobs.push({id:'j'+Date.now(), title:t, company:$('#jobCompany').value, pay:$('#jobPay').value, desc:$('#jobDesc').value}); addIntis(20, 'Empleo publicado'); save(); renderHub(); };
$('#addMK').onclick=()=>{ const n=$('#mkName').value; if(!n) return; S.hub.market.push({id:'m'+Date.now(), name:n, price:Number($('#mkPrice').value||0), desc:$('#mkDesc').value}); addIntis(20, 'Servicio publicado'); save(); renderHub(); };
$('#sendRoom').onclick = () => {
    const msg = $('#roomMsg').value.trim(); if (!msg) return;
    const myName = S.hub.perfil?.nombre || 'Tú';
    const activeRoomId = S.chat.activeRoom || 'r1';
    if (!S.chat.messages[activeRoomId]) S.chat.messages[activeRoomId] = [];
    S.chat.messages[activeRoomId].push({ who: myName, at: new Date(), text: msg });
    addIntis(2, 'Mensaje enviado');
    save();
    renderChat();
    $('#roomMsg').value = '';
};
$('#briefSave').onclick=()=>{ S.marketing.brief={brand:$('#brandName').value,target:$('#target').value,funnel:$('#funnel').value,notes:$('#briefNotes').value}; save(); showToast("Brief guardado.", "success"); };
$('#genUTM').onclick=()=>{
  const url=$('#offerURL').value.trim(); const name=$('#offerName').value.trim()||'offer';
  if (!url) { 
      if($('#utmOut')) $('#utmOut').textContent = 'Coloca URL base.'; 
      return; 
  }
  const q = new URLSearchParams({utm_source:'goatify',utm_medium:'social',utm_campaign:name.replace(/\s+/g,'_')});
  if($('#utmOut')) $('#utmOut').textContent = `${url}${url.includes('?')?'&':'?'}${q}`;
};
init();
</script>
</body>
</html>

