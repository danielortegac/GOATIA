<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Metadatos para PWA (Progressive Web App) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0D1117">
  <link rel="apple-touch-icon" href="Logos HD.png">
  <link rel="manifest" href="manifest.json">

  <title>Flow by Goatify - Revolucionando la Vida en Condominio</title>
  
  <link rel="icon" href="LOGOS-HD-FAVICON.png" type="image/png">
  
  <!-- SEO Mejorado -->
  <meta name="description" content="Flow revoluciona el real estate y la administración de condominios. Fomentamos comunidad, comercio local y economía circular con total transparencia. Una súper app para la vida moderna en comunidad.">
  <meta name="keywords" content="real estate, administración de condominios, app para residencias, vida en comunidad, economía circular, flow, goatify, inti, moneda digital, gestión de edificios, seguridad residencial, chat vecinal">
  <meta name="author" content="Goatify IA, Daniel y Victor Ortega Corella">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { 'sans': ['Sora', 'sans-serif'] },
          colors: {
            // Dark Theme
            'flow-dark': '#0D1117', 'flow-panel': '#161B22', 'flow-border': '#30363D',
            'text-primary-dark': '#E6EDF3', 'text-secondary-dark': '#8B949E',
            // Light Theme
            'flow-light': '#F6F8FA', 'flow-panel-light': '#FFFFFF', 'flow-border-light': '#D0D7DE',
            'text-primary-light': '#1F2328', 'text-secondary-light': '#656D76',
            // Universal Colors
            'flow-blue': '#58A6FF', 'flow-cyan': '#39C5F7', 'flow-purple': '#BC8EFF',
            'flow-success': '#3FB950', 'flow-danger': '#F85149', 'flow-warning': '#F7B731',
            'inti-coin': '#F7B731',
          },
          boxShadow: { 'glow': '0 0 15px rgba(88, 166, 255, 0.2)' }
        }
      }
    }
  </script>

  <style>
    /* Estilos generales y de transiciones */
    html, body { 
        height: 100%; 
    }
    body { 
      display: flex;
      overflow-x: hidden; /* Previene scroll horizontal */
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .panel, .modal-content { transition: background-color 0.3s, border-color 0.3s; }
    
    /* Estilos Light Mode */
    body { background-color: #F6F8FA; color: #1F2328; }
    .nav-btn, .text-main { color: #1F2328; }
    .sidebar, .panel, .modal-content { background-color: #FFFFFF; border-color: #D0D7DE; }
    .header { background-color: rgba(255,255,255,0.8); }
    .input-field { background-color: #F6F8FA; border-color: #D0D7DE; color: #1F2328;}
    .text-secondary { color: #656D76; }
    
    /* Estilos Dark Mode */
    .dark body { background-color: #0D1117; color: #E6EDF3; }
    .dark .nav-btn, .dark .text-main { color: #E6EDF3; }
    .dark .sidebar, .dark .panel, .dark .modal-content { background-color: #161B22; border-color: #30363D; }
    .dark .header { background-color: rgba(22,27,34,0.8); }
    .dark .input-field { background-color: #0D1117; border-color: #30363D; color: #E6EDF3;}
    .dark .text-secondary { color: #8B949E; }

    /* Estilos de componentes interactivos */
    .nav-btn.active { background-color: rgba(88, 166, 255, 0.1); color: #58A6FF; border-right: 3px solid #58A6FF; font-weight: 700; }
    .btn-primary { background-color: #58A6FF; color: #0D1117; font-weight: 700; transition: all 0.2s ease; transform: translateY(0); }
    .btn-primary:hover { background-color: #79B8FF; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(88, 166, 255, 0.2); }
    .btn-primary:disabled { background-color: #8B949E; cursor: not-allowed; }
    .input-field:focus { outline: none; border-color: #58A6FF; box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2); }
    
    /* Scrollbar personalizado */
    ::-webkit-scrollbar { width: 10px; }
    .dark ::-webkit-scrollbar-track { background: #161B22; }
    .dark ::-webkit-scrollbar-thumb { background: #30363D; border-radius: 5px; border: 2px solid #161B22; }
    .light ::-webkit-scrollbar-track { background: #FFFFFF; }
    .light ::-webkit-scrollbar-thumb { background: #D0D7DE; border-radius: 5px; border: 2px solid #FFFFFF; }
    .dark ::-webkit-scrollbar-thumb:hover { background: #58A6FF; }

    /* Animaciones */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    
    /* --- INICIO DE CORRECCIONES DE LAYOUT Y SIDEBAR --- */

    /* Contenedor principal del contenido */
    #main-content {
        width: 100%;
        margin-left: 16rem; /* Ancho del sidebar (w-64) */
        transition: margin-left 0.3s ease-in-out;
    }
    
    /* Sidebar: Transición de ancho para colapso */
    #sidebar {
        transition: width 0.3s ease-in-out;
    }
    
    /* Scroll para el menú de navegación */
    #nav-menu {
        overflow-y: auto;
    }

    /* Estilos del Sidebar Colapsado (Escritorio) */
    body.sidebar-collapsed #sidebar {
        width: 5rem; /* 80px */
    }
    body.sidebar-collapsed #main-content {
        margin-left: 5rem;
    }
    body.sidebar-collapsed #sidebar .sidebar-text,
    body.sidebar-collapsed #sidebar #profile-btn .ml-3,
    body.sidebar-collapsed #sidebar .role-switcher-container {
        display: none;
    }
    body.sidebar-collapsed #sidebar .h-16 {
        justify-content: center;
    }
    body.sidebar-collapsed #sidebar .nav-btn {
        justify-content: center;
    }
    body.sidebar-collapsed #sidebar .nav-btn .fa-fw {
        margin-left: 0;
    }

    /* Responsividad */
    @media (max-width: 768px) {
        #main-content {
            margin-left: 0; /* Sin margen en móvil */
        }
        #sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 40; /* Asegurar que esté por encima del contenido */
        }
        #sidebar.open {
            transform: translateX(0);
        }
        /* Ignorar estado colapsado en móvil */
        body.sidebar-collapsed #sidebar {
            width: 16rem; /* Restaurar ancho original */
        }
        body.sidebar-collapsed #main-content {
            margin-left: 0;
        }
    }
    /* --- FIN DE CORRECCIONES --- */
    
    /* Estilos del Calendario */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-day { display: flex; flex-direction: column; min-height: 100px; }
    .calendar-event { font-size: 0.65rem; padding: 2px 4px; border-radius: 4px; margin-top: 2px; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; }
    #calendar-tooltip {
        position: absolute;
        display: none;
        background-color: #161B22;
        color: #E6EDF3;
        border: 1px solid #30363D;
        padding: 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        z-index: 100;
        pointer-events: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <!-- Sidebar (Menú Lateral) -->
  <aside id="sidebar" class="sidebar w-64 flex-col p-4 fixed h-full flex">
    <div class="h-16 flex items-center justify-between mb-6 px-2 flex-shrink-0">
      <div class="flex items-center gap-2">
        <img src="Logos HD.png" alt="Flow Logo HD" class="h-12 w-auto">
        <span class="text-2xl font-bold text-main sidebar-text">Flow</span>
      </div>
      <button id="close-sidebar-btn" class="md:hidden text-secondary text-2xl">&times;</button>
    </div>
    <nav id="nav-menu" class="flex-1 space-y-2">
        <!-- El contenido del menú se genera con JS -->
    </nav>
    <div class="mt-auto flex-shrink-0">
        <div class="role-switcher-container p-2 rounded-lg bg-flow-dark dark:bg-flow-dark mb-4 border border-flow-border-light dark:border-flow-border">
            <label for="role-switcher" class="text-xs text-secondary mb-1 block">Vista de Demo</label>
            <select id="role-switcher" class="w-full bg-transparent text-sm rounded focus:outline-none">
                <option value="resident">Residente</option>
                <option value="admin">Administrador</option>
            </select>
        </div>
        <div id="profile-btn" class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-flow-light dark:hover:bg-flow-dark">
            <div class="relative">
                <img id="sidebar-avatar" src="" class="w-10 h-10 rounded-full" alt="User Avatar" />
                <span id="user-status-dot" class="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full ring-2 ring-white dark:ring-flow-panel"></span>
            </div>
            <div class="ml-3">
                <p id="sidebar-name" class="font-semibold text-sm text-main">Cargando...</p>
                <p class="text-xs text-secondary sidebar-text" id="sidebar-role-unit">Residente, Apto. 1204</p>
            </div>
        </div>
    </div>
  </aside>

  <!-- Contenido Principal -->
  <div id="main-content" class="flex-1 flex flex-col h-full">
    <header id="header" class="header flex items-center justify-between p-4 backdrop-blur-sm border-b sticky top-0 z-20 flex-shrink-0">
      <div class="flex items-center gap-4">
        <button id="sidebar-toggle" class="text-main text-xl"><i class="fas fa-bars"></i></button>
        <h2 id="header-title" class="text-xl font-bold text-main">Dashboard</h2>
      </div>
      <div class="flex items-center gap-4 sm:gap-6">
        <button id="about-btn" title="¿Qué es Flow?" class="text-secondary text-xl"><i class="fas fa-question-circle"></i></button>
        <button onclick="showSection('wallet')" title="Billetera Inti" class="text-secondary text-xl"><i class="fas fa-wallet"></i></button>
        <button id="pricing-btn" title="Planes y Precios" class="text-secondary text-xl"><i class="fas fa-rocket"></i></button>
        <button id="theme-toggle" class="text-secondary text-xl"><i class="fas fa-sun"></i></button>
        <div class="relative">
          <button id="notifications-btn" class="text-secondary hover:text-flow-cyan text-xl"><i class="fas fa-bell"></i></button>
          <span id="notifications-badge" class="absolute -top-1 -right-1 bg-flow-danger text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center hidden"></span>
        </div>
        <div class="w-px h-6 bg-flow-border-light dark:bg-flow-border"></div>
        <button id="header-action-container" class="btn-primary flex items-center gap-2 px-4 py-2 rounded-lg text-sm">
            <i id="header-action-icon" class="fas fa-plus-circle"></i>
            <span id="header-action-button">Nuevo Reporte</span>
        </button>
      </div>
    </header>
    <div class="flex-1 overflow-y-auto">
        <main id="content-sections" class="p-4 sm:p-6 lg:p-8"></main>
    </div>
  </div>
  
  <!-- Contenedor de Modales -->
  <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4 transition-opacity duration-300">
      <div id="modal-content" class="modal-content w-full max-w-lg p-6 rounded-xl shadow-lg relative transform transition-all duration-300 scale-95 opacity-0">
      </div>
  </div>
  
  <!-- Pop-up de bienvenida / Footer -->
  <div id="welcome-popup" class="fixed bottom-0 left-0 right-0 bg-flow-panel border-t border-flow-border p-2 text-center z-40 hidden">
    <p class="text-xs text-secondary">
        ¡Bienvenido a <strong>Flow</strong>! La súper app para tu condominio.
        <button id="close-popup-btn" class="ml-4 font-bold text-secondary text-sm">&times;</button>
    </p>
  </div>

  <!-- Tooltip para Calendario -->
  <div id="calendar-tooltip"></div>


<script>
// =======================================================
// SCRIPT DE INTERACTIVIDAD PARA FLOW (VERSIÓN PRO v14 - MODELO DE NEGOCIO Y RED SOCIAL)
// =======================================================

let db = {};
let chartInstance = null;

// --- BASE DE DATOS INICIAL (SIMULACIÓN) ---
function initializeDB() {
    const today = new Date();
    const formatDate = (date) => date.toISOString().split('T')[0];
    const addDays = (date, days) => {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    };

    db = {
        users: [
            { id: 1, name: 'Carlos Andrade', unit: '1204', role: 'resident', avatar: `https://i.pravatar.cc/150?u=carlos`, phone: '0991234567', email: 'carlos.a@email.com', status: 'Solvente', since: '2022-01-15', isBanned: false, residentsCount: 2, social: { instagram: 'carlos_andrade', whatsapp: '593991234567' }, pets: [{id: 1, name: 'Max', type: 'Perro', breed: 'Golden Retriever', status: 'ok'}], intis: 150, parkingSpots: ['A-101'], storageUnit: 'S-23', notifications: [], transactions: [], dependents: [{id: 101, name: 'Ana de Andrade', relation: 'Cónyuge'}, {id: 102, name: 'Pedro Andrade', relation: 'Hijo'}] },
            { id: 2, name: 'Ana Martínez', unit: '801', role: 'resident', avatar: `https://i.pravatar.cc/150?u=ana`, phone: '0987654321', email: 'ana.m@email.com', status: 'Solvente', since: '2021-11-20', isBanned: false, residentsCount: 1, social: { whatsapp: '593987654321' }, pets: [], intis: 250, parkingSpots: ['B-205'], storageUnit: null, notifications: [], transactions: [], dependents: [] },
            { id: 3, name: 'Javier Torres', unit: '502', role: 'resident', avatar: `https://i.pravatar.cc/150?u=javier`, phone: '0976543210', email: 'javier.t@email.com', status: 'Moroso', since: '2023-05-10', isBanned: true, residentsCount: 3, social: { whatsapp: '593976543210' }, pets: [], intis: 10, parkingSpots: ['C-310'], storageUnit: 'S-11', notifications: [], transactions: [], dependents: [] },
            { id: 4, name: 'Lucía Vera', unit: '1101', role: 'resident', avatar: `https://i.pravatar.cc/150?u=lucia`, phone: '0965432109', email: 'lucia.v@email.com', status: 'Solvente', since: '2020-02-28', isBanned: false, residentsCount: 4, social: { instagram: 'lucia_v', whatsapp: '593965432109' }, pets: [{id: 2, name: 'Mishi', type: 'Gato', breed: 'Mestizo', status: 'ok'}], intis: 500, parkingSpots: ['A-112', 'A-113'], storageUnit: 'S-45', notifications: [], transactions: [], dependents: [] },
            { id: 100, name: 'Sofía Vargas', unit: 'Admin', role: 'admin', avatar: `https://i.pravatar.cc/150?u=sofia`, phone: '0999999999', email: 'admin@flow.com', status: 'N/A', since: '2020-01-01', isBanned: false, residentsCount: 1, social: {}, pets: [], intis: 0, notifications: [], transactions: [], dependents: [] },
        ],
        announcements: [
            { id: 1, title: 'Mantenimiento Programado de Ascensores', content: 'Se realizará un mantenimiento preventivo en ambos ascensores el día Lunes, de 9:00 a 13:00. Agradecemos su comprensión.', date: formatDate(addDays(today, -2)) },
        ],
        bookings: [
            { id: 1, amenityId: 'sala_eventos', userId: 1, date: formatDate(addDays(today, 6)), time: '18:00 - 22:00', status: 'Aprobado' },
            { id: 2, amenityId: 'cancha_futbol', userId: 2, date: formatDate(addDays(today, 4)), time: '10:00 - 11:00', status: 'Aprobado' },
            { id: 3, amenityId: 'zona_bbq', userId: 4, date: formatDate(addDays(today, 7)), time: '13:00 - 16:00', status: 'Pendiente' },
            { id: 4, amenityId: 'sala_eventos', userId: 2, date: formatDate(addDays(today, 10)), time: '15:00 - 19:00', status: 'Pendiente' },
        ],
        amenities: [
            { id: 'sala_eventos', name: 'Salón de Eventos', icon: 'fa-champagne-glasses', capacity: 50, image: 'https://images.unsplash.com/photo-1523580494863-6f3031224c94?q=80&w=800&auto=format&fit=crop', rules: 'Costo de $50 por limpieza. Horario hasta 01:00 AM.' },
            { id: 'cancha_futbol', name: 'Cancha de Fútbol', icon: 'fa-futbol', capacity: 10, image: 'https://images.unsplash.com/photo-1551955139-0a12502b5436?q=80&w=800&auto=format&fit=crop', rules: 'Reservas de 1 hora. Uso obligatorio de calzado adecuado.' },
            { id: 'zona_bbq', name: 'Zona BBQ', icon: 'fa-fire-burner', capacity: 15, image: 'https://images.unsplash.com/photo-1558030006-450675393462?q=80&w=800&auto=format&fit=crop', rules: 'El residente es responsable de la limpieza post-uso.' },
        ],
        community: {
            events: [
                { id: 1, name: 'Clase de Yoga', organizerId: 2, description: 'Clase de Vinyasa Yoga para todos los niveles.', location: 'Terraza', date: formatDate(addDays(today, 3)), time: '07:00', cost: { amount: 5, currency: 'USD' }, participants: [1, 4], comments: [{userId: 1, text: '¡Qué buena idea!', time: '10:30'}] },
                { id: 2, name: 'Taller de Cocina', organizerId: 4, description: 'Aprende a hacer pasta fresca desde cero.', location: 'Salón de Eventos', date: formatDate(addDays(today, 8)), time: '18:00', cost: { amount: 150, currency: 'INTIS' }, participants: [], comments: [] }
            ],
            marketplace: [ 
                { id: 101, userId: 1, type: 'Servicio', title: 'Clases de Guitarra', description: 'Ofrezco clases para principiantes.', price: { amount: 100, currency: 'INTIS' } },
            ],
            jobs: [
                { id: 1, userId: 4, title: 'Diseñador Gráfico Jr.', company: 'Agencia Creativa', description: 'Buscamos diseñador con experiencia en Figma y Adobe Suite. Trabajo remoto.', contact: 'lucia.v@email.com' }
            ],
            groups: [
                { id: 1, name: 'Club de Corredores', icon: 'fa-person-running', description: 'Salimos a correr por el parque La Carolina todos los martes y jueves.', members: [1, 4], requests: [] },
            ]
        },
        finances: {
            summary: { income: 22500, expenses: 8500, period: 'Agosto 2025' },
            expense_details: [
                { id: 1, category: 'Seguridad y Vigilancia', amount: 8500, details: 'Contrato mensual con G4S.', date: '2025-08-01' },
            ]
        },
        notifications: [
            { id: 1, type: 'report', text: 'Nuevo reporte de Lucía Vera.', read: false, date: formatDate(today), link: () => showSection('reports') },
        ],
        reports: [
            { id: 1, userId: 4, category: 'Mantenimiento', description: 'La luz del pasillo del piso 11 está parpadeando.', status: 'Sin leer', date: formatDate(today) }
        ],
        rules: { 
            fines: [ { id: 1, userId: 3, reason: 'Ruido excesivo.', amount: 50.00, date: formatDate(addDays(today, -3)) } ],
            pets: [ "Todas las mascotas deben estar registradas en la aplicación." ]
        },
        security: { 
            staff: [ { id: 10, name: 'Luis Cajas', role: 'Guardia Diurno', phone: '0991234567', avatar: `https://i.pravatar.cc/150?u=luis` } ],
            cameras: [ { id: 'cam1', name: 'Lobby Principal', status: 'online' } ]
        },
        parking: {
            visitorSpots: [ {id: 'V1', isAvailable: true, owner: null}, {id: 'V2', isAvailable: false, owner: 2}, {id: 'V3', isAvailable: true, owner: null} ],
            reservations: [ { id: 1, spotId: 'V2', userId: 2, guestName: 'Juan Perez', date: formatDate(today), startTime: '14:00', endTime: '16:00', licensePlate: 'PCX-1234' } ]
        },
        chats: {
            seguridad: { name: 'Canal de Seguridad', icon: 'fa-shield-halved', messages: [{ userId: 100, text: 'Recuerden reportar cualquier actividad sospechosa.', time: '09:00' }] },
            emprendedores: { name: 'Club de Emprendedores', icon: 'fa-lightbulb', messages: [{ userId: 4, text: '¡Hola a todos! Vendo postres caseros, ¿a alguien le interesa?', time: '11:30' }] },
        },
        currentUser: null,
        currentRole: 'resident',
    };
    recalculateFinancialSummary();
}

// --- INICIALIZACIÓN Y MANEJO DE ESTADO ---
document.addEventListener('DOMContentLoaded', () => {
    initializeDB();
    db.currentUser = db.users.find(u => u.role === 'resident');
    
    const themeToggle = document.getElementById('theme-toggle');
    if (localStorage.getItem('theme') === 'light') { document.documentElement.classList.remove('dark'); themeToggle.innerHTML = '<i class="fas fa-moon"></i>'; } 
    else { document.documentElement.classList.add('dark'); themeToggle.innerHTML = '<i class="fas fa-sun"></i>'; }
    themeToggle.addEventListener('click', toggleTheme);

    document.getElementById('role-switcher').addEventListener('change', (e) => switchRole(e.target.value));
    
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');

    sidebarToggle.addEventListener('click', () => {
        if (document.body.clientWidth <= 768) {
            sidebar.classList.add('open');
        } else {
            document.body.classList.toggle('sidebar-collapsed');
        }
    });

    closeSidebarBtn.addEventListener('click', () => {
        sidebar.classList.remove('open');
    });

    document.getElementById('notifications-btn').addEventListener('click', showNotificationsModal);
    document.getElementById('profile-btn').addEventListener('click', () => showSection('profile'));
    document.getElementById('pricing-btn').addEventListener('click', showPricingModal);
    document.getElementById('about-btn').addEventListener('click', showAboutFlowModal);
    
    const popup = document.getElementById('welcome-popup');
    if (!localStorage.getItem('popupDismissed')) {
        popup.classList.remove('hidden');
    }
    document.getElementById('close-popup-btn').addEventListener('click', () => {
        popup.style.display = 'none';
        localStorage.setItem('popupDismissed', 'true');
    });

    checkMonthlyBonus();
    setupApp();
});

function setupApp() {
    const user = db.currentUser;
    document.getElementById('sidebar-avatar').src = user.avatar;
    document.getElementById('sidebar-name').textContent = user.name;
    document.getElementById('sidebar-role-unit').textContent = db.currentRole === 'admin' ? 'Administrador' : `Residente, Apto. ${user.unit}`;
    const statusDot = document.getElementById('user-status-dot');
    statusDot.className = `absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full ring-2 ring-white dark:ring-flow-panel ${user.isBanned ? 'bg-flow-danger' : 'bg-flow-success'}`;
    statusDot.title = user.isBanned ? 'Usuario Sancionado' : 'Usuario Activo';
    
    updateNotificationsBadge();
    renderNavMenu();
    showSection('dashboard');
}

function switchRole(role) {
    db.currentRole = role;
    db.currentUser = role === 'admin' ? db.users.find(u => u.role === 'admin') : db.users[0];
    setupApp();
}

function toggleTheme() {
    const themeToggle = document.getElementById('theme-toggle');
    document.documentElement.classList.toggle('dark');
    if (document.documentElement.classList.contains('dark')) { localStorage.setItem('theme', 'dark'); themeToggle.innerHTML = '<i class="fas fa-sun"></i>'; } 
    else { localStorage.setItem('theme', 'light'); themeToggle.innerHTML = '<i class="fas fa-moon"></i>'; }
}

// --- NAVEGACIÓN Y RENDERIZADO ---
const navConfig = {
    resident: [
        { id: 'dashboard', name: 'Dashboard', icon: 'fa-home' },
        { id: 'calendar', name: 'Calendario', icon: 'fa-calendar-days' },
        { id: 'myUnit', name: 'Mi Unidad', icon: 'fa-door-open' },
        { id: 'residents', name: 'Directorio', icon: 'fa-address-book' },
        { id: 'announcements', name: 'Comunicados', icon: 'fa-bullhorn' },
        { id: 'community', name: 'Comunidad', icon: 'fa-users' },
        { id: 'marketplace', name: 'Marketplace', icon: 'fa-store' },
        { id: 'chat', name: 'Chat Vecinal', icon: 'fa-comments' },
        { id: 'bookings', name: 'Reservar Amenidades', icon: 'fa-calendar-check' },
        { id: 'security', name: 'Seguridad', icon: 'fa-shield-halved' },
        { id: 'wallet', name: 'Billetera Inti', icon: 'fa-wallet' },
        { id: 'pets', name: 'Mascotas', icon: 'fa-paw' },
        { id: 'rules', name: 'Reglamento', icon: 'fa-gavel' },
        { id: 'finances', name: 'Finanzas', icon: 'fa-chart-line' },
        { id: 'benefits', name: 'Beneficios', icon: 'fa-star' },
        { id: 'flowNetwork', name: 'Red Flow', icon: 'fa-network-wired' },
    ],
    admin: [
        { id: 'dashboard', name: 'Dashboard Admin', icon: 'fa-chart-pie' },
        { id: 'calendar', name: 'Calendario General', icon: 'fa-calendar-days' },
        { id: 'residents', name: 'Gestionar Residentes', icon: 'fa-users-cog' },
        { id: 'communityAdmin', name: 'Gestionar Comunidad', icon: 'fa-users-gear' },
        { id: 'amenities', name: 'Configurar Amenidades', icon: 'fa-concierge-bell' },
        { id: 'bookings', name: 'Gestionar Reservas', icon: 'fa-calendar-alt' },
        { id: 'parkingAdmin', name: 'Gestionar Parqueos', icon: 'fa-car' },
        { id: 'chat', name: 'Moderar Chat', icon: 'fa-comments' },
        { id: 'reports', name: 'Gestionar Reportes', icon: 'fa-triangle-exclamation' },
        { id: 'security', name: 'Seguridad', icon: 'fa-shield-halved' },
        { id: 'announcements', name: 'Gestionar Comunicados', icon: 'fa-bullhorn' },
        { id: 'rules', name: 'Gestionar Sanciones', icon: 'fa-gavel' },
        { id: 'finances', name: 'Finanzas', icon: 'fa-file-invoice-dollar' },
    ]
};

function renderNavMenu() {
    const menu = document.getElementById('nav-menu');
    menu.innerHTML = '';
    const items = navConfig[db.currentRole];
    items.forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'nav-btn w-full text-left p-3 rounded-lg flex items-center font-semibold text-sm transition-all duration-200 hover:bg-flow-border/10';
        btn.dataset.target = item.id;
        btn.innerHTML = `<i class="fas ${item.icon} fa-fw w-6 text-lg text-secondary"></i><span class="ml-3 sidebar-text">${item.name}</span>`;
        btn.onclick = () => showSection(item.id);
        menu.appendChild(btn);
    });
}

function showSection(sectionId) {
    if (document.body.clientWidth <= 768) {
        document.getElementById('sidebar').classList.remove('open');
    }

    const container = document.getElementById('content-sections');
    
    let renderFunctionName;
    if (sectionId === 'residents') {
        renderFunctionName = db.currentRole === 'admin' ? 'renderAdminResidents' : 'renderResidents';
    } else {
        renderFunctionName = `render${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`;
    }
    
    const renderFunction = window[renderFunctionName];
    if (renderFunction) {
        container.innerHTML = `<div class="fade-in">${renderFunction()}</div>`;
    }

    const navItem = navConfig[db.currentRole].find(item => item.id === sectionId) || navConfig.admin.find(item => item.id === sectionId);
    document.getElementById('header-title').textContent = navItem ? navItem.name : 'Perfil';

    const actions = {
        residents: db.currentRole === 'admin' ? { text: 'Agregar Residente', icon: 'fa-user-plus', handler: () => showAddResidentModal() } : { text: 'Nuevo Reporte', icon: 'fa-exclamation-triangle', handler: showNewReportModal },
        community: { text: 'Crear Evento', icon: 'fa-calendar-plus', handler: showCreateEventModal },
        marketplace: { text: 'Publicar Anuncio', icon: 'fa-plus', handler: showCreateMarketplacePostModal },
        announcements: db.currentRole === 'admin' ? { text: 'Nuevo Comunicado', icon: 'fa-plus', handler: () => showAnnouncementModal() } : { text: 'Nuevo Reporte', icon: 'fa-exclamation-triangle', handler: showNewReportModal },
        rules: db.currentRole === 'admin' ? { text: 'Añadir Sanción', icon: 'fa-plus', handler: showAddFineModal } : { text: 'Nuevo Reporte', icon: 'fa-exclamation-triangle', handler: showNewReportModal },
        amenities: { text: 'Añadir Amenidad', icon: 'fa-plus', handler: () => showAmenityModal() },
        pets: { text: 'Añadir Mascota', icon: 'fa-plus', handler: () => showPetModal() },
        myUnit: { text: 'Añadir Dependiente', icon: 'fa-user-plus', handler: () => showDependentModal() },
        parkingAdmin: { text: 'Añadir Parqueo', icon: 'fa-plus-circle', handler: () => addVisitorSpot() },
        communityAdmin: { text: 'Crear Nuevo Grupo', icon: 'fa-plus-circle', handler: () => showCreateGroupModal() },
        finances: db.currentRole === 'admin' ? { text: 'Añadir Gasto', icon: 'fa-plus', handler: () => showExpenseModal() } : { text: 'Nuevo Reporte', icon: 'fa-exclamation-triangle', handler: showNewReportModal },
        default: { text: 'Nuevo Reporte', icon: 'fa-exclamation-triangle', handler: showNewReportModal }
    };
    const action = actions[sectionId] || actions.default;
    const actionContainer = document.getElementById('header-action-container');
    document.getElementById('header-action-button').textContent = action.text;
    document.getElementById('header-action-icon').className = `fas ${action.icon}`;
    actionContainer.onclick = action.handler;

    if (sectionId === 'dashboard' && db.currentRole === 'admin') {
        setTimeout(renderAdminChart, 50);
    }
    if (sectionId === 'calendar') {
        setTimeout(() => renderCalendarView('calendar-container'), 50);
    }
    
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.nav-btn[data-target="${sectionId}"]`)?.classList.add('active');
}

// --- MANEJO DE MODALES Y NOTIFICACIONES ---
const modalContainer = document.getElementById('modal-container');
const modalContent = document.getElementById('modal-content');

function showModal(content, callback) { modalContent.innerHTML = content; modalContainer.classList.remove('hidden'); modalContainer.classList.add('flex'); setTimeout(() => { modalContent.classList.remove('scale-95', 'opacity-0'); }, 10); if (callback) callback(); }
function hideModal() { modalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => { modalContainer.classList.add('hidden'); modalContainer.classList.remove('flex'); modalContent.innerHTML = ''; }, 300); }
modalContainer.addEventListener('click', (e) => { if (e.target === modalContainer) hideModal(); });

function addNotification(type, text, link, userId = null) {
    const newNotif = { id: Date.now(), type, text, read: false, date: new Date().toISOString().split('T')[0], link };
    if (userId) {
        const user = db.users.find(u => u.id === userId);
        if (user) { user.notifications.unshift(newNotif); }
    } else { // Notificación para admin
        const admin = db.users.find(u => u.role === 'admin');
        if(admin) admin.notifications.unshift(newNotif);
    }
    updateNotificationsBadge();
}

function updateNotificationsBadge() {
    const user = db.currentUser;
    const badge = document.getElementById('notifications-badge');
    const notifications = user.notifications || [];
    const unreadCount = notifications.filter(n => !n.read).length;

    if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

function showNotificationsModal() {
    const user = db.currentUser;
    const notifications = user.notifications || [];
    const icons = { report: 'fa-exclamation-triangle', booking: 'fa-calendar-check', payment: 'fa-file-invoice-dollar', group_join: 'fa-users', panic: 'fa-bell', reward: 'fa-star', event_creation: 'fa-calendar-plus', message: 'fa-comment-dots' };
    const colors = { report: 'text-flow-danger', booking: 'text-flow-blue', payment: 'text-flow-success', group_join: 'text-flow-purple', panic: 'text-flow-danger', reward: 'text-inti-coin', event_creation: 'text-flow-purple', message: 'text-flow-cyan' };
    
    const notificationsHTML = notifications.length > 0 ? notifications.map((n, index) => `
        <div onclick="handleNotificationClick(${index})" class="flex items-start gap-3 p-3 border-b border-flow-border-light dark:border-flow-border cursor-pointer ${!n.read ? 'bg-flow-blue/10' : ''}">
            <i class="fas ${icons[n.type] || 'fa-info-circle'} ${colors[n.type] || 'text-secondary'} mt-1"></i>
            <div class="flex-1"><p class="text-sm text-main">${n.text}</p><p class="text-xs text-secondary">${n.date}</p></div>
            ${!n.read ? '<div class="w-2 h-2 bg-flow-blue rounded-full self-center"></div>' : ''}
        </div>
    `).join('') : '<p class="text-center text-secondary p-4">No tienes notificaciones.</p>';

    showModal(`<button onclick="hideModal()" class="absolute top-4 right-4 text-secondary hover:text-main text-2xl">&times;</button><h2 class="text-2xl font-bold mb-4 text-main">Notificaciones</h2><div class="max-h-96 overflow-y-auto">${notificationsHTML}</div><button onclick="markAllAsRead()" class="text-sm text-flow-blue font-semibold mt-4">Marcar todas como leídas</button>`);
}

function handleNotificationClick(index) {
    const notifications = db.currentUser.notifications || [];
    const notification = notifications[index];
    notification.read = true;
    hideModal();
    if (notification.link) { notification.link(); }
    updateNotificationsBadge();
}

function markAllAsRead() { 
    const notifications = db.currentUser.notifications || [];
    notifications.forEach(n => n.read = true); 
    updateNotificationsBadge(); 
    hideModal(); 
}

// --- SISTEMA DE RECOMPENSAS Y TRANSACCIONES INTI ---
function addTransaction(userId, type, description, amount, from, to) {
    const user = db.users.find(u => u.id === userId);
    if (user) {
        if (!user.transactions) user.transactions = [];
        user.transactions.unshift({
            id: Date.now(),
            date: new Date().toISOString().split('T')[0],
            type,
            description,
            amount,
            from,
            to
        });
    }
}

function checkMonthlyBonus() {
    const user = db.users.find(u => u.role === 'resident' && u.status === 'Solvente');
    if (user) {
        user.intis += 50;
        addTransaction(user.id, 'reward', 'Bonus mensual por pago puntual', 50, 'Sistema', user.name);
        addNotification('reward', '¡Recibiste 50 Intis por tu pago puntual!', () => showSection('wallet'), user.id);
    }
}

// --- RENDERIZADO DE MÓDULOS ---
function renderDashboard() { if (db.currentRole === 'admin') return renderAdminDashboard(); return `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 space-y-6"><div class="panel p-6 rounded-lg"><h3 class="font-bold text-lg text-main mb-2">Último Comunicado</h3><h4 class="font-semibold text-flow-cyan mb-2">${db.announcements[0].title}</h4><p class="text-sm text-secondary">${db.announcements[0].content}</p></div><div class="panel p-6 rounded-lg"><h3 class="font-bold text-lg mb-4 text-main">Mi Billetera Inti</h3><div class="flex items-center justify-between"><div class="flex items-center gap-3"><i class="fas fa-coins text-4xl text-inti-coin"></i><div><p class="text-2xl font-bold text-main">${db.currentUser.intis}</p><p class="text-sm text-secondary">Intis</p></div></div><button onclick="showSection('wallet')" class="btn-primary px-4 py-2 rounded-lg text-sm">Ver Billetera</button></div></div></div><div class="space-y-6"><div class="panel p-6 rounded-lg"><h3 class="font-bold text-lg mb-4 text-main">Mis Próximas Reservas</h3>${db.bookings.filter(b => b.userId === db.currentUser.id && new Date(b.date) >= new Date()).slice(0, 3).map(b => { const a = db.amenities.find(am => am.id === b.amenityId); return `<div class="flex items-center gap-4 mb-3"><div class="bg-flow-light dark:bg-flow-dark w-12 h-12 rounded-lg flex items-center justify-center"><i class="fas ${a.icon} text-xl text-flow-blue"></i></div><div><p class="font-semibold text-main">${a.name}</p><p class="text-xs text-secondary">${b.date}</p></div></div>` }).join('') || '<p class="text-sm text-secondary">No tienes reservas próximas.</p>'} <button onclick="showSection(\'calendar\')" class="text-sm text-flow-blue font-semibold mt-4 w-full text-center">Ver Calendario Completo &rarr;</button></div></div></div>`; }
function renderCommunity() { return `<div class="space-y-8"><div><h2 class="text-3xl font-extrabold text-main mb-1">Conecta con tu Comunidad</h2><p class="text-secondary mb-6">Participa, colabora y haz de este un mejor lugar para vivir.</p></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2 space-y-8"><div><h3 class="text-2xl font-bold text-main mb-4">Grupos de Interés</h3><div id="groups-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">${db.community.groups.map(renderGroupCard).join('')}</div></div><div><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold text-main">Eventos de la Comunidad</h3><button onclick="showCreateEventModal()" class="btn-primary px-4 py-2 rounded-lg text-sm">Crear Evento</button></div><div id="events-list" class="space-y-4">${db.community.events.map(renderEventCard).join('')}</div></div></div><div class="space-y-6"><div class="panel p-6 rounded-lg"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-xl">Bolsa de Empleo</h3><button onclick="showJobPostModal()" class="btn-primary px-4 py-2 rounded-lg text-sm">Publicar Oferta</button></div><div id="jobs-list" class="space-y-4">${db.community.jobs.map(renderJobCard).join('') || '<p class="text-sm text-secondary">No hay ofertas de empleo.</p>'}</div></div></div></div></div>`; }
function renderMarketplace() { return `<div><div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-extrabold text-main">Marketplace Vecinal</h2><button onclick="showCreateMarketplacePostModal()" class="btn-primary px-4 py-2 rounded-lg text-sm">Publicar (+5 Intis)</button></div><div id="marketplace-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${db.community.marketplace.map(renderMarketplaceCard).join('')}</div></div>`; }
function renderBenefits() { const b = [ { name: 'Goatify IA - Suscripción Pro', icon: 'fa-robot', description: 'Accede a herramientas de IA de vanguardia.', link: 'https://www.goatify.app/IA', color: 'text-flow-purple', cost: 500 }, { name: 'Goatify Web - Página Web', icon: 'fa-desktop', description: 'Descuentos en diseño y desarrollo web.', link: 'https://www.goatify.app/web', color: 'text-flow-cyan', cost: 1200 }, { name: 'Centro Iberoamericano', icon: 'fa-graduation-cap', description: 'Certifícate en IA & Marketing Digital.', link: 'https://www.ibero.education/oferta-acad%C3%A9mica/certificaciones/ia-marketing-digital', color: 'text-flow-blue', cost: 2500 }, { name: 'Club Pa\' la Raza', icon: 'fa-film', description: 'Funciones exclusivas de cine al aire libre.', link: 'https://www.palaraza.club/servicios/eventos/cine-al-aire-libre', color: 'text-flow-warning', cost: 300 }, { name: 'Villa Permacultural', icon: 'fa-leaf', description: 'Tarifas especiales en hospedajes Glamping.', link: 'https://www.villa-permacultural.com', color: 'text-flow-success', cost: 800 } ]; return `<div class="max-w-5xl mx-auto text-center"><i class="fas fa-star text-5xl text-inti-coin mb-4"></i><h2 class="text-4xl font-extrabold mb-4 text-main">Tus Beneficios Exclusivos</h2><p class="text-secondary mb-10">¡Usa tus <strong>Intis</strong> para canjear productos, servicios y obtener descuentos únicos con nuestras marcas aliadas!</p><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${b.map(ben => `<div class="panel p-6 rounded-lg text-left flex flex-col justify-between hover:shadow-glow hover:-translate-y-1 transition-all"><div class="flex-grow"><i class="fas ${ben.icon} text-3xl ${ben.color} mb-4"></i><h3 class="font-bold text-xl mb-2 text-main">${ben.name}</h3><p class="text-sm text-secondary mb-4">${ben.description}</p></div><div><div class="flex justify-between items-center border-t pt-3 mt-3"><p class="font-bold text-sm text-inti-coin flex items-center gap-1"><i class="fas fa-coins"></i> ${ben.cost}</p><a href="${ben.link}" target="_blank" class="font-bold text-sm text-flow-blue">Saber Más</a></div><button onclick="showPurchaseConfirmationModal('benefit', '${ben.name}')" class="btn-primary w-full mt-3 py-2 text-sm">Canjear</button></div></div>`).join('')}</div></div>`; }
function renderWallet() { return `<div class="space-y-8"><div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start"><div class="panel p-6 rounded-lg text-center"><h3 class="font-bold text-xl mb-4">Mi Billetera</h3><i class="fas fa-coins text-6xl text-inti-coin"></i><p class="text-5xl font-bold my-4">${db.currentUser.intis} <span class="text-2xl text-secondary">Intis</span></p><p class="text-sm text-secondary mb-6">Usa tus Intis para obtener descuentos o transfiérelos a otros residentes.</p><button onclick="showTransferModal()" class="btn-primary w-full py-3 rounded-lg">Transferir Intis</button></div><div class="panel p-6 rounded-lg"><h3 class="font-bold text-xl mb-4">¿Qué es el Inti?</h3><p class="text-sm text-secondary mb-3">El Inti es nuestra moneda digital exclusiva, creada para fortalecer nuestra comunidad y ofrecerte beneficios tangibles.</p><ul class="space-y-3 text-sm"><li class="flex items-start gap-3"><i class="fas fa-dollar-sign text-flow-danger mt-1"></i><div><strong class="text-main">Ahorra Dinero Real:</strong> Usar Intis es más económico que usar dólares para muchos servicios dentro de la comunidad.</div></li><li class="flex items-start gap-3"><i class="fas fa-rocket text-flow-purple mt-1"></i><div><strong class="text-main">Fomenta la Comunidad:</strong> Al usar Intis, apoyas a tus vecinos emprendedores y participas en una economía circular.</div></li><li class="flex items-start gap-3"><i class="fas fa-gift text-flow-success mt-1"></i><div><strong class="text-main">Gana Recompensas:</strong> Recibes Intis por ser un buen vecino: pagando a tiempo, publicando en el marketplace, y mucho más.</div></li></ul></div></div><div class="panel p-6 rounded-lg"><h3 class="font-bold text-xl mb-4">Historial de Transacciones</h3><div id="transaction-history" class="space-y-3 max-h-96 overflow-y-auto">${renderTransactionHistory()}</div></div></div>`; }
function renderPets() { const userPets = db.currentUser.pets; return `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 space-y-6"><div><h3 class="font-bold text-xl mb-4">Mis Mascotas</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${userPets.length > 0 ? userPets.map(renderMyPetCard).join('') : '<p class="text-secondary text-sm">No has registrado ninguna mascota.</p>'}</div></div><div><h3 class="font-bold text-xl mb-4">Reglamento de Mascotas</h3><div class="panel p-6 rounded-lg"><ul class="list-disc list-inside space-y-2 text-sm text-secondary">${db.rules.pets.map(rule => `<li>${rule}</li>`).join('')}</ul></div></div></div><div class="panel p-6 rounded-lg"><h3 class="font-bold text-xl mb-2">Finalidad del Módulo</h3><p class="text-sm text-secondary mb-4">El registro de mascotas nos ayuda a:</p><ul class="space-y-3 text-sm"><li class="flex items-start gap-3"><i class="fas fa-bolt text-flow-warning mt-1"></i><div><strong class="text-main">Actuar rápido:</strong> En caso de pérdida, tener su foto y datos a la mano es crucial.</div></li><li class="flex items-start gap-3"><i class="fas fa-handshake-angle text-flow-success mt-1"></i><div><strong class="text-main">Mejorar la convivencia:</strong> Conocer a las mascotas del edificio fomenta una comunidad más responsable.</div></li><li class="flex items-start gap-3"><i class="fas fa-shield-halved text-flow-blue mt-1"></i><div><strong class="text-main">Seguridad:</strong> Permite al personal identificar qué mascotas pertenecen al conjunto.</div></li></ul><button onclick="showLostPetModal()" class="btn-primary w-full py-2 rounded-lg text-sm mt-6">Reportar Mascota Perdida</button></div></div>`; }
function renderFinances() { if (db.currentRole === 'admin') return renderAdminFinances(); const f = db.finances.summary; const d = db.finances.expense_details; const balance = f.income - f.expenses; return `<div class="panel p-6 rounded-lg max-w-5xl mx-auto"><div class="border-b pb-4 mb-6"><h3 class="font-bold text-2xl">Finanzas del Conjunto</h3><p class="text-secondary text-sm">Transparencia para el periodo de ${f.period}</p></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6"><div class="panel p-4 rounded-lg bg-flow-success/10"><p class="text-sm font-semibold">Ingresos Totales</p><p class="text-3xl font-bold text-main">$${f.income.toLocaleString()}</p></div><div class="panel p-4 rounded-lg bg-flow-danger/10"><p class="text-sm font-semibold">Egresos Totales</p><p class="text-3xl font-bold text-main">$${f.expenses.toLocaleString()}</p></div><div class="panel p-4 rounded-lg ${balance >= 0 ? 'bg-flow-blue/10' : 'bg-flow-warning/10'}"><p class="text-sm font-semibold">Balance del Periodo</p><p class="text-3xl font-bold text-main">$${balance.toLocaleString()}</p></div></div><div><h4 class="font-bold text-xl mb-4">Desglose Detallado de Gastos</h4><div class="space-y-3">${d.map(e => `<div class="p-4 bg-flow-light dark:bg-flow-dark rounded-lg"><div class="flex justify-between items-center"><p class="font-bold text-main">${e.category}</p><p class="font-bold text-lg text-flow-danger">$${e.amount.toLocaleString()}</p></div><p class="text-xs text-secondary mt-1">${e.details}</p></div>`).join('')}</div></div></div>`; }
function renderMyUnit() { const u = db.currentUser; return `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 space-y-6"><div class="panel p-6 rounded-lg"><h3 class="font-bold text-xl mb-4">Información de mi Propiedad</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"><div class="bg-flow-light dark:bg-flow-dark p-4 rounded-lg"><p class="text-xs text-secondary font-semibold">UNIDAD</p><p class="text-lg font-bold">${u.unit}</p></div><div class="bg-flow-light dark:bg-flow-dark p-4 rounded-lg"><p class="text-xs text-secondary font-semibold">BODEGA</p><p class="text-lg font-bold">${u.storageUnit || 'No asignada'}</p></div><div class="md:col-span-2 bg-flow-light dark:bg-flow-dark p-4 rounded-lg"><p class="text-xs text-secondary font-semibold">ESTACIONAMIENTOS</p><div class="flex gap-2 mt-1">${u.parkingSpots.map(p => `<span class="font-bold text-lg bg-flow-panel-light dark:bg-flow-panel border px-3 py-1 rounded">${p}</span>`).join('')}</div></div></div></div><div class="panel p-6 rounded-lg"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-xl">Dependientes</h3><button onclick="showDependentModal()" class="btn-primary px-3 py-1 text-xs rounded-lg">Añadir</button></div><div id="dependents-list" class="space-y-2">${u.dependents.length > 0 ? u.dependents.map(d => `<div class="flex justify-between items-center p-2 bg-flow-light dark:bg-flow-dark rounded-md"><p class="text-sm font-semibold">${d.name} <span class="text-xs text-secondary">(${d.relation})</span></p><div><button onclick="showDependentModal(${d.id})" class="text-flow-blue text-xs mr-2"><i class="fas fa-edit"></i></button><button onclick="deleteDependent(${d.id})" class="text-flow-danger text-xs"><i class="fas fa-trash"></i></button></div></div>`).join('') : '<p class="text-xs text-secondary">No hay dependientes registrados.</p>'}</div></div></div><div class="panel p-6 rounded-lg lg:col-span-3"><h3 class="font-bold text-xl mb-4">Parqueo de Visitas</h3><p class="text-sm text-secondary mb-4">Reserva un espacio para tus invitados (máx. 2 horas).</p><div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">${db.parking.visitorSpots.map(p => `<div class="p-3 rounded-lg flex flex-col justify-center items-center ${p.isAvailable ? 'bg-flow-success/10' : 'bg-flow-danger/10'}"><span class="font-bold text-sm">Espacio ${p.id}</span><span class="text-xs font-semibold px-2 py-1 mt-1 rounded-full ${p.isAvailable ? 'bg-flow-success text-white' : 'bg-flow-danger text-white'}">${p.isAvailable ? 'Disponible' : 'Ocupado'}</span></div>`).join('')}</div><button onclick="showVisitorParkingModal()" class="btn-primary w-full max-w-xs mx-auto mt-6 py-2 rounded-lg text-sm block">Reservar Espacio</button></div></div>`; }
function renderSecurity() { return `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 panel p-6 rounded-lg"><h3 class="font-bold text-xl mb-4">Cámaras de Seguridad</h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${db.security.cameras.map(c => `<div class="aspect-video bg-flow-dark rounded-lg flex flex-col justify-between p-2 text-white"><div class="flex justify-between items-center"><span class="text-xs font-semibold">${c.name}</span><span class="flex items-center gap-1 text-xs ${c.status === 'online' ? 'text-flow-success' : 'text-flow-danger'}"><i class="fas fa-circle text-[8px]"></i> ${c.status}</span></div><i class="fas fa-video text-4xl text-center text-gray-500"></i><div></div></div>`).join('')}</div></div><div class="space-y-6"><div class="panel p-6 rounded-lg"><h3 class="font-bold text-xl mb-4">Personal de Guardia</h3><div class="space-y-4">${db.security.staff.map(s => `<div class="flex items-center gap-4"><img src="${s.avatar}" class="w-12 h-12 rounded-full"><div class="flex-1"><p class="font-bold text-main">${s.name}</p><p class="text-sm text-secondary">${s.role}</p></div><a href="tel:${s.phone}" class="w-10 h-10 flex items-center justify-center rounded-full bg-flow-light dark:bg-flow-dark hover:bg-flow-blue/20"><i class="fas fa-phone text-flow-blue"></i></a></div>`).join('')}</div></div><div class="panel p-6 rounded-lg text-center bg-flow-danger/10 border border-flow-danger/20"><h3 class="font-bold text-xl mb-2 text-flow-danger">Botón de Pánico</h3><p class="text-sm text-secondary mb-4">Úsalo solo en emergencias reales. Se notificará a seguridad y al 911.</p><button onclick="triggerPanicButton()" class="w-20 h-20 bg-flow-danger rounded-full flex items-center justify-center text-white shadow-lg animate-pulse"><i class="fas fa-bell text-3xl"></i></button></div></div></div>`; }
function renderChat() { const isAdmin = db.currentRole === 'admin'; return `<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-[calc(100vh - 200px)]"><div class="lg:col-span-1 panel p-4 rounded-lg flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">Canales</h3> ${isAdmin ? '<button onclick="showCreateChannelModal()" class="text-flow-blue text-xl"><i class="fas fa-plus-circle"></i></button>' : ''}</div><div class="flex-1 space-y-2" id="chat-channels-list">${Object.keys(db.chats).map(key => `<div class="flex items-center"><button onclick="switchChatChannel('${key}')" id="chat-channel-${key}" class="flex-1 text-left p-3 rounded-lg flex items-center gap-3 hover:bg-flow-light dark:hover:bg-flow-dark"><i class="fas ${db.chats[key].icon} text-secondary"></i><span class="font-semibold sidebar-text">${db.chats[key].name}</span></button>${isAdmin && key !== 'seguridad' ? `<button onclick="deleteChannel('${key}')" class="text-flow-danger p-2 ml-1"><i class="fas fa-trash"></i></button>` : ''}</div>`).join('')}</div></div><div class="lg:col-span-3 panel rounded-lg flex flex-col p-4"><div id="chat-rules" class="p-3 mb-4 rounded-lg bg-flow-blue/10 border"><h4 class="font-bold text-main mb-1">Reglas del Chat:</h4><ul class="list-disc list-inside text-sm text-secondary"><li>Ser respetuoso y cordial con todos los vecinos.</li><li>No compartir información falsa o spam.</li><li>Utilizar los canales para sus temas correspondientes.</li></ul><p class="mt-2 text-xs">El administrador puede moderar los mensajes y aplicar sanciones.</p></div><div id="chat-messages" class="flex-1 overflow-y-auto mb-4 space-y-4 p-2"></div><form id="chat-form" class="flex gap-3"><input type="text" name="message" placeholder="Escribe un mensaje..." class="input-field flex-1 p-3 rounded-lg" required><button type="submit" class="btn-primary px-5 rounded-lg"><i class="fas fa-paper-plane"></i></button></form></div></div>`; }
function renderFlowNetwork() { return `<div class="panel p-8 rounded-lg max-w-4xl mx-auto text-center"><i class="fas fa-network-wired text-5xl text-flow-cyan mb-4"></i><h2 class="text-4xl font-extrabold mb-4 text-main">Bienvenido a la Red Flow</h2><p class="text-secondary mb-6">Estamos construyendo la primera red social de condominios.</p><div class="text-left space-y-4 text-secondary"><p>Imagina poder conectar con otras comunidades que también usan Flow. Nuestra visión es crear un ecosistema interconectado donde los condominios puedan:</p><ul class="list-disc list-inside space-y-2 pl-4 mt-4"><li><strong>Organizar eventos más grandes:</strong> Ferias, campeonatos deportivos o celebraciones conjuntas entre varios condominios.</li><li><strong>Ampliar el Marketplace:</strong> ¿No encuentras lo que buscas en tu comunidad? Accede a los productos y servicios de condominios vecinos.</li><li><strong>Crear alianzas:</strong> Gestionar compras al por mayor de servicios (como seguridad o internet) para obtener mejores precios para todos.</li><li><strong>Compartir experiencias:</strong> Las directivas y administradores podrán compartir conocimientos y mejores prácticas para una mejor gestión.</li></ul><p class="mt-4 font-semibold text-main">Esta funcionalidad está en desarrollo y será una de las grandes ventajas de pertenecer a la comunidad Flow. ¡Prepárate para llevar la vida en comunidad al siguiente nivel!</p></div></div>`; }

// --- MÓDULOS DE ADMINISTRADOR Y RESIDENTES ---
function renderAdminDashboard() { const pB = db.bookings.filter(b => b.status === 'Pendiente').length; const uR = db.reports.filter(r => r.status === 'Sin leer').length; const tF = db.rules.fines.reduce((a, f) => a + f.amount, 0); return `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6"><a href="#" onclick="showSection('bookings')" class="panel p-4 rounded-lg block hover:bg-flow-light dark:hover:bg-flow-dark"><p class="text-sm text-secondary">Reservas Pendientes</p><p class="text-2xl font-bold text-main">${pB}</p></a><a href="#" onclick="showSection('reports')" class="panel p-4 rounded-lg block hover:bg-flow-light dark:hover:bg-flow-dark"><p class="text-sm text-secondary">Reportes sin Leer</p><p class="text-2xl font-bold text-main">${uR}</p></a><div class="panel p-4 rounded-lg"><p class="text-sm text-secondary">Total en Multas</p><p class="text-2xl font-bold text-flow-danger">$${tF.toLocaleString()}</p></div><div class="panel p-4 rounded-lg"><p class="text-sm text-secondary">Morosidad</p><p class="text-2xl font-bold text-main">12%</p></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 panel p-6 rounded-lg"><h3 class="font-bold text-xl mb-4 text-main">Feed de Actividad Reciente</h3><div class="space-y-3">${db.notifications.slice(0, 5).map(n => `<div class="flex items-center gap-3"><i class="fas ${ {report: 'fa-exclamation-triangle', booking: 'fa-calendar-check', group_join: 'fa-users'}[n.type] } text-secondary"></i><p class="text-sm text-main flex-1">${n.text}</p><span class="text-xs text-secondary">${n.date}</span></div>`).join('')}</div></div><div class="panel p-6 rounded-lg"><h3 class="font-bold text-xl mb-4 text-main">Desglose de Egresos</h3><canvas id="expensesChart"></canvas></div></div>`; }
function renderCalendar() { return `<div class="panel p-6 rounded-lg"><div id="calendar-container"></div></div>`; }
function renderCommunityAdmin() { return `<div class="panel p-6 rounded-lg"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-xl">Gestionar Grupos de Interés</h3><button onclick="showCreateGroupModal()" class="btn-primary px-4 py-2 rounded-lg text-sm">Crear Nuevo Grupo</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6">${db.community.groups.map(renderAdminGroupCard).join('')}</div></div>`; }
function renderAdminFinances() { const f = db.finances.summary; const d = db.finances.expense_details; const balance = f.income - f.expenses; return `<div class="panel p-6 rounded-lg max-w-5xl mx-auto"><div class="border-b pb-4 mb-6"><h3 class="font-bold text-2xl">Gestión Financiera</h3><p class="text-secondary text-sm">Periodo: ${f.period}</p></div><div class="p-4 rounded-lg bg-flow-blue/10 mb-6"><h4 class="font-semibold text-main">Compromiso con la Transparencia</h4><p class="text-sm text-secondary mt-1">Los egresos son gestionados manualmente para asegurar la correcta asignación de fondos. Cada gasto es visible para todos los residentes, promoviendo una comunidad informada y confiable.</p></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6"><div class="panel p-4 rounded-lg"><p class="text-sm font-semibold">Ingresos (Automático)</p><p class="text-3xl font-bold text-flow-success">$${f.income.toLocaleString()}</p></div><div class="panel p-4 rounded-lg"><p class="text-sm font-semibold">Egresos (Editable)</p><p class="text-3xl font-bold text-flow-danger">$${f.expenses.toLocaleString()}</p></div><div class="panel p-4 rounded-lg"><p class="text-sm font-semibold">Balance Actual</p><p class="text-3xl font-bold ${balance >= 0 ? 'text-main' : 'text-flow-danger'}">$${balance.toLocaleString()}</p></div></div><div><div class="flex justify-between items-center mb-4"><h4 class="font-bold text-xl">Registro de Egresos</h4><button onclick="showExpenseModal()" class="btn-primary text-sm px-4 py-2 rounded-lg flex items-center gap-2"><i class="fas fa-plus"></i>Añadir Gasto</button></div><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead><tr class="border-b"><th class="p-2">Fecha</th><th class="p-2">Categoría</th><th class="p-2">Monto</th><th class="p-2 hidden md:table-cell">Detalle</th><th class="p-2">Acciones</th></tr></thead><tbody>${d.map(e => `<tr><td class="p-2">${e.date}</td><td class="p-2 font-semibold">${e.category}</td><td class="p-2 text-flow-danger font-bold">$${e.amount.toLocaleString()}</td><td class="p-2 text-xs text-secondary hidden md:table-cell">${e.details}</td><td class="p-2 flex gap-3"><button onclick="showExpenseModal(${e.id})" class="text-flow-blue"><i class="fas fa-edit"></i></button><button onclick="deleteExpense(${e.id})" class="text-flow-danger"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody></table></div></div></div>`; }
function renderAmenities() { return `<div class="panel p-6 rounded-lg"><div class="flex justify-between items-start mb-6"><div class="flex-1"><h3 class="font-bold text-xl">Configurar Amenidades</h3><p class="text-sm text-secondary mt-1 max-w-xl">Define qué amenidades existen en el edificio para que los residentes puedan reservarlas.</p></div><button onclick="showAmenityModal()" class="btn-primary flex-shrink-0 flex items-center gap-2 px-4 py-2 rounded-lg text-sm"><i class="fas fa-plus"></i><span>Añadir Amenidad</span></button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${db.amenities.map(a => `<div class="border rounded-lg overflow-hidden flex flex-col"><div class="p-4 flex-1"><div class="flex items-center gap-3 mb-2"><i class="fas ${a.icon} text-xl text-flow-cyan"></i><h4 class="font-bold text-lg">${a.name}</h4></div><p class="text-xs text-secondary">${a.rules}</p></div><div class="flex border-t"><button onclick="showAmenityModal('${a.id}')" class="flex-1 p-3 text-sm font-semibold text-flow-blue hover:bg-flow-blue/10">Editar</button><button onclick="deleteAmenity('${a.id}')" class="flex-1 p-3 text-sm font-semibold text-flow-danger hover:bg-flow-danger/10 border-l">Eliminar</button></div></div>`).join('') || `<p class="text-center text-secondary col-span-full py-8">No hay amenidades registradas.</p>`}</div><p class="text-xs text-center text-secondary mt-6"><strong>Nota:</strong> Para gestionar las <strong>reservas</strong>, dirígete al módulo 'Gestionar Reservas'.</p></div>`; }
function renderParkingAdmin() { return `<div class="panel p-6 rounded-lg"><h3 class="font-bold text-xl mb-4">Gestión de Parqueaderos de Visitas</h3><div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">${db.parking.visitorSpots.map(p => `<div class="p-3 rounded-lg text-center ${p.isAvailable ? 'bg-flow-success/10 border' : 'bg-flow-danger/10 border'}"><p class="font-bold text-lg">${p.id}</p><p class="text-xs font-semibold">${p.isAvailable ? 'Libre' : 'Ocupado'}</p>${!p.isAvailable ? `<p class="text-[10px] text-secondary">Por U. ${db.users.find(u => u.id === p.owner)?.unit}</p>` : `<button onclick="removeVisitorSpot('${p.id}')" class="text-flow-danger text-xs mt-1"><i class="fas fa-times-circle"></i></button>`}</div>`).join('')}</div><h4 class="font-bold text-lg mb-4">Reservas Activas</h4><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead><tr><th>Residente</th><th>Invitado</th><th>Horario</th><th>Parqueo</th><th>Acciones</th></tr></thead><tbody>${db.parking.reservations.map(r => { const u = db.users.find(user => user.id === r.userId); return `<tr><td class="p-2">${u.name} (U. ${u.unit})</td><td class="p-2">${r.guestName}</td><td class="p-2">${r.startTime} - ${r.endTime}</td><td class="p-2 font-bold">${r.spotId}</td><td class="p-2"><button onclick="showAdminMessageModal(${u.id})" class="text-flow-blue text-lg" title="Enviar Mensaje"><i class="fas fa-comment-dots"></i></button></td></tr>` }).join('')}</tbody></table></div></div>`; }
function renderReports() { const s = { 'Sin leer': 'bg-flow-danger/20 text-flow-danger', 'En proceso': 'bg-flow-warning/20 text-flow-warning', 'Resuelto': 'bg-flow-success/20 text-flow-success' }; return `<div class="panel p-6 rounded-lg"><h3 class="font-bold text-xl mb-4">Gestión de Reportes</h3><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead><tr><th>Fecha</th><th>Residente</th><th>Categoría</th><th>Descripción</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>${db.reports.map(r => { const u = db.users.find(user => user.id === r.userId); return `<tr><td class="p-2">${r.date}</td><td class="p-2">${u.name}</td><td class="p-2">${r.category}</td><td class="p-2 text-xs">${r.description}</td><td><span class="px-2 py-1 rounded-full text-xs font-semibold ${s[r.status]}">${r.status}</span></td><td class="p-2"><select onchange="updateReportStatus(${r.id}, this.value)" class="input-field text-xs"><option ${r.status === 'Sin leer' ? 'selected' : ''}>Sin leer</option><option ${r.status === 'En proceso' ? 'selected' : ''}>En proceso</option><option ${r.status === 'Resuelto' ? 'selected' : ''}>Resuelto</option></select></td></tr>` }).join('')}</tbody></table></div></div>`; }
function renderAdminResidents() { const r = db.users.filter(u => u.role === 'resident'); return `<div class="panel p-6 rounded-lg"><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead><tr><th class="p-3">Residente</th><th class="p-3">Contacto</th><th class="p-3">Estado</th><th class="p-3">Acciones</th></tr></thead><tbody>${r.map(res => `<tr><td class="p-3"><div class="flex items-center gap-3"><img src="${res.avatar}" class="w-10 h-10 rounded-full"><div class="flex-1"><p class="font-bold">${res.name}</p><p class="text-xs text-secondary">U. ${res.unit} / ${res.dependents.length + 1} pers.</p></div></div></td><td class="p-3"><p>${res.email}</p><p class="text-xs">${res.phone}</p></td><td class="p-3"><span class="px-2 py-1 rounded-full text-xs font-semibold ${res.isBanned ? 'bg-flow-danger/20 text-flow-danger' : 'bg-flow-success/20 text-flow-success'}">${res.isBanned ? 'Sancionado' : res.status}</span></td><td class="p-3 flex gap-2 items-center"><button onclick="showResidentContactModal(${res.id})" class="text-flow-cyan" title="Contactar"><i class="fas fa-address-book"></i></button><button onclick="showAddResidentModal(${res.id})" class="text-flow-blue" title="Editar"><i class="fas fa-edit"></i></button><button onclick="toggleUserBan(${res.id})" class="text-secondary" title="${res.isBanned ? 'Desbanear' : 'Banear'}"><i class="fas ${res.isBanned ? 'fa-unlock' : 'fa-ban'}"></i></button></td></tr>`).join('')}</tbody></table></div></div>`; }
function renderResidents() { const r = db.users.filter(u => u.role === 'resident'); return `<div class="panel p-6 rounded-lg"><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead><tr><th class="p-3">Residente</th><th class="p-3">Unidad</th><th class="p-3">Acciones</th></tr></thead><tbody>${r.map(res => `<tr><td class="p-3"><div class="flex items-center gap-3"><img src="${res.avatar}" class="w-10 h-10 rounded-full"><p class="font-bold">${res.name}</p></div></td><td class="p-3"><p class="text-secondary">U. ${res.unit}</p></td><td class="p-3"><button onclick="showResidentContactModal(${res.id})" class="btn-primary px-4 py-2 text-xs rounded-lg">Contactar</button></td></tr>`).join('')}</tbody></table></div></div>`; }

// --- CALENDARIO ---
function renderCalendarView(containerId, date = new Date()) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const month = date.getMonth();
    const year = date.getFullYear();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const dayNames = ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"];

    let html = `<div class="flex justify-between items-center mb-4">
        <button id="prev-month-${containerId}" class="p-2 rounded-lg hover:bg-flow-light dark:hover:bg-flow-dark"><i class="fas fa-chevron-left"></i></button>
        <h4 class="font-bold text-lg">${monthNames[month]} ${year}</h4>
        <button id="next-month-${containerId}" class="p-2 rounded-lg hover:bg-flow-light dark:hover:bg-flow-dark"><i class="fas fa-chevron-right"></i></button>
    </div>`;
    html += `<div class="grid grid-cols-7 gap-2 text-center text-xs font-bold text-secondary mb-2">${dayNames.map(d => `<div>${d}</div>`).join('')}</div>`;
    html += '<div class="calendar-grid">';

    for (let i = 0; i < firstDay; i++) { html += '<div></div>'; }

    for (let day = 1; day <= daysInMonth; day++) {
        const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const events = db.community.events.filter(e => e.date === fullDate);
        const bookings = db.bookings.filter(b => b.date === fullDate);
        const parkings = db.parking.reservations.filter(p => p.date === fullDate);
        
        let dayEventsHtml = events.map(e => `<div class="calendar-event bg-flow-purple/20 text-flow-purple" onmouseenter="showTooltip(event, '<strong>Evento:</strong> ${e.name}<br><strong>Lugar:</strong> ${e.location}')" onmouseleave="hideTooltip()">${e.name}</div>`).join('');
        dayEventsHtml += bookings.map(b => {
            const user = db.users.find(u => u.id === b.userId);
            const amenity = db.amenities.find(a => a.id === b.amenityId);
            return `<div class="calendar-event bg-flow-blue/20 text-flow-blue" onmouseenter="showTooltip(event, '<strong>Reserva:</strong> ${amenity.name}<br><strong>Por:</strong> ${user.name}<br><strong>Hora:</strong> ${b.time}')" onmouseleave="hideTooltip()">${amenity.name}</div>`;
        }).join('');
        dayEventsHtml += parkings.map(p => {
            const user = db.users.find(u => u.id === p.userId);
            return `<div class="calendar-event bg-flow-cyan/20 text-flow-cyan" onmouseenter="showTooltip(event, '<strong>Parqueo:</strong> ${p.spotId}<br><strong>Invitado de:</strong> ${user.name}<br><strong>Hora:</strong> ${p.startTime} - ${p.endTime}')" onmouseleave="hideTooltip()">Parqueo ${p.spotId}</div>`;
        }).join('');
        
        html += `<div class="calendar-day p-2 border rounded-md ${new Date().toISOString().split('T')[0] === fullDate ? 'bg-flow-blue/10' : ''}">
            <div class="font-bold text-sm">${day}</div>
            <div class="overflow-y-auto flex-1">${dayEventsHtml}</div>
        </div>`;
    }
    html += '</div>';
    container.innerHTML = html;

    document.getElementById(`prev-month-${containerId}`).onclick = () => renderCalendarView(containerId, new Date(year, month - 1, 1));
    document.getElementById(`next-month-${containerId}`).onclick = () => renderCalendarView(containerId, new Date(year, month + 1, 1));
}
function showTooltip(event, text) {
    const tooltip = document.getElementById('calendar-tooltip');
    tooltip.innerHTML = text;
    tooltip.style.display = 'block';
    tooltip.style.left = `${event.pageX + 10}px`;
    tooltip.style.top = `${event.pageY + 10}px`;
}
function hideTooltip() {
    const tooltip = document.getElementById('calendar-tooltip');
    tooltip.style.display = 'none';
}


// --- FUNCIONES DE LÓGICA ---
function recalculateFinancialSummary() { db.finances.summary.expenses = db.finances.expense_details.reduce((total, expense) => total + expense.amount, 0); }
function renderAnnouncements() { if (db.currentRole === 'admin') return renderAdminAnnouncements(); return `<div class="space-y-4 max-w-4xl mx-auto">${db.announcements.map(a => `<div class="panel p-6 rounded-lg"><div class="flex justify-between items-center mb-2"><h3 class="font-bold text-xl text-flow-cyan">${a.title}</h3><span class="text-sm text-secondary">${a.date}</span></div><p class="text-secondary">${a.content}</p></div>`).join('')}</div>`; }
function renderBookings() { if (db.currentRole === 'admin') return renderAdminBookings(); return `<div><h2 class="text-2xl font-bold mb-6 text-main">Elige una Amenidad para Reservar</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6">${db.amenities.map(amenity => `<div class="panel rounded-lg overflow-hidden group cursor-pointer" onclick="showBookingModal('${amenity.id}')"><div class="h-40 bg-cover bg-center" style="background-image: url('${amenity.image}')"></div><div class="p-4"><h3 class="font-bold text-lg text-main">${amenity.name}</h3><p class="text-xs text-secondary mt-1">${amenity.rules}</p></div><div class="bg-flow-light dark:bg-flow-dark p-3 text-center font-semibold text-flow-cyan group-hover:bg-flow-blue group-hover:text-white transition-all">Ver Disponibilidad</div></div>`).join('')}</div></div>`; }
function renderRules() { return `<div class="panel p-6 rounded-lg max-w-4xl mx-auto"><div class="border-b pb-4 mb-6"><h3 class="font-bold text-2xl">Reglamento y Sanciones</h3><p class="text-secondary text-sm">Normas para una sana convivencia.</p></div><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div><h4 class="font-bold text-xl mb-4">Reglamento General</h4><div class="space-y-4"><div id="rule-category-1"><h5 class="font-semibold text-main mb-2"><i class="fas fa-users mr-2 text-flow-purple"></i>Convivencia</h5><ul class="text-sm text-secondary list-disc list-inside space-y-2"><li>Respetar el horario de silencio de 10:00 PM a 7:00 AM.</li><li>No obstaculizar áreas comunes.</li></ul></div><div id="rule-category-2"><h5 class="font-semibold text-main mt-4 mb-2"><i class="fas fa-swimming-pool mr-2 text-flow-cyan"></i>Uso de Áreas Comunes</h5><ul class="text-sm text-secondary list-disc list-inside space-y-2"><li>El uso de la piscina es hasta las 9:00 PM.</li><li>Limpiar la zona de BBQ después de su uso.</li></ul></div></div></div><div><h4 class="font-bold text-xl mb-4">Registro de Sanciones</h4><div class="space-y-3">${db.rules.fines.map(fine => { const user = db.users.find(u => u.id === fine.userId); return `<div class="p-3 bg-flow-light dark:bg-flow-dark rounded-md"><p class="text-sm font-bold text-main">${user.name} (U. ${user.unit})</p><p class="text-xs text-secondary">${fine.reason}</p><p class="text-xs font-semibold text-flow-danger mt-1">Multa: $${fine.amount.toFixed(2)}</p></div>` }).join('') || '<p class="text-sm text-secondary">No hay sanciones registradas.</p>'}</div></div></div></div>`; }
function renderAdminAnnouncements() { return `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="panel p-6 rounded-lg"><h3 class="font-bold text-xl mb-4">Publicar Comunicado</h3><form id="announcement-form" class="space-y-4"><div><label class="text-sm">Título</label><input type="text" id="title" name="title" class="input-field w-full p-2 mt-1" required></div><div><label class="text-sm">Contenido</label><textarea name="content" rows="4" class="input-field w-full p-2 mt-1" required></textarea></div><button type="submit" class="btn-primary w-full py-3">Publicar</button></form></div><div class="panel p-6 rounded-lg"><h3 class="font-bold text-xl mb-4">Gestionar Publicados</h3><div class="space-y-2">${db.announcements.map(a => `<div class="flex justify-between items-center p-2 rounded hover:bg-flow-light dark:hover:bg-flow-dark"><p class="text-sm font-semibold">${a.title}</p><div class="flex gap-3"><button onclick="editAnnouncement(${a.id})" class="text-flow-blue"><i class="fas fa-edit"></i></button><button onclick="deleteAnnouncement(${a.id})" class="text-flow-danger"><i class="fas fa-trash"></i></button></div></div>`).join('')}</div></div></div>`; }
function renderAdminBookings() { const s = { 'Aprobado': 'bg-flow-success/20 text-flow-success', 'Pendiente': 'bg-flow-warning/20 text-flow-warning', 'Rechazado': 'bg-flow-danger/20 text-flow-danger' }; return `<div class="panel p-6 rounded-lg"><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead><tr><th class="p-3">Residente</th><th class="p-3">Amenidad</th><th class="p-3">Fecha</th><th class="p-3">Estado</th><th class="p-3">Acciones</th></tr></thead><tbody>${db.bookings.map(b => { const u = db.users.find(user => user.id === b.userId); const a = db.amenities.find(am => am.id === b.amenityId); return `<tr><td class="p-3 font-bold">${u.name}</td><td class="p-3">${a.name}</td><td class="p-3">${b.date}</td><td class="p-3"><span class="px-2 py-1 rounded-full text-xs font-semibold ${s[b.status]}">${b.status}</span></td><td class="p-3 flex gap-2">${b.status === 'Pendiente' ? `<button onclick="updateBookingStatus(${b.id}, 'Aprobado')" class="text-flow-success"><i class="fas fa-check"></i></button><button onclick="updateBookingStatus(${b.id}, 'Rechazado')" class="text-flow-danger"><i class="fas fa-times"></i></button>` : `<button onclick="deleteBooking(${b.id})" class="text-flow-danger"><i class="fas fa-trash"></i></button>`}</td></tr>`}).join('')}</tbody></table></div></div>`; }
function renderAdminRules() { return `<div class="panel p-6 rounded-lg"><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead><tr><th class="p-3">Residente</th><th class="p-3">Motivo</th><th class="p-3">Monto</th><th class="p-3">Acciones</th></tr></thead><tbody>${db.rules.fines.map(f => { const u = db.users.find(user => user.id === f.userId); return `<tr><td class="p-3 font-bold">${u.name}</td><td class="p-3">${f.reason}</td><td class="p-3 text-flow-danger">$${f.amount.toFixed(2)}</td><td class="p-3"><button onclick="removeFine(${f.id})" class="text-flow-danger"><i class="fas fa-trash"></i></button></td></tr>`}).join('')}</tbody></table></div></div>`; }
function renderMarketplaceCard(i) { const seller = db.users.find(u => u.id === i.userId); const priceTag = i.price.currency === 'USD' ? `<div class="font-bold text-main">$${i.price.amount} <span class="text-xs text-secondary">USD</span></div>` : `<div class="flex items-center gap-1 font-bold text-inti-coin"><i class="fas fa-coins"></i>${i.price.amount}</div>`; const actionButton = i.price.currency === 'INTIS' ? `<button onclick="showPurchaseConfirmationModal('marketplace', ${i.id})" class="w-full mt-3 btn-primary text-sm py-2 rounded-lg">Comprar con Intis</button>` : `<button onclick="showContactModal(${i.userId})" class="w-full mt-3 bg-flow-light dark:bg-flow-dark border text-main font-semibold text-sm py-2 rounded-lg hover:bg-flow-border/10">Contactar a ${seller.name.split(' ')[0]}</button>`; return `<div class="panel p-5 rounded-lg flex flex-col"><div class="flex-1"><div><span class="text-xs font-semibold px-2 py-1 rounded-full ${i.type === 'Servicio' ? 'bg-flow-blue/20 text-flow-blue' : 'bg-flow-cyan/20 text-flow-cyan'}">${i.type}</span><h4 class="font-bold text-lg mt-2">${i.title}</h4></div><p class="text-sm text-secondary mt-2">${i.description}</p></div><div class="mt-4 pt-3 border-t"><div class="flex justify-between items-center">${priceTag}</div>${actionButton}</div></div>`; }
function renderMyPetCard(pet) { return `<div class="panel p-4 rounded-lg"><div class="flex items-center gap-4"><i class="fas fa-paw text-3xl ${pet.status === 'lost' ? 'text-flow-danger' : 'text-flow-purple'}"></i><div><p class="font-bold text-main">${pet.name}</p><p class="text-sm text-secondary">${pet.breed}</p></div><div class="ml-auto flex gap-2"><button onclick="showPetModal(${pet.id})" class="text-flow-blue"><i class="fas fa-edit"></i></button><button onclick="deletePet(${pet.id})" class="text-flow-danger"><i class="fas fa-trash"></i></button></div></div><button onclick="togglePetStatus(${pet.id})" class="w-full text-center mt-3 text-sm font-semibold ${pet.status === 'lost' ? 'text-flow-success' : 'text-flow-danger'}">${pet.status === 'lost' ? 'Marcar como Encontrado' : 'Reportar como Perdido'}</button></div>`; }
function renderGroupCard(group) { const isMember = group.members.includes(db.currentUser.id); let buttonHTML = isMember ? `<button onclick="joinGroup(${group.id})" class="w-full mt-3 bg-flow-danger/20 text-flow-danger font-semibold text-sm py-2 rounded-lg">Abandonar Grupo</button>` : `<button onclick="joinGroup(${group.id})" class="w-full mt-3 bg-flow-light dark:bg-flow-dark border text-main font-semibold text-sm py-2 rounded-lg hover:bg-flow-blue hover:text-white">Unirse al Grupo</button>`; return `<div class="panel p-5 rounded-lg flex flex-col"><div class="flex-1"><div class="flex items-center gap-3 mb-2"><i class="fas ${group.icon} text-xl text-flow-purple"></i><h4 class="font-bold text-lg">${group.name}</h4></div><p class="text-sm text-secondary">${group.description}</p></div><div class="mt-4 pt-3 border-t"><p class="text-sm text-secondary">${group.members.length} miembro(s)</p>${buttonHTML}</div></div>`; }
function renderAdminGroupCard(group) { return `<div class="panel p-5 rounded-lg flex flex-col"><div class="flex-1"><div class="flex items-center gap-3 mb-2"><i class="fas ${group.icon} text-xl text-flow-purple"></i><h4 class="font-bold text-lg">${group.name}</h4></div><p class="text-sm text-secondary">${group.description}</p></div><div class="mt-4 pt-3 border-t"><p class="text-sm text-secondary">${group.members.length} miembro(s)</p></div></div>`; }
function renderJobCard(job) { const publisher = db.users.find(u => u.id === job.userId); const isOwner = job.userId === db.currentUser.id || db.currentRole === 'admin'; return `<div class="p-4 rounded-lg bg-flow-light dark:bg-flow-dark"><div class="flex justify-between items-start"><div class="flex-1"><h4 class="font-bold text-main">${job.title}</h4><p class="text-sm font-semibold text-flow-cyan">${job.company}</p><p class="text-xs text-secondary mt-2">${job.description}</p></div><img src="${publisher.avatar}" class="w-10 h-10 rounded-full ml-4"></div><div class="mt-3 pt-3 border-t flex justify-between items-center"><p class="text-xs text-secondary">Publicado por ${publisher.name}.</p>${isOwner ? `<div class="flex gap-3"><button onclick="showJobPostModal(${job.id})" class="text-flow-blue"><i class="fas fa-edit"></i></button><button onclick="deleteJobPost(${job.id})" class="text-flow-danger"><i class="fas fa-trash"></i></button></div>` : ''}</div></div>`; }
function renderEventCard(event) { const organizer = db.users.find(u => u.id === event.organizerId); const costTag = event.cost.currency === 'USD' ? `<div class="font-bold text-main">$${event.cost.amount}</div>` : `<div class="flex items-center gap-1 font-bold text-inti-coin"><i class="fas fa-coins"></i>${event.cost.amount}</div>`; const isOwner = event.organizerId === db.currentUser.id || db.currentRole === 'admin'; const isParticipant = event.participants.includes(db.currentUser.id); let actionButton; if (isParticipant) { actionButton = `<button class="font-semibold text-sm py-2 px-4 rounded-lg bg-flow-success/20 text-flow-success" disabled>Inscrito</button>`; } else { actionButton = `<button onclick="joinEvent(${event.id})" class="font-semibold text-sm py-2 px-4 rounded-lg btn-primary">Unirme al Evento</button>`; } return `<div class="panel p-4 rounded-lg"><div class="flex items-start gap-4"><div class="text-center w-12"><p class="text-2xl font-bold text-flow-purple">${new Date(event.date + 'T00:00:00').getDate()}</p><p class="text-sm text-secondary">${new Date(event.date + 'T00:00:00').toLocaleString('es-ES', { month: 'short' })}</p></div><div class="flex-1"><p class="text-xs text-flow-cyan font-bold">${event.location} @ ${event.time}</p><h4 class="font-bold text-lg mt-1">${event.name}</h4><p class="text-sm text-secondary mt-1">${event.description}</p></div><div class="text-right"><p class="text-xs text-secondary">Costo</p>${costTag}</div></div><div class="mt-3 pt-3 border-t space-y-3"><div class="flex justify-between items-center"><div class="text-sm text-secondary"><i class="fas fa-users mr-1"></i> ${event.participants.length} Asistentes</div>${actionButton}</div>${isOwner ? `<div class="flex justify-end gap-3"><button onclick="showCreateEventModal(${event.id})" class="text-flow-blue text-sm font-semibold">Editar</button><button onclick="deleteEvent(${event.id})" class="text-flow-danger text-sm font-semibold">Eliminar</button></div>` : ''}</div><div class="mt-3 pt-3 border-t"><h5 class="text-sm font-bold mb-2">Comentarios</h5><div class="space-y-2 max-h-32 overflow-y-auto">${event.comments.map(c => { const u = db.users.find(us => us.id === c.userId); return `<div class="text-xs"><strong class="text-main">${u.name}:</strong> <span class="text-secondary">${c.text}</span></div>`}).join('') || '<p class="text-xs text-secondary">No hay comentarios.</p>'}</div><form class="mt-2 flex gap-2" onsubmit="addEventComment(event, ${event.id})"><input name="comment" class="input-field flex-1 text-xs p-1" placeholder="Añadir un comentario..." required><button type="submit" class="btn-primary px-2 text-xs">Enviar</button></form></div></div>`; }
function showCreateMarketplacePostModal() { const m = `<button onclick="hideModal()" class="absolute top-4 right-4 text-secondary hover:text-main text-2xl">&times;</button><h2 class="text-2xl font-bold mb-4">Publicar Anuncio</h2><form id="post-form" class="space-y-4"><input type="text" name="title" placeholder="Título del anuncio" class="input-field w-full p-2" required><select name="type" class="input-field w-full p-2"><option>Producto</option><option>Servicio</option></select><div><label class="text-sm font-semibold">Moneda</label><div class="flex gap-2 mt-2" id="currency-selector"><button type="button" data-currency="USD" class="currency-btn flex-1 p-2 rounded-lg border-2">USD</button><button type="button" data-currency="INTIS" class="currency-btn flex-1 p-2 rounded-lg border-2 border-inti-coin bg-inti-coin/10">INTIS</button></div></div><div id="price-inputs"><div id="usd-input-container" class="hidden"><label class="text-xs text-secondary">Valor en USD</label><input type="number" name="priceUSD" placeholder="$" class="input-field w-full p-2 mt-1"></div><div id="intis-input-container"><label class="text-xs text-secondary">Valor en Intis</label><input type="number" name="priceIntis" placeholder="INTIS" class="input-field w-full p-2 mt-1"></div></div><textarea name="description" placeholder="Descripción detallada" class="input-field w-full p-2" rows="3" required></textarea><button type="submit" class="btn-primary w-full py-3">Publicar y ganar 5 Intis</button></form>`; showModal(m, () => { let selectedCurrency = 'INTIS'; document.querySelectorAll('.currency-btn').forEach(btn => { btn.addEventListener('click', () => { selectedCurrency = btn.dataset.currency; document.querySelectorAll('.currency-btn').forEach(b => b.classList.remove('border-inti-coin', 'bg-inti-coin/10')); btn.classList.add('border-inti-coin', 'bg-inti-coin/10'); document.getElementById('usd-input-container').classList.toggle('hidden', selectedCurrency !== 'USD'); document.getElementById('intis-input-container').classList.toggle('hidden', selectedCurrency !== 'INTIS'); }); }); document.getElementById('post-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); const price = { currency: selectedCurrency, amount: selectedCurrency === 'USD' ? parseFloat(f.get('priceUSD')) : parseInt(f.get('priceIntis')) }; db.community.marketplace.unshift({ id: Date.now(), userId: db.currentUser.id, type: f.get('type'), title: f.get('title'), description: f.get('description'), price }); db.currentUser.intis += 5; addTransaction(db.currentUser.id, 'reward', 'Publicación en Marketplace', 5, 'Sistema', db.currentUser.name); addNotification('reward', '¡Ganaste 5 Intis por publicar en el Marketplace!', () => showSection('wallet'), db.currentUser.id); hideModal(); showSection('marketplace'); }); }); }
function showBookingModal(id) { const a = db.amenities.find(am => am.id === id); const m = `<h2 class="text-2xl font-bold mb-4">Reservar: ${a.name}</h2><form id="booking-form" class="space-y-4"><input type="date" name="date" class="input-field w-full p-2" required><input type="text" name="time" placeholder="18:00 - 22:00" class="input-field w-full p-2" required><button type="submit" class="btn-primary w-full py-3">Solicitar</button></form>`; showModal(m, () => { document.getElementById('booking-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); addNotification('booking', `Solicitud de reserva para ${a.name} de ${db.currentUser.name}.`, () => showSection('bookings')); db.bookings.unshift({ id: Date.now(), amenityId: id, userId: db.currentUser.id, date: f.get('date'), time: f.get('time'), status: 'Pendiente' }); hideModal(); }); }); }
function showNewReportModal() { const m = `<h2 class="text-2xl font-bold mb-4">Nuevo Reporte</h2><form id="report-form" class="space-y-4"><select name="category" class="input-field w-full p-2"><option>Mantenimiento</option><option>Seguridad</option><option>Convivencia</option></select><textarea name="description" placeholder="Describe el problema detalladamente..." class="input-field w-full p-2" rows="4" required></textarea><button type="submit" class="btn-primary w-full py-3">Enviar</button></form>`; showModal(m, () => { document.getElementById('report-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); const category = f.get('category'); const description = f.get('description'); db.reports.push({ id: Date.now(), userId: db.currentUser.id, category, description, status: 'Sin leer', date: new Date().toISOString().split('T')[0] }); addNotification('report', `Nuevo reporte de ${category} de ${db.currentUser.name}.`, () => showSection('reports')); hideModal(); }); }); }
function showAddResidentModal(id) { const isEdit = id !== undefined; const res = isEdit ? db.users.find(u => u.id === id) : {}; const m = `<h2 class="text-2xl font-bold mb-4">${isEdit ? 'Editar' : 'Agregar'} Residente</h2><form id="add-resident-form" class="space-y-4"><input type="text" name="name" placeholder="Nombre" class="input-field w-full p-2" value="${res.name || ''}" required><input type="text" name="unit" placeholder="Unidad" class="input-field w-full p-2" value="${res.unit || ''}" required><input type="email" name="email" placeholder="Correo" class="input-field w-full p-2" value="${res.email || ''}" required><input type="tel" name="phone" placeholder="Teléfono" class="input-field w-full p-2" value="${res.phone || ''}" required><input type="number" name="residentsCount" placeholder="N° de residentes" class="input-field w-full p-2" value="${res.residentsCount || ''}" required><button type="submit" class="btn-primary w-full py-3">Guardar</button></form>`; showModal(m, () => { document.getElementById('add-resident-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); if (isEdit) { Object.assign(res, { name: f.get('name'), unit: f.get('unit'), email: f.get('email'), phone: f.get('phone'), residentsCount: parseInt(f.get('residentsCount')) }); } else { db.users.push({ id: Date.now(), name: f.get('name'), unit: f.get('unit'), email: f.get('email'), phone: f.get('phone'), role: 'resident', avatar: `https://i.pravatar.cc/150?u=${Date.now()}`, status: 'Solvente', since: new Date().toISOString().split('T')[0], isBanned: false, residentsCount: parseInt(f.get('residentsCount')), pets: [], intis: 0, social:{}, transactions: [], dependents: [] }); } hideModal(); showSection('residents'); }); }); }
function showAmenityModal(id) { const isEdit = id !== undefined; const a = isEdit ? db.amenities.find(am => am.id === id) : {}; const m = `<h2 class="text-2xl font-bold mb-4">${isEdit ? 'Editar' : 'Añadir'} Amenidad</h2><form id="amenity-form" class="space-y-4"><input type="text" name="name" placeholder="Nombre" class="input-field w-full p-2" value="${a.name || ''}" required><input type="text" name="icon" placeholder="Ícono FontAwesome (e.g., fa-futbol)" class="input-field w-full p-2" value="${a.icon || ''}" required><input type="text" name="image" placeholder="URL de imagen" class="input-field w-full p-2" value="${a.image || ''}" required><textarea name="rules" placeholder="Reglas" class="input-field w-full p-2" required>${a.rules || ''}</textarea><button type="submit" class="btn-primary w-full py-3">Guardar</button></form>`; showModal(m, () => { document.getElementById('amenity-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); if (isEdit) { Object.assign(a, { name: f.get('name'), icon: f.get('icon'), image: f.get('image'), rules: f.get('rules') }); } else { db.amenities.push({ id: f.get('name').toLowerCase().replace(/\s+/g, '_'), name: f.get('name'), icon: f.get('icon'), image: f.get('image'), rules: f.get('rules') }); } hideModal(); showSection('amenities'); }); }); }
function showTransferModal() { const r = db.users.filter(u => u.role === 'resident' && u.id !== db.currentUser.id); const m = `<h2 class="text-2xl font-bold mb-4">Transferir Intis</h2><form id="transfer-form" class="space-y-4"><select name="recipientId" class="input-field w-full p-2">${r.map(res => `<option value="${res.id}">${res.name}</option>`).join('')}</select><input type="number" name="amount" placeholder="Monto" class="input-field w-full p-2" max="${db.currentUser.intis}" required><textarea name="description" placeholder="Descripción (ej: pago de cena)" class="input-field w-full p-2" rows="2" required></textarea><button type="submit" class="btn-primary w-full py-3">Transferir</button></form>`; showModal(m, () => { document.getElementById('transfer-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); const amount = parseInt(f.get('amount')); const description = f.get('description'); const recipientId = parseInt(f.get('recipientId')); const recipient = db.users.find(u => u.id === recipientId); if (amount > 0 && db.currentUser.intis >= amount && recipient) { db.currentUser.intis -= amount; recipient.intis += amount; addTransaction(db.currentUser.id, 'transfer_out', description, amount, db.currentUser.name, recipient.name); addTransaction(recipient.id, 'transfer_in', description, amount, db.currentUser.name, recipient.name); addNotification('payment', `Recibiste ${amount} Intis de ${db.currentUser.name}. Motivo: ${description}`, () => showSection('wallet'), recipient.id); showSuccessModal('¡Transferencia Exitosa!', `Has enviado ${amount} Intis a ${recipient.name}.`); showSection('wallet'); } else { showModal('Fondos insuficientes o destinatario inválido.'); } }); }); }
function showPetModal(id) { const isEdit = id !== undefined; const p = isEdit ? db.currentUser.pets.find(pet => pet.id === id) : {}; const m = `<h2 class="text-2xl font-bold mb-4">${isEdit ? 'Editar' : 'Añadir'} Mascota</h2><form id="pet-form" class="space-y-4"><input type="text" name="name" placeholder="Nombre" class="input-field w-full p-2" value="${p.name || ''}" required><input type="text" name="type" placeholder="Tipo (Perro, Gato)" class="input-field w-full p-2" value="${p.type || ''}" required><input type="text" name="breed" placeholder="Raza" class="input-field w-full p-2" value="${p.breed || ''}" required><button type="submit" class="btn-primary w-full py-3">Guardar</button></form>`; showModal(m, () => { document.getElementById('pet-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); if (isEdit) { Object.assign(p, { name: f.get('name'), type: f.get('type'), breed: f.get('breed') }); } else { db.currentUser.pets.push({ id: Date.now(), name: f.get('name'), type: f.get('type'), breed: f.get('breed'), status: 'ok' }); } hideModal(); showSection('pets'); }); }); }
function togglePetStatus(petId) { const pet = db.currentUser.pets.find(p => p.id === petId); if(pet) { pet.status = pet.status === 'lost' ? 'ok' : 'lost'; showSection('pets'); } }
function deletePet(petId) { db.currentUser.pets = db.currentUser.pets.filter(p => p.id !== petId); showSection('pets'); }
function updateBookingStatus(id, status) { const b = db.bookings.find(bo => bo.id === id); if (b) { b.status = status; showSection('bookings'); } }
function deleteBooking(id) { db.bookings = db.bookings.filter(b => b.id !== id); showSection('bookings'); }
function deleteAnnouncement(id) { db.announcements = db.announcements.filter(a => a.id !== id); showSection('announcements'); }
function editAnnouncement(id) { const a = db.announcements.find(an => an.id === id); const m = `<h2 class="text-2xl font-bold mb-4">Editar Comunicado</h2><form id="edit-ann-form" class="space-y-4"><input type="text" name="title" class="input-field w-full p-2" value="${a.title}" required><textarea name="content" rows="4" class="input-field w-full p-2" required>${a.content}</textarea><button type="submit" class="btn-primary w-full py-3">Guardar</button></form>`; showModal(m, () => { document.getElementById('edit-ann-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); a.title = f.get('title'); a.content = f.get('content'); hideModal(); showSection('announcements'); }); }); }
function deleteAmenity(id) { const a = db.amenities.find(am => am.id === id); if (!a) return; const m = `<div class="text-center"><i class="fas fa-exclamation-triangle text-4xl text-flow-danger mb-4"></i><h2 class="text-2xl font-bold mb-2">¿Estás seguro?</h2><p class="text-secondary mb-6">Vas a eliminar la amenidad "<strong>${a.name}</strong>".</p><div class="flex justify-center gap-4"><button onclick="hideModal()" class="bg-gray-200 dark:bg-gray-600 font-bold py-2 px-6 rounded-lg">Cancelar</button><button onclick="confirmDeleteAmenity('${id}')" class="bg-flow-danger text-white font-bold py-2 px-6 rounded-lg">Sí, Eliminar</button></div></div>`; showModal(m); }
function confirmDeleteAmenity(id) { db.amenities = db.amenities.filter(a => a.id !== id); hideModal(); showSection('amenities'); }
function toggleUserBan(id) { const u = db.users.find(user => user.id === id); if (u) { u.isBanned = !u.isBanned; showSection('residents'); } }
function showAddFineModal() { const r = db.users.filter(u => u.role === 'resident' && !u.isBanned); const m = `<h2 class="text-2xl font-bold mb-4">Registrar Sanción</h2><form id="fine-form" class="space-y-4"><select name="userId" class="input-field w-full p-2">${r.map(res => `<option value="${res.id}">${res.name}</option>`).join('')}</select><input type="text" name="reason" placeholder="Motivo" class="input-field w-full p-2" required><input type="number" name="amount" placeholder="Monto" class="input-field w-full p-2" required><button type="submit" class="btn-primary w-full py-3">Guardar</button></form>`; showModal(m, () => { document.getElementById('fine-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); db.rules.fines.push({ id: Date.now(), userId: parseInt(f.get('userId')), reason: f.get('reason'), amount: parseFloat(f.get('amount')), date: new Date().toISOString().split('T')[0] }); hideModal(); showSection('rules'); }); }); }
function renderAdminChart() { const ctx = document.getElementById('expensesChart')?.getContext('2d'); if (!ctx) return; if (chartInstance) chartInstance.destroy(); const data = db.finances.expense_details; chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: data.map(d => d.category), datasets: [{ data: data.map(d => d.amount), backgroundColor: ['#58A6FF', '#3FB950', '#F7B731', '#F85149', '#BC8EFF'], borderColor: document.documentElement.classList.contains('dark') ? '#161B22' : '#FFFFFF' }] }, options: { responsive: true, plugins: { legend: { position: 'right', labels: { color: document.documentElement.classList.contains('dark') ? '#E6EDF3' : '#1F2328' } } } } }); }
function showPricingModal() { const content = `<div class="text-center max-w-2xl mx-auto"><button onclick="hideModal()" class="absolute top-4 right-4 text-secondary hover:text-main text-2xl">&times;</button><i class="fas fa-rocket text-4xl text-flow-purple mb-3"></i><h2 class="text-2xl font-extrabold mb-2 text-main">Un Plan Simple para Transformar tu Comunidad</h2><p class="text-secondary mb-6">Un solo pago por unidad de vivienda, integrado en la alícuota, para un acceso total.</p><div class="panel p-6 rounded-xl shadow-glow text-left"><h3 class="text-xl font-bold text-center">Plan Comunitario Flow</h3><div class="text-center my-4"><p class="text-4xl font-black">$4<span class="text-lg text-secondary">/mes</span></p><p class="text-sm text-secondary">(Total $48 anuales por unidad de vivienda)</p></div><p class="text-xs text-center text-secondary mb-4">Este valor se suma a la alícuota mensual para simplificar la gestión.</p><h4 class="font-bold text-main mb-2">¿Por qué vale la pena?</h4><ul class="space-y-2 text-sm text-secondary"> <li class="flex items-start gap-3"><i class="fas fa-check-circle text-flow-success mt-1"></i><div><strong>Acceso Familiar Ilimitado:</strong> Todos los miembros de tu hogar pueden usar la app y sus beneficios.</div></li><li class="flex items-start gap-3"><i class="fas fa-check-circle text-flow-success mt-1"></i><div><strong>Economía y Comunidad:</strong> Ahorra dinero real usando Intis en el marketplace y apoya a tus vecinos.</div></li><li class="flex items-start gap-3"><i class="fas fa-check-circle text-flow-success mt-1"></i><div><strong>Transparencia Total:</strong> Accede a las finanzas y decisiones administrativas en tiempo real.</div></li><li class="flex items-start gap-3"><i class="fas fa-check-circle text-flow-success mt-1"></i><div><strong>Visión a Futuro - Red Flow:</strong> Conéctate con otros condominios para crear una mega-comunidad con más oportunidades.</div></li></ul></div><div class="panel p-4 rounded-xl mt-4 border-2 border-flow-cyan/50 text-left"><h3 class="text-lg font-bold text-flow-cyan">Servicio Opcional: Co-Administración Asistida</h3><p class="text-secondary mt-1 text-sm">Potenciamos a tu directiva con nuestro apoyo estratégico para una gestión más eficiente y sin estrés.</p><p class="text-xs text-main font-semibold mt-2">Servicio con costo adicional. ¡Contáctanos!</p></div></div>`; showModal(content); }
function showVisitorParkingModal() { const availableSpots = db.parking.visitorSpots.filter(s => s.isAvailable); if (availableSpots.length === 0) { showModal(`<h3 class="font-bold text-xl mb-4">Sin Espacios Disponibles</h3><p class="text-sm text-secondary">No hay parqueaderos de visita disponibles.</p>`); return; } const m = `<h2 class="text-2xl font-bold mb-4">Reservar Parqueo de Visita</h2><form id="visitor-parking-form" class="space-y-4"><select name="spotId" class="input-field w-full p-2">${availableSpots.map(s => `<option value="${s.id}">Espacio ${s.id}</option>`).join('')}</select><input type="text" name="guestName" placeholder="Nombre del invitado" class="input-field w-full p-2" required><input type="text" name="licensePlate" placeholder="Placa del vehículo" class="input-field w-full p-2" required><input type="date" name="date" class="input-field w-full p-2" value="${new Date().toISOString().split('T')[0]}" required><div><label class="text-sm">Hora de Inicio (Reserva por 2h)</label><input type="time" name="startTime" class="input-field w-full p-2 mt-1" required></div><button type="submit" class="btn-primary w-full py-3">Confirmar Reserva</button></form>`; showModal(m, () => { document.getElementById('visitor-parking-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); const spotId = f.get('spotId'); const spot = db.parking.visitorSpots.find(s => s.id === spotId); const startTime = f.get('startTime'); const [hours, minutes] = startTime.split(':').map(Number); const endTime = new Date(); endTime.setHours(hours + 2, minutes); const endTimeString = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`; if (spot) { spot.isAvailable = false; spot.owner = db.currentUser.id; db.parking.reservations.push({ id: Date.now(), spotId: spotId, userId: db.currentUser.id, guestName: f.get('guestName'), date: f.get('date'), startTime: startTime, endTime: endTimeString, licensePlate: f.get('licensePlate') }); } hideModal(); showSection('myUnit'); }); }); }
function showContactModal(userId) { const user = db.users.find(u => u.id === userId); if (!user) return; const modalHTML = `<button onclick="hideModal()" class="absolute top-4 right-4 text-secondary hover:text-main text-2xl">&times;</button><h2 class="text-2xl font-bold mb-4 text-main">Contactar Vendedor</h2><div class="flex items-center gap-4"><img src="${user.avatar}" class="w-16 h-16 rounded-full"><div><p class="font-bold text-lg">${user.name}</p><p class="text-sm text-secondary">Unidad ${user.unit}</p></div></div><div class="mt-6 border-t pt-4 space-y-3"><p class="text-sm"><strong class="w-20 inline-block text-secondary">Email:</strong> <a href="mailto:${user.email}" class="text-flow-blue">${user.email}</a></p><p class="text-sm"><strong class="w-20 inline-block text-secondary">Teléfono:</strong> <a href="tel:${user.phone}" class="text-flow-blue">${user.phone}</a></p></div>`; showModal(modalHTML); }
function showExpenseModal(id) { const isEdit = id !== undefined; const expense = isEdit ? db.finances.expense_details.find(e => e.id === id) : {}; const m = `<h2 class="text-2xl font-bold mb-4">${isEdit ? 'Editar' : 'Añadir'} Gasto</h2><form id="expense-form" class="space-y-4"><input type="date" name="date" class="input-field w-full p-2" value="${expense.date || new Date().toISOString().split('T')[0]}" required><input type="text" name="category" placeholder="Categoría" class="input-field w-full p-2" value="${expense.category || ''}" required><input type="number" name="amount" placeholder="Monto" class="input-field w-full p-2" value="${expense.amount || ''}" required><textarea name="details" placeholder="Detalles" class="input-field w-full p-2" required>${expense.details || ''}</textarea><button type="submit" class="btn-primary w-full py-3">Guardar</button></form>`; showModal(m, () => { document.getElementById('expense-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); if (isEdit) { Object.assign(expense, { date: f.get('date'), category: f.get('category'), amount: parseFloat(f.get('amount')), details: f.get('details') }); } else { db.finances.expense_details.push({ id: Date.now(), date: f.get('date'), category: f.get('category'), amount: parseFloat(f.get('amount')), details: f.get('details') }); } recalculateFinancialSummary(); hideModal(); showSection('finances'); }); }); }
function deleteExpense(id) { db.finances.expense_details = db.finances.expense_details.filter(e => e.id !== id); recalculateFinancialSummary(); showSection('finances'); }
function joinGroup(groupId) { const group = db.community.groups.find(g => g.id === groupId); if (group) { const userIndex = group.members.indexOf(db.currentUser.id); if (userIndex > -1) { group.members.splice(userIndex, 1); } else { group.members.push(db.currentUser.id); } showSection('community'); } }
function joinEvent(eventId) { const event = db.community.events.find(e => e.id === eventId); if (!event) return; const isParticipant = event.participants.includes(db.currentUser.id); if (isParticipant) return; if (event.cost.currency === 'INTIS' && event.cost.amount > 0) { showPurchaseConfirmationModal('event', eventId); } else { event.participants.push(db.currentUser.id); showSuccessModal('¡Inscripción Exitosa!', `Te has unido al evento "${event.name}".`); showSection('community'); } }
function addEventComment(e, eventId) { e.preventDefault(); const event = db.community.events.find(ev => ev.id === eventId); const form = e.target; const commentText = form.elements.comment.value; if (event && commentText) { event.comments.push({ userId: db.currentUser.id, text: commentText, time: new Date().toLocaleTimeString('es-EC', { hour: '2-digit', minute: '2-digit' }) }); showSection('community'); } }
function handleGroupRequest(groupId, userId, approve) { const group = db.community.groups.find(g => g.id === groupId); if (group) { group.requests = group.requests.filter(id => id !== userId); if (approve) { group.members.push(userId); } showSection('communityAdmin'); } }
function showJobPostModal(id) { const isEdit = id !== undefined; const job = isEdit ? db.community.jobs.find(j => j.id === id) : {}; const m = `<h2 class="text-2xl font-bold mb-4">${isEdit ? 'Editar' : 'Publicar'} Oferta de Empleo</h2><form id="job-post-form" class="space-y-4"><input type="text" name="title" placeholder="Título del Puesto" class="input-field w-full p-2" value="${job.title || ''}" required><input type="text" name="company" placeholder="Nombre de la Empresa" class="input-field w-full p-2" value="${job.company || ''}" required><textarea name="description" placeholder="Descripción del puesto" class="input-field w-full p-2" rows="3" required>${job.description || ''}</textarea><input type="email" name="contact" placeholder="Email de Contacto" class="input-field w-full p-2" value="${job.contact || db.currentUser.email}" required><button type="submit" class="btn-primary w-full py-3">Guardar</button></form>`; showModal(m, () => { document.getElementById('job-post-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); if (isEdit) { Object.assign(job, { title: f.get('title'), company: f.get('company'), description: f.get('description'), contact: f.get('contact') }); } else { db.community.jobs.unshift({ id: Date.now(), userId: db.currentUser.id, title: f.get('title'), company: f.get('company'), description: f.get('description'), contact: f.get('contact') }); } hideModal(); showSection('community'); }); }); }
function deleteJobPost(id) { db.community.jobs = db.community.jobs.filter(j => j.id !== id); showSection('community'); }
function addVisitorSpot() { const newId = `V${db.parking.visitorSpots.length + 1}`; db.parking.visitorSpots.push({ id: newId, isAvailable: true, owner: null }); showSection('parkingAdmin'); }
function removeVisitorSpot(spotId) { db.parking.visitorSpots = db.parking.visitorSpots.filter(s => s.id !== spotId); showSection('parkingAdmin'); }
function updateReportStatus(reportId, newStatus) { const report = db.reports.find(r => r.id === reportId); if (report) { report.status = newStatus; showSection('reports'); } }
let activeChatChannel = 'seguridad';
function switchChatChannel(channelKey) { activeChatChannel = channelKey; document.querySelectorAll('[id^="chat-channel-"]').forEach(btn => btn.classList.remove('bg-flow-blue/10')); document.getElementById(`chat-channel-${channelKey}`).classList.add('bg-flow-blue/10'); renderChatMessages(); }
function renderChatMessages() { const messagesContainer = document.getElementById('chat-messages'); if (!messagesContainer) return; const messages = db.chats[activeChatChannel].messages; messagesContainer.innerHTML = messages.map((msg, index) => { const sender = db.users.find(u => u.id === msg.userId) || { name: 'Sistema', avatar: 'https://i.ibb.co/9gX1sBw/LOGOS-HD-FAVICON.png' }; const isCurrentUser = msg.userId === db.currentUser.id; const isAdmin = db.currentRole === 'admin'; return `<div class="flex items-start gap-3 ${isCurrentUser ? 'flex-row-reverse' : ''}"><img src="${sender.avatar}" class="w-8 h-8 rounded-full"><div class="flex-1 max-w-xs md:max-w-md"><div class="p-3 rounded-lg ${isCurrentUser ? 'bg-flow-blue text-white' : 'bg-flow-light dark:bg-flow-dark'}"><p class="text-sm">${msg.text}</p></div><div class="text-xs text-secondary mt-1 px-1 ${isCurrentUser ? 'text-right' : ''}">${sender.name}, ${msg.time} ${isAdmin && !isCurrentUser ? `<button onclick="deleteChatMessage(${index})" class="text-flow-danger ml-2">Borrar</button>` : ''}</div></div></div>`; }).join(''); messagesContainer.scrollTop = messagesContainer.scrollHeight; }
function deleteChatMessage(index) { db.chats[activeChatChannel].messages.splice(index, 1); renderChatMessages(); }
function showCreateChannelModal() { const m = `<h2 class="text-2xl font-bold mb-4">Crear Nuevo Canal</h2><form id="create-channel-form" class="space-y-4"><input type="text" name="name" placeholder="Nombre del Canal" class="input-field w-full p-2" required><input type="text" name="icon" placeholder="Ícono FontAwesome (e.g., fa-comments)" class="input-field w-full p-2" value="fa-comments" required><button type="submit" class="btn-primary w-full py-3">Crear Canal</button></form>`; showModal(m, () => { document.getElementById('create-channel-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); const name = f.get('name'); const key = name.toLowerCase().replace(/\s+/g, '_'); db.chats[key] = { name: name, icon: f.get('icon'), messages: [] }; hideModal(); showSection('chat'); }); }); }
function deleteChannel(key) { if (key !== 'seguridad' && confirm(`¿Estás seguro de que quieres eliminar el canal "${db.chats[key].name}"?`)) { delete db.chats[key]; if (activeChatChannel === key) { activeChatChannel = 'seguridad'; } showSection('chat'); } }
function showCreateGroupModal() { const m = `<h2 class="text-2xl font-bold mb-4">Crear Nuevo Grupo</h2><form id="create-group-form" class="space-y-4"><input type="text" name="name" placeholder="Nombre del Grupo" class="input-field w-full p-2" required><input type="text" name="icon" placeholder="Ícono FontAwesome (e.g., fa-futbol)" class="input-field w-full p-2" value="fa-users" required><textarea name="description" placeholder="Descripción breve del grupo" class="input-field w-full p-2" rows="3" required></textarea><button type="submit" class="btn-primary w-full py-3">Crear Grupo</button></form>`; showModal(m, () => { document.getElementById('create-group-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); db.community.groups.push({ id: Date.now(), name: f.get('name'), icon: f.get('icon'), description: f.get('description'), members: [], requests: [] }); hideModal(); showSection('communityAdmin'); }); }); }
function showCreateEventModal(id) { const isEdit = id !== undefined; const event = isEdit ? db.community.events.find(e => e.id === id) : {}; const m = `<h2 class="text-2xl font-bold mb-4">${isEdit ? 'Editar' : 'Crear'} Evento Comunitario</h2><form id="event-form" class="space-y-4"><input type="text" name="name" placeholder="Nombre del Evento" class="input-field w-full p-2" value="${event.name || ''}" required><input type="text" name="location" placeholder="Ubicación (e.g., Salón Comunal)" class="input-field w-full p-2" value="${event.location || ''}" required><input type="date" name="date" class="input-field w-full p-2" value="${event.date || ''}" required><input type="time" name="time" class="input-field w-full p-2" value="${event.time || ''}" required><textarea name="description" placeholder="Descripción del evento" class="input-field w-full p-2" rows="3" required>${event.description || ''}</textarea><div><label class="text-sm font-semibold">Costo del Evento</label><div class="flex gap-2 mt-2" id="currency-selector"></div></div><div id="price-inputs"></div><button type="submit" class="btn-primary w-full py-3">${isEdit ? 'Guardar Cambios' : 'Publicar Evento'}</button></form>`; showModal(m, () => { const currencySelector = document.getElementById('currency-selector'); const priceInputs = document.getElementById('price-inputs'); const currencies = ['USD', 'INTIS']; let selectedCurrency = isEdit ? event.cost.currency : 'INTIS'; currencies.forEach(c => { currencySelector.innerHTML += `<button type="button" data-currency="${c}" class="currency-btn flex-1 p-2 rounded-lg border-2">${c}</button>`; priceInputs.innerHTML += `<div id="${c.toLowerCase()}-input-container" class="hidden"><label class="text-xs text-secondary">Valor en ${c}</label><input type="number" name="price${c}" value="${event.cost?.currency === c ? event.cost.amount : ''}" placeholder="${c}" class="input-field w-full p-2 mt-1"></div>`; }); const updateCurrencyUI = () => { document.querySelectorAll('.currency-btn').forEach(b => { b.classList.remove('border-inti-coin', 'bg-inti-coin/10'); if (b.dataset.currency === selectedCurrency) b.classList.add('border-inti-coin', 'bg-inti-coin/10'); }); document.querySelectorAll('[id$="-input-container"]').forEach(c => c.classList.add('hidden')); document.getElementById(`${selectedCurrency.toLowerCase()}-input-container`).classList.remove('hidden'); }; document.querySelectorAll('.currency-btn').forEach(btn => btn.addEventListener('click', () => { selectedCurrency = btn.dataset.currency; updateCurrencyUI(); })); updateCurrencyUI(); document.getElementById('event-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); const cost = { currency: selectedCurrency, amount: parseFloat(f.get(`price${selectedCurrency}`)) || 0 }; if (isEdit) { Object.assign(event, { name: f.get('name'), location: f.get('location'), date: f.get('date'), time: f.get('time'), description: f.get('description'), cost }); } else { db.community.events.unshift({ id: Date.now(), organizerId: db.currentUser.id, name: f.get('name'), location: f.get('location'), date: f.get('date'), time: f.get('time'), description: f.get('description'), cost, participants: [], comments: [] }); addNotification('event_creation', `${db.currentUser.name} ha creado el evento: ${f.get('name')}`, () => showSection('communityAdmin')); } hideModal(); showSection('community'); }); }); }
function deleteEvent(id) { db.community.events = db.community.events.filter(e => e.id !== id); showSection('community'); }
function triggerPanicButton() { const m = `<div class="text-center"><i class="fas fa-exclamation-triangle text-5xl text-flow-danger mb-4"></i><h2 class="text-2xl font-bold mb-2">Confirmar Alerta de Pánico</h2><p class="text-secondary mb-6">Esto notificará inmediatamente a seguridad y simulará una llamada al 911. Úsalo solo en una emergencia real.</p><div class="flex justify-center gap-4"><button onclick="hideModal()" class="bg-gray-200 dark:bg-gray-600 font-bold py-2 px-6 rounded-lg">Cancelar</button><button onclick="confirmPanicAlert()" class="bg-flow-danger text-white font-bold py-2 px-6 rounded-lg">Sí, Activar Alerta</button></div></div>`; showModal(m); }
function confirmPanicAlert() { const user = db.currentUser; const alertMessage = `¡ALERTA DE PÁNICO! ${user.name} desde la unidad ${user.unit} ha activado el botón de pánico.`; db.chats.seguridad.messages.push({ userId: 100, text: alertMessage, time: new Date().toLocaleTimeString('es-EC', { hour: '2-digit', minute: '2-digit' }) }); addNotification('panic', alertMessage, () => showSection('chat')); const modalContent = `<div class="text-center"><i class="fas fa-check-circle text-5xl text-flow-success mb-4"></i><h2 class="text-2xl font-bold mb-2">Alerta Enviada</h2><p class="text-secondary">Se ha notificado a seguridad. Simulación de llamada al 911 iniciada.</p></div>`; showModal(modalContent); }
function showAdminMessageModal(userId) { const user = db.users.find(u => u.id === userId); const m = `<h2 class="text-2xl font-bold mb-4">Enviar Mensaje a ${user.name}</h2><form id="admin-message-form" class="space-y-4"><textarea name="message" placeholder="Escribe tu mensaje aquí..." class="input-field w-full p-2" rows="4" required></textarea><button type="submit" class="btn-primary w-full py-3">Enviar Mensaje</button></form>`; showModal(m, () => { document.getElementById('admin-message-form').addEventListener('submit', e => { e.preventDefault(); const f = new FormData(e.target); const message = f.get('message'); addNotification('message', `Mensaje de Admin: ${message}`, () => {}, userId); hideModal(); }); }); }
document.getElementById('content-sections').addEventListener('submit', function(e) { if (e.target.id === 'announcement-form') { e.preventDefault(); const f = new FormData(e.target); db.announcements.unshift({ id: Date.now(), title: f.get('title'), content: f.get('content'), date: new Date().toISOString().split('T')[0] }); e.target.reset(); showSection('announcements'); } });
document.getElementById('content-sections').addEventListener('submit', function(e) { if (e.target.id === 'chat-form') { e.preventDefault(); const f = new FormData(e.target); const messageText = f.get('message'); if (messageText.trim()) { db.chats[activeChatChannel].messages.push({ userId: db.currentUser.id, text: messageText, time: new Date().toLocaleTimeString('es-EC', { hour: '2-digit', minute: '2-digit' }) }); e.target.reset(); renderChatMessages(); } } });

// --- NUEVAS FUNCIONES DE BILLETERA Y SOCIALES ---
function renderTransactionHistory() {
    const transactions = db.currentUser.transactions;
    if (!transactions || transactions.length === 0) {
        return '<p class="text-sm text-secondary text-center py-4">No hay transacciones todavía.</p>';
    }
    return transactions.map(t => {
        const isIncome = ['transfer_in', 'reward', 'sale'].includes(t.type);
        const amountColor = isIncome ? 'text-flow-success' : 'text-flow-danger';
        const icon = {
            transfer_in: 'fa-arrow-down', transfer_out: 'fa-arrow-up',
            purchase: 'fa-shopping-cart', reward: 'fa-star', sale: 'fa-tag'
        }[t.type];
        const sign = isIncome ? '+' : '-';
        
        return `<div class="flex items-center gap-4 p-3 border-b border-flow-border-light dark:border-flow-border">
            <div class="w-8 h-8 rounded-full flex items-center justify-center ${isIncome ? 'bg-flow-success/10' : 'bg-flow-danger/10'}">
                <i class="fas ${icon} ${isIncome ? 'text-flow-success' : 'text-flow-danger'}"></i>
            </div>
            <div class="flex-1">
                <p class="font-semibold text-main">${t.description}</p>
                <p class="text-xs text-secondary">${t.date} - De: ${t.from} / Para: ${t.to}</p>
            </div>
            <div class="font-bold ${amountColor}">${sign}${t.amount} Intis</div>
        </div>`;
    }).join('');
}

function showPurchaseConfirmationModal(type, itemId) {
    let item, seller, buyer;
    buyer = db.currentUser;

    if (type === 'marketplace') {
        item = db.community.marketplace.find(i => i.id === itemId);
        seller = db.users.find(u => u.id === item.userId);
    } else if (type === 'event') {
        item = db.community.events.find(e => e.id === itemId);
        seller = db.users.find(u => u.id === item.organizerId);
    } else { // 'benefit'
        const benefits = [ { name: 'Goatify IA - Suscripción Pro', cost: 500 }, { name: 'Goatify Web - Página Web', cost: 1200 }, { name: 'Centro Iberoamericano', cost: 2500 }, { name: 'Club Pa\' la Raza', cost: 300 }, { name: 'Villa Permacultural', cost: 800 } ];
        const benefitData = benefits.find(b => b.name === itemId);
        item = { title: itemId, price: { amount: benefitData.cost } };
        seller = { name: 'Flow Benefits' };
    }

    const cost = (type === 'event') ? item.cost.amount : item.price.amount;

    if (buyer.intis < cost) {
        showModal(`<div class="text-center"><i class="fas fa-exclamation-circle text-4xl text-flow-warning mb-4"></i><h2 class="text-2xl font-bold mb-2">Fondos Insuficientes</h2><p class="text-secondary">No tienes suficientes Intis para realizar esta compra.</p></div>`);
        return;
    }

    const modalHTML = `<div class="text-center">
        <i class="fas fa-wallet text-4xl text-flow-blue mb-4"></i>
        <h2 class="text-2xl font-bold mb-2">Confirmar Compra</h2>
        <p class="text-secondary mb-4">¿Deseas comprar "${type === 'event' ? item.name : item.title}" por <strong class="text-inti-coin">${cost} Intis</strong>?</p>
        <div class="flex justify-center gap-4">
            <button onclick="hideModal()" class="bg-gray-200 dark:bg-gray-600 font-bold py-2 px-6 rounded-lg">Cancelar</button>
            <button id="confirm-purchase-btn" class="btn-primary py-2 px-6 rounded-lg">Sí, Comprar</button>
        </div>
    </div>`;
    
    showModal(modalHTML, () => {
        document.getElementById('confirm-purchase-btn').onclick = () => {
            buyer.intis -= cost;
            const itemName = type === 'event' ? item.name : item.title;

            if (seller.id) {
                seller.intis += cost;
                addTransaction(seller.id, 'sale', `Venta: ${itemName}`, cost, buyer.name, seller.name);
                addNotification('payment', `Has vendido "${itemName}" a ${buyer.name} por ${cost} Intis.`, () => showSection('wallet'), seller.id);
            }
            
            addTransaction(buyer.id, 'purchase', `Compra: ${itemName}`, cost, buyer.name, seller.name);

            if (type === 'event') {
                item.participants.push(buyer.id);
                addNotification('payment', `${buyer.name} se ha unido a tu evento "${item.name}" y ha pagado ${cost} Intis.`, () => showSection('community'), seller.id);
                showSuccessModal('¡Inscripción Exitosa!', `Te has unido al evento "${item.name}".`);
                showSection('community');
            } else {
                showSuccessModal('¡Compra Exitosa!', `Se han transferido ${cost} Intis.`);
                if(type === 'marketplace') showSection('marketplace');
                if(type === 'benefit') showSection('benefits');
            }
        };
    });
}

function showSuccessModal(title, message) {
    const modalHTML = `<div class="text-center">
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-flow-success/10 flex items-center justify-center">
            <i class="fas fa-check-circle text-4xl text-flow-success"></i>
        </div>
        <h2 class="text-2xl font-bold mb-2">${title}</h2>
        <p class="text-secondary mb-6">${message}</p>
        <button onclick="hideModal()" class="btn-primary py-2 px-8 rounded-lg">Entendido</button>
    </div>`;
    showModal(modalHTML);
}

function showInternalMessageModal(recipientId) {
    const recipient = db.users.find(u => u.id === recipientId);
    const modalHTML = `<button onclick="hideModal()" class="absolute top-4 right-4 text-secondary hover:text-main text-2xl">&times;</button>
    <h2 class="text-2xl font-bold mb-4">Enviar Mensaje a ${recipient.name}</h2>
    <form id="internal-message-form" class="space-y-4">
        <textarea name="message" placeholder="Escribe tu mensaje aquí..." class="input-field w-full p-2" rows="4" required></textarea>
        <button type="submit" class="btn-primary w-full py-3">Enviar Mensaje</button>
    </form>`;
    showModal(modalHTML, () => {
        document.getElementById('internal-message-form').addEventListener('submit', e => {
            e.preventDefault();
            const f = new FormData(e.target);
            const message = f.get('message');
            addNotification('message', `Mensaje de ${db.currentUser.name}: ${message}`, () => {}, recipientId);
            showSuccessModal('¡Mensaje Enviado!', `Tu mensaje ha sido enviado a ${recipient.name}.`);
        });
    });
}

function showAboutFlowModal() {
    const content = `<div class="text-left">
        <button onclick="hideModal()" class="absolute top-4 right-4 text-secondary hover:text-main text-2xl">&times;</button>
        <div class="flex items-center gap-3 mb-4">
            <img src="Logos HD.png" alt="Flow Logo" class="h-12 w-auto">
            <h2 class="text-3xl font-extrabold text-main">¿Qué es Flow?</h2>
        </div>
        <div class="space-y-4 text-secondary text-sm max-h-[60vh] overflow-y-auto pr-2">
            <p><strong>Flow es una súper app que revoluciona el sector del Real Estate</strong> al transformar la manera en que se gestionan los condominios y se vive en comunidad. Nuestra plataforma va más allá de la simple administración; está diseñada para crear un ecosistema vibrante y autosostenible.</p>
            
            <div>
                <h3 class="font-bold text-main mb-2">Fomentamos la Comunidad y la Economía Circular</h3>
                <p>Con Flow, los residentes pueden conectar, colaborar y comerciar entre ellos de forma segura. El <strong>Marketplace</strong> y los <strong>Eventos</strong> permiten a los emprendedores ofrecer sus productos y servicios, generando una economía circular que beneficia a todos. Para facilitar esto, creamos el <strong>Inti</strong>, nuestra moneda digital exclusiva que incentiva la participación y premia la buena convivencia.</p>
            </div>

            <div>
                <h3 class="font-bold text-main mb-2">Transparencia y Eficiencia</h3>
                <p>Creemos en la gestión transparente. Por eso, el módulo de <strong>Finanzas</strong> permite a cada residente ver claramente los ingresos y egresos del condominio, generando confianza y eliminando incertidumbres. Todas las herramientas, desde la reserva de amenidades hasta los reportes de seguridad, están diseñadas para ser intuitivas y eficientes.</p>
            </div>

            <div>
                <h3 class="font-bold text-main mb-2">Nuestra Visión</h3>
                <p>Nuestra visión es fortalecer las comunidades, convirtiendo cada condominio en un lugar más conectado, seguro y próspero. Queremos que la tecnología sea un puente para mejorar las relaciones humanas y la calidad de vida.</p>
            </div>
        </div>
        <div class="mt-6 pt-4 border-t border-flow-border text-xs text-secondary">
            <p>Diseñada por <strong>Goatify IA.</strong></p>
            <p><strong>Founders & Developers:</strong> Daniel y Victor Ortega Corella.</p>
        </div>
    </div>`;
    showModal(content);
}

function showDependentModal(id) {
    const isEdit = id !== undefined;
    const dependent = isEdit ? db.currentUser.dependents.find(d => d.id === id) : {};
    const modalHTML = `<button onclick="hideModal()" class="absolute top-4 right-4 text-secondary hover:text-main text-2xl">&times;</button>
    <h2 class="text-2xl font-bold mb-4">${isEdit ? 'Editar' : 'Añadir'} Dependiente</h2>
    <form id="dependent-form" class="space-y-4">
        <input type="text" name="name" placeholder="Nombre Completo" class="input-field w-full p-2" value="${dependent.name || ''}" required>
        <input type="text" name="relation" placeholder="Parentesco (Ej: Cónyuge, Hijo/a)" class="input-field w-full p-2" value="${dependent.relation || ''}" required>
        <button type="submit" class="btn-primary w-full py-3">Guardar</button>
    </form>`;
    showModal(modalHTML, () => {
        document.getElementById('dependent-form').addEventListener('submit', e => {
            e.preventDefault();
            const f = new FormData(e.target);
            const dependentData = {
                name: f.get('name'),
                relation: f.get('relation')
            };
            if (isEdit) {
                const depIndex = db.currentUser.dependents.findIndex(d => d.id === id);
                db.currentUser.dependents[depIndex] = { ...dependent, ...dependentData };
            } else {
                db.currentUser.dependents.push({ id: Date.now(), ...dependentData });
            }
            hideModal();
            showSection('myUnit');
        });
    });
}

function deleteDependent(id) {
    db.currentUser.dependents = db.currentUser.dependents.filter(d => d.id !== id);
    showSection('myUnit');
}

</script>

</body>
</html>
