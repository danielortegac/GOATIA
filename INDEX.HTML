<!DOCTYPE html>
<html data-theme="light" lang="es">
<head>
<meta charset="utf-8"/>
<!-- 
  ============================================================================
  META TAGS DE VISTA Y RESPONSIVIDAD (¡IMPORTANTE!)
  ============================================================================
-->
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<title>Goatify IA — Suite de Negocios Pro</title>
<link rel="icon" href="Logos HD.png" type="image/png">

<!-- SEO Meta Tags -->
<meta content="Goatify IA es tu sistema operativo de negocios que se adapta a tu industria. Personaliza tu espacio de trabajo para marketing, e-commerce, y más." name="description"/>
<meta content="project management, crm, business os, collaboration, ai chat, cronopost, goatify ia, personalized workspace" name="keywords"/>
<meta content="Goatify" name="author"/>

<!-- Open Graph Meta Tags -->
<meta content="Goatify IA — Suite de Negocios Pro" property="og:title"/>
<meta content="website" property="og:type"/>
<meta content="La nueva era de la productividad. Goatify IA personaliza tus proyectos, tareas y herramientas según tu tipo de negocio desde el inicio." property="og:description"/>
<meta content="#f6f7fb" name="theme-color"/>

<!-- 
  ============================================================================
  LIBRERÍAS EXTERNAS (Iconos, PDF, Supabase)
  ============================================================================
-->
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- 
  NOTA: Aún no implementamos Supabase, pero dejamos la librería lista para el futuro.
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
-->


<!-- 
  ============================================================================
  INICIO DE ESTILOS CSS (MODIFICADOS Y MEJORADOS)
  ============================================================================
-->
<style>
  /* ----------------------------------------------------------------------------
  VARIABLES DE TEMA (ROOT) - ¡MEJORADAS!
  ----------------------------------------------------------------------------
  */
  :root{
    --bg:#0b0f19; --surface:#0f172a; --muted:#1e293b; --line:#334155;
    --text:#e2e8f0; --sub:#94a3b8; --brand:#a78bfa; --brand2:#8b5cf6; --accent:#38bdf8;
    --danger:#f87171; --warn:#fbbf24; --success:#22c55e; --info:#60a5fa;
    /* Sombras más profundas y profesionales */
    --shadow:0 25px 50px -12px rgba(0,0,0,.35);
    /* Esquinas más redondeadas */
    --radius:12px; 
    --xs:10px; --sm:11.5px; --md:13px; --lg:15px; --xl:17px;
    --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  [data-theme="light"]{
    --bg:#f8fafc; --surface:#ffffff; --muted:#f1f5f9; --line:#e9eef5;
    --text:#0f172a; --sub:#64748b; --brand:#6d28d9; --brand2:#8b5cf6; --accent:#0ea5e9;
    /* Sombras más suaves y modernas */
    --shadow:0 10px 30px rgba(15, 23, 42,.08); 
  }
  
  /* ----------------------------------------------------------------------------
  ESTILOS GLOBALES Y RESET
  ----------------------------------------------------------------------------
  */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
  
  *{
    box-sizing:border-box; 
    transition: background .2s ease, color .2s ease, border-color .2s ease, transform .2s ease, box-shadow .2s ease, width .2s ease, grid-template-columns .2s ease, opacity .2s ease, height .2s ease, flex-basis .2s ease;
  }
  html,body{
    height:100%;
  } 
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font: var(--md)/1.5 var(--font-sans); 
    overflow-x: hidden;
  }
  a{
    color:var(--brand);
    text-decoration:none;
  }
  main {
    height: calc(100vh - 55px);
    overflow-y: auto;
    overflow-x: hidden;
  }
  
  ::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }
  ::-webkit-scrollbar-track {
    background: transparent;
  }
  ::-webkit-scrollbar-thumb {
    background: var(--line);
    border-radius: 10px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: var(--muted);
  }

  /* ----------------------------------------------------------------------------
  LAYOUT PRINCIPAL (ASIDE, HEADER, CONTAINER)
  ----------------------------------------------------------------------------
  */
  .container{
    display:grid;
    grid-template-columns: 260px 1fr; 
    min-height:100%;
  }
  aside{
    border-right:1px solid var(--line);
    background:var(--surface);
    padding:10px 10px 20px 10px;
    position:relative;
    z-index:30; 
    display: flex; 
    flex-direction: column; 
    width: 100%;
    height: 100vh;
    overflow: hidden; 
  }
  
  aside .aside-top-section {
    flex-shrink: 0;
    padding: 0 4px;
  }
  aside .aside-middle-section {
    flex: 1 1 50%; 
    overflow-y: auto;
    min-height: 150px;
    margin: 10px 0;
    padding: 10px 0;
  }
  
  #sidebar-resizer {
    flex-shrink: 0;
    height: 5px;
    cursor: ns-resize;
    background: transparent;
    border-top: 1px solid var(--line);
    border-bottom: 1px solid var(--line);
    margin: 5px 0;
  }
  #sidebar-resizer:hover {
    background: var(--muted);
  }

  aside .aside-bottom-section {
    flex-shrink: 0;
    flex: 0 1 40%;
    overflow-y: hidden;
    display: flex;
    flex-direction: column;
    min-height: 150px;
  }

  .pinned-nav-item {
      padding: 5px 4px 10px 4px;
      border-bottom: 1px solid var(--line);
      flex-shrink: 0;
  }
  .pinned-nav-item .navBtn {
      background: color-mix(in hsl, var(--brand) 12%, transparent);
      color: var(--brand);
      font-weight: 600;
  }
  .pinned-nav-item .navBtn:hover {
      background: color-mix(in hsl, var(--brand) 20%, transparent);
  }
  body.aside-collapsed .pinned-nav-item {
      padding: 10px 4px;
  }
  body.aside-collapsed .pinned-nav-item .navBtn {
      width: 54px;
      justify-content: center;
  }

  #nav-list {
      flex-grow: 1;
      overflow-y: auto;
      padding-top: 10px;
  }


  header.app{
    position:sticky;
    top:0;
    z-index:40;
    background:color-mix(in hsl, var(--surface) 85%, transparent);
    backdrop-filter:blur(10px);
    border-bottom:1px solid var(--line);
    padding:8px 10px;
    display:flex;
    gap:10px;
    align-items:center;
    height: 55px;
  }

  /* ----------------------------------------------------------------------------
  COMPONENTES DE UI BÁSICOS (Botones, Inputs, Chips, Badges)
  ----------------------------------------------------------------------------
  */
  .brand{
    display:flex;
    gap:8px;
    align-items:center;
    font-weight:700;
    font-size: var(--lg); 
    padding: 8px 0;
  }
  .brand-logo { 
    height: 26px; 
    width: auto; 
    flex-shrink: 0;
  }
  .badge{
    padding:2px 8px;
    border-radius:999px;
    background:linear-gradient(90deg,var(--brand),var(--brand2));
    color:#fff;
    font-size:var(--xs);
    font-weight: 600;
  }
  .btn{
    border-radius:var(--radius);
    border:1px solid var(--line);
    background:var(--surface);
    color:var(--text);
    padding:8px 12px;
    cursor:pointer;
    display:inline-flex;
    gap:6px;
    align-items:center; 
    font-weight: 500;
    white-space: nowrap;
    justify-content: center;
  }
  .btn:hover{
    transform:translateY(-1px); 
    border-color: color-mix(in hsl, var(--brand) 60%, transparent);
    box-shadow: 0 3px 10px rgba(0,0,0,.05);
  } 
  .btn:active{
    transform:none; 
    box-shadow: none;
    background: var(--muted);
  }
  .btn:disabled, .btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  .btn.btn-sm { 
    padding: 4px 8px; 
    font-size: var(--sm); 
    gap: 4px;
  }
  .btn-primary{
    border:none;
    background:linear-gradient(90deg,var(--brand),var(--brand2));
    color:#fff;
  }
  .btn-primary:hover { 
    box-shadow: 0 4px 15px color-mix(in hsl, var(--brand) 30%, transparent);
    border: none;
  }
  .btn-ghost{
    background:transparent; 
    border-color: transparent; 
    box-shadow: none;
  }
  .btn-ghost:hover {
    background: var(--muted);
    border-color: var(--muted);
    transform: none;
    box-shadow: none;
  }
  .btn-ghost.active { 
    background: var(--muted); 
    color: var(--brand);
    font-weight: 600;
  }
  .chip{
    display:inline-flex;
    gap:6px;
    align-items:center;
    padding:4px 10px;
    border:1px solid transparent;
    border-radius:999px;
    background:var(--muted); 
    cursor: pointer;
    font-size: var(--sm);
  }
  .chip:hover { 
    border-color: var(--line);
    background: var(--surface);
  }
  input,select,textarea{
    border:1px solid var(--line);
    border-radius:var(--radius); /* Más redondeado */
    background:var(--muted);
    color:var(--text);
    padding:8px 12px;
    outline:none; 
    width: 100%;
    box-sizing: border-box;
    font-family: var(--font-sans);
    font-size: var(--md);
  }
  input:focus, select:focus, textarea:focus { 
    border-color: var(--brand); 
    background: var(--surface); 
    box-shadow: 0 0 0 3px color-mix(in hsl, var(--brand) 20%, transparent); 
  }
  textarea { 
    resize: vertical; 
    min-height: 50px;
  }

  /* ----------------------------------------------------------------------------
  NAVEGACIÓN LATERAL (Aside)
  ----------------------------------------------------------------------------
  */
  .projList{
    display:flex;
    flex-direction:column;
    gap: 2px;
    padding: 0 4px;
  }
  .navBtn, .projItem { 
    display:flex;
    gap: 8px;
    align-items:center;
    border:1px solid transparent;
    border-radius: var(--radius); /* Más redondeado */
    background:transparent;
    padding: 6px 8px;
    cursor:pointer; 
    font-weight: 500; 
    font-size: var(--sm);
    color: var(--sub);
    text-decoration: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .navBtn i, .projItem i {
    flex-shrink: 0;
    width: 16px;
    height: 16px;
  }
  .navBtn:hover, .projItem:hover {
    background:var(--muted);
    color: var(--text);
  }
  .navBtn.active {
    background: color-mix(in hsl, var(--brand) 10%, transparent); 
    color: var(--brand); 
    font-weight: 600;
  }
  
  .projItem .proj-text {
    flex-grow: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .projItem .proj-actions { 
    display: none; 
    margin-left: auto; 
    gap: 2px;
  }
  .projItem:hover .proj-actions { 
    display: flex; 
  }
  .projItem.active { 
    background: color-mix(in hsl, var(--brand) 10%, transparent); 
    font-weight: 600; 
    color: var(--brand);
  }
  .proj-color-dot { 
    width: 8px;
    height: 8px;
    border-radius: 50%; 
    flex-shrink: 0;
  }
  
  .projList-header {
    padding: 0 10px 4px 10px;
    font-size: var(--sm);
    color: var(--sub);
  }
  .projList-header b {
    font-weight: 600;
    color: var(--text);
  }
  .projList-header .btn {
    padding: 2px 6px;
  }
  .projList-header .btn i {
    width: 14px;
    height: 14px;
  }

  .mj-folder-list {
    margin: 2px 0 6px 16px;
    display: grid; 
    gap: 2px;
    padding-left: 8px;
    border-left: 1px solid var(--line);
  }
  .mj-folder-row {
    display:flex;
    align-items:center;
    gap: 6px;
    cursor:pointer;
    font-size: var(--sm);
    padding: 4px 6px;
    border-radius: 8px; /* Más redondeado */
    color: var(--sub);
    text-decoration: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .mj-folder-row:hover {
    background: var(--muted);
    color: var(--text);
  }
  .mj-folder-row .dot {
    width: 6px;
    height: 6px;
    border-radius:50%;
    flex-shrink: 0;
  }
  .mj-folder-row .label {
    flex-grow: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .mj-folder-actions {
    display: none;
    gap: 2px;
    margin-left: auto;
  }
  .mj-folder-row:hover .mj-folder-actions {
    display: flex;
  }
  .mj-folder-actions .btn {
    padding: 2px;
  }
  .mj-folder-actions i {
    width: 14px;
    height: 14px;
  }

  .projItem .proj-toggle {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    color: var(--sub);
  }
  .projItem .proj-toggle i {
    transition: transform 0.2s ease;
  }
  .projItem[data-collapsed="true"] .proj-toggle i {
    transform: rotate(-90deg);
  }
  .projItem[data-collapsed="true"] + .mj-folder-list {
    display: none;
  }


  /* ----------------------------------------------------------------------------
  ESTILOS DE PANELES Y CONTENIDO GENERAL
  ----------------------------------------------------------------------------
  */
  .panel{
    background:var(--surface);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    margin:16px; /* Más margen */
    overflow:hidden; 
    animation: fadeIn .3s ease;
  }
  .panel.full-height-panel {
    height: calc(100vh - 87px); /* header - (márgenes * 2) */
    margin: 16px;
    display: flex;
    flex-direction: column;
  }

  @keyframes fadeIn { 
    from { opacity: 0; transform: translateY(10px); } 
    to { opacity: 1; transform: translateY(0); } 
  }
  .row{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .spacer{
    flex:1;
  }
  .section{
    padding:16px;
    border-top:1px solid var(--line);
  }
  .card{
    border:1px solid var(--line);
    border-radius:var(--radius);
    background:var(--muted);
    padding:16px;
  }
  .overview-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
    gap: 16px; 
  }
  .stat-card { 
    background: var(--surface); 
    padding: 16px; 
    border-radius: var(--radius); 
    cursor: pointer;
    border: 1px solid var(--line);
  }
  .stat-card:hover { 
    transform: translateY(-2px); 
    box-shadow: var(--shadow); 
    border-color: var(--brand); 
  }
  .stat-card h4 { 
    margin: 0 0 8px 0; 
    color: var(--sub); 
    font-size: var(--sm);
    font-weight: 500;
  }
  .stat-card p { 
    margin: 0; 
    font-size: var(--xl); 
    font-weight: 600; 
  }
  .empty-state { 
    text-align: center; 
    padding: 40px; 
    color: var(--sub); 
  }
  .empty-state i { 
    margin-bottom: 12px; 
    width: 36px;
    height: 36px;
  }
  .table-wrapper { 
    overflow-x: auto; 
    -webkit-overflow-scrolling: touch; 
  }

  /* ----------------------------------------------------------------------------
  PESTAÑAS (TABS)
  ----------------------------------------------------------------------------
  */
  .tabs{
    display:flex;
    gap:6px;
    padding:10px 16px; /* Más padding lateral */
    border-bottom:1px solid var(--line); 
    flex-wrap: wrap;
  }
  .tab{
    all:unset;
    cursor:pointer;
    padding:6px 12px;
    border:1px solid transparent;
    border-radius:8px;
    background:transparent; 
    font-weight: 500; 
    font-size: var(--sm);
    color: var(--sub);
    min-width: 80px; 
    text-align: center;
  }
  .tab:hover {
    background: var(--muted);
    color: var(--text);
  }
  .tab.active{
    background:var(--surface);
    color: var(--brand);
    font-weight: 600;
    border-color:var(--line);
    box-shadow: 0 1px 3px rgba(0,0,0,.03);
  }
  
  /* ----------------------------------------------------------------------------
  MÓDULO: TAREAS (KANBAN & LISTA)
  ----------------------------------------------------------------------------
  */
  .board{
    display:grid;
    grid-template-columns:repeat(4, 1fr);
    gap:16px; /* Más gap */
    padding:16px;
    overflow-x: auto;
    min-height: 220px;
  }
  .col{
    background:var(--muted);
    border:1px solid var(--line);
    border-radius:var(--radius);
    min-height:220px;
    padding:8px;
    min-width: 280px; /* Más ancho */
    display: flex;
    flex-direction: column;
  }
  .col-header {
     padding: 8px; 
     align-items: center;
     flex-shrink: 0;
     font-size: var(--sm);
     font-weight: 600;
  }
  .col-content {
      flex-grow: 1;
      min-height: 100px;
      cursor: pointer;
  }
  .col .row b { 
    word-break: break-word; 
  }
  .col.dragover { 
    outline: 2px dashed var(--brand); 
    background: color-mix(in hsl, var(--brand) 10%, transparent); 
  }
  .task{
    background:var(--surface);
    border:1px solid var(--line);
    border-radius:10px;
    padding:12px; /* Más padding */
    margin:8px 4px;
    cursor:grab;
    box-shadow:var(--shadow);
    font-size: var(--sm);
  }
  .task:active {
    cursor: grabbing;
  }
  
  .task-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 8px;
  }
  .task-tag {
    font-size: 10px;
    font-weight: 500;
    padding: 2px 6px;
    border-radius: 6px;
    background: var(--muted);
    color: var(--sub);
  }

  #task-list-table th { 
    text-align: left; 
    padding: 8px; 
    color: var(--sub); 
    border-bottom: 2px solid var(--line); 
    font-size: var(--sm); 
    font-weight: 500;
  }
  #task-list-table td { 
    padding: 10px 8px;
    border-bottom: 1px solid var(--line);
    font-size: var(--sm);
  }
  #task-list-table tbody tr { 
    cursor: pointer; 
  }
  #task-list-table tbody tr:hover { 
    background: var(--muted); 
  }
  .status-badge { 
    padding: 3px 8px; 
    border-radius: 999px; 
    font-size: var(--xs); 
    font-weight: 600; 
    text-transform: uppercase; 
  }
  
  /* ----------------------------------------------------------------------------
  MÓDULO: CALENDARIOS (PROYECTO Y CRONOPOST)
  ----------------------------------------------------------------------------
  */
  #cpCalendarContainer { 
    background: var(--surface); 
    border-radius: var(--radius); 
    padding: 16px; 
    border: 1px solid var(--line); 
  }
  .calendar { 
    display: grid; 
    grid-template-columns: repeat(7, 1fr); 
    gap: 6px; 
  }
  .day { 
    min-height: 140px; 
    border: 1px solid var(--line); 
    border-radius: 10px; 
    background: var(--surface); 
    padding: 6px; 
    display: flex; 
    flex-direction: column; 
    gap: 4px; 
    cursor: pointer; 
    transition: background 0.2s ease;
  }
  .day:hover { 
    background: var(--muted); 
  }
  .day.dragover {
    outline: 2px dashed var(--brand); 
    background: color-mix(in hsl, var(--brand) 10%, transparent);
  }
  .cp-post, .cal-task { 
    font-size: 11px;
    background: var(--surface); 
    border-radius: 6px;
    padding: 4px 6px; 
    cursor: grab; 
    box-shadow: 0 2px 4px rgba(0,0,0,.05); 
    border: 1px solid var(--line);
    border-left: 3px solid; 
    margin-bottom: 4px; 
    font-weight: 500;
  }
  .cal-task:active {
    cursor: grabbing;
  }

  /* ----------------------------------------------------------------------------
  MÓDULO: HUB PROFESIONAL (Avatar con Iniciales)
  ----------------------------------------------------------------------------
  */
  .profile-card .profile-header { 
    height: 100px; 
    background: var(--surface); 
    border-radius: var(--radius) var(--radius) 0 0; 
    transition: background .3s ease; 
  }
  .profile-card .avatar { 
    width: 100px; 
    height: 100px; 
    border-radius: 50%; 
    object-fit: cover; 
    border: 4px solid var(--surface); 
    box-shadow: 0 0 10px rgba(0,0,0,0.1); 
    cursor: pointer; 
  }
  /* NUEVO: Estilo para Avatar de Iniciales */
  .avatar-initials {
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 40px; /* Iniciales grandes */
    color: var(--brand);
    background: color-mix(in hsl, var(--brand) 20%, transparent);
    /* Hereda .avatar para tamaño, borde, etc. */
  }
  
  /* ----------------------------------------------------------------------------
  MÓDULO: NOTAS Y LIENZO
  ----------------------------------------------------------------------------
  */
  .note-editor-wrapper { 
    display: grid; 
    grid-template-columns: 1fr 300px; 
    gap: 16px; 
    align-items: start;
  }
  #noteEditor { 
    min-height: 60vh; 
    max-height: 60vh; 
    background: var(--surface); 
    border-radius: var(--radius); 
    border: 1px solid var(--line); 
    padding: 12px; 
    overflow-y: auto; 
    outline: none;
  }
  #noteEditor:focus {
    border-color: var(--brand); 
    box-shadow: 0 0 0 3px color-mix(in hsl, var(--brand) 20%, transparent); 
  }
  #drawingCanvas { 
    border: 1px solid var(--line); 
    border-radius: var(--radius); 
    cursor: crosshair; 
    width:100%; 
    height:auto; 
    aspect-ratio: 250 / 180; 
  }
  
  /* ----------------------------------------------------------------------------
  MÓDULO: CHAT IA & CHAT GLOBAL (¡DISEÑO MEJORADO!)
  ----------------------------------------------------------------------------
  */
  .gchat-grid {
    display: grid; 
    gap: 16px; 
    grid-template-columns: 260px 1fr; 
    padding: 16px; 
    height: 100%;
    box-sizing: border-box;
    transition: grid-template-columns 0.3s ease;
  }
  #p-tab-chat .gchat-grid { 
    height: calc(100vh - 156px); /* Ajuste para header + tabs + márgenes */
    padding: 16px;
  }
  #ai-global-chat .gchat-grid {
    height: 100%;
  }

  .gchat-grid > .card:first-child {
    display:flex; 
    flex-direction: column; 
    overflow: hidden;
    max-height: 100%;
    background: var(--muted);
    padding: 8px;
    transition: opacity 0.3s ease, padding 0.3s ease, margin 0.3s ease, width 0.3s ease;
  }
  .gchat-grid > .card:last-child {
    display:flex; 
    flex-direction:column; 
    height: 100%;
    overflow: hidden;
    padding: 8px;
  }

  .gchat-list-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-shrink: 0;
  }
  .gchat-list-header b {
      flex-grow: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
  }
  #chatList, #aiChatList {
      flex-grow: 1;
      overflow-y: auto;
      margin-top: 0;
  }

  .gchat-main-header {
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid var(--line);
      padding-bottom: 8px;
      margin-bottom: 8px;
      flex-shrink: 0;
  }
  .gchat-main-header #showChatListBtn {
      display: none; 
  }
  .gchat-main-header .model-selector {
      flex-grow: 1;
      margin: 0;
      padding: 0;
      border: none;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 6px;
  }
  .gchat-grid > .card:last-child > .model-selector {
      display: none;
  }
  
  .gchat-grid.chat-list-collapsed {
      grid-template-columns: 0px 1fr;
      gap: 0;
  }
  .gchat-grid.chat-list-collapsed > .card:first-child {
      opacity: 0;
      pointer-events: none;
      padding: 0;
      margin: 0;
      width: 0;
      border: none;
  }
  .gchat-grid.chat-list-collapsed .gchat-main-header #showChatListBtn {
      display: inline-flex;
  }


  .chat-log { 
    display: flex; 
    flex-direction: column; 
    overflow-y: auto; 
    overflow-x: hidden; 
    border-radius: var(--radius); 
    padding: 10px; 
    background: var(--muted); 
    flex: 1;
    min-height: 0;
  }
  .chat-log .msg { 
    display: flex; 
    gap: 10px; 
    margin-bottom: 12px; 
    max-width: 90%; /* Más ancho */
    align-items: flex-end; 
  }
  .chat-log .msg.mine { 
    align-self: flex-end; 
    flex-direction: row-reverse; 
  }
  .chat-log .msg-avatar { 
    width: 32px;
    height: 32px;
    border-radius: 50%; 
    object-fit: cover; 
    flex-shrink: 0; 
    background: var(--surface); 
    padding: 2px;
  }
  .chat-log .msg-content { 
    display: flex; 
    flex-direction: column; 
  }
  .chat-log .msg-who { 
    font-size: var(--sm); 
    font-weight: 600; 
    margin-bottom: 4px; 
    color: var(--sub); 
  }
  .chat-log .msg-body { 
    background: var(--surface); 
    padding: 10px 14px; /* Más padding */
    border-radius: 12px; /* Coincide con --radius */
    word-break: break-word; 
    font-size: var(--sm);
    line-height: 1.6;
    box-shadow: 0 2px 5px rgba(0,0,0,.04);
  }
  .chat-log .msg.mine .msg-content { 
    align-items: flex-end; 
  }
  .chat-log .msg.mine .msg-body { 
    background: var(--brand); 
    color: #fff; 
    border-bottom-right-radius: 4px; /* Efecto "cola" */
  }
  .chat-log .msg:not(.mine) .msg-body {
    border-bottom-left-radius: 4px; /* Efecto "cola" */
  }
  .chat-input-area { 
    align-items: flex-end; 
    border-top: 1px solid var(--line); 
    padding-top: 10px; 
    flex-shrink: 0;
  }
  .chat-input-area textarea { 
    resize: none; 
    max-height: 150px; 
    background: var(--surface);
    border: none;
    box-shadow: none;
    padding-left: 0;
  }
  .chat-input-area textarea:focus {
    box-shadow: none;
    border: none;
  }

  /* Selector de Modelo IA */
  .model-selector { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
    gap: 8px; 
    padding-bottom: 8px; 
    margin-bottom: 8px; 
    flex-shrink: 0; 
  }
  .model-card { 
    border: 1px solid var(--line); 
    border-radius: var(--radius); 
    padding: 8px; 
    cursor: pointer; 
    background: var(--surface); 
    text-align: center; 
  }
  .model-card:not(.disabled):hover { 
    border-color: var(--brand); 
  }
  .model-card.active { 
    border-color: var(--brand); 
    background: color-mix(in hsl, var(--brand) 10%, transparent); 
    box-shadow: 0 0 0 2px var(--brand); 
  }
  .model-card.disabled { 
    opacity: 0.5; 
    cursor: not-allowed; 
    background: var(--muted); 
  }
  /* NUEVO: Badge PRO para Goatify X */
  .model-card.pro-feature {
    position: relative;
    overflow: hidden;
  }
  .model-card.pro-feature::after {
    content: 'PRO';
    position: absolute;
    top: 4px;
    right: 4px;
    background: var(--brand);
    color: white;
    font-size: 9px;
    font-weight: 700;
    padding: 1px 4px;
    border-radius: 4px;
  }
  .model-card.disabled.pro-feature::after {
      background: var(--sub);
  }
  
  .model-card h5 { 
    margin: 0 0 4px; 
    font-size: var(--sm); 
    white-space: nowrap; 
    font-weight: 600;
  }
  .model-card p { 
    margin: 0; 
    font-size: var(--xs); 
    color: var(--sub); 
    line-height: 1.3; 
  }

  /* Header vacío de Chat IA */
  #aiChatEmptyHeader {
      position: relative;
  }
  /* CORRECCIÓN BUG: Quitado botón duplicado de aquí */
  /* #aiChatEmptyHeader #showChatListBtn { ... } */
  

  /* Bloques de Código en Chat */
  .code-block { 
    border: 1px solid var(--line); 
    border-radius: var(--radius); 
    margin: 8px 0; 
    background: var(--bg);
  }
  .code-header { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    padding: 4px 8px; 
    background: color-mix(in hsl, var(--surface) 20%, var(--bg)); 
    border-bottom: 1px solid var(--line); 
    font-size: var(--sm); 
  }
  .code-block pre { 
    margin: 0; 
    padding: 12px; 
    overflow-x: auto; 
    background-color: transparent; 
    border-radius: 0 0 var(--radius) var(--radius); 
    font-size: 12px;
  }
  .code-preview-container { 
    border-top: 1px solid var(--line); 
    padding: 8px; 
  }
  .code-preview-container iframe { 
    width: 100%; 
    height: 200px; 
    border: 1px solid var(--line); 
    border-radius: 8px; 
    background: white; 
  }
  
  /* ----------------------------------------------------------------------------
  MÓDULO: BOLSA de EMPLEO
  ----------------------------------------------------------------------------
  */
  .job-card { 
    background: var(--surface); 
    border: 1px solid var(--line); 
    border-left: 4px solid var(--accent); 
    border-radius: 12px; 
    padding: 16px; 
    margin-bottom: 10px; 
    cursor: pointer; 
  }
  .job-card:hover { 
    border-color: var(--accent); 
    box-shadow: var(--shadow); 
    transform: translateY(-2px); 
  }
  .job-card .job-title { 
    font-weight: 600;
    font-size: var(--lg); 
  }
  .job-card .job-company { 
    color: var(--sub); 
    font-size: var(--sm);
  }
  .job-card-details { 
    display: none; 
    margin-top: 16px; 
    border-top: 1px solid var(--line); 
    padding-top: 16px; 
    white-space: pre-wrap; 
  }
  
  /* ----------------------------------------------------------------------------
  NUEVO MÓDULO: ASISTENTE DE MONETIZACIÓN (Rediseñado)
  ----------------------------------------------------------------------------
  */
  .service-card {
    background: var(--surface);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    box-shadow: var(--shadow);
    transition: transform .2s ease, box-shadow .2s ease;
  }
  .service-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0,0,0,.1);
    border-color: var(--brand);
  }
  .service-card .commission {
    font-size: 2.5rem; /* 40px */
    font-weight: 700;
    color: var(--brand);
    line-height: 1;
  }
  .service-card .commission-label {
    font-size: var(--sm);
    color: var(--sub);
    margin-top: -8px;
  }
  .service-card h4 {
    font-size: var(--lg);
    font-weight: 600;
    margin: 0;
  }
  .service-card p {
    font-size: var(--sm);
    color: var(--sub);
    margin: 0;
    flex-grow: 1;
  }
  
  /* ----------------------------------------------------------------------------
  NUEVO MÓDULO: AJUSTES (Rediseñado)
  ----------------------------------------------------------------------------
  */
  .plan-card {
    background: var(--surface);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    padding: 24px;
    display: flex;
    flex-direction: column;
  }
  .plan-card.pro-plan {
    border-width: 2px;
    border-color: var(--brand);
    box-shadow: 0 0 25px color-mix(in hsl, var(--brand) 20%, transparent);
  }
  .plan-card h3 {
    font-size: var(--xl);
    font-weight: 700;
    margin-top: 0;
  }
  .plan-card .price {
    font-size: 3rem; /* 48px */
    font-weight: 800;
    margin: 0;
  }
  .plan-card .price-sub {
    font-size: var(--md);
    color: var(--sub);
    margin-top: -8px;
    margin-bottom: 20px;
  }
  .plan-card ul {
    padding-left: 20px;
    margin: 0;
    display: grid;
    gap: 12px;
    flex-grow: 1;
  }
  .plan-card ul li {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    color: var(--text);
    font-size: var(--sm);
    line-height: 1.4;
  }
  .plan-card ul li i {
    width: 16px;
    height: 16px;
    color: var(--success);
    flex-shrink: 0;
    margin-top: 3px;
  }
  .plan-card ul li.limited i {
    color: var(--warn);
  }
  .plan-card ul li.excluded i {
    color: var(--danger);
  }
  .plan-card .btn {
      margin-top: 24px;
  }
  
  /* ----------------------------------------------------------------------------
  MÓDULO: MINDSET
  ----------------------------------------------------------------------------
  */
  #breathing-circle-container { 
    position: relative; 
    width: 150px; 
    height: 150px; 
    margin: 20px auto; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
  }
  #breathing-circle { 
    width: 100%; 
    height: 100%; 
    border-radius: 50%; 
    background: var(--brand); 
    animation: breathe 8s ease-in-out infinite; 
  }
  #breathing-text { 
    position: absolute; 
    color: white; 
    font-weight: 600; 
    animation: breathe-text 8s ease-in-out infinite;
  }
  @keyframes breathe { 
    0%, 100% { transform: scale(0.6); opacity: 0.7; } 
    50% { transform: scale(1); opacity: 1; } 
  }
  @keyframes breathe-text { 
    0%, 100% { content: "Inhala..."; } 
    50% { content: "Exhala..."; } 
  }
  
  /* ----------------------------------------------------------------------------
  MODALES Y TOASTS
  ----------------------------------------------------------------------------
  */
  dialog { 
    border: 1px solid var(--line); 
    border-radius: var(--radius); 
    box-shadow: var(--shadow); 
    max-width: 600px; 
    padding: 0; 
    overflow: hidden; 
    background: var(--surface);
    color: var(--text);
  }
  dialog[open] { 
    animation: fadeIn .2s ease; 
  }
  dialog::backdrop { 
    background: rgba(0,0,0,.5); 
    backdrop-filter: blur(4px); 
  }
  #toast { 
    position: fixed; 
    bottom: -100px; 
    left: 50%; 
    transform: translateX(-50%); 
    padding: 12px 20px; 
    border-radius: 999px; 
    z-index: 100; 
    font-weight: 600; 
    font-size: var(--sm);
    box-shadow: var(--shadow); 
    opacity: 0; 
    transition: opacity .3s, bottom .3s;
    background: var(--bg);
    border: 1px solid var(--line);
    color: var(--text);
  }
  #toast.info { border-left: 4px solid var(--info); }
  #toast.success { border-left: 4px solid var(--success); }
  #toast.warn { border-left: 4px solid var(--warn); }
  #toast.danger { border-left: 4px solid var(--danger); }
  #toast.show { 
    opacity: 1; 
    bottom: 30px; 
  }
  
  /* ----------------------------------------------------------------------------
  NUEVO: ESTILOS DE BILLETERA (MODAL)
  ----------------------------------------------------------------------------
  */
  #walletTransferUI {
    display: none; /* Show/hide with JS */
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--line);
  }
  #walletTabs .tab { /* Pestañas para modal de billetera */
     flex: 1; 
  }
  #intisReceipt {
    font-family: 'Courier New', Courier, monospace;
    background: var(--muted);
    padding: 16px;
    border-radius: 8px;
    border: 1px dashed var(--line);
    font-size: var(--sm);
    display: none;
    margin-top: 16px;
  }
  #intisReceipt pre {
    margin: 0;
    white-space: pre-wrap;
  }
  /* Notificación de "brillo" para Intis */
  #intisChip.notify {
    animation: pulse-brand 1.5s infinite;
  }
  @keyframes pulse-brand {
    0%, 100% { box-shadow: 0 0 0 0 color-mix(in hsl, var(--brand) 50%, transparent); }
    50% { box-shadow: 0 0 0 8px color-mix(in hsl, var(--brand) 0%, transparent); }
  }
  
  /* ----------------------------------------------------------------------------
  LAYOUTS DE GRID ESPECÍFICOS
  ----------------------------------------------------------------------------
  */
  .hub-grid, #cronopost-grid { 
    display: grid; 
    gap: 16px; 
  }
  .hub-grid { 
    grid-template-columns: 360px 1fr; 
  }
  #cronopost-grid { 
    grid-template-columns: 1fr 320px; 
    padding: 16px; 
  }
  #cpMonthLbl { 
    min-width: 150px; 
    justify-content: center; 
  }

  /* ----------------------------------------------------------------------------
  ASIDE COLAPSABLE (Desktop)
  ----------------------------------------------------------------------------
  */
  
  body.aside-collapsed .container { 
    grid-template-columns: 74px 1fr; 
  }
  body.aside-collapsed aside { 
    width: 74px; 
    align-items: center;
    padding: 10px 0;
  }
  
  body.aside-collapsed aside .brand span, 
  body.aside-collapsed aside .projItem > .proj-text, 
  body.aside-collapsed aside .navBtn > span {
    transition: opacity .1s, transform .1s, width .1s; 
  }
  
  body.aside-collapsed aside .brand span,
  body.aside-collapsed aside .navBtn > span,
  body.aside-collapsed aside .projItem > .proj-text,
  body.aside-collapsed aside .projItem > .proj-toggle,
  body.aside-collapsed aside .projItem > .proj-actions,
  body.aside-collapsed aside .projList-header,
  body.aside-collapsed aside .search input,
  body.aside-collapsed aside .mj-folder-list,
  body.aside-collapsed aside #sidebar-resizer
  { 
    opacity: 0; 
    pointer-events: none; 
    width: 0;
    transform: translateX(-10px);
    display: none;
  }
  
  body.aside-collapsed aside .aside-top-section .brand {
    justify-content: center;
  }
  body.aside-collapsed aside .brand-logo {
    margin: 8px 0;
  }
  body.aside-collapsed aside .navBtn,
  body.aside-collapsed aside .projItem { 
    justify-content: center; 
    padding: 10px;
    width: 54px;
  }
  body.aside-collapsed aside .proj-color-dot {
    margin: 0;
    width: 12px;
    height: 12px;
  }
  body.aside-collapsed aside .search { 
    padding: 0; 
  }
  body.aside-collapsed aside .aside-middle-section {
    padding: 10px 4px;
    align-items: center;
  }
  body.aside-collapsed aside .aside-bottom-section {
    padding: 0;
    align-items: center;
  }
  body.aside-collapsed aside .projList {
    align-items: center;
  }
  body.aside-collapsed aside .pinned-nav-item .navBtn > span {
      display: none;
  }


  /* ----------------------------------------------------------------------------
  MENÚ MÓVIL (Overlay y Dropdown)
  ----------------------------------------------------------------------------
  */
  #menu-overlay { 
    position: fixed; 
    inset: 0; 
    background: rgba(0,0,0,0.4); 
    z-index: 98; 
    display: none; 
    transition: opacity .3s ease; 
    opacity: 0; 
  }
  body.aside-open #menu-overlay { 
    display: block; 
    opacity: 1; 
  }
  
  .header-desktop-actions { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
  }
  .header-mobile-actions { 
    display: none; 
    align-items: center; 
    gap: 6px; 
  }
  .dropdown-container { 
    position: relative; 
  }
  .dropdown-menu { 
    display: none; 
    position: absolute; 
    top: calc(100% + 8px); 
    right: 0; 
    background: var(--surface); 
    border: 1px solid var(--line); 
    border-radius: var(--radius); 
    box-shadow: var(--shadow); 
    width: 220px; 
    z-index: 50; 
    padding: 6px; 
    flex-direction: column; 
    gap: 4px; 
    animation: fadeIn .15s ease-out; 
  }
  .dropdown-menu.active { 
    display: flex; 
  }
  .dropdown-item { 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    padding: 10px 12px; 
    border-radius: 10px; 
    color: var(--text); 
    font-weight: 500; 
    font-size: var(--md); 
    cursor: pointer; 
  }
  .dropdown-item:hover { 
    background: var(--muted); 
  }
  .dropdown-item i { 
    color: var(--sub); 
  }

  /* ============================================================================
  INICIO DE MEDIA QUERIES (ESTILOS RESPONSIVOS)
  ============================================================================
  */
  
  @media (max-width: 1180px){
    body.aside-collapsed .container { 
      grid-template-columns: 1fr; 
    }
    body.aside-collapsed aside { 
      width: 300px; 
      transform: translateX(-101%);
      align-items: stretch;
      padding: 10px 10px 20px 10px;
    }
    
    body.aside-open aside { 
      transform: translateX(0); 
      height: 100vh;
      box-shadow: var(--shadow);
    }
    
    .container{ 
      grid-template-columns: 1fr; 
    }
    aside{ 
      position: fixed; 
      inset: 0; 
      transform: translateX(-101%); 
      transition: transform .3s ease-in-out; 
      z-index: 99; 
      background: var(--surface); 
      width: 300px; 
      height: 100vh;
    }
    body.aside-open { 
      overflow: hidden; 
    }
    
    body.aside-collapsed aside .brand span, 
    body.aside-collapsed aside .navBtn > span, 
    body.aside-collapsed aside .projItem > .proj-text,
    body.aside-collapsed aside .projItem > .proj-toggle,
    body.aside-collapsed aside .projItem > .proj-actions,
    body.aside-collapsed aside .projList-header, 
    body.aside-collapsed aside .search input,
    body.aside-collapsed aside .mj-folder-list,
    body.aside-collapsed aside #sidebar-resizer { 
      opacity: 1; 
      pointer-events: auto;
      width: auto;
      transform: translateX(0);
      display: flex;
    }
    
    body.aside-collapsed aside .brand span,
    body.aside-collapsed aside .navBtn > span,
    body.aside-collapsed aside .projItem > .proj-text,
    body.aside-collapsed aside .projItem > .proj-toggle,
    body.aside-collapsed aside .projList-header,
    body.aside-collapsed aside .search input {
        display: block;
    }
    body.aside-collapsed aside #sidebar-resizer {
      display: none;
    }
    body.aside-collapsed aside .projItem > .proj-actions,
    body.aside-collapsed aside .mj-folder-list {
        display: grid;
    }
    body.aside-collapsed aside .projItem:hover .proj-actions {
        display: flex;
    }
    body.aside-collapsed aside .pinned-nav-item .navBtn > span {
        display: inline;
    }

    body.aside-collapsed aside .navBtn,
    body.aside-collapsed aside .projItem { 
      justify-content: flex-start;
      width: auto;
    }
    body.aside-collapsed aside .aside-top-section .brand {
        justify-content: flex-start;
    }
    body.aside-collapsed aside .search {
        padding: 0;
    }
    body.aside-collapsed aside .proj-color-dot {
        width: 8px;
        height: 8px;
    }
    body.aside-collapsed aside .aside-middle-section {
      padding: 10px 0;
      align-items: stretch;
    }
    body.aside-collapsed aside .aside-bottom-section {
      padding: 0;
      align-items: stretch;
    }
    body.aside-collapsed aside .pinned-nav-item {
        padding: 5px 4px 10px 4px;
    }
    body.aside-collapsed aside .projList {
      align-items: stretch;
    }

    #sidebar-resizer {
      display: none;
    }
    aside .aside-middle-section {
      height: 50%;
      flex-basis: 50%;
    }
    aside .aside-bottom-section {
      height: auto;
      flex: 1 1 auto;
    }
  }
  
  @media (max-width: 1024px) {
      .hub-grid, .note-editor-wrapper, #cronopost-grid { 
        grid-template-columns: 1fr; 
      }
      
      .gchat-grid {
          grid-template-columns: minmax(220px, 260px) 1fr;
      }

      .board { 
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
      
      /* Ajustes para Monetización y Ajustes en tablet */
      #monet, #settings {
          padding: 16px;
      }
  }

  @media (max-width: 768px) {
    .header-desktop-actions { 
      display: none; 
    }
    .header-mobile-actions { 
      display: flex; 
    }
    
    /* MEJORA DE CHAT MÓVIL */
    .panel {
        margin: 8px;
    }
    .panel.full-height-panel {
        height: calc(100vh - 71px); /* header - (márgenes * 2) */
        margin: 8px;
    }
    #p-tab-chat {
        height: auto; 
        padding: 0;
    }
    #p-tab-chat .gchat-grid {
      height: calc(100vh - 55px - 60px - 16px); 
      padding: 8px;
    }
    
    .gchat-grid {
        display: flex;
        flex-direction: column;
        height: 100%;
        max-height: none;
        padding: 8px;
        gap: 8px;
        grid-template-columns: 1fr; 
    }
    .gchat-grid > .card:first-child {
        flex-shrink: 0;
        max-height: 180px;
        overflow-y: auto;
        opacity: 1;
        pointer-events: auto;
        padding: 8px;
        margin: 0;
        width: auto;
        border: 1px solid var(--line);
    }
    .gchat-grid > .card:last-child {
        flex-grow: 1;
        min-height: 0;
        overflow: hidden;
    }
    .gchat-grid > .card:last-child .chat-log {
        flex-grow: 1;
        min-height: 0;
    }
    .gchat-grid > .card:last-child .chat-input-area {
        flex-shrink: 0;
    }
    .gchat-grid > .card:last-child #aiCodePreviewWrapper {
        flex-shrink: 0;
    }

    .gchat-list-header #p-collapse-chat-list,
    .gchat-list-header #ai-collapse-chat-list,
    .gchat-main-header #showChatListBtn {
        display: none !important;
    }
    .gchat-main-header .model-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 4px;
        padding-bottom: 0;
        margin-bottom: 0;
    }
    .model-card { 
      padding: 6px 4px;
    }
    .model-card h5 { 
      font-size: 11px; 
      margin-bottom: 2px; 
    }
    .model-card p { 
      font-size: 10px; 
      line-height: 1.2; 
    }
    /* ----------------------------------------------------------------------- */

    .board { 
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 8px; 
      padding: 10px; 
    }
    
    #finTable, #task-list-table { 
      min-width: 100%; 
      width: 100%; 
      font-size: var(--sm); 
    }
    
    /* Ajustes Generales Móvil */
    .tabs { 
      padding: 8px; 
    }
    .tab { 
      padding: 6px 12px; 
      font-size: var(--sm); 
    }
    #project-header-right { 
      flex-wrap: wrap; 
      justify-content: flex-end; 
      gap: 4px; 
    }
    dialog { 
      width: calc(100vw - 30px); 
      max-width: 95%; 
    }
    
    /* Ajustes para Monetización y Ajustes en móvil */
    #monet, #settings {
        padding: 8px;
    }
    #settings .plan-card {
        padding: 16px;
    }
    .service-card {
        padding: 16px;
    }
  }
  
  @media (max-width: 480px) {
      body { 
        font-size: var(--sm); 
      }
      .brand { 
        font-size: var(--md); 
      }
      #p-tab-finance .overview-grid { 
        grid-template-columns: 1fr; /* 1 columna en móvil pequeño */
      }
      /* 1 columna en móvil pequeño */
      #monet .service-card, #settings .plan-card {
          grid-template-columns: 1fr;
      }
  }
</style>
</head>
<body class="aside-collapsed"> <!-- Inicia colapsado por defecto en desktop -->

<!-- 
============================================================================
HEADER DE LA APLICACIÓN
============================================================================
-->
<header class="app">
<button class="btn btn-ghost" id="menuBtn"><i data-lucide="menu"></i></button>
<div class="brand">
    <img src="Logos HD.png" alt="Goatify Logo" class="brand-logo">
    Goatify <span style="color:var(--brand)">IA</span>
</div>
<div class="spacer"></div>

<!-- Acciones de Header para Desktop -->
<div class="header-desktop-actions">
    <div class="chip" id="walletChip" title="Ver Billetera"><i data-lucide="wallet"></i> <span id="wallet-amount">$0</span></div>
    <!-- ID 'intisChip' para notificaciones -->
    <div class="chip" id="intisChip" title="Tus Intis (puntos de gamificación)"><i data-lucide="sparkles"></i> <span id="intis-amount">0</span></div>
    <button class="btn btn-ghost" id="themeBtn" title="Cambiar Tema"><i data-lucide="sun"></i></button>
    <button class="btn btn-ghost" id="tourBtn" title="Iniciar Tour"><i data-lucide="help-circle"></i></button>
</div>

<!-- Acciones de Header para Móvil (Dropdown) -->
<div class="header-mobile-actions">
    <div class="dropdown-container">
        <button class="btn btn-ghost" id="mobileMoreBtn"><i data-lucide="more-vertical"></i></button>
        <div class="dropdown-menu" id="mobileDropdown">
            <div id="mobileWalletBtn" class="dropdown-item"><i data-lucide="wallet"></i><span>Billetera</span></div>
            <div id="mobileIntisBtn" class="dropdown-item"><i data-lucide="sparkles"></i><span>Intis</span></div>
            <div id="mobileThemeBtn" class="dropdown-item"><i data-lucide="sun"></i><span>Tema</span></div>
            <div id="mobileTourBtn" class="dropdown-item"><i data-lucide="help-circle"></i><span>Tour</span></div>
        </div>
    </div>
</div>
</header>

<!-- 
============================================================================
CONTENEDOR PRINCIPAL (Aside y Main)
============================================================================
-->
<div class="container">
<!-- 
----------------------------------------------------------------------------
BARRA LATERAL (ASIDE)
----------------------------------------------------------------------------
-->
<aside>
<div class="aside-top-section">
    <div class="brand">
        <img src="Logos HD.png" alt="Goatify Logo" class="brand-logo">
        <span>Goatify <span style="color:var(--brand)">IA</span></span>
    </div>
    <div class="search" style="margin: 10px 0;"><input id="q" placeholder="Buscar en todo…"/></div>
</div>

<div class="aside-middle-section">
    <div class="projList-header row"><b>Proyectos</b><span class="spacer"></span><button class="btn btn-sm" id="newProject"><i data-lucide="plus"></i> Nuevo</button></div>
    <div class="projList" id="projList" style="margin-top: 10px;">
        <!-- Los proyectos y carpetas se renderizan aquí -->
    </div>
</div>

<div id="sidebar-resizer" title="Ajustar tamaño"></div>

<div class="aside-bottom-section">
    <div class="pinned-nav-item">
        <a class="navBtn" data-nav="ai-global-chat" href="#!ai-global-chat">
            <i data-lucide="bot"></i> <span>Asistente IA Global</span>
        </a>
    </div>
    
    <div id="nav-list" class="projList">
        <a class="navBtn" data-nav="cronopost" href="#!cronopost"><i data-lucide="calendar-days"></i> <span>Calendario General</span></a>
        <a class="navBtn" data-nav="hub" href="#!hub"><i data-lucide="globe-2"></i> <span>Hub Profesional</span></a>
        <a class="navBtn" data-nav="gchat" href="#!gchat"><i data-lucide="messages-square"></i> <span>Chat Global</span></a>
        <a class="navBtn" data-nav="monet" href="#!monet"><i data-lucide="dollar-sign"></i> <span>Monetización (Socios)</span></a>
        <a class="navBtn" data-nav="mindset" href="#!mindset"><i data-lucide="brain-circuit"></i> <span>Bienestar y Mindset</span></a>
        <a class="navBtn" data-nav="settings" href="#!settings"><i data-lucide="settings"></i> <span>Ajustes y Pro</span></a>
    </div>
</div>
</aside>

<!-- 
----------------------------------------------------------------------------
CONTENIDO PRINCIPAL (MAIN)
----------------------------------------------------------------------------
-->
<main id="main">
<!-- 
============================================================================
SHELL DEL PROYECTO
============================================================================
-->
<section class="panel" id="projectShell" style="display:none">
<div class="tabs" id="project-tabs">
    <button class="tab active" data-ptab="overview">Overview</button>
    <button class="tab" data-ptab="tasks">Tareas</button>
    <button class="tab" data-ptab="calendar">Calendario</button>
    <button class="tab" data-ptab="notes">Notas</button>
    <button class="tab" data-ptab="tables">Tablas</button>
    <button class="tab" data-ptab="files">Archivos</button>
    <button class="tab" data-ptab="chat">Chat IA</button>
    <button class="tab" data-ptab="finance">Finanzas</button>
    <div class="spacer"></div>
    <div id="project-header-right" class="row">
        <div class="chip" id="projectNameChip">Proyecto</div>
        <button class="btn btn-ghost btn-sm" id="addFolder" title="Nueva Carpeta"><i data-lucide="folder-plus"></i></button>
        <select id="folderSel" class="btn-sm"></select>
        <button class="btn btn-primary btn-sm" id="quickAdd"><i data-lucide="plus"></i> Añadir</button>
    </div>
</div>
<!-- Pestaña: Overview -->
<div id="p-tab-overview" style="padding:16px; display:block;">
    <div id="ovr" class="overview-grid"></div>
</div>
<!-- Pestaña: Tareas -->
<div id="p-tab-tasks" style="display:none;">
    <div class="row" style="padding: 6px 16px; border-bottom: 1px solid var(--line);">
        <button id="viewToggleBoard" class="btn btn-ghost active"><i data-lucide="layout-grid"></i> Tablero</button>
        <button id="viewToggleList" class="btn btn-ghost"><i data-lucide="list"></i> Lista</button>
        
        <div class="chip" style="padding: 0 0 0 8px; margin-left: 10px;">
           <i data-lucide="tag" style="width:14px; height:14px; color: var(--sub);"></i>
           <input id="taskTagFilter" placeholder="Filtrar por tag..." style="border:none; background:transparent; padding: 6px 8px; font-size: var(--sm); width: 150px;">
        </div>

        <span class="spacer"></span>
        <button id="addColumnBtn" class="btn btn-sm"><i data-lucide="plus"></i> Columna</button>
    </div>
    <div id="kanban-view">
        <div class="board" id="kanban"></div>
    </div>
    <div id="list-view" class="table-wrapper" style="display:none; padding: 16px;">
        <table id="task-list-table" style="width:100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="width: 50%;">Tarea</th>
                    <th>Estado</th>
                    <th>Fecha Límite</th>
                    <th>Tags</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<!-- Pestaña: Calendario -->
<div id="p-tab-calendar" style="display:none; padding:16px;">
    <div class="row"><b>Calendario del proyecto</b><span class="spacer"></span><button class="btn" id="prevM"><i data-lucide="chevron-left"></i></button><div class="chip" id="monthLbl">Mes</div><button class="btn" id="nextM"><i data-lucide="chevron-right"></i></button></div>
    <div class="calendar" id="calGrid" style="margin-top:16px;"></div>
</div>
<!-- Pestaña: Notas -->
<div id="p-tab-notes" style="display:none; padding:16px">
    <div class="note-editor-wrapper">
        <div class="card" style="padding:8px;">
            <div class="row" style="margin-bottom:8px; padding: 4px; flex-wrap: wrap;">
                <button class="btn btn-sm" data-cmd="bold"><b>B</b></button>
                <button class="btn btn-sm" data-cmd="italic"><i>I</i></button>
                <button class="btn btn-sm" data-cmd="underline"><u>U</u></button>
                <button class="btn btn-sm" data-cmd="insertUnorderedList">•</button>
                <button class="btn btn-sm" data-cmd="insertOrderedList">1.</button>
                <button class="btn btn-sm" data-cmd="formatBlock" data-value="h2">H2</button>
                <button class="btn btn-sm" data-cmd="formatBlock" data-value="h3">H3</button>
                <span class="spacer"></span>
                <button class="btn btn-sm" id="exportNotePDF"><i data-lucide="file-down"></i> PDF</button>
            </div>
            <div id="noteEditor" contenteditable="true"></div>
        </div>
        <div>
            <div class="card">
                <div class="row"><b>Mis Notas</b><span class="spacer"></span><button class="btn btn-sm" id="newNoteBtn"><i data-lucide="plus"></i></button></div>
                <div id="noteList" style="margin-top:8px; max-height: 20vh; overflow-y: auto;"></div>
            </div>
            <div class="card" style="margin-top:16px">
                <div class="row"><b>Lienzo Rápido</b><span class="spacer"></span><button class="btn btn-sm" id="clearCanvasBtn"><i data-lucide="eraser"></i></button></div>
                <div class="row" style="margin: 8px 0;"><input type="color" id="canvasColorPicker"><input type="range" id="canvasStrokeSlider" min="1" max="20" value="3"></div>
                <canvas id="drawingCanvas"></canvas>
            </div>
        </div>
    </div>
</div>
<!-- Pestaña: Tablas -->
<div id="p-tab-tables" style="display:none; padding:16px;">
    <div class="row">
      <select id="tableSelector" class="btn-sm"></select>
      <button class="btn" id="newTableBtn"><i data-lucide="plus-square"></i></button>
      <span class="spacer"></span>
      <button class="btn" id="addCol"><i data-lucide="plus"></i> Columna</button>
      <button class="btn" id="addRow"><i data-lucide="plus"></i> Fila</button>
      <button class="btn" id="exportCSV">CSV</button>
    </div>
    <div class="section table-wrapper" id="sheetWrap" style="margin-top:16px;"></div>
</div>
<!-- Pestaña: Archivos -->
<div id="p-tab-files" style="display:none;padding:16px">
    <div class="row"><b>Archivos</b><span class="spacer"></span><label class="btn btn-primary"><i data-lucide="upload"></i> Subir Archivos<input id="fileInput" multiple type="file" style="display: none;"/></label></div>
    <div id="fileList" style="margin-top:16px" class="row"></div>
</div>
<!-- Pestaña: Chat IA (Proyecto) -->
<div id="p-tab-chat" style="display:none">
    <div class="gchat-grid" id="p-chat-grid">
        <!-- Columna de Lista de Chats -->
        <div class="card">
            <div class="gchat-list-header">
                <b>Conversaciones</b>
                <button class="btn btn-sm" id="newChat"><i data-lucide="plus"></i></button>
                <button class="btn btn-sm btn-ghost" id="p-collapse-chat-list" title="Ocultar lista"><i data-lucide="chevron-left"></i></button>
            </div>
            <div id="chatList" style="flex-grow: 1; overflow-y: auto;"></div>
        </div>
        <!-- Columna de Chat Activo -->
        <div class="card">
            <div class="gchat-main-header">
                <button class="btn btn-sm btn-ghost" id="showChatListBtn"><i data-lucide="chevron-right"></i></button>
                <div class="model-selector" style="flex-grow: 1; margin: 0; padding: 0; border: none;">
                    <div class="model-card active" data-model="pro">
                        <h5>Goatify Pro</h5>
                        <p>Potente y creativo.</p>
                    </div>
                    <div class="model-card" data-model="web">
                        <h5>Goatify Web</h5>
                        <p>Conectado a internet.</p>
                    </div>
                    <!-- Goatify X (PRO) -->
                    <div class="model-card disabled pro-feature" data-model="x" title="Goatify X - Exclusivo para PRO">
                        <h5>Goatify X</h5>
                        <p>Avanzado y veloz.</p>
                    </div>
                </div>
                <button class="btn btn-sm" id="chatToTasks"><i data-lucide="list-plus"></i> Crear Tarea</button>
            </div>
            
            <div id="chatLog" class="chat-log"></div>
            
            <div class="row chat-input-area">
                <button class="btn btn-ghost" id="p_attachFileBtn" title="Analizar Imagen, PDF, etc."><i data-lucide="paperclip"></i></button>
                <textarea class="spacer" id="chatMsg" placeholder="Habla con la IA de tu proyecto…" rows="1"></textarea>
                <button class="btn btn-primary" id="sendMsg"><i data-lucide="send"></i></button>
                <input type="file" id="p_chatFileInput" style="display:none" />
            </div>
        </div>
    </div>
</div>
<!-- Pestaña: Finanzas -->
<div id="p-tab-finance" style="display:none; padding:16px;">
    <div class="row"><b>Finanzas del Proyecto</b><span class="spacer"></span><button class="btn btn-primary" id="finNew"><i data-lucide="plus"></i> Movimiento</button><button class="btn" id="finExport">CSV</button></div>
    <div class="overview-grid" style="padding: 16px 0;">
        <div class="stat-card"><h4>Ingresos Totales</h4><p id="finIn" style="color: var(--success);">0</p></div>
        <div class="stat-card"><h4>Egresos Totales</h4><p id="finOut" style="color: var(--danger);">0</p></div>
        <div class="stat-card"><h4>Balance Neto</h4><p id="finBal">0</p></div>
    </div>
    <div class="table-wrapper">
        <table id="finTable" style="width:100%; border-collapse: collapse;">
            <thead><tr><th style="text-align: left; padding: 8px;">Fecha</th><th style="text-align: left; padding: 8px;">Tipo</th><th style="text-align: right; padding: 8px;">Monto</th><th style="text-align: left; padding: 8px;">Categoría</th><th style="text-align: left; padding: 8px;">Nota</th><th></th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
</section>

<!-- 
============================================================================
MÓDULO: ASISTENTE IA GLOBAL
============================================================================
-->
<section class="panel full-height-panel" id="ai-global-chat" style="display:none;">
    <div class="gchat-grid" id="ai-chat-grid">
        <!-- Columna de Lista de Chats -->
        <div class="card">
            <div class="gchat-list-header">
                <b>Conversaciones</b>
                <button class="btn btn-sm" id="aiNewChat"><i data-lucide="plus"></i></button>
                <button class="btn btn-sm btn-ghost" id="ai-collapse-chat-list" title="Ocultar lista"><i data-lucide="chevron-left"></i></button>
            </div>
            <div id="aiChatList" style="flex-grow: 1; overflow-y: auto;"></div>
            <!-- Límite de IA -->
            <div class="card" id="ai-limit-tracker" style="background: var(--surface); margin-top: 8px; padding: 8px 12px; display: none;">
                <div class="row" style="flex-wrap: nowrap;">
                    <span style="font-size: var(--sm); color: var(--sub);">Respuestas IA (Gratis):</span>
                    <span class="spacer"></span>
                    <b id="ai-limit-count" style="color: var(--brand);">0 / 20</b>
                </div>
                <button id="ai-limit-upgrade-btn" class="btn btn-primary btn-sm" style="width: 100%; margin-top: 8px; display: none;">Subir a PRO</button>
            </div>
        </div>
        <!-- Columna de Chat Activo -->
        <div class="card">
             <!-- Encabezado de estado vacío -->
             <div id="aiChatEmptyHeader" class="empty-state" style="display:none; padding: 20px 0 0 0; text-align: center; border-bottom: 1px solid var(--line); position: relative;">
                <!-- CORRECCIÓN: Botón duplicado eliminado de aquí -->
                <img src="Logos HD.png" style="width: 60px; height: 60px; margin-bottom: 12px;" alt="Goatify Logo">
                <h3 style="margin: 0; padding-bottom: 16px;">¿Cómo puedo ayudarte hoy?</h3>
             </div>
             
             <!-- Header del Chat Principal -->
             <div class="gchat-main-header">
                <button class="btn btn-sm btn-ghost" id="showChatListBtn"><i data-lucide="chevron-right"></i></button>
                <div class="model-selector" style="flex-grow: 1; margin: 0; padding: 0; border: none;">
                    <div class="model-card active" data-model="pro">
                        <h5>Goatify Pro</h5>
                        <p>Potente y creativo.</p>
                    </div>
                    <div class="model-card" data-model="web">
                        <h5>Goatify Web</h5>
                        <p>Conectado a internet.</p>
                    </div>
                    <!-- Goatify X (PRO) -->
                    <div class="model-card disabled pro-feature" data-model="x" title="Goatify X - Exclusivo para PRO">
                        <h5>Goatify X</h5>
                        <p>Genera Código.</p>
                    </div>
                </div>
                <button class="btn btn-sm" id="aiImageGenBtn"><i data-lucide="image"></i> Generar Imagen</button>
             </div>
            
            <!-- Log del Chat -->
            <div id="aiChatLog" class="chat-log">
                <!-- El estado vacío (sugerencias) se renderizará aquí -->
            </div>

            <!-- NUEVO: Vista Previa de Código (para Goatify X) -->
            <div id="aiCodePreviewWrapper" style="display:none; border-top: 1px solid var(--line); margin-top: 10px; padding-top: 10px; flex-shrink: 0;">
                <div class="row" style="margin-bottom: 8px;">
                    <b><i data-lucide="code"></i> Goatify X - Vista Previa de Código</b>
                    <span class="spacer"></span>
                    <button class="btn btn-sm btn-ghost" id="closeAiCodePreview"><i data-lucide="x"></i></button>
                </div>
                <iframe id="aiCodePreviewFrame" style="width: 100%; height: 300px; border: 1px solid var(--line); border-radius: 8px; background: white;"></iframe>
            </div>

            <!-- Input del Chat -->
            <div class="row chat-input-area">
                <button class="btn btn-ghost" id="g_attachFileBtn" title="Analizar Imagen, PDF, etc."><i data-lucide="paperclip"></i></button>
                <textarea class="spacer" id="aiChatMsg" placeholder="Habla con tu Asistente IA Global..." rows="1"></textarea>
                <button class="btn btn-primary" id="aiSendMsg"><i data-lucide="send"></i></button>
                <input type="file" id="g_chatFileInput" style="display:none" />
            </div>
        </div>
    </div>
</section>

<!-- 
============================================================================
MÓDULO: CRONOPOST (Calendario General)
============================================================================
-->
<section class="panel" id="cronopost" style="display:none;">
    <div class="row" style="padding:12px 16px; border-bottom: 1px solid var(--line);">
        <b>Calendario General</b>
        <div class="chip" style="margin-left: 10px;">Proyecto:</div>
        <select id="cpProjectSelect" class="btn-sm"></select>
        <span class="spacer"></span>
        <button class="btn" id="cpPrevM"><i data-lucide="chevron-left"></i></button>
        <div class="chip" id="cpMonthLbl">Mes</div>
        <button class="btn" id="cpNextM"><i data-lucide="chevron-right"></i></button>
    </div>
    <div id="cronopost-grid">
        <div id="cpCalendarContainer">
            <div class="calendar" id="cpCalendar"></div>
        </div>
        <div id="cpIdeas">
            <div class="card">
                <div class="row"><b>💡 Banco de Ideas</b><span class="spacer"></span><button class="btn btn-primary btn-sm" id="cpGenAIIdeas"><i data-lucide="sparkles"></i> IA</button></div>
                <div id="cpIdeasList" style="max-height: 50vh; overflow-y: auto; padding-right: 5px; margin: 10px 0;"></div>
                <input id="cpNewIdeaInput" placeholder="Escribe una nueva idea..." style="margin-bottom: 8px;">
                <button class="btn" id="cpAddIdeaBtn" style="width: 100%;">+ Añadir Idea</button>
            </div>
        </div>
    </div>
</section>

<!-- 
============================================================================
MÓDULO: HUB PROFESIONAL (Avatar con Iniciales)
============================================================================
-->
<section class="panel" id="hub" style="display:none; padding: 16px;">
    <div class="hub-grid">
    <div class="profile-card" style="background:var(--surface); border-radius:var(--radius); border:1px solid var(--line);">
        <div class="profile-header"></div>
        <div class="avatar-wrapper" style="padding: 0 20px;">
             <!-- Contenedor para Avatar e Iniciales -->
             <div style="position: relative; width: 100px; height: 100px; margin: -50px auto 10px;">
                <img alt="avatar" class="avatar" id="avatar" src="" style="display: none;"/>
                <div class="avatar avatar-initials" id="avatarInitials">TÚ</div>
            </div>
             <input type="file" id="avatarInput" accept="image/*" style="display:none;">
        </div>
        <div style="padding: 0 20px 20px;">
            <h3 id="pNombreDisplay" style="margin: 0; display:inline-block; cursor:pointer;">Tu Nombre</h3>
            <p id="pRoleDisplay" class="sub" style="margin: 4px 0 10px; cursor:pointer;">Tu Rol Profesional</p>
            <p id="pBioDisplay" class="sub" style="font-size: var(--sm); cursor:pointer;">Tu biografía profesional. Habla sobre tu experiencia, tus habilidades y lo que buscas.</p>
            <div id="pSocialsDisplay" class="row"></div>
            <hr style="border-color:var(--line);"/>
            <b>Editar Perfil</b>
            <input id="pNombre" placeholder="Tu nombre" style="margin-top: 8px;"/>
            <input id="pApellido" placeholder="Tu apellido" style="margin: 8px 0;"/>
            <input id="pRole" placeholder="Rol (Ej: Frontend Developer)" style="margin-bottom: 8px;"/>
            <textarea id="pBio" placeholder="Bio corta" rows="3" style="margin-bottom: 8px;"></textarea>
            <div class="row"><input id="pSocialLinkedin" placeholder="URL LinkedIn"/><input id="pSocialTwitter" placeholder="URL Twitter"/></div>
            <button class="btn btn-primary" id="savePerfil" style="width:100%; margin-top:10px;">Guardar Perfil</button>
        </div>
    </div>
    <div>
        <div class="tabs" style="padding:0; border-bottom:none; margin-bottom:10px;">
            <button class="tab active" data-htab="market">Mercado de Servicios</button>
            <button class="tab" data-htab="jobs">Bolsa de Empleos</button>
        </div>
        <div id="h-htab-market">
            <div class="card" style="margin-bottom: 10px;">
              <b>Publicar un nuevo producto o servicio</b>
              <div class="row"><input id="mkName" placeholder="Nombre"/><input id="mkPrice" placeholder="Precio (Ej: 500)" type="number"/></div>
              <textarea id="mkDesc" placeholder="Describe tu servicio..." rows="2" style="width:100%; margin: 8px 0;"></textarea>
              <button class="btn btn-primary" id="addMK">Publicar en Mercado</button>
            </div>
            <div id="mkList" style="max-height: 60vh; overflow-y:auto; padding: 5px;"></div>
        </div>
        <div id="h-htab-jobs" style="display:none;">
             <div class="card" style="margin-bottom: 10px;">
              <b>Publicar una nueva oferta de empleo</b>
              <div class="row" style="gap: 8px; margin-top: 8px;">
                <input id="jobTitle" placeholder="Título del Puesto" style="flex: 2;"/>
                <input id="jobCompany" placeholder="Empresa" style="flex: 1;"/>
              </div>
              <div class="row" style="gap: 8px; margin-top: 8px;">
                <input id="jobLocation" placeholder="Ubicación (Ej: Remoto)" style="flex: 1;"/>
                <input id="jobPay" placeholder="Salario (Ej: $2000/mes)" style="flex: 1;"/>
                <select id="jobType" style="flex: 1;">
                    <option>Tiempo Completo</option>
                    <option>Medio Tiempo</option>
                    <option>Por Proyecto</option>
                    <option>Freelance</option>
                </select>
              </div>
              <textarea id="jobDesc" placeholder="Descripción del puesto, requisitos, beneficios..." rows="4" style="width:100%; margin: 8px 0;"></textarea>
              <button class="btn btn-primary" id="addJob">Publicar Empleo</button>
            </div>
            <div class="row" style="padding: 0 5px; margin-bottom: 10px;">
                <input id="jobSearchInput" placeholder="Buscar empleos por título o empresa...">
            </div>
            <div id="jobsList" style="max-height: 60vh; overflow-y:auto; padding: 5px;"></div>
        </div>
    </div>
</div>
</section>

<!-- 
============================================================================
MÓDULO: CHAT GLOBAL
============================================================================
-->
<section class="panel full-height-panel" id="gchat" style="display:none">
    <div class="gchat-grid">
        <!-- Columna de Lista de Usuarios -->
        <div class="card">
            <b>Usuarios Conectados</b>
            <div id="gUserList" class="user-list" style="margin-top:8px; flex:1; overflow-y:auto;"></div>
        </div>
        <!-- Columna de Chat Activo -->
        <div class="card">
            <h3 id="gChatHeader" style="margin: 0 0 10px 0;">Chat Global: #general</h3>
            <div id="gChatLog" class="chat-log" style="flex:1;"></div>
            <div class="row" style="padding-top:10px;"><input class="spacer" id="gChatMsg" placeholder="Escribe un mensaje..."/><button class="btn btn-primary" id="sendGChat"><i data-lucide="send"></i></button></div>
        </div>
    </div>
</section>

<!-- 
============================================================================
MÓDULO: ASISTENTE DE MONETIZACIÓN (¡TOTALMENTE REDISEÑADO!)
============================================================================
-->
<section class="panel" id="monet" style="display:none; padding:16px;">
    <div class="card" style="text-align: center; background: linear-gradient(145deg, color-mix(in hsl, var(--brand) 85%, black), color-mix(in hsl, var(--accent) 85%, black)); color: white; padding: 24px; margin-bottom: 16px;">
        <h2 style="margin:0 0 8px 0;">🚀 Conviértete en Socio Estratégico Goatify IA</h2>
        <p style="opacity: 0.9; font-size: var(--lg); max-width: 800px; margin: 0 auto 16px;">Genera ingresos reales con comisiones de hasta el <strong>50%</strong>. Te damos las herramientas, el sistema y el soporte para que vendas soluciones de IA a empresas y emprendedores.</p>
        <p style="opacity: 0.8; font-size: var(--sm); margin:0;">Al unirte al <strong>Paquete Pro ($4/mes)</strong>, quedas automáticamente inscrito en el programa de socios.</p>
    </div>

    <h3 style="margin-top: 16px; padding-left: 8px;">Nuestros Servicios (Tu Portafolio de Ventas)</h3>
    <p class="sub" style="padding-left: 8px; margin-top: -8px; margin-bottom: 16px;">Estas son las soluciones de alto valor que puedes ofrecer a tus clientes:</p>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
        
        <!-- Card 1: Kit de Branding -->
        <div class="service-card">
            <div>
                <div class="commission">40%</div>
                <div class="commission-label">Comisión</div>
            </div>
            <h4>1. Kit de Branding con IA</h4>
            <p>Tu marca lista en minutos (Logo, paleta, tipografía). ¡Fácil de vender a emprendedores!</p>
        </div>

        <!-- Card 2: Aplicaciones a Medida -->
        <div class="service-card">
            <div>
                <div class="commission">35%</div>
                <div class="commission-label">Comisión</div>
            </div>
            <h4>2. Aplicaciones a tu Medida</h4>
            <p>Desarrollo de apps inteligentes personalizadas para automatizar y gestionar tu negocio.</p>
        </div>

        <!-- Card 3: Videos Promocionales -->
        <div class="service-card">
            <div>
                <div class="commission">30%</div>
                <div class="commission-label">Comisión</div>
            </div>
            <h4>3. Videos Promocionales con IA</h4>
            <p>Creación de avatares hiperrealistas que venden y presentan sin cámaras ni actores.</p>
        </div>

        <!-- Card 4: Consultoría -->
        <div class="service-card">
            <div>
                <div class="commission" style="color: var(--success);">50%</div>
                <div class="commission-label">Comisión</div>
            </div>
            <h4>4. Consultoría Empresarial en IA</h4>
            <p>Máxima ganancia. Estrategias y soluciones inteligentes para optimizar procesos empresariales.</p>
        </div>

        <!-- Card 5: Sitios Web Smart -->
        <div class="service-card">
            <div>
                <div class="commission">30%</div>
                <div class="commission-label">Comisión</div>
            </div>
            <h4>5. Sitios Web Smart</h4>
            <p>Páginas web completas (código, e-commerce, dominio) listas para vender 24/7.</p>
        </div>

        <!-- Card 6: Goatify.app -->
        <div class="service-card">
            <div>
                <div class="commission">30%</div>
                <div class="commission-label">Comisión</div>
            </div>
            <h4>6. Goatify.app (Suscripción)</h4>
            <p>Tu súper app impulsada por IA (GPT/Gemini). El complemento perfecto para tu negocio.</p>
        </div>

        <!-- Card 7: Capacitación -->
        <div class="service-card">
            <div>
                <div class="commission">45%</div>
                <div class="commission-label">Comisión</div>
            </div>
            <h4>7. Capacitamos a tu Equipo en IA</h4>
            <p>Entrenamientos personalizados para mejorar la productividad de tu personal.</p>
        </div>

        <!-- Card 8: Agentes de Venta -->
        <div class="service-card">
            <div>
                <div class="commission">38%</div>
                <div class="commission-label">Comisión</div>
            </div>
            <h4>8. Agentes de Venta IA 24/7</h4>
            <p>Vendedores virtuales tipo agentes inteligentes que atienden y cierran ventas automáticas.</p>
        </div>

    </div>
</section>

<!-- 
============================================================================
MÓDULO: BIENESTAR Y MINDSET
============================================================================
-->
<section class="panel" id="mindset" style="display:none; padding: 16px;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; align-items: start;">
        <div class="card">
            <h3><i data-lucide="brain-circuit"></i> Balance Mente-Cuerpo</h3>
            <p class="sub">El verdadero éxito no es solo alcanzar metas, sino mantener un equilibrio saludable. Tu bienestar es la base de tu productividad y creatividad.</p>
            <p class="sub" style="font-size: var(--sm);">Una parte clave del balance es mejorar tus habilidades sociales y hacer networking. Por eso hemos creado el Chat Global, un espacio para que conectes con otros profesionales.</p>
            <div class="row" style="margin-top: 16px;">
                <a href="#!gchat" class="btn btn-primary nav-link-btn" style="width: 100%;">
                    <i data-lucide="messages-square"></i>
                    <span>Ir al Chat Global</span>
                </a>
            </div>
        </div>
        <div class="card" style="text-align:center;">
            <h3><i data-lucide="wind"></i> Pausa para Respirar</h3>
            <p class="sub">Tómate un minuto para centrarte.</p>
            <div id="breathing-circle-container">
                <div id="breathing-circle"></div>
                <span id="breathing-text">Inhala...</span>
            </div>
        </div>
        <div class="card">
            <h3><i data-lucide="dumbbell"></i> Momento de Actividad</h3>
            <p class="sub">El movimiento impulsa la mente. Estira tu cuerpo o prepárate para una rutina de entrenamiento completa para recargar tu energía.</p>
            <div class="row" style="margin-top: 16px; justify-content: center;">
                <a href="https://www.goatify.app/fit" target="_blank" class="btn btn-primary" style="width: 100%;">
                    <i data-lucide="external-link"></i>
                    <span>Entrenar con goatiFIT (Rutinas Gratis)</span>
                </a>
            </div>
        </div>
         <div class="card">
            <h3><i data-lucide="quote"></i> Dosis de Inspiración</h3>
            <p class="sub" id="mindsetQuote">"El éxito es la suma de pequeños esfuerzos repetidos día tras día."</p>
        </div>
    </div>
</section>

<!-- 
============================================================================
MÓDULO: AJUSTES (¡TOTALMENTE REDISEÑADO!)
============================================================================
-->
<section class="panel" id="settings" style="display:none; padding:16px;">
    <h2 style="margin-top: 8px; padding-left: 8px;">Ajustes de Suscripción</h2>
    <p class="sub" style="padding-left: 8px; margin-top: -12px; margin-bottom: 24px;">Gestiona tu plan y desbloquea todo el potencial de Goatify IA.</p>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; align-items: stretch;">
        
        <!-- Plan Gratuito -->
        <div class="plan-card">
            <h3>Plan Gratuito</h3>
            <p class="price">GRATIS</p>
            <p class="price-sub">Para siempre</p>
            
            <button class="btn" style="width: 100%;" disabled>Tu Plan Actual</button>
            
            <ul style="margin-top: 24px;">
                <li class="limited"><i data-lucide="check"></i><strong>3</strong> Proyectos</li>
                <li class="limited"><i data-lucide="check"></i><strong>50</strong> Tareas Totales</li>
                <li class="limited"><i data-lucide="check"></i><strong>100</strong> Sub-tareas</li>
                <li class="limited"><i data-lucide="check"></i><strong>10</strong> Entradas/mes en Calendario General</li>
                <li class="limited"><i data-lucide="check"></i><strong>20</strong> Respuestas de IA / día</li>
                <li class="excluded"><i data-lucide="x"></i>Acceso a Goatify X (Código)</li>
                <li class="excluded"><i data-lucide="x"></i>Programa de Socios (Monetización)</li>
                <li class="excluded"><i data-lucide="x"></i>Página Web Gratis</li>
            </ul>
        </div>
        
        <!-- Plan PRO -->
        <div class="plan-card pro-plan">
            <h3>Paquete PRO</h3>
            <p class="price">$4<span style="font-size: 1.5rem; color: var(--sub); font-weight: 500;">/mes</span></p>
            <p class="price-sub">Facturado mensualmente</p>
            
            <button class="btn btn-primary" style="width: 100%; padding: 12px; font-size: var(--lg);">Subir a PRO</button>
            
            <ul style="margin-top: 24px;">
                <li><i data-lucide="check"></i><strong>Proyectos Ilimitados</strong></li>
                <li><i data-lucide="check"></i><strong>Tareas Ilimitadas</strong></li>
                <li><i data-lucide="check"></i><strong>Respuestas de IA Ilimitadas</strong></li>
                <li><i data-lucide="check"></i>Acceso a <strong>Modelos de IA TOP</strong> (GPT, Gemini)</li>
                <li><i data-lucide="check"></i>Súper HUB de Dirección de Proyectos</li>
                <li><i data-lucide="check"></i>Acceso a <strong>Goatify X</strong> (Programación de Código)</li>
                <li><i data-lucide="check"></i>Acceso al <strong>Programa de Socios (Monetización)</strong></li>
                <li><i data-lucide="check"></i><strong>Una Página Web Gratis</strong></li>
                <li><i data-lucide="check"></i>Todos los beneficios de $20 ¡por solo $4!</li>
            </ul>
        </div>
    </div>
    
    <!-- Sección de Exportar/Importar (Mantenida de la versión anterior) -->
    <div class="card" style="margin-top: 24px; background: var(--surface);">
        <b>Gestión de Datos (LocalStorage)</b>
        <p class="sub" style="font-size: var(--sm);">Realiza copias de seguridad de tus datos. Actualmente todo se guarda localmente en tu navegador.</p>
        <div class="row" style="margin-top:8px">
            <button class="btn" id="btnExport">Exportar Datos (.json)</button>
            <label class="btn">Importar Datos<input type="file" accept="application/json" id="btnImport" style="display:none;"/></label>
            <button class="btn" id="resetApp" style="background:var(--danger); color:white; border-color: var(--danger);">Reset Total</button>
        </div>
    </div>
</section>
</main>
</div> <!-- Fin de .container -->

<!-- 
============================================================================
OVERLAY PARA MENÚ MÓVIL
============================================================================
-->
<div id="menu-overlay"></div>

<!-- 
============================================================================
MODALES DE LA APLICACIÓN
============================================================================
-->
<!-- Modal: Selección de Industria (Onboarding) -->
<dialog id="industryModal">
    <div style="padding: 24px; text-align: center;">
        <i data-lucide="briefcase" width="48" height="48" style="color: var(--brand);"></i>
        <h2 style="margin-top: 10px;">¡Bienvenido a Goatify IA!</h2>
        <p class="sub">Para empezar, personalicemos tu espacio de trabajo. ¿Cuál es tu industria o tipo de negocio?</p>
        <div class="card" style="text-align: left;">
             <label for="industrySelect">Selecciona tu Industria:</label>
             <select id="industrySelect" style="width: 100%; margin: 12px 0;">
                <option value="agency">Agencia de Marketing / Servicios</option>
                <option value="ecommerce">E-commerce / Tienda Online</option>
                <option value="creator">Creador de Contenido / Marca Personal</option>
                <option value="generic">Otro / General</option>
            </select>
            <button class="btn btn-primary" id="loadIndustryBtn" style="width: 100%;">Personalizar y Empezar</button>
        </div>
    </div>
</dialog>

<!-- Modal: Input Genérico -->
<dialog id="inputModal">
    <div style="padding: 24px;">
        <h3 id="inputModalTitle" style="margin-top:0"></h3>
        <p id="inputModalDesc" class="sub"></p>
        <input id="inputModalInput" style="margin-bottom: 12px;"/>
        <div class="row" style="margin-top: 24px;">
            <button class="btn" onclick="$('#inputModal').close()">Cancelar</button>
            <span class="spacer"></span>
            <button class="btn btn-primary" id="inputModalConfirm">Confirmar</button>
        </div>
    </div>
</dialog>

<!-- Modal: Detalles de Tarea -->
<dialog id="taskDetailModal">
    <div style="padding: 24px; display: flex; flex-direction: column; max-height: 85vh;">
        <div class="row">
            <h3 style="margin-top:0">Detalles de la Tarea</h3>
            <span class="spacer"></span>
            <button class="btn btn-ghost" onclick="$('#taskDetailModal').close()"><i data-lucide="x"></i></button>
        </div>
        <input type="hidden" id="taskDetailId">
        <div style="overflow-y: auto; padding-right: 10px;">
            <label>Título de la Tarea</label>
            <input id="taskDetailTitle" placeholder="¿Qué hay que hacer?" style="margin: 8px 0 16px; font-size: var(--lg); padding: 12px;" />
            
            <label>Descripción</label>
            <textarea id="taskDetailDesc" placeholder="Añade más detalles..." rows="4" style="margin: 8px 0 16px;"></textarea>
            
            <div class="row" style="gap: 16px; margin-bottom: 16px;">
                <div style="flex:1">
                    <label>Estado</label>
                    <select id="taskDetailStatus" style="margin-top: 8px;"></select>
                </div>
                <div style="flex:1">
                    <label>Fecha Límite</label>
                    <input type="date" id="taskDetailDue" style="margin-top: 8px;" />
                </div>
            </div>

             <div style="margin-bottom: 16px;">
                 <label>Carpeta</label>
                 <select id="taskDetailFolder" style="margin-top: 8px;"></select>
             </div>

             <div style="margin-bottom: 16px;">
                 <label>Tags (separados por coma)</label>
                 <input id="taskDetailTags" placeholder="Ej: urgente, diseño, cliente" style="margin-top: 8px;" />
             </div>
        </div>
        <div class="row" style="margin-top: 24px; border-top: 1px solid var(--line); padding-top: 16px;">
            <button class="btn" style="color:var(--danger); border-color: var(--danger);" id="taskDetailDeleteBtn"><i data-lucide="trash-2"></i> Eliminar</button>
            <span class="spacer"></span>
            <button class="btn" onclick="$('#taskDetailModal').close()">Cancelar</button>
            <button class="btn btn-primary" id="taskDetailSaveBtn"><i data-lucide="save"></i> Guardar Cambios</button>
        </div>
    </div>
</dialog>

<!-- Modal: Límite de Acciones (Upsell) -->
<dialog id="limitModal">
    <div style="padding: 24px; text-align: center;">
        <button onclick="$('#limitModal').close()" class="btn btn-ghost" style="position:absolute; top:10px; right:10px;"><i data-lucide="x"></i></button>
        <i data-lucide="zap" width="48" height="48" style="color: var(--brand);"></i>
        <h2 style="margin-top: 10px;">¡Has alcanzado el límite del Plan Gratuito!</h2>
        <p class="sub" id="limitModalText">Has alcanzado el número máximo de [acción] permitidas en el plan gratuito.</p>
        <div class="card" style="text-align: left; background: color-mix(in hsl, var(--brand) 8%, transparent); border-left: 4px solid var(--brand);">
            <h3 style="margin-top:0;">Desbloquea todo con PRO por $4/mes</h3>
            <ul style="padding-left: 20px; display: grid; gap: 8px;">
                <li><i data-lucide="check" style="color: var(--success); width: 16px; height: 16px;"></i> Proyectos y Tareas Ilimitadas</li>
                <li><i data-lucide="check" style="color: var(--success); width: 16px; height: 16px;"></i> Respuestas de IA Ilimitadas</li>
                <li><i data-lucide="check" style="color: var(--success); width: 16px; height: 16px;"></i> Acceso a Goatify X (Código)</li>
                <li><i data-lucide="check" style="color: var(--success); width: 16px; height: 16px;"></i> Programa de Socios para Monetizar</li>
            </ul>
        </div>
        <button class="btn btn-primary" id="limitModalUpgradeBtn" style="width: 100%; margin-top: 16px; padding: 12px;">Subir a PRO Ahora</button>
    </div>
</dialog>

<!-- Modal: Videollamada (Placeholder) -->
<dialog id="videoCallModal">
    <div style="padding: 24px; text-align: center;">
        <h3 id="videoCallTitle">Llamando a...</h3>
        <p class="sub">Esperando que acepte la llamada.</p>
        <div style="width: 120px; height: 120px; border-radius: 50%; background: var(--muted); margin: 20px auto; display:flex; align-items:center; justify-content:center;"><i data-lucide="video" size="48"></i></div>
        <button class="btn" style="background:var(--danger); color:white;" onclick="$('#videoCallModal').close()">Cancelar Llamada</button>
    </div>
</dialog>

<!-- Modal: Módulo de Monetización (Ya no se usa, el contenido está en la página) -->
<dialog id="monetModuleModal">
    <div style="padding: 24px; display: flex; flex-direction: column; max-height: 85vh;">
         <div class="row">
            <h3 id="monetModuleTitle" style="margin-top:0; color: var(--brand);"></h3>
            <span class="spacer"></span>
            <button onclick="$('#monetModuleModal').close()" class="btn btn-ghost"><i data-lucide="x"></i></button>
        </div>
        <div id="monetModuleContent" style="overflow-y: auto; padding-right: 10px;"></div>
    </div>
</dialog>

<!-- Modal: Billetera General (¡TOTALMENTE REDISEÑADO!) -->
<dialog id="walletModal">
    <div style="padding: 0; display: flex; flex-direction: column; max-height: 85vh; width: 600px;">
        <!-- Header -->
        <div style="padding: 16px 24px; border-bottom: 1px solid var(--line); flex-shrink: 0;">
            <div class="row">
                <h3 style="margin:0;"><i data-lucide="wallet"></i> Billetera Goatify</h3>
                <span class="spacer"></span>
                <button onclick="$('#walletModal').close()" class="btn btn-ghost"><i data-lucide="x"></i></button>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div style="padding: 0 24px 24px; overflow-y: auto; flex-grow: 1;">
            <!-- Pestañas -->
            <div class="tabs" id="walletTabs" style="padding: 16px 0; margin-bottom: 16px;">
                <button class="tab active" data-wtab="intis">Mis Intis ✨</button>
                <button class="tab" data-wtab="transfer">Transferir / Pagar</button>
                <button class="tab" data-wtab="history">Historial $ (Legacy)</button>
            </div>

            <!-- Pestaña 1: Intis -->
            <div id="w-tab-intis">
                <div class="card" style="text-align: center; background: color-mix(in hsl, var(--brand) 10%, transparent);">
                    <h4 style="margin:0; color: var(--sub); font-weight: 500;">Balance Total de Intis</h4>
                    <p id="walletIntisBalance" style="font-size: 3rem; font-weight: 700; color: var(--brand); margin: 8px 0;">0</p>
                    <p class="sub" style="margin:0; font-size: var(--sm);">Gana Intis usando la app. ¡Te pagamos por trabajar!</p>
                </div>
                <h4 style="margin-top: 24px;">¿Qué son los Intis?</h4>
                <p class="sub" style="font-size: var(--sm); margin-top: -8px;">
                    Los <strong>Intis</strong> son nuestra moneda digital. Gánalos completando tareas, creando proyectos y participando en la comunidad.
                    <br><br>
                    Puedes usarlos para <strong>transferir a otros usuarios</strong>, pagar por servicios dentro de Goatify, o canjearlos por cursos en el <strong>Centro Iberoamericano de Educación</strong> y descuentos con marcas aliadas.
                </p>
                <!-- Notificación de Canje -->
                <div id="walletRedeemInfo" class="card" style="display:none; margin-top: 16px; background: color-mix(in hsl, var(--success) 10%, transparent); border-color: var(--success);">
                    <div class="row" style="flex-wrap: nowrap; align-items: flex-start; gap: 12px;">
                        <i data-lucide="gift" style="color: var(--success); margin-top: 2px; flex-shrink: 0;"></i>
                        <div>
                            <h4 style="margin:0; color: var(--success);">¡Felicidades!</h4>
                            <p class="sub" style="margin: 4px 0 0;">¡Has alcanzado <strong><span id="redeemAmount"></span> Intis</strong>! Ya puedes canjear tu primera recompensa.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña 2: Transferir Intis -->
            <div id="w-tab-transfer" style="display:none;">
                <h4 style="margin-top:0;">Transferir Intis a otro Usuario</h4>
                <p class="sub" style="font-size: var(--sm); margin-top: -8px;">Envía Intis a tus colaboradores o paga servicios dentro de la app.</p>
                <label>ID del Usuario de Destino</label>
                <input id="walletTransferUserID" placeholder="Pega el User ID (Ej: aB3x...)" style="margin-top: 8px;">
                <label style="margin-top: 16px;">Monto de Intis</label>
                <input id="walletTransferAmount" type="number" placeholder="0" style="margin-top: 8px;">
                <label style="margin-top: 16px;">Nota (Opcional)</label>
                <input id="walletTransferNote" placeholder="Ej: Pago por diseño de logo" style="margin-top: 8px;">
                
                <button id="walletPerformTransfer" class="btn btn-primary" style="width: 100%; margin-top: 24px; padding: 12px;">
                    <i data-lucide="send"></i> Realizar Transferencia
                </button>

                <!-- Recibo de Transferencia -->
                <div id="intisReceipt" style="display:none; margin-top: 24px;">
                    <pre id="intisReceiptContent"></pre>
                    <button id="closeIntisReceipt" class="btn btn-sm" style="width: 100%; margin-top: 16px;">Cerrar Recibo</button>
                </div>
            </div>

            <!-- Pestaña 3: Historial $ (Legacy) -->
            <div id="w-tab-history" style="display:none;">
                <p class="sub" style="font-size: var(--sm); margin-top: 0;">Este es tu historial de transacciones en Dólares (legacy). Las nuevas transacciones se basan en Intis.</p>
                <div class="row">
                    <input id="wMonto" placeholder="Monto $" type="number" step="0.01" style="flex: 1;"/>
                    <select id="wTipo" style="flex: 1;"><option>Ingreso</option><option>Egreso</option></select>
                </div>
                <div class="row" style="margin-top:8px">
                    <input id="wCat" placeholder="Categoría" class="spacer"/>
                    <input id="wNota" placeholder="Nota" class="spacer"/>
                </div>
                <button class="btn" id="wAdd" style="width:100%; margin-top:8px;">+ Añadir Movimiento $ (Legacy)</button>
                
                <div class="table-wrapper" style="overflow-y: auto; max-height: 200px; padding-right: 10px; margin-top: 16px;">
                    <table style="width:100%;">
                        <thead><tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Cat</th><th></th></tr></thead>
                        <tbody id="wBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</dialog>

<!-- Modal: Intis (Gamificación) - (Este modal ya no es necesario, se integró en la Billetera) -->
<dialog id="intisModal">
     <div style="padding: 24px; text-align: center;">
        <button onclick="$('#intisModal').close()" class="btn btn-ghost" style="position:absolute; top:10px; right:10px;"><i data-lucide="x"></i></button>
        <i data-lucide="sparkles" width="48" height="48" style="color: var(--brand);"></i>
        <h2 style="margin-top: 10px;">¿Qué son los Intis? ✨</h2>
        <p class="sub">Los Intis son nuestra moneda de gamificación. ¡Gánalos usando la app y canjéalos por recompensas!</p>
        <div class="card" style="text-align: left;">
            <h4 style="margin-top:0">Reglas para Ganar Intis</h4>
            <ul id="intisRulesList" style="padding-left: 20px;">
                <!-- Se llenará con JS -->
            </ul>
             <h4 style="margin-top:1em;">¿Para qué sirven?</h4>
             <p>Transfiere Intis a otros usuarios o canjéalos por cursos en el <strong>Centro Iberoamericano de Educación</strong> y servicios de Goatify.</p>
        </div>
    </div>
</dialog>

<!-- Modal: Enviar Chat a Proyecto -->
<dialog id="sendChatModal">
    <div style="padding: 24px;">
        <h3 id="sendChatModalTitle" style="margin-top:0">Enviar Conversación a Proyecto</h3>
        <p class="sub">Selecciona el proyecto de destino:</p>
        <select id="sendChatProjectSelect" style="width: 100%; margin: 12px 0;"></select>
        <div class="row" style="margin-top: 24px;">
            <button class="btn" onclick="$('#sendChatModal').close()">Cancelar</button>
            <span class="spacer"></span>
            <button class="btn btn-primary" id="sendChatConfirmBtn">Confirmar</button>
        </div>
    </div>
</dialog>

<!-- Modal: Nueva Tarea (desde Cronopost) -->
<dialog id="cronoTaskModal">
    <div style="padding: 24px; display: flex; flex-direction: column; max-height: 85vh;">
        <div class="row">
            <h3 id="cronoTaskModalTitle" style="margin-top:0">Nueva Tarea</h3>
             <span class="spacer"></span>
            <button class="btn btn-ghost" onclick="$('#cronoTaskModal').close()"><i data-lucide="x"></i></button>
        </div>
        <p id="cronoTaskModalDesc" class="sub"></p>
        
        <div style="overflow-y: auto; padding-right: 10px;">
            <label>Título de la Tarea</label>
            <input id="cronoTaskTitle" placeholder="¿Qué hay que hacer?" style="margin: 8px 0 16px; font-size: var(--lg); padding: 12px;" />
            
            <label>Descripción</label>
            <textarea id="cronoTaskDesc" placeholder="Añade más detalles..." rows="3" style="margin: 8px 0 16px;"></textarea>
            
            <div class="row" style="gap: 16px; margin-bottom: 16px;">
                <div style="flex:1">
                    <label>Asignar a Proyecto</label>
                    <select id="cronoTaskProjectSelect" style="margin-top: 8px;"></select>
                </div>
                <div style="flex:1">
                    <label>Estado Inicial</label>
                    <select id="cronoTaskStatusSelect" style="margin-top: 8px;">
                    </select>
                </div>
            </div>

             <div style="margin-bottom: 16px;">
                 <label>Tags (separados por coma)</label>
                 <input id="cronoTaskTags" placeholder="Ej: urgente, marketing" style="margin-top: 8px;" />
             </div>
        </div>
        
        <div class="row" style="margin-top: 24px; border-top: 1px solid var(--line); padding-top: 16px;">
            <button class="btn" onclick="$('#cronoTaskModal').close()">Cancelar</button>
            <span class="spacer"></span>
            <button class="btn btn-primary" id="cronoTaskConfirm">Crear Tarea</button>
        </div>
    </div>
</dialog>

<!-- Modal: Búsqueda -->
<dialog id="searchModal">
    <div style="padding: 24px; display: flex; flex-direction: column; max-height: 85vh;">
        <div class="row">
            <h3 style="margin-top:0">Resultados de Búsqueda</h3>
            <span class="spacer"></span>
            <button class="btn btn-ghost" onclick="$('#searchModal').close()"><i data-lucide="x"></i></button>
        </div>
        <div id="searchResults" style="overflow-y: auto; padding-right: 10px; margin-top: 16px;"></div>
    </div>
</dialog>

<!-- Modal: Finanzas de Proyecto -->
<dialog id="projectFinModal">
    <div style="padding: 24px;">
        <h3 style="margin-top:0">Nuevo Movimiento de Proyecto</h3>
        <div class="row" style="gap: 8px;">
            <input id="pF_Monto" placeholder="Monto" type="number" step="0.01" style="flex:1;"/>
            <select id="pF_Tipo" style="flex:1;">
                <option>Ingreso</option>
                <option>Egreso</option>
            </select>
        </div>
        <div class="row" style="margin-top:8px; gap: 8px;">
            <input id="pF_Cat" placeholder="Categoría" style="flex:1;"/>
            <input id="pF_Nota" placeholder="Nota" style="flex:1;"/>
        </div>
        <div class="row" style="margin-top: 24px;">
            <button class="btn" onclick="$('#projectFinModal').close()">Cancelar</button>
            <span class="spacer"></span>
            <button class="btn btn-primary" id="pF_Confirm">Añadir</button>
        </div>
    </div>
</dialog>

<!-- 
============================================================================
ELEMENTOS DEL TOUR GUIADO
============================================================================
-->
<div id="tour-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index: 1000;"></div>
<div id="tour-tooltip" style="display:none; position:fixed; background:var(--surface); color:var(--text); padding:16px; border-radius:var(--radius); z-index:1001; max-width:300px; box-shadow:var(--shadow); transition: top .3s ease, left .3s ease;">
    <h4 id="tour-title" style="margin-top:0;"></h4>
    <p id="tour-text" class="sub"></p>
    <div class="row">
        <span id="tour-step"></span>
        <span class="spacer"></span>
        <button class="btn" id="tour-prev">Anterior</button>
        <button class="btn btn-primary" id="tour-next">Siguiente</button>
    </div>
</div>

<!-- 
============================================================================
NOTIFICACIÓN TOAST
============================================================================
-->
<div id="toast" class="info"></div>

<!-- 
============================================================================
============================================================================
INICIO DE JAVASCRIPT (PARTE 2)
============================================================================
============================================================================
-->
<script>
// "use strict"; // Desactivado temporalmente para depuración si es necesario

/* ============================================================================
SECCIÓN 1: ESTADO GLOBAL Y MANEJO DE DATOS
============================================================================
*/
var S = {}; // El objeto de estado global
// Constantes para límites (configurables)
const FREE_PLAN_LIMITS = {
    projects: 3,
    tasks: 50,      // Tareas totales en toda la cuenta
    subtasks: 100,  // Aún no implementado, pero definido
    calendarEntries: 10, // Entradas al mes en Calendario General (posts+tareas)
    aiResponses: 20 // Respuestas de IA al día
};
// Estado para rastrear el uso diario/mensual
var usageTracker = {
    aiResponsesToday: 0,
    calendarEntriesThisMonth: 0,
    lastAiResetDate: new Date().toLocaleDateString(),
    lastCalendarResetMonth: new Date().getMonth()
};
const initialState = {
  version:'10.0-pro', // Versión actualizada con PRO, Gemini, límites, billetera
  userProfile: {
      industry: null,
      isPro: false, // Nuevo estado de suscripción
      userId: null, // ID de usuario (para Supabase/Firebase)
      firstName: '', // Nuevo: Nombre
      lastName: '', // Nuevo: Apellido
  },
  projects: [],
  activeProject: null,
  activeNav: 'ai-global-chat', // Vista predeterminada
  ui: {
      taskView: 'board',
      asideCollapsed: true,
      activeFolder: 'General',
      sidebarTopHeight: '50%',
      projectCollapsedState: {},
      pChatCollapsed: false,
      aiChatCollapsed: false,
      isGuest: false, // Nuevo: Indica si es sesión de invitado
      guestActionsCount: 0, // Nuevo: Contador para invitado
  },
  folders: {},
  tasks: {},
  notes: {},
  chats: {},
  tables: {},
  files: {},
  fin: {},
  cronopost: { posts: {}, ideas: {} },
  hub: {
    perfil: { id: null, nombre: 'Invitado', apellido: '', rol:'Visitante', bio:'Explorando Goatify IA', avatar: null, socials: {linkedin:'', twitter:''}},
    market:[],
    jobs:[],
    users: [ /* Datos de ejemplo - eliminar en producción */
        {id: 'u_ana', nombre: 'Ana', rol: 'Diseñadora UX', online: true, avatar: 'https://placehold.co/100x100/f87171/ffffff?text=A'},
        {id: 'u_carlos', nombre: 'Carlos', rol: 'Copywriter', online: false, avatar: 'https://placehold.co/100x100/38bdf8/ffffff?text=C'},
        {id: 'u_elena', nombre: 'Elena', rol: 'Project Manager', online: true, avatar: 'https://placehold.co/100x100/22c55e/ffffff?text=E'},
    ]
  },
  gchat: { messages:{'general': []}, dms: {}, activeChat: 'general' },
  monet: {}, // Ya no necesita contenido aquí
  mindset: { frequency: 'daily' },
  wallet: {
      intis: 0, // Intis ahora centralizados aquí
      transactions: [], // NUEVO: Historial de transferencias Intis
      legacyMovs: [] // Billetera antigua $
  },
  aiGlobalChat: { threads: [{id:'c_global_1', title:'Chat General'}], messages: {'c_global_1':[]}, activeThread: 'c_global_1', model: 'pro' },
  // Eliminado 'credits', ahora se maneja con límites diarios/mensuales
};
const INTIS_REWARDS = { // Centralizar recompensas Intis
    loadIndustry: 100,
    newProject: 50,
    publishHub: 20,
    completeTask: 10,
    createTask: 5,
    createNote: 5,
    createTable: 5,
    createIdea: 5,
    uploadFile: 5,
    chatGlobalMessage: 2,
    transferIntis: 1, // Pequeño incentivo por transferir
    // Añadido:
    login: 10, // Recompensa por iniciar sesión (una vez al día)
    addFinanceLegacy: 1 // Pequeño incentivo por usar billetera legacy
};
const INTIS_REDEEM_THRESHOLD = 500; // Puntos para la primera notificación de canje

/**
 * Guarda el estado global 'S' y el tracker de uso en localStorage.
 * Cambia a Supabase/Firebase si el usuario no es invitado.
 */
function save(){
    try {
        if (S.ui.isGuest) {
            localStorage.setItem('goatify_guest_state_v10', JSON.stringify(S));
            localStorage.setItem('goatify_usage_tracker_v10', JSON.stringify(usageTracker));
        } else {
            // AQUÍ IRÍA LA LÓGICA PARA GUARDAR EN SUPABASE/FIREBASE
            // Por ahora, simulamos guardando en localStorage también para usuarios logueados
            localStorage.setItem('goatify_user_state_v10', JSON.stringify(S));
            localStorage.setItem('goatify_usage_tracker_v10', JSON.stringify(usageTracker));
            console.log("Simulando guardado en DB para usuario logueado...");
        }
        syncHeader();
    } catch(e) {
        console.error("Error saving state:", e);
        showToast("Error: No se pudo guardar el estado.", "warn");
    }
}

/**
 * Carga el estado 'S' y el tracker desde localStorage o usa el estado inicial.
 * Prioriza datos de usuario sobre invitado si existen.
 * Realiza migraciones y comprobaciones de integridad.
 */
function load(){
    let rawState = localStorage.getItem('goatify_user_state_v10'); // Prioriza usuario logueado
    let source = 'user';
    if (!rawState) {
        rawState = localStorage.getItem('goatify_guest_state_v10'); // Cae a invitado
        source = 'guest';
    }
    // Carga versiones anteriores si no hay datos nuevos
    if (!rawState) rawState = localStorage.getItem('goatify_v9_2_final') || localStorage.getItem('goatify_v9_final') || localStorage.getItem('goatify_v9_nav') || localStorage.getItem('goatify_v8_7');

    S = rawState ? JSON.parse(rawState) : JSON.parse(JSON.stringify(initialState));

    // Carga tracker de uso
    let rawTracker = localStorage.getItem('goatify_usage_tracker_v10');
    usageTracker = rawTracker ? JSON.parse(rawTracker) : { ...usageTracker }; // Copia inicial si no existe

    // Determina si es invitado (si cargó de guest o si no había datos)
    S.ui.isGuest = (source === 'guest' || !rawState);
    if (!S.ui.guestActionsCount) S.ui.guestActionsCount = 0;

    // ----- Migraciones y Valores por Defecto -----
    if (!S.version || S.version !== initialState.version) {
        console.log(`Migrating from version ${S.version || 'unknown'} to ${initialState.version}`);
        // Aquí irían lógicas de migración más complejas si fueran necesarias
        S.version = initialState.version;
    }
    if (S.userProfile === undefined) S.userProfile = { ...initialState.userProfile };
    if (S.userProfile.isPro === undefined) S.userProfile.isPro = false;
    if (S.userProfile.userId === undefined) S.userProfile.userId = null;
    if (S.userProfile.firstName === undefined) S.userProfile.firstName = '';
    if (S.userProfile.lastName === undefined) S.userProfile.lastName = '';
    if (S.projects === undefined) S.projects = [];
    if (S.folders === undefined) S.folders = {};
    if (S.tasks === undefined) S.tasks = {};
    if (S.notes === undefined) S.notes = {};
    if (S.chats === undefined) S.chats = {};
    if (S.tables === undefined) S.tables = {};
    if (S.files === undefined) S.files = {};
    if (S.fin === undefined) S.fin = {};
    if (S.cronopost === undefined) S.cronopost = { posts: {}, ideas: {} };
    if (S.hub === undefined) S.hub = JSON.parse(JSON.stringify(initialState.hub));
    if (S.hub.perfil === undefined) S.hub.perfil = JSON.parse(JSON.stringify(initialState.hub.perfil));
    if (S.hub.perfil.socials === undefined) S.hub.perfil.socials = {linkedin:'', twitter:''};
    if (S.hub.market === undefined) S.hub.market = [];
    if (S.hub.jobs === undefined) S.hub.jobs = [];
    if (S.hub.users === undefined) S.hub.users = []; // Podrían cargarse desde DB
    if (S.gchat === undefined) S.gchat = JSON.parse(JSON.stringify(initialState.gchat));
    // Monetización ahora es estático en el HTML
    if (S.mindset === undefined) S.mindset = { frequency: 'daily' };
    if (S.wallet === undefined) S.wallet = { intis: 0, transactions: [], legacyMovs: [] };
    if (S.wallet.intis === undefined) S.wallet.intis = S.intis || 0; // Migrar Intis si existían fuera
    if (S.wallet.transactions === undefined) S.wallet.transactions = [];
    if (S.wallet.legacyMovs === undefined) S.wallet.legacyMovs = S.wallet.movs || []; // Migrar movs legacy
    delete S.intis; // Eliminar S.intis antiguo
    delete S.wallet.movs; // Eliminar S.wallet.movs antiguo
    if (S.aiGlobalChat === undefined) S.aiGlobalChat = JSON.parse(JSON.stringify(initialState.aiGlobalChat));
    if (S.ui === undefined) S.ui = { ...initialState.ui };
    if (S.ui.taskView === undefined) S.ui.taskView = 'board';
    if (S.ui.asideCollapsed === undefined) S.ui.asideCollapsed = true;
    if (S.ui.activeFolder === undefined) S.ui.activeFolder = 'General';
    if (S.ui.sidebarTopHeight === undefined) S.ui.sidebarTopHeight = '50%';
    if (S.ui.projectCollapsedState === undefined) S.ui.projectCollapsedState = {};
    if (S.ui.pChatCollapsed === undefined) S.ui.pChatCollapsed = false;
    if (S.ui.aiChatCollapsed === undefined) S.ui.aiChatCollapsed = false;
    if (S.ui.isGuest === undefined) S.ui.isGuest = true; // Default a invitado si no se define
    if (S.ui.guestActionsCount === undefined) S.ui.guestActionsCount = 0;


    // Asegurar estructura interna para cada proyecto existente
    S.projects.forEach(p => {
        const projId = p.id;
        if(!p.taskColumns) p.taskColumns = ['Backlog','En curso','Bloqueado','Hecho'];
        if (!S.folders[projId]) S.folders[projId] = ['General'];
        if (!S.tasks[projId]) S.tasks[projId] = { 'General': [] };
        // Asegurar que todas las carpetas tengan entrada en tasks y que las tareas tengan tags
        S.folders[projId].forEach(folderName => {
            if (!S.tasks[projId][folderName]) S.tasks[projId][folderName] = [];
            S.tasks[projId][folderName].forEach(task => { if (!task.tags) task.tags = []; });
        });
        if (!S.notes[projId]) S.notes[projId] = {list:[], active:null, bodies:{}, drawings:{}};
        if (!S.chats[projId]) S.chats[projId] = {threads:[], messages:{}, activeThread: null, model: 'pro'};
        if (!S.tables[projId]) S.tables[projId] = {list:[{id: 'tbl_default', name: 'Tabla 1'}], active: 'tbl_default', data: {'tbl_default': {cols:['Col 1'], rows:[]}}};
        if (!S.files[projId]) S.files[projId] = [];
        if (!S.fin[projId]) S.fin[projId] = {rows:[]}; // Finanzas de proyecto siguen siendo legacy $
        if (!S.cronopost.posts[projId]) S.cronopost.posts[projId] = {};
        if (!S.cronopost.ideas[projId]) S.cronopost.ideas[projId] = [];
    });
    // ----- Fin Migraciones -----

    // Resetear contadores diarios/mensuales si es necesario
    resetUsageTrackersIfNeeded();

    // Actualizar UI inicial
    syncHeader();
    document.body.classList.toggle('aside-collapsed', S.ui.asideCollapsed);
    applySidebarHeight();
    updateUILimits(); // Muestra/oculta elementos PRO
}

/**
 * Resetea los contadores de uso diario/mensual si ha pasado el día/mes.
 */
function resetUsageTrackersIfNeeded() {
    const today = new Date();
    const todayString = today.toLocaleDateString();
    const currentMonth = today.getMonth();

    if (usageTracker.lastAiResetDate !== todayString) {
        usageTracker.aiResponsesToday = 0;
        usageTracker.lastAiResetDate = todayString;
        console.log("AI usage reset for the day.");
    }
    if (usageTracker.lastCalendarResetMonth !== currentMonth) {
        usageTracker.calendarEntriesThisMonth = 0;
        usageTracker.lastCalendarResetMonth = currentMonth;
        console.log("Calendar usage reset for the month.");
    }
    // No necesita 'save()' aquí, se llamará después de la acción que lo necesite
}

/**
 * Aplica la altura guardada a las secciones del sidebar.
 */
function applySidebarHeight() {
    const topSection = $('aside .aside-middle-section');
    const bottomSection = $('aside .aside-bottom-section');
    if (topSection && bottomSection) {
        topSection.style.flexBasis = S.ui.sidebarTopHeight || '50%';
    }
}

/**
 * Sincroniza los valores de la billetera (Intis y legacy $) en el header.
 */
function syncHeader(){
  const legacyBalance = (S.wallet.legacyMovs || []).reduce((acc, mov) => acc + (mov.tipo === 'Ingreso' ? mov.monto : -mov.monto), 0);
  $('#wallet-amount').textContent = `$${legacyBalance.toFixed(2)}`; // Muestra balance legacy $
  $('#intis-amount').textContent = S.wallet.intis || 0; // Muestra Intis
}

/**
 * Verifica si se ha alcanzado un límite del plan gratuito.
 * @param {string} limitType - 'projects', 'tasks', 'subtasks', 'calendarEntries', 'aiResponses'.
 * @param {number} [currentCountOverride] - Opcional: Proporciona el recuento actual si no se puede calcular fácilmente desde S.
 * @returns {boolean} - True si el límite se ha alcanzado, false si no.
 */
function checkLimitReached(limitType, currentCountOverride) {
    if (S.userProfile.isPro) return false; // Los usuarios PRO no tienen límites

    let currentCount;
    let limit;

    switch (limitType) {
        case 'projects':
            currentCount = S.projects.length;
            limit = FREE_PLAN_LIMITS.projects;
            break;
        case 'tasks':
            // Suma todas las tareas de todos los proyectos y carpetas
            currentCount = S.projects.reduce((total, proj) => {
                return total + Object.values(S.tasks[proj.id] || {}).flat().length;
            }, 0);
            limit = FREE_PLAN_LIMITS.tasks;
            break;
        case 'subtasks': // Aún no implementado funcionalmente
            currentCount = 0; // Reemplazar con lógica real
            limit = FREE_PLAN_LIMITS.subtasks;
            break;
        case 'calendarEntries':
            currentCount = usageTracker.calendarEntriesThisMonth;
            limit = FREE_PLAN_LIMITS.calendarEntries;
            break;
        case 'aiResponses':
            currentCount = usageTracker.aiResponsesToday;
            limit = FREE_PLAN_LIMITS.aiResponses;
            break;
        default:
            console.warn("Unknown limit type:", limitType);
            return false;
    }

    // Usa el override si se proporcionó
    if (currentCountOverride !== undefined) {
        currentCount = currentCountOverride;
    }

    const reached = currentCount >= limit;
    if (reached) {
        showLimitModal(limitType); // Muestra el modal de upsell
    }
    return reached;
}

/**
 * Muestra el modal de límite alcanzado con un mensaje específico.
 * @param {string} limitType - El tipo de límite alcanzado.
 */
function showLimitModal(limitType) {
    const modal = $('#limitModal');
    const textEl = $('#limitModalText');
    let message = "Has alcanzado el límite de acciones para el plan gratuito.";

    switch (limitType) {
        case 'projects': message = `Has alcanzado el máximo de ${FREE_PLAN_LIMITS.projects} proyectos permitidos en el plan gratuito.`; break;
        case 'tasks': message = `Has alcanzado el máximo de ${FREE_PLAN_LIMITS.tasks} tareas totales permitidas en el plan gratuito.`; break;
        case 'calendarEntries': message = `Has alcanzado el máximo de ${FREE_PLAN_LIMITS.calendarEntries} entradas en el Calendario General este mes para el plan gratuito.`; break;
        case 'aiResponses': message = `Has alcanzado el máximo de ${FREE_PLAN_LIMITS.aiResponses} respuestas de IA hoy para el plan gratuito.`; break;
        case 'goatifyX': message = `Goatify X (generación de código) es una función exclusiva para usuarios PRO.`; break; // Caso específico
        case 'socios': message = `El programa de Socios es exclusivo para usuarios PRO.`; break; // Caso específico
        case 'guest': message = `Has realizado ${S.ui.guestActionsCount} acciones como invitado. Por favor, inicia sesión o regístrate para continuar.`; break; // Caso Invitado
    }

    textEl.textContent = message;
    // Añadir listener al botón de Upgrade (si no existe ya)
    const upgradeBtn = $('#limitModalUpgradeBtn');
    if (!upgradeBtn.dataset.listenerAttached) {
        upgradeBtn.onclick = () => {
             modal.close();
             // Navegar a la sección de ajustes/pro
             history.pushState({view: 'settings'}, '', `#!settings`);
             show('settings');
        };
        upgradeBtn.dataset.listenerAttached = 'true';
    }
    modal.showModal();
    lucide.createIcons(); // Para iconos en el modal
}


/**
 * Añade puntos de gamificación (Intis) y verifica umbral de canje.
 * @param {number} points - Puntos a añadir.
 * @param {string} reason - Razón para el log (usar claves de INTIS_REWARDS).
 */
function addIntis(points, reasonKey) {
    if (isNaN(points) || points <= 0) return;
    const reasonText = Object.keys(INTIS_REWARDS).find(key => INTIS_REWARDS[key] === points && key === reasonKey) || reasonKey;

    const oldIntis = S.wallet.intis || 0;
    S.wallet.intis = oldIntis + points;

    // Registrar transacción Intis (opcional, podría volverse pesado)
    // S.wallet.transactions.push({ id: 'tx'+Date.now(), type: 'earn', amount: points, reason: reasonText, date: new Date().toISOString() });

    save();
    showToast(`+${points} Intis ✨ (${reasonText})`, 'info');

    // Notificación de Canje (solo la primera vez que se cruza el umbral)
    if (oldIntis < INTIS_REDEEM_THRESHOLD && S.wallet.intis >= INTIS_REDEEM_THRESHOLD) {
        notifyRedeemAvailable(INTIS_REDEEM_THRESHOLD);
    }
}

/**
 * Muestra notificación (brillo) y mensaje en billetera al alcanzar umbral de canje.
 * @param {number} amount - El umbral alcanzado.
 */
function notifyRedeemAvailable(amount) {
    const chip = $('#intisChip');
    const redeemInfo = $('#walletRedeemInfo');
    const redeemAmount = $('#redeemAmount');

    chip?.classList.add('notify'); // Añade brillo al chip del header
    if (redeemInfo && redeemAmount) {
        redeemAmount.textContent = amount;
        redeemInfo.style.display = 'block'; // Muestra el mensaje en el modal de billetera
    }
    // Opcional: Quitar brillo después de un tiempo o al abrir la billetera
    setTimeout(() => chip?.classList.remove('notify'), 5000);
}

/**
 * Incrementa el contador de acciones del invitado y verifica el límite.
 * @returns {boolean} - True si el invitado puede continuar, false si alcanzó el límite.
 */
function incrementGuestAction() {
    if (!S.ui.isGuest) return true; // No aplica a usuarios logueados

    S.ui.guestActionsCount++;
    save(); // Guarda el contador actualizado

    if (S.ui.guestActionsCount > 10) {
        showLimitModal('guest');
        return false;
    }
    return true;
}


/* ============================================================================
SECCIÓN 2: FUNCIONES UTILITARIAS (Helpers)
============================================================================
*/
/**
 * Selector de DOM (Query Selector)
 * @param {string} sel - Selector CSS.
 * @returns {Element | null}
 */
const $ = sel => document.querySelector(sel);

/**
 * Selector de DOM Múltiple (Query Selector All)
 * @param {string} sel - Selector CSS.
 * @returns {NodeListOf<Element>}
 */
const $$ = sel => document.querySelectorAll(sel);

/**
 * Creador de elementos DOM.
 * @param {string} tag - Etiqueta HTML (ej: 'div').
 * @param {object} attrs - Atributos (ej: {class: 'clase', dataset: {id: 1}}).
 * @param  {...any} kids - Nodos hijos (texto o elementos).
 * @returns {Element}
 */
function el(tag, attrs={}, ...kids){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='dataset'){ Object.entries(v).forEach(([dk,dv])=>e.dataset[dk]=dv); }
    else if(k==='html'){ e.innerHTML = v; }
    else if(k==='textContent'){ e.textContent = v; }
    else if(k.startsWith('on') && typeof v === 'function') { e[k] = v; } // Asigna listeners si es función
    else e.setAttribute(k,v);
  });
  kids.forEach(k=>{ if(k !== null && k !== undefined) e.append(k); }); // Ignora null/undefined
  return e;
}

/**
 * Formatea una fecha localmente.
 * @param {string|Date} d - La fecha.
 * @param {string} type - 'datetime', 'date', 'short', 'receipt'.
 * @returns {string} - Fecha formateada.
 */
function fmtDate(d, type = 'datetime'){
    const dt = new Date(d);
    if (isNaN(dt)) return '';

    const year = dt.getFullYear();
    const month = String(dt.getMonth() + 1).padStart(2, '0');
    const day = String(dt.getDate()).padStart(2, '0');
    const hours = String(dt.getHours()).padStart(2, '0');
    const minutes = String(dt.getMinutes()).padStart(2, '0');
    const seconds = String(dt.getSeconds()).padStart(2, '0');

    if (type === 'date') return `${year}-${month}-${day}`;
    if (type === 'short') return dt.toLocaleDateString('es', { day: 'numeric', month: 'short' });
    if (type === 'receipt') return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;

    // 'datetime' (default)
    return dt.toLocaleString('es', { dateStyle: 'short', timeStyle: 'short'});
}

/**
 * Convierte un array 2D en una cadena CSV.
 * @param {Array<Array<any>>} rows - Array de filas.
 * @returns {string} - Cadena CSV.
 */
function csv(rows){ return rows.map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n'); }

/**
 * Inicia la descarga de un archivo de texto.
 * @param {string} filename - Nombre del archivo.
 * @param {string} text - Contenido del archivo.
 */
function download(filename, text){
  const a = el('a',{href:URL.createObjectURL(new Blob([text],{type:'text/plain;charset=utf-8'})), download:filename}); // Añadido charset
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); // Liberar memoria
}

/**
 * Muestra una notificación toast.
 * @param {string} message - Mensaje a mostrar.
 * @param {string} type - 'info', 'success', 'warn', 'danger'.
 */
let toastTimeout;
function showToast(message, type = 'info') {
    const toast = $('#toast');
    if (!toast) return;
    toast.textContent = message;
    toast.className = '';
    toast.classList.add(type, 'show');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 3000);
}

/**
 * Muestra el modal de input genérico.
 * @param {string} title - Título del modal.
 * @param {string} description - Descripción.
 * @param {string} placeholder - Placeholder del input.
 * @param {Function} callback - Función a ejecutar al confirmar (recibe el valor).
 * @param {string} [initialValue=''] - Valor inicial del input.
 * @param {string} [inputType='text'] - Tipo de input ('text', 'number', etc.).
 */
function showInputModal(title, description, placeholder, callback, initialValue = '', inputType = 'text') {
    $('#inputModalTitle').textContent = title;
    $('#inputModalDesc').textContent = description;
    const input = $('#inputModalInput');
    input.placeholder = placeholder;
    input.value = initialValue;
    input.type = inputType; // Establecer tipo de input

    const confirmBtn = $('#inputModalConfirm');
    // Clonar para remover listeners viejos
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    const handleConfirm = () => {
        const value = input.value.trim();
        // Validar confirmación de eliminación
        if ((placeholder === 'eliminar' && value.toLowerCase() !== 'eliminar') ||
            (placeholder === 'BORRAR TODO' && value !== 'BORRAR TODO')) {
            showToast('La confirmación no coincide.', 'warn');
            return;
        }
        // Validar campo vacío (excepto para confirmaciones)
        if (!value && placeholder !== 'eliminar' && placeholder !== 'BORRAR TODO') {
             showToast('Por favor, ingresa un valor.', 'warn');
             return;
        }

        callback(value);
        $('#inputModal').close();
    };

    newConfirmBtn.onclick = handleConfirm;
    // Permitir Enter para confirmar
    input.onkeydown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleConfirm();
        }
    };

    $('#inputModal').showModal();
    input.focus();
}

/**
 * Genera iniciales a partir de nombre y apellido.
 * @param {string} [firstName='']
 * @param {string} [lastName='']
 * @returns {string} - Iniciales (ej: "JD") o "?" si no hay nombres.
 */
function getInitials(firstName = '', lastName = '') {
    const firstInitial = firstName ? firstName[0].toUpperCase() : '';
    const lastInitial = lastName ? lastName[0].toUpperCase() : '';
    const initials = `${firstInitial}${lastInitial}`;
    return initials || '?'; // Devuelve '?' si no hay iniciales
}

/**
 * Función para simular llamada a API Gemini (Placeholder).
 * Incluye manejo de límites y lógica PRO.
 * @param {string} prompt - El prompt del usuario.
 * @param {string} modelType - 'pro', 'web', 'x'.
 * @returns {Promise<string>} - Promesa que resuelve con la respuesta simulada.
 */
async function callGeminiAPI(prompt, modelType) {
    if (!incrementGuestAction()) return Promise.reject("Guest limit reached"); // Verifica límite de invitado

    // Verifica límite de respuestas IA para plan gratuito
    if (!S.userProfile.isPro) {
        if (checkLimitReached('aiResponses')) {
            return Promise.reject("AI response limit reached for free plan.");
        }
        // Incrementa contador si no se alcanzó el límite
        usageTracker.aiResponsesToday++;
        save(); // Guarda el contador actualizado
        updateUILimits(); // Actualiza visualización del contador
    }

    // Verifica si se intenta usar Goatify X sin ser PRO
    if (modelType === 'x' && !S.userProfile.isPro) {
        showLimitModal('goatifyX');
        return Promise.reject("Goatify X requires PRO plan.");
    }

    // --- Simulación de llamada a API ---
    console.log(`Calling Gemini (Simulated) - Model: ${modelType}, Prompt: "${prompt}"`);
    showToast("Generando respuesta IA...", "info"); // Feedback visual

    // Simular delay de red
    await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));

    // Lógica de respuesta simulada
    let responseText = `Respuesta simulada del modelo ${modelType} para: "${prompt}". `;

    if (modelType === 'web') {
        responseText += `\n[Simulando búsqueda web] Los resultados indican que...`;
    }

    if (modelType === 'x') {
        responseText += `\nSoy Goatify X (PRO), más rápido y capaz. `;
        // Simular generación de código si el prompt lo pide
        if (prompt.toLowerCase().includes('genera código') || prompt.toLowerCase().includes('escribe un script')) {
             responseText += `Aquí tienes un ejemplo de código:\n[CODE]<!DOCTYPE html>
<html>
<head>
    <title>Goatify X Code</title>
    <style> body { font-family: sans-serif; background-color: #f0f0f0; padding: 20px; } button { padding: 10px 15px; background-color: #8b5cf6; color: white; border: none; border-radius: 5px; cursor: pointer; } </style>
</head>
<body>
    <h1>Código Generado por Goatify X (PRO)</h1>
    <p>Este es un ejemplo simple.</p>
    <button onclick="alert('¡Hola desde Goatify X!')">Haz Clic</button>
    <script> console.log('Script ejecutado!'); </script>
</body>
</html>
[/CODE]`;
        }
    } else {
        // Simular generación de código básica para otros modelos si se pide
         if (prompt.toLowerCase().includes('genera código html') || prompt.toLowerCase().includes('botón html')) {
             responseText += `Claro, aquí tienes un botón simple:\n[CODE]<button style="padding: 10px; background-color: #a78bfa; color: white; border: none; border-radius: 8px;">Botón Ejemplo</button>[/CODE]`;
         }
    }


    // Simular generación de imagen si se pide
    if (prompt.toLowerCase().includes('crea una imagen') || prompt.toLowerCase().includes('genera una foto')) {
        // En una implementación real, aquí se llamaría a la API de Imagen y se devolvería la URL o Base64
        const placeholderUrl = `https://placehold.co/512x512/0f172a/e2e8f0?text=Imagen+Generada+%0A(${prompt.substring(0, 30)}...)`;
        responseText += `\n¡Imagen generada! Aquí la tienes: \n![Imagen Generada](${placeholderUrl})`;
    }


    console.log("Simulated Gemini Response:", responseText);
    return responseText;
}


/* ============================================================================
SECCIÓN 3: NAVEGACIÓN PRINCIPAL Y UI CORE
============================================================================
*/

/**
 * Renderiza la lista de proyectos y carpetas en el aside.
 * Incluye lógica de plegado/desplegado y tooltips.
 */
function renderAside() {
  const list = $('#projList'); list.innerHTML='';
  const isCollapsed = document.body.classList.contains('aside-collapsed') && window.innerWidth > 1180;

  S.projects.forEach(p => {
    const isProjectCollapsed = S.ui.projectCollapsedState[p.id] === true;

    const item = el('a', {
        class:'projItem',
        dataset: {id: p.id, collapsed: isProjectCollapsed},
        href: `#!project/${p.id}`,
        title: isCollapsed ? p.name : '', // Tooltip solo cuando está colapsado
        onclick: (e) => {
            if (!incrementGuestAction()) { e.preventDefault(); return; } // Verifica invitado
            // Permitir click en toggle sin navegar
            if (!e.target.closest('.proj-toggle')) {
                e.preventDefault();
                history.pushState({view: `project/${p.id}`}, '', `#!project/${p.id}`);
                openProject(p.id);
            }
        }
      },
        el('span', { class: 'proj-toggle', onclick: (e) => { e.preventDefault(); e.stopPropagation(); toggleProjectCollapse(p.id); }},
            el('i', {'data-lucide': 'chevron-down', width: 16, height: 16})
        ),
        el('div', {class:'proj-color-dot', style:`background-color:${p.color}`}),
        el('span',{class: 'proj-text', textContent:p.name, title: p.name}),
        el('div', {class: 'proj-actions'},
            el('button', {class: 'btn btn-ghost btn-sm', title: 'Editar nombre', onclick: (e) => { e.stopPropagation(); e.preventDefault(); editProjectName(p.id); }}, el('i', {'data-lucide': 'edit-3', width: 14})),
            el('button', {class: 'btn btn-ghost btn-sm', title: 'Cambiar Color', onclick: (e) => { e.stopPropagation(); e.preventDefault(); changeProjectColor(p.id); }}, el('i', {'data-lucide': 'palette', width: 14})), // Nuevo botón color
            el('button', {class: 'btn btn-ghost btn-sm', title: 'Eliminar Proyecto', onclick: (e) => { e.stopPropagation(); e.preventDefault(); deleteProject(p.id); }}, el('i', {'data-lucide': 'trash-2', width: 14}))
        )
    );
    if (p.id === S.activeProject) item.classList.add('active');
    list.appendChild(item);

    const folderWrap = el('div', {class: 'mj-folder-list'});
    const folders = (S.folders[p.id] || ['General']);

    folders.forEach(f => {
        const folderRow = el('a', {
            class: 'mj-folder-row',
            href: `#!project/${p.id}/folder/${encodeURIComponent(f)}`,
            title: isCollapsed ? `${p.name} > ${f}` : f, // Tooltip
            onclick: (e) => {
                if (!incrementGuestAction()) { e.preventDefault(); return; } // Verifica invitado
                e.preventDefault();
                history.pushState({view: `project/${p.id}/folder/${f}`}, '', `#!project/${p.id}/folder/${encodeURIComponent(f)}`);
                openProject(p.id, f);
            }
        },
            el('span', {class: 'dot', style: `background-color:${p.color}`}),
            el('span', {class: 'label', textContent: f, title: f}),
            el('div', {class: 'mj-folder-actions'},
                 el('button', {class: 'btn btn-ghost btn-sm', title: 'Renombrar Carpeta', onclick: (e) => { e.stopPropagation(); e.preventDefault(); editFolderName(p.id, f); }}, el('i', {'data-lucide': 'edit-3', width: 14})),
                 f !== 'General' ? el('button', {class: 'btn btn-ghost btn-sm', title: 'Eliminar Carpeta', onclick: (e) => { e.stopPropagation(); e.preventDefault(); deleteFolder(p.id, f); }}, el('i', {'data-lucide': 'trash-2', width: 14})) : null
            )
        );
        folderWrap.appendChild(folderRow);
    });
    list.appendChild(folderWrap);
  });

  // Renderiza botones de navegación global con tooltips
  $$('#nav-list .navBtn[data-nav]').forEach(btn => {
      const navKey = btn.dataset.nav;
      const navText = btn.querySelector('span')?.textContent || navKey;
      btn.title = isCollapsed ? navText : ''; // Tooltip solo colapsado
      btn.classList.toggle('active', navKey === S.activeNav && !S.activeProject);
  });

  const pinnedBtn = $('.pinned-nav-item .navBtn');
  if (pinnedBtn) {
      const navKey = pinnedBtn.dataset.nav;
      const navText = pinnedBtn.querySelector('span')?.textContent || navKey;
      pinnedBtn.title = isCollapsed ? navText : ''; // Tooltip solo colapsado
      pinnedBtn.classList.toggle('active', pinnedBtn.dataset.nav === S.activeNav && !S.activeProject);
  }

  lucide.createIcons();
}

/**
 * Cambia el estado de plegado/desplegado de un proyecto en el aside.
 */
function toggleProjectCollapse(projectId) {
    if (!incrementGuestAction()) return; // Verifica invitado
    S.ui.projectCollapsedState[projectId] = !S.ui.projectCollapsedState[projectId];
    save();
    renderAside();
}

/**
 * Muestra una sección principal (módulo global).
 * @param {string} sectionId - ID del módulo a mostrar.
 */
function show(sectionId){
  if (!incrementGuestAction()) return; // Verifica invitado

  $$('main > section').forEach(s => s.style.display = 'none');
  const s = $('#'+sectionId);
  if(s) s.style.display='block';

  S.activeProject = null;
  S.activeNav = sectionId;
  save();

  renderAside();
  document.body.classList.remove('aside-open');

  // Renderiza contenido específico
  switch(sectionId) {
    case 'ai-global-chat': renderGlobalAIChat(); break;
    case 'cronopost': renderCronoPOST(); break;
    case 'hub': renderHub(); break;
    case 'gchat': renderGChat(); break;
    case 'monet': /* Ya no necesita render, es estático */ break;
    case 'mindset': setupMindset(); break;
    case 'settings': renderSettings(); break; // Renderiza sección de ajustes
  }
}

/**
 * Abre un proyecto específico.
 * @param {string} id - ID del proyecto.
 * @param {string} [folderName='General'] - Carpeta específica a activar.
 */
function openProject(id, folderName = 'General') {
    if (!incrementGuestAction()) return; // Verifica invitado

    S.activeProject = id;
    S.activeNav = null;
    S.ui.taskView = S.ui.taskView || 'board'; // Mantener vista si existe

    if (!(S.folders[id] || []).includes(folderName)) {
        folderName = 'General';
    }
    S.ui.activeFolder = folderName;
    save();

    $$('main > section').forEach(s => s.style.display = 'none');
    $('#projectShell').style.display='block';

    const p = S.projects.find(x=>x.id===id);
    $('#projectNameChip').textContent = p?.name || 'Proyecto';
    $('#projectNameChip').style.borderLeft = `3px solid ${p?.color || 'var(--brand)'}`;

    renderFolderSelector();
    renderAside();
    renderProject(); // Renderiza sub-módulos
    // Mantiene la pestaña activa si existe, sino va a overview
    const activeTab = $(`#project-tabs .tab.active`)?.dataset.ptab || 'overview';
    $(`#project-tabs .tab[data-ptab="${activeTab}"]`)?.click();
    document.body.classList.remove('aside-open');
}

/**
 * Renderiza el selector de carpetas y asigna su listener.
 */
function renderFolderSelector() {
    const projId = S.activeProject;
    if (!projId) return;
    const folderSel = $('#folderSel');
    folderSel.innerHTML = '';

    (S.folders[projId] || ['General']).forEach(f => folderSel.append(el('option', {textContent: f, value: f})));

    const currentFolder = (S.folders[projId] || []).includes(S.ui.activeFolder) ? S.ui.activeFolder : 'General';
    folderSel.value = currentFolder;
    S.ui.activeFolder = currentFolder;

    if (!folderSel.dataset.listenerAttached) {
        folderSel.addEventListener('change', (e) => {
            if (!incrementGuestAction()) { // Verifica invitado al CAMBIAR carpeta
                e.target.value = S.ui.activeFolder; // Revierte selección si se bloquea
                return;
            }
            S.ui.activeFolder = e.target.value;
            save();
            history.pushState({view: `project/${projId}/folder/${S.ui.activeFolder}`}, '', `#!project/${projId}/folder/${encodeURIComponent(S.ui.activeFolder)}`);
            renderTasks(); // Solo re-renderiza tareas
        });
        folderSel.dataset.listenerAttached = 'true';
    }
}

/**
 * Llama a todas las funciones de renderizado de los sub-módulos del proyecto.
 */
function renderProject() {
    renderOverview();
    renderCalendar();
    renderNotes();
    renderTables();
    renderFiles();
    renderProjectChat();
    renderFin();
    renderTasks();
}

/**
 * Actualiza la UI para reflejar el estado PRO y los límites.
 * Oculta/muestra elementos PRO, actualiza contadores.
 */
function updateUILimits() {
    const isPro = S.userProfile.isPro;

    // Elementos PRO en el Chat IA Global (Modelo X, Preview de código)
    const modelXCard = $(`#ai-chat-grid .model-card[data-model="x"]`);
    if (modelXCard) {
        modelXCard.classList.toggle('disabled', !isPro);
        modelXCard.title = isPro ? "Goatify X - Avanzado y veloz" : "Goatify X - Exclusivo para PRO";
    }
    // Habilitar/deshabilitar click en modelo X
    $$('#ai-chat-grid .model-card[data-model="x"]').forEach(card => card.onclick = isPro ? ()=>{ if(S.aiGlobalChat) S.aiGlobalChat.model = 'x'; save(); renderGlobalAIChat(); } : () => showLimitModal('goatifyX'));
    $$('#p-chat-grid .model-card[data-model="x"]').forEach(card => card.onclick = isPro ? ()=>{ const pid=S.activeProject; if(pid && S.chats[pid]) S.chats[pid].model = 'x'; save(); renderProjectChat(); } : () => showLimitModal('goatifyX'));


    // Mostrar/ocultar contador de IA y botón de upgrade
    const limitTracker = $('#ai-limit-tracker');
    const limitCount = $('#ai-limit-count');
    const upgradeBtn = $('#ai-limit-upgrade-btn');
    if (limitTracker && limitCount && upgradeBtn) {
        if (isPro) {
            limitTracker.style.display = 'none'; // Ocultar si es PRO
        } else {
            limitTracker.style.display = 'block'; // Mostrar si es Free
            limitCount.textContent = `${usageTracker.aiResponsesToday} / ${FREE_PLAN_LIMITS.aiResponses}`;
            // Mostrar botón de upgrade si está cerca o ha alcanzado el límite
            upgradeBtn.style.display = (usageTracker.aiResponsesToday >= FREE_PLAN_LIMITS.aiResponses * 0.8) ? 'block' : 'none';
        }
    }

    // Lógica para botones de Upgrade en Ajustes (si es necesario deshabilitarlos)
    // const settingsUpgradeBtn = $('#settings .pro-plan .btn-primary');
    // if (settingsUpgradeBtn) settingsUpgradeBtn.disabled = isPro;

    // Podríamos añadir lógica similar para otros elementos PRO si fuera necesario
}


/* ============================================================================
SECCIÓN 4: CRUD DE PROYECTOS Y CARPETAS
============================================================================
*/

/**
 * Muestra un modal para crear un nuevo proyecto y lo inicializa.
 */
function createNewProject() {
    if (!incrementGuestAction()) return; // Verifica invitado
    if (checkLimitReached('projects')) return; // Verifica límite

    showInputModal('Crear Nuevo Proyecto', 'Dale un nombre a tu nuevo espacio de trabajo.', 'Ej: Lanzamiento App Móvil', (name) => {
        const id = 'p' + Date.now();
        const color = `hsl(${Math.random() * 360}, 70%, 60%)`;

        S.projects.push({id, name, color, taskColumns: ['Backlog','En curso','Bloqueado','Hecho']});
        S.folders[id]=['General'];
        S.tasks[id]= { 'General': [] };
        S.notes[id]={list:[], active:null, bodies:{}, drawings:{}};
        S.chats[id]={threads:[], messages:{}, activeThread: null, model: 'pro'};
        S.tables[id]={list:[{id: 'tbl_default', name: 'Tabla 1'}], active: 'tbl_default', data: {'tbl_default': {cols:['Col 1'], rows:[]}}};
        S.files[id]=[];
        S.fin[id]={rows:[]};
        S.cronopost.posts[id] = {};
        S.cronopost.ideas[id] = [];
        S.ui.projectCollapsedState[id] = false;

        addIntis(INTIS_REWARDS.newProject, 'Proyecto nuevo');
        showToast('Proyecto creado!', 'success');
        save();

        history.pushState({view: `project/${id}`}, '', `#!project/${id}`);
        openProject(id, 'General');
        renderAside();
    });
}

/**
 * Edita el nombre de un proyecto.
 */
function editProjectName(projectId) {
    if (!incrementGuestAction()) return; // Verifica invitado
    const project = S.projects.find(p => p.id === projectId);
    if (!project) return;

    showInputModal('Editar Proyecto', 'Nuevo nombre para el proyecto:', project.name, (newName) => {
        if (!newName || newName === project.name) return;
        project.name = newName;
        save();
        renderAside();
        if (S.activeProject === projectId) {
             $('#projectNameChip').textContent = newName;
        }
        showToast('Proyecto renombrado', 'success');
    }, project.name);
}

/**
 * Permite cambiar el color de un proyecto.
 */
function changeProjectColor(projectId) {
    if (!incrementGuestAction()) return; // Verifica invitado
    const project = S.projects.find(p => p.id === projectId);
    if (!project) return;

    const picker = el('input', { type: 'color', value: project.color || '#a78bfa' });
    picker.oninput = (e) => {
        project.color = e.target.value;
        save();
        renderAside(); // Actualiza el punto de color
        if (S.activeProject === projectId) {
             $('#projectNameChip').style.borderLeftColor = project.color;
             // Opcional: Re-renderizar elementos que usen el color, como tareas en calendario
             renderCalendar();
             renderCronoPOST();
        }
    };
    picker.click(); // Abre el selector de color del navegador
}


/**
 * Elimina un proyecto completo (con confirmación).
 */
function deleteProject(projectId) {
    if (!incrementGuestAction()) return; // Verifica invitado
    const project = S.projects.find(p => p.id === projectId);
    if (!project) return;

    showInputModal('Confirmar Eliminación de Proyecto', `Esto eliminará "${project.name}" y TODO su contenido IRREVERSIBLEMENTE. Escribe "eliminar" para confirmar.`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            S.projects = S.projects.filter(p => p.id !== projectId);
            delete S.folders[projectId];
            delete S.tasks[projectId];
            delete S.notes[projectId];
            delete S.chats[projectId];
            delete S.tables[projectId];
            delete S.files[projectId];
            delete S.fin[projectId];
            delete S.cronopost.posts[projectId];
            delete S.cronopost.ideas[projectId];
            delete S.ui.projectCollapsedState[projectId];

            if (S.activeProject === projectId) {
                S.activeProject = null;
                S.activeNav = 'ai-global-chat';
                history.pushState({view: S.activeNav}, '', `#!${S.activeNav}`);
                show(S.activeNav);
            }

            save();
            renderAside();
            showToast(`Proyecto "${project.name}" eliminado.`, 'info');
        }
    });
}

/**
 * Añade una nueva carpeta al proyecto activo.
 */
function addFolder() {
    if (!incrementGuestAction()) return; // Verifica invitado
    const id = S.activeProject; if (!id) return;
    showInputModal('Nueva Carpeta', 'Nombre de la nueva carpeta:', 'Ej: Documentos', name => {
        if ((S.folders[id] || []).includes(name)) {
            showToast(`La carpeta "${name}" ya existe.`, 'warn');
            return;
        }
        if (!S.folders[id]) S.folders[id] = [];
        S.folders[id].push(name);
        if (!S.tasks[id]) S.tasks[id] = {};
        S.tasks[id][name] = [];
        save();

        history.pushState({view: `project/${id}/folder/${name}`}, '', `#!project/${id}/folder/${encodeURIComponent(name)}`);
        openProject(id, name);
    });
}

/**
 * Edita el nombre de una carpeta.
 */
function editFolderName(projectId, oldName) {
    if (!incrementGuestAction()) return; // Verifica invitado
    if (oldName === 'General') {
        showToast('La carpeta "General" no se puede renombrar.', 'warn');
        return;
    }

    showInputModal('Renombrar Carpeta', `Nuevo nombre para "${oldName}":`, oldName, (newName) => {
        if (!newName || newName === oldName) return;
        if ((S.folders[projectId] || []).includes(newName)) {
            showToast(`La carpeta "${newName}" ya existe.`, 'warn');
            return;
        }

        const folderIndex = (S.folders[projectId] || []).indexOf(oldName);
        if (folderIndex > -1) {
            S.folders[projectId][folderIndex] = newName;
        }

        if (S.tasks[projectId] && S.tasks[projectId][oldName]) {
            S.tasks[projectId][newName] = S.tasks[projectId][oldName];
            delete S.tasks[projectId][oldName];
            (S.tasks[projectId][newName] || []).forEach(task => { task.folder = newName; });
        } else {
             S.tasks[projectId][newName] = [];
        }

        if (S.activeProject === projectId && S.ui.activeFolder === oldName) {
            S.ui.activeFolder = newName;
            renderFolderSelector();
            history.pushState({view: `project/${projectId}/folder/${newName}`}, '', `#!project/${projectId}/folder/${encodeURIComponent(newName)}`);
        }

        save();
        renderAside();
        showToast('Carpeta renombrada', 'success');

    }, oldName);
}

/**
 * Elimina una carpeta (mueve tareas a 'General').
 */
function deleteFolder(projectId, folderName) {
    if (!incrementGuestAction()) return; // Verifica invitado
    if (folderName === 'General') {
        showToast('La carpeta "General" no se puede eliminar.', 'warn');
        return;
    }

    showInputModal('Confirmar Eliminación de Carpeta', `Las tareas se moverán a "General". Escribe "eliminar" para confirmar.`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            const tasksToMove = S.tasks[projectId]?.[folderName] || [];
            if (!S.tasks[projectId]['General']) S.tasks[projectId]['General'] = [];

            tasksToMove.forEach(task => {
                task.folder = 'General';
                S.tasks[projectId]['General'].push(task);
            });

            S.folders[projectId] = (S.folders[projectId] || []).filter(f => f !== folderName);
            delete S.tasks[projectId][folderName];

            if (S.activeProject === projectId && S.ui.activeFolder === folderName) {
                S.ui.activeFolder = 'General';
                history.pushState({view: `project/${projectId}/folder/General`}, '', `#!project/${projectId}/folder/General`);
                renderFolderSelector();
                renderTasks();
            }

            save();
            renderAside();
            showToast(`Carpeta "${folderName}" eliminada. Tareas movidas.`, 'info');
        }
    });
}


/* ============================================================================
SECCIÓN 5: SUB-MÓDULOS DE PROYECTO
============================================================================
*/

// --- 5.1: OVERVIEW ---
/**
 * Renderiza la pestaña de Overview del proyecto.
 * Cuenta todas las tareas de todas las carpetas.
 */
function renderOverview(){
    const id = S.activeProject; if(!id) return;
    const wrap = $('#ovr'); wrap.innerHTML = '';
    const p = S.projects.find(x => x.id === id);
    if (!p) return;

    const allTasks = Object.values(S.tasks[id] || {}).flat();
    const finance = S.fin[id] || {rows:[]}; // Finanzas de proyecto son legacy $
    const notes = S.notes[id]?.list || [];
    const files = S.files[id] || [];

    const createStatCard = (title, value, icon, color, tab) => {
        const card = el('div', { class: 'stat-card', style: `border-left: 4px solid ${color}` },
            el('div', { style: 'display:flex; align-items:center; gap:12px;' },
                el('div', { style: `padding:10px; border-radius:50%; background:color-mix(in hsl, ${color} 15%, transparent); color:${color}`}, el('i', {'data-lucide': icon})),
                el('div', {},
                    el('h4', { textContent: title }),
                    el('p', { textContent: value })
                )
            )
        );
        card.onclick = () => {
            if (!incrementGuestAction()) return; // Verifica invitado
            $(`#project-tabs .tab[data-ptab="${tab}"]`)?.click();
        };
        return card;
    };

    const doneColName = p.taskColumns[p.taskColumns.length - 1] || 'Hecho';
    const done = allTasks.filter(x => x.status === doneColName).length;
    const totalTasks = allTasks.length;
    const progress = totalTasks > 0 ? Math.round(done / totalTasks * 100) : 0;
    const sumIn = finance.rows.reduce((a, b) => a + (b.tipo === 'Ingreso' ? Number(b.monto) : 0), 0);
    const sumOut = finance.rows.reduce((a, b) => a + (b.tipo === 'Egreso' ? Number(b.monto) : 0), 0);

    wrap.append(createStatCard('Progreso de Tareas', `${progress}%`, 'check-circle', 'var(--brand)', 'tasks'));
    wrap.append(createStatCard('Tareas Pendientes', `${totalTasks - done}`, 'list-todo', 'var(--warn)', 'tasks'));
    wrap.append(createStatCard('Balance Neto ($)', `$${(sumIn - sumOut).toFixed(2)}`, 'scale', 'var(--success)', 'finance'));
    wrap.append(createStatCard('Archivos y Notas', `${files.length + notes.length}`, 'file-text', 'var(--accent)', 'files'));

    lucide.createIcons();
}

// --- 5.2: TAREAS (KANBAN & LISTA) ---
/**
 * Renderiza la pestaña de Tareas, filtrando por carpeta activa Y por tags.
 * CORREGIDO: Bug de duplicación y D&D.
 */
function renderTasks(){
    const view = S.ui.taskView;
    const isBoardView = view === 'board';
    $('#kanban-view').style.display = isBoardView ? 'block' : 'none';
    $('#list-view').style.display = isBoardView ? 'none' : 'block';
    $('#addColumnBtn').style.display = isBoardView ? 'inline-flex' : 'none';
    $('#viewToggleBoard').classList.toggle('active', isBoardView);
    $('#viewToggleList').classList.toggle('active', !isBoardView);

    const activeFolder = S.ui.activeFolder || 'General';
    const projId = S.activeProject;
    if (!projId) return;

    if (!S.tasks[projId]) S.tasks[projId] = { 'General': [] };
    if (!S.tasks[projId][activeFolder]) S.tasks[projId][activeFolder] = [];

    const tasksForFolder = S.tasks[projId][activeFolder];

    const tagFilter = ($('#taskTagFilter')?.value || '').toLowerCase().trim();
    const filteredTasks = tagFilter
        ? tasksForFolder.filter(t => (t.tags || []).some(tag => tag.toLowerCase().includes(tagFilter)))
        : tasksForFolder;

    if (isBoardView) renderTaskBoard(filteredTasks);
    else renderTaskList(filteredTasks);
}

/**
 * Renderiza el tablero Kanban con tareas filtradas (carpeta y tag).
 * CORREGIDO: Lógica D&D para manejar UNA sola tarea.
 * @param {Array<object>} tasks - Array de tareas filtradas.
 */
function renderTaskBoard(tasks){
  const projId=S.activeProject; if(!projId) return;
  const p = S.projects.find(x => x.id === projId);
  if (!p) return;
  const cols = p.taskColumns || [];
  const board=$('#kanban'); board.innerHTML='';

  cols.forEach((c, index) => {
    const colEl=el('div',{class:'col',dataset:{status:c}},
      el('div',{class:'row col-header'},
          el('b',{textContent:c, style: 'flex: 1; white-space: normal; overflow: hidden; text-overflow: ellipsis;', title: c}),
          el('span', {class:'chip', textContent: tasks.filter(t=>t.status===c).length}),
          el('div', { class: 'proj-actions', style: 'display: flex;' },
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { if (!incrementGuestAction()) return; e.stopPropagation(); renameColumn(index); }, title: 'Renombrar' }, el('i', { 'data-lucide': 'edit-3', width: 14 })),
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { if (!incrementGuestAction()) return; e.stopPropagation(); deleteColumn(index); }, title: 'Eliminar' }, el('i', { 'data-lucide': 'trash-2', width: 14 }))
          )
      ),
      el('div', {class: 'col-content', onclick: (e) => {
          if (!incrementGuestAction()) return; // Verifica invitado
          if (e.target.classList.contains('col-content')) {
              createTaskInColumn(c);
          }
      }},
        ...tasks.filter(t=>t.status===c).map(t=>{
          const tagsHtml = (t.tags && t.tags.length > 0)
            ? el('div', {class: 'task-tags'}, ...t.tags.map(tag => el('span', {class: 'task-tag', textContent: tag})))
            : null;

          const taskEl=el('div',{class:'task',draggable:'true', dataset: {id:t.id, folder: t.folder}, // Guardar carpeta origen en dataset
             onclick: ()=>openTaskModal(t.id),
             style:'border-left: 3px solid ' + (p.color || 'var(--brand)')},
            el('div',{ textContent:t.title }),
            tagsHtml
          );
          // CORRECCIÓN DRAG & DROP: Guardar ID y carpeta origen
          taskEl.ondragstart = e => {
              if (!incrementGuestAction()) { e.preventDefault(); return; } // Verifica invitado
              e.stopPropagation();
              e.dataTransfer.setData('text/plain', JSON.stringify({ taskId: t.id, originFolder: t.folder })); // Guarda objeto JSON
              e.dataTransfer.effectAllowed = 'move';
          };
          return taskEl;
        })
      )
    );

    colEl.ondragover=e=>{e.preventDefault(); colEl.classList.add('dragover');};
    colEl.ondragleave=()=>colEl.classList.remove('dragover');
    colEl.ondrop=e=>{
      e.preventDefault();
      if (!incrementGuestAction()) return; // Verifica invitado
      colEl.classList.remove('dragover');

      let dragData;
      try {
          dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
      } catch (err) {
          console.error("Error parsing D&D data:", err);
          return;
      }

      const { taskId, originFolder } = dragData;
      const targetStatus = colEl.dataset.status;
      const targetFolder = S.ui.activeFolder || 'General'; // La carpeta activa es el destino EN EL KANBAN

      // Busca la tarea en su carpeta ORIGINAL
      const taskList = S.tasks[projId]?.[originFolder];
      if (!taskList) { console.error(`Origin folder ${originFolder} not found`); return; }
      const taskIndex = taskList.findIndex(x => x.id === taskId);
      if (taskIndex === -1) { console.error(`Task ${taskId} not found in origin folder ${originFolder}`); return; }

      const task = taskList[taskIndex];
      const oldStatus = task.status;
      const doneColName = p.taskColumns[p.taskColumns.length - 1];

      // Si la carpeta de destino (la activa) es DIFERENTE a la original, mueve la tarea
      if (originFolder !== targetFolder) {
          // 1. Quitar de la carpeta original
          taskList.splice(taskIndex, 1);
          // 2. Actualizar carpeta y estado de la tarea
          task.folder = targetFolder;
          task.status = targetStatus;
          // 3. Añadir a la nueva carpeta (asegurándose de que exista)
          if (!S.tasks[projId][targetFolder]) S.tasks[projId][targetFolder] = [];
          S.tasks[projId][targetFolder].push(task);
          console.log(`Task ${taskId} moved from ${originFolder} to ${targetFolder}`);
      } else {
          // Si es la misma carpeta, solo actualiza el estado
          task.status = targetStatus;
          console.log(`Task ${taskId} status updated to ${targetStatus} in folder ${targetFolder}`);
      }

      // Gamificación
      if (oldStatus !== doneColName && targetStatus === doneColName) {
          addIntis(INTIS_REWARDS.completeTask, 'Tarea completada');
      }

      save();
      renderTasks(); // Re-renderiza tablero
      renderOverview();
      renderCalendar(); // Actualiza ambos calendarios
      renderCronoPOST();
      renderAside(); // Actualiza contadores
    };
    board.appendChild(colEl);
  });
  lucide.createIcons();
}

/**
 * Añade una nueva columna al tablero Kanban.
 */
function addColumn() {
    if (!incrementGuestAction()) return; // Verifica invitado
    const id = S.activeProject; if (!id) return;
    const p = S.projects.find(x => x.id === id);
    if (!p) return;
    showInputModal('Nueva Columna', 'Nombre para la nueva columna:', 'Ej: Revisión', name => {
        if (!p.taskColumns) p.taskColumns = [];
        p.taskColumns.push(name);
        save();
        renderTasks();
    });
}

/**
 * Renombra una columna del Kanban. Afecta a TODAS las carpetas.
 * @param {number} index - Índice de la columna.
 */
function renameColumn(index) {
    if (!incrementGuestAction()) return; // Verifica invitado
    const projId = S.activeProject; if (!projId) return;
    const p = S.projects.find(x => x.id === projId);
    if (!p || !p.taskColumns || !p.taskColumns[index]) return;
    const oldName = p.taskColumns[index];

    showInputModal('Renombrar Columna', `Nuevo nombre para "${oldName}":`, oldName, newName => {
        if (!newName || newName === oldName) return;

        Object.keys(S.tasks[projId] || {}).forEach(folder => {
            (S.tasks[projId][folder] || []).forEach(t => {
                if (t.status === oldName) t.status = newName;
            });
        });
        p.taskColumns[index] = newName;
        save();
        renderTasks();
    }, oldName);
}

/**
 * Elimina una columna (solo si está vacía en TODAS las carpetas).
 * @param {number} index - Índice de la columna.
 */
function deleteColumn(index) {
    if (!incrementGuestAction()) return; // Verifica invitado
    const projId = S.activeProject; if (!projId) return;
    const p = S.projects.find(x => x.id === projId);
    if (!p || !p.taskColumns || !p.taskColumns[index]) return;
    const colName = p.taskColumns[index];

    const isEmptyEverywhere = Object.values(S.tasks[projId] || {}).every(folderTasks =>
        !folderTasks.some(t => t.status === colName)
    );

    if (!isEmptyEverywhere) {
        showToast('No se puede eliminar una columna con tareas.', 'warn');
        return;
    }

    showInputModal('Confirmar Eliminación', `Eliminar columna "${colName}"? Escribe "eliminar".`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            p.taskColumns.splice(index, 1);
            save();
            renderTasks();
        }
    });
}

/**
 * Renderiza la vista de lista de tareas filtradas (carpeta y tag).
 * @param {Array<object>} tasks - Array de tareas filtradas.
 */
function renderTaskList(tasks) {
    const projId = S.activeProject; if (!projId) return;
    const tbody = $('#task-list-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    const newRow = el('tr', { class: 'mj-new-task-row', style: 'cursor: pointer;' },
        el('td', { colspan: 5, textContent: '+ Nueva tarea…', style: 'color: var(--sub); font-style: italic; padding: 10px 12px;' })
    );
    newRow.onclick = quickAddTask;
    tbody.append(newRow);

    tasks.forEach(t => {
        const tagsHtml = (t.tags && t.tags.length > 0)
            ? t.tags.map(tag => el('span', {class: 'task-tag', textContent: tag}) )
            : el('span', {textContent: '---', style:'color: var(--sub);'});

        const tr = el('tr', { onclick: () => openTaskModal(t.id) },
            el('td', { textContent: t.title }),
            el('td', {}, el('span', { class: 'status-badge', style: `background: color-mix(in hsl, ${getTaskStatusColor(t.status)} 20%, transparent); color: ${getTaskStatusColor(t.status)};`, textContent: t.status })),
            el('td', { textContent: t.due ? fmtDate(t.due, 'short') : '---' }),
            el('td', { style:'display: flex; gap: 4px; flex-wrap: wrap;'}, ...(Array.isArray(tagsHtml) ? tagsHtml : [tagsHtml])),
            el('td', {}, el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { if (!incrementGuestAction()) return; e.stopPropagation(); deleteTask(t.id); } }, el('i', { 'data-lucide': 'trash-2', width: 14 })))
        );
        tbody.append(tr);
    });
    lucide.createIcons();
}

/**
 * Devuelve un color basado en el estado de la tarea.
 * @param {string} status - Nombre del estado.
 * @returns {string} - Variable CSS de color.
 */
function getTaskStatusColor(status) {
    if (!status) return 'var(--sub)';
    const s = status.toLowerCase();
    if (s.includes('hecho') || s.includes('done') || s.includes('aprobado') || s.includes('lanzado')) return 'var(--success)';
    if (s.includes('curso') || s.includes('progress') || s.includes('progreso') || s.includes('revisión')) return 'var(--info)';
    if (s.includes('bloqueado') || s.includes('blocked')) return 'var(--danger)';
    return 'var(--sub)';
}

/**
 * Muestra un modal para añadir una tarea rápida a la carpeta activa.
 * CORREGIDO: Bug de duplicación.
 */
function quickAddTask() {
    if (!incrementGuestAction()) return; // Verifica invitado
    if (checkLimitReached('tasks')) return; // Verifica límite de tareas

    const projId=S.activeProject; if(!projId) return;
    const p = S.projects.find(x => x.id === projId);
    if (!p) return;
    const firstColumn = p.taskColumns[0] || 'Backlog';
    const activeFolder = S.ui.activeFolder || 'General';

    showInputModal('Nueva Tarea', `Añadir tarea a "${activeFolder}"`, 'Describe la tarea...', (title) => {
        if (!S.tasks[projId][activeFolder]) S.tasks[projId][activeFolder] = [];
        // CORRECCIÓN: Crear UNA sola tarea
        const newTask = {id:'t'+Date.now(), title, status:firstColumn, desc:'', due:'', folder: activeFolder, tags: []};
        S.tasks[projId][activeFolder].push(newTask);

        addIntis(INTIS_REWARDS.createTask, 'Tarea creada');
        save();
        renderTasks(); // Actualiza vista de tareas (Kanban o Lista)
        renderOverview();
        renderCalendar(); // Actualiza calendario del proyecto
        renderCronoPOST(); // Actualiza calendario general
        renderAside(); // Actualiza contadores en el aside
    });
}

/**
 * Crea una tarea directamente en una columna del tablero Kanban.
 * CORREGIDO: Bug de duplicación.
 * @param {string} columnStatus - El estado de la columna donde se hizo click.
 */
function createTaskInColumn(columnStatus) {
    if (!incrementGuestAction()) return; // Verifica invitado
    if (checkLimitReached('tasks')) return; // Verifica límite de tareas

    const projId = S.activeProject; if (!projId) return;
    const activeFolder = S.ui.activeFolder || 'General';
    showInputModal(`Nueva Tarea en "${columnStatus}"`, `Añadir a "${activeFolder}"`, 'Describe la tarea...', (title) => {
         if (!S.tasks[projId][activeFolder]) S.tasks[projId][activeFolder] = [];
         // CORRECCIÓN: Crear UNA sola tarea
         const newTask = {id:'t'+Date.now(), title, status:columnStatus, desc:'', due:'', folder: activeFolder, tags: []};
         S.tasks[projId][activeFolder].push(newTask);

         addIntis(INTIS_REWARDS.createTask, 'Tarea creada');
         save();
         renderTasks();
         renderOverview();
         renderCalendar();
         renderCronoPOST();
         renderAside();
    });
}


/**
 * Abre el modal de detalles de una tarea y carga las carpetas y tags.
 * @param {string} taskId - ID de la tarea.
 */
function openTaskModal(taskId) {
    if (!incrementGuestAction()) return; // Verifica invitado
    const projId = S.activeProject;
    if (!projId) return;
    const p = S.projects.find(x => x.id === projId);
    if (!p) return;

    let task = null;
    let taskOriginFolder = null;

    // Busca la tarea en TODAS las carpetas del proyecto
    for (let folderName in S.tasks[projId]) {
        const foundTask = S.tasks[projId][folderName].find(t => t.id === taskId);
        if (foundTask) {
            task = foundTask;
            taskOriginFolder = folderName;
            break;
        }
    }

    if (!task) {
        showToast('Error: No se encontró la tarea.', 'danger');
        return;
    }

    $('#taskDetailId').value = task.id;
    $('#taskDetailTitle').value = task.title;
    $('#taskDetailDesc').value = task.desc || '';
    $('#taskDetailDue').value = task.due ? task.due.split('T')[0] : '';

    const statusSel = $('#taskDetailStatus');
    statusSel.innerHTML = '';
    (p.taskColumns || []).forEach(s => statusSel.append(el('option', { value: s, textContent: s })));
    statusSel.value = task.status;

    const folderSel = $('#taskDetailFolder');
    folderSel.innerHTML = '';
    (S.folders[projId] || ['General']).forEach(f => folderSel.append(el('option', { value: f, textContent: f})));
    folderSel.value = task.folder || 'General';

    $('#taskDetailTags').value = (task.tags || []).join(', ');

    $('#taskDetailModal').dataset.originFolder = taskOriginFolder;
    $('#taskDetailDeleteBtn').style.display = 'inline-flex'; // Asegura que el botón de eliminar sea visible

    $('#taskDetailModal').showModal();
    lucide.createIcons();
}

/**
 * Guarda los cambios desde el modal de detalles de tarea, incluyendo carpeta y tags.
 * CORREGIDO: Lógica de movimiento entre carpetas.
 */
function saveTaskDetails() {
    if (!incrementGuestAction()) return; // Verifica invitado
    const projId = S.activeProject;
    if (!projId) return;
    const p = S.projects.find(x => x.id === projId);
    if (!p) return;

    const taskId = $('#taskDetailId').value;
    const modal = $('#taskDetailModal');
    const oldFolder = modal.dataset.originFolder; // Carpeta de donde viene
    const newFolder = $('#taskDetailFolder').value;

    // Si taskId está vacío, es una NUEVA tarea creada desde el calendario
    if (!taskId) {
        if (checkLimitReached('tasks')) { modal.close(); return; } // Verifica límite al GUARDAR nueva

        const newTask = {
            id: 't' + Date.now(),
            title: $('#taskDetailTitle').value.trim(),
            desc: $('#taskDetailDesc').value.trim(),
            due: $('#taskDetailDue').value,
            status: $('#taskDetailStatus').value,
            folder: newFolder,
            tags: ($('#taskDetailTags').value || '').split(',').map(tag => tag.trim()).filter(tag => tag !== '')
        };
        if (!newTask.title) { showToast('El título es obligatorio.', 'warn'); return; }

        if (!S.tasks[projId][newFolder]) S.tasks[projId][newFolder] = [];
        S.tasks[projId][newFolder].push(newTask);

        addIntis(INTIS_REWARDS.createTask, 'Tarea creada');
        save();
        renderTasks();
        renderOverview();
        renderCalendar();
        renderCronoPOST();
        renderAside();
        modal.close();
        delete modal.dataset.originFolder;
        return; // Termina aquí para nueva tarea
    }

    // --- Lógica para tarea EXISTENTE ---
    if (!oldFolder) { console.error("Origin folder missing for task update"); modal.close(); return; }

    let taskIndex = -1;
    let task = null;
    if (S.tasks[projId]?.[oldFolder]) {
         taskIndex = S.tasks[projId][oldFolder].findIndex(t => t.id === taskId);
         if (taskIndex !== -1) {
             task = S.tasks[projId][oldFolder][taskIndex];
         }
    }

    if (!task) {
        console.error(`Task ${taskId} not found in origin folder ${oldFolder} for saving.`);
        showToast('Error al guardar la tarea.', 'danger');
        modal.close();
        return;
    }

    const oldStatus = task.status;
    const newStatus = $('#taskDetailStatus').value;
    const doneColName = p.taskColumns[p.taskColumns.length - 1];

    // Actualiza datos de la tarea (en su objeto original)
    task.title = $('#taskDetailTitle').value.trim();
    task.desc = $('#taskDetailDesc').value.trim();
    task.due = $('#taskDetailDue').value;
    task.status = newStatus;
    task.tags = ($('#taskDetailTags').value || '').split(',').map(tag => tag.trim()).filter(tag => tag !== '');

    // Mover la tarea SI la carpeta cambió
    if (oldFolder !== newFolder) {
        task.folder = newFolder; // Actualiza la propiedad folder ANTES de mover
        // Quita de la carpeta vieja
        S.tasks[projId][oldFolder].splice(taskIndex, 1);
        // Añade a la carpeta nueva (asegura que exista)
        if (!S.tasks[projId][newFolder]) S.tasks[projId][newFolder] = [];
        S.tasks[projId][newFolder].push(task); // Añade el objeto tarea actualizado
        console.log(`Task ${taskId} moved from ${oldFolder} to ${newFolder}`);
        // Si la carpeta activa ERA la antigua, y AHORA es diferente, actualiza la UI
        if (S.ui.activeFolder === oldFolder) {
             // No necesitamos cambiar S.ui.activeFolder aquí, el usuario sigue viendo la carpeta vieja
             // pero la tarea ya no estará allí al re-renderizar.
             // Si quisiéramos seguir la tarea a la nueva carpeta:
             // S.ui.activeFolder = newFolder;
             // $('#folderSel').value = newFolder;
             // history.pushState({view: `project/${projId}/folder/${newFolder}`}, '', `#!project/${projId}/folder/${encodeURIComponent(newFolder)}`);
        }
    } else {
        // Si no cambió de carpeta, la tarea ya está actualizada en su sitio
        console.log(`Task ${taskId} details updated in folder ${oldFolder}`);
    }

    // Gamificación
    if (oldStatus !== doneColName && newStatus === doneColName) {
        addIntis(INTIS_REWARDS.completeTask, 'Tarea completada');
    }

    save();
    renderTasks();
    renderOverview();
    renderCalendar();
    renderCronoPOST();
    renderAside();
    modal.close();
    delete modal.dataset.originFolder;
}

/**
 * Elimina una tarea (de su carpeta actual).
 * @param {string} taskId - ID de la tarea.
 */
function deleteTask(taskId) {
    if (!incrementGuestAction()) return; // Verifica invitado
    const projId = S.activeProject;
    if (!projId) return;

    let taskFolder = null;
    let taskIndex = -1;
    for (const folderName in (S.tasks[projId] || {})) {
        const index = S.tasks[projId][folderName].findIndex(t => t.id === taskId);
        if (index > -1) {
            taskFolder = folderName;
            taskIndex = index;
            break;
        }
    }

    if (!taskFolder) {
        showToast('Error: No se pudo encontrar la tarea para eliminar.', 'danger');
        return;
    }

    showInputModal('Confirmar Eliminación', `Eliminar esta tarea? Escribe "eliminar".`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            S.tasks[projId][taskFolder].splice(taskIndex, 1);
            save();
            renderTasks();
            renderOverview();
            renderCalendar();
            renderCronoPOST();
            renderAside();
            $('#taskDetailModal').close();
            showToast('Tarea eliminada.', 'info');
        }
    });
}

// --- 5.3: CALENDARIO (PROYECTO) ---
let calRef=new Date();

/**
 * Renderiza el calendario del proyecto, mostrando tareas de la CARPETA ACTIVA.
 * CORREGIDO: Lógica D&D para manejar UNA tarea.
 */
function renderCalendar(){
  const projId=S.activeProject; if(!projId) return;
  const activeFolder = S.ui.activeFolder || 'General';
  $('#monthLbl').textContent = calRef.toLocaleString('es', {month:'long', year:'numeric'});
  const grid=$('#calGrid'); grid.innerHTML='';

  const monthGrid = (ref=new Date()) => {
      const y=ref.getFullYear(), m=ref.getMonth();
      const first=new Date(y,m,1);
      const start = new Date(first); start.setDate(1-((first.getDay()+6)%7)); // Lunes
      const days=[]; let cur=new Date(start);
      while(days.length < 42){ days.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
      return days;
  }

  const projColor = S.projects.find(p=>p.id===projId)?.color || 'var(--brand)';
  const tasksForFolder = S.tasks[projId]?.[activeFolder] || [];

  monthGrid(calRef).forEach(d=>{
    const localYear = d.getFullYear();
    const localMonth = String(d.getMonth() + 1).padStart(2, '0');
    const localDay = String(d.getDate()).padStart(2, '0');
    const localDateString = `${localYear}-${localMonth}-${localDay}`;
    const dateKeyForComparison = d.toDateString();

    const day=el('div',{class:'day', dataset: {localDate: localDateString}});
    if(d.getMonth() !== calRef.getMonth()) day.style.opacity = .4;
    day.append(el('div',{class:'sub', textContent:d.getDate()}));
    day.onclick = () => openTaskModalFromDate(d);

    day.ondragover = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; day.classList.add('dragover'); };
    day.ondragleave = () => { day.classList.remove('dragover'); };
    day.ondrop = (e) => {
        e.preventDefault();
        if (!incrementGuestAction()) return; // Verifica invitado
        day.classList.remove('dragover');

        let dragData;
        try {
            dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
        } catch (err) { console.error("Error parsing D&D data:", err); return; }

        // Asegurarse de que sea una tarea (podría ser un post de Cronopost)
        if (!dragData || typeof dragData !== 'object' || !dragData.taskId || !dragData.originFolder) {
            console.warn("Invalid data dropped on project calendar:", dragData);
            return; // Ignorar si no es una tarea válida
        }

        const { taskId, originFolder } = dragData;
        const targetLocalDate = day.dataset.localDate;

        // Busca la tarea en su carpeta ORIGINAL
        const taskList = S.tasks[projId]?.[originFolder];
        if (!taskList) { console.error(`Origin folder ${originFolder} not found`); return; }
        const task = taskList.find(t => t.id === taskId);

        if (task) {
            task.due = targetLocalDate; // Actualiza la fecha de vencimiento
            console.log(`Task ${taskId} due date updated to ${targetLocalDate} in folder ${originFolder}`);
            save();
            renderCalendar();
            renderCronoPOST();
            renderTasks(); // Actualiza también la vista de tareas
        } else {
             console.error(`Task ${taskId} not found in origin folder ${originFolder} during drop`);
        }
    };

    tasksForFolder.filter(t => t.due && (t.due === localDateString || new Date(t.due).toDateString() === dateKeyForComparison)).forEach(t => {
        const taskEl = el('div', {
            class: 'cal-task',
            textContent: t.title,
            style: `border-left-color: ${projColor}`,
            draggable: 'true',
            title: t.title
        });
        taskEl.onclick = (e) => {
            e.stopPropagation();
            openTaskModal(t.id);
        };
        // CORRECCIÓN DRAG & DROP: Guardar ID y carpeta origen
        taskEl.ondragstart = (e) => {
            if (!incrementGuestAction()) { e.preventDefault(); return; } // Verifica invitado
            e.stopPropagation();
            e.dataTransfer.setData('text/plain', JSON.stringify({ taskId: t.id, originFolder: t.folder })); // Guarda objeto JSON
            e.dataTransfer.effectAllowed = 'move';
        };
        day.append(taskEl);
    });
    grid.append(day);
  });
}

/**
 * Abre el modal de detalles de tarea pre-rellenado con la fecha.
 * Usado para CREAR una nueva tarea desde el calendario.
 * @param {Date} date - Fecha seleccionada.
 */
function openTaskModalFromDate(date) {
    if (!incrementGuestAction()) return; // Verifica invitado
    if (checkLimitReached('tasks')) return; // Verifica límite ANTES de abrir modal para crear

    const projId = S.activeProject; if (!projId) return;
    const p = S.projects.find(x => x.id === projId);
    if (!p) return;
    const activeFolder = S.ui.activeFolder || 'General';

    $('#taskDetailId').value = ''; // ID vacío = nueva tarea
    $('#taskDetailTitle').value = '';
    $('#taskDetailDesc').value = '';

    const localYear = date.getFullYear();
    const localMonth = String(date.getMonth() + 1).padStart(2, '0');
    const localDay = String(date.getDate()).padStart(2, '0');
    $('#taskDetailDue').value = `${localYear}-${localMonth}-${localDay}`;

    $('#taskDetailTags').value = '';

    const statusSel = $('#taskDetailStatus');
    statusSel.innerHTML = '';
    (p.taskColumns || []).forEach(s => statusSel.append(el('option', { value: s, textContent: s })));
    if (p.taskColumns?.length > 0) statusSel.value = p.taskColumns[0];

    const folderSel = $('#taskDetailFolder');
    folderSel.innerHTML = '';
    (S.folders[projId] || ['General']).forEach(f => folderSel.append(el('option', { value: f, textContent: f})));
    folderSel.value = activeFolder; // Carpeta activa por defecto

    delete $('#taskDetailModal').dataset.originFolder;
    $('#taskDetailDeleteBtn').style.display = 'none'; // Oculta botón eliminar para nueva tarea

    $('#taskDetailModal').showModal();
    lucide.createIcons();
}

// --- 5.4: NOTAS Y LIENZO ---
let currentDrawingNoteId = null;
function renderNotes(){
    const id=S.activeProject; if(!id) return;
    if (!S.notes[id]) S.notes[id] = { list: [], active: null, bodies: {}, drawings: {} };
    const N=S.notes[id];
    const list=$('#noteList'); list.innerHTML='';

    N.list.forEach(n=>{
        const item = el('div',{class:'projItem', onclick:()=>{ if (!incrementGuestAction()) return; N.active=n.id; save(); renderNotes();}},
            el('span', {textContent: n.title}),
            el('span', {class: 'spacer'}),
            el('button', {class: 'btn btn-ghost btn-sm', onclick: e => { if (!incrementGuestAction()) return; e.stopPropagation(); deleteNote(n.id)}}, el('i', {'data-lucide': 'trash-2', width: 14}))
        );
        if(n.id===N.active) item.classList.add('active');
        list.append(item);
    });

    if(!N.active && N.list.length > 0) {
        N.active=N.list[0].id;
        // No guardar aquí, solo es selección inicial
    }

    const editor = $('#noteEditor');
    // Desvincular listener antiguo antes de asignar nuevo contenido
    const newEditor = editor.cloneNode(false); // Clonar sin hijos
    editor.parentNode.replaceChild(newEditor, editor);
    newEditor.id = 'noteEditor'; // Restaurar ID
    newEditor.contentEditable = 'true';
    newEditor.innerHTML = (N.active? (N.bodies[N.active]||'') : 'Selecciona o crea una nota.');

    // Volver a vincular listener
    newEditor.addEventListener('input', () => {
        const currentProjectId = S.activeProject;
        const currentNoteId = S.notes[currentProjectId]?.active;
        if (currentProjectId && currentNoteId) {
             // Solo guarda si la nota activa no ha cambiado mientras se escribía
             if (currentNoteId === N.active) {
                S.notes[currentProjectId].bodies[currentNoteId] = newEditor.innerHTML;
                save(); // Guardar en cada input
             }
        }
    });

    if (N.active && N.active !== currentDrawingNoteId) {
        initDrawingCanvas(N.active);
        currentDrawingNoteId = N.active;
    } else if (!N.active) {
        const canvas = $('#drawingCanvas'); if (!canvas) return; const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        currentDrawingNoteId = null;
    }
    lucide.createIcons();
}
function createNewNote() {
    if (!incrementGuestAction()) return; // Verifica invitado
    // Aquí podríamos añadir un límite de notas si quisiéramos
    const id=S.activeProject; if(!id) return;
    showInputModal('Nueva Nota', 'Título:', 'Ej: Ideas reunión', (t) => {
        const nid='n'+Date.now();
        if (!S.notes[id]) S.notes[id] = { list: [], active: null, bodies: {}, drawings: {} };
        S.notes[id].list.push({id:nid,title:t});
        S.notes[id].active=nid;
        S.notes[id].bodies[nid]='';
        S.notes[id].drawings[nid]='';
        addIntis(INTIS_REWARDS.createNote, 'Nota creada');
        save();
        renderNotes();
    });
}
function deleteNote(noteId) {
     if (!incrementGuestAction()) return; // Verifica invitado
     showInputModal('Confirmar Eliminación', `Eliminar esta nota? Escribe "eliminar".`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            const id = S.activeProject;
            if (!S.notes[id]) return;
            S.notes[id].list = S.notes[id].list.filter(n => n.id !== noteId);
            delete S.notes[id].bodies[noteId];
            delete S.notes[id].drawings[noteId];
            if (S.notes[id].active === noteId) {
                S.notes[id].active = S.notes[id].list.length > 0 ? S.notes[id].list[0].id : null;
            }
            save();
            renderNotes();
        }
    });
}
function initDrawingCanvas(noteId) {
    const canvas = $('#drawingCanvas'); if (!canvas) return;
    const ctx = canvas.getContext('2d');

    // Ajustar tamaño del canvas a su contenedor (una sola vez o en resize)
    if (canvas.width !== canvas.clientWidth || canvas.height !== canvas.clientHeight) {
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
    }

    let drawing = false;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const currentProjectId = S.activeProject;
    if (S.notes[currentProjectId]?.drawings?.[noteId]) {
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        img.onerror = () => console.error("Error loading drawing image for note:", noteId);
        img.src = S.notes[currentProjectId].drawings[noteId];
    }

    const getCoords = (e) => {
        const rect = canvas.getBoundingClientRect();
        const event = e.touches ? e.touches[0] : e;
        // Ajustar coordenadas según el tamaño real vs mostrado del canvas
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = (event.clientX - rect.left) * scaleX;
        const y = (event.clientY - rect.top) * scaleY;
        return {x, y};
    };

    let lastX, lastY;
    const start = (e) => {
        if (!incrementGuestAction()) { e.preventDefault(); return; } // Verifica invitado
        e.preventDefault();
        drawing = true;
        const {x, y} = getCoords(e);
        lastX = x; lastY = y;
        ctx.beginPath();
        ctx.moveTo(x, y);
    };
    const end = (e) => {
        if (!drawing) return;
        drawing = false;
        ctx.beginPath(); // Finaliza trazo actual

        // Guardar estado del canvas solo al terminar de dibujar
        try {
           const activeNoteIdNow = S.notes[currentProjectId]?.active;
           if (activeNoteIdNow === noteId) { // Solo guarda si la nota no cambió
             S.notes[currentProjectId].drawings[noteId] = canvas.toDataURL();
             save();
           } else {
             console.warn("Note changed while drawing, drawing not saved.");
           }
        } catch (err) {
            console.error("Error saving canvas data:", err);
            showToast("Error al guardar el dibujo.", "danger");
        }
    };
    const draw = (e) => {
        if (!drawing) return;
        e.preventDefault();
        const {x, y} = getCoords(e);
        ctx.lineWidth = $('#canvasStrokeSlider').value; ctx.lineCap = 'round';
        ctx.strokeStyle = $('#canvasColorPicker').value;
        ctx.lineTo(x, y); ctx.stroke();
        // Optimización: No reiniciar el path aquí, seguir el trazo
        // ctx.beginPath();
        // ctx.moveTo(x, y);
        lastX = x; lastY = y;
    };

    // --- Limpiar y reasignar listeners ---
    const newCanvas = canvas.cloneNode(true); // Clonar
    canvas.parentNode.replaceChild(newCanvas, canvas); // Reemplazar
    const newCtx = newCanvas.getContext('2d');

    // Redibujar la imagen guardada en el nuevo canvas
    if (S.notes[currentProjectId]?.drawings?.[noteId]) {
        const img = new Image();
        img.onload = () => newCtx.drawImage(img, 0, 0, newCanvas.width, newCanvas.height);
        img.src = S.notes[currentProjectId].drawings[noteId];
    }

    // Asignar listeners al NUEVO canvas
    newCanvas.addEventListener('mousedown', start);
    newCanvas.addEventListener('mouseup', end);
    newCanvas.addEventListener('mousemove', draw);
    newCanvas.addEventListener('mouseleave', end);

    newCanvas.addEventListener('touchstart', start, { passive: false });
    newCanvas.addEventListener('touchend', end, { passive: false });
    newCanvas.addEventListener('touchmove', draw, { passive: false });
    newCanvas.addEventListener('touchcancel', end, { passive: false });
}
function exportNote(format) {
    if (!incrementGuestAction()) return; // Verifica invitado
    const id = S.activeProject; const noteId = S.notes[id]?.active;
    if (!noteId) return showToast("Selecciona una nota para exportar.", "warn");
    const title = S.notes[id].list.find(n => n.id === noteId)?.title || "Nota";
    const contentHTML = S.notes[id].bodies[noteId] || "";
    if (format === 'pdf') {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont('Inter', 'normal'); // Usar fuente Inter si es posible

            // Añadir título con margen
            doc.setFontSize(16);
            doc.text(title, 15, 20);

            // Convertir HTML a texto plano para el PDF (jsPDF tiene soporte limitado de HTML)
            const tempDiv = el('div', {html: contentHTML});
            // Procesar elementos básicos (p, br, li, h) para formateo simple
            let pdfText = '';
            tempDiv.childNodes.forEach(node => {
                if (node.nodeName === '#text') {
                    pdfText += node.textContent;
                } else if (node.nodeName === 'P' || node.nodeName === 'DIV') {
                    pdfText += node.textContent + '\n\n';
                } else if (node.nodeName === 'BR') {
                    pdfText += '\n';
                } else if (node.nodeName === 'LI') {
                    pdfText += '- ' + node.textContent + '\n';
                } else if (node.nodeName.startsWith('H')) {
                    pdfText += '\n' + node.textContent.toUpperCase() + '\n\n';
                } else {
                     pdfText += node.textContent; // Otros elementos como texto plano
                }
            });

            doc.setFontSize(11);
            doc.text(pdfText, 15, 30, { maxWidth: 180 }); // Ajustar posición y ancho

            doc.save(`${title}.pdf`);
        } catch (pdfErr) {
            console.error("jsPDF error:", pdfErr);
            showToast("Error al generar el PDF. Exportando como TXT.", "danger");
            const textContent = el('div', {html: contentHTML}).textContent || "";
            download(`${title}.txt`, textContent);
        }
    }
}

// --- 5.5: TABLAS ---
function renderTables(){
  const id=S.activeProject; if(!id) return;
  if (!S.tables[id]) S.tables[id] = { list: [{id: 'tbl_default', name: 'Tabla 1'}], active: 'tbl_default', data: {'tbl_default': {cols:['Col 1'], rows:[]}} };
  const T_PROJ = S.tables[id];

  const selector = $('#tableSelector');
  selector.innerHTML = '';
  T_PROJ.list.forEach(t => selector.append(el('option',{value:t.id, textContent:t.name})));
  if (!T_PROJ.list.find(t => t.id === T_PROJ.active) && T_PROJ.list.length > 0) {
      T_PROJ.active = T_PROJ.list[0].id;
      // No guardar aquí, es solo selección inicial
  }
  selector.value = T_PROJ.active;

  const wrap=$('#sheetWrap'); wrap.innerHTML='';
  const T_DATA = T_PROJ.data[T_PROJ.active];

  if (!T_DATA || !T_DATA.cols || T_DATA.cols.length === 0) {
      wrap.innerHTML = `<div class="empty-state"><i data-lucide="table-2" width="48" height="48"></i><h4>Tabla vacía.</h4><p>Añade columnas y filas.</p></div>`;
      lucide.createIcons(); return;
  }

  const tbl=el('table',{style:'width:100%; border-collapse: collapse; min-width: 600px;'});
  const thead=el('thead',{}, el('tr',{},
      ...T_DATA.cols.map((c,ci)=>el('th',{style:'border: 1px solid var(--line); padding: 8px; position:relative;'},
          // Input para editar nombre de columna
          el('input', {
              value: c,
              style: 'border:none; background:transparent; padding: 4px; width: calc(100% - 30px); font-weight: inherit;',
              onchange: (e) => {
                  if (!incrementGuestAction()) { e.target.value = c; return; } // Verifica invitado
                  T_DATA.cols[ci] = e.target.value;
                  save();
              },
              onclick: (e) => e.stopPropagation() // Evitar que el click en input active otros listeners
          }),
          el('button', {
              class: 'btn btn-ghost btn-sm',
              style:'position:absolute; top:2px; right:2px; padding: 2px;',
              title: 'Eliminar Columna',
              onclick: () => deleteTableColumn(ci)
            },
            el('i', {'data-lucide': 'x', width: 14})
          )
      ))
  ));
  const tbody=el('tbody',{});
  (T_DATA.rows || []).forEach((r,ri)=>{
    const tr=el('tr',{},
        ...T_DATA.cols.map((c,ci)=>el('td',{style:'border: 1px solid var(--line); padding: 0;'},
            el('input',{value:r[ci]||'', style:'border:none; background:transparent; padding: 8px; width: 100%; height: 100%;',
                onchange:(e)=>{
                    if (!incrementGuestAction()) { e.target.value = r[ci]||''; return; } // Verifica invitado
                    if (!r) r = []; // Asegura que la fila exista
                    r[ci]=e.target.value;
                    save();
                }
            })
        )),
        el('td', {style:'border: 1px solid var(--line); padding: 0; width: 40px; text-align: center;'},
            el('button', {
                class: 'btn btn-ghost btn-sm',
                style: 'padding: 4px;',
                title: 'Eliminar Fila',
                onclick: () => deleteTableRow(ri)
              },
              el('i', {'data-lucide':'trash-2', width:14})
            )
        )
    );
    tbody.appendChild(tr);
  });
  tbl.append(thead,tbody);
  wrap.append(tbl);
  lucide.createIcons();
}
function createNewTable() {
    if (!incrementGuestAction()) return; // Verifica invitado
    // Podríamos añadir límite de tablas aquí
    const id = S.activeProject; if (!id) return;
    showInputModal('Nueva Tabla', `Nombre de la tabla:`, `Tabla ${S.tables[id].list.length + 1}`, (name) => {
        const tableId = 'tbl_' + Date.now();
        S.tables[id].list.push({ id: tableId, name: name });
        S.tables[id].data[tableId] = { cols: ['Nueva Columna'], rows: [['']] };
        S.tables[id].active = tableId;
        addIntis(INTIS_REWARDS.createTable, 'Tabla creada');
        save(); renderTables();
    });
}
function deleteTableColumn(colIndex) {
    if (!incrementGuestAction()) return; // Verifica invitado
    const projId = S.activeProject; if (!projId) return;
    const activeTableId = S.tables[projId]?.active;
    if (!activeTableId) return;
    const tableData = S.tables[projId].data[activeTableId];
    if (!tableData || !tableData.cols || colIndex < 0 || colIndex >= tableData.cols.length) return;

    showInputModal('Confirmar Eliminación', `Eliminar columna "${tableData.cols[colIndex]}"? Escribe "eliminar".`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            tableData.cols.splice(colIndex, 1);
            (tableData.rows || []).forEach(row => row.splice(colIndex, 1));
            save();
            renderTables();
        }
    });
}
function deleteTableRow(rowIndex) {
    if (!incrementGuestAction()) return; // Verifica invitado
    const projId = S.activeProject; if (!projId) return;
    const activeTableId = S.tables[projId]?.active;
    if (!activeTableId) return;
    const tableData = S.tables[projId].data[activeTableId];
    if (!tableData || !tableData.rows || rowIndex < 0 || rowIndex >= tableData.rows.length) return;

    tableData.rows.splice(rowIndex, 1);
    save();
    renderTables();
}


// --- 5.6: ARCHIVOS ---
function renderFiles(){
  const id=S.activeProject; if(!id) return;
  if (!S.files[id]) S.files[id] = [];
  const L=S.files[id]; const wrap=$('#fileList'); wrap.innerHTML='';
  if (L.length === 0) {
      wrap.innerHTML = `<div class="empty-state" style="width:100%"><i data-lucide="file-up" width="48" height="48"></i><h4>No hay archivos.</h4><p>Sube documentos, imágenes, etc.</p></div>`;
      lucide.createIcons(); return;
  }
  L.forEach((f,idx)=>{
      // Mostrar miniatura si es imagen
      let preview = el('i', {'data-lucide': 'file', width: 16});
      if (f.type && f.type.startsWith('image/')) {
          preview = el('img', { src: f.url, alt: f.name, style: 'width: 20px; height: 20px; object-fit: cover; border-radius: 4px; margin-right: 4px;' });
      }

      const fileChip = el('div', {class:'chip', style:'background: var(--surface); border: 1px solid var(--line);'},
        preview,
        el('a',{href:f.url,download:f.name, textContent:f.name, target:'_blank', title:`Tamaño: ${f.size ? (f.size / 1024).toFixed(1) + ' KB' : 'N/A'}`}),
        el('button', {class: 'btn btn-ghost btn-sm', style:'padding:2px; margin-left: auto;', onclick:()=>{ if (!incrementGuestAction()) return; L.splice(idx,1); URL.revokeObjectURL(f.url); save(); renderFiles(); renderOverview(); }}, el('i', {'data-lucide':'trash-2', width:14}))
      );
      wrap.append(fileChip);
  });
  lucide.createIcons();
}

// --- 5.7: FINANZAS (PROYECTO - Legacy $) ---
function renderFin(){
  const id=S.activeProject; if(!id) return;
  if (!S.fin[id]) S.fin[id] = { rows: [] };
  const F=S.fin[id];
  const tbody=$('#finTable tbody'); tbody.innerHTML='';
  (F.rows || []).forEach((r,i)=>{
    const tr=el('tr',{},
        el('td',{textContent:fmtDate(r.fecha, 'short'), style:'padding:8px'}),
        el('td',{textContent:r.tipo, style:'padding:8px; color:' + (r.tipo === 'Ingreso' ? 'var(--success)' : 'var(--danger)')}),
        el('td',{textContent:'$'+Number(r.monto).toFixed(2), style:'text-align:right; padding:8px'}),
        el('td',{textContent:r.cat, style:'padding:8px'}),
        el('td',{textContent:r.nota, style:'padding:8px'}),
        el('td',{}, el('button',{class:'btn btn-ghost btn-sm',onclick:()=>{ if (!incrementGuestAction()) return; F.rows.splice(i,1); save(); renderFin(); renderOverview();}}, el('i',{'data-lucide':'trash-2', width:14})))
    );
    tbody.appendChild(tr);
  });

  const sumIn=F.rows.reduce((a,b)=>a+(b.tipo==='Ingreso' ? Number(b.monto) : 0),0);
  const sumOut=F.rows.reduce((a,b)=>a+(b.tipo==='Egreso' ? Number(b.monto) : 0),0);
  $('#finIn').textContent='$'+sumIn.toFixed(2);
  $('#finOut').textContent='$'+sumOut.toFixed(2);
  $('#finBal').textContent='$'+(sumIn-sumOut).toFixed(2);
  lucide.createIcons();
}
function addProjectFinanceMove() {
    if (!incrementGuestAction()) return; // Verifica invitado
    const id = S.activeProject; if (!id) return;
    if (!S.fin[id]) S.fin[id] = { rows: [] };
    const F = S.fin[id];
    const monto = parseFloat($('#pF_Monto').value);
    const tipo = $('#pF_Tipo').value;
    const cat = $('#pF_Cat').value.trim() || 'General';
    const nota = $('#pF_Nota').value.trim();

    if (isNaN(monto) || monto <= 0) {
        showToast('Ingresa un monto válido.', 'warn');
        return;
    }

    F.rows.push({ fecha: new Date().toISOString(), tipo, monto, cat, nota });
    addIntis(INTIS_REWARDS.addFinanceLegacy, 'Movimiento financiero ($)');
    save();
    renderFin();
    renderOverview();

    $('#pF_Monto').value = '';
    $('#pF_Cat').value = '';
    $('#pF_Nota').value = '';
    $('#projectFinModal').close();
}

// --- 5.8: CHAT IA (PROYECTO) ---
function renderProjectChat() {
    const pid = S.activeProject; if (!pid) return;
    if (!S.chats[pid]) S.chats[pid] = { threads: [], messages: {}, activeThread: null, model: 'pro' };
    const C = S.chats[pid];

    $('#p-chat-grid')?.classList.toggle('chat-list-collapsed', S.ui.pChatCollapsed);

    const list = $('#chatList'); list.innerHTML = '';
    (C.threads || []).forEach(th => {
        // CORRECCIÓN BOTÓN DESPLEGAR CHAT: Usar solo un botón
        const actions = el('div', { class: 'proj-actions' },
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { if (!incrementGuestAction()) return; e.stopPropagation(); renameProjectChat(th.id); }, title: 'Renombrar' }, el('i', { 'data-lucide': 'edit-3', width: 14 })),
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { if (!incrementGuestAction()) return; e.stopPropagation(); deleteProjectChat(th.id); }, title: 'Eliminar' }, el('i', { 'data-lucide': 'trash-2', width: 14 }))
        );
        const it = el('div', { class: 'projItem', dataset: { id: th.id }, onclick: () => { if (!incrementGuestAction()) return; C.activeThread = th.id; save(); renderProjectChat(); } },
           el('span', {textContent: th.title, style:'flex: 1; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;'}),
           actions // Añadir acciones aquí
        );
        if (th.id === C.activeThread) it.classList.add('active');
        list.append(it);
    });

    if (!C.activeThread && C.threads?.length > 0) { C.activeThread = C.threads[0].id; /* No guardar, solo selección inicial */ }

    // Sincroniza selector de modelo y estado PRO
    $$('#p-chat-grid .gchat-main-header .model-card').forEach(c => {
        c.classList.toggle('active', C.model === c.dataset.model);
        if (c.dataset.model === 'x') {
            c.classList.toggle('disabled', !S.userProfile.isPro);
            c.title = S.userProfile.isPro ? "Goatify X - Avanzado y veloz" : "Goatify X - Exclusivo para PRO";
        }
    });

    const log = $('#chatLog'); log.innerHTML = '';
    if (C.activeThread) {
        (C.messages[C.activeThread] || []).forEach(m => log.append(createMessageElement(m, S.hub.perfil)));
        requestAnimationFrame(() => { log.scrollTop = log.scrollHeight; });
    } else {
        log.innerHTML = `<div class="empty-state" style="padding: 20px;"><i data-lucide="message-square" width="36" height="36"></i><p>Selecciona o crea una conversación.</p></div>`;
        lucide.createIcons();
    }
    updateUILimits(); // Asegura que los modelos PRO estén bien marcados
}
async function sendProjectChatMessage() {
    if (!incrementGuestAction()) return; // Verifica invitado
    const pid = S.activeProject; if (!pid) return;
    if (!S.chats[pid]) S.chats[pid] = { threads: [], messages: {}, activeThread: null, model: 'pro' };

    // Si no hay hilo activo, intenta crear uno o seleccionar el primero
    if (!S.chats[pid]?.activeThread) {
        if ((S.chats[pid].threads || []).length > 0) {
            S.chats[pid].activeThread = S.chats[pid].threads[0].id;
        } else {
            // Crea un nuevo hilo si no hay ninguno
            const newId = 'c'+Date.now();
            S.chats[pid].threads = [{id: newId, title: 'Chat Inicial'}];
            S.chats[pid].activeThread = newId;
            S.chats[pid].messages = {[newId]: []};
        }
        save(); // Guarda el nuevo hilo o la selección
        // No renderiza aquí, deja que la lógica continúe
    }

    const msgInput = $('#chatMsg');
    const msg = msgInput.value.trim(); if (!msg) return;
    const C = S.chats[pid];
    const model = C.model;
    const threadId = C.activeThread;

    // Verificar si el modelo X requiere PRO
    if (model === 'x' && !S.userProfile.isPro) {
        showLimitModal('goatifyX');
        return;
    }

    C.messages[threadId].push({ who: 'Tú', at: new Date().toISOString(), text: msg });
    msgInput.value = ''; msgInput.style.height = 'auto';
    renderProjectChat(); // Muestra mensaje del usuario inmediatamente

    try {
        const responseText = await callGeminiAPI(msg, model); // Llama a la simulación/API real
        C.messages[threadId].push({ who: 'IA', at: new Date().toISOString(), text: responseText, type: model });
        save();
        renderProjectChat(); // Muestra respuesta de IA
    } catch (error) {
        console.error("Error calling AI API:", error);
        showToast(`Error al obtener respuesta de IA: ${error}`, "danger");
        // Opcional: Remover mensaje del usuario si falla la llamada
        // C.messages[threadId].pop();
        // renderProjectChat();
    }
}
function renameProjectChat(threadId) {
    if (!incrementGuestAction()) return; // Verifica invitado
    const pid = S.activeProject; if (!pid || !S.chats[pid]) return;
    const thread = S.chats[pid].threads.find(t => t.id === threadId);
    if (!thread) return;
    showInputModal('Renombrar Conversación', 'Nuevo título:', thread.title, (newTitle) => {
        if (!newTitle || newTitle === thread.title) return;
        thread.title = newTitle;
        save();
        renderProjectChat();
    }, thread.title);
}
function deleteProjectChat(threadId) {
    if (!incrementGuestAction()) return; // Verifica invitado
     showInputModal('Confirmar Eliminación', `Eliminar esta conversación? Escribe "eliminar".`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            const pid = S.activeProject; if (!pid || !S.chats[pid]) return;
            S.chats[pid].threads = S.chats[pid].threads.filter(t => t.id !== threadId);
            delete S.chats[pid].messages[threadId];
            if (S.chats[pid].activeThread === threadId) {
                S.chats[pid].activeThread = S.chats[pid].threads.length > 0 ? S.chats[pid].threads[0].id : null;
            }
            save();
            renderProjectChat();
        }
    });
}


/* ============================================================================
SECCIÓN 6: MÓDULOS GLOBALES
============================================================================
*/

// --- 6.1: ASISTENTE IA GLOBAL ---
const aiPrompts = [
    { title: 'Dame ideas de posts', prompt: 'Dame 5 ideas de posts para redes sociales sobre productividad para emprendedores' },
    { title: 'Crea una imagen', prompt: 'Crea una imagen de un astronauta meditando en marte, estilo acuarela' },
    { title: 'Resume un texto', prompt: 'Resume el siguiente texto en 3 puntos clave: [pega tu texto aquí]' },
    { title: 'Escribe un email', prompt: 'Escribe un email corto para un cliente potencial presentando mis servicios de desarrollo web' },
    { title: 'Genera código simple', prompt: 'Genera código HTML para un botón azul'}, // Prompt para código
];
function renderGlobalAIChat() {
    if (!S.aiGlobalChat) S.aiGlobalChat = JSON.parse(JSON.stringify(initialState.aiGlobalChat));
    const C = S.aiGlobalChat;

    $('#ai-chat-grid')?.classList.toggle('chat-list-collapsed', S.ui.aiChatCollapsed);

    const list = $('#aiChatList'); list.innerHTML = '';
    C.threads.forEach(th => {
        const actions = el('div', { class: 'proj-actions' },
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { if (!incrementGuestAction()) return; e.stopPropagation(); renameAIChat(th.id); }, title: 'Renombrar' }, el('i', { 'data-lucide': 'edit-3', width: 14 })),
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { if (!incrementGuestAction()) return; e.stopPropagation(); showSendToProjectModal(th.id); }, title: 'Enviar a proyecto' }, el('i', { 'data-lucide': 'send', width: 14 })),
            el('button', { class: 'btn btn-ghost btn-sm', onclick: (e) => { if (!incrementGuestAction()) return; e.stopPropagation(); deleteAIChat(th.id); }, title: 'Eliminar' }, el('i', { 'data-lucide': 'trash-2', width: 14 }))
        );
        const it = el('div', { class: 'projItem', dataset: { id: th.id }, onclick: () => { if (!incrementGuestAction()) return; C.activeThread = th.id; save(); renderGlobalAIChat(); } },
            el('span', { textContent: th.title, style: 'flex: 1; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;' }),
            actions
        );
        if (th.id === C.activeThread) it.classList.add('active');
        list.append(it);
    });

    if (!C.activeThread && C.threads.length > 0) {
        C.activeThread = C.threads[0].id;
        // No guardar, selección inicial
    } else if (C.threads.length === 0) {
        const newId = 'c_global_1';
        C.threads = [{id: newId, title: 'Chat General'}];
        C.activeThread = newId;
        C.messages = {[newId]: []};
        save();
        // Llamada recursiva segura porque ahora SIEMPRE habrá un hilo
        return renderGlobalAIChat();
    }

    // Sincroniza selector de modelo y estado PRO
    $$('#ai-chat-grid .gchat-main-header .model-card').forEach(c => {
         c.classList.toggle('active', C.model === c.dataset.model);
         if (c.dataset.model === 'x') {
             c.classList.toggle('disabled', !S.userProfile.isPro);
             c.title = S.userProfile.isPro ? "Goatify X - Avanzado y veloz" : "Goatify X - Exclusivo para PRO";
         }
    });

    const log = $('#aiChatLog'); log.innerHTML = '';
    const emptyHeader = $('#aiChatEmptyHeader');
    const codePreview = $('#aiCodePreviewWrapper'); codePreview.style.display = 'none'; // Ocultar preview por defecto

    if (C.activeThread) {
        const messages = C.messages[C.activeThread] || [];
        if (messages.length === 0) {
            emptyHeader.style.display = 'block';
            // Renderizar sugerencias
            const suggestions = el('div', {style: 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 16px;'});
            aiPrompts.forEach(p => {
                const card = el('div', {class:'card', style: 'padding: 12px; cursor: pointer; background: var(--surface);'},
                  el('b', {textContent: p.title, style: 'font-size: var(--sm);'}),
                  el('p', {textContent: p.prompt, style: 'font-size: var(--xs); color: var(--sub); margin: 4px 0 0; opacity: .7;'})
                );
                card.onclick = () => { if (!incrementGuestAction()) return; $('#aiChatMsg').value = p.prompt; $('#aiChatMsg').focus(); };
                suggestions.append(card);
            });
            log.append(suggestions);
        } else {
            emptyHeader.style.display = 'none';
            messages.forEach(m => log.append(createMessageElement(m, S.hub.perfil))); // Pasar perfil para avatar
        }
         requestAnimationFrame(() => { log.scrollTop = log.scrollHeight; });
    } else {
        emptyHeader.style.display = 'block';
    }
    updateUILimits(); // Actualiza contador y botones PRO
    lucide.createIcons();
}
function renameAIChat(threadId) {
    if (!incrementGuestAction()) return; // Verifica invitado
    const C = S.aiGlobalChat;
    const thread = C.threads.find(t => t.id === threadId);
    if (!thread) return;
    showInputModal('Renombrar Conversación', 'Nuevo título:', thread.title, (newTitle) => {
        if (!newTitle || newTitle === thread.title) return;
        thread.title = newTitle;
        save();
        renderGlobalAIChat();
    }, thread.title);
}
function deleteAIChat(threadId) {
    if (!incrementGuestAction()) return; // Verifica invitado
     showInputModal('Confirmar Eliminación', `Eliminar esta conversación? Escribe "eliminar".`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            const C = S.aiGlobalChat;
            C.threads = C.threads.filter(t => t.id !== threadId);
            delete C.messages[threadId];
            if (C.activeThread === threadId) {
                C.activeThread = C.threads.length > 0 ? C.threads[0].id : null;
            }
            save();
            renderGlobalAIChat();
        }
    });
}
function showSendToProjectModal(threadId) {
    if (!incrementGuestAction()) return; // Verifica invitado
    const modal = $('#sendChatModal');
    const select = $('#sendChatProjectSelect');
    select.innerHTML = '';
    if (S.projects.length === 0) {
        select.append(el('option', {textContent: 'No hay proyectos'}));
        $('#sendChatConfirmBtn').disabled = true;
    } else {
        S.projects.forEach(p => select.append(el('option', {value: p.id, textContent: p.name})));
        $('#sendChatConfirmBtn').disabled = false;
    }

    const confirmBtn = $('#sendChatConfirmBtn');
    const newConfirmBtn = confirmBtn.cloneNode(true); // Clonar para quitar listeners
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    newConfirmBtn.onclick = () => {
        const projId = select.value;
        if (projId && S.projects.find(p => p.id === projId)) { // Validar que el proyecto aún existe
            const C = S.aiGlobalChat;
            const thread = C.threads.find(t => t.id === threadId);
            const messages = C.messages[threadId];
            if (!thread || !messages) { modal.close(); return; }
            if (!S.chats[projId]) S.chats[projId] = { threads: [], messages: {}, activeThread: null, model: 'pro' };

            const newThreadId = 'c' + Date.now();
            S.chats[projId].threads.unshift({ id: newThreadId, title: `Global: ${thread.title.substring(0,30)}`});
            S.chats[projId].messages[newThreadId] = JSON.parse(JSON.stringify(messages));
            S.chats[projId].activeThread = newThreadId; // Activar el nuevo hilo en el proyecto
            save();
            showToast(`Chat enviado a "${S.projects.find(p=>p.id===projId).name}"`, 'success');

            // Navegar y abrir el chat del proyecto
            history.pushState({view: `project/${projId}`}, '', `#!project/${projId}`);
            openProject(projId);
            setTimeout(() => { // Esperar a que el proyecto se renderice
                $('#project-tabs .tab[data-ptab="chat"]').click();
                 // No es necesario renderProjectChat aquí, openProject y el click lo hacen
            }, 100);
            modal.close();
        } else {
            showToast("Selecciona un proyecto válido.", "warn");
        }
    };
    modal.showModal();
}
async function sendGlobalAIChatMessage() {
    // Nota: El límite de invitado ya se chequea en callGeminiAPI
    const msgInput = $('#aiChatMsg');
    const msg = msgInput.value.trim(); if (!msg) return;
    const C = S.aiGlobalChat;
    if (!C || !C.activeThread) {
        // Si no hay hilo activo, intenta crear el inicial
        if (C.threads.length === 0) {
            const newId = 'c_global_1';
            C.threads = [{id: newId, title: 'Chat General'}];
            C.activeThread = newId;
            C.messages = {[newId]: []};
            save();
            // Continuar con el envío del mensaje ahora que hay un hilo
        } else {
             showToast("Error: No hay conversación activa.", "danger");
             return;
        }
    }
    const model = C.model;
    const threadId = C.activeThread;

    // Verificar si el modelo X requiere PRO
    if (model === 'x' && !S.userProfile.isPro) {
        showLimitModal('goatifyX');
        return;
    }

    C.messages[threadId].push({ who: 'Tú', at: new Date().toISOString(), text: msg });
    msgInput.value = ''; msgInput.style.height = 'auto';
    renderGlobalAIChat(); // Muestra mensaje del usuario

    try {
        const responseText = await callGeminiAPI(msg, model); // Llama a la simulación/API real
        C.messages[threadId].push({ who: 'IA', at: new Date().toISOString(), text: responseText, type: model });
        save();
        renderGlobalAIChat(); // Muestra respuesta de IA

        // Si la respuesta contiene código y el modelo es X (PRO), muestra la preview
        if (model === 'x' && responseText.includes('[CODE]') && S.userProfile.isPro) {
            showAiCodePreview(responseText);
        }

    } catch (error) {
        console.error("Error calling AI API:", error);
        // El toast de error ya se muestra en callGeminiAPI si es por límite
        if (error !== "AI response limit reached for free plan." && error !== "Goatify X requires PRO plan." && error !== "Guest limit reached") {
            showToast(`Error al obtener respuesta de IA.`, "danger");
        }
        // Opcional: Remover mensaje del usuario si falla
        // C.messages[threadId].pop();
        // renderGlobalAIChat();
    }
}
/**
 * Muestra el panel de vista previa de código en el chat global.
 * @param {string} aiResponseText - El texto completo de la respuesta de IA.
 */
function showAiCodePreview(aiResponseText) {
    const codeMatch = aiResponseText.match(/\[CODE\]([\s\S]*?)\[\/CODE\]/);
    if (!codeMatch) return;
    const codeContent = codeMatch[1];
    const previewWrapper = $('#aiCodePreviewWrapper');
    const iframe = $('#aiCodePreviewFrame');
    if (!previewWrapper || !iframe) return;

    iframe.srcdoc = codeContent; // Carga el código en el iframe
    previewWrapper.style.display = 'block'; // Muestra el contenedor
    // Scroll hacia el final para ver la preview
    const log = $('#aiChatLog');
    log.scrollTop = log.scrollHeight;
}

/**
 * Crea el elemento DOM para un mensaje de chat (IA o Usuario).
 * Incluye manejo de bloques de código y preview para Goatify X.
 * @param {object} message - Objeto del mensaje.
 * @param {object} [userProfile] - Perfil del usuario (para avatar 'Tú').
 */
function createMessageElement(message, userProfile) {
    const isMine = message.who === 'Tú'; // Asume que 'Tú' siempre es el usuario local
    const profile = userProfile || { avatar: null, nombre: 'Usuario', firstName: 'Usuario', lastName: '' }; // Fallback
    const initials = getInitials(profile.firstName, profile.lastName);
    const avatarSrc = isMine
        ? (profile.avatar || `https://placehold.co/40x40/dde2ed/0b132a?text=${initials}`)
        : (message.avatar || 'Logos HD.png'); // Avatar de IA o de otro usuario
    const senderName = isMine ? 'Tú' : (message.who || 'IA');

    const msgBody = el('div', { class: 'msg-body' });
    const textToParse = message.text || "";

    // Regex mejorado para capturar opcionalmente el lenguaje
    const codeRegex = /\[CODE(?: lang="([^"]+)")?\]([\s\S]*?)\[\/CODE\]/g;
    let lastIndex = 0;
    let match;

    while ((match = codeRegex.exec(textToParse)) !== null) {
        // Texto antes del bloque de código
        if (match.index > lastIndex) {
            msgBody.append(createFormattedTextNode(textToParse.substring(lastIndex, match.index)));
        }

        const language = match[1] || 'html'; // Lenguaje (default: html)
        const codeContent = match[2];

        // Botón de Preview (solo para HTML y si es PRO)
        const previewBtn = (language === 'html' && S.userProfile.isPro)
            ? el('button', { class: 'btn btn-sm code-preview-btn' }, el('i', {'data-lucide':'eye', width:14}))
            : null;

        const codeBlock = el('div', { class: 'code-block' },
            el('div', { class: 'code-header' },
                el('span', { textContent: `Código (${language})` }),
                el('span', { class: 'spacer' }),
                previewBtn, // Añadir botón de preview si existe
                el('button', { class: 'btn btn-sm code-copy-btn' }, el('i', {'data-lucide':'copy', width:14})),
                el('button', { class: 'btn btn-sm code-download-btn' }, el('i', {'data-lucide':'download', width:14}))
            ),
            el('pre', {}, el('code', { textContent: codeContent /* Aquí iría resaltado de sintaxis */ })),
            // Contenedor de preview (oculto por defecto)
            (language === 'html' && S.userProfile.isPro) ? el('div', { class: 'code-preview-container', style: 'display:none;' },
                el('iframe', { title: 'Vista Previa de Código', sandbox: "allow-scripts allow-same-origin" }) // Sandbox por seguridad
            ) : null
        );

        // Listeners para botones del bloque de código
        if (previewBtn) {
            previewBtn.onclick = (e) => {
                 if (!incrementGuestAction()) return; // Verifica invitado
                 const previewContainer = e.target.closest('.code-block').querySelector('.code-preview-container');
                 const iframe = previewContainer.querySelector('iframe');
                 // Usar srcdoc para evitar problemas de seguridad y carga
                 iframe.srcdoc = codeContent;
                 previewContainer.style.display = previewContainer.style.display === 'none' ? 'block' : 'none';
                 // Scroll al final del chat para ver preview
                 const chatLog = e.target.closest('.chat-log');
                 if (chatLog) chatLog.scrollTop = chatLog.scrollHeight;
            };
        }
        codeBlock.querySelector('.code-copy-btn').onclick = () => {
             if (!incrementGuestAction()) return; // Verifica invitado
             // Usar document.execCommand como fallback si navigator.clipboard falla
             try {
                 navigator.clipboard.writeText(codeContent)
                    .then(() => showToast('Código copiado!', 'success'))
                    .catch(err => {
                        console.warn('Clipboard API failed, using fallback:', err);
                        const textArea = el('textarea', { value: codeContent });
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            showToast('Código copiado!', 'success');
                        } catch (execErr) {
                            showToast('Error al copiar el código.', 'warn');
                            console.error('Fallback copy failed:', execErr);
                        }
                        document.body.removeChild(textArea);
                    });
             } catch (e) {
                  showToast('Error al copiar, tu navegador podría no ser compatible.', 'warn');
             }
         };
        codeBlock.querySelector('.code-download-btn').onclick = () => {
             if (!incrementGuestAction()) return; // Verifica invitado
             const extension = language === 'javascript' ? 'js' : language === 'python' ? 'py' : language === 'css' ? 'css' : 'html';
             download(`codigo_goatify.${extension}`, codeContent);
         };

        msgBody.append(codeBlock);
        lastIndex = match.index + match[0].length;
    }

    // Texto después del último bloque de código (o todo el texto si no hay código)
    if (lastIndex < textToParse.length) {
        msgBody.append(createFormattedTextNode(textToParse.substring(lastIndex)));
    }

    // Crear elemento principal del mensaje
    const msgElement = el('div', { class: 'msg' + (isMine ? ' mine' : '') },
        el('img', { src: avatarSrc, class: 'msg-avatar', alt: senderName, onerror: (e) => e.target.src='https://placehold.co/40x40/cccccc/ffffff?text=?' }), // Fallback avatar
        el('div', { class: 'msg-content' },
            el('div', { class: 'msg-who', textContent: senderName }),
            msgBody
        )
    );
    lucide.createIcons();
    return msgElement;
}

/**
 * Crea un nodo de texto o fragmento con formato básico (negrita, itálica, enlaces, imágenes).
 * @param {string} text - El texto a formatear.
 * @returns {DocumentFragment | Text}
 */
function createFormattedTextNode(text) {
    const fragment = document.createDocumentFragment();
    // Regex para negrita, itálica, enlaces e imágenes Markdown
    const regex = /(\*\*(.*?)\*\*|\*(.*?)\*|!\[(.*?)\]\((.*?)\)|\[(.*?)\]\((.*?)\))/g;
    let lastIndex = 0;
    let match;

    while ((match = regex.exec(text)) !== null) {
        // Texto antes del match
        if (match.index > lastIndex) {
            fragment.appendChild(document.createTextNode(text.substring(lastIndex, match.index)));
        }

        if (match[1].startsWith('**')) { // Negrita
            fragment.appendChild(el('strong', {}, match[2]));
        } else if (match[1].startsWith('*')) { // Itálica
            fragment.appendChild(el('em', {}, match[3]));
        } else if (match[1].startsWith('![')) { // Imagen
            fragment.appendChild(el('img', { src: match[5], alt: match[4] || 'Imagen', style: 'max-width: 100%; border-radius: 8px; margin-top: 5px;' }));
        } else if (match[1].startsWith('[')) { // Enlace
            fragment.appendChild(el('a', { href: match[7], target: '_blank' }, match[6]));
        }

        lastIndex = match.index + match[0].length;
    }

    // Texto después del último match
    if (lastIndex < text.length) {
        fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
    }

    // Si solo hay texto plano, devuelve un nodo de texto simple
    if (fragment.childNodes.length === 1 && fragment.firstChild.nodeType === Node.TEXT_NODE) {
        return fragment.firstChild;
    }

    return fragment;
}


// --- 6.2: CRONOPOST (Calendario General) ---
let cpRef = new Date();
function renderCronoPOST() {
    const sel = $('#cpProjectSelect'); const currentSelection = sel.value;
    sel.innerHTML = '';
    sel.append(el('option', { value: 'all', textContent: 'Todos los Proyectos' }));
    S.projects.forEach(p => sel.append(el('option', { value: p.id, textContent: p.name })));
    // Restaurar selección si el proyecto aún existe, sino default a 'all'
    sel.value = S.projects.find(p => p.id === currentSelection) ? currentSelection : 'all';

    const activeProjectId = sel.value;
    $('#cpMonthLbl').textContent = cpRef.toLocaleString('es', { month: 'long', year: 'numeric' });
    const calendarEl = $('#cpCalendar'); calendarEl.innerHTML = '';

    const headerRow = el('div',{style:'display:contents;'});
    ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'].forEach(day => headerRow.append(el('div', { textContent: day, style: 'text-align:center; font-weight: 600; color: var(--sub); padding-bottom: 8px; font-size: var(--sm);' })));
    calendarEl.append(headerRow);

    const monthGrid = (ref = new Date()) => {
        const y = ref.getFullYear(), m = ref.getMonth(); const first = new Date(y, m, 1);
        const start = new Date(first); start.setDate(1 - ((first.getDay() + 6) % 7)); // Lunes
        const days = []; let cur = new Date(start);
        // Ajustar número de días para mostrar 6 semanas si es necesario
        const endDate = new Date(y, m + 1, 0); // Último día del mes
        const numWeeks = Math.ceil((endDate.getDate() + ((first.getDay() + 6) % 7)) / 7);
        const numDays = numWeeks > 5 ? 42 : 35; // 6 o 5 semanas
        while (days.length < numDays) { days.push(new Date(cur)); cur.setDate(cur.getDate() + 1); } return days;
    };

    const projectsToShow = activeProjectId === 'all' ? S.projects : S.projects.filter(p => p.id === activeProjectId);

    monthGrid(cpRef).forEach(d => {
        const localYear = d.getFullYear();
        const localMonth = String(d.getMonth() + 1).padStart(2, '0');
        const localDay = String(d.getDate()).padStart(2, '0');
        const localDateString = `${localYear}-${localMonth}-${localDay}`;
        const dateKeyForComparison = d.toDateString(); // Clave para posts (legacy)

        const dayEl = el('div', { class: 'day', dataset: { localDate: localDateString, dateString: dateKeyForComparison } });
        dayEl.onclick = () => openCronoTaskModal(d); // Abre modal para NUEVA tarea
        if(d.getMonth() !== cpRef.getMonth()) dayEl.style.opacity = .5;
        dayEl.append(el('div', { textContent: d.getDate(), style: 'font-weight: 500; color: var(--sub); margin-bottom: 4px; text-align: right; font-size: var(--sm);' }));

        let entryCountThisDay = 0; // Contador para límite mensual

        projectsToShow.forEach(proj => {
            // Renderizar Posts (Legacy - usan dateKeyForComparison)
            const posts = S.cronopost.posts[proj.id] || {};
            (posts[dateKeyForComparison] || []).forEach((p) => {
                entryCountThisDay++;
                const postEl = el('div', { class: 'cp-post', draggable: 'true', textContent: p.title, title: `${proj.name}: ${p.title}`, style: `border-left-color:${proj.color}; background: color-mix(in hsl, ${proj.color} 15%, transparent);` });
                postEl.ondragstart = e => {
                    if (!incrementGuestAction()) { e.preventDefault(); return; } // Verifica invitado
                    e.stopPropagation();
                    e.dataTransfer.setData('text/plain', JSON.stringify({type: 'post', id: p.id, title: p.title, fromDateString: dateKeyForComparison, fromProject: proj.id}));
                    e.dataTransfer.effectAllowed = 'move';
                };
                dayEl.append(postEl);
            });

            // Renderizar Tareas (usan localDateString para 'due')
            const allTasksForProject = Object.values(S.tasks[proj.id] || {}).flat();
            allTasksForProject.filter(t => t.due && (t.due === localDateString /*|| new Date(t.due).toDateString() === dateKeyForComparison*/)).forEach(t => {
                 entryCountThisDay++;
                 const taskEl = el('div', { class: 'cal-task', draggable: 'true', textContent: `✓ ${t.title}`, title: `Tarea: ${t.title}`, style: `border-left-color:${proj.color};` });
                 taskEl.dataset.folder = t.folder;
                 taskEl.ondragstart = e => {
                      if (!incrementGuestAction()) { e.preventDefault(); return; } // Verifica invitado
                      e.stopPropagation();
                      e.dataTransfer.setData('text/plain', JSON.stringify({type: 'task', taskId: t.id, originFolder: t.folder, fromProject: proj.id })); // Usar taskId y originFolder
                      e.dataTransfer.effectAllowed = 'move';
                 };
                 dayEl.append(taskEl);
            });
        });

        dayEl.ondragover = (e) => { e.preventDefault(); dayEl.classList.add('dragover'); };
        dayEl.ondragleave = (e) => { dayEl.classList.remove('dragover'); };
        dayEl.ondrop = (e) => {
            e.preventDefault();
            if (!incrementGuestAction()) return; // Verifica invitado
            dayEl.classList.remove('dragover');
            let data;
            try { data = JSON.parse(e.dataTransfer.getData('text/plain')); } catch(err) { console.error("Error parsing D&D data:", err); return; }

            const toLocalDate = dayEl.dataset.localDate;
            const toDateStringKey = dayEl.dataset.dateString;
            const targetProjectId = $('#cpProjectSelect').value; // Proyecto seleccionado en el dropdown

            // Verifica límite de calendario ANTES de añadir
            if (data.type === 'idea' || data.type === 'post' || data.type === 'task') {
                if (checkLimitReached('calendarEntries', usageTracker.calendarEntriesThisMonth + 1)) { // Simula añadir 1
                    showToast("Límite mensual de entradas de calendario alcanzado.", "warn");
                    return;
                }
            }


            if (data.type === 'idea') {
                if (!targetProjectId || targetProjectId === 'all') { showToast('Selecciona un proyecto para agendar ideas.', 'warn'); return; }

                if (!S.cronopost.posts[targetProjectId]) S.cronopost.posts[targetProjectId] = {};
                if (!S.cronopost.posts[targetProjectId][toDateStringKey]) S.cronopost.posts[targetProjectId][toDateStringKey] = [];
                S.cronopost.posts[targetProjectId][toDateStringKey].push({ id: 'post' + Date.now(), title: data.title });

                // Eliminar idea del banco si existe en el proyecto target
                if (S.cronopost.ideas[targetProjectId]) {
                     S.cronopost.ideas[targetProjectId] = S.cronopost.ideas[targetProjectId].filter(i => i.id !== data.id);
                }
                usageTracker.calendarEntriesThisMonth++; // Incrementar contador

            } else if (data.type === 'post') { // Mover post existente
                if (!data.fromProject || !data.fromDateString) return;
                const fromPosts = S.cronopost.posts[data.fromProject]?.[data.fromDateString];
                if (!fromPosts) return;

                const postIndex = fromPosts.findIndex(p => p.id === data.id);
                if (postIndex > -1) {
                    const [post] = fromPosts.splice(postIndex, 1); // Quitar del origen
                    if (fromPosts.length === 0) delete S.cronopost.posts[data.fromProject][data.fromDateString]; // Limpiar si queda vacío

                    // Añadir al destino (mismo proyecto, nueva fecha)
                    if (!S.cronopost.posts[data.fromProject]) S.cronopost.posts[data.fromProject] = {};
                    if (!S.cronopost.posts[data.fromProject][toDateStringKey]) S.cronopost.posts[data.fromProject][toDateStringKey] = [];
                    S.cronopost.posts[data.fromProject][toDateStringKey].push(post);
                    // No incrementar contador aquí, solo se movió
                }

            } else if (data.type === 'task') { // Mover tarea existente
                if (!data.fromProject || !data.originFolder || !data.taskId) return;
                const taskFolder = data.originFolder;
                const task = S.tasks[data.fromProject]?.[taskFolder]?.find(t => t.id === data.taskId);
                if (task) {
                    const oldLocalDate = task.due;
                    task.due = toLocalDate; // Actualizar fecha
                    // Incrementar contador SOLO si era una tarea sin fecha previa y ahora tiene
                    if (!oldLocalDate && toLocalDate) {
                         usageTracker.calendarEntriesThisMonth++;
                    }
                    console.log(`Task ${data.taskId} due date updated to ${toLocalDate} in folder ${taskFolder}`);
                } else {
                     console.error(`Task ${data.taskId} not found in origin folder ${taskFolder} during drop`);
                }
            }
            save();
            renderCronoPOST();
            // Actualizar calendario de proyecto si la tarea movida pertenece al proyecto activo
            if (S.activeProject && S.activeProject === data.fromProject) {
                renderCalendar();
                renderTasks(); // Re-renderiza tareas también
            }
        };
        calendarEl.append(dayEl);
    });

    const ideasList = $('#cpIdeasList'); ideasList.innerHTML = '';
    const ideasContainer = $('#cpIdeas');
    if (activeProjectId !== 'all') {
        ideasContainer.style.opacity = 1;
        $('#cpNewIdeaInput').disabled = false;
        $('#cpAddIdeaBtn').disabled = false;
        $('#cpGenAIIdeas').disabled = false;

        if (!S.cronopost.ideas[activeProjectId]) S.cronopost.ideas[activeProjectId] = [];
        const ideas = S.cronopost.ideas[activeProjectId];

        if (ideas.length === 0) {
             ideasList.innerHTML = `<div class="empty-state" style="padding: 10px; font-size: var(--sm);">Añade tu primera idea.</div>`;
        } else {
            ideas.forEach(idea => {
                const ideaEl = el('div', { class: 'cp-post', draggable: 'true', textContent: idea.title });
                ideaEl.ondragstart = (e) => {
                    if (!incrementGuestAction()) { e.preventDefault(); return; } // Verifica invitado
                    e.stopPropagation();
                    e.dataTransfer.setData('text/plain', JSON.stringify({type: 'idea', id: idea.id, title: idea.title}));
                    e.dataTransfer.effectAllowed = 'move';
                };
                ideasList.append(ideaEl);
            });
        }
    } else {
         ideasList.innerHTML = `<div class="empty-state" style="padding: 10px; font-size: var(--sm);">Selecciona un proyecto para ver y añadir ideas.</div>`;
         ideasContainer.style.opacity = 0.6;
         $('#cpNewIdeaInput').disabled = true;
         $('#cpAddIdeaBtn').disabled = true;
         $('#cpGenAIIdeas').disabled = true;
    }
    updateUILimits(); // Actualiza visualización de límites
}

/**
 * Abre el modal mejorado para crear una tarea desde Cronopost.
 * @param {Date} date - Fecha seleccionada.
 */
function openCronoTaskModal(date) {
    if (!incrementGuestAction()) return; // Verifica invitado
    // Verifica límite de tareas Y de calendario ANTES de abrir
    if (checkLimitReached('tasks') || checkLimitReached('calendarEntries')) return;

    const modal = $('#cronoTaskModal');
    $('#cronoTaskModalDesc').textContent = `Crear tarea para ${fmtDate(date, 'short')}`;
    const projectSelect = $('#cronoTaskProjectSelect');
    const statusSelect = $('#cronoTaskStatusSelect');

    $('#cronoTaskTitle').value = '';
    $('#cronoTaskDesc').value = '';
    $('#cronoTaskTags').value = '';
    projectSelect.innerHTML = '';
    statusSelect.innerHTML = '';

    if(S.projects.length === 0) {
        showToast('Debes crear un proyecto primero.', 'warn');
        return;
    }

    S.projects.forEach(p => projectSelect.append(el('option', {value: p.id, textContent: p.name})));

    const populateStatuses = (projectId) => {
        statusSelect.innerHTML = '';
        const project = S.projects.find(p => p.id === projectId);
        if (project && project.taskColumns) {
            project.taskColumns.forEach(status => statusSelect.append(el('option', {value: status, textContent: status})));
        } else {
             statusSelect.append(el('option', {value: 'Backlog', textContent: 'Backlog'}));
        }
    };

    populateStatuses(projectSelect.value);
    // Listener único
    if (!projectSelect.dataset.listenerAttached) {
        projectSelect.addEventListener('change', () => populateStatuses(projectSelect.value));
        projectSelect.dataset.listenerAttached = 'true';
    }

    // Listener único para confirmar
    const confirmBtn = $('#cronoTaskConfirm');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    newConfirmBtn.onclick = () => {
        // Verifica límites OTRA VEZ al confirmar, por si acaso
        if (checkLimitReached('tasks') || checkLimitReached('calendarEntries')) { modal.close(); return; }

        const title = $('#cronoTaskTitle').value.trim();
        const projectId = projectSelect.value;
        if (!title || !projectId) return showToast('Título y proyecto son requeridos.', 'warn');

        const desc = $('#cronoTaskDesc').value.trim();
        const status = statusSelect.value;
        const tags = ($('#cronoTaskTags').value || '').split(',').map(tag => tag.trim()).filter(tag => tag !== '');
        const targetFolder = 'General';

        const localYear = date.getFullYear();
        const localMonth = String(date.getMonth() + 1).padStart(2, '0');
        const localDay = String(date.getDate()).padStart(2, '0');
        const localDateString = `${localYear}-${localMonth}-${localDay}`;

        const newTask = {
            id: 't' + Date.now(), title, status, desc, due: localDateString, folder: targetFolder, tags
        };

        if (!S.tasks[projectId]) S.tasks[projectId] = {};
        if (!S.tasks[projectId][targetFolder]) S.tasks[projectId][targetFolder] = [];

        S.tasks[projectId][targetFolder].push(newTask);
        addIntis(INTIS_REWARDS.createTask, 'Tarea creada');
        usageTracker.calendarEntriesThisMonth++; // Incrementar contador calendario
        save();
        renderCronoPOST();
        if(S.activeProject === projectId) { renderCalendar(); renderTasks(); }
        renderAside();
        modal.close();
        updateUILimits(); // Actualiza UI de límites
    };
    modal.showModal();
    lucide.createIcons();
}

// --- 6.3: HUB PROFESIONAL (Avatar con Iniciales) ---
function renderHub() {
    if (!S.hub) S.hub = JSON.parse(JSON.stringify(initialState.hub));
    const P = S.hub.perfil || initialState.hub.perfil; // Usar perfil inicial si no existe
    const firstName = S.userProfile.firstName || P.nombre; // Prioriza datos de userProfile
    const lastName = S.userProfile.lastName || P.apellido || '';

    // Lógica para mostrar Avatar o Iniciales
    const avatarImg = $('#avatar');
    const avatarInitials = $('#avatarInitials');
    if (P.avatar) {
        avatarImg.src = P.avatar;
        avatarImg.style.display = 'block';
        avatarInitials.style.display = 'none';
    } else {
        avatarInitials.textContent = getInitials(firstName, lastName);
        avatarImg.style.display = 'none';
        avatarInitials.style.display = 'flex';
    }

    $('#pNombreDisplay').textContent = `${firstName} ${lastName}`.trim() || 'Usuario';
    $('#pRoleDisplay').textContent = P.rol;
    $('#pBioDisplay').textContent = P.bio;
    $('#pNombre').value = firstName;
    $('#pApellido').value = lastName;
    $('#pRole').value = P.rol;
    $('#pBio').value = P.bio;
    $('#pSocialLinkedin').value = P.socials?.linkedin || '';
    $('#pSocialTwitter').value = P.socials?.twitter || '';

    const socialsEl = $('#pSocialsDisplay'); socialsEl.innerHTML = '';
    if(P.socials?.linkedin) socialsEl.append(el('a', {href: P.socials.linkedin, target:'_blank', class:'btn btn-ghost btn-sm'}, el('i', {'data-lucide':'linkedin'})));
    if(P.socials?.twitter) socialsEl.append(el('a', {href: P.socials.twitter, target:'_blank', class:'btn btn-ghost btn-sm'}, el('i', {'data-lucide':'twitter'})));

    const mkList = $('#mkList'); mkList.innerHTML = '';
    (S.hub.market || []).forEach(item => {
        mkList.append(el('div', {class: 'card', style:'margin-bottom:10px; background: var(--surface);'},
            el('div', {class:'row'}, el('b', {textContent: item.name}), el('span', {class:'spacer'}), el('span', {class:'chip', textContent: `$${item.price}`})),
            el('p', {class:'sub', textContent:item.desc}),
            el('div', {class:'row'}, el('span',{class:'spacer'}),
                // Botones solo si es el autor (o si no hay authorId para compatibilidad)
                (item.authorId === 'u_me' || !item.authorId) ? el('button', {class:'btn btn-sm btn-ghost', onclick:()=>editMarketItem(item.id)}, el('i',{'data-lucide':'edit-3', width:16})) : null,
                (item.authorId === 'u_me' || !item.authorId) ? el('button', {class:'btn btn-sm btn-ghost', onclick:()=>deleteMarketItem(item.id)}, el('i',{'data-lucide':'trash-2', width:16})) : null
            )
        ));
    });
    renderJobs();
    lucide.createIcons();
}
function renderJobs(){
    const list = $('#jobsList'); list.innerHTML = '';
    const searchTerm = ($('#jobSearchInput')?.value || '').toLowerCase().trim();
    const jobs = (S.hub.jobs || []).filter(j =>
         (j.title || '').toLowerCase().includes(searchTerm) ||
         (j.company || '').toLowerCase().includes(searchTerm)
    );

    if (jobs.length === 0) {
        list.innerHTML = `<div class="empty-state"><i data-lucide="search-x" width="48" height="48"></i><h4>No hay ofertas de empleo</h4><p>No se han publicado ofertas o no coinciden con tu búsqueda.</p></div>`;
        lucide.createIcons(); return;
    }

    jobs.forEach(job => {
        const card = el('div', {class: 'job-card'},
            el('div', {class:'row'},
                el('div', {},
                    el('div', {class: 'job-title', textContent: job.title}),
                    el('div', {class: 'job-company', textContent: `${job.company} • ${job.location}`})
                ),
                el('span', {class: 'spacer'}),
                el('div', {},
                    el('div', {class:'chip', textContent: job.type}),
                    el('div', {style:'text-align:right; margin-top: 4px; font-weight: 600;', textContent: job.pay})
                )
            ),
            el('div', {class: 'job-card-details'},
                 el('p', {textContent: job.desc}),
                 // Mostrar botones solo si el usuario es el autor
                 (job.authorId === 'u_me') ? el('div', {class:'row', style:'margin-top:16px; border-top: 1px solid var(--line); padding-top: 10px;'},
                    el('span', {class:'spacer'}),
                    el('button', {class:'btn btn-sm btn-ghost', onclick:(e)=>{ e.stopPropagation(); editJob(job.id); }}, el('i',{'data-lucide':'edit-3', width:16})),
                    el('button', {class:'btn btn-sm btn-ghost', onclick:(e)=>{ e.stopPropagation(); deleteJob(job.id); }}, el('i',{'data-lucide':'trash-2', width:16}))
                 ) : null
            )
        );
        card.onclick = () => {
            const details = card.querySelector('.job-card-details');
            if (details) details.style.display = details.style.display === 'block' ? 'none' : 'block';
        };
        list.append(card);
    });
    lucide.createIcons(); // Asegurar que los iconos de los botones se rendericen
}
function addJob() {
    if (!incrementGuestAction()) return; // Verifica invitado
    if (!S.hub) S.hub = JSON.parse(JSON.stringify(initialState.hub));
    if (!S.hub.jobs) S.hub.jobs = [];

    const job = {
        id: 'j' + Date.now(),
        title: $('#jobTitle').value.trim(),
        company: $('#jobCompany').value.trim(),
        location: $('#jobLocation').value.trim(),
        pay: $('#jobPay').value.trim(),
        type: $('#jobType').value,
        desc: $('#jobDesc').value.trim(),
        authorId: 'u_me' // Identifica al autor
    };
    if (!job.title || !job.company) return showToast('Título y empresa son obligatorios.', 'warn');
    S.hub.jobs.unshift(job);
    addIntis(INTIS_REWARDS.publishHub, 'Empleo publicado');
    save(); renderJobs();
    showToast('Oferta de empleo publicada', 'success');
    ['#jobTitle', '#jobCompany', '#jobLocation', '#jobPay', '#jobDesc'].forEach(s => $(s).value = '');
}
// NUEVO: Editar Empleo
function editJob(jobId) {
    if (!incrementGuestAction()) return; // Verifica invitado
    if (!S.hub || !S.hub.jobs) return;
    const job = S.hub.jobs.find(j => j.id === jobId);
    if (!job || job.authorId !== 'u_me') return showToast('No puedes editar esta oferta.', 'warn');

    // Pre-llenar campos del formulario de añadir/editar
    $('#jobTitle').value = job.title;
    $('#jobCompany').value = job.company;
    $('#jobLocation').value = job.location;
    $('#jobPay').value = job.pay;
    $('#jobType').value = job.type;
    $('#jobDesc').value = job.desc;

    // Cambiar botón de Añadir a Guardar (temporalmente)
    const addButton = $('#addJob');
    const originalText = addButton.textContent;
    const originalOnClick = addButton.onclick;
    addButton.textContent = 'Guardar Cambios';
    addButton.onclick = () => {
        job.title = $('#jobTitle').value.trim();
        job.company = $('#jobCompany').value.trim();
        job.location = $('#jobLocation').value.trim();
        job.pay = $('#jobPay').value.trim();
        job.type = $('#jobType').value;
        job.desc = $('#jobDesc').value.trim();
        if (!job.title || !job.company) return showToast('Título y empresa son obligatorios.', 'warn');

        save();
        renderJobs();
        showToast('Oferta de empleo actualizada.', 'success');
        // Restaurar botón y limpiar formulario
        addButton.textContent = originalText;
        addButton.onclick = originalOnClick;
        ['#jobTitle', '#jobCompany', '#jobLocation', '#jobPay', '#jobDesc'].forEach(s => $(s).value = '');
    };
    showToast('Editando oferta. Guarda los cambios.', 'info');
}
// NUEVO: Eliminar Empleo
function deleteJob(jobId) {
    if (!incrementGuestAction()) return; // Verifica invitado
    if (!S.hub || !S.hub.jobs) return;
    const job = S.hub.jobs.find(j => j.id === jobId);
    if (!job || job.authorId !== 'u_me') return showToast('No puedes eliminar esta oferta.', 'warn');

    showInputModal('Confirmar Eliminación', `Eliminar esta oferta de empleo? Escribe "eliminar".`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            S.hub.jobs = S.hub.jobs.filter(j => j.id !== jobId);
            save();
            renderJobs();
            showToast('Oferta eliminada.', 'info');
        }
    });
}
function saveProfile() {
    if (!incrementGuestAction()) return; // Verifica invitado
    if (!S.hub) S.hub = JSON.parse(JSON.stringify(initialState.hub));
    if (!S.hub.perfil) S.hub.perfil = { socials: {} }; // Asegurar que perfil exista
    if (!S.hub.perfil.socials) S.hub.perfil.socials = { linkedin: '', twitter: '' };

    // Guarda en userProfile Y en hub.perfil para consistencia local
    S.userProfile.firstName = $('#pNombre').value.trim();
    S.userProfile.lastName = $('#pApellido').value.trim();
    S.hub.perfil.nombre = S.userProfile.firstName; // Mantener sincronizado por ahora
    S.hub.perfil.apellido = S.userProfile.lastName; // Nuevo campo
    S.hub.perfil.rol = $('#pRole').value.trim();
    S.hub.perfil.bio = $('#pBio').value.trim();
    S.hub.perfil.socials.linkedin = $('#pSocialLinkedin').value.trim();
    S.hub.perfil.socials.twitter = $('#pSocialTwitter').value.trim();

    // Actualizar ID del perfil si el usuario está logueado
    if (!S.ui.isGuest && S.userProfile.userId) {
        S.hub.perfil.id = S.userProfile.userId;
    } else {
        S.hub.perfil.id = 'guest_user'; // O un ID genérico para invitado
    }


    save(); renderHub(); showToast("Perfil actualizado", "success");
}
function handleAvatarUpload(e) {
    if (!incrementGuestAction()) return; // Verifica invitado
    const file = e.target.files?.[0]; if (!file) return;
    // Validación simple de tamaño (ej: < 2MB)
    if (file.size > 2 * 1024 * 1024) {
        showToast("La imagen es muy grande (máx 2MB).", "warn");
        e.target.value = null; // Limpiar input
        return;
    }
    const reader = new FileReader();
    reader.onload = (event) => {
        if (!S.hub) S.hub = JSON.parse(JSON.stringify(initialState.hub));
        if (!S.hub.perfil) S.hub.perfil = {};
        S.hub.perfil.avatar = event.target?.result;
        save();
        renderHub();
        e.target.value = null; // Limpiar input
    };
    reader.onerror = () => { showToast("Error al cargar la imagen.", "danger"); e.target.value = null; };
    reader.readAsDataURL(file);
}
function addMarketItem() {
    if (!incrementGuestAction()) return; // Verifica invitado
    if (!S.hub) S.hub = JSON.parse(JSON.stringify(initialState.hub));
    if (!S.hub.market) S.hub.market = [];
    const name = $('#mkName').value.trim();
    const price = Number($('#mkPrice').value || 0);
    const desc = $('#mkDesc').value.trim();
    if (!name) return showToast('El nombre del servicio es obligatorio.', 'warn');
    S.hub.market.unshift({ id:'m'+Date.now(), name, price, desc, authorId: 'u_me' }); // Añadir authorId
    addIntis(INTIS_REWARDS.publishHub, 'Servicio publicado');
    save(); renderHub();
    ['#mkName', '#mkPrice', '#mkDesc'].forEach(s => $(s).value = '');
    showToast('Servicio publicado en el mercado', 'success');
}
function editMarketItem(id) {
    if (!incrementGuestAction()) return; // Verifica invitado
    if (!S.hub || !S.hub.market) return;
    const item = S.hub.market.find(i => i.id === id);
    if (!item || item.authorId !== 'u_me') return showToast('No puedes editar este servicio.', 'warn');

    showInputModal('Editar Servicio', 'Nuevo nombre:', item.name, newName => {
        showInputModal('Editar Servicio', 'Nuevo precio:', item.price, newPrice => {
             showInputModal('Editar Servicio', 'Nueva descripción:', item.desc, newDesc => {
                if (newName) item.name = newName;
                const priceNum = Number(newPrice);
                if (!isNaN(priceNum)) item.price = priceNum;
                if (newDesc) item.desc = newDesc; // Actualizar descripción
                save(); renderHub();
                showToast('Servicio actualizado.', 'success');
             }, item.desc, 'textarea'); // Usar textarea para descripción
        }, item.price, 'number');
    }, item.name);
}
function deleteMarketItem(id) {
    if (!incrementGuestAction()) return; // Verifica invitado
    if (!S.hub || !S.hub.market) return;
    const item = S.hub.market.find(i => i.id === id);
    if (!item || item.authorId !== 'u_me') return showToast('No puedes eliminar este servicio.', 'warn');

    showInputModal('Confirmar Eliminación', `Eliminar "${item.name}"? Escribe "eliminar".`, 'eliminar', (confirmText) => {
        if (confirmText.toLowerCase() === 'eliminar') {
            S.hub.market = S.hub.market.filter(i => i.id !== id);
            save(); renderHub();
            showToast('Servicio eliminado.', 'info');
        }
    });
}

// --- 6.4: CHAT GLOBAL ---
function renderGChat() {
    // Si es invitado, no renderizar chat global (o mostrar mensaje)
    if (S.ui.isGuest) {
        $('#gchat').innerHTML = `<div class="empty-state" style="height: 100%; display: flex; flex-direction: column; justify-content: center;"><i data-lucide="lock" width="48" height="48"></i><h4>Chat Global no disponible</h4><p>Inicia sesión o regístrate para chatear con otros usuarios.</p><button id="guest-login-btn" class="btn btn-primary">Iniciar Sesión / Registrarse</button></div>`;
        $('#guest-login-btn').onclick = handleGuestLoginRedirect;
        lucide.createIcons();
        return;
    }

    if (!S.hub) S.hub = JSON.parse(JSON.stringify(initialState.hub));
    if (!S.gchat) S.gchat = JSON.parse(JSON.stringify(initialState.gchat));
    if (!S.gchat.messages) S.gchat.messages = { 'general': [] };
    if (!S.gchat.dms) S.gchat.dms = {};

    // Usa el ID del usuario logueado
    const currentUserId = S.userProfile.userId || 'guest_user';
    S.hub.perfil.id = currentUserId; // Asegura que el perfil local tenga el ID correcto

    // Combina perfil local con otros usuarios (simulados o de DB)
    const allUsers = [S.hub.perfil, ...(S.hub.users || [])].filter(u => u && u.id); // Filtrar nulos o sin ID
    const uniqueUserIds = new Set();
    const uniqueUsers = allUsers.filter(u => {
        if (!uniqueUserIds.has(u.id)) {
            uniqueUserIds.add(u.id);
            return true;
        }
        return false;
    });


    const userList = $('#gUserList'); userList.innerHTML = '';

    const generalChannel = el('div', {class: 'projItem', onclick: ()=> openDirectMessage('general')}, el('i', {'data-lucide': 'hash'}), el('span', {textContent: 'general'}));
    if (S.gchat.activeChat === 'general') generalChannel.classList.add('active');
    userList.append(generalChannel);

    uniqueUsers.filter(u => u.id !== currentUserId).forEach(u => {
        const dmKey = [currentUserId, u.id].sort().join('-');
        const userEl = el('div', {class: 'projItem', dataset: {userid: u.id}, onclick: ()=> openDirectMessage(u.id)},
            el('div', {class:'presence-dot', style:`width: 8px; height: 8px; border-radius: 50%; background:${u.online ? 'var(--success)' : 'var(--sub)'}`}),
            el('span', {textContent: `${u.nombre} ${u.apellido || ''}`.trim() }) // Mostrar nombre completo
        );
        if (S.gchat.activeChat === dmKey) userEl.classList.add('active');
        userList.append(userEl);
    });

    const log = $('#gChatLog'); log.innerHTML = ''; let messages = []; let activeChatName = "Chat";
    const header = $('#gChatHeader'); header.innerHTML = ''; // Limpiar header

    if (S.gchat.activeChat === 'general') {
        activeChatName = "# general";
        messages = S.gchat.messages.general || [];
        if (messages.length === 0) messages.push({senderId: 'system', at: new Date().toISOString(), text: '¡Bienvenido al chat global! Sé respetuoso y colabora.'});
        header.textContent = activeChatName; // Solo texto para general
    } else {
        // Derivar otherUserId correctamente
        const otherUserId = S.gchat.activeChat.replace(currentUserId,'').replace('-','');
        const otherUser = uniqueUsers.find(u => u.id === otherUserId);
        if(otherUser) {
            activeChatName = `Chat con ${otherUser.nombre}`;
            header.textContent = activeChatName;
            // Añadir botón de videollamada
            const callBtn = el('button', {class:"btn btn-sm btn-ghost", id:"videoCallBtn", style:"margin-left: auto;"}, el('i', {'data-lucide':"video"}));
            callBtn.onclick = () => { $('#videoCallTitle').textContent = `Llamando a ${otherUser.nombre}...`; $('#videoCallModal').showModal(); };
            header.appendChild(callBtn);
        } else {
             header.textContent = "Chat Directo"; // Fallback
             console.warn("Other user not found for DM:", S.gchat.activeChat);
        }
        messages = S.gchat.dms[S.gchat.activeChat] || [];
    }

    messages.forEach(m => {
        // Encontrar remitente en la lista única
        const sender = uniqueUsers.find(u => u.id === m.senderId) || {nombre: 'Sistema', avatar: 'Logos HD.png'};
        log.append(createMessageElement(m, sender)); // Pasar perfil del remitente
    });
    requestAnimationFrame(() => { log.scrollTop = log.scrollHeight; });
    lucide.createIcons();
}
function openDirectMessage(userId) {
    if (S.ui.isGuest) { handleGuestLoginRedirect(); return; } // Redirigir invitado
    if (!incrementGuestAction()) return; // Verifica invitado (doble chequeo)

    const currentUserId = S.userProfile.userId;
    if (!currentUserId) { showToast("Error: ID de usuario no encontrado.", "danger"); return; } // Necesario para DMs

    S.gchat.activeChat = (userId === 'general' || userId === currentUserId)
        ? 'general'
        : [currentUserId, userId].sort().join('-'); // Clave DM ordenada
    save(); renderGChat();
}
function sendGChatMessage() {
    if (S.ui.isGuest) { handleGuestLoginRedirect(); return; } // Redirigir invitado
    if (!incrementGuestAction()) return; // Verifica invitado

    const msgInput = $('#gChatMsg');
    const msg = msgInput.value.trim(); if (!msg) return;

    if (!S.gchat) S.gchat = JSON.parse(JSON.stringify(initialState.gchat));
    // ... asegurar estructuras internas ...

    const currentUserId = S.userProfile.userId;
    if (!currentUserId) { showToast("Error: No se pudo enviar el mensaje.", "danger"); return; }

    const message = { senderId: currentUserId, at: new Date().toISOString(), text: msg };

    if (S.gchat.activeChat === 'general') {
        if (!S.gchat.messages.general) S.gchat.messages.general = [];
        S.gchat.messages.general.push(message);
    } else {
        if (!S.gchat.dms[S.gchat.activeChat]) S.gchat.dms[S.gchat.activeChat] = [];
        S.gchat.dms[S.gchat.activeChat].push(message);
    }
    addIntis(INTIS_REWARDS.chatGlobalMessage, 'Mensaje en chat');
    save(); renderGChat(); msgInput.value = '';
}
/**
 * Maneja la redirección o muestra un mensaje para que el invitado inicie sesión.
 */
function handleGuestLoginRedirect() {
    // En un entorno real, redirigiría a la página de login/registro
    // window.location.href = '/login';
    showToast("Por favor, inicia sesión o regístrate para usar esta función.", "warn");
    // Opcionalmente, abrir un modal de login/registro
}


// --- 6.5: MONETIZACIÓN ---
// Ya no necesita JS, es estático en el HTML.

// --- 6.6: MINDSET ---
function setupMindset() {
    const quotes = ["El éxito es la suma de pequeños esfuerzos repetidos.", "La creatividad es la inteligencia divirtiéndose.", "Ama lo que haces."];
    $('#mindsetQuote').textContent = `"${quotes[Math.floor(Math.random()*quotes.length)]}"`;
    const breathingText = $('#breathing-text');
    const circle = $('#breathing-circle');
    // Reiniciar animación al mostrar
    if (circle && breathingText) {
        circle.style.animation = 'none';
        breathingText.style.animation = 'none';
        // Forzar reflow
        void circle.offsetWidth;
        void breathingText.offsetWidth;
        // Reaplicar animación
        circle.style.animation = 'breathe 8s ease-in-out infinite';
        breathingText.style.animation = 'breathe-text 8s ease-in-out infinite';
        breathingText.textContent = 'Inhala...';
    }
}

// --- 6.7: BILLETERA (Intis y Legacy $) ---
function renderWallet() {
    if (!S.wallet) S.wallet = { intis: 0, transactions: [], legacyMovs: [] };

    // Actualizar balance Intis
    $('#walletIntisBalance').textContent = S.wallet.intis || 0;

    // Lógica de notificación de canje
    const redeemInfo = $('#walletRedeemInfo');
    const redeemAmount = $('#redeemAmount');
    if (S.wallet.intis >= INTIS_REDEEM_THRESHOLD) {
        if (redeemAmount) redeemAmount.textContent = INTIS_REDEEM_THRESHOLD;
        if (redeemInfo) redeemInfo.style.display = 'block';
        $('#intisChip')?.classList.add('notify'); // Asegura que brille si ya superó
    } else {
        if (redeemInfo) redeemInfo.style.display = 'none';
        $('#intisChip')?.classList.remove('notify');
    }

    // Renderizar historial legacy $
    const tbodyLegacy = $('#wBody'); tbodyLegacy.innerHTML = '';
    const sortedLegacy = [...(S.wallet.legacyMovs || [])].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    sortedLegacy.forEach((mov) => {
        const tr = el('tr', {},
            el('td', {textContent: fmtDate(mov.fecha, 'short')}),
            el('td', {textContent: mov.tipo, style: `color: ${mov.tipo === 'Ingreso' ? 'var(--success)' : 'var(--danger)'}`}),
            el('td', {textContent: `$${mov.monto.toFixed(2)}`, style:'text-align: right;'}),
            el('td', {textContent: mov.cat}),
            // el('td', {textContent: mov.nota}), // Quitado Nota para simplificar
            el('td', {}, el('button', {class: 'btn btn-ghost btn-sm', onclick: () => {
                if (!incrementGuestAction()) return; // Verifica invitado
                const originalIndex = S.wallet.legacyMovs.findIndex(originalMov => originalMov === mov);
                if (originalIndex > -1) S.wallet.legacyMovs.splice(originalIndex, 1);
                save(); renderWallet(); syncHeader(); // Actualiza header también
            }}, el('i', {'data-lucide': 'trash-2', width: 14})))
        );
        tbodyLegacy.append(tr);
    });

    // Resetear campos de transferencia Intis
    $('#walletTransferUserID').value = '';
    $('#walletTransferAmount').value = '';
    $('#walletTransferNote').value = '';
    $('#intisReceipt').style.display = 'none';
    $('#walletPerformTransfer').disabled = false; // Habilitar botón

    // Lógica para mostrar/ocultar pestañas (se hace con listener)
    lucide.createIcons();
}
function addWalletLegacyTransaction() {
    if (!incrementGuestAction()) return; // Verifica invitado
    const monto = parseFloat($('#wMonto').value);
    if (isNaN(monto) || monto <= 0) return showToast('Ingresa un monto válido.', 'warn');
    const newMov = {
        fecha: new Date().toISOString(),
        tipo: $('#wTipo').value,
        monto: monto,
        cat: $('#wCat').value.trim() || 'General',
        nota: $('#wNota').value.trim()
    };

    if (!S.wallet.legacyMovs) S.wallet.legacyMovs = [];
    S.wallet.legacyMovs.push(newMov);
    addIntis(INTIS_REWARDS.addFinanceLegacy, 'Movimiento en billetera ($)'); // Recompensa pequeña
    save(); renderWallet(); syncHeader(); // Actualiza header
    $('#wMonto').value = ''; $('#wCat').value = ''; $('#wNota').value = '';
}
function performIntisTransfer() {
    if (S.ui.isGuest) { handleGuestLoginRedirect(); return; } // No permitido para invitados
    if (!incrementGuestAction()) return; // Doble chequeo

    const recipientId = $('#walletTransferUserID').value.trim();
    const amountInput = $('#walletTransferAmount');
    const amount = parseInt(amountInput.value);
    const note = $('#walletTransferNote').value.trim();
    const currentUser = S.userProfile.userId;

    if (!recipientId || isNaN(amount) || amount <= 0) {
        showToast("ID de usuario y monto válido son requeridos.", "warn");
        return;
    }
    if (amount > S.wallet.intis) {
        showToast("Fondos insuficientes.", "warn");
        return;
    }
    // Simple validación de ID (podría ser más robusta)
    if (recipientId === currentUser) {
         showToast("No puedes transferirte a ti mismo.", "warn");
         return;
    }
    // Aquí iría la lógica para verificar si el recipientId existe en la DB (Supabase/Firebase)
    console.log(`Verificando existencia de usuario ${recipientId}... (Simulado)`);
    const recipientExists = true; // Simulación: asumir que existe

    if (!recipientExists) {
         showToast("El ID de usuario de destino no existe.", "warn");
         return;
    }

    // --- Ejecutar Transferencia (Simulada Localmente) ---
    // 1. Restar del emisor
    S.wallet.intis -= amount;

    // 2. Registrar transacción de salida
    const transactionOut = {
        id: 'txOut' + Date.now(),
        type: 'transfer_out',
        amount: amount,
        recipient: recipientId,
        note: note,
        date: new Date().toISOString()
    };
    if (!S.wallet.transactions) S.wallet.transactions = [];
    S.wallet.transactions.push(transactionOut);

    // 3. Simular suma al receptor (en una app real, esto lo haría el backend/DB)
    console.log(`Simulando envío de ${amount} Intis a ${recipientId}...`);

    addIntis(INTIS_REWARDS.transferIntis, 'Transferencia Intis'); // Pequeña recompensa
    save();
    renderWallet(); // Actualiza UI de billetera
    showToast(`Transferencia de ${amount} Intis a ${recipientId} realizada con éxito.`, "success");

    // Mostrar recibo
    showIntisReceipt(transactionOut);

    // Deshabilitar botón temporalmente para evitar doble envío
    $('#walletPerformTransfer').disabled = true;
    setTimeout(() => { $('#walletPerformTransfer').disabled = false; }, 2000); // Rehabilitar después de 2 seg
}
/**
 * Muestra el recibo de transferencia Intis.
 * @param {object} transaction - El objeto de la transacción realizada.
 */
function showIntisReceipt(transaction) {
    const receiptContent = $('#intisReceiptContent');
    const receiptContainer = $('#intisReceipt');
    if (!receiptContent || !receiptContainer) return;

    const receipt = `
  ==================================
        RECIBO DE TRANSFERENCIA
  ==================================
  ID Transacción: ${transaction.id}
  Fecha:          ${fmtDate(transaction.date, 'receipt')}
  ----------------------------------
  De:             ${S.userProfile.userId || 'Tu Usuario'}
  Para:           ${transaction.recipient}
  Monto:          ${transaction.amount} Intis ✨
  Nota:           ${transaction.note || '---'}
  ----------------------------------
  Estado:         COMPLETADO
  ==================================
    `;
    receiptContent.textContent = receipt;
    receiptContainer.style.display = 'block';

    // Scroll hacia el recibo si es necesario
    receiptContainer.scrollIntoView({ behavior: 'smooth' });
}

// --- 6.8: AJUSTES (PRO y Gestión de Datos) ---
function renderSettings() {
    // Lógica para mostrar estado actual PRO (si lo es)
    const proPlanCard = $('#settings .pro-plan');
    const freePlanCard = $('#settings .plan-card:not(.pro-plan)');
    const upgradeButton = proPlanCard.querySelector('.btn-primary');

    if (S.userProfile.isPro) {
        proPlanCard.querySelector('h3').textContent = "Paquete PRO (Activo)";
        upgradeButton.textContent = "Gestionar Suscripción";
        upgradeButton.onclick = () => { /* Aquí iría lógica para portal de Stripe/Paddle */ showToast("Ir a gestión de suscripción (pendiente)", "info"); };
        freePlanCard.querySelector('button').style.display = 'none'; // Ocultar botón 'Tu Plan Actual'
    } else {
        proPlanCard.querySelector('h3').textContent = "Paquete PRO";
        upgradeButton.textContent = "Subir a PRO";
        upgradeButton.onclick = () => { /* Aquí iría lógica de pago */ showToast("Ir a checkout PRO (pendiente)", "info"); };
        freePlanCard.querySelector('button').style.display = 'block'; // Mostrar botón 'Tu Plan Actual'
    }

    // Actualizar iconos de check/x basados en estado PRO
    proPlanCard.querySelectorAll('ul li i').forEach(icon => icon.dataset.lucide = 'check');
    freePlanCard.querySelectorAll('ul li.limited i').forEach(icon => icon.dataset.lucide = 'check');
    freePlanCard.querySelectorAll('ul li.excluded i').forEach(icon => icon.dataset.lucide = 'x');

    lucide.createIcons();
}

/* ============================================================================
SECCIÓN 7: ONBOARDING (Plantillas e Invitado)
============================================================================
*/
const industryTemplates = {
    agency: { /* ... (definido antes) ... */ },
    ecommerce: { /* ... (definido antes) ... */ },
    creator: { /* ... (definido antes) ... */ }
    // generic no necesita plantilla específica, usa el estado inicial vacío
};
function loadIndustryTemplate(industry) {
    if (!incrementGuestAction()) return; // Verifica invitado
    const template = industryTemplates[industry] || {}; // Usa {} para 'generic'

    // Resetear estado principal a valores iniciales + plantilla
    S = {
        ...JSON.parse(JSON.stringify(initialState)), // Copia profunda de initialState
        version: initialState.version, // Asegura versión correcta
        userProfile: { ...S.userProfile, industry: industry }, // Mantiene perfil actual pero actualiza industria
        projects: JSON.parse(JSON.stringify(template.projects || [])),
        folders: JSON.parse(JSON.stringify(template.folders || {})),
        tasks: JSON.parse(JSON.stringify(template.tasks || {})),
        notes: JSON.parse(JSON.stringify(template.notes || {})),
        chats: {}, // Resetear chats
        tables: {}, // Resetear tablas
        files: {}, // Resetear files
        fin: {}, // Resetear finanzas proyecto
        cronopost: { posts: {}, ideas: JSON.parse(JSON.stringify(template.cronopost?.ideas || {})) }, // Mantener ideas de plantilla
        // Mantener hub, gchat, wallet, aiGlobalChat, ui del estado actual S
        hub: S.hub,
        gchat: S.gchat,
        wallet: S.wallet,
        aiGlobalChat: S.aiGlobalChat,
        ui: S.ui,
    };

    // Asegurar estructura interna para proyectos de la plantilla
    S.projects.forEach(p => {
        const id = p.id;
        if (!p.taskColumns) p.taskColumns = ['Backlog','En curso','Bloqueado','Hecho'];
        if (!S.folders[id]) S.folders[id] = ['General'];
        if (!S.tasks[id]) S.tasks[id] = { 'General': [] };
         Object.values(S.tasks[id] || {}).forEach(folderTasks => {
              folderTasks.forEach(task => { if (!task.tags) task.tags = []; });
         });
        // Asegurar carpetas en estructura tasks
        (S.folders[id] || []).forEach(f => { if (!S.tasks[id][f]) S.tasks[id][f] = []; });
        if (!S.notes[id]) S.notes[id] = {list:[], active:null, bodies:{}, drawings:{}};
        if (!S.chats[id]) S.chats[id] = {threads:[], messages:{}, activeThread: null, model: 'pro'};
        if (!S.tables[id]) S.tables[id] = {list:[{id: 'tbl_default', name: 'Tabla 1'}], active: 'tbl_default', data: {'tbl_default': {cols:['Col 1'], rows:[]}}};
        if (!S.files[id]) S.files[id] = [];
        if (!S.fin[id]) S.fin[id] = {rows:[]};
        if (!S.cronopost.posts[id]) S.cronopost.posts[id] = {};
        if (!S.cronopost.ideas[id]) S.cronopost.ideas[id] = [];
        S.ui.projectCollapsedState[id] = false;
    });


    addIntis(INTIS_REWARDS.loadIndustry, `Plantilla ${industry}`);
    save();
    showToast(`Espacio de trabajo para ${industry} listo.`, 'success');

    // Navegar después de cargar
    if(S.projects.length > 0) {
        history.pushState({view: `project/${S.projects[0].id}`}, '', `#!project/${S.projects[0].id}`);
        openProject(S.projects[0].id);
    } else {
        // Si la plantilla no tiene proyectos (ej: generic), ir a IA
        history.pushState({view: 'ai-global-chat'}, '', `#!ai-global-chat`);
        show('ai-global-chat');
    }
    renderAside();
}

/**
 * Inicia la sesión como invitado.
 */
function startAsGuest() {
    S = JSON.parse(JSON.stringify(initialState)); // Carga estado inicial limpio
    S.ui.isGuest = true;
    S.ui.guestActionsCount = 0;
    S.hub.perfil.nombre = 'Invitado'; // Perfil de invitado
    S.hub.perfil.id = 'guest_user';
    save(); // Guarda el estado de invitado
    $('#loginScreen').style.display = 'none'; // Oculta pantalla de login
    $('#appContent').style.display = 'block'; // Muestra contenido de la app
    // Forzar renderizado inicial después de login/guest
    handleNav();
    renderAside();
    showToast("Explorando como invitado. Funciones limitadas.", "info");
}

/**
 * Simula el inicio de sesión (reemplazar con lógica real de Auth).
 */
function simulateLogin() {
    // 1. Cargar estado del usuario si existe, sino, estado inicial
    let rawUserState = localStorage.getItem('goatify_user_state_v10');
    S = rawUserState ? JSON.parse(rawUserState) : JSON.parse(JSON.stringify(initialState));

    // 2. Marcar como NO invitado
    S.ui.isGuest = false;
    S.ui.guestActionsCount = 0; // Resetear contador invitado

    // 3. Simular datos de usuario (reemplazar con datos reales de Auth)
    S.userProfile.userId = 'user_' + Date.now(); // ID único simulado
    S.userProfile.firstName = 'Usuario';
    S.userProfile.lastName = 'Goatify';
    S.userProfile.isPro = false; // Asumir no PRO al loguear (podría venir de DB)
    S.hub.perfil.id = S.userProfile.userId;
    S.hub.perfil.nombre = S.userProfile.firstName;
    S.hub.perfil.apellido = S.userProfile.lastName;

    // 4. Guardar estado de usuario
    save();

    // 5. Ocultar login, mostrar app
    $('#loginScreen').style.display = 'none';
    $('#appContent').style.display = 'block';

    // 6. Forzar renderizado inicial
    handleNav();
    renderAside();
    showToast(`¡Bienvenido, ${S.userProfile.firstName}!`, "success");
    addIntis(INTIS_REWARDS.login, 'Inicio de sesión'); // Recompensa por login
}

/* ============================================================================
SECCIÓN 8: BÚSQUEDA GLOBAL
============================================================================
*/
function performSearch() {
    if (!incrementGuestAction()) return; // Verifica invitado
    const query = $('#q').value.toLowerCase().trim();
    if (!query) return;
    const results = [];
    const queryWords = query.split(' ').filter(w => w);

    const isMatch = (text) => {
        if (!text) return false;
        const lowerText = text.toLowerCase();
        return queryWords.every(word => lowerText.includes(word));
    };

    // Buscar en Proyectos
    S.projects.forEach(p => {
        if (isMatch(p.name)) {
            results.push({
                type: 'Proyecto', name: p.name, context: 'Nombre del proyecto',
                action: () => {
                    history.pushState({view: `project/${p.id}`}, '', `#!project/${p.id}`);
                    openProject(p.id);
                    $('#searchModal').close(); $('#q').value = ''; // Limpiar búsqueda
                }
            });
        }
        // Buscar en Tareas dentro del proyecto
        Object.entries(S.tasks[p.id] || {}).forEach(([folderName, tasksInFolder]) => {
            (tasksInFolder || []).forEach(t => {
                if (isMatch(t.title) || isMatch(t.desc) || (t.tags && t.tags.some(tag => isMatch(tag)))) {
                    results.push({
                        type: 'Tarea', name: t.title, context: `Proyecto: ${p.name} (Carpeta: ${folderName})`,
                        action: () => {
                            history.pushState({view: `project/${p.id}/folder/${folderName}`}, '', `#!project/${p.id}/folder/${encodeURIComponent(folderName)}`);
                            openProject(p.id, folderName);
                            setTimeout(() => openTaskModal(t.id), 150); // Dar tiempo a renderizar
                            $('#searchModal').close(); $('#q').value = '';
                        }
                    });
                }
            });
        });
        // Buscar en Notas
        (S.notes[p.id]?.list || []).forEach(n => {
            if (isMatch(n.title) || isMatch(S.notes[p.id].bodies[n.id])) {
                results.push({
                    type: 'Nota', name: n.title, context: `Proyecto: ${p.name}`,
                    action: () => {
                        history.pushState({view: `project/${p.id}`}, '', `#!project/${p.id}`);
                        openProject(p.id);
                        S.notes[p.id].active = n.id;
                        save();
                        setTimeout(() => {
                            $('#project-tabs .tab[data-ptab="notes"]').click();
                            renderNotes(); // Asegura que la nota correcta se muestre
                        }, 100);
                        $('#searchModal').close(); $('#q').value = '';
                    }
                });
            }
        });
        // Buscar en Tablas (nombres y contenido básico)
        (S.tables[p.id]?.list || []).forEach(tblInfo => {
             if (isMatch(tblInfo.name)) {
                  results.push({
                      type: 'Tabla', name: tblInfo.name, context: `Proyecto: ${p.name}`,
                      action: () => {
                          history.pushState({view: `project/${p.id}`}, '', `#!project/${p.id}`);
                          openProject(p.id);
                          S.tables[p.id].active = tblInfo.id;
                          save();
                          setTimeout(() => {
                              $('#project-tabs .tab[data-ptab="tables"]').click();
                              renderTables();
                          }, 100);
                          $('#searchModal').close(); $('#q').value = '';
                      }
                  });
             }
             // Opcional: buscar en contenido de tablas (puede ser lento)
             /*
             const tableData = S.tables[p.id]?.data[tblInfo.id];
             if (tableData && tableData.rows) {
                 // ... lógica para buscar en celdas ...
             }
             */
        });
         // Buscar en Archivos
        (S.files[p.id] || []).forEach(f => {
             if (isMatch(f.name)) {
                  results.push({
                      type: 'Archivo', name: f.name, context: `Proyecto: ${p.name}`,
                      action: () => {
                          history.pushState({view: `project/${p.id}`}, '', `#!project/${p.id}`);
                          openProject(p.id);
                          setTimeout(() => {
                              $('#project-tabs .tab[data-ptab="files"]').click();
                          }, 100);
                          $('#searchModal').close(); $('#q').value = '';
                          // Opcional: intentar scroll/highlight al archivo?
                      }
                  });
             }
        });

    }); // Fin loop proyectos

    // Buscar en Chats Globales (Títulos y Mensajes - puede ser lento)
    (S.aiGlobalChat?.threads || []).forEach(th => {
         if (isMatch(th.title)) {
              results.push({
                  type: 'Chat IA', name: th.title, context: 'Chat Global',
                  action: () => {
                      history.pushState({view: 'ai-global-chat'}, '', `#!ai-global-chat`);
                      S.aiGlobalChat.activeThread = th.id;
                      show('ai-global-chat'); // Renderizará el chat correcto
                      $('#searchModal').close(); $('#q').value = '';
                  }
              });
         }
         // Opcional: Buscar en mensajes del chat global
         /*
         (S.aiGlobalChat.messages[th.id] || []).forEach(m => {
             if (isMatch(m.text)) { ... }
         });
         */
    });


    const resultsEl = $('#searchResults'); resultsEl.innerHTML = '';
    if (results.length === 0) {
        resultsEl.innerHTML = `<div class="empty-state">No se encontraron resultados para "${query}"</div>`;
    } else {
        results.forEach(r => {
            const resultCard = el('div', { class: 'card', style: 'margin-bottom: 10px; cursor: pointer; background: var(--surface);'},
                el('div', {class:'row'},
                    el('b', {textContent: r.name}),
                    el('span', {class: 'spacer'}),
                    el('span', {class: 'chip', textContent: r.type})
                ),
                el('p', {class: 'sub', textContent: r.context, style: 'margin: 4px 0 0; font-size: var(--sm)'})
            );
            resultCard.onclick = r.action; // Acción definida al crear el resultado
            resultsEl.append(resultCard);
        });
    }
    $('#searchModal').showModal();
    lucide.createIcons();
}


/* ============================================================================
SECCIÓN 9: TOUR GUIADO
============================================================================
*/
let currentTourStep = 0;
const tourSteps = [
    { el: '#menuBtn', title: 'Menú Principal', text: 'Expande/contrae la barra lateral.'},
    { el: 'aside .aside-middle-section', title: 'Tus Proyectos', text: 'Gestiona tus proyectos y carpetas aquí.'},
    { el: '.pinned-nav-item .navBtn', title: 'Asistente IA Global', text: 'Accede rápidamente a tu chat de IA principal.'},
    { el: '#nav-list', title: 'Módulos Globales', text: 'Herramientas como Calendario General, Hub, Chat Global, Monetización y Ajustes.'},
    { el: '#projectShell .tabs', title: 'Pestañas de Proyecto', text: 'Navega por las herramientas específicas de cada proyecto.'},
    { el: '#folderSel', title: 'Selector de Carpetas', text: 'Filtra las tareas por carpeta dentro de un proyecto.'},
    { el: '#quickAdd', title: 'Añadir Rápido', text: 'Crea tareas, notas, etc., según la pestaña activa.'},
    { el: '#intisChip', title: 'Billetera Intis', text: 'Consulta tu balance de Intis y realiza transferencias.'},
    { el: '#settings', title: 'Ajustes y PRO', text: 'Gestiona tu suscripción y accede a los beneficios PRO.'},
];
function showTourStep(index) {
    if (index >= tourSteps.length) { endTour(); return; }
    currentTourStep = index;
    const step = tourSteps[index];
    let targetEl = $(step.el);

    // Lógica especial para mostrar #settings si no está visible
    if (step.el === '#settings' && (!targetEl || targetEl.style.display === 'none')) {
        history.pushState({view: 'settings'}, '', `#!settings`);
        show('settings');
        // Esperar un poco para que se renderice antes de buscar de nuevo
        setTimeout(() => {
            targetEl = $(step.el);
            if (!targetEl) { console.warn("Tour step element still not found:", step.el); endTour(); return; }
            proceedWithTourStep(step, targetEl, index);
        }, 300);
    }
    // Lógica especial para expandir el aside si está colapsado y el target está dentro
    else if (targetEl && targetEl.closest('aside') && document.body.classList.contains('aside-collapsed')) {
         document.body.classList.remove('aside-collapsed'); // Expandir
         S.ui.asideCollapsed = false; save(); renderAside(); // Guardar estado
         // Esperar a la transición
         setTimeout(() => {
             proceedWithTourStep(step, targetEl, index);
         }, 300);
    }
    else if (!targetEl) {
        console.warn("Tour step element not found:", step.el);
        showTourStep(index + 1); // Saltar al siguiente paso si no se encuentra
        return;
    } else {
        proceedWithTourStep(step, targetEl, index);
    }
}
function proceedWithTourStep(step, targetEl, index) {
    const tooltip = $('#tour-tooltip');
    $('#tour-overlay').style.display = 'block';
    tooltip.style.display = 'block';

    $('#tour-title').textContent = step.title;
    $('#tour-text').textContent = step.text;
    $('#tour-step').textContent = `${index + 1} / ${tourSteps.length}`;
    $('#tour-prev').disabled = index === 0;
    $('#tour-next').textContent = index === tourSteps.length - 1 ? 'Finalizar' : 'Siguiente';

    targetEl.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });

    // Pequeño delay para asegurar que scrollIntoView termine
    setTimeout(() => {
        const rect = targetEl.getBoundingClientRect();
        let top = rect.bottom + 10;
        let left = rect.left;

        // Ajustar posición si se sale de la pantalla
        tooltip.style.top = `${top}px`;
        tooltip.style.left = `${left}px`;

        const tooltipRect = tooltip.getBoundingClientRect();
        // Evitar que se salga por la derecha
        if (tooltipRect.right > window.innerWidth - 10) {
            left = window.innerWidth - tooltipRect.width - 10;
        }
        // Evitar que se salga por abajo (intentar poner arriba)
        if (tooltipRect.bottom > window.innerHeight - 10) {
            top = rect.top - tooltipRect.height - 10;
        }
        // Evitar que se salga por arriba
        if (top < 10) {
            top = 10;
        }
        // Evitar que se salga por la izquierda
        if (left < 10) {
            left = 10;
        }

        tooltip.style.top = `${top}px`;
        tooltip.style.left = `${left}px`;

    }, 300);
}
function endTour() {
    $('#tour-overlay').style.display = 'none';
    $('#tour-tooltip').style.display = 'none';
}

/* ============================================================================
SECCIÓN 10: INICIALIZACIÓN Y EVENT LISTENERS GLOBALES
============================================================================
*/

/**
 * Manejador de navegación basado en Hash.
 */
function handleNav() {
    // Si es invitado y superó límite, no navegar, mostrar modal
    if (S.ui.isGuest && S.ui.guestActionsCount > 10) {
        showLimitModal('guest');
        // Opcional: ¿redirigir a #login o mantener vista actual?
        // history.replaceState(null, '', '#!'); // Limpiar hash
        return;
    }

    const hash = window.location.hash.replace('#!', '');
    if (hash.startsWith('project/')) {
        const parts = hash.split('/');
        const projId = parts[1];
        const folderName = parts[3] ? decodeURIComponent(parts[3]) : 'General';

        if (S.projects.find(p => p.id === projId)) {
            openProject(projId, folderName);
        } else {
            console.warn('Project not found from hash, redirecting.');
            const defaultView = S.projects.length > 0 ? `project/${S.projects[0].id}` : 'ai-global-chat';
            history.replaceState({view: defaultView}, '', `#!${defaultView}`);
            handleNav(); // Llamar de nuevo para cargar la vista por defecto
        }
    } else if (hash && $(`[data-nav="${hash}"]`)) {
        show(hash);
    } else {
        // Vista por defecto: primer proyecto o IA global
        const defaultView = S.projects.length > 0 ? `project/${S.projects[0].id}` : 'ai-global-chat';
        // Solo redirige si el hash actual NO es ya la vista por defecto correcta
        if (window.location.hash !== `#!${defaultView}`) {
            history.replaceState({view: defaultView}, '', `#!${defaultView}`);
            handleNav(); // Llamar de nuevo para cargarla
        } else {
             // Si ya estamos en la vista por defecto correcta, solo asegúrate de mostrarla
             if (defaultView.startsWith('project/')) {
                 openProject(S.projects[0].id);
             } else {
                 show(defaultView);
             }
        }
    }
}


// Deteniéndose aquí como solicitado.
// El resto del código incluirá la función init(), los listeners finales y el cierre del script y HTML.

</script>

/**
 * Función de inicialización principal.
 */
function init(){
  // Intenta cargar el estado (usuario o invitado)
  load();

  // Si después de cargar sigue siendo invitado Y NO hay pantalla de login visible (p.ej. refresh)
  // O si NO es invitado pero NO hay userId (estado inválido), muestra pantalla de login.
  // Excepto si explícitamente se pide entrar como invitado via URL hash #!guest (para desarrollo)
  if (window.location.hash !== '#!guest' && ((S.ui.isGuest && !$('#loginScreen')) || (!S.ui.isGuest && !S.userProfile.userId))) {
      // Renderiza pantalla de login si no existe
      if (!$('#loginScreen')) {
          const loginScreen = el('div', {id: 'loginScreen', style: 'position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px;'},
              el('div', {class: 'card', style: 'background: var(--surface); max-width: 400px; padding: 40px;'},
                  el('img', {src: 'Logos HD.png', alt: 'Goatify Logo', style: 'height: 60px; margin-bottom: 20px;'}),
                  el('h2', {textContent: 'Bienvenido a Goatify IA'}),
                  el('p', {class: 'sub', textContent: 'Tu súper app para gestionar proyectos, colaborar y monetizar con IA.'}),
                  el('button', {id: 'loginBtn', class: 'btn btn-primary', style: 'width: 100%; margin-top: 20px; padding: 12px;'}, 'Iniciar Sesión / Registrarse'),
                  el('button', {id: 'guestBtn', class: 'btn', style: 'width: 100%; margin-top: 10px;'}, 'Entrar como Invitado')
              )
          );
          document.body.appendChild(loginScreen);
          // Ocultar contenido principal
          if (!$('#appContent')) {
              const appContent = el('div', {id: 'appContent'}, $('header.app'), $('.container'));
              document.body.appendChild(appContent);
          }
          $('#appContent').style.display = 'none';

          // Asignar listeners a los botones de login
          $('#loginBtn').onclick = simulateLogin; // Reemplazar con lógica real
          $('#guestBtn').onclick = startAsGuest;
      }
      // Asegurarse de que esté visible
      $('#loginScreen').style.display = 'flex';
      $('#appContent').style.display = 'none';

  } else {
       // Si ya está logueado o es invitado válido (o entró con #!guest), muestra la app
       if ($('#loginScreen')) $('#loginScreen').style.display = 'none';
       if (!$('#appContent')) { // Asegurar que appContent exista
            const appContent = el('div', {id: 'appContent'}, $('header.app'), $('.container'));
            document.body.appendChild(appContent);
       }
       $('#appContent').style.display = 'block';

       // Continuar con la inicialización normal de la app
       lucide.createIcons();
       setupListeners(); // Configurar todos los listeners
       handleNav(); // Navegar a la vista correcta
       renderAside();
       updateUILimits(); // Aplicar restricciones visuales
       if (S.ui.isGuest) {
            showToast("Explorando como invitado. Funciones limitadas.", "info");
       }
  }
}

/**
 * Configura TODOS los event listeners de la aplicación.
 */
function setupListeners() {
    // --- Listeners Generales ---
    $('#loadIndustryBtn').onclick = () => { const industry = $('#industrySelect').value; loadIndustryTemplate(industry); $('#industryModal').close(); };
    $('#newProject').onclick = createNewProject;
    $('#q').addEventListener('keydown', e => { if (e.key === 'Enter') performSearch(); });
    $('#menuBtn').onclick=()=>{
        // No necesita check de invitado aquí, es solo UI
        const bodyClassList = document.body.classList;
        if (window.innerWidth <= 1180) { // Comportamiento Overlay en móvil/tablet
            bodyClassList.toggle('aside-open');
        } else { // Comportamiento Colapso en desktop
            S.ui.asideCollapsed = !S.ui.asideCollapsed;
            bodyClassList.toggle('aside-collapsed', S.ui.asideCollapsed);
            save();
            renderAside(); // Re-renderizar aside para tooltips
        }
    };
    $('#menu-overlay').onclick = () => document.body.classList.remove('aside-open');
    $('#walletChip').onclick = () => { if (!incrementGuestAction()) return; renderWallet(); $('#walletModal').showModal(); };
    $('#intisChip').onclick = () => { if (!incrementGuestAction()) return; $('#intisModal').showModal(); renderIntisRules(); lucide.createIcons(); }; // Abre modal reglas Intis
    $('#wAdd').onclick = addWalletLegacyTransaction; // Botón legacy $
    $('#resetApp').onclick=()=>{ if (!incrementGuestAction()) return; showInputModal('Confirmar Eliminación Total', `IRREVERSIBLE. Escribe "BORRAR TODO".`, 'BORRAR TODO', (confirmText) => { if(confirmText === 'BORRAR TODO') { localStorage.clear(); window.location.reload(); } })};
    $('#tourBtn').onclick = () => { if (!incrementGuestAction()) return; showTourStep(0); };
    $('#tour-next').onclick = () => showTourStep(currentTourStep + 1);
    $('#tour-prev').onclick = () => showTourStep(currentTourStep - 1);
    $('#tour-overlay').onclick = endTour; // Cerrar tour al hacer click fuera

    // --- Listeners Header Móvil ---
    setupHeaderActions(); // Configura botones desktop/móvil

    // --- Listeners Navegación y Popstate ---
    // Listener para navegación global en aside (incluye IA fijado)
    $('aside').addEventListener('click', (e) => {
      const link = e.target.closest('a.navBtn[data-nav]'); // Solo links de NAV GLOBAL
      if (link) {
          e.preventDefault();
          const view = link.dataset.nav;
          history.pushState({view}, '', `#!${view}`);
          show(view); // show() ya tiene check de invitado
      }
      // Click en logo o marca para ir a la vista por defecto
      const brandLink = e.target.closest('.brand');
      if (brandLink && !e.target.closest('input')) { // Evitar si se clickea en input de búsqueda
            e.preventDefault();
            const defaultView = S.projects.length > 0 ? `project/${S.projects[0].id}` : 'ai-global-chat';
            history.pushState({view: defaultView}, '', `#!${defaultView}`);
            handleNav();
      }
    });
    // Listener para popstate (navegación historial)
    window.addEventListener('popstate', (e) => {
        // Ignorar popstate si es invitado y superó límite
        if (S.ui.isGuest && S.ui.guestActionsCount > 10) return;

        if (e.state && e.state.view) {
             const view = e.state.view;
             if (view.startsWith('project/')) {
                const parts = view.split('/');
                const projId = parts[1];
                const folderName = parts[3] ? decodeURIComponent(parts[3]) : 'General';
                // Asegurarse que el proyecto exista antes de abrir
                if (S.projects.find(p => p.id === projId)) {
                    openProject(projId, folderName);
                } else { handleNav(); } // Ir a default si no existe
             } else if ($(`[data-nav="${view}"]`)) { // Validar que la vista global exista
                show(view);
             } else { handleNav(); } // Ir a default si no existe
        } else {
            handleNav(); // Cargar vista desde hash si no hay state
        }
    });
    // Listener para links internos (ej: Mindset -> Chat Global)
    document.body.addEventListener('click', e => {
        const link = e.target.closest('a.nav-link-btn');
        if (link && link.hash) {
            e.preventDefault();
            const view = link.hash.replace('#!', '');
            if($(`[data-nav="${view}"]`)){
                history.pushState({view}, '', `#!${view}`);
                show(view); // show() ya tiene check de invitado
            }
        }
    });

    // --- Listeners Pestañas y Quick Add ---
    wireTabs('#projectShell', 'ptab', 'p-tab'); // Conecta pestañas de proyecto

    // --- Listeners Proyecto ---
    $('#addColumnBtn').onclick = addColumn;
    $('#addFolder').onclick = addFolder;
    $('#taskTagFilter').addEventListener('input', renderTasks);
    // Calendario Proyecto
    $('#prevM').onclick=()=>{ if (!incrementGuestAction()) return; calRef.setMonth(calRef.getMonth()-1); renderCalendar();};
    $('#nextM').onclick=()=>{ if (!incrementGuestAction()) return; calRef.setMonth(calRef.getMonth()+1); renderCalendar();};
    // Notas
    $('#newNoteBtn').onclick = createNewNote;
    $$('#p-tab-notes [data-cmd]').forEach(btn=>btn.onclick=()=>{ if (!incrementGuestAction()) return; document.execCommand(btn.dataset.cmd, false, btn.dataset.value || null); }); // Verifica invitado
    $('#clearCanvasBtn').onclick=()=>{ if (!incrementGuestAction()) return; const id=S.activeProject; if(!id||!S.notes[id]?.active)return; delete S.notes[id].drawings[S.notes[id].active]; save(); initDrawingCanvas(S.notes[id].active); };
    $('#exportNotePDF').onclick = () => exportNote('pdf');
    // Archivos
    $('#fileInput').onchange=(e)=>{
        if (!incrementGuestAction()) { e.target.value = null; return; } // Verifica invitado
        const id=S.activeProject; if(!id) return;
        if (!S.files[id]) S.files[id] = [];
        const files = Array.from(e.target.files); // Convertir a Array
        let filesAdded = 0;
        files.forEach(f => {
            // Podríamos añadir límite de archivos aquí
            S.files[id].push({name:f.name, type: f.type, size:f.size, url:URL.createObjectURL(f)});
            filesAdded++;
        });
        if (filesAdded > 0) addIntis(INTIS_REWARDS.uploadFile * filesAdded, 'Archivo(s) subido(s)');
        save(); renderFiles(); renderOverview();
        e.target.value = null; // Limpiar input para permitir subir mismo archivo
    };
    // Chat IA Proyecto
    $('#newChat').onclick=()=>{ if (!incrementGuestAction()) return; const id=S.activeProject; if(!id)return; if(!S.chats[id]) S.chats[id] = { threads: [], messages: {}, activeThread: null, model: 'pro' }; showInputModal('Nueva Conversación', 'Título:', 'Ej: Ideas blog', t => { const newId = 'c'+Date.now(); S.chats[id].threads.push({id:newId, title:t}); S.chats[id].activeThread = newId; if(!S.chats[id].messages) S.chats[id].messages={}; S.chats[id].messages[newId] = []; save(); renderProjectChat();})};
    $$('#p-chat-grid .model-card:not(.disabled)').forEach(card => card.onclick=()=>{ if (!incrementGuestAction()) return; const id=S.activeProject; if(!id || !S.chats[id])return; if(card.dataset.model === 'x' && !S.userProfile.isPro) { showLimitModal('goatifyX'); return; } S.chats[id].model=card.dataset.model; save(); renderProjectChat(); });
    $('#sendMsg').onclick = sendProjectChatMessage; // Ya tiene check invitado dentro
    $('#chatMsg').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendProjectChatMessage(); }});
    $('#p_attachFileBtn').onclick = () => { if (!incrementGuestAction()) return; $('#p_chatFileInput').click(); }; // Verifica invitado
    $('#chatToTasks').onclick=()=>{ if (!incrementGuestAction()) return; /* ... resto de la lógica ... */ }; // Verifica invitado
    // Tablas
    $('#newTableBtn').onclick = createNewTable;
    $('#tableSelector').onchange = (e) => { if (!incrementGuestAction()) { e.target.value = S.tables[S.activeProject]?.active; return; } const projId = S.activeProject; if (!projId || !S.tables[projId]) return; S.tables[projId].active = e.target.value; save(); renderTables(); };
    $('#addCol').onclick=()=>{ if (!incrementGuestAction()) return; const id=S.activeProject; if(!id || !S.tables[id]) return; const activeTableId = S.tables[id].active; if (!activeTableId) return; const T=S.tables[id].data[activeTableId]; showInputModal('Nueva Columna', 'Nombre:', `Col ${T.cols.length + 1}`, name => { if (!T.cols) T.cols = []; T.cols.push(name); if (!T.rows) T.rows = []; T.rows.forEach(r=>r.push('')); save(); renderTables(); })};
    $('#addRow').onclick=()=>{ if (!incrementGuestAction()) return; const id=S.activeProject; if(!id || !S.tables[id]) return; const activeTableId = S.tables[id].active; if (!activeTableId) return; const T=S.tables[id].data[activeTableId]; if (!T.cols) T.cols = ['Col 1']; if (!T.rows) T.rows = []; T.rows.push(new Array(T.cols.length).fill('')); save(); renderTables();};
    $('#exportCSV').onclick=()=>{ if (!incrementGuestAction()) return; const id=S.activeProject; if(!id || !S.tables[id]) return; const activeTableId = S.tables[id].active; if (!activeTableId) return; const T=S.tables[id].data[activeTableId]; const tableName = S.tables[id].list.find(t => t.id === activeTableId)?.name || 'tabla'; download(`${tableName}.csv`, csv([T.cols, ...T.rows]));};
    // Finanzas Proyecto (Legacy $)
    $('#finNew').onclick=()=>{ if (!incrementGuestAction()) return; $('#projectFinModal').showModal(); };
    $('#pF_Confirm').onclick = addProjectFinanceMove;
    $('#finExport').onclick=()=>{ if (!incrementGuestAction()) return; /* ... resto de la lógica ... */ };
    // Vistas Tareas
    $('#viewToggleBoard').onclick = () => { if (!incrementGuestAction()) return; S.ui.taskView = 'board'; save(); renderTasks(); };
    $('#viewToggleList').onclick = () => { if (!incrementGuestAction()) return; S.ui.taskView = 'list'; save(); renderTasks(); };
    // Modal Tareas
    $('#taskDetailSaveBtn').onclick = saveTaskDetails; // Ya tiene check invitado dentro
    $('#taskDetailDeleteBtn').onclick = () => deleteTask($('#taskDetailId').value); // Ya tiene check invitado dentro

    // --- Listeners Módulos Globales ---
    // Cronopost
    $('#cpProjectSelect').onchange = () => { if (!incrementGuestAction()) return; renderCronoPOST(); }; // Verifica invitado al cambiar proyecto
    $('#cpPrevM').onclick = () => { if (!incrementGuestAction()) return; cpRef.setMonth(cpRef.getMonth() - 1); renderCronoPOST(); };
    $('#cpNextM').onclick = () => { if (!incrementGuestAction()) return; cpRef.setMonth(cpRef.getMonth() + 1); renderCronoPOST(); };
    $('#cpAddIdeaBtn').onclick = () => {
        if (!incrementGuestAction()) return; // Verifica invitado
        // Podríamos añadir límite de ideas aquí
        const activeProjectId = $('#cpProjectSelect').value;
        if (!activeProjectId || activeProjectId === 'all') { showToast('Selecciona un proyecto específico.', 'warn'); return; }
        const title = $('#cpNewIdeaInput').value.trim(); if (!title) return;
        if(!S.cronopost.ideas[activeProjectId]) S.cronopost.ideas[activeProjectId] = [];
        S.cronopost.ideas[activeProjectId].push({ id: 'i' + Date.now(), title });
        addIntis(INTIS_REWARDS.createIdea, 'Idea de contenido');
        save(); renderCronoPOST(); $('#cpNewIdeaInput').value = '';
    };
    $('#cpGenAIIdeas').onclick = async () => { // Hacer async
        if (!incrementGuestAction()) return; // Verifica invitado
        const activeProjectId = $('#cpProjectSelect').value;
        if (!activeProjectId || activeProjectId === 'all') { showToast('Selecciona un proyecto para generar ideas.', 'warn'); return; }

        // Usar callGeminiAPI
        const projName = S.projects.find(p=>p.id===activeProjectId)?.name || 'este proyecto';
        const prompt = `Dame 3 ideas concisas de posts para redes sociales sobre ${projName}. Separadas por saltos de línea.`;
        showToast('Generando ideas con IA...', 'info');
        try {
            const response = await callGeminiAPI(prompt, 'pro'); // Usa modelo 'pro'
            // Procesar respuesta (asumiendo ideas separadas por saltos de línea)
            const ideas = response.split('\n')
                                .map(line => line.replace(/^[*-]?\s*/, '').trim()) // Limpiar formato lista/viñeta
                                .filter(idea => idea.length > 5); // Filtrar líneas vacías o muy cortas

            if (!S.cronopost.ideas[activeProjectId]) S.cronopost.ideas[activeProjectId] = [];
            ideas.forEach(title => S.cronopost.ideas[activeProjectId].push({ id: 'i' + Date.now(), title }));
            save();
            renderCronoPOST();
            showToast(`${ideas.length} ideas generadas!`, 'success');
        } catch (error) {
            console.error("Error generating AI ideas:", error);
            // El toast de error ya se muestra en callGeminiAPI si es por límite
             if (error !== "AI response limit reached for free plan." && error !== "Guest limit reached") {
                showToast("Error al generar ideas con IA.", "danger");
            }
        }
    };
    // Hub
    wireTabs('#hub', 'htab', 'h-htab');
    $('#avatar').onclick = () => { if (!incrementGuestAction()) return; $('#avatarInput').click(); }; // Check invitado al click
    $('#avatarInitials').onclick = () => { if (!incrementGuestAction()) return; $('#avatarInput').click(); }; // Check invitado
    $('#avatarInput').onchange = handleAvatarUpload; // Check invitado dentro
    $('#savePerfil').onclick = saveProfile; // Check invitado dentro
    $('#addMK').onclick = addMarketItem; // Check invitado dentro
    $('#addJob').onclick = addJob; // Check invitado dentro
    $('#jobSearchInput').oninput = renderJobs; // No necesita check, solo lectura
    // Chat Global
    $('#sendGChat').onclick = sendGChatMessage; // Ya tiene check invitado dentro
    $('#gChatMsg').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendGChatMessage();} });
    // Chat IA Global
    $('#aiNewChat').onclick=()=>{ if (!incrementGuestAction()) return; showInputModal('Nueva Conversación Global', 'Título:', 'Ej: Brainstorming', t => { const newId = 'c_g_'+Date.now(); if(!S.aiGlobalChat) S.aiGlobalChat=JSON.parse(JSON.stringify(initialState.aiGlobalChat)); S.aiGlobalChat.threads.push({id:newId, title:t}); S.aiGlobalChat.messages[newId] = []; S.aiGlobalChat.activeThread = newId; save(); renderGlobalAIChat();})};
    $('#aiSendMsg').onclick = sendGlobalAIChatMessage; // Ya tiene check invitado dentro
    $$('#ai-chat-grid .model-card:not(.disabled)').forEach(card => card.onclick = () => { if (!incrementGuestAction()) return; if(card.dataset.model === 'x' && !S.userProfile.isPro) { showLimitModal('goatifyX'); return; } if(S.aiGlobalChat) S.aiGlobalChat.model = card.dataset.model; save(); renderGlobalAIChat(); });
    $('#aiChatMsg').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendGlobalAIChatMessage(); }});
    $('#g_attachFileBtn').onclick = () => { if (!incrementGuestAction()) return; $('#g_chatFileInput').click(); }; // Verifica invitado
    $('#aiImageGenBtn').onclick = () => { if (!incrementGuestAction()) return; showInputModal('Generar Imagen con IA', 'Describe la imagen:', 'Un gato astronauta', p => { $('#aiChatMsg').value = `Crea una imagen de ${p}`; sendGlobalAIChatMessage(); }); }; // Verifica invitado
    $('#closeAiCodePreview').onclick = () => { $('#aiCodePreviewWrapper').style.display = 'none'; }; // No necesita check

    // --- Listeners Billetera ---
    wireTabs('#walletModal', 'wtab', 'w-tab'); // Pestañas de la billetera
    $('#walletPerformTransfer').onclick = performIntisTransfer; // Ya tiene check invitado dentro
    $('#closeIntisReceipt').onclick = () => { $('#intisReceipt').style.display = 'none'; };

    // --- Listener Redimensionar Sidebar ---
    setupSidebarResizer();

    // --- Listener Auto-Resize Textareas ---
    setupAutoResize();

    // --- Listener Colapso Chats ---
    setupChatCollapse();

}

// --- Ejecutar Inicialización al cargar el DOM ---
document.addEventListener('DOMContentLoaded', init);

</script>
<!-- Pantalla de Login (oculta inicialmente si hay datos guardados) -->
<div id="loginScreen" style="display: none; position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px;">
    <div class="card" style="background: var(--surface); max-width: 400px; padding: 40px;">
        <img src="Logos HD.png" alt="Goatify Logo" style="height: 60px; margin-bottom: 20px;">
        <h2>Bienvenido a Goatify IA</h2>
        <p class="sub">Tu súper app para gestionar proyectos, colaborar y monetizar con IA.</p>
        <button id="loginBtn" class="btn btn-primary" style="width: 100%; margin-top: 20px; padding: 12px;">Iniciar Sesión / Registrarse</button>
        <button id="guestBtn" class="btn" style="width: 100%; margin-top: 10px;">Entrar como Invitado</button>
    </div>
</div>

<!-- Contenedor Principal de la App (oculto hasta login/guest) -->
<div id="appContent" style="display: none;">
    <!-- El Header y .container van aquí (movidos por JS durante init) -->
</div>

</body>
</html>

