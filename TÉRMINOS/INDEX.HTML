<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#101010">
    <link rel="manifest" href="manifest.json">
    <title>Goatify IA - Tu Aliado Estratégico en Productividad y Negocios con IA</title>
    <link rel="icon" type="image/png" href="./Logos HD.png">
    <link rel="apple-touch-icon" href="/Logos HD.png"> <!-- PWA: Apple Touch Icon -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- PDF Reading Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>pdfjsLib.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';</script>
    <!-- Date/Time Library -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/locale/es.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/plugin/localizedFormat.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/plugin/isoWeek.js"></script>

    <style>
        :root {
            --bg-dark: #101010;
            --bg-medium: #1a1a1a;
            --bg-light: #282828;
            --primary: #8a4fff;
            --primary-hover: #7b46e6;
            --text-light: #e5e5e5;
            --text-medium: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
            --gold-color: #FFD700;
            --urgent-color: #ef4444;
            --danger-color: #dc2626;

            --light-bg-dark: #f9f9f9;
            --light-bg-medium: #ffffff;
            --light-bg-light: #f1f1f1;
            --light-primary: #7c40e6;
            --light-primary-hover: #6a37d3;
            --light-text-dark: #1f2937;
            --light-text-medium: #6b7280;
            --light-border-color: rgba(0, 0, 0, 0.09);

            --base-font-size: 13.5px; /* Made font size slightly smaller */
        }

        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: var(--base-font-size);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .dark-theme {
            --current-bg-dark: var(--bg-dark);
            --current-bg-medium: var(--bg-medium);
            --current-bg-light: var(--bg-light);
            --current-primary: var(--primary);
            --current-primary-hover: var(--primary-hover);
            --current-text-light: var(--text-light);
            --current-text-medium: var(--text-medium);
            --current-border-color: var(--border-color);
            background-color: var(--current-bg-dark);
            color: var(--text-light);
        }

        .light-theme {
            --current-bg-dark: var(--light-bg-dark);
            --current-bg-medium: var(--light-bg-medium);
            --current-bg-light: var(--light-bg-light);
            --current-primary: var(--light-primary);
            --current-primary-hover: var(--light-primary-hover);
            --current-text-light: var(--light-text-dark);
            --current-text-medium: var(--light-text-medium);
            --current-border-color: var(--light-border-color);
            background-color: var(--light-bg-dark);
            color: var(--light-text-dark);
        }

        #sidebar {
            background-color: var(--current-bg-dark);
            border-right: 1px solid var(--current-border-color);
            height: 100vh;
            transition: width 0.3s ease, transform 0.3s ease;
            z-index: 40;
            position: relative;
            display: flex; /* Ensure flex column layout for sidebar content */
            flex-direction: column;
        }
        #sidebar.collapsed {
            width: 80px; /* Adjusted collapsed width to show logo/icon */
            padding: 0;
            overflow: hidden;
        }
        #sidebar.collapsed > *:not(#sidebar-toggle-arrow, #sidebar-header, #sidebar-bottom-fixed, #workflows-container, #actions-category, #user-section) { /* Hide most content when collapsed */
            display: none;
        }
        #sidebar.collapsed #sidebar-header {
            padding-bottom: 0;
            border-bottom: none;
        }
        #sidebar.collapsed #sidebar-top-actions,
        #sidebar.collapsed #sidebar-scrollable-content .flex-grow,
        #sidebar.collapsed #sidebar-footer {
            display: none;
        }

        #sidebar.collapsed #workflows-container .workflow-header .text-sm,
        #sidebar.collapsed #actions-category .actions-header .text-sm,
        #sidebar.collapsed #sidebar-bottom-fixed #user-menu-view span,
        #sidebar.collapsed #sidebar-bottom-fixed #user-menu-view .fas.fa-ellipsis-h
         {
            display: none;
        }
        #sidebar.collapsed .workflow-header,
        #sidebar.collapsed .actions-header,
        #sidebar.collapsed #sidebar-bottom-fixed #user-menu-btn
         {
            justify-content: center;
        }
        #sidebar.collapsed .workflow-header i,
        #sidebar.collapsed .actions-header i,
        #sidebar.collapsed #sidebar-bottom-fixed #user-menu-btn img,
        #sidebar.collapsed #sidebar-bottom-fixed #user-menu-btn i.fa-cog {
            margin-right: 0 !important;
            margin-left: 0 !important;
        }
        #sidebar.collapsed #sidebar-bottom-fixed #user-menu-btn i.fa-cog { /* Ensure settings icon is visible and centered */
            display: block;
        }

        #sidebar-toggle-arrow {
            position: absolute;
            top: 12px; /* Position at the top right */
            right: -12px;
            transform: translateY(0%) rotate(0deg); /* No vertical translation initially, arrow points left initially (expanded state) */
            background-color: var(--current-bg-dark);
            border: 1px solid var(--current-border-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: none; /* Hidden by default, shown on desktop */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 45;
            transition: transform 0.3s ease, left 0.3s ease, right 0.3s ease, top 0.3s ease; /* Added top to transition */
        }
        #sidebar:not(.collapsed) #sidebar-toggle-arrow {
            right: -12px; /* Keep it on the right side when expanded */
            transform: translateY(0%) rotate(0deg); /* Arrow points left when expanded */
        }


        #sidebar-header, #sidebar-bottom-fixed {
            flex-shrink: 0;
            padding: 0.75rem;
        }
        #sidebar-header { border-bottom: 1px solid var(--current-border-color); }
        #sidebar-bottom-fixed { border-top: 1px solid var(--current-border-color); }

        #sidebar-scrollable-content {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
        }
        #sidebar-content-main {
            flex-grow: 1;
        }
        #sidebar-footer {
            flex-shrink: 0;
            margin-top: auto;
            padding-top: 1rem;
        }


        @media (max-width: 767px) {
            #sidebar {
                transform: translateX(-100%);
                position: fixed;
                top: 0;
                left: 0;
                width: 288px;
            }
            #sidebar.is-open {
                transform: translateX(0);
            }
            #sidebar, #sidebar > .flex {
                height: 100vh;
                height: -webkit-fill-available;
            }
            body { --base-font-size: 13.5px; }
            button, .btn-primary {
                padding-top: 0.4rem; padding-bottom: 0.4rem;
                padding-left: 0.75rem; padding-right: 0.75rem;
                font-size: 0.8rem;
            }
            .text-lg { font-size: 1rem; }
            .text-xl { font-size: 1.1rem; }
            .text-2xl { font-size: 1.2rem; }
            .text-3xl { font-size: 1.4rem; }
            #app-container {
                max-height: calc(100vh - 10px);
            }
             #sidebar.collapsed { /* On mobile, when explicitly collapsed by menu button, should hide completely */
                width: 0;
                padding: 0;
                overflow: hidden;
                border-right: none;
            }
            #sidebar.collapsed > * { /* Hide all content when fully collapsed on mobile */
                display: none;
            }
            #sidebar.collapsed #sidebar-toggle-arrow { /* Hide sidebar toggle arrow on mobile */
                display: none;
            }
        }


        #main-chat-area, .modal-content { background-color: var(--current-bg-medium); }
        .chat-bubble-bot, .bg-input, #pdf-preview-container, .chat-item, .project-header, #user-menu-popup, #services-menu, .note-item { background-color: var(--current-bg-light); }
        .border-themed { border-color: var(--current-border-color); }
        .chat-bubble-user { background-color: var(--current-primary); color: white; }
        .btn-primary { background-color: var(--current-primary); color: white; }
        .btn-primary:hover { background-color: var(--current-primary-hover); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .plan-card-highlight { border-color: var(--current-primary); box-shadow: 0 0 15px rgba(138, 79, 255, 0.3); }
        .placeholder-themed::placeholder { color: var(--current-text-medium); }
        .text-primary, .workflow-header i:not(.workflow-arrow) { color: var(--primary) !important; }
        .glowing-mic { animation: pulse 1.5s infinite; color: var(--primary) !important; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(138, 79, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(138, 79, 255, 0); }
        }

        .project .project-content { display: none; }
        .project.open .project-content { display: block; }
        .workflow-category.open .workflow-arrow,
        .actions-category.open .actions-arrow,
        .folders-category.open .folder-arrow,
        .project.open .project-arrow {
            transform: rotate(90deg);
        }
        .project-header.drag-over { background-color: var(--current-primary); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        #app-container { height: 100vh; height: -webkit-fill-available; }
        #pricing-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .chat-item.selected-for-delete, .note-item.selected-for-delete { background-color: var(--primary) !important; color: white; }

        .model-selector-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .model-selector-wrapper select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
            padding-right: 2.5rem;
            height: 32px;
            font-size: 0.875rem;
            line-height: 1.25rem;
            border: none;
            outline: none;
            cursor: pointer;
            min-width: 120px;
            background-color: transparent;
        }
         .model-selector-wrapper i {
            position: absolute;
            right: 0.5rem;
            pointer-events: none;
        }

        /* Desktop specific styles for input area */
        @media (min-width: 768px) {
            #input-area {
                display: flex;
                flex-direction: column; /* Stack vertically on desktop */
                align-items: flex-start; /* Align items to start */
            }
            #input-area-model-row { /* New ID for the top row (model + tools) */
                display: flex;
                flex-direction: row; /* Horizontal layout for model and file buttons */
                align-items: center;
                justify-content: space-between;
                background-color: var(--current-bg-light);
                padding: 0.25rem 0.5rem; /* Thinner bar */
                border-radius: 0.75rem;
                margin-bottom: 0.5rem; /* Closer to input */
                width: 100%;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            #input-area-chat-row { /* New ID for the chat input and mic/send buttons */
                display: flex;
                flex-direction: row; /* Keep horizontal for input row */
                align-items: center;
                background-color: var(--current-bg-light);
                border-radius: 0.75rem;
                padding: 0.5rem;
                width: 100%;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
        }

        /* Mobile specific adjustments to maintain stacked layout */
        @media (max-width: 767px) {
            #input-area-model-row {
                display: flex;
                flex-direction: row; /* Changed to row for single line */
                align-items: center;
                justify-content: space-around; /* Distribute items evenly */
                background-color: var(--current-bg-light);
                padding: 0.5rem;
                border-radius: 0.75rem;
                margin-bottom: 0.75rem;
                width: 100%;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            #input-area-model-row .model-selector-wrapper {
                flex-grow: 1; /* Allow selector to grow */
                margin-bottom: 0; /* Remove extra margin */
                min-width: unset; /* Allow shrinking */
            }
            #input-area-model-row .action-buttons-container {
                width: auto; /* Allow buttons to take natural width */
                justify-content: flex-end; /* Align buttons to the end */
                flex-shrink: 0; /* Prevent shrinking */
            }
            #input-area-chat-row {
                display: flex;
                flex-direction: row; /* Keep horizontal for input row */
                align-items: center;
                background-color: var(--current-bg-light);
                border-radius: 0.75rem;
                padding: 0.5rem;
                width: 100%;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
        }

        #input-area-model-row .model-selector-wrapper {
            flex-grow: 1;
            min-width: 0;
            text-align: center; /* Center text in selector */
        }
        #input-area-model-row .action-buttons-container {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
       #voice-selector-container {
            display: flex !important; /* Always visible */
            align-items: center;
            gap: 0.25rem;
            opacity: 0.8; /* Subtle visibility */
        }
        #input-area-chat-row .input-wrapper {
            background-color: transparent;
            padding: 0;
        }


        .workflow-category.open .workflow-content, .actions-category.open .actions-content, .folders-category.open .folders-content { display: block; }
        .workflow-content, .actions-content, .folders-content { display: none; }

        .plan-card { background-color: var(--current-bg-light); }
        #pdf-preview-container { padding: 0.5rem; }

        @keyframes sweep {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(200%) skewX(-15deg); }
        }
        .cool-light-effect { position: relative; overflow: hidden; }
        .cool-light-effect::before {
            content: '';
            position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(138, 79, 255, 0.25) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-150%) skewX(-15deg); transition: transform 0.8s ease;
            pointer-events: none;
        }
        .cool-light-effect:hover::before { animation: sweep 2s infinite linear; }

        .input-wrapper { border: 1px solid transparent; transition: box-shadow 0.3s ease, border-color 0.3s ease; }
        .input-wrapper:focus-within { box-shadow: 0 0 10px 0px rgba(138, 79, 255, 0.5); border-color: var(--current-primary-hover); }

        #chat-title {
            color: var(--primary);
            font-weight: 700;
            transition: color 0.3s ease;
        }
        #desktop-chat-title-wrapper:hover #chat-title {
            color: var(--primary-hover);
        }

        #desktop-chat-title-wrapper {
            position: relative;
            cursor: pointer;
        }
        #desktop-chat-title-wrapper .edit-icon {
            opacity: 0;
            transition: opacity 0.2s;
            margin-right: 8px;
        }
        #desktop-chat-title-wrapper:hover .edit-icon {
            opacity: 1;
        }
        #mobile-chat-title-wrapper .edit-icon {
            margin-right: 8px;
        }

        .btn-disabled { background-color: #3a3a3a !important; color: #888 !important; cursor: not-allowed !important; border-color: #3a3a3a !important;}

        .chat-item.selected-chat, .note-item.active {
            background-color: var(--current-primary);
            color: white !important;
        }
        .chat-item.selected-chat .text-sm, .note-item.active * {
            color: white !important;
        }
        .light-theme .chat-item, .light-theme .note-item {
            color: var(--light-text-dark);
        }
        .note-item:hover {
            background-color: var(--current-bg-dark);
        }

        /* Calendar styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day {
            padding: 2px;
            border-radius: 4px;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            transition: background-color 0.2s ease, border 0.2s ease;
            position: relative;
            border: 2px solid transparent;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .calendar-day-number {
            font-weight: bold;
            font-size: 0.8rem;
            margin: 4px;
            align-self: flex-start;
        }
        .calendar-day-tasks {
            flex-grow: 1;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 0 2px 2px 2px;
        }
        .calendar-day-task {
            font-size: 0.65rem;
            padding: 2px 4px;
            border-radius: 4px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
            position: relative;
        }
        .calendar-day-task .delete-task-icon {
            display: none;
            position: absolute;
            right: 1px;
            top: 1px;
            color: white;
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 14px;
            height: 14px;
            font-size: 8px;
            line-height: 14px;
            text-align: center;
        }
        .calendar-day-task:hover .delete-task-icon {
            display: block;
        }

        .calendar-day:hover {
            background-color: var(--current-bg-light);
        }
        .calendar-day.current-month {
            color: var(--current-text-light);
        }
        .calendar-day.other-month {
            color: var(--current-text-medium);
            opacity: 0.5;
        }
        .calendar-day.today .calendar-day-number {
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 2px;
        }
        .task-dots-container {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
        }
        .task-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-item-completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .notification-bell-icon {
            position: relative;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7em;
            line-height: 1;
            min-width: 18px;
            text-align: center;
        }

        .calendar-view-toggle, .project-view-controls {
            display: flex;
            gap: 0.5rem;
            background-color: var(--current-bg-dark);
            padding: 0.25rem;
            border-radius: 8px;
            width: 100%;
        }

        .calendar-view-toggle button, .project-view-controls button {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            font-weight: 600;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
            white-space: nowrap; /* Prevents text wrapping */
        }
        .calendar-view-toggle button.active, .project-view-controls button.active {
            background-color: var(--current-primary);
            color: white;
            box-shadow: 0 0 8px rgba(138, 79, 255, 0.4);
        }
        .calendar-view-toggle button:hover:not(.active), .project-view-controls button:hover:not(.active) {
            background-color: var(--current-bg-medium);
        }
        .dark-theme .project-view-controls button:not(.active) {
            color: var(--current-text-light);
        }
        .light-theme .project-view-controls button:not(.active) {
            color: var(--current-text-dark);
        }

        #month-view-container, #day-view-container {
            display: block;
        }
        #week-view-container, #day-view-container {
            display: none;
        }
        #week-view-container, #day-view-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--current-border-color);
            border-radius: 8px;
            padding: 10px;
        }
        .week-day-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--current-border-color);
        }
        .week-day-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .week-day-section h5 {
            font-weight: 700;
            color: var(--current-primary);
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .week-day-section .task-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 0;
        }

        .day-view-timeline {
            position: relative;
        }
        .day-view-hour {
            display: flex;
            border-top: 1px solid var(--current-border-color);
        }
        .day-view-hour-label {
            width: 60px;
            flex-shrink: 0;
            text-align: right;
            padding-right: 10px;
            font-size: 0.75rem;
            color: var(--current-text-medium);
        }
        .day-view-hour-content {
            flex-grow: 1;
            border-left: 1px solid var(--current-border-color);
            padding: 5px;
            min-height: 40px;
            position: relative;
        }
        .add-task-to-time-btn {
            position: absolute;
            right: 5px;
            top: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .day-view-hour-content:hover .add-task-to-time-btn {
            opacity: 1;
        }

        /* Project, Financial & Notepad View Styles */
        #project-management-view, #financial-assistant-view, #notepad-view-container, #translator-view {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: 100%;
            position: relative;
            flex: 1;
            overflow: hidden;
        }

        #project-board-container, #financial-tools-container, #notepad-editor-and-chat-container, #translator-panels {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        #project-chat-container, #financial-chat-container, #notepad-chat-container {
            display: flex;
            border-top: 1px solid var(--current-border-color);
            padding-top: 1rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
            background-color: var(--current-bg-medium);
        }
        #project-chat-container.collapsed, #financial-chat-container.collapsed, #notepad-chat-container.collapsed {
            flex-grow: 0;
            flex-basis: auto;
            height: 50px !important;
        }

        #project-chat-container .project-chat-body,
        #financial-chat-container .financial-chat-body,
        #notepad-chat-container .notepad-chat-body {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        #project-chat-container.collapsed .project-chat-body,
        #financial-chat-container.collapsed .financial-chat-body,
        #notepad-chat-container.collapsed .notepad-chat-body {
            display: none;
        }

        #project-chat-toggle i, #financial-chat-toggle i, #notepad-chat-toggle i {
            transition: transform 0.3s ease;
        }
        #project-chat-container:not(.collapsed) #project-chat-toggle i,
        #financial-chat-container:not(.collapsed) #financial-chat-toggle i,
        #notepad-chat-container:not(.collapsed) #notepad-chat-toggle i {
            transform: rotate(180deg);
        }

        #project-chat-messages, #financial-chat-messages, #notepad-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        #kanban-view {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            overflow: hidden;
            flex-grow: 1;
        }

        .kanban-column {
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-width: 0; /* Allow columns to shrink */
        }
        .kanban-column-title {
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--current-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-cards {
            flex-grow: 1;
            min-height: 100px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .kanban-card {
            background-color: var(--current-bg-medium);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            border-left: 4px solid var(--current-primary);
            position: relative;
        }
        .kanban-card .delete-task-icon {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
            color: var(--current-text-medium);
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            line-height: 18px;
            text-align: center;
        }
        .kanban-card .delete-task-icon:hover {
            background-color: var(--danger-color);
            color: white;
            transform: scale(1.1);
        }
        .kanban-card:hover .delete-task-icon {
            display: block;
        }
        .kanban-card.urgent {
            border-left-color: var(--urgent-color);
        }
        .kanban-card:active {
            cursor: grabbing;
            background-color: var(--primary);
        }
        .kanban-card p {
            font-weight: 500;
            padding-right: 20px; /* Space for delete icon */
        }
        .kanban-card .card-footer {
            font-size: 0.75rem;
            color: var(--current-text-medium);
            margin-top: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-cards.drag-over {
            border: 2px dashed var(--current-primary);
            background-color: rgba(138, 79, 255, 0.1);
        }

        /* List View Styles */
        #list-view {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-grow: 1;
        }
        .list-view-header {
            display: grid;
            grid-template-columns: 1fr 150px 80px 120px 40px;
            gap: 1rem;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid var(--current-border-color);
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--current-text-medium);
            flex-shrink: 0;
        }
        .list-view-content {
             overflow-y: auto;
             flex-grow: 1;
        }
        .list-view-task {
            display: grid;
            grid-template-columns: 1fr 150px 80px 120px 40px;
            gap: 1rem;
            align-items: center;
            padding: 0.25rem 1rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        .list-view-task:last-child {
            border-bottom: none;
        }
        .list-view-task input[type="date"], .list-view-task input[type="time"] {
                background: transparent;
                border: none;
                border-radius: 4px;
                padding: 2px 4px;
                font-size: 0.8rem;
                width: auto;
                color: var(--current-text-light);
                color-scheme: dark;
        }
        .light-theme .list-view-task input { color-scheme: light; color: var(--light-text-dark); }
        .list-view-task:hover {
            background-color: var(--current-bg-light);
        }
        .list-view-task.task-item-completed .task-content-list {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .task-content-list.urgent {
            font-weight: 600;
            color: var(--urgent-color);
        }
        .task-content-list input {
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
        }
        .task-content-list input:focus {
             background-color: var(--current-bg-dark);
        }
        .priority-cell {
            text-align: center;
            cursor: pointer;
        }

        .task-labels {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .task-label {
            padding: 2px 8px;
            font-size: 0.7rem;
            border-radius: 12px;
            font-weight: 600;
        }
        #project-tag-filter-container {
            position: relative;
        }
        #tag-filter-dropdown {
            position: absolute;
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Gamification Styles */
        #gamification-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .gamification-tabs { border-bottom: 2px solid var(--current-border-color); }
        .gamification-tab { padding: 0.75rem 1rem; font-weight: 600; color: var(--current-text-medium); cursor: pointer; border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; }
        .gamification-tab.active { color: var(--current-primary); border-color: var(--current-primary); }
        .xp-bar-bg { background-color: var(--current-bg-light); }
        .xp-bar-fill { background-color: var(--current-primary); transition: width 0.5s ease-out; }
        .level-badge { background-color: var(--current-primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; }
        .streak-day { background-color: var(--current-bg-light); border: 2px solid var(--current-border-color); transition: all 0.2s ease; }
        .streak-day.active { border-color: var(--current-primary); transform: scale(1.05); box-shadow: 0 0 10px rgba(138, 79, 255, 0.5); }
        .streak-day.completed { background-color: var(--current-primary); color: white; border-color: var(--current-primary); }
        .streak-day .fa-gift { color: var(--gold-color); }
        .mission-item.completed { opacity: 0.5; text-decoration: line-through; }
        .mission-item.completed .btn-primary { background-color: #4CAF50; cursor: default; }
        .achievement-badge { border: 2px solid var(--current-border-color); filter: grayscale(100%); opacity: 0.6; transition: all 0.3s ease; }
        .achievement-badge.unlocked { border-color: var(--gold-color); filter: grayscale(0%); opacity: 1; box-shadow: 0 0 15px var(--gold-color); }
        .achievement-badge.unlocked .fa-medal { color: var(--gold-color); }
        .text-gold { color: var(--gold-color); }

        /* Pricing Modal Enhancements */
        .plan-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .plan-details.open {
            max-height: 500px; /* Adjust as needed */
        }
        .plan-feature-list {
            list-style-position: inside;
        }
        .plan-feature-list li {
            padding-left: 1em;
            text-indent: -1em;
        }
        .plan-feature-list .fa-check-circle {
            color: var(--primary);
        }

        /* NEW Financial Assistant Styles */
        #financial-tools-container {
             padding: 1rem;
             gap: 1rem;
             overflow-y: auto;
        }
        .finance-section {
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
        }
        .finance-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        .finance-section-header h3 {
            font-size: 1.125rem;
            font-weight: 700;
        }
        .finance-category {
            margin-top: 1rem;
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
        }
        .finance-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .finance-category-header .finance-category-name-input {
            background: transparent;
            border: none;
            outline: none;
            font-weight: bold;
            width: 70%;
            color: var(--current-text-light);
        }
        .finance-category-content {
            padding: 0.75rem;
        }
        .finance-item-row {
            display: grid;
            grid-template-columns: 1fr 100px 40px;
            gap: 0.75rem;
            align-items: center;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--current-border-color);
        }
        .finance-item-row:last-child {
            border-bottom: none;
        }
        .finance-item-row input {
            background: transparent;
            border: none;
            padding: 0.25rem;
            width: 100%;
            outline: none;
            color: var(--current-text-light);
        }
        .finance-item-row input:focus {
            background-color: var(--current-bg-dark);
            border-radius: 4px;
        }
        .finance-summary {
            background-color: var(--current-bg-light);
            border-radius: 0.5rem;
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            text-align: center;
        }
        .finance-summary h4 {
            font-size: 0.8rem;
            color: var(--current-text-medium);
        }
        .finance-summary p {
            font-size: 1.25rem;
            font-weight: 700;
        }
        #total-income { color: #22c55e; }
        #total-expenses { color: #ef4444; }

        /* Notepad View */
        #notepad-view-container {
            display: none; /* Hidden by default */
            padding: 0; /* No padding on main container */
            flex-direction: column; /* Organiza el toolbar y el resto verticalmente */
        }

        #notes-list-panel {
            flex-shrink: 0; /* El panel no debe encogerse */
            padding: 0.5rem;
            border-bottom: 1px solid var(--current-border-color);
        }

        #notepad-editor-and-chat-container {
            display: flex;
            flex-direction: row;
            flex-grow: 1;
            gap: 1rem;
            padding: 1rem;
            min-height: 0;
        }
        #notes-list {
            display: none; /* La lista interna ya no es necesaria aquí */
        }
        .note-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background-color: var(--current-bg-medium);
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
            display: block; /* Asegurarse de que las etiquetas 'a' se comporten como bloques */
            color: var(--current-text-light); /* Heredar color de texto */
            text-decoration: none; /* Quitar subrayado de los links */
        }
        .note-item:hover {
            background-color: var(--current-bg-dark);
            border-left-color: var(--current-primary-hover);
        }
        .note-item.active {
            background-color: var(--current-primary);
            color: white !important;
            font-weight: bold;
            border-left-color: var(--gold-color);
        }
        .note-item.active * {
            color: white !important;
        }
        #note-editor-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        #note-editor-toolbar {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--current-border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            background-color: var(--current-bg-medium);
        }
         #note-editor-toolbar button, .drawing-tool {
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.375rem;
            padding: 0.4rem 0.6rem;
            transition: all 0.2s ease;
        }
         #note-editor-toolbar button:hover, .drawing-tool:hover {
            background-color: var(--current-bg-dark);
            border-color: var(--current-primary);
        }
        #note-editor-toolbar button.active {
            background-color: var(--current-primary);
            color: white;
            border-color: var(--current-primary);
        }
        .drawing-tool[type="color"] {
             padding: 0.2rem;
             min-width: 36px;
             height: 36px;
        }
        #note-title-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            outline: none;
            font-size: 1.1rem; /* Reduced font size */
            font-weight: bold;
            padding: 0.5rem 0.75rem; /* Reduced padding */
            border-bottom: 1px solid var(--current-border-color);
        }
        #note-content-area {
            position: relative;
            flex-grow: 1;
        }
        #note-content-editor {
            flex-grow: 1;
            width: 100%;
            height: 100%;
            background-color: transparent;
            color: var(--current-text-light);
            border: none;
            border-radius: 0.5rem;
            padding: 1rem; /* Default padding for margins */
            padding-left: 2rem; /* Left margin */
            padding-right: 2rem; /* Right margin */
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            resize: none;
            outline: none;
            overflow-y: auto; /* Enable vertical scroll */
            white-space: pre-wrap; /* Ensure line breaks are respected */
        }
        #note-content-editor:focus-within {
            box-shadow: none;
        }
        .checklist-item {
            display: flex;
            align-items: flex-start; /* Align items to the top for multi-line text */
            gap: 0.75rem; /* Space between checkbox and text */
            margin: 0.5rem 0;
        }
        .checklist-item input[type="checkbox"] {
            width: 1.15em;
            height: 1.15em;
            accent-color: var(--current-primary);
            cursor: pointer;
            flex-shrink: 0; /* Prevent checkbox from shrinking */
            margin-top: 0.2em; /* Adjust vertical alignment of checkbox */
        }
        .checklist-item-text {
            flex-grow: 1;
            outline: none;
            min-height: 1.15em; /* Ensure text area has minimum height */
            padding-top: 0.2em; /* Align text with checkbox visually */
            padding-bottom: 0.2em;
            word-wrap: break-word; /* Allow text to wrap within the span */
        }
        .checklist-item-text[data-checked="true"] {
            text-decoration: line-through;
            opacity: 0.6;
        }
        #note-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--light-bg-medium); /* Or a translucent background for dark theme */
            cursor: crosshair;
            touch-action: none; /* Prevents browser gestures like scroll/zoom on canvas for better touch drawing */
        }
        #notes-list-toggle {
            position: absolute;
            top: 12px; /* Adjusted to match sidebar toggle */
            right: -12px; /* Half of width to position it outside */
            transform: translateY(0%) rotate(0deg); /* Initial state when expanded */
            background-color: var(--current-bg-dark);
            border: 1px solid var(--current-border-color);
            border-radius: 50%;
            padding: 4px;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.3s ease;
        }
        #notes-list-panel:not(.collapsed) #notes-list-toggle {
            transform: translateY(0%) rotate(0deg); /* Arrow points left when list is open */
        }
        #notes-list-panel.collapsed #notes-list-toggle {
            transform: translateY(0%) rotate(180deg); /* Arrow points right when list is collapsed */
        }
        /* New styles for text editor controls */
        .text-editor-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .text-editor-controls button {
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.375rem;
            padding: 0.4rem 0.6rem;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            cursor: pointer;
        }
        .text-editor-controls button:hover {
            background-color: var(--current-bg-dark);
            border-color: var(--current-primary);
        }
        .text-editor-controls button.active {
            background-color: var(--current-primary);
            color: white;
            border-color: var(--current-primary);
        }
        .drawing-tool.active {
            background-color: var(--current-primary);
            color: white;
            border-color: var(--current-primary);
        }
        #drawing-fullscreen-btn {
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.375rem;
            padding: 0.4rem 0.6rem;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            cursor: pointer;
        }
        #drawing-fullscreen-btn:hover {
            background-color: var(--current-bg-dark);
            border-color: var(--current-primary);
        }
        #drawing-fullscreen-btn.active {
            background-color: var(--current-primary);
            color: white;
            border-color: var(--current-primary);
        }

        /* Translator UI Styles */
        #translator-view {
            display: none; /* Hidden by default */
        }
        #translator-panels {
            display: flex;
            flex-grow: 1;
            gap: 1rem;
            min-height: 0;
            flex-direction: column; /* Mobile first */
        }
        .translator-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
            min-height: 250px; /* Min height for mobile */
        }
        .translator-panel textarea {
            flex-grow: 1;
            background-color: var(--current-bg-medium);
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            resize: none;
            color: var(--current-text-light);
            outline: none;
            font-size: 1rem;
        }
        .translator-panel textarea:focus {
            border-color: var(--current-primary);
            box-shadow: 0 0 8px rgba(138, 79, 255, 0.4);
        }
        #translator-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
            padding: 0.5rem 0;
        }
        @media (min-width: 768px) {
            #translator-panels {
                flex-direction: row;
            }
            #translator-controls {
                flex-direction: column;
                padding: 0 0.5rem;
            }
            #translate-btn i {
                transform: rotate(90deg);
            }
        }


        /* In-app notification */
        #in-app-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-200%);
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            padding: 1rem;
            border-radius: 0.75rem;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            border: 1px solid var(--current-border-color);
            max-width: 90%;
            width: 400px;
            opacity: 0;
            pointer-events: none;
            cursor: pointer;
        }
        #in-app-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        #in-app-notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        #in-app-notification-header h4 {
            font-weight: bold;
        }

        @keyframes glowing {
            0% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px var(--primary), 0 0 20px var(--primary); }
            50% { text-shadow: 0 0 10px #fff, 0 0 20px var(--primary), 0 0 30px var(--primary), 0 0 40px var(--primary); }
            100% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px var(--primary), 0 0 20px var(--primary); }
        }

        .task-notification-content .glowing-text {
            animation: glowing 1.5s ease-in-out infinite;
        }


        /* Desktop specific styles */
        @media (min-width: 768px) {
            #sidebar-toggle-arrow {
                display: flex;
            }
            #sidebar.collapsed {
                width: 80px;
            }
            #sidebar:not(.collapsed) {
                width: 288px;
            }

            #services-menu {
                opacity: 0;
                visibility: hidden;
                transform: scale(0.95) translateY(-10px);
                transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
            }
            #services-menu.show {
                opacity: 1;
                visibility: visible;
                transform: scale(1) translateY(0);
            }
            #project-management-view, #financial-assistant-view, #translator-view {
                display: flex;
                flex-direction: row;
            }
             #notepad-editor-and-chat-container {
                flex-direction: row;
            }

            #notes-list-toggle {
                display: block; /* Show toggle on desktop */
            }


            #project-chat-container, #financial-chat-container, #notepad-chat-container {
                display: flex;
                border-left: 1px solid var(--current-border-color);
                border-top: none;
                padding-left: 1rem;
                padding-top: 0;
                height: 100%;
                flex-basis: 40%;
                flex-shrink: 0;
                flex-direction: column;
            }
            #project-chat-container.collapsed, #financial-chat-container.collapsed, #notepad-chat-container.collapsed {
                flex-basis: 50px;
                height: 100% !important;
            }
            #project-chat-container-header, #financial-chat-header, #notepad-chat-header { cursor: pointer; }

            #project-chat-container.collapsed .project-chat-body,
            #project-chat-container.collapsed #project-chat-container-header h3,
            #financial-chat-container.collapsed .financial-chat-body,
            #financial-chat-container.collapsed #financial-chat-header h3,
            #notepad-chat-container.collapsed .notepad-chat-body,
            #notepad-chat-container.collapsed #notepad-chat-header h3 {
                display: none;
            }

            #project-chat-container.collapsed #project-chat-toggle,
            #financial-chat-container.collapsed #financial-chat-toggle,
            #notepad-chat-container.collapsed #notepad-chat-toggle {
                transform: rotate(90deg);
                justify-content: center;
            }
            #project-chat-container.collapsed #project-chat-toggle i,
            #financial-chat-container.collapsed #financial-chat-toggle i,
            #notepad-chat-container.collapsed #notepad-chat-toggle i {
                 transform: rotate(180deg);
            }
        }

        /* Mobile specific adjustments */
        @media (max-width: 767px) {
            #mobile-chat-title-wrapper .edit-icon, #mobile-chat-title-wrapper #motivation-btn-mobile {
                display: inline-block;
            }
             #desktop-chat-title-wrapper .edit-icon, #desktop-chat-title-wrapper #motivation-btn-header {
                display: none;
            }
            #calendar-modal {
                padding: 0.5rem;
                max-width: 98vw;
                max-height: 95vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            #calendar-modal > div:not(:first-child) {
                overflow-y: auto;
            }

            .header-left-icons {
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 0;
            }
             .header-left-icons > * {
                padding: 0.3rem;
            }
            .header-right-icons {
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 0;
            }
            .header-right-icons > * {
                padding: 0.3rem;
            }
            #desktop-chat-title-wrapper { display: none; }
            #main-header-content {
                display: flex;
                align-items: center;
                justify-content: space-between;
                width: 100%;
                gap: 0.5rem;
            }
            #main-header-content > * {
                flex-basis: 33.33%;
            }
            #main-header-content .header-left-icons { justify-content: flex-start; }
            #main-header-content .header-right-icons { justify-content: flex-end; }
            #main-header-content #message-counter-wrapper { text-align: center; }


             #file-preview-area {
                display: none; /* Only show when there is a file */
             }
             #image-preview-container {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                max-height: 45px;
                flex-shrink: 1;
            }
            #image-preview {
                max-height: 45px;
                width: auto;
                border-radius: 0.25rem;
            }
            #input-area {
                display: flex;
                flex-direction: column;
            }

            /* Mobile chat containers */
            #project-chat-container, #financial-chat-container, #notepad-chat-container {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 50px;
                overflow: hidden;
                border-top: 1px solid var(--current-border-color);
                z-index: 10;
                transition: height 0.3s ease;
                max-height: calc(100vh - 120px);
            }
            #project-chat-container:not(.collapsed),
            #financial-chat-container:not(.collapsed),
            #notepad-chat-container:not(.collapsed) {
                 height: 100%;
            }
            #project-chat-container .project-chat-body,
            #financial-chat-container .financial-chat-body,
            #notepad-chat-container .notepad-chat-body {
                height: calc(100% - 50px);
                display: flex;
                flex-direction: column;
            }
            /* On mobile, the notepad assistant should be collapsed by default */
            #notepad-chat-container {
                height: 50px !important;
            }
            #notepad-chat-container.collapsed {
                 height: 50px !important;
            }
            #notepad-chat-container:not(.collapsed) {
                 height: 60% !important; /* Or a suitable height */
            }


            #kanban-view {
                grid-template-columns: repeat(3, 1fr);
                overflow-y: auto;
                overflow-x: hidden;
                gap: 0.4rem;
                padding-bottom: 50px;
            }
            .kanban-column {
                min-width: 0;
                padding: 0.4rem;
            }
            .kanban-column-title { font-size: 0.7rem; }
            .kanban-card { padding: 0.4rem; }
            .kanban-card p { font-weight: normal; font-size: 0.7rem; }

            #list-view-mobile {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                 padding-bottom: 50px;
                 overflow-y: auto;
                 flex-grow: 1;
            }
            .list-view-task-mobile { background-color: var(--current-bg-light); padding: 0.75rem; border-radius: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
            .list-view-task-mobile-header { display: flex; align-items: flex-start; gap: 0.75rem; }
            .list-view-task-mobile-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--current-border-color); padding-top: 0.5rem; font-size: 0.75rem; }
            .list-view-task-mobile-footer input[type="time"], .list-view-task-mobile-footer input[type="date"] {
                background: var(--current-bg-dark);
                border: none;
                border-radius: 4px;
                padding: 2px 4px;
                font-size: 0.7rem;
                width: auto;
                color-scheme: dark;
            }
            .light-theme .list-view-task-mobile-footer input[type="time"], .light-theme .list-view-task-mobile-footer input[type="date"] {
                 color-scheme: light;
            }

            /* Notepad Mobile Optimization */
            #notepad-view-container {
                flex-direction: column;
                padding: 0;
                height: 100%;
            }
            #notepad-editor-and-chat-container {
                flex-direction: column;
                padding: 0.5rem;
                height: 100%;
                gap: 0.5rem;
            }
            #notepad-view-container.mobile-editor-active #notes-list-panel {
                display: none;
            }
            #notepad-view-container:not(.mobile-editor-active) #notepad-editor-and-chat-container {
                display: none;
            }
            #notes-list-panel {
                width: 100%;
                height: auto; /* Ajustar altura automáticamente */
                border-radius: 0;
            }
            #note-editor-panel {
                height: 100%;
            }
            #note-back-btn {
                display: inline-block; /* Show back button on mobile */
            }
            #notepad-chat-container {
                position: relative;
                height: 100% !important; /* Full height on mobile */
                max-height: 100% !important;
            }
            #notepad-chat-container:not(.collapsed) {
                 height: 100% !important; /* Forces full height when not collapsed */
                 max-height: 100% !important;
            }
            #notepad-chat-container .notepad-chat-body {
                height: calc(100% - 50px) !important; /* Adjusted to take full remaining height */
            }


            #services-menu {
                position: fixed;
                opacity: 0;
                visibility: hidden;
                transform: scale(0.95) translateY(-10px);
                transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
                width: 90vw;
                max-width: 320px;
                top: 60px;
                right: 10px;
                max-height: calc(100vh - 80px);
                overflow-y: auto;
                z-index: 50;
            }
            #services-menu.show {
                opacity: 1;
                visibility: visible;
                transform: scale(1) translateY(0);
            }

            .calendar-view-toggle button { padding: 6px 4px; font-size: 0.75rem; }
            .project-view-controls { width: fit-content; flex-grow: 0; }
            .project-view-controls button { padding: 6px 8px; font-size: 0.75rem; flex-grow: 0; }

            #gamification-modal .modal-content { padding: 1rem; }
            #gamification-modal h2 { font-size: 1.25rem; }
            .streak-day .text-lg { font-size: 0.8rem; }
            .streak-day .text-2xl { font-size: 1.1rem; }
            .streak-day .text-xs { font-size: 0.6rem; }
            .mission-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .mission-item .btn-primary { padding: 0.25rem 0.5rem; font-size: 0.75rem; align-self: flex-end; }
            #achievements-container { gap: 0.5rem; }
            .achievement-badge { padding: 0.5rem; font-size: 0.7rem; }
            .achievement-badge .fa-3x { font-size: 1.75em; }

            /* Mobile chat item icons always visible */
            .chat-item .chat-item-actions, .note-item .chat-item-actions {
                opacity: 1 !important;
            }
            #notes-list-panel.collapsed #notes-list-toggle { /* Hide notepad toggle on mobile, regardless of state */
                display: none;
            }
        }

        /* Mobile Landscape */
        @media (max-height: 500px) and (orientation: landscape) {
            #sidebar.is-open #sidebar-scrollable-content {
                 overflow-y: auto;
                 height: 100%;
            }
            #main-chat-area, #project-management-view, #financial-assistant-view, #notepad-view-container, #translator-view {
                overflow-y: auto;
            }
            #chat-messages {
                padding: 0.5rem;
                flex-grow: 1;
            }
            #kanban-view {
                grid-template-columns: repeat(3, minmax(250px, 1fr));
                overflow-x: auto;
            }
            .modal-content { max-height: 95vh; overflow-y: auto; }
            #input-area { padding: 0.5rem; flex-shrink: 0; }
            .pro-controls-bg { padding: 0.25rem; }
            #msg { height: 3rem !important; max-height: 3rem; }
        }

        /* Motivation Modal Shimmer Effect */
        #motivation-quote.shimmer-text {
            position: relative;
            overflow: hidden;
        }
        #motivation-quote.shimmer-text::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            animation: shimmer 2.5s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes shimmer {
            0% { transform: translateX(-150%) skewX(-15deg); }
            100% { transform: translateX(250%) skewX(-15deg); }
        }

        .dark-theme #message-counter-wrapper span {
            color: white;
        }

        .light-theme #message-counter-wrapper span {
            color: black;
        }
        .speaker-icon {
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 8px;
            display: inline-block;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .speaker-icon:hover {
            opacity: 1;
        }
        /* Make chat items links for right-click functionality */
        .chat-item, .note-item {
            display: block;
            text-decoration: none;
        }
        .chat-item, a.chat-item:hover, .note-item, a.note-item:hover {
            color: var(--current-text-light);
        }
        .light-theme .chat-item, .light-theme a.chat-item:hover, .light-theme .note-item, .light-theme a.note-item:hover {
            color: var(--light-text-dark);
        }
        /* New style for add to folder dropdown */
        .add-to-folder-dropdown {
            position: absolute;
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            min-width: 150px;
        }
        .add-to-folder-dropdown button {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            text-align: left;
            transition: background-color 0.2s ease;
        }
        .add-to-folder-dropdown button:hover {
            background-color: var(--current-bg-medium);
        }
        .light-theme .add-to-folder-dropdown button {
            color: var(--light-text-dark);
        }
        .light-theme .add-to-folder-dropdown button:hover {
            background-color: var(--light-bg-light);
        }

        /* HTML Preview Modal Styles */
        #html-preview-modal .modal-content {
            padding: 0;
            width: 90%; /* Adjust width */
            max-width: 900px; /* Max width */
            height: 90%; /* Adjust height */
            max-height: 600px; /* Max height */
        }
        #html-preview-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--current-border-color);
            background-color: var(--current-bg-light);
            border-radius: 0.75rem 0.75rem 0 0;
        }
        #html-preview-modal .modal-header h3 {
            margin: 0;
        }
        #html-preview-modal .modal-header button {
            background: none;
            border: none;
            color: var(--current-text-light);
            font-size: 1.5rem;
            cursor: pointer;
        }
        #html-preview-iframe {
            flex-grow: 1;
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }
        #preview-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background-color: var(--current-bg-light);
            border-radius: 0 0 0.75rem 0.75rem;
            border-top: 1px solid var(--current-border-color);
        }

        /* Fullscreen for Canvas */
        .canvas-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background-color: var(--current-bg-dark); /* Ensure it covers everything */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .canvas-fullscreen canvas {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Keep aspect ratio */
        }

    </style>
    <meta name="description" content="Goatify IA es tu copiloto estratégico, una inteligencia artificial avanzada que combina dirección de proyectos, asistente financiero, y herramientas creativas únicas en el mercado para potenciar tu negocio y productividad.">
    <meta name="keywords" content="Goatify IA, inteligencia artificial, dirección de proyectos, asistente financiero, productividad, automatización de ventas, estrategias de marketing, creación de contenido, SEO, herramientas de IA, negocio digital">
    <meta name="author" content="Goatify IA Team">
    <meta property="og:title" content="Goatify IA - Tu Aliado Estratégico en Productividad y Negocios con IA">
    <meta property="og:description" content="Goatify IA es tu copiloto estratégico, una inteligencia artificial avanzada que combina dirección de proyectos, asistente financiero, y herramientas creativas únicas en el mercado para potenciar tu negocio y productividad.">
    <meta property="og:image" content="./Logos HD.png">
    <meta property="og:url" content="https://www.goatify.app">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Goatify IA - Tu Aliado Estratégico en Productividad y Negocios con IA">
    <meta name="twitter:description" content="Goatify IA es tu copiloto estratégico, una inteligencia artificial avanzada que combina dirección de proyectos, asistente financiero, y herramientas creativas únicas en el mercado para potenciar tu negocio y productividad.">
    <meta name="twitter:image" content="./Logos HD.png">
</head>
<body class="w-screen overflow-x-hidden dark-theme">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script type="text/javascript">
        if (window.netlifyIdentity) {
            netlifyIdentity.init();
        }
    </script>
    <div id="loading-overlay" class="fixed inset-0 bg-bg-dark bg-opacity-95 flex flex-col items-center justify-center z-[100] transition-opacity duration-300">
        <img src="./Logos HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mb-6 animate-pulse" onerror="this.onerror=null;this.src='https://placehold.co/96x96/121212/e0e0e0?text=LOGO';">
        <div class="text-text-light text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3 text-lg font-semibold" data-translate-key="initializing">Inicializando...</p>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden opacity-0 pointer-events-none"></div>

    <div id="app-container" class="flex w-full relative opacity-0 transition-opacity duration-300">
        <aside id="sidebar" class="w-72 flex-shrink-0 flex flex-col transition-transform duration-300 md:translate-x-0 h-full">

            <div id="sidebar-header">
                <div id="logo-space" class="w-16 h-16 rounded-lg mx-auto flex-shrink-0 flex items-center justify-center overflow-hidden cursor-pointer">
                    <img src="./Logos HD.png" alt="Goatify Logo" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                </div>
            </div>

            <div class="flex-shrink-0 px-4 pt-2 pb-4 border-b border-themed">
                 <div class="mb-4">
                    <h3 class="text-xs font-semibold uppercase text-text-medium mb-2 px-2" data-translate-key="workflows">Workflows</h3>
                    <div id="sidebar-top-actions" class="space-y-2">
                        <button data-workflow="project-management" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                            <i class="fas fa-tasks w-6 mr-2"></i>
                           <span class="text-sm font-bold" data-translate-key="wf_pm">Asistente de Proyectos</span>
                       </button>
                       <button data-workflow="financial-assistant" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                            <i class="fas fa-wallet w-6 mr-2"></i>
                           <span class="text-sm font-bold" data-translate-key="wf_financial">Asistente Financiero</span>
                       </button>
                        <button data-workflow="notepad-app" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                            <i class="fas fa-book-open w-6 mr-2"></i>
                           <span class="text-sm font-bold" data-translate-key="wf_notepad">Bloc de Notas</span>
                       </button>
                   </div>
                </div>
            </div>

            <div id="sidebar-scrollable-content">
                <div id="sidebar-content-main" class="flex flex-col">
                    <div class="flex-grow">
                        <div class="mb-4">
                             <div id="workflows-container" class="space-y-1">
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-brain w-6 mr-2"></i>
                                        <span class="text-sm font-bold" data-translate-key="wf_expert">Asistente Experto</span>
                                    </div>
                                     <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="decision-lab" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_expert_1">Laboratorio de Decisiones</button>
                                        <button data-workflow="conflict-resolution" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_expert_2">Resolución de Conflictos</button>
                                     </div>
                                </div>
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-share-alt w-6 mr-2"></i>
                                        <span class="text-sm font-bold" data-translate-key="wf_social">Potenciador de Redes Sociales</span>
                                     </div>
                                    <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="create-full-post" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_1">Crear un Post Completo</button>
                                         <button data-workflow="persuasive-copy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_2">Redacción de Copys</button>
                                        <button data-workflow="post-ideas" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_3">Lluvia de Ideas para Posts</button>
                                         <button data-workflow="brand-strategy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_social_4">Definir Estrategia de Marca</button>
                                    </div>
                                </div>
                                 <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-chart-pie w-6 mr-2"></i>
                                        <span class="text-sm font-bold" data-translate-key="wf_business">Análisis de Negocio</span>
                                    </div>
                                     <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="competitor-analysis" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_1">Análisis de tu Competencia</button>
                                         <button data-workflow="buyer-persona" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_2">Definir mi Cliente Ideal</button>
                                        <button data-workflow="brand-names" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_business_3">Lluvia de Nombres para Marca</button>
                                     </div>
                                </div>
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-headset w-6 mr-2"></i>
                                        <span class="text-sm font-bold" data-translate-key="wf_sales">Comunicación y Ventas</span>
                                     </div>
                                    <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="sales-assistant" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_1">Ventas para tu Negocio</button>
                                        <button data-workflow="email-writing" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_2">Redacción de Email</button>
                                        <button data-workflow="design-web" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_3">Diseño Web</button>
                                         <button data-workflow="social-skills" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_sales_4">Mejorar Habilidades Sociales</button>
                                    </div>
                                 </div>
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-language w-6 mr-2"></i>
                                        <span class="text-sm font-bold" data-translate-key="wf_english_teacher">English Teacher</span>
                                    </div>
                                       <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="english-teacher-translate" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_1">Traducir/Corregir Texto</button>
                                         <button data-workflow="english-teacher-vocabulary" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_2">Aprender Vocabulario Nuevo</button>
                                        <button data-workflow="english-teacher-practice" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_3">Practicar Conversación</button>
                                     </div>
                                </div>
                            </div>
                        </div>

                        <div id="actions-category" class="actions-category border-t border-themed pt-4 open">
                            <div class="actions-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                <i class="fas fa-chevron-right actions-arrow mr-2 transition-transform text-xs"></i>
                                <span class="text-sm font-bold" data-translate-key="quick_actions">Acciones Rápidas</span>
                            </div>
                            <div class="actions-content pl-4 pt-2 space-y-2 block">
                                <button id="new-chat-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors w-full"><i class="fas fa-plus mr-2"></i><span data-translate-key="new_chat">Nuevo Chat</span></button>
                                <button id="new-folder-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg bg-input w-full"><i class="fas fa-folder-plus mr-2"></i><span data-translate-key="new_folder">Nueva Carpeta</span></button>
                            </div>
                        </div>

                        <div id="folders-category" class="folders-category border-t border-themed pt-4 open">
                            <div class="folders-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                <i class="fas fa-chevron-right folder-arrow mr-2 transition-transform text-xs"></i>
                                <span class="text-sm font-bold" data-translate-key="my_projects">Mis Proyectos</span>
                                <button id="add-project-folder-btn" title="Nueva Carpeta de Proyectos" class="ml-2 text-primary hover:text-primary-hover"><i class="fas fa-plus-circle"></i></button>
                            </div>
                            <div id="folders-container" class="folders-content pl-4 pt-2 space-y-1 block"></div>
                        </div>

                        <div class="border-t border-themed pt-2 mt-4">
                             <button id="select-chats-btn" class="w-full text-sm p-2 rounded hover:bg-light flex items-center justify-center">
                                <i class="fas fa-tasks mr-2"></i><span data-translate-key="select_chats">Seleccionar Múltiples Chats</span>
                            </button>
                         </div>
                        <div id="delete-mode-controls" class="hidden flex space-x-2 my-2">
                            <button id="delete-selected-btn" class="flex-1 flex items-center justify-center font-semibold p-2 rounded-lg bg-red-600 text-white disabled:opacity-50" disabled><i class="fas fa-trash-alt mr-2"></i><span data-translate-key="delete">Borrar</span></button>
                             <button id="cancel-select-mode-btn" class="p-2 rounded-lg bg-gray-600 text-white"><i class="fas fa-times"></i></button>
                        </div>
                        <div id="sidebar-content" class="pr-1 space-y-1"></div>
                    </div>
                </div>

                <div id="sidebar-footer">
                    <div class="flex flex-col space-y-2 border-t border-themed pt-4">
                        <button id="web-launch-offer-btn" class="w-full text-left font-semibold text-sm p-3 rounded-lg btn-primary transition-colors animate-pulse" data-translate-key="web_offer">
                           🚀 ¡Lanza tu Negocio, te regalamos una pg web Gratis con tu suscripcion!
                        </button>
                        <div id="upgrade-plan-container" class="hidden text-center p-2 bg-yellow-400 rounded-lg">
                            <button id="upgrade-plan-btn" class="text-xs font-semibold text-black hover:text-gray-800">
                                <i class="fas fa-rocket mr-1"></i>
                               <span data-translate-key="upgrade_plan">Mejorar Plan</span>
                            </button>
                        </div>
                        <div class="text-center p-2 bg-input rounded-lg">
                            <a href="#" id="free-guides-link" class="text-xs font-semibold text-primary hover:underline">
                                <i class="fas fa-book-open mr-1"></i>
                               <span data-translate-key="free_guides">Guías de IA Gratis</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sidebar-bottom-fixed">
                 <div id="user-section">
                    <div id="login-view" class="hidden">
                        <button id="login-btn" class="w-full flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-sign-in-alt mr-2"></i><span data-translate-key="login">Iniciar Sesión</span></button>
                    </div>
                     <div id="user-menu-view" class="hidden relative">
                        <button id="user-menu-btn" class="w-full flex items-center text-left p-2 rounded-lg hover:bg-light transition-colors">
                            <span id="user-email" class="flex-grow truncate text-sm font-semibold"></span>
                            <i id="user-settings-icon" class="fas fa-cog text-text-medium hover:text-primary cursor-pointer ml-2"></i>
                        </button>
                        <div id="user-menu-popup" class="absolute bottom-full left-0 w-full mb-2 rounded-lg p-2 border border-themed shadow-lg hidden">
                            <button id="settings-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-cog w-6 mr-2"></i><span data-translate-key="settings">Configuración</span></button>
                             <button id="logout-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-sign-out-alt w-6 mr-2"></i><span data-translate-key="logout">Cerrar Sesión</span></button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="sidebar-toggle-arrow">
                <i class="fas fa-chevron-left"></i> </div>
        </aside>

        <main id="main-chat-area" class="flex-1 flex flex-col h-full overflow-hidden">
            <header class="flex items-center justify-between p-3 md:p-4 border-b border-themed flex-shrink-0 relative">
                <div id="main-header-content" class="flex items-center justify-between w-full">
                    <div class="flex items-center flex-shrink-0 header-left-icons">
                        <button id="menu-toggle" class="md:hidden text-xl p-2"><i class="fas fa-bars"></i></button>
                        <button id="new-chat-icon-btn" title="Nuevo Chat" class="text-xl p-1 hover:opacity-80 transition-opacity"><i class="fas fa-plus-circle text-primary"></i></button>
                        <button id="new-folder-icon-btn" title="Nueva Carpeta" class="text-xl p-1 hover:opacity-80 transition-opacity"><i class="fas fa-folder-plus text-primary"></i></button>
                    </div>

                    <div id="desktop-chat-title-wrapper" class="hidden sm:flex items-center justify-center group cursor-pointer mx-2 flex-1 min-w-0" title="Renombrar Chat">
                        <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                        <h1 id="chat-title" class="text-lg font-semibold truncate">Goatify IA</h1>
                        <button id="motivation-btn-header" title="Motivación Diaria" class="text-yellow-400 hover:text-yellow-300 p-2 transition-colors ml-2"><i class="fas fa-lightbulb text-xl"></i></button>
                        <button id="calendar-btn" title="Mi Calendario y Tareas" class="text-sky-400 hover:text-sky-300 p-1 transition-colors notification-bell-icon">
                            <i class="fas fa-calendar-days text-lg"></i>
                            <span id="notification-badge" class="notification-badge hidden">0</span>
                        </button>
                    </div>

                    <div class="flex items-center space-x-1 sm:space-x-2 header-right-icons">
                        <div id="message-counter-wrapper" class="flex items-center space-x-2 text-xs font-mono whitespace-nowrap block mx-2 cursor-pointer">
                             <div id="plan-credits-info" class="flex items-center">
                                <i class="fas fa-trophy text-primary mr-1 text-base"></i> <span id="plan-credits-display">0/0</span>
                            </div>
                            <div id="reward-credits-info" class="flex items-center">
                                <i class="fas fa-coins text-gold ml-2 mr-1 text-base"></i> <span id="reward-credits-display">0</span>
                            </div>
                        </div>
                        <button id="services-menu-btn" title="Potenciar mi Negocio" class="relative text-xl p-1 hover:opacity-80 transition-opacity flex items-center gap-2">
                            <i class="fas fa-rocket text-primary"></i>
                            <span class="text-sm font-semibold text-primary hidden md:inline" data-translate-key="solutions">Soluciones</span>
                        </button>
                        <button id="theme-toggle" title="Cambiar Tema" class="text-xl p-1"><i class="fas fa-moon" id="theme-icon"></i></button>
                    </div>
                </div>
                 <div id="services-menu" class="absolute top-full right-4 mt-2 w-80 rounded-xl shadow-lg border border-themed z-30 p-4 origin-top-right">
                    <h4 class="font-bold text-lg mb-1 text-text-light" data-translate-key="ally_title">Somos tu Aliado Estratégico</h4>
                    <p class="text-sm text-text-medium mb-4" data-translate-key="ally_desc">Goatify no es solo un chat. Somos una IA personalizada con un equipo de expertos listos para ayudarte a escalar tu negocio.</p>
                    <ul class="space-y-3">
                        <li><a id="sol-web" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Páginas Web que Convierten</p><p class="text-sm text-text-medium">Transformamos tus ideas en webs y tiendas online diseñadas para vender.</p></a></li>
                         <li><a id="sol-auto" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Ventas en Piloto Automático</p><p class="text-sm text-text-medium">Implementamos sistemas de IA para automatizar tus ventas y procesos clave.</p></a></li>
                        <li><a id="sol-social" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Avatares para Redes Sociales</p><p class="text-sm text-text-medium">Creamos avatares hiperrealistas con IA y estrategias de contenido que captan la atención.</p></a></li>
                         <li><a id="sol-consult" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Escala tu Empresa con IA</p><p class="text-sm text-text-medium">Obtén consultoría experta para integrar la IA en el ADN de tu negocio.</p></a></li>
                    </ul>
                </div>
            </header>
            <div class="block sm:hidden text-center py-1.5 border-b border-themed bg-current-bg-dark shadow-sm flex-shrink-0">
                <div id="mobile-chat-title-wrapper" class="flex items-center justify-center group cursor-pointer px-4 relative" title="Renombrar Chat">
                    <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                    <h2 id="mobile-chat-title" class="text-sm font-semibold truncate">Goatify IA</h2>
                    <button id="motivation-btn-mobile" title="Motivación Diaria" class="text-yellow-400 hover:text-yellow-300 p-2 transition-colors"><i class="fas fa-lightbulb text-lg"></i></button>
                    <button id="calendar-btn-mobile" title="Mi Calendario y Tareas" class="text-sky-400 hover:text-sky-300 p-1 transition-colors notification-bell-icon">
                        <i class="fas fa-calendar-days text-lg"></i>
                        <span id="notification-badge-mobile" class="notification-badge hidden">0</span>
                    </button>
                </div>
             </div>

            <div id="view-container" class="flex-1 overflow-hidden relative">
                <div id="chat-messages" class="h-full overflow-y-auto p-3 sm:p-6">
                    <div class="flex justify-center items-center h-full" id="initial-message-container">
                        <div id="welcome-message-wrapper" class="text-center text-text-medium">
                            <img src="./Logos HD.png" alt="Goatify Logo" class="w-24 h-24 object-contain mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                            <h2 class="text-3xl font-bold text-text-light">Goatify IA</h2>
                            <div id="personalized-welcome" class="hidden"><p class="text-lg mt-1"><span data-translate-key="welcome_user">¡Hola, </span><span id="user-name"></span><span data-translate-key="welcome_user_2">! Hoy es un gran día para crear algo increíble.</span></p></div>
                            <div id="generic-welcome" class="hidden"><p class="text-xl" data-translate-key="welcome_guest">¿Cómo puedo ayudarte hoy?</p></div>
                        </div>
                    </div>
                </div>

                <!-- START: Translator View -->
                <div id="translator-view" class="hidden">
                    <div id="translator-panels">
                        <!-- Panel de Texto Original -->
                        <div class="translator-panel">
                            <h3 class="text-lg font-bold mb-2 flex items-center justify-between">
                                <span data-translate-key="original_text_header">Texto Original (Español)</span>
                                <i class="fas fa-paste p-2 rounded-md hover:bg-current-bg-dark cursor-pointer" id="paste-to-translator-btn" title="Pegar texto"></i>
                            </h3>
                            <!-- Updated placeholder to be bold -->
                            <textarea id="translator-input-es" placeholder="**Pega o escribe aquí lo que quieras y traduce correctamente al ingles:**" class="translator-textarea"></textarea>
                        </div>
                
                        <!-- Controles Centrales -->
                        <div id="translator-controls">
                            <div class="model-selector-wrapper mb-2 md:mb-0">
                                <!-- Changed options to include GOAT X and allow selection -->
                                <select id="translator-model-selector" class="rounded-md py-1 pl-1.5 pr-8 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                    <option value="gpt-3.5-turbo-1106" data-translate-key="model_general">GOAT X</option>
                                    <option value="gpt-4o" class="goat-x-pro-model">GOAT X PRO</option>
                                </select>
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                            <button id="translate-btn" class="btn-primary p-3 rounded-full font-bold transition-transform hover:scale-105" data-translate-key="translate_button" title="Traducir">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                
                        <!-- Panel de Texto Traducido -->
                        <div class="translator-panel">
                            <h3 class="text-lg font-bold mb-2 flex items-center justify-between">
                                <span data-translate-key="translated_text_header">Texto Traducido (Inglés)</span>
                                <i class="fas fa-copy p-2 rounded-md hover:bg-current-bg-dark cursor-pointer" id="copy-from-translator-btn" title="Copiar traducción"></i>
                            </h3>
                            <textarea id="translator-output-en" readonly placeholder="La traducción aparecerá aquí..." class="translator-textarea"></textarea>
                        </div>
                    </div>
                </div>
                <!-- END: Translator View -->


                <div id="notepad-view-container" class="hidden">
                    <div id="notes-list-panel">
                        <div id="notes-list-header" class="flex items-center gap-2">
                            <button id="add-new-note-btn" class="w-full btn-primary text-sm flex items-center justify-center gap-2"><i class="fas fa-file-alt"></i><span data-translate-key="new_note">Nueva Nota</span></button>
                            <button id="add-new-drawing-btn" class="p-2 bg-input rounded-md" title="Nuevo Dibujo" data-translate-key="new_drawing_title"><i class="fas fa-paint-brush"></i></button>
                        </div>
                    </div>
                    <div id="notepad-editor-and-chat-container">
                        <div id="note-editor-panel">
                             <div id="note-editor-toolbar">
                                <button id="note-back-btn" title="Volver a la lista" class="p-2 hidden mr-2" data-translate-key="back_to_list"><i class="fas fa-arrow-left"></i></button>
                                <input id="note-title-input" type="text" placeholder="Título de la nota..." data-translate-key="note_title_placeholder">
                                <div id="text-tools" class="flex items-center gap-2 ml-auto">
                                    <div class="text-editor-controls">
                                        <!-- New Text Tools -->
                                        <button id="copy-btn" title="Copiar" data-translate-key="copy_text"><i class="fas fa-copy"></i></button>
                                        <button id="cut-btn" title="Cortar" data-translate-key="cut_text"><i class="fas fa-cut"></i></button>
                                        <button id="paste-btn" title="Pegar" data-translate-key="paste_text"><i class="fas fa-paste"></i></button>
                                        <button id="bold-btn" title="Negrita" data-translate-key="bold_text"><i class="fas fa-bold"></i></button>
                                        <button id="italic-btn" title="Cursiva" data-translate-key="italic_text"><i class="fas fa-italic"></i></button>
                                        <button id="underline-btn" title="Subrayar" data-translate-key="underline_text"><i class="fas fa-underline"></i></button>
                                        <button id="align-left-btn" title="Alinear Izquierda"><i class="fas fa-align-left"></i></button>
                                        <button id="align-center-btn" title="Alinear Centro"><i class="fas fa-align-center"></i></button>
                                        <button id="align-right-btn" title="Alinear Derecha"><i class="fas fa-align-right"></i></button>
                                        <button id="justify-btn" title="Justificar"><i class="fas fa-align-justify"></i></button>
                                        <select id="font-family-selector" class="rounded-md py-1 px-2 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                            <option value="Montserrat, sans-serif">Montserrat</option>
                                            <option value="Arial, sans-serif">Arial</option>
                                            <option value="Verdana, sans-serif">Verdana</option>
                                            <option value="Georgia, serif">Georgia</option>
                                            <option value="Courier New, monospace">Courier New</option>
                                        </select>
                                    </div>
                                    <button id="add-checklist-item-btn" title="Añadir Checklist" data-translate-key="add_checklist"><i class="fas fa-check-square"></i></button>
                                </div>
                                <div id="drawing-tools" class="hidden items-center gap-2">
                                    <button id="tool-pencil" class="drawing-tool active" title="Lápiz" data-translate-key="tool_pencil"><i class="fas fa-pencil-alt"></i></button>
                                    <button id="tool-eraser" class="drawing-tool" title="Borrador" data-translate-key="tool_eraser"><i class="fas fa-eraser"></i></button>
                                    <button id="tool-line" class="drawing-tool" title="Línea" data-translate-key="drawing_tool_line"><i class="fas fa-slash"></i></button>
                                    <button id="tool-rect" class="drawing-tool" title="Rectángulo" data-translate-key="drawing_tool_rect"><i class="fas fa-square"></i></button>
                                    <button id="tool-circle" class="drawing-tool" title="Círculo" data-translate-key="drawing_tool_circle"><i class="fas fa-circle"></i></button>
                                    <input type="color" id="drawing-color" class="drawing-tool" title="Color" value="#000000" data-translate-key="drawing_color"> <input type="range" id="drawing-line-width" class="drawing-tool" min="1" max="50" value="3" title="Grosor" data-translate-key="drawing_thickness">
                                    <button id="clear-canvas-btn" class="drawing-tool" title="Limpiar todo" data-translate-key="clear_all"><i class="fas fa-trash-alt"></i></button>
                                    <button id="undo-drawing-btn" class="drawing-tool" title="Deshacer" data-translate-key="undo_drawing"><i class="fas fa-undo"></i></button>
                                    <button id="redo-drawing-btn" class="drawing-tool" title="Rehacer" data-translate-key="redo_drawing"><i class="fas fa-redo"></i></button>
                                    <button id="drawing-fullscreen-btn" title="Pantalla Completa"><i class="fas fa-expand"></i></button>
                                </div>
                                 <!-- New Export/Share Buttons -->
                                <button id="export-pdf-btn" title="Exportar como PDF" class="p-2 ml-2" data-translate-key="export_pdf_btn"><i class="fas fa-file-pdf"></i></button>
                                <button id="share-note-btn" title="Compartir / Colaborar" class="p-2 ml-2" data-translate-key="share_note_btn"><i class="fas fa-user-plus"></i></button>
                                <button id="delete-note-btn" title="Eliminar Nota" class="p-2 text-red-500 hover:text-red-400 transition-colors" data-translate-key="delete_note_btn"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <div id="note-content-area" class="relative flex-grow">
                                <div id="note-content-editor" contenteditable="true" class="h-full"></div>
                                <canvas id="note-canvas" class="absolute top-0 left-0 hidden"></canvas>
                            </div>
                        </div>
                        <div id="notepad-chat-container" class="hidden md:flex collapsed">
                            <div id="notepad-chat-header" class="flex justify-between items-center cursor-pointer p-2">
                                <h3 class="text-lg font-semibold text-primary" data-translate-key="writing_assistant">Asistente de Redacción</h3>
                                <button id="notepad-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-up"></i></button>
                            </div>
                            <div class="notepad-chat-body">
                                <div id="notepad-chat-messages" class="chat-bubble-bot"></div>
                                <div class="mt-auto pt-2">
                                    <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                                        <div class="flex items-center space-x-2">
                                           <label for="notepad-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1" data-translate-key="model">Modelo:</label>
                                            <div class="model-selector-wrapper">
                                               <select id="notepad-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                                    <option value="gpt-3.5-turbo-1106" data-translate-key="model_general">GOAT X</option>
                                                    <option value="sonar" data-translate-key="model_web">Búsqueda Web</option>
                                                    <option value="gpt-4o" class="goat-x-pro-model">GOAT X PRO</option>
                                                </select>
                                                 <i class="fas fa-chevron-down text-xs"></i>
                                           </div>
                                        </div>
                                   </div>
                                    <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                        <textarea id="notepad-msg" placeholder="Pide ideas, resúmenes, o correcciones..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm" data-translate-key="notepad_placeholder"></textarea>
                                        <button id="notepad-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="financial-assistant-view" class="hidden h-full"></div>

                <div id="project-management-view" class="hidden p-4 h-full">
                    <div id="project-board-container" class="flex flex-col h-full">
                        <div class="flex flex-wrap justify-between items-center mb-4 flex-shrink-0 gap-2">
                            <h2 id="project-view-title" class="text-2xl font-bold">Nombre del Proyecto</h2>
                             <div id="project-tag-filter-container" class="relative">
                                <button id="tag-filter-btn" class="p-2 rounded-md bg-input text-sm"><i class="fas fa-tag mr-1"></i> <span data-translate-key="filter_tags">Filtrar</span></button>
                                <div id="tag-filter-dropdown" class="hidden absolute right-0 mt-1 p-2 rounded-md shadow-lg w-48"></div>
                             </div>
                        </div>
                         <div class="flex items-center space-x-2 project-view-controls mb-4 flex-shrink-0">
                            <span class="text-sm text-text-medium hidden sm:inline" data-translate-key="views">Vistas:</span>
                             <button id="view-toggle-kanban" class="px-3 py-1 text-sm rounded-md" data-translate-key="kanban">Kanban</button>
                            <button id="view-toggle-list" class="px-3 py-1 text-sm rounded-md" data-translate-key="list">Lista</button>
                            <button id="add-task-list-view-btn" title="Añadir Tarea" class="hidden ml-auto p-2 rounded-md bg-primary text-white" data-translate-key="add_task_btn_short"><i class="fas fa-plus"></i></button>
                            <button id="project-calendar-btn" title="Calendario del Proyecto" class="text-sky-400 hover:text-sky-300 p-2 transition-colors ml-auto" data-translate-key="project_calendar_title"><i class="fas fa-calendar-alt text-xl"></i></button>
                        </div>
                         <div id="kanban-view" class="hidden flex-1">
                            </div>
                        <div id="list-view" class="hidden flex-1 flex-col">
                        </div>
                        <div id="list-view-mobile" class="hidden flex-1 overflow-y-auto">
                        </div>
                    </div>
                    <div id="project-chat-container">
                         <div id="project-chat-container-header" class="flex justify-between items-center cursor-pointer p-2">
                            <h3 class="text-lg font-semibold text-primary" data-translate-key="project_assistant">Asistente del Proyecto</h3>
                            <button id="project-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-up"></i></button>
                        </div>
                         <div class="project-chat-body">
                            <div id="project-chat-messages" class="chat-bubble-bot"></div>
                            <div id="project-input-area" class="mt-auto pt-2">
                                 <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                                     <div class="flex items-center space-x-2">
                                        <label for="project-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1" data-translate-key="model">Modelo:</label>
                                         <div class="model-selector-wrapper">
                                            <select id="project-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                                <option value="gpt-3.5-turbo-1106" data-translate-key="model_general">GOAT X</option>
                                                <option value="sonar" data-translate-key="model_web">Búsqueda Web</option>
                                                <option value="gpt-4o" class="goat-x-pro-model">GOAT X PRO</option>
                                             </select>
                                              <i class="fas fa-chevron-down text-xs"></i>
                                        </div>
                                     </div>
                                </div>
                                 <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                     <textarea id="project-msg" placeholder="Deja que Goatify organice tu proyecto..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm" data-translate-key="project_chat_placeholder"></textarea>
                                    <button id="project-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="input-area" class="p-2 sm:p-4 border-t border-themed flex-shrink-0">
                <div id="file-preview-area" class="mb-2 space-y-2 px-1 sm:px-0 hidden"> <!-- Initially hidden -->
                     <div id="image-preview-container" class="flex items-center gap-2 p-2 rounded-lg bg-current-bg-medium border border-themed hidden">
                        <img id="image-preview" src="#" alt="Image Preview" class="max-h-12 w-auto rounded-md object-cover">
                        <span id="image-name" class="text-xs text-text-medium truncate flex-grow"></span>
                         <button id="clear-image-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                    <div id="pdf-preview-container" class="flex items-center gap-2 p-2 rounded-lg bg-current-bg-medium border border-themed hidden">
                        <i class="fas fa-file-pdf text-red-500 text-xl"></i>
                         <div class="flex-grow min-w-0">
                            <p id="pdf-name" class="font-medium truncate"></p>
                            <p id="pdf-status" class="text-xxs font-mono"></p>
                         </div>
                        <button id="clear-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                </div>
                <div id="input-area-model-row" class="cool-light-effect">
                    <div class="flex items-center">
                        <label for="model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1" data-translate-key="model">Modelo:</label>
                        <div class="model-selector-wrapper">
                            <select id="model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                <option value="gpt-3.5-turbo-1106" data-translate-key="model_general">Chat</option>
                                <option value="sonar" data-translate-key="model_web">Búsqueda Web</option>
                                <option value="gpt-4o" class="goat-x-pro-model">GOAT X PRO</option>
                            </select>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                    <div class="action-buttons-container">
                        <div id="voice-selector-container" class="items-center space-x-2">
                            <label for="voice-selector" class="font-medium text-xs text-text-medium" data-translate-key="voice">Voz:</label>
                            <div class="model-selector-wrapper">
                                <select id="voice-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light w-24"></select>
                            </div>
                        </div>
                        <button id="image-gen-btn" title="Crear Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium" data-translate-key="create_image_title"><i class="fas fa-paint-brush text-lg"></i></button>
                        <button id="pdf-upload-btn" title="Subir PDF" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium" data-translate-key="upload_pdf_title"><i class="fa fa-file-pdf text-lg"></i></button>
                        <button id="image-upload-btn" title="Subir Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium" data-translate-key="upload_image_title"><i class="fa fa-image text-lg"></i></button>
                    </div>
                </div>
                <div id="input-area-chat-row" class="relative input-wrapper">
                    <input type="file" id="pdf-upload" accept=".pdf,application/pdf" class="hidden"><input type="file" id="image-upload" accept="image/*" class="hidden">
                    <button id="mic-btn" title="Activar Micrófono" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium" data-translate-key="activate_mic"><i class="fa fa-microphone text-xl"></i></button>
                     <button id="tts-toggle" title="Activar/Desactivar Voz" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium" data-translate-key="toggle_voice"><i class="fa fa-volume-mute text-xl"></i></button>
                    <textarea id="msg" placeholder="Escribe tu mensaje..." class="flex-1 bg-transparent p-2 h-12 max-h-32 resize-none outline-none placeholder-themed" rows="1" data-translate-key="placeholder_main"></textarea>
                    <button id="send" title="Enviar" class="p-2 sm:p-4 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i id="send-icon" class="fa fa-paper-plane text-xl"></i></button>
                 </div>
                <div id="contextual-footer" class="text-center text-xs text-text-medium mt-2 px-2 h-4"></div>
            </div>
        </main>
    </div>
    <div id="in-app-notification">
        <div id="in-app-notification-header">
            <h4 id="in-app-notification-title"></h4>
            <button id="in-app-notification-close" class="text-text-medium hover:text-text-light text-2xl leading-none">&times;</button>
        </div>
        <p id="in-app-notification-body"></p>
    </div>

    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <div id="modal-body" class="mb-4 text-text-medium text-sm"></div>
            <div id="modal-buttons-container" class="flex justify-end space-x-2">
                 </div>
        </div>
    </div>

    <!-- New Credit Limit Modal - For Guest Usage Limits -->
    <div id="credit-limit-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative text-center">
            <i class="fas fa-gem text-primary text-4xl mb-4"></i>
            <h3 class="text-2xl font-bold mb-4" data-translate-key="login_for_credits_title">¡Más Poder para Ti!</h3>
            <p class="text-lg text-text-light mb-6" data-translate-key="login_for_credits_body">Has agotado tus 5 créditos de prueba. ¡No te preocupes! <strong>Inicia sesión para obtener 100 créditos más</strong> y seguir creando. O, si lo prefieres, explora nuestros planes para un acceso ilimitado.</p>
            <div class="flex justify-center space-x-4">
                <button id="credit-modal-login-btn" class="btn-primary px-6 py-2 rounded-lg font-semibold" data-translate-key="login_now_btn">Iniciar Sesión</button>
                <button id="credit-modal-close-btn" class="px-6 py-2 rounded-lg bg-gray-600 text-white font-semibold" data-translate-key="view_plans_btn">Ver Planes</button>
            </div>
        </div>
    </div>

    <div id="motivation-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative text-center">
            <i class="fas fa-lightbulb text-4xl text-yellow-400 mb-4"></i>
            <h3 id="motivation-title" class="text-2xl mb-4" data-translate-key="motivation_title">Dosis de Motivación</h3>
            <p id="motivation-quote" class="text-lg text-text-light mb-6 min-h-[50px]"></p>
            <div class="flex items-center justify-center mb-6">
                <label for="motivation-toggle" class="flex items-center cursor-pointer">
                    <span class="mr-3 text-text-light font-medium" data-translate-key="motivation_notifications">
                        Notificaciones periódicas
                    </span>
                    <div class="relative">
                        <input type="checkbox" id="motivation-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                    </div>
                </label>
            </div>
            <button id="close-motivation-modal" class="btn-primary px-6 py-2 rounded-lg" data-translate-key="understood_btn">¡Entendido!</button>
        </div>
    </div>

    <div id="pricing-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-5xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-6">
                <h2 class="text-3xl md:text-4xl font-extrabold text-center flex-grow" data-translate-key="plans_title">Planes Goatify</h2>
                 <button id="close-pricing-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="modal-content-body flex-grow overflow-y-auto px-2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-text-light">
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">Free</h3>
                        <p class="text-5xl font-extrabold my-3">$0</p>
                        <p class="text-sm text-text-medium mb-4" data-translate-key="plan_free_sub">Para Siempre</p>
                         <ul class="text-sm space-y-2 mb-4 text-left">
                            <li><i class="fas fa-check-circle mr-2"></i>5 Créditos de Prueba</li>
                            <li><i class="fas fa-check-circle mr-2"></i>Acceso a Modelos Básicos</li>
                             <li><i class="fas fa-check-circle mr-2"></i>Workflows Limitados</li>
                        </ul>
                        <button id="free-plan-button" class="mt-auto w-full p-3 rounded-lg font-semibold border-2 border-primary text-primary hover:bg-primary hover:text-white transition-colors" data-translate-key="plan_free_cta">Tu Plan Actual</button>
                     </div>
                    <div class="plan-card border-2 rounded-xl p-6 flex flex-col bg-current-bg-dark plan-card-highlight">
                        <h3 class="text-2xl font-bold">GOAT <span class="text-primary">BOOST</span></h3>
                         <p class="text-5xl font-extrabold my-3">$7<span class="text-lg font-medium text-text-medium">/mes</span></p>
                        <button class="w-full p-2 text-sm rounded-lg font-semibold border border-primary text-primary hover:bg-primary hover:text-white transition-colors mb-4 plan-details-toggle" data-translate-key="view_details">Ver Detalles</button>
                        <div class="plan-details text-sm text-left">
                             <ul class="space-y-2 mb-4 plan-feature-list">
                                <li><i class="fas fa-check-circle mr-2"></i><strong>500 Créditos/mes</strong></li>
                                <li><i class="fas fa-check-circle mr-2"></i>Acceso a <strong>todos los modelos de IA</strong></li>
                                 <li><i class="fas fa-check-circle mr-2"></i>Acceso a <strong>todos los Workflows</strong></li>
                                <li><i class="fas fa-check-circle mr-2"></i>Soporte Prioritario</li>
                            </ul>
                         </div>
                        <button data-plan="boost" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_boost_cta">Obtener Boost</button>
                    </div>
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">GOAT <span class="text-primary">PRO</span></h3>
                        <p class="text-5xl font-extrabold my-3">$17<span class="text-lg font-medium text-text-medium">/mes</span></p>
                         <button class="w-full p-2 text-sm rounded-lg font-semibold border border-primary text-primary hover:bg-primary hover:text-white transition-colors mb-4 plan-details-toggle" data-translate-key="view_details">Ver Detalles</button>
                        <div class="plan-details text-sm text-left">
                            <ul class="space-y-2 mb-4 plan-feature-list">
                                 <li><i class="fas fa-check-circle mr-2"></i><strong>2000 Créditos/mes</strong></li>
                                <li><i class="fas fa-check-circle mr-2"></i>Todo lo del plan BOOST</li>
                                <li><i class="fas fa-check-circle mr-2 text-gold"></i><strong>¡Te construimos tu Página Web!</strong></li>
                                 <li><i class="fas fa-check-circle mr-2"></i>Consultoría de IA</li>
                                <li><i class="fas fa-check-circle mr-2"></i>Acceso a Guías Premium</li>
                            </ul>
                         </div>
                        <button data-plan="pro" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_pro_cta">Quiero mi Plan Pro + Web</button>
                    </div>
                </div>
             </div>
        </div>
    </div>

    <div id="html-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full h-full max-w-4xl flex flex-col relative">
            <div class="modal-header">
                <h3 class="text-lg font-bold" data-translate-key="preview">Vista Previa</h3>
                <button id="close-html-preview-modal" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <iframe id="html-preview-iframe" class="w-full flex-grow border-2 border-themed rounded-b-lg bg-white"></iframe>
            <div id="preview-actions">
                <button id="download-html-btn" class="btn-primary p-2 rounded-lg text-sm"><i class="fas fa-download mr-1"></i> <span data-translate-key="download_html">Descargar HTML</span></button>
                <button id="copy-html-btn" class="btn-primary p-2 rounded-lg text-sm"><i class="fas fa-copy mr-1"></i> <span data-translate-key="copy_code">Copiar Código</span></button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-lg p-6 relative">
             <h3 class="text-lg font-bold mb-4" data-translate-key="settings">Configuración</h3>
            <div class="space-y-4 text-sm max-h-[70vh] overflow-y-auto pr-2">
                <div>
                    <p class="font-semibold" data-translate-key="settings_email">Correo Electrónico:</p>
                    <p id="settings-user-email" class="text-text-medium"></p>
                 </div>
                <div>
                    <p class="font-semibold" data-translate-key="settings_plan">Plan de Suscripción:</p>
                    <p id="settings-user-plan" class="text-text-medium"></p>
                    <button id="settings-upgrade-plan-btn" class="text-primary hover:underline mt-1 text-xs" data-translate-key="upgrade_plan">Mejorar Plan</button>
                 </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_fontsize">Tamaño de Letra:</p>
                    <input type="range" id="font-size-slider" min="14" max="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg dark:bg-gray-700">
                    <span id="font-size-value" class="text-xs text-text-medium">16px</span>
                </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_theme">Personalización:</p>
                    <button id="settings-theme-toggle" class="flex items-center p-2 rounded hover:bg-medium w-full text-left">
                         <i class="fas fa-moon mr-2" id="settings-theme-icon"></i>
                        <span data-translate-key="settings_dark_mode">Modo Oscuro</span>
                    </button>
                </div>
                <div>
                     <div class="flex items-center justify-between">
                        <p class="font-semibold" data-translate-key="settings_notifications">Notificaciones de Tareas:</p>
                        <label for="notifications-toggle" class="inline-flex relative items-center cursor-pointer">
                            <input type="checkbox" id="notifications-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                 </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_lang">Idioma:</p>
                    <select id="language-selector" class="w-full p-2 rounded bg-input border border-themed">
                         <option value="es">Español</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="border-t border-themed pt-4 mt-4">
                     <h4 class="font-semibold mb-2" data-translate-key="settings_integrations">Integraciones</h4>
                     <div class="space-y-2">
                        <button id="connect-google-calendar-btn" class="w-full bg-input p-2 rounded-lg flex items-center justify-start text-left hover:bg-light transition-colors">
                             <i class="fab fa-google mr-3 text-red-500 fa-lg"></i>
                            <div>
                                <span class="font-semibold">Google Calendar</span>
                                 <p class="text-xs text-text-medium" data-translate-key="google_calendar_desc">Sincroniza tus tareas y eventos.</p>
                            </div>
                        </button>
                        </div>
                </div>
                <div>
                    <button id="connect-whatsapp-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center mb-2">
                         <i class="fab fa-whatsapp mr-2"></i><span data-translate-key="settings_whatsapp">Conectarse a WhatsApp</span>
                    </button>
                    <a href="https://calendly.com/goatify" target="_blank" id="schedule-meeting-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar-alt mr-2"></i><span data-translate-key="settings_schedule_meeting">Agendar Reunión</span>
                     </a>
                </div>
            </div>
            <button id="close-settings-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>

    <div id="calendar-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div id="calendar-modal" class="modal-content rounded-lg w-full max-w-4xl p-6 relative">
             <h3 class="text-2xl font-extrabold text-center text-primary mb-4" data-translate-key="calendar_my_calendar">Mi Calendario y Tareas</h3>
             <div class="text-center mb-4">
                <p id="current-date-display" class="text-lg text-text-medium"></p>
                <p id="current-time-display" class="text-xl font-extrabold text-primary animate-pulse"></p>
            </div>
            <div class="calendar-view-toggle mb-4">
                <button id="day-view-btn" data-translate-key="calendar_day_view">Vista de Día</button>
                <button id="week-view-btn" data-translate-key="calendar_week_view">Vista de Semana</button>
                <button id="month-view-btn" class="active" data-translate-key="calendar_month_view">Vista de Mes</button>
             </div>

            <div id="day-view-container">
                 <div class="calendar-header">
                    <button id="prev-day" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-day-display" class="text-xl font-semibold"></h4>
                     <button id="next-day" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="day-view-timeline"></div>
            </div>

            <div id="week-view-container">
                <div class="calendar-header">
                     <button id="prev-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-week-range" class="text-xl font-semibold"></h4>
                    <button id="next-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                 <div id="week-days-content"></div>
            </div>

            <div id="month-view-container">
                <div class="calendar-header">
                    <button id="prev-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-month-year" class="text-xl font-semibold"></h4>
                     <button id="next-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid mb-4">
                    <div class="font-bold text-primary" data-translate-key="calendar_mon">Lun</div>
                     <div class="font-bold text-primary" data-translate-key="calendar_tue">Mar</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_wed">Mié</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_thu">Jue</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_fri">Vie</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_sat">Sáb</div>
                     <div class="font-bold text-primary" data-translate-key="calendar_sun">Dom</div>
                </div>
                <div id="calendar-days-grid" class="calendar-grid"></div>
            </div>

            <div class="mt-6 border-t border-themed pt-4">
                <button id="add-task-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i><span data-translate-key="calendar_add_task_btn">Añadir Tarea</span>
                </button>
            </div>

            <button id="close-calendar-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>
    <div id="task-notification-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-[110] p-4">
        <div class="modal-content text-center rounded-lg w-full max-w-md p-8 relative">
            <h3 id="task-notification-title" class="text-2xl font-bold mb-4"></h3>
            <div id="task-notification-body" class="text-lg text-text-light mb-8"></div>
            <button id="task-notification-close-btn" class="btn-primary px-8 py-3 rounded-lg font-semibold" data-translate-key="done_btn">Listo</button>
        </div>
    </div>


    <div id="gamification-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-4">
                <h2 class="text-3xl font-extrabold text-gold">
                    <i class="fas fa-coins mr-2"></i><span data-translate-key="gamification_title">La Ascensión del G.O.A.T. </span></h2>
                <button id="close-gamification-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>

            <div class="p-4 bg-input rounded-lg mb-4 flex-shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <span id="gamification-level-name" class="font-bold text-xl text-text-light">Nivel 1: Iniciador Digital</span>
                    <div class="text-right">
                        <span id="gamification-xp" class="font-bold text-primary">0 / 100 XP</span>
                         <p id="gamification-credits" class="text-sm text-gold font-semibold"><i class="fas fa-coins mr-1"></i>0 Créditos</p>
                    </div>
                </div>
                <div class="w-full xp-bar-bg rounded-full h-4">
                    <div id="gamification-xp-bar" class="xp-bar-fill h-4 rounded-full" style="width: 0%;"></div>
                 </div>
            </div>

            <div class="flex-grow overflow-hidden flex flex-col">
                <div class="flex-shrink-0 gamification-tabs flex items-center space-x-2">
                    <button class="gamification-tab active" data-tab="racha" data-translate-key="daily_streak_tab">Racha Diaria</button>
                     <button class="gamification-tab" data-tab="misiones" data-translate-key="missions_tab">Misiones</button>
                    <button class="gamification-tab" data-tab="logros" data-translate-key="achievements_tab">Logros</button>
                    <button id="gamification-rules-btn" class="ml-auto text-sm text-text-medium hover:text-primary" data-translate-key="rules_btn"><i class="fas fa-circle-question mr-1"></i> Reglas</button>
                </div>
                <div class="flex-grow overflow-y-auto pt-4">
                     <div id="gamification-tab-racha" class="gamification-tab-content space-y-4">
                        <p class="text-center text-text-medium" data-translate-key="streak_desc">Mantén tu racha para ganar XP, créditos y un cofre especial el día 7.</p>
                         <div id="daily-streak-container" class="grid grid-cols-7 gap-2 md:gap-4 text-center">
                            </div>
                    </div>
                     <div id="gamification-tab-misiones" class="gamification-tab-content hidden space-y-3">
                        </div>
                     <div id="gamification-tab-logros" class="gamification-tab-content hidden">
                        <div id="achievements-container" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                           </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="gamification-rules-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-[60] p-4">
         <div class="modal-content rounded-lg w-full max-w-2xl p-6 relative">
            <h3 class="text-lg font-bold mb-4 text-gold"><i class="fas fa-scroll mr-2"></i><span data-translate-key="rules_title">Reglas de "La Ascensión del GOAT"</span></h3>
            <div class="space-y-4 text-text-medium text-sm max-h-[70vh] overflow-y-auto pr-2">
                <p data-translate-key="rules_intro">¡Bienvenido a tu viaje para convertirte en un G.O.A.T. (Greatest Of All Time) del emprendimiento digital! La lógica es simple: cuanto más usas la plataforma de forma estratégica, más recompensas obtienes.</p>
                <div>
                    <h4 class="font-semibold text-text-light mt-3" data-translate-key="xp_credits_title">1. Puntos de Experiencia (XP) vs. Créditos de Recompensa (🪙)</h4>
                    <p data-translate-key="xp_credits_desc">Existen dos tipos de recompensas:</p>
                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li data-translate-key="xp_desc"><strong>Puntos de Experiencia (XP):</strong> Miden tu progreso y maestría. El XP <strong class="text-primary">nunca se gasta</strong>, solo se acumula para que subas de nivel y desbloquees nuevos títulos.</li>
                        <li data-translate-key="credits_desc"><strong>Créditos de Recompensa (🪙):</strong> Son una <strong class="text-gold">reserva de créditos utilizables</strong> que ganas al completar misiones y rachas. Cuando se agotan los créditos diarios de tu plan, el sistema usará automáticamente estos créditos de recompensa para que puedas seguir trabajando.</li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-semibold text-text-light mt-3" data-translate-key="how_to_level_up_title">2. Cómo Subir de Nivel</h4>
                    <p data-translate-key="how_to_level_up_desc">Acumula suficiente XP para ascender de nivel. Cada nivel representa una nueva etapa en tu dominio del marketing y los negocios con IA.</p>
                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li data-translate-key="level_1">Nivel 1: <strong>Iniciador Digital</strong></li>
                        <li data-translate-key="level_2">Nivel 2: <strong>Creador de Contenido</strong></li>
                         <li data-translate-key="level_3">Nivel 3: <strong>Estratega de Marketing</strong></li>
                        <li data-translate-key="level_4">Nivel 4: <strong>CEO Digital</strong></li>
                        <li data-translate-key="level_5">Nivel 5: <strong>G.O.A.T.</strong></li>
                    </ul>
                </div>
                  <div>
                    <h4 class="font-semibold text-text-light mt-3" data-translate-key="how_to_earn_rewards_title">3. Cómo Ganar Recompensas</h4>
                     <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li data-translate-key="daily_streak_reward"><strong>Racha Diaria:</strong> Cada día consecutivo que entras te da XP y Créditos de Recompensa.</li>
                        <li data-translate-key="goat_chest_reward"><strong>Cofre GOAT (Día 7):</strong> ¡Tu gran recompensa semanal por 7 días de racha! Puede contener una gran cantidad de créditos, <strong>cupones de descuento</strong> para nuestros servicios de implementación (páginas web, automatizaciones) o incluso una <strong>asesoría estratégica GRATIS</strong>.</li>
                        <li data-translate-key="missions_achievements_reward"><strong>Misiones y Logros:</strong> La forma más rápida de ganar grandes bonificaciones de XP y Créditos. Completa tareas específicas para acelerar tu ascenso.</li>
                    </ul>
                </div>
                 <p class="font-bold text-center mt-4 text-lg text-primary" data-translate-key="rules_closing">¡Cada acción cuenta en tu camino a la cima! ¡A por ello!</p>
            </div>
            <button id="close-gamification-rules-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>
//<-- START OF SCRIPT -->
        window.addEventListener('DOMContentLoaded', () => {
            dayjs.extend(window.dayjs_plugin_localizedFormat);
            dayjs.extend(window.dayjs_plugin_isoWeek);

            // Object containing all translations for Spanish and English
            const translations = {
                es: {
                    initializing: "Inicializando...", new_chat: "Nuevo Chat", new_folder: "Nueva Carpeta",
                    web_offer: "🚀 ¡Lanza tu Negocio, te regalamos una pg web Gratis con tu suscripcion!",
                     upgrade_plan: "Mejorar Plan", free_guides: "Guías de IA Gratis", workflows: "Workflows",
                    wf_pm: "Asistente de Proyectos", wf_financial: "Asistente Financiero", wf_notepad: "Bloc de Notas",
                    wf_expert: "Asistente Experto", wf_expert_1: "Laboratorio de Decisiones", wf_expert_2: "Resolución de Conflictos",
                    wf_social: "Potenciador de Redes Sociales", wf_social_1: "Crear un Post Completo", wf_social_2: "Redacción de Copys",
                     wf_social_3: "Lluvia de Ideas para Posts", wf_social_4: "Definir Estrategia de Marca",
                    wf_business: "Análisis de Negocio", wf_business_1: "Análisis de tu Competencia", wf_business_2: "Definir mi Cliente Ideal",
                    wf_business_3: "Lluvia de Nombres para Marca", wf_sales: "Comunicación y Ventas", wf_sales_1: "Ventas para tu Negocio",
                     wf_sales_2: "Redacción de Email", wf_sales_3: "Diseño Web", wf_sales_4: "Mejorar Habilidades Sociales",
                    wf_english_teacher: "English Teacher", wf_eng_1: "Traducir/Corregir Texto",
                    wf_eng_2: "Aprender Vocabulario Nuevo", wf_eng_3: "Practicar Conversación", quick_actions: "Acciones Rápidas", my_projects: "Mis Proyectos",
                    select_chats: "Seleccionar Múltiples Chats",
                    delete: "Borrar", login: "Iniciar Sesión", settings: "Configuración", logout: "Cerrar Sesión",
                     solutions: "Soluciones", ally_title: "Somos tu Aliado Estratégico",
                    ally_desc: "Goatify no es solo un chat. Somos una IA personalizada con un equipo de expertos listos para ayudarte a escalar tu negocio.",
                    welcome_user: "¡Hola, ", welcome_user_2: "! Hoy es un gran día para crear algo increíble.",
                    welcome_guest: "¿Cómo puedo ayudarte hoy?", model: "Modelo:", model_general: "GOAT X",
                    model_web: "Búsqueda Web", voice: "Voz:", placeholder_main: "Escribe tu mensaje...", cancel: "Cancelar",
                    confirm: "Confirmar", plans_title: "Planes Goatify", plan_free_sub: "Para Siempre", plan_free_cta: "Tu Plan Actual",
                     plan_boost_cta: "Obtener Boost", plan_pro_cta: "Quiero mi Plan Pro + Web",
                    preview: "Vista Previa", settings_email: "Correo Electrónico:", settings_plan: "Plan de Suscripción:",
                    settings_fontsize: "Tamaño de Letra:", settings_theme: "Personalización:", settings_dark_mode: "Modo Oscuro",
                     settings_lang: "Idioma:", settings_whatsapp: "Conectarse a WhatsApp", current_plan: "Tu Plan Actual",
                    settings_notifications: "Notificaciones de Tareas:", settings_schedule_meeting: "Agendar Reunión",
                    settings_integrations: "Integraciones", google_calendar_desc: "Sincroniza tus tareas y eventos.",
                    calendar_today: "Hoy", calendar_this_week: "Esta Semana", calendar_mon: "Lun", calendar_tue: "Mar", calendar_wed: "Mié",
                     calendar_thu: "Jue", calendar_fri: "Vie", calendar_sat: "Sáb", calendar_sun: "Dom",
                    calendar_no_tasks: "No hay tareas para este día.", calendar_add_task_placeholder: "Añadir nueva tarea personal...",
                    calendar_add_task_btn: "Añadir Tarea", calendar_my_calendar: "Mi Calendario y Tareas",
                    calendar_day_view: "Vista de Día", calendar_month_view: "Vista de Mes", calendar_week_view: "Vista de Semana",
                    notification_task_due: "Es hora de: ", notification_title: "Goatify IA - ¡Hora de tu Tarea!",
                    tasks_for: "Tareas para", add_task_for: "Añadir Tarea para",
                    delete_task_confirm_title: "Confirmar Eliminación", delete_task_confirm_body: "¿Estás seguro de que quieres eliminar esta tarea?",
                    delete_btn: "Eliminar", done_btn: "Listo",
                    share_note: "Compartir Nota",
                    share_note_desc: "Ingresa el email del usuario de Goatify con quien quieres colaborar en esta nota.",
                    share_note_email_placeholder: "ejemplo@email.com",
                    share_note_info: "Nota: Esta funcionalidad requiere que ambos usuarios tengan un plan Pro y está en desarrollo. Por ahora, esto es una demostración.",
                    share_note_button: "Compartir",
                    share_financial_data: "Compartir Datos Financieros",
                    share_financial_data_desc: "Ingresa el email del usuario de Goatify con quien quieres compartir estos datos financieros.",
                    share_financial_data_info: "Nota: Esta funcionalidad requiere que ambos usuarios tengan un plan Pro y está en desarrollo. Por ahora, esto es una demostración.",
                    my_projects: "Mis Proyectos", add_to_folder: "Mover a carpeta", no_folders_yet: "No hay carpetas aún.",
                    new_note: "Nueva Nota", new_drawing_title: "Nuevo Dibujo", note_title_placeholder: "Título de la nota...",
                    bold_text: "Negrita", italic_text: "Cursiva", underline_text: "Subrayar",
                    copy_text: "Copiar", cut_text: "Cortar", paste_text: "Pegar",
                    align_left: "Alinear Izquierda", align_center: "Alinear Centro", align_right: "Alinear Derecha", align_justify: "Justificar",
                    export_pdf_btn: "Exportar como PDF",
                    add_checklist: "Añadir Checklist", tool_pencil: "Lápiz", tool_eraser: "Borrador", drawing_color: "Color", drawing_thickness: "Grosor", clear_all: "Limpiar todo",
                    share_note_btn: "Compartir", delete_note_btn: "Eliminar Nota", writing_assistant: "Asistente de Redacción",
                    notepad_placeholder: "Pide ideas, resúmenes, o correcciones...",
                    filter_tags: "Filtrar", views: "Vistas:", kanban: "Kanban", list: "Lista", add_task_btn_short: "Añadir Tarea",
                    project_calendar_title: "Calendario del Proyecto", project_assistant: "Asistente del Proyecto",
                    project_chat_placeholder: "Deja que Goatify organice tu proyecto...",
                    gamification_title: "La Ascensión del G.O.A.T.", daily_streak_tab: "Racha Diaria", missions_tab: "Misiones", achievements_tab: "Logros",
                    rules_btn: "Reglas", streak_desc: "Mantén tu racha para ganar XP, créditos y un cofre especial el día 7.",
                    rules_intro: "¡Bienvenido a tu viaje para convertirte en un G.O.A.T. (Greatest Of All Time) del emprendimiento digital! La lógica es simple: cuanto más usas la plataforma de forma estratégica, más recompensas obtienes.",
                    xp_credits_title: "1. Puntos de Experiencia (XP) vs. Créditos de Recompensa (🪙)",
                    xp_credits_desc: "Existen dos tipos de recompensas:",
                    xp_desc: "Puntos de Experiencia (XP): Miden tu progreso y maestría. El XP nunca se gasta, solo se acumula para que subas de nivel y desbloquees nuevos títulos.",
                    credits_desc: "Créditos de Recompensa (🪙): Son una reserva de créditos utilizables que ganas al completar misiones y rachas. Cuando se agotan los créditos diarios de tu plan, el sistema usará automáticamente estos créditos de recompensa para que puedas seguir trabajando. ¡Son tu colchón para que nunca pares de crear!",
                    how_to_level_up_title: "2. Cómo Subir de Nivel",
                    how_to_level_up_desc: "Acumula suficiente XP para ascender de nivel. Cada nivel representa una nueva etapa en tu dominio del marketing y los negocios con IA.",
                    level_1: "Nivel 1: Iniciador Digital", level_2: "Nivel 2: Creador de Contenido", level_3: "Nivel 3: Estratega de Marketing",
                    level_4: "Nivel 4: CEO Digital", level_5: "Nivel 5: G.O.A.T.",
                    how_to_earn_rewards_title: "3. Cómo Ganar Recompensas",
                    daily_streak_reward: "Racha Diaria: Cada día consecutivo que entras te da XP y Créditos de Recompensa.",
                    goat_chest_reward: "Cofre GOAT (Día 7): ¡Tu gran recompensa semanal por 7 días de racha! Puede contener una gran cantidad de créditos, cupones de descuento para nuestros servicios de implementación (páginas web, automatizaciones) o incluso una asesoría estratégica GRATIS.",
                    missions_achievements_reward: "Misiones y Logros: La forma más rápida de ganar grandes bonificaciones de XP y Créditos. Completa tareas específicas para acelerar tu ascenso.",
                    rules_closing: "¡Cada acción cuenta en tu camino a la cima! ¡A por ello!",
                    create_image_title: "Crear Imagen", upload_pdf_title: "Subir PDF", upload_image_title: "Subir Imagen",
                    activate_mic: "Activar Micrófono", toggle_voice: "Activar/Desactivar Voz",
                    understood_btn: "¡Entendido!", view_details: "Ver Detalles",
                    back_to_list: "Volver a la lista",
                    credits_details_title: "Mi Día",
                    current_plan_details: "Plan Activo: ",
                    credits_breakdown: "Créditos Restantes:",
                    upgrade_for_more: "Mejora tu plan para obtener más.",
                    gamification_credits_info: "Adicionalmente, tienes tus <strong>Créditos de Recompensa (🪙)</strong> ganados en la gamificación, que se usan automáticamente cuando se agotan los de tu plan.",
                    view_plans_btn: "Ver Planes",
                    motivation_title: "Dosis de Motivación",
                    motivation_notifications: "Notificaciones periódicas",
                    default_chat_title: "Conversación Cósmica",
                    rename_title: "Renombrar",
                    delete_title: "Eliminar",
                    add_to_folder: "Mover a Carpeta", // Updated to reflect common usage
                    tasks_completed_today: "Tareas completadas hoy:",
                    activities_today: "Actividades hoy:",
                    positive_message: "¡Cada pequeño paso te acerca a tu éxito!",
                    view_active_plan: "Ver mi Plan Activo",
                    learn_about_credits: "¿Qué son los créditos?",
                    success_title: "Éxito",
                    new_chat_created: "Has creado un nuevo",
                    folder_created_message: "Carpeta",
                    created_suffix: "creada.",
                    note_created_message: "Se ha creado:",
                    read_aloud_title: "Leer en voz alta",
                    edit_message_title: "Editar mensaje",
                    save_changes_btn: "Guardar Cambios",
                    image_prompt_desc: "Describe la imagen que quieres crear:",
                    image_prompt_placeholder: "Ej: Un astronauta en un caballo cósmico",
                    generate_btn: "Generar",
                    generate_image_message: "Generar imagen:",
                    image_creation_success: "¡Aquí está tu creación, Jefe/a!",
                    image_creation_error: "❌ **Error al crear la imagen:**",
                    create_folder_title: "Crear Nueva Carpeta",
                    folder_name_placeholder: "Nombre de la Carpeta...",
                    create_btn: "Crear",
                    undo_action_warning: "Esta acción no se puede deshacer.",
                    also_delete_items_warning: "También se eliminarán los",
                    items_contained_warning: "elementos que contiene.",
                    conversation_text: "Conversación",
                    project_text: "Proyecto",
                    note_text: "Nota",
                    rename_title_prefix: "Renombrar",
                    reading_pdf_status: "Leyendo...",
                    processing_pdf_status: "Procesando...",
                    pdf_ready_status: "Listo",
                    pages_short: "pág.",
                    pdf_error_status: "Error al leer PDF.",
                    restricted_access_title: "Acceso Restringido",
                    restricted_access_message: "El modelo GOAT X PRO está disponible solo para usuarios con un plan de pago.",
                    exclusive_feature_title: "Función Exclusiva",
                    exclusive_feature_message: "La gamificación está disponible para usuarios logueados.",
                    drawing_tool_line: "Línea",
                    drawing_tool_rect: "Rectángulo",
                    drawing_tool_circle: "Círculo",
                    undo_drawing: "Deshacer",
                    redo_drawing: "Rehacer",
                    download_html: "Descargar HTML",
                    copy_code: "Copiar Código",
                    pending_tasks_today: "Tareas pendientes hoy:",
                    total_activities_today: "Actividades totales hoy:",
                    login_for_credits_title: "¡Más Poder para Ti!",
                    login_for_credits_body: "Has agotado tus 5 créditos de prueba. ¡No te preocupes! <strong>Inicia sesión para obtener 100 créditos más</strong> y seguir creando. O, si lo prefieres, explora nuestros planes para un acceso ilimitado.",
                    login_now_btn: "Iniciar Sesión",
                    original_text_header: "Texto Original (Español)",
                    translated_text_header: "Texto Traducido (Inglés)",
                    translate_button: "Traducir",
                },
                en: {
                    initializing: "Initializing...", new_chat: "New Chat", new_folder: "New Folder",
                    web_offer: "🚀 Launch your Business, get a free website with your subscription!",
                    upgrade_plan: "Upgrade Plan", free_guides: "Free AI Guides", workflows: "Workflows",
                     wf_pm: "Project Assistant", wf_financial: "Financial Assistant", wf_notepad: "Notepad",
                    wf_expert: "Expert Assistant", wf_expert_1: "Decision Lab", wf_expert_2: "Conflict Resolution",
                    wf_social: "Social Media Booster", wf_social_1: "Create a Full Post", wf_social_2: "Copywriting",
                    wf_social_3: "Brainstorm Post Ideas", wf_social_4: "Define Brand Strategy",
                    wf_business: "Business Analysis", wf_business_1: "Analyze your Competition", wf_business_2: "Define my Ideal Customer",
                     wf_business_3: "Brainstorm Brand Names", wf_sales: "Communication & Sales", wf_sales_1: "Sales for your Business",
                    wf_sales_2: "Email Writing", wf_sales_3: "Web Design", wf_sales_4: "Improve Social Skills",
                    wf_english_teacher: "English Teacher", wf_eng_1: "Translate/Correct Text",
                    wf_eng_2: "Learn New Vocabulary", wf_eng_3: "Practice Conversation", quick_actions: "Quick Actions", my_projects: "My Projects",
                    select_chats: "Select Multiple Chats",
                    delete: "Delete", login: "Login", settings: "Settings", logout: "Logout",
                    solutions: "Solutions", ally_title: "We are your Strategic Ally",
                    ally_desc: "Goatify is not just a chat. We are a custom AI with a team of experts ready to help you scale your business.",
                    welcome_user: "Hello, ", welcome_user_2: "! Today is a great day to create something amazing.",
                    welcome_guest: "How can I help you today?", model: "Model:", model_general: "GOAT X",
                    model_web: "Web Search", voice: "Voz:", placeholder_main: "Type your message...", cancel: "Cancel",
                    confirm: "Confirm", plans_title: "Goatify Plans", plan_free_sub: "Forever", plan_free_cta: "Current Plan",
                    plan_boost_cta: "Get Boost", plan_pro_cta: "Get Pro Plan + Web",
                    preview: "Preview", settings_email: "Email Address:", settings_plan: "Subscription Plan:",
                    settings_fontsize: "Font Size:", settings_theme: "Personalization:", settings_dark_mode: "Dark Mode",
                     settings_lang: "Language:", settings_whatsapp: "Connect to WhatsApp", current_plan: "Current Plan",
                    settings_notifications: "Task Notifications:", settings_schedule_meeting: "Schedule Meeting",
                    settings_integrations: "Integrations", google_calendar_desc: "Sync your tasks and events.",
                    calendar_today: "Today", calendar_this_week: "This Week", calendar_mon: "Mon", calendar_tue: "Tue", calendar_wed: "Wed",
                     calendar_thu: "Thu", calendar_fri: "Fri", calendar_sat: "Sat", calendar_sun: "Sun",
                    calendar_no_tasks: "No tasks for this day.", calendar_add_task_placeholder: "Add new personal task...",
                    calendar_add_task_btn: "Add Task", calendar_my_calendar: "My Calendar & Tasks",
                    calendar_day_view: "Day View", calendar_month_view: "Month View", calendar_week_view: "Week View",
                     notification_task_due: "Time for: ", notification_title: "Goatify IA - Task Due!",
                    tasks_for: "Tasks for", add_task_for: "Add Task for",
                    delete_task_confirm_title: "Confirm Deletion", delete_task_confirm_body: "Are you sure you want to delete this task?",
                    delete_btn: "Delete", done_btn: "Done",
                    share_note: "Share Note",
                    share_note_desc: "Enter the email of the Goatify user you want to collaborate with on this note.",
                    share_note_email_placeholder: "example@email.com",
                    share_note_info: "Note: This functionality requires both users to have a Pro plan and is under development. For now, this is a demonstration.",
                    share_note_button: "Share",
                    share_financial_data: "Share Financial Data",
                    share_financial_data_desc: "Enter the email of the Goatify user you want to share this financial data with.",
                    share_financial_data_info: "Note: This functionality requires both users to have a Pro plan and is under development. For now, this is a demonstration.",
                    my_projects: "My Projects", add_to_folder: "Move to Folder", no_folders_yet: "No folders yet.",
                    new_note: "New Note", new_drawing_title: "New Drawing", note_title_placeholder: "Note title...",
                    bold_text: "Bold", italic_text: "Italic", underline_text: "Underline",
                    copy_text: "Copy", cut_text: "Cut", paste_text: "Paste",
                    align_left: "Align Left", align_center: "Center", align_right: "Align Right", align_justify: "Justify",
                    export_pdf_btn: "Export as PDF",
                    add_checklist: "Add Checklist", tool_pencil: "Pencil", tool_eraser: "Eraser", drawing_color: "Color", drawing_thickness: "Thickness", clear_all: "Clear All",
                    share_note_btn: "Share", delete_note_btn: "Delete Note", writing_assistant: "Writing Assistant",
                    notepad_placeholder: "Ask for ideas, summaries, or corrections...",
                    filter_tags: "Filter", views: "Views:", kanban: "Kanban", list: "List", add_task_btn_short: "Add Task",
                    project_calendar_title: "Project Calendar", project_assistant: "Project Assistant",
                    project_chat_placeholder: "Let Goatify organize your project...",
                    gamification_title: "The G.O.A.T. Ascension", daily_streak_tab: "Daily Streak", missions_tab: "Missions", achievements_tab: "Achievements",
                    rules_btn: "Rules", streak_desc: "Maintain your streak to earn XP, credits, and a special chest on day 7.",
                    rules_intro: "Welcome to your journey to become a G.O.A.T. (Greatest Of All Time) of digital entrepreneurship! The logic is simple: the more strategically you use the platform, the more rewards you get.",
                    xp_credits_title: "1. Experience Points (XP) vs. Reward Credits (🪙)",
                    xp_credits_desc: "There are two types of rewards:",
                    xp_desc: "Experience Points (XP): Measure your progress and mastery. XP is never spent, it only accumulates for you to level up and unlock new titles.",
                    credits_desc: "Reward Credits (🪙): Are a reserve of usable credits that you earn by completing missions and streaks. When your plan's daily credits run out, the system will automatically use these reward credits so you can continue working. They are your safety net to keep creating!",
                    how_to_level_up_title: "2. How to Level Up",
                    how_to_level_up_desc: "Accumulate enough XP to ascend in level. Each level represents a new stage in your mastery of marketing and business with AI.",
                    level_1: "Level 1: Digital Initiator", level_2: "Level 2: Content Creator", level_3: "Level 3: Marketing Strategist",
                    level_4: "Level 4: Digital CEO", level_5: "Level 5: G.O.A.T.",
                    how_to_earn_rewards_title: "3. How to Earn Rewards",
                    daily_streak_reward: "Daily Streak: Each consecutive day you log in gives you XP and Reward Credits.",
                    goat_chest_reward: "GOAT Chest (Day 7): Your big weekly reward for a 7-day streak! It can contain a large amount of credits, discount coupons for our implementation services (websites, automations), or even a FREE strategic consultation.",
                    missions_achievements_reward: "Missions & Achievements: The fastest way to earn big XP and Credit bonuses. Complete specific tasks to accelerate your ascent.",
                    rules_closing: "Every action counts on your way to the top! Go for it!",
                    create_image_title: "Create Image", upload_pdf_title: "Upload PDF", upload_image_title: "Upload Image",
                    activate_mic: "Activate Microphone", toggle_voice: "Toggle Voice",
                    understood_btn: "Got it!", view_details: "View Details",
                    back_to_list: "Back to list",
                    credits_details_title: "My Day",
                    current_plan_details: "Active Plan: ",
                    credits_breakdown: "Remaining Credits:",
                    upgrade_for_more: "Upgrade your plan for more.",
                    gamification_credits_info: "Additionally, you have your <strong>Reward Credits (🪙)</strong> earned from gamification, which are used automatically when your plan credits run out.",
                    view_plans_btn: "View Plans",
                    motivation_title: "Dose of Motivation",
                    motivation_notifications: "Periodic notifications",
                    default_chat_title: "Cosmic Conversation",
                    rename_title: "Rename",
                    delete_title: "Delete",
                    add_to_folder: "Move to Folder", // Updated to reflect common usage
                    tasks_completed_today: "Tasks completed today:",
                    activities_today: "Activities today:",
                    positive_message: "Every small step brings you closer to success!",
                    view_active_plan: "View my Active Plan",
                    learn_about_credits: "What are credits?",
                    success_title: "Success",
                    new_chat_created: "You created a new",
                    folder_created_message: "Folder",
                    created_suffix: "created.",
                    note_created_message: "Created:",
                    read_aloud_title: "Read aloud",
                    edit_message_title: "Edit message",
                    save_changes_btn: "Save Changes",
                    image_prompt_desc: "Describe the image you want to create:",
                    image_prompt_placeholder: "Ex: An astronaut on a cosmic horse",
                    generate_btn: "Generate",
                    generate_image_message: "Generate image:",
                    image_creation_success: "Here's your creation, Boss!",
                    image_creation_error: "❌ **Error creating image:**",
                    create_folder_title: "Create New Folder",
                    folder_name_placeholder: "Folder Name...",
                    create_btn: "Create",
                    undo_action_warning: "This action cannot be undone.",
                    also_delete_items_warning: "Also deletes",
                    items_contained_warning: "contained items.",
                    conversation_text: "Conversation",
                    project_text: "Project",
                    note_text: "Note",
                    rename_title_prefix: "Rename",
                    reading_pdf_status: "Reading...",
                    processing_pdf_status: "Processing...",
                    pdf_ready_status: "Ready",
                    pages_short: "pgs.",
                    pdf_error_status: "Error reading PDF.",
                    restricted_access_title: "Restricted Access",
                    restricted_access_message: "The GOAT X PRO model is only available for paid users.",
                    exclusive_feature_title: "Exclusive Feature",
                    exclusive_feature_message: "Gamification is available for logged-in users.",
                    drawing_tool_line: "Line",
                    drawing_tool_rect: "Rectangle",
                    drawing_tool_circle: "Circle",
                    undo_drawing: "Undo",
                    redo_drawing: "Redo",
                    download_html: "Download HTML",
                    copy_code: "Copy Code",
                    pending_tasks_today: "Pending tasks today:",
                    total_activities_today: "Total activities today:",
                    login_for_credits_title: "More Power to You!",
                    login_for_credits_body: "You've used up your 5 trial credits. Don't worry! <strong>Log in to get 100 more credits</strong> and keep creating. Or, if you prefer, explore our plans for unlimited access.",
                    login_now_btn: "Log In",
                    original_text_header: "Original Text (Spanish)",
                    translated_text_header: "Translated Text (English)",
                    translate_button: "Translate",
                }
            };
            // Constants for credit limits based on user plan
            const GUEST_CREDIT_LIMIT = 5;
            const LOGGED_IN_FREE_CREDITS = 100;
            const BOOST_PLAN_CREDIT_LIMIT = 500;
            const PRO_PLAN_CREDIT_LIMIT = 2000;

            // Costs associated with different AI model usages
            const COSTS = {
                GENERAL: 1, // Cost for general chat model (e.g., GPT-3.5)
                SEARCH: 2,  // Cost for web search model (e.g., Sonar)
                WORKFLOW: 2, // Cost for specific workflow usage
                PDF_ANALYSIS: 2, // Cost for PDF analysis
                IMAGE_ANALYSIS: 2, // Cost for image analysis
                IMAGE_GENERATION: 5, // Cost for image generation (e.g., DALL-E)
                GPT4O: 3 // Cost for GPT-4o model
            };

            // Motivational messages for the motivation modal
            const MOTIVATIONAL_MESSAGES = [
                "Eres una persona increíble, ¡never lo dudes!",
                "Hoy es tu día para brillar. ¡Ve por ello!",
                "Tu potencial es infinito. ¡Puedes lograr lo que te propongas!",
                "La rompes todos los días, ¡sigue así!",
                "Confía en tu proceso. Estás construyendo algo grandioso.",
                "Cada paso que das te acerca a tu meta. ¡No te detengas!",
                "Tu energía es contagiosa. ¡Ilumina el mundo!",
                "Puedes con todo y más. ¡Cree en ti!",
                "El éxito es la suma de pequeños esfuerzos repetidos día tras día.",
                "No importa lo lento que vayas, siempre y cuando no te detengas.",
                "La única forma de hacer un gran trabajo es amar lo que haces."
            ];
            // Button texts for the motivation modal
            const MOTIVATION_BUTTON_TEXTS = ["¡Listo!", "¡Vamos a darle!", "¡Perfecto!", "¡Sí, yo puedo!", "¡Vamos!", "¡Entendido!", "¡A por todas!"];

            // Global state variables for the application
            let state = { chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
            let gamificationState = {}; // State for gamification features
            let currentChatId = null; // ID of the currently selected chat
            let currentUser = null; // Current authenticated user
            let speechOn = false; // Flag for text-to-speech
            let availableVoices = []; // List of available voices for speech synthesis
            let selectedVoice = null; // Currently selected voice for speech synthesis
            let isRecognizing = false; // Flag for speech recognition in progress
            let selectedImageBase64 = null; // Base64 encoded string of the uploaded image
            let selectedPdfText = null; // Extracted text from the uploaded PDF
            let micWasOnBeforeSpeaking = false; // Flag to restart mic after TTS
            let modalResolve = null; // Promise resolver for generic modal
            let modalKeydownHandler = null; // To handle Enter key on modals
            let isSelectModeActive = false; // Flag for multi-chat selection mode
            let chatsToDelete = new Set(); // Set of chat IDs selected for deletion
            let currentNoteId = null; // ID of the currently selected note
            let goatXProUsage = 0; // Daily usage counter for GPT-4o model
            const GOAT_X_PRO_DAILY_LIMIT = 10; // Daily limit for GPT-4o model

            // Default notification settings, active by default as per requirements
            let notificationsEnabled = localStorage.getItem('goatify-notifications-enabled') === null ? true : localStorage.getItem('goatify-notifications-enabled') === 'true';
            let motivationEnabled = localStorage.getItem('goatify-motivation-enabled') === null ? true : localStorage.getItem('goatify-motivation-enabled') === 'true';

            // Calendar related state
            let selectedCalendarDate = dayjs(); // The date currently selected in the calendar
            let currentCalendarView = 'month'; // Current view of the calendar (day, week, month)
            let activeTagFilter = null; // Filter for project tasks by tag
            let motivationInterval = null; // Interval for periodic motivation notifications

            // DOM elements mapping for easier access
            const dom = {};
            const fullDom = {
                appContainer: document.getElementById('app-container'),
                msgInput: document.getElementById('msg'), sendBtn: document.getElementById('send'),
                inputArea: document.getElementById('input-area'),
                filePreviewArea: document.getElementById('file-preview-area'),
                messageCounterWrapper: document.getElementById('message-counter-wrapper'),
                planCreditsInfo: document.getElementById('plan-credits-info'),
                rewardCreditsInfo: document.getElementById('reward-credits-info'),
                upgradePlanContainer: document.getElementById('upgrade-plan-container'),
                upgradePlanBtn: document.getElementById('upgrade-plan-btn'),
                newChatBtn: document.getElementById('new-chat-btn'), newFolderBtn: document.getElementById('new-folder-btn'),
                pricingModal: document.getElementById('pricing-modal'), closePricingModalBtn: document.getElementById('close-pricing-modal'),
                genericModal: document.getElementById('generic-modal'),
                viewContainer: document.getElementById('view-container'),
                chatMessages: document.getElementById('chat-messages'),
                notepadViewContainer: document.getElementById('notepad-view-container'),
                translatorView: document.getElementById('translator-view'),
                chatTitle: document.getElementById('chat-title'), mobileChatTitle: document.getElementById('mobile-chat-title'),
                desktopChatTitleWrapper: document.getElementById('desktop-chat-title-wrapper'), mobileChatTitleWrapper: document.getElementById('mobile-chat-title-wrapper'),
                initialMessageContainer: document.getElementById('initial-message-container'), themeToggle: document.getElementById('theme-toggle'), themeIcon: document.getElementById('theme-icon'),
                micBtn: document.getElementById('mic-btn'), ttsToggle: document.getElementById('tts-toggle'),
                modelSelector: document.getElementById('model-selector'),
                actionButtonsContainer: document.getElementById('action-buttons-container'),
                imageUploadBtn: document.getElementById('image-upload-btn'), imageUploadInput: document.getElementById('image-upload'),
                imagePreviewContainer: document.getElementById('image-preview-container'), imagePreview: document.getElementById('image-preview'),
                clearImageBtn: document.getElementById('clear-image-btn'), pdfUploadBtn: document.getElementById('pdf-upload-btn'), pdfUploadInput: document.getElementById('pdf-upload'),
                pdfPreviewContainer: document.getElementById('pdf-preview-container'), pdfNameEl: document.getElementById('pdf-name'), pdfStatusEl: document.getElementById('pdf-status'), clearPdfBtn: document.getElementById('clear-pdf-btn'),
                sidebar: document.getElementById('sidebar'), menuToggle: document.getElementById('menu-toggle'), sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarContent: document.getElementById('sidebar-content'), loginView: document.getElementById('login-view'), userMenuView: document.getElementById('user-menu-view'),
                loginBtn: document.getElementById('login-btn'), userMenuBtn: document.getElementById('user-menu-btn'), userMenuPopup: document.getElementById('user-menu-popup'), userEmail: document.getElementById('user-email'),
                logoutBtn: document.getElementById('logout-btn'), webLaunchOfferBtn: document.getElementById('web-launch-offer-btn'),
                workflowsContainer: document.getElementById('workflows-container'), freeGuidesLink: document.getElementById('free-guides-link'),
                personalizedWelcome: document.getElementById('personalized-welcome'), genericWelcome: document.getElementById('generic-welcome'), userName: document.getElementById('user-name'),
                loadingOverlay: document.getElementById('loading-overlay'), htmlPreviewModal: document.getElementById('html-preview-modal'),
                closeHtmlPreviewModalBtn: document.getElementById('close-html-preview-modal'), htmlPreviewIframe: document.getElementById('html-preview-iframe'),
                downloadHtmlBtn: document.getElementById('download-html-btn'), copyHtmlBtn: document.getElementById('copy-html-btn'),
                voiceSelector: document.getElementById('voice-selector'),
                voiceSelectorContainer: document.getElementById('voice-selector-container'),
                selectChatsBtn: document.getElementById('select-chats-btn'), deleteModeControls: document.getElementById('delete-mode-controls'),
                deleteSelectedBtn: document.getElementById('delete-selected-btn'), cancelSelectModeBtn: document.getElementById('cancel-select-mode-btn'),
                imageGenBtn: document.getElementById('image-gen-btn'), servicesMenuBtn: document.getElementById('services-menu-btn'), servicesMenu: document.getElementById('services-menu'),
                contextualFooter: document.getElementById('contextual-footer'),
                newChatIconBtn: document.getElementById('new-chat-icon-btn'),
                newFolderIconBtn: document.getElementById('new-folder-icon-btn'),
                settingsBtn: document.getElementById('settings-btn'), userSettingsIcon: document.getElementById('user-settings-icon'),
                settingsModal: document.getElementById('settings-modal'), closeSettingsModal: document.getElementById('close-settings-modal'),
                settingsUserEmail: document.getElementById('settings-user-email'), settingsUserPlan: document.getElementById('settings-user-plan'),
                settingsUpgradePlanBtn: document.getElementById('settings-upgrade-plan-btn'), fontSizeSlider: document.getElementById('font-size-slider'),
                fontSizeValue: document.getElementById('font-size-value'), settingsThemeToggle: document.getElementById('settings-theme-toggle'),
                settingsThemeIcon: document.getElementById('settings-theme-icon'), languageSelector: document.getElementById('language-selector'),
                connectWhatsappBtn: document.getElementById('connect-whatsapp-btn'), scheduleMeetingBtn: document.getElementById('schedule-meeting-btn'), freePlanButton: document.getElementById('free-plan-button'),
                notificationsToggle: document.getElementById('notifications-toggle'),
                mainChatArea: document.getElementById('main-chat-area'),
                calendarModalOverlay: document.getElementById('calendar-modal-overlay'),
                calendarModal: document.getElementById('calendar-modal'),
                calendarBtn: document.getElementById('calendar-btn'), mobileCalendarBtn: document.getElementById('calendar-btn-mobile'),
                closeCalendarModal: document.getElementById('close-calendar-modal'),
                prevMonthBtn: document.getElementById('prev-month'), nextMonthBtn: document.getElementById('next-month'),
                currentMonthYear: document.getElementById('current-month-year'), calendarDaysGrid: document.getElementById('calendar-days-grid'),
                addTaskBtn: document.getElementById('add-task-btn'),
                notificationBadge: document.getElementById('notification-badge'), mobileNotificationBadge: document.getElementById('notification-badge-mobile'),
                inAppNotification: document.getElementById('in-app-notification'),
                inAppNotificationTitle: document.getElementById('in-app-notification-title'),
                inAppNotificationBody: document.getElementById('in-app-notification-body'),
                inAppNotificationClose: document.getElementById('in-app-notification-close'),
                taskNotificationModal: document.getElementById('task-notification-modal'),
                taskNotificationTitle: document.getElementById('task-notification-title'),
                taskNotificationBody: document.getElementById('task-notification-body'),
                taskNotificationCloseBtn: document.getElementById('task-notification-close-btn'),
                monthViewContainer: document.getElementById('month-view-container'), weekViewContainer: document.getElementById('week-view-container'),
                dayViewContainer: document.getElementById('day-view-container'),
                monthViewBtn: document.getElementById('month-view-btn'), weekViewBtn: document.getElementById('week-view-btn'), dayViewBtn: document.getElementById('day-view-btn'),
                prevWeekBtn: document.getElementById('prev-week'), nextWeekBtn: document.getElementById('next-week'),
                currentWeekRange: document.getElementById('current-week-range'), weekDaysContent: document.getElementById('week-days-content'),
                prevDayBtn: document.getElementById('prev-day'), nextDayBtn: document.getElementById('next-day'),
                currentDayDisplay: document.getElementById('current-day-display'), dayViewTimeline: document.getElementById('day-view-timeline'),
                projectManagementView: document.getElementById('project-management-view'),
                projectBoardContainer: document.getElementById('project-board-container'),
                projectChatContainer: document.getElementById('project-chat-container'),
                projectChatToggle: document.getElementById('project-chat-toggle'),
                projectChatHeader: document.getElementById('project-chat-container-header'),
                projectViewTitle: document.getElementById('project-view-title'),
                kanbanView: document.getElementById('kanban-view'),
                listView: document.getElementById('list-view'),
                listViewMobile: document.getElementById('list-view-mobile'),
                viewToggleKanban: document.getElementById('view-toggle-kanban'),
                viewToggleList: document.getElementById('view-toggle-list'),
                addTaskListViewBtn: document.getElementById('add-task-list-view-btn'),
                projectChatMessages: document.getElementById('project-chat-messages'),
                projectMsgInput: document.getElementById('project-msg'),
                projectSendBtn: document.getElementById('project-send'),
                projectCalendarBtn: document.getElementById('project-calendar-btn'),
                tagFilterBtn: document.getElementById('tag-filter-btn'),
                tagFilterDropdown: document.getElementById('tag-filter-dropdown'),
                financialAssistantView: document.getElementById('financial-assistant-view'),
                gamificationBtn: document.getElementById('gamification-btn'), // This button does not exist in HTML
                gamificationModal: document.getElementById('gamification-modal'),
                closeGamificationModal: document.getElementById('close-gamification-modal'),
                gamificationLevelName: document.getElementById('gamification-level-name'),
                gamificationXp: document.getElementById('gamification-xp'),
                gamificationCredits: document.getElementById('gamification-credits'),
                gamificationXpBar: document.getElementById('gamification-xp-bar'),
                dailyStreakContainer: document.getElementById('daily-streak-container'),
                missionsContainer: document.getElementById('gamification-tab-misiones'),
                achievementsContainer: document.getElementById('achievements-container'),
                gamificationRulesBtn: document.getElementById('gamification-rules-btn'),
                gamificationRulesModal: document.getElementById('gamification-rules-modal'),
                closeGamificationRulesModal: document.getElementById('close-gamification-rules-modal'),
                motivationBtnHeader: document.getElementById('motivation-btn-header'),
                motivationBtnMobile: document.getElementById('motivation-btn-mobile'),
                motivationModal: document.getElementById('motivation-modal'),
                motivationTitle: document.getElementById('motivation-title'),
                motivationQuote: document.getElementById('motivation-quote'),
                motivationToggle: document.getElementById('motivation-toggle'),
                closeMotivationModal: document.getElementById('close-motivation-modal'),
                sidebarToggleArrow: document.getElementById('sidebar-toggle-arrow'),
                foldersContainer: document.getElementById('folders-container'),
                addProjectFolderBtn: document.getElementById('add-project-folder-btn'),

                // Notepad DOM elements
                notesListPanel: document.getElementById('notes-list-panel'),
                notesListHeader: document.getElementById('notes-list-header'),
                noteEditorPanel: document.getElementById('note-editor-panel'),
                noteTitleInput: document.getElementById('note-title-input'),
                noteEditorToolbar: document.getElementById('note-editor-toolbar'),
                textTools: document.getElementById('text-tools'),
                drawingTools: document.getElementById('drawing-tools'),
                deleteNoteBtn: document.getElementById('delete-note-btn'),
                shareNoteBtn: document.getElementById('share-note-btn'),
                addChecklistItemBtn: document.getElementById('add-checklist-item-btn'),
                noteContentArea: document.getElementById('note-content-area'),
                noteContentEditor: document.getElementById('note-content-editor'),
                noteCanvas: document.getElementById('note-canvas'),
                addNewNoteBtn: document.getElementById('add-new-note-btn'),
                addNewDrawingBtn: document.getElementById('add-new-drawing-btn'),
                noteBackBtn: document.getElementById('note-back-btn'),
                notepadChatContainer: document.getElementById('notepad-chat-container'),
                notepadChatHeader: document.getElementById('notepad-chat-header'),
                notepadChatToggle: document.getElementById('notepad-chat-toggle'),
                notepadChatMessages: document.getElementById('notepad-chat-messages'),
                notepadMsgInput: document.getElementById('notepad-msg'),
                notepadSendBtn: document.getElementById('notepad-send'),
                planCreditsDisplay: document.getElementById('plan-credits-display'),
                rewardCreditsDisplay: document.getElementById('reward-credits-display'),
                boldBtn: document.getElementById('bold-btn'),
                italicBtn: document.getElementById('italic-btn'),
                underlineBtn: document.getElementById('underline-btn'),
                copyBtn: document.getElementById('copy-btn'),
                cutBtn: document.getElementById('cut-btn'),
                pasteBtn: document.getElementById('paste-btn'),
                alignLeftBtn: document.getElementById('align-left-btn'),
                alignCenterBtn: document.getElementById('align-center-btn'),
                alignRightBtn: document.getElementById('align-right-btn'),
                justifyBtn: document.getElementById('justify-btn'),
                exportPdfBtn: document.getElementById('export-pdf-btn'),
                fontFamilySelector: document.getElementById('font-family-selector'),
                toolLine: document.getElementById('tool-line'),
                toolRect: document.getElementById('tool-rect'),
                toolCircle: document.getElementById('tool-circle'),
                undoDrawingBtn: document.getElementById('undo-drawing-btn'),
                redoDrawingBtn: document.getElementById('redo-drawing-btn'),
                currentDateDisplay: document.getElementById('current-date-display'),
                currentTimeDisplay: document.getElementById('current-time-display'),
                drawingFullscreenBtn: document.getElementById('drawing-fullscreen-btn'),

                // Translator DOM elements
                translatorInputEs: document.getElementById('translator-input-es'),
                translatorOutputEn: document.getElementById('translator-output-en'),
                translateBtn: document.getElementById('translate-btn'),
                translatorModelSelector: document.getElementById('translator-model-selector'),
            };
            // Assign fullDom properties to the simpler 'dom' object for convenience
            Object.assign(dom, fullDom);

            // Gamification experience points required for each level
            const XP_FOR_LEVEL = [0, 250, 750, 2000, 5000, Infinity];
            // Names for each gamification level
            const LEVEL_NAMES = ["Iniciador Digital", "Creador de Contenido", "Estratega de Marketing", "CEO Digital", "G.O.A.T."];
            // Definitions of missions for gamification
            const MISSIONS = {
                'brand-strategy': { id: 'brand-strategy', text: 'Define tu primera estrategia de marca', xp: 50, credits: 15, workflow: 'brand-strategy', completed: false },
                'competitor-analysis': { id: 'competitor-analysis', text: 'Espía a la competencia por primera vez', xp: 50, credits: 15, workflow: 'competitor-analysis', completed: false },
                'week-organized': { id: 'week-organized', text: 'Crea una tarea para cada día de la semana', xp: 75, credits: 25, condition: checkWeekOrganized, completed: false },
                'project-created': { id: 'project-created', text: 'Crea tu primer proyecto y añade 3 tareas', xp: 100, credits: 30, condition: (chatId) => checkProjectCreated(chatId, 3), completed: false },
                'image-generated': { id: 'image-generated', text: 'Genera tu primera imagen con IA', xp: 40, credits: 10, action: 'generateImage', completed: false },
                'english-practice': { id: 'english-practice', text: 'Practica tu conversación en inglés', xp: 30, credits: 10, workflow: 'english-teacher-practice', completed: false },
                'social-skills': { id: 'social-skills', text: 'Mejora tus habilidades sociales con un consejo de IA', xp: 30, credits: 10, workflow: 'social-skills', completed: false },
                'conflict-resolution': { id: 'conflict-resolution', text: 'Analiza tu primer conflicto con IA', xp: 40, credits: 15, workflow: 'conflict-resolution', completed: false },
                'decision-lab': { id: 'decision-lab', text: 'Usa el Laboratorio de Decisiones', xp: 50, credits: 20, workflow: 'decision-lab', completed: false },
            };
            // Definitions of achievements for gamification
            const ACHIEVEMENTS = {
                'streak-30': { id: 'streak-30', title: 'Consistencia', description: 'Mantén la racha diaria por 30 días.', icon: 'fa-calendar-check', xp: 500, credits: 250 },
                'project-master': { id: 'project-master', title: 'Project Master', description: 'Completa 10 proyectos.', icon: 'fa-sitemap', xp: 1000, credits: 0, reward: '50% de descuento en consultoría de automatización.' },
                'influencer': { id: 'influencer', title: 'Influencer', description: 'Genera 50 publicaciones para redes sociales.', icon: 'fa-bullhorn', xp: 750, credits: 0, reward: 'Un mes de GOAT Boost gratis.' },
            };

            /**
             * Sets the application language by updating text content based on data-translate-key attributes.
             * @param {string} lang - The language code (e.g., 'es', 'en').
             */
            function setLanguage(lang) {
                const translationData = translations[lang];
                if (!translationData) return; // Exit if translation data is not found
                dayjs.locale(lang); // Set Day.js locale for date formatting
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    if (translationData[key]) {
                        const isIconOnlyButton = el.tagName === 'BUTTON' && el.querySelector('i') && !el.querySelector('span');

                        // Handle different element types for translation
                        if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT' || el.tagName === 'SELECT') {
                            if (el.placeholder) el.placeholder = translationData[key];
                            if (el.title) el.title = translationData[key];
                        } else if (isIconOnlyButton) {
                            el.title = translationData[key];
                        } else {
                            const icon = el.querySelector('i');
                            const textSpan = el.querySelector('span');
                            if (textSpan) {
                                textSpan.textContent = translationData[key]; // Update text in a span
                            } else if (icon) {
                                // If there's an icon and text directly in the element
                                let textNode = null;
                                for (const node of el.childNodes) {
                                    if (node.nodeType === Node.TEXT_NODE && node.textContent.trim().length > 0) {
                                        textNode = node;
                                        break;
                                    }
                                }
                                if (textNode) {
                                    textNode.textContent = ` ${translationData[key]}`; // Prepend space for icon + text
                                } else {
                                    el.textContent = translationData[key]; // Update full text content
                                }
                            } else {
                                el.textContent = translationData[key]; // Update full text content
                            }
                        }
                    }
                });
                document.documentElement.lang = lang; // Set HTML lang attribute
                localStorage.setItem('goatify-lang', lang); // Save language preference
                renderCalendarView(); // Re-render calendar to apply language changes
                renderSidebar(); // Re-render sidebar to apply language changes
                renderGamificationModal(); // Re-render gamification modal
                updateCreditCounter(); // Update credit counter text
            }

            /**
             * Updates the contextual footer message based on the active workflow.
             * @param {string|null} workflowKey - The key of the current workflow, or null for general chat.
             */
            function updateContextualFooter(workflowKey) {
                if (!dom.contextualFooter) return; // Exit if footer element is not found
                // Mapping of workflow keys to their descriptive texts
                const workflowTexts = {
                    'create-full-post': 'Modo Redes Sociales: Define tu red social y tema para un post completo.',
                    'persuasive-copy': 'Modo Copywriter: Dime qué vendes y para dónde es el texto.',
                    'brand-strategy': 'Modo Estratega: Dime el nombre y rubro de tu negocio para empezar.',
                     'competitor-analysis': 'Modo Analista: Pega la URL de tu competencia para investigarla.',
                    'sales-assistant': 'Modo Ventas: Pega el mensaje de tu cliente para responder.',
                    'english-teacher-practice': 'Practice mode: Let\'s talk. How was your day.',
                    'design-web': 'Modo Diseñador Web: Describe el componente visual y lo crearé en HTML.',
                    'project-management': 'Modo Director de Proyectos: Describe tu proyecto para crear tareas en el tablero.',
                    'conflict-resolution': 'Modo Mediador: Describe la situación de conflicto para encontrar una solución.',
                    'decision-lab': 'Modo Estratega: Describe la decisión que enfrentas y tus opciones.',
                    'financial-assistant': 'Modo Financiero: Usa la tabla para registrar transacciones. Pídeme análisis en el chat.',
                    'notepad-app': 'Bloc de Notas: Organiza tus ideas, todo se guarda automáticamente. Usa el chat para pedir ideas o correcciones.',
                    'notepad-assistant': 'Asistente de Redacción: Pide ideas, resúmenes, o ayuda para mejorar y corregir la ortografía de tu texto actual.',
                    'english-teacher-translate': 'Modo Traductor: Escribe en un panel para ver la traducción en el otro.'
                };
                const currentChat = state.chats[currentChatId];
                // Determine the key based on provided workflow or current chat/view
                const key = workflowKey || (currentChat ? currentChat.workflow : (currentChatId === 'notepad-app' ? 'notepad-app' : (currentChatId === 'translator-view' ? 'english-teacher-translate' : null)));
                dom.contextualFooter.textContent = workflowTexts[key] || 'Tu copiloto de IA para hacer crecer tu negocio.';
            }

            // Web Speech API for Speech Recognition
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            /**
             * Displays a generic modal with customizable content and buttons.
             * @param {object} options - Configuration for the modal.
             * @param {string} options.title - The title of the modal.
             * @param {string} options.body - The HTML content for the modal body.
             * @param {string} [options.confirmText='Confirmar'] - Text for the confirm button.
             * @param {string} [options.cancelText='Cancelar'] - Text for the cancel button.
             * @param {boolean} [options.showCancel=true] - Whether to show the cancel button.
             * @param {boolean} [options.showConfirm=true] - Whether to show the confirm button.
             * @param {Array<object>} [options.extraButtons=[]] - Array of extra buttons to add.
             * @param {boolean} [options.dangerConfirm=false] - If true, makes the confirm button red.
             * @returns {Promise<object>} A promise that resolves with { confirmed: boolean, data: object } when the modal is closed.
             */
            function showModal({ title, body, confirmText = 'Confirmar', cancelText = 'Cancelar', showCancel = true, showConfirm = true, extraButtons = [], dangerConfirm = false }) {
                const modalTitle = dom.genericModal.querySelector('#modal-title');
                const modalBody = dom.genericModal.querySelector('#modal-body');
                const modalButtonsContainer = dom.genericModal.querySelector('#modal-buttons-container');

                modalTitle.innerHTML = title;
                modalBody.innerHTML = body;

                let buttonsHTML = '';
                if (showCancel) {
                    buttonsHTML += `<button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded">${cancelText}</button>`;
                }
                extraButtons.forEach(btn => {
                    buttonsHTML += `<button id="${btn.id}" class="${btn.classes || 'px-4 py-2 rounded bg-gray-500 text-white'}">${btn.text}</button>`;
                });
                if (showConfirm) {
                    const confirmClasses = dangerConfirm ? 'btn-danger' : 'btn-primary';
                    buttonsHTML += `<button id="modal-confirm" class="px-4 py-2 rounded text-white ${confirmClasses}">${confirmText}</button>`;
                }
                modalButtonsContainer.innerHTML = buttonsHTML;

                // Attach event listeners for modal buttons
                if (showConfirm) {
                    dom.genericModal.querySelector('#modal-confirm').addEventListener('click', () => {
                        const inputs = modalBody.querySelectorAll('input, textarea, select');
                        const data = {};
                        inputs.forEach(input => {
                            data[input.id] = input.type === 'checkbox' ? input.checked : input.value;
                        });
                        hideModal({ confirmed: true, data });
                    }, { once: true }); // Use once: true to automatically remove listener after first click
                }

                if (showCancel) {
                    dom.genericModal.querySelector('#modal-cancel').addEventListener('click', () => hideModal({ confirmed: false }), { once: true });
                }
                extraButtons.forEach(btn => {
                    const buttonElement = dom.genericModal.querySelector(`#${btn.id}`);
                    if(buttonElement) {
                        buttonElement.addEventListener('click', (e) => {
                            btn.action(e, modalBody); // Pass event and modalBody to extra button action
                        });
                    }
                });

                // Handle Enter key press on modal to trigger confirm
                const confirmButton = dom.genericModal.querySelector('#modal-confirm');
                modalKeydownHandler = (e) => {
                    if (e.key === 'Enter') {
                        if (e.target.tagName !== 'TEXTAREA') { // Prevent Enter from submitting if in a textarea
                            e.preventDefault();
                            if (confirmButton) {
                                confirmButton.click();
                            }
                        }
                    }
                };
                document.addEventListener('keydown', modalKeydownHandler);

                dom.genericModal.classList.remove('hidden');
                dom.genericModal.classList.add('flex');

                // Return a promise that resolves when the modal is closed
                return new Promise(resolve => { modalResolve = resolve; });
            }

            /**
             * Hides the generic modal and resolves its promise.
             * @param {object} [resolveWith=null] - The value to resolve the modal promise with.
             */
            function hideModal(resolveWith = null) {
                // Remove keydown listener if it exists
                if (modalKeydownHandler) {
                    document.removeEventListener('keydown', modalKeydownHandler);
                    modalKeydownHandler = null;
                }
                // Resolve the promise if it's pending
                if(modalResolve) {
                    modalResolve(resolveWith);
                    modalResolve = null;
                }
                dom.genericModal.classList.add('hidden');
                dom.genericModal.classList.remove('flex');
            }

            /**
             * Shows the pricing modal.
             */
            function showPricingModal() {
                dom.pricingModal.classList.remove('hidden');
                dom.pricingModal.classList.add('flex');
                // Add a small delay for the scale transition to be visible
                setTimeout(() => { dom.pricingModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);

                const lang = localStorage.getItem('goatify-lang') || 'es';
                const isFree = !currentUser || (currentUser.app_metadata?.plan || 'free') === 'free';

                // Update the "Your Current Plan" button based on user's plan
                if (isFree) {
                    dom.freePlanButton.textContent = translations[lang].current_plan;
                    dom.freePlanButton.disabled = true;
                    dom.freePlanButton.classList.add('btn-disabled');
                } else {
                    dom.freePlanButton.textContent = translations[lang].plan_free_cta;
                    dom.freePlanButton.disabled = false;
                    dom.freePlanButton.classList.remove('btn-disabled');
                }
            }

            /**
             * Hides the pricing modal.
             */
            function hidePricingModal() {
                dom.pricingModal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => { dom.pricingModal.classList.add('hidden'); dom.pricingModal.classList.remove('flex'); }, 300);
            }

            /**
             * Shows the settings modal.
             */
            function showSettingsModal() {
                dom.settingsModal.classList.remove('hidden');
                dom.settingsModal.classList.add('flex');
                // Populate user email and plan if logged in
                if (currentUser) {
                    dom.settingsUserEmail.textContent = currentUser.email;
                    const userPlan = currentUser.app_metadata?.plan || 'free';
                    dom.settingsUserPlan.textContent = userPlan.charAt(0).toUpperCase() + userPlan.slice(1);
                    dom.settingsUpgradePlanBtn.classList.toggle('hidden', userPlan !== 'free'); // Hide upgrade button if not free
                } else {
                    dom.settingsUserEmail.textContent = 'Not logged in';
                    dom.settingsUserPlan.textContent = 'Free (Guest)';
                    dom.settingsUpgradePlanBtn.classList.remove('hidden');
                }
                // Set font size slider value and display
                dom.fontSizeSlider.value = parseInt(getComputedStyle(document.body).getPropertyValue('--base-font-size')) || 16;
                dom.fontSizeValue.textContent = `${dom.fontSizeSlider.value}px`;
                // Set theme icon based on current theme
                dom.settingsThemeIcon.className = `fas fa-${document.body.classList.contains('dark-theme') ? 'sun' : 'moon'}`;
                // Set language selector value
                dom.languageSelector.value = localStorage.getItem('goatify-lang') || 'es';
                // Set notifications toggle state
                dom.notificationsToggle.checked = notificationsEnabled;
            }

            /**
             * Hides the settings modal.
             */
            function hideSettingsModal() {
                dom.settingsModal.classList.add('hidden');
                dom.settingsModal.classList.remove('flex');
            }

            /**
             * Displays an in-app notification at the top center of the screen.
             * @param {string} title - The title of the notification.
             * @param {string} body - The body content of the notification.
             * @param {number} [duration=5000] - Duration in milliseconds before the notification auto-hides. Set to 0 for persistent.
             */
            function showInAppNotification(title, body, duration = 5000) {
                dom.inAppNotificationTitle.innerHTML = title;
                dom.inAppNotificationBody.innerHTML = body;
                dom.inAppNotification.classList.add('show');

                let timer;

                const closeNotification = (event) => {
                    // Prevent closing if a button/link inside the notification was clicked
                    if (event && event.target.closest('button, a')) {
                        return;
                    }
                    if(timer) clearTimeout(timer); // Clear any existing auto-hide timer
                    dom.inAppNotification.classList.remove('show');
                    dom.inAppNotification.removeEventListener('click', closeNotification); // Remove event listener to prevent multiple calls
                    dom.inAppNotificationClose.removeEventListener('click', closeFromX); // Remove event listener for 'X' button
                };

                const closeFromX = (event) => {
                    event.stopPropagation(); // Prevent click from bubbling up to the notification itself
                    closeNotification();
                };

                dom.inAppNotification.addEventListener('click', closeNotification);
                dom.inAppNotificationClose.addEventListener('click', closeFromX);

                if(duration) {
                    timer = setTimeout(closeNotification, duration);
                }
            }

            /**
             * Triggers a push notification to the user's device via a Netlify function.
             * Requires user to be logged in and subscribed to push notifications.
             * @param {string} title - The title of the push notification.
             * @param {string} body - The body content of the push notification.
             */
            async function triggerPushNotification(title, body) {
                console.log("Intentando disparar notificación push...");
                if (!currentUser) {
                    console.log("No hay usuario logueado, no se puede enviar la notificación push.");
                    return;
                }

                try {
                    const response = await fetch('/.netlify/functions/send-push', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: currentUser.id,
                            title,
                            body,
                        }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({details: 'Error desconocido en el servidor'}));
                        console.error("Error desde el backend al enviar la notificación:", errorData);
                    } else {
                        console.log("Petición para enviar push al backend fue exitosa.");
                    }
                } catch (error) {
                    console.error("Error de red al intentar disparar la notificación push:", error);
                }
            }

            /**
             * Converts a URL-safe base64 string to a Uint8Array.
             * Used for VAPID public key conversion for Push API.
             * @param {string} base64String - The URL-safe base64 string.
             * @returns {Uint8Array} The converted Uint8Array.
             */
            function urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }

            /**
             * Registers the Service Worker and subscribes the user for push notifications.
             * Handles permission requests and sends subscription details to the backend.
             */
            async function registerServiceWorkerAndSubscribe() {
                // Check if Service Worker and Push API are supported by the browser
                if (!('serviceWorker' in navigator && 'PushManager' in window)) {
                    console.warn("Las notificaciones Push no son soportadas en este navegador.");
                    notificationsEnabled = false; // Disable notifications if not supported
                    return;
                }

                try {
                    // Register the Service Worker
                    const registration = await navigator.serviceWorker.register('/service-worker.js', { scope: '/' });
                    console.log('Service Worker registrado exitosamente.');

                    // Request notification permission if not already granted
                    if (Notification.permission !== 'granted') {
                        console.log("El permiso para notificaciones aún no ha sido concedido. Solicitando...");
                        const permission = await Notification.requestPermission();
                        if (permission !== 'granted') {
                            console.warn("Permiso de notificación denegado.");
                            notificationsEnabled = false;
                            if(dom.notificationsToggle) dom.notificationsToggle.checked = false;
                            localStorage.setItem('goatify-notifications-enabled', 'false');
                            return;
                        }
                    }

                    // Get existing subscription or create a new one
                    let subscription = await registration.pushManager.getSubscription();
                    if (subscription === null) {
                        console.log("No se encontró suscripción, creando una nueva.");

                        // Public VAPID key (replace with your actual key if different)
                        const VAPID_PUBLIC_KEY = 'BJ4v02ExA1Tso9D_s2zXJGXWf_Q-wG2t6RkcuU_k9mLyD_i_Ld16Gq2g4Gf4K_V8A2f4g7J1zX9Z8hE3D4A0f5Y';

                        subscription = await registration.pushManager.subscribe({
                            userVisibleOnly: true, // Required for user-visible notifications
                            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY) // Your VAPID public key
                        });
                        console.log('Nueva suscripción creada:', subscription);

                        // Send the new subscription to your backend to save it
                        await fetch('/.netlify/functions/save-subscription', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: currentUser.id,
                                subscription: subscription
                            }),
                        });
                        console.log("Suscripción enviada al backend para ser guardada.");
                    } else {
                        console.log("Ya existe una suscripción:", subscription);
                    }

                } catch (error) {
                    console.error('Falló el registro del Service Worker o la suscripción:', error);
                    notificationsEnabled = false; // Disable notifications on error
                    if(dom.notificationsToggle) dom.notificationsToggle.checked = false;
                    localStorage.setItem('goatify-notifications-enabled', 'false');
                }
            }

            /**
             * Displays a task-specific notification modal.
             * @param {string} title - The title of the task notification.
             * @param {string} body - The body content of the task notification.
             */
            function showTaskNotification(title, body) {
                dom.taskNotificationModal.classList.remove('hidden');
                dom.taskNotificationModal.classList.add('flex');
                dom.taskNotificationTitle.textContent = title;

                // Add glowing effect to the task due message
                const glowingBody = body.replace(/(Es hora de:.*)/, '<span class="glowing-text">$1</span>');
                dom.taskNotificationBody.innerHTML = glowingBody;

                // Also trigger a push notification if enabled
                triggerPushNotification(title, body);
            }

            /**
             * Hides the task notification modal.
             */
            function hideTaskNotification() {
                dom.taskNotificationModal.classList.add('hidden');
                dom.taskNotificationModal.classList.remove('flex');
            }

            /**
             * Shows the calendar modal.
             */
            function showCalendarModal() {
                dom.calendarModalOverlay.classList.remove('hidden');
                dom.calendarModalOverlay.classList.add('flex');
                if (!currentCalendarView) currentCalendarView = 'month'; // Default to month view
                renderCalendarView(); // Render the current calendar view
                updateCalendarTime(); // Update time when modal opens
                updateMiDiaInfo(); // Update "My Day" info when modal opens
            }

            /**
             * Hides the calendar modal.
             */
            function hideCalendarModal() {
                dom.calendarModalOverlay.classList.add('hidden');
                dom.calendarModalOverlay.classList.remove('flex');
            }

            /**
             * Updates the current date and time displayed in the calendar modal header.
             */
            function updateCalendarTime() {
                const now = dayjs();
                dom.currentDateDisplay.textContent = now.format('dddd, D [de] MMMM [de]YYYY');
                dom.currentTimeDisplay.textContent = now.format('HH:mm:ss');
            }
            setInterval(updateCalendarTime, 1000); // Update time every second

            /**
             * Updates the "Mi Día" (My Day) information displayed in the calendar modal.
             * Includes tasks completed, pending, total activities, and credit count.
             */
            function updateMiDiaInfo() {
                const lang = localStorage.getItem('goatify-lang') || 'es';
                const todayKey = dayjs().format('YYYY-MM-DD');
                const allTasksToday = getTasksForDay(todayKey);
                const completedTasksToday = allTasksToday.filter(task => task.completed).length;
                const totalPendingTasksToday = allTasksToday.filter(task => !task.completed).length;

                let totalChatActivities = 0;
                // Count chat messages sent today
                Object.values(state.chats).forEach(chat => {
                    (chat.messages || []).forEach(msg => {
                        if (dayjs(msg.timestamp).isSame(dayjs(), 'day')) {
                            totalChatActivities++;
                        }
                    });
                });
                // Calculate total activities (tasks + half of chat messages for simplicity)
                const totalActivitiesToday = completedTasksToday + totalPendingTasksToday + Math.floor(totalChatActivities / 2);

                const planCreditsInfo = getCreditCount();
                const totalCredits = planCreditsInfo.remaining + (gamificationState.credits || 0);

                // Personalize welcome message in modal
                const userName = currentUser ? (currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.email.split('@')[0]) : '';
                let greetingTitle = 'Jefe';
                if (userName.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(userName.toLowerCase())) {
                    greetingTitle = 'Jefa';
                }
                const modalWelcomeUserGreeting = dom.genericModal.querySelector('#modal-welcome-user-greeting');
                if (modalWelcomeUserGreeting) {
                    modalWelcomeUserGreeting.innerHTML = `¡Hola, <span class="text-primary">${userName || greetingTitle}</span>! Ten un excelente día.`;
                }

                // Update various display elements in the modal
                const calendarInfoCompleted = dom.genericModal.querySelector('#calendar-info-completed-tasks');
                if(calendarInfoCompleted) calendarInfoCompleted.textContent = `${completedTasksToday}/${allTasksToday.length}`;

                const calendarInfoPending = dom.genericModal.querySelector('#calendar-info-pending-tasks');
                if(calendarInfoPending) calendarInfoPending.textContent = `${totalPendingTasksToday}`;

                const calendarInfoTotalActivities = dom.genericModal.querySelector('#calendar-info-total-activities');
                if(calendarInfoTotalActivities) calendarInfoTotalActivities.textContent = `${totalActivitiesToday}`;

                const calendarInfoTotalCredits = dom.genericModal.querySelector('#calendar-info-total-credits');
                if(calendarInfoTotalCredits) calendarInfoTotalCredits.textContent = `${totalCredits} (${planCreditsInfo.remaining}/${planCreditsInfo.limit === Infinity ? '∞' : planCreditsInfo.limit} plan + ${gamificationState.credits || 0} 🪙)`;
            }


            /**
             * Renders the month view of the calendar.
             */
            function renderMonthView() {
                dom.calendarDaysGrid.innerHTML = ''; // Clear previous days
                dom.currentMonthYear.textContent = selectedCalendarDate.format('MMMM YYYY'); // Update month/year display
                const startDay = selectedCalendarDate.startOf('month').startOf('isoWeek'); // Get the first day of the week for the first day of the month

                // Loop to render 42 days (6 weeks) to fill the calendar grid
                for (let i = 0; i < 42; i++) {
                    const day = startDay.add(i, 'day');
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.dataset.date = day.format('YYYY-MM-DD'); // Store date for easy access

                    dayEl.innerHTML = `<span class="calendar-day-number">${day.date()}</span><div class="calendar-day-tasks"></div>`;

                    // Apply classes for current month, other months, and today
                    if (day.month() === selectedCalendarDate.month()) {
                        dayEl.classList.add('current-month');
                    } else {
                        dayEl.classList.add('other-month');
                    }
                    if (day.isSame(dayjs(), 'day')) {
                        dayEl.classList.add('today');
                    }

                    const tasksContainer = dayEl.querySelector('.calendar-day-tasks');
                    const tasksForDay = getTasksForDay(day.format('YYYY-MM-DD'));
                    // Render up to 3 tasks directly in the day cell
                    tasksForDay.slice(0, 3).forEach(task => {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'calendar-day-task';
                        taskEl.textContent = task.text;
                        // Set background color based on task source/label
                        const bgColor = task.source === 'Personal' ? getLabelColor('Personal') : (task.labels && task.labels[0] ? getLabelColor(task.labels[0]) : 'grey');
                        taskEl.style.backgroundColor = bgColor;
                        taskEl.draggable = true; // Make tasks draggable
                        taskEl.dataset.taskId = task.id;
                        taskEl.dataset.taskSource = task.source;
                        taskEl.innerHTML = `
                            ${task.text}
                            <i class="fas fa-times delete-task-icon" data-task-id="${task.id}" data-task-source="${task.source}"></i>
                        `;
                        tasksContainer.appendChild(taskEl);
                    });

                    // Event listener for clicking on a day or task within the day
                    dayEl.addEventListener('click', (e) => {
                        if(e.target.classList.contains('delete-task-icon')) {
                            e.stopPropagation(); // Prevent bubbling to day click
                            deleteTask(e.target.dataset.taskId);
                        } else if(e.target === e.currentTarget || e.target.classList.contains('calendar-day-tasks')) {
                             editCalendarTask(null, day.format('YYYY-MM-DD')); // Add new task for the day
                        } else if(e.target.closest('.calendar-day-task')) {
                            const taskEl = e.target.closest('.calendar-day-task');
                            handleTaskClick(taskEl.dataset.taskId, taskEl.dataset.taskSource); // Edit existing task
                        }
                    });
                    // Drag and drop event listeners for calendar days
                    dayEl.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    dayEl.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    dayEl.addEventListener('drop', handleCalendarDrop);
                    // Touch event listeners for draggable tasks (for mobile drag and drop)
                    tasksContainer.querySelectorAll('.calendar-day-task').forEach(t => t.addEventListener('dragstart', handleCalendarDragStart));
                    tasksContainer.querySelectorAll('.calendar-day-task').forEach(t => t.addEventListener('touchstart', handleTouchStart, {passive: false}));

                    dom.calendarDaysGrid.appendChild(dayEl);
                }
            }

            /**
             * Renders the week view of the calendar.
             */
            function renderWeekView() {
                dom.weekDaysContent.innerHTML = ''; // Clear previous week content
                let startOfWeek = selectedCalendarDate.startOf('isoWeek'); // Get the start of the current week

                const endOfWeek = startOfWeek.add(6, 'day');
                dom.currentWeekRange.textContent = `${startOfWeek.format('D MMM')} - ${endOfWeek.format('D MMM, YYYY')}`; // Update week range display

            for (let i = 0; i < 7; i++) {
                    const day = startOfWeek.add(i, 'day');
                    const dayKey = day.format('YYYY-MM-DD');
                    const tasks = getTasksForDay(dayKey);
                    const lang = localStorage.getItem('goatify-lang') || 'es';
                    const displayDate = day.format('dddd, D MMM');
                    const daySection = document.createElement('div');
                    daySection.className = 'week-day-section';
                    daySection.dataset.date = dayKey; // Store date for easy access

                    // Build HTML for each day section including tasks
                    daySection.innerHTML = `
                        <h5>
                            <span>${displayDate}</span>
                            <button class="add-task-to-day-btn text-lg hover:text-primary" data-date="${dayKey}">+</button>
                        </h5>
                        <div class="space-y-1">
                            ${tasks.length === 0 ? `<p class="text-xs text-text-medium italic" data-translate-key="calendar_no_tasks">${translations[lang].calendar_no_tasks}</p>` : ''}
                            ${tasks.map((task) => {
                                const isPersonal = task.source === 'Personal';
                                const labelsHtml = (task.labels || []).map(label => `<span class="task-label" style="background-color: ${getLabelColor(label)}; color: white;">${label}</span>`).join('');
                                return `
                                <div class="task-item flex items-center gap-2 cursor-pointer ${task.completed ? 'task-item-completed' : ''}"
                                     draggable="true" data-task-id="${task.id}" data-task-source="${task.source}">
                                     <input type="checkbox" class="task-checkbox flex-shrink-0" data-task-id="${task.id}" ${task.completed ? 'checked' : ''}>
                                    <span class="flex-grow">${task.text} ${task.time ? `(${task.time})` : ''} <span class="text-xs text-primary">(${task.source})</span></span>
                                    <div class="task-labels ml-auto">${labelsHtml}</div>
                                    <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            `}).join('')}
                        </div>
                     `;
                    dom.weekDaysContent.appendChild(daySection);
                    // Drag and drop event listeners for week day sections
                    daySection.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    daySection.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    daySection.addEventListener('drop', handleCalendarDrop);
                    // Click listener to add new task to the day
                    daySection.addEventListener('click', (e) => {
                         if(e.target === e.currentTarget || e.target.classList.contains('space-y-1')) {
                            editCalendarTask(null, dayKey);
                        }
                    });
                }

                // Attach event listeners to dynamically created elements
                dom.weekDaysContent.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent bubbling
                        updateTaskStatus(e.currentTarget.dataset.taskId, { completed: e.currentTarget.checked });
                    });
                 });

                dom.weekDaysContent.querySelectorAll('.task-item').forEach(item => {
                    item.addEventListener('dragstart', handleCalendarDragStart); // Make tasks draggable
                    item.addEventListener('touchstart', handleTouchStart, {passive: false}); // Touch drag for mobile
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(item.dataset.taskId);
                            return;
                        }
                        if (e.target.type === 'checkbox') return; // Don't trigger if checkbox is clicked
                        handleTaskClick(item.dataset.taskId, item.dataset.taskSource); // Edit task
                     });
                });
                dom.weekDaysContent.querySelectorAll('.add-task-to-day-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const date = e.currentTarget.dataset.date;
                        editCalendarTask(null, date); // Add new task to specific day
                    });
                });
            }

            /**
             * Renders the day view of the calendar.
             */
            function renderDayView() {
                dom.currentDayDisplay.textContent = selectedCalendarDate.format('dddd, D [de] MMMM'); // Update day display
                dom.dayViewTimeline.innerHTML = ''; // Clear previous day content
                const tasksForDay = getTasksForDay(selectedCalendarDate.format('YYYY-MM-DD'));

                // Loop through 24 hours to create the timeline
                for (let hour = 0; hour < 24; hour++) {
                    const hourEl = document.createElement('div');
                    hourEl.className = 'day-view-hour';
                    const hourLabel = (hour < 10 ? '0' : '') + hour + ':00';
                    hourEl.dataset.time = hourLabel.substring(0,2); // Store hour for drop target
                    const tasksInHour = tasksForDay.filter(t => t.time && t.time.startsWith((hour < 10 ? '0' : '') + hour));
                    hourEl.innerHTML = `
                        <div class="day-view-hour-label">${hourLabel}</div>
                        <div class="day-view-hour-content" data-time="${hourLabel}" data-date="${selectedCalendarDate.format('YYYY-MM-DD')}">
                            ${tasksInHour.map(task => {
                                const labelsHtml = (task.labels || []).map(label => `<span class="task-label" style="background-color: ${getLabelColor(label)}; color: white;">${label}</span>`).join('');
                                return `
                                 <div class="task-item flex items-center gap-2 p-1 rounded-md ${task.completed ? 'bg-green-900/50 text-gray-400 line-through' : 'bg-input'} text-sm"
                                    draggable="true" data-task-id="${task.id}" data-task-source="${task.source}">
                                    <input type="checkbox" class="task-checkbox flex-shrink-0" data-task-id="${task.id}" ${task.completed ? 'checked' : ''}>
                                     <span class="flex-grow cursor-pointer"><strong>${task.time}:</strong> ${task.text} <span class="text-xs text-primary">(${task.source})</span></span>
                                    <div class="task-labels ml-auto">${labelsHtml}</div>
                                    <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            `}).join('')}
                             <button class="add-task-to-time-btn text-lg hover:text-primary" data-date="${selectedCalendarDate.format('YYYY-MM-DD')}" data-time="${hourLabel}">+</button>
                        </div>
                    `;
                    dom.dayViewTimeline.appendChild(hourEl);

                    const hourContent = hourEl.querySelector('.day-view-hour-content');
                    // Drag and drop event listeners for hour content areas
                    hourContent.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    hourContent.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    hourContent.addEventListener('drop', handleCalendarDrop);
                     hourContent.addEventListener('click', (e) => {
                         if(e.target === e.currentTarget) {
                            editCalendarTask(null, selectedCalendarDate.format('YYYY-MM-DD'), e.currentTarget.dataset.time);
                        }
                    });
                }
                // Attach event listeners to dynamically created elements
                dom.dayViewTimeline.querySelectorAll('.add-task-to-time-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const date = e.currentTarget.dataset.date;
                         const time = e.currentTarget.dataset.time;
                        editCalendarTask(null, date, time);
                    });
                });
                dom.dayViewTimeline.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        updateTaskStatus(e.currentTarget.dataset.taskId, { completed: e.currentTarget.checked });
                    });
                });
                dom.dayViewTimeline.querySelectorAll('.task-item').forEach(item => {
                    item.addEventListener('dragstart', handleCalendarDragStart); // Make tasks draggable
                    item.addEventListener('touchstart', handleTouchStart, {passive: false}); // Touch drag for mobile
                    item.addEventListener('click', (e) => {
                         if (e.target.closest('.delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(item.dataset.taskId);
                            return;
                        }
                        if (e.target.type === 'checkbox') return; // Don't trigger if checkbox is clicked
                        handleTaskClick(item.dataset.taskId, item.dataset.taskSource); // Edit task
                    });
                 });
            }

            /**
             * Handles click on a task item, redirecting to appropriate edit function based on task source.
             * @param {string} taskId - The ID of the task.
             * @param {string} taskSource - The source of the task ('Personal' or project title).
             */
            function handleTaskClick(taskId, taskSource) {
                 if (taskSource === 'Personal') {
                    editCalendarTask(taskId);
                } else {
                    // Find the project chat associated with the task source
                    const projectChat = Object.values(state.chats).find(c => c.projectData && c.projectData.title === taskSource);
                    if (projectChat) {
                        editProjectTask(projectChat.id, taskId);
                    }
                }
            }

            let draggedCalendarTaskId = null; // Stores the ID of the task being dragged in the calendar
            /**
             * Handles the start of a drag operation for a calendar task.
             * @param {DragEvent} e - The drag event.
             */
            function handleCalendarDragStart(e) {
                const target = e.target.closest('[draggable="true"]');
                if (!target) return;
                draggedCalendarTaskId = target.dataset.taskId;
                e.dataTransfer.setData('text/plain', draggedCalendarTaskId); // Set data for drop
                e.dataTransfer.effectAllowed = 'move'; // Specify allowed drag effect
            }

            /**
             * Handles the drop event for a calendar task onto a new date/time slot.
             * @param {DragEvent} e - The drop event.
             */
            function handleCalendarDrop(e) {
                e.preventDefault();
                e.stopPropagation(); // Prevent event from bubbling up
                e.currentTarget.style.backgroundColor = ''; // Reset background color
                const taskId = e.dataTransfer.getData('text/plain');
                if (!taskId) return;

                const dropZone = e.currentTarget;
                const newDate = dropZone.dataset.date; // Get new date from drop zone
                let newTime = dropZone.dataset.time || findTask(taskId)?.task?.time || null; // Get new time or retain old time

                // Adjust time format if only hour is provided
                if (newTime && newTime.length === 2) {
                   const originalTask = findTask(taskId)?.task;
                   const originalMinutes = originalTask?.time?.substring(3,5) || '00';
                   newTime = `${newTime}:${originalMinutes}`;
                }

                const updates = { date: newDate, time: newTime };
                updateTaskStatus(taskId, updates); // Update task with new date/time
            }

            let touchDragElement = null, ghostElement = null; // Elements for touch-based drag and drop
            let startX, startY; // Initial touch coordinates for drag
            /**
             * Handles the start of a touch-based drag operation for an element.
             * Creates a ghost element for visual feedback.
             * @param {TouchEvent} e - The touch event.
             */
            function handleTouchStart(e) {
                if (e.touches.length !== 1) return; // Only handle single touch
                const target = e.target.closest('[draggable="true"]');
                if (!target) return;

                touchDragElement = target;

                // Create a ghost element for visual feedback during drag
                ghostElement = touchDragElement.cloneNode(true);
                ghostElement.style.position = 'absolute';
                ghostElement.style.zIndex = '1000';
                ghostElement.style.opacity = '0.7';
                ghostElement.style.pointerEvents = 'none'; // Ensure ghost element doesn't interfere with touch events
                ghostElement.style.width = `${touchDragElement.offsetWidth}px`;
                document.body.appendChild(ghostElement);

                const touch = e.touches[0];
                startX = touch.pageX;
                startY = touch.pageY;
                ghostElement.style.left = `${startX - ghostElement.offsetWidth / 2}px`;
                ghostElement.style.top = `${startY - ghostElement.offsetHeight / 2}px`;

                // Add touchmove and touchend listeners globally
                document.addEventListener('touchmove', handleTouchMove, {passive: false});
                document.addEventListener('touchend', handleTouchEnd);
            }

            /**
             * Handles the movement of a touch-based drag operation.
             * Updates the position of the ghost element.
             * @param {TouchEvent} e - The touch event.
             */
            function handleTouchMove(e) {
                if (e.touches.length !== 1 || !ghostElement) return;
                e.preventDefault(); // Prevent scrolling while dragging
                const touch = e.touches[0];
                ghostElement.style.left = `${touch.pageX - ghostElement.offsetWidth / 2}px`;
                ghostElement.style.top = `${touch.pageY - ghostElement.offsetHeight / 2}px`;
            }

            /**
             * Handles the end of a touch-based drag operation.
             * Determines the drop target and performs the relevant action.
             * @param {TouchEvent} e - The touch event.
             */
            function handleTouchEnd(e) {
                if (!ghostElement) return;

                ghostElement.style.display = 'none'; // Hide ghost element
                // Determine the element at the drop position
                const dropTarget = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
                ghostElement.remove(); // Remove ghost element from DOM

                if (dropTarget) {
                    // Find the closest valid drop zone
                    const dropZone = dropTarget.closest('.calendar-day, .week-day-section, .day-view-hour-content, .kanban-cards, .list-view-column-mobile, .list-view-content > h4, .project-header');
                    if(dropZone) {
                        const taskId = touchDragElement.dataset.taskId; // For tasks
                        const itemId = touchDragElement.dataset.id; // For notes/chats
                        const itemType = touchDragElement.dataset.type; // For notes/chats

                        // Handle different drop zone types
                        if (dropZone.classList.contains('kanban-cards')) {
                            const chatId = currentChatId;
                            const columnId = dropZone.dataset.columnId;
                            moveTask(chatId, taskId, columnId);
                        } else if(dropZone.classList.contains('list-view-column-mobile')) {
                            const chatId = currentChatId;
                            const columnId = dropZone.dataset.columnId;
                            moveTask(chatId, taskId, columnId);
                        } else if (dropZone.tagName === 'H4' && dropZone.closest('#list-view')) {
                             const columnTitle = dropZone.textContent.trim();
                             const chat = state.chats[currentChatId];
                             const targetColumn = chat.projectData.columns.find(c => c.title === columnTitle);
                             if (targetColumn) {
                                 moveTask(currentChatId, taskId, targetColumn.id);
                             }
                        }
                        else if (dropZone.classList.contains('project-header')) {
                            const targetProjectId = dropZone.closest('.project').dataset.id;
                            if (itemId && itemType) {
                                moveItemToProject(itemId, targetProjectId); // Move chat/note to project folder
                            } else if (draggedCalendarTaskId) {
                                console.warn("Dragging calendar task to project header not fully defined.");
                            }
                        }
                        else {
                            // Default to calendar task update
                            const newDate = dropZone.dataset.date;
                            let newTime = dropZone.dataset.time || findTask(taskId)?.task?.time || null;
                            if (newTime && newTime.length === 2) {
                                const originalTask = findTask(taskId)?.task;
                                const originalMinutes = originalTask?.time?.substring(3,5) || '00';
                                newTime = `${newTime}:${originalMinutes}`;
                            }
                            updateTaskStatus(taskId, { date: newDate, time: newTime });
                        }
                    }
                }

                // Reset touch drag state
                touchDragElement = null; ghostElement = null;
                document.removeEventListener('touchmove', handleTouchMove);
                document.removeEventListener('touchend', handleTouchEnd);
            }

            /**
             * Finds a task by its ID, whether it's a personal calendar task or a project task.
             * @param {string} taskId - The ID of the task to find.
             * @returns {object|null} An object containing task details and its location, or null if not found.
             */
            function findTask(taskId) {
                if (!taskId) return null;
                // Check personal calendar tasks
                if (taskId.startsWith('cal-')) {
                    for (const dayKey in state.calendar) {
                        const taskIndex = (state.calendar[dayKey] || []).findIndex(t => t.id === taskId);
                        if (taskIndex > -1) {
                            return { type: 'personal', task: state.calendar[dayKey][taskIndex], dayKey, taskIndex };
                        }
                    }
                }
                // Check project tasks across all projects and columns
                else if (taskId.startsWith('proj-')) {
                    for (const chat of Object.values(state.chats)) {
                        if (chat.projectData && chat.projectData.columns) {
                            for (const column of chat.projectData.columns) {
                                const taskIndex = (column.tasks || []).findIndex(t => t.id === taskId);
                                if (taskIndex > -1) {
                                     return { type: 'project', task: column.tasks[taskIndex], chat, column, taskIndex };
                                }
                            }
                        }
                    }
                }
                return null; // Task not found
            }

            /**
             * Updates the status or properties of a task (personal or project).
             * Handles moving tasks between dates/columns if date/completion status changes.
             * @param {string} taskId - The ID of the task to update.
             * @param {object} updates - An object containing the properties to update.
             */
            function updateTaskStatus(taskId, updates) {
                const found = findTask(taskId);
                if (!found) return; // Task not found

                if (found.type === 'personal') {
                    const { task, dayKey } = found;
                    const oldDate = dayKey;
                    const newDate = updates.date || oldDate;

                    if (oldDate !== newDate) {
                        // If date changes, move task to new date's array
                        const taskIndex = state.calendar[oldDate].findIndex(t => t.id === taskId);
                        const [taskToMove] = state.calendar[oldDate].splice(taskIndex, 1);
                        if(state.calendar[oldDate].length === 0) delete state.calendar[oldDate]; // Remove empty day array

                        if (!state.calendar[newDate]) state.calendar[newDate] = []; // Create new day array if it doesn't exist
                        Object.assign(taskToMove, updates); // Apply updates to the task
                        delete taskToMove.date; // Remove redundant 'date' property
                        state.calendar[newDate].push(taskToMove); // Add task to new date
                    } else {
                        delete updates.date; // Remove date from updates if not changing
                        Object.assign(task, updates); // Apply updates to the existing task
                    }
                }
                else if (found.type === 'project') {
                    const { task, chat } = found;
                    const originalCompleted = task.completed; // Store original completion status

                    // If 'date' is provided in updates, it means it's a dueDate for project tasks
                    if (updates.date) {
                        updates.dueDate = updates.date;
                        delete updates.date;
                    }

                    Object.assign(task, updates); // Apply updates to the project task

                    // If completion status changed, move task between columns (e.g., to 'done' or 'todo')
                    if (updates.completed !== undefined && updates.completed !== originalCompleted) {
                        let sourceColumn, taskIndex;
                        // Find the source column of the task
                        for(const col of chat.projectData.columns){
                            const idx = (col.tasks || []).findIndex(t => t.id === taskId);
                            if(idx > -1){
                                sourceColumn = col;
                                taskIndex = idx;
                                break;
                            }
                        }

                        if (sourceColumn) {
                            const [taskToMove] = sourceColumn.tasks.splice(taskIndex, 1); // Remove task from source column
                            if (task.completed) {
                                // If completed, move to 'done' column
                                const doneColumn = chat.projectData.columns.find(c => c.id === 'done');
                                if (doneColumn && sourceColumn.id !== 'done') doneColumn.tasks.push(taskToMove);
                                else sourceColumn.tasks.push(taskToMove); // If already in 'done' or no 'done' column, keep in place
                            } else {
                                // If uncompleted, move to 'todo' column
                                const todoColumn = chat.projectData.columns.find(c => c.id === 'todo');
                                if (todoColumn && sourceColumn.id === 'done') todoColumn.tasks.push(taskToMove);
                                else sourceColumn.tasks.push(taskToMove); // If not in 'done' or no 'todo' column, keep in place
                            }
                        }
                    }
                }

                saveState(); // Save the updated state
                // Re-render relevant UI components
                if (dom.calendarModalOverlay.classList.contains('flex')) {
                    renderCalendarView();
                }
                if (dom.projectManagementView.style.display === 'flex') {
                    renderProjectBoard(currentChatId);
                }
            }


            /**
             * Retrieves all tasks (personal and project) for a given day.
             * @param {string} dayKey - The date string in 'YYYY-MM-DD' format.
             * @returns {Array<object>} An array of tasks for the specified day, sorted by time.
             */
            function getTasksForDay(dayKey) {
                // Get personal tasks for the day
                const calendarTasks = (state.calendar[dayKey] || []).map(t => ({...t, text: t.content, source: 'Personal', labels: ['Personal']}));
                const projectTasks = [];
                // Iterate through all project chats to find tasks due on this day
                Object.values(state.chats).forEach(chat => {
                    if (chat.projectData && chat.projectData.columns) {
                        chat.projectData.columns.forEach(column => {
                            (column.tasks || []).forEach(task => {
                                 if (task.dueDate === dayKey) {
                                    projectTasks.push({...task, source: chat.projectData.title, text: task.content});
                                }
                             });
                        });
                    }
                });
                // Combine and sort tasks by time
                return [...calendarTasks, ...projectTasks].sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
            }

            /**
             * Updates the notification badge displaying the count of overdue/pending tasks.
             */
            function updateNotificationBadge() {
                 let pendingNotifications = 0;
                const now = dayjs();
                // Iterate through all calendar days with tasks
                Object.keys(state.calendar).forEach(dayKey => {
                    const tasksForDay = getTasksForDay(dayKey);
                    tasksForDay.forEach(task => {
                         if (!task.completed) {
                            if (task.time) {
                                // Check if task with time is overdue
                                const taskDateTime = dayjs(`${dayKey}T${task.time}`);
                                if (taskDateTime.isBefore(now)) {
                                     pendingNotifications++;
                                }
                            } else {
                                // Check if all-day task is today or in the past
                                const taskDate = dayjs(dayKey);
                                if (taskDate.isBefore(now, 'day') || taskDate.isSame(now, 'day')) {
                                    pendingNotifications++;
                                }
                            }
                         }
                    });
                });

                const badgeEl = document.getElementById('notification-badge');
                const mobileBadgeEl = document.getElementById('notification-badge-mobile');

                // Update badge visibility and count
                if (pendingNotifications > 0) {
                    badgeEl.textContent = pendingNotifications;
                    badgeEl.classList.remove('hidden');
                    mobileBadgeEl.textContent = pendingNotifications;
                    mobileBadgeEl.classList.remove('hidden');
                } else {
                    badgeEl.classList.add('hidden');
                    mobileBadgeEl.classList.add('hidden');
                }
            }

            /**
             * Checks for and triggers notifications for tasks that are due.
             * Runs periodically.
             */
            function checkAndNotifyTasks() {
                if (!notificationsEnabled) return; // Exit if notifications are disabled
                const now = dayjs();
                const todayKey = now.format('YYYY-MM-DD');
                const currentHourMinute = now.format('HH:mm');
                const allTasksToday = getTasksForDay(todayKey);
                allTasksToday.forEach(task => {
                    // Check if task is due now and hasn't been notified for this minute
                    if (!task.completed && task.time === currentHourMinute && !task.notifiedThisMinute) {
                        const lang = localStorage.getItem('goatify-lang') || 'es';
                        const notificationTitle = translations[lang].notification_title;
                        const notificationBody = `${translations[lang].notification_task_due} ${task.text} (${task.time})`;

                        showTaskNotification(notificationTitle, notificationBody);

                        updateTaskNotifiedFlag(task.id, true); // Mark as notified for this minute
                    }
                });
                // Reset notification flag for tasks that were notified in past minutes
                for (const dayKey in state.calendar) {
                    state.calendar[dayKey].forEach(task => {
                        const taskDate = dayjs(dayKey);
                        const taskDateTime = task.time ? dayjs(`${dayKey}T${task.time}`) : taskDate;
                        if (task.notifiedThisMinute && taskDateTime.isBefore(now, 'minute')) {
                            task.notifiedThisMinute = false;
                        }
                    });
                }
                saveState(); // Save state after updating notification flags
                updateNotificationBadge(); // Update badge count
            }

            /**
             * Updates the 'notifiedThisMinute' flag for a specific task.
             * @param {string} taskId - The ID of the task.
             * @param {boolean} isNotified - The new value for the flag.
             */
            function updateTaskNotifiedFlag(taskId, isNotified) {
                const found = findTask(taskId);
                if (found) {
                    found.task.notifiedThisMinute = isNotified;
                }
            }


            /**
             * Renders the appropriate calendar view (day, week, or month) based on `currentCalendarView`.
             */
            function renderCalendarView() {
                 dom.dayViewContainer.style.display = currentCalendarView === 'day' ? 'block' : 'none';
                dom.weekViewContainer.style.display = currentCalendarView === 'week' ? 'block' : 'none';
                dom.monthViewContainer.style.display = currentCalendarView === 'month' ? 'block' : 'none';

                // Update active state of view toggle buttons
                dom.dayViewBtn.classList.toggle('active', currentCalendarView === 'day');
                dom.weekViewBtn.classList.toggle('active', currentCalendarView === 'week');
                dom.monthViewBtn.classList.toggle('active', currentCalendarView === 'month');

                // Call the specific render function for the active view
                if (currentCalendarView === 'day') renderDayView();
                if (currentCalendarView === 'week') renderWeekView();
                if (currentCalendarView === 'month') renderMonthView();
            }

            setInterval(checkAndNotifyTasks, 10 * 1000); // Check for tasks every 10 seconds

            /**
             * Initiates speech synthesis for the given text.
             * Handles pausing/restarting speech recognition if active.
             * @param {string} text - The text to speak.
             * @param {HTMLElement} [element=null] - The element that triggered the speech (optional).
             */
            function speak(text, element) {
                if (!text) return;

                if (speechOn) { // If global speech is enabled
                    if (!('speechSynthesis' in window)) return; // Check for SpeechSynthesis API support
                    speechSynthesis.cancel(); // Stop any ongoing speech
                    micWasOnBeforeSpeaking = isRecognizing; // Store mic state
                    if (isRecognizing) { recognition.stop(); } // Stop speech recognition if active
                    // Clean HTML tags and Markdown formatting from the text
                    const cleanText = text.replace(/<[^>]*>/g, '').replace(/[*_`#~[\]()🔍]|(-{3,})/g, '');
                    const utterance = new SpeechSynthesisUtterance(cleanText);
                    if (selectedVoice) { utterance.voice = selectedVoice; } // Set selected voice
                    utterance.rate = 1.15; // Slightly faster speech rate
                    utterance.onend = () => {
                        // Restart speech recognition if it was active before speaking
                        if (micWasOnBeforeSpeaking) {
                            if (recognition && !isRecognizing) {
                                try { recognition.start(); } catch(e) { console.error("Error restarting recognition:", e); }
                            }
                            micWasOnBeforeSpeaking = false;
                        }
                    };
                    utterance.onerror = (e) => {
                        console.error('Speech synthesis error:', e);
                        // Restart speech recognition even on error
                        if (micWasOnBeforeSpeaking) {
                            if (recognition && !isRecognizing) {
                               try { recognition.start(); } catch(e) { console.error("Error restarting recognition on error:", e); }
                            }
                            micWasOnBeforeSpeaking = false;
                        }
                    }
                    speechSynthesis.speak(utterance);
                } else if (element) { // If speech is triggered by a specific element (e.g., speaker icon)
                    speechSynthesis.cancel();
                    const cleanText = text.replace(/<[^>]*>/g, '').replace(/[*_`#~[\]()🔍]|(-{3,})/g, '');
                    const utterance = new SpeechSynthesisUtterance(cleanText);
                    if (selectedVoice) utterance.voice = selectedVoice;
                    utterance.rate = 1.15;
                    speechSynthesis.speak(utterance);
                }
            }

            /**
             * Populates the voice selector dropdown with available speech synthesis voices.
             * Filters for Spanish and English voices and prioritizes certain voices.
             */
            function populateVoiceList() {
                const setVoices = () => {
                    if (typeof speechSynthesis === 'undefined') { return; }
                    // Filter for Spanish and English voices
                    availableVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('es-') || v.lang.startsWith('en-'));
                    // Prioritize certain voices for better user experience
                    const preferredVoices = [ "Microsoft Sabina Online (Natural) - Spanish (Mexico)", "Paulina", "Google español de Estados Unidos", "Google español" ];
                    availableVoices.sort((a, b) => {
                        let aIdx = preferredVoices.indexOf(a.name); let bIdx = preferredVoices.indexOf(b.name);
                        if (aIdx === -1) aIdx = Infinity; if (bIdx === -1) bIdx = Infinity;
                        if (aIdx !== bIdx) return aIdx - bIdx; // Sort by preferred index first
                        return a.name.localeCompare(b.name); // Then by name
                    });

                    if (availableVoices.length > 0) {
                        dom.voiceSelector.innerHTML = ''; // Clear existing options
                        availableVoices.forEach(voice => {
                            const option = document.createElement('option');
                            // Clean up voice names for display
                            const displayName = voice.name.replace('Microsoft', '').replace('Online (Natural) -', '').replace('Google', '').replace('Spanish (Mexico)','Mex').trim();
                            option.textContent = `${displayName || voice.lang} (${voice.lang})`;
                            option.value = voice.name;
                            dom.voiceSelector.appendChild(option);
                        });
                        selectedVoice = availableVoices[0]; // Select the first available voice by default
                        if (selectedVoice) dom.voiceSelector.value = selectedVoice.name;
                    }
                }
                // Listen for voiceschanged event to re-populate if voices become available later
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = setVoices;
                }
                setVoices(); // Call immediately to populate initially
            }

            /**
             * Determines the AI model to use for a request based on workflow, file presence, and user plan.
             * Handles "GOAT X PRO" access restrictions for free users.
             * @param {string} workflow - The current workflow (e.g., 'design-web').
             * @param {boolean} hasFile - True if an image or PDF is attached.
             * @param {string} assistantType - The type of assistant ('main', 'project', 'financial', 'notepad', 'translator').
             * @returns {string} The selected model ID.
             */
            function getModelForRequest(workflow, hasFile, assistantType) {
                let selector;
                // Select the correct model selector based on assistant type
                switch (assistantType) {
                    case 'project':
                        selector = document.getElementById('project-model-selector');
                        break;
                    case 'financial':
                        selector = document.getElementById('financial-model-selector');
                        break;
                    case 'notepad':
                        selector = document.getElementById('notepad-model-selector');
                        break;
                    case 'translator':
                        return 'gpt-4o'; // Translator always uses GOAT X PRO
                    default:
                        selector = dom.modelSelector; // Main chat model selector
                }

                // Specific model overrides for certain workflows or file types
                if (workflow === "design-web") return "gpt-4o-mini"; // Use specific model for web design
                if (hasFile) return "gpt-4o-mini"; // Use specific model for file analysis

                const selectedModel = selector.value;
                // Restrict "GOAT X PRO" (gpt-4o) access for free users
                if (selectedModel === 'gpt-4o' && (!currentUser || (currentUser.app_metadata?.plan || 'free') === 'free')) {
                     showInAppNotification(translations[localStorage.getItem('goatify-lang') || 'es'].restricted_access_title || "Acceso Restringido", translations[localStorage.getItem('goatify-lang') || 'es'].restricted_access_message || "El modelo GOAT X PRO está disponible solo para usuarios con un plan de pago.", 3000);
                     selector.value = 'gpt-3.5-turbo-1106'; // Revert to default model
                     return 'gpt-3.5-turbo-1106';
                }
                return selectedModel;
            }

            /**
             * Sends a request to the backend Netlify function to get an AI response.
             * @param {string} prompt - The user's input prompt.
             * @param {Array<object>} history - The chat history.
             * @param {string} image - Base64 encoded image data (optional).
             * @param {string} pdf - Extracted PDF text (optional).
             * @param {string} model - The AI model to use.
             * @param {string} workflow - The active workflow (optional).
             * @param {string} userName - The user's name.
             * @param {object} financialData - Financial data for financial assistant (optional).
             * @param {string} noteContent - Content of the current note for notepad assistant (optional).
             * @returns {Promise<object>} A promise that resolves with the AI's response.
             */
            async function getAIResponse(prompt, history, image, pdf, model, workflow, userName, financialData = null, noteContent = null) {
                const name = (userName || '').split(' ')[0];
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }
                const body = {
                    prompt, history, model,
                    workflow, userName, title,
                    imageData: image, pdfText: pdf,
                    financialData, noteContent,
                 };
                try {
                    const response = await fetch('/.netlify/functions/get-ai-response', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(body),
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({details: 'Error desconocido en el servidor'}));
                        console.error("Backend Error:", errorData);
                        throw new Error(errorData.details || `Error del servidor: ${response.status}.`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("Fetch Error:", error);
                    throw error;
                }
            }

            /**
             * Calculates the current credit count for the user.
             * Handles guest users and different subscription plans.
             * @returns {object} An object containing remaining credits, total limit, and plan.
             */
            function getCreditCount() {
                if (!currentUser) {
                    // Logic for guest users
                    const usageData = JSON.parse(localStorage.getItem('guest_usage')) || { count: 0 };
                    return { remaining: Math.max(0, GUEST_CREDIT_LIMIT - usageData.count), limit: GUEST_CREDIT_LIMIT, plan: 'free (guest)' };
                }

                // Logic for logged-in users
                const plan = currentUser.app_metadata?.plan || 'free';
                let limit;
                switch (plan) {
                    case 'boost': limit = BOOST_PLAN_CREDIT_LIMIT; break;
                    case 'pro': limit = PRO_PLAN_CREDIT_LIMIT; break;
                    default: limit = LOGGED_IN_FREE_CREDITS;
                }

                const usageKey = `usage_monthly_${currentUser.id}`;
                const currentMonth = dayjs().format('YYYY-MM');
                const usageData = JSON.parse(localStorage.getItem(usageKey)) || { count: 0, month: '' };

                // Reset monthly usage if it's a new month
                if (usageData.month !== currentMonth) {
                    return { remaining: limit, limit, plan };
                }

                return { remaining: Math.max(0, limit - usageData.count), limit, plan };
            }

            /**
             * Deducts credits based on the cost of the operation and the model used.
             * Displays modals for insufficient credits or GOAT X PRO daily limit.
             * @param {number} cost - The number of credits to spend.
             * @param {string} modelUsed - The ID of the model used (e.g., 'gpt-4o').
             * @returns {boolean} True if credits were successfully spent, false otherwise.
             */
            function spendCredits(cost, modelUsed) {
                // Check GOAT X PRO daily limit for logged-in users
                if (modelUsed === 'gpt-4o' && currentUser) {
                    const today = dayjs().format('YYYY-MM-DD');
                    const proUsageKey = `goat_x_pro_usage_${currentUser?.id || 'guest'}_${today}`;
                    goatXProUsage = parseInt(localStorage.getItem(proUsageKey) || '0');

                    if (goatXProUsage >= GOAT_X_PRO_DAILY_LIMIT) {
                        showModal({
                            title: 'Límite de Uso Alcanzado para GOAT X PRO',
                            body: `Has alcanzado el límite de ${GOAT_X_PRO_DAILY_LIMIT} usos diarios para el modelo GOAT X PRO. Por favor, usa el modelo GOAT X (General) o espera hasta mañana para volver a usar GOAT X PRO.`,
                            confirmText: 'Entendido',
                            showCancel: false
                        }).then(() => {
                            // Revert model selector to GOAT X if limit reached
                            dom.modelSelector.value = 'gpt-3.5-turbo-1106';
                            if (document.getElementById('project-model-selector')) document.getElementById('project-model-selector').value = 'gpt-3.5-turbo-1106';
                            if (document.getElementById('financial-model-selector')) document.getElementById('financial-model-selector').value = 'gpt-3.5-turbo-1106';
                            if (document.getElementById('notepad-model-selector')) document.getElementById('notepad-model-selector').value = 'gpt-3.5-turbo-1106';
                        });
                        return false;
                    }
                }

                const { remaining } = getCreditCount();
                const gamCredits = (gamificationState.credits || 0); // Get reward credits

                // Check if total available credits are sufficient
                if (remaining < cost && gamCredits < cost) {
                    const lang = localStorage.getItem('goatify-lang') || 'es';
                    if (!currentUser) {
                         // Show login/upgrade modal for guest users
                         showModal({
                            title: translations[lang].login_for_credits_title,
                            body: translations[lang].login_for_credits_body,
                            confirmText: translations[lang].login_now_btn,
                            cancelText: translations[lang].view_plans_btn,
                        }).then(res => {
                            if (res.confirmed) {
                                netlifyIdentity.open('login'); // Open Netlify Identity login
                            } else {
                                showPricingModal(); // Show pricing plans
                            }
                        });
                    } else {
                        // Show insufficient credits modal for logged-in users
                        showModal({
                            title: 'Créditos Insuficientes',
                            body: 'No tienes suficientes créditos de tu plan ni créditos de recompensa. Mejora tu plan para obtener más o espera al próximo mes.',
                            confirmText: 'Ver Planes'
                        }).then(res => { if (res.confirmed) showPricingModal(); });
                    }
                    return false;
                }

                // Prioritize plan credits, then reward credits
                if (remaining >= cost) {
                    if (!currentUser) {
                        // Update guest usage in local storage
                        const usageKey = 'guest_usage';
                        let usageData = JSON.parse(localStorage.getItem(usageKey)) || { count: 0 };
                        usageData.count += cost;
                        localStorage.setItem(usageKey, JSON.stringify(usageData));
                    } else {
                        // Update logged-in user's monthly usage in local storage
                        const usageKey = `usage_monthly_${currentUser.id}`;
                        const currentMonth = dayjs().format('YYYY-MM');
                        let usageData = JSON.parse(localStorage.getItem(usageKey)) || { count: 0, month: '' };
                        if (usageData.month !== currentMonth) {
                            usageData = { count: 0, month: currentMonth }; // Reset for new month
                        }
                        usageData.count += cost;
                        localStorage.setItem(usageKey, JSON.stringify(usageData));
                    }
                } else {
                    // Use reward credits if plan credits are insufficient
                    gamificationState.credits -= cost;
                    saveGamificationState(); // Save updated gamification state
                    showInAppNotification("Crédito de Recompensa Usado", `Se ha utilizado un crédito de recompensa. Te quedan ${gamificationState.credits}.`, 2000);
                }


                updateCreditCounter(); // Update credit display in UI

                // Increment GOAT X PRO daily usage counter
                if (modelUsed === 'gpt-4o' && currentUser) {
                    const today = dayjs().format('YYYY-MM-DD');
                    const proUsageKey = `goat_x_pro_usage_${currentUser.id}_${today}`;
                    goatXProUsage++;
                    localStorage.setItem(proUsageKey, goatXProUsage.toString());
                }
                return true;
            }

                            // Increment GOAT X PRO daily usage counter
                if (modelUsed === 'gpt-4o' && currentUser) {
                    const today = dayjs().format('YYYY-MM-DD');
                    const proUsageKey = `goat_x_pro_usage_${currentUser.id}_${today}`;
                    goatXProUsage++;
                    localStorage.setItem(proUsageKey, proUsageKey.toString());
                }
                return true;
            }

            /**
             * Loads the application state from local storage or backend (for logged-in users).
             * Initializes default chats if they don't exist.
             */
            async function loadStateForUser() {
                // Helper to safely load and parse JSON from local storage
                const loadLocalStorage = (key) => {
                    const saved = localStorage.getItem(key);
                    try {
                        // Basic validation to prevent JSON.parse errors on invalid data
                        if (saved && saved.startsWith('{') && saved.endsWith('}')) {
                            return JSON.parse(saved);
                        }
                    } catch (e) {
                        console.error("Error parsing localStorage data for key:", key, e);
                        localStorage.removeItem(key); // Clear corrupted data
                    }
                    return {};
                };

                if (!currentUser) {
                    // Load state for guest users from local storage
                    const guestData = loadLocalStorage('guestState');
                    state = guestData.state || { chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
                    currentChatId = guestData.currentChatId || null;
                } else {
                     try {
                        // Attempt to load state from backend (Netlify function) for logged-in users
                        const response = await fetch('/.netlify/functions/load-chats', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId: currentUser.id }),
                        });
                        if (!response.ok) { throw new Error(`Server error: ${response.status}`); }
                        const dbState = await response.json();
                        state = dbState.state || { chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
                        currentChatId = dbState.currentChatId;
                    } catch (error) {
                        // Fallback to local storage if backend load fails
                        console.error("Could not load from DB, falling back to localStorage:", error);
                        const userLocalData = loadLocalStorage(`goatbotState_${currentUser.id}`);
                        state = userLocalData.state || { chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
                        currentChatId = userLocalData.currentChatId;
                    }
                }

                // Restore last viewed chat/workflow from local storage
                const lastView = localStorage.getItem('lastView');
                if (lastView) {
                    currentChatId = lastView;
                }


                // Ensure all top-level state properties exist
                state.calendar = state.calendar || {};
                state.projects = state.projects || {};
                state.chats = state.chats || {};
                state.structure = state.structure || [];
                state.notes = state.notes || [];

                // Ensure 'notepad-assistant-chat' exists and is marked as non-deletable
                if (!state.chats['notepad-assistant-chat']) {
                    state.chats['notepad-assistant-chat'] = {
                        id: 'notepad-assistant-chat',
                        title: 'Asistente de Redacción',
                        messages: [{ role: 'assistant', content: '¡Hola! Soy tu asistente de redacción. Pega tu texto aquí o pídeme ideas para empezar. También puedo corregir la ortografía.' }],
                        workflow: 'notepad-assistant',
                        isDeletable: false, // Cannot be deleted by user
                    };
                }
                // Ensure 'english-teacher-translate-chat' exists and is marked as non-deletable
                if (!state.chats['english-teacher-translate-chat']) {
                    state.chats['english-teacher-translate-chat'] = {
                        id: 'english-teacher-translate-chat',
                        title: 'Traducir/Corregir Texto',
                        messages: [{ role: 'assistant', content: '¡Hola! Soy tu asistente de traducción. Pega tu texto en español en el panel izquierdo para obtener la traducción al inglés. También puedo corregir el texto.' }],
                        workflow: 'english-teacher-translate',
                        isDeletable: false, // Cannot be deleted by user
                    };
                }

                // Initialize GOAT X PRO usage counter for the current day
                const today = dayjs().format('YYYY-MM-DD');
                const proUsageKey = `goat_x_pro_usage_${currentUser?.id || 'guest'}_${today}`;
                goatXProUsage = parseInt(localStorage.getItem(proUsageKey) || '0');

                // Load gamification state (must happen before rendering anything that depends on it)
                await loadGamificationState();

                renderSidebar(); // Initial render of the sidebar

                const urlParams = new URLSearchParams(window.location.search);
                const chatIdFromUrl = urlParams.get('chat');

                // Logic to determine which chat or view to select on load
                let chatToSelect = null;
                if (chatIdFromUrl && (state.chats[chatIdFromUrl] || (state.notes || []).find(n => n.id === chatIdFromUrl))) {
                    chatToSelect = chatIdFromUrl;
                } else if (currentChatId && (state.chats[currentChatId] || (state.notes || []).find(n => n.id === currentChatId) || currentChatId.startsWith('note-') || currentChatId === 'notepad-app' || currentChatId === 'translator-view')) {
                    chatToSelect = currentChatId;
                } else if (state.structure && state.structure.length > 0) {
                     const firstValidItem = state.structure.find(id => state.chats[id] || state.notes.find(n => n.id === id));
                     chatToSelect = firstValidItem;
                }

                if (chatToSelect) {
                    selectChat(chatToSelect); // Select the determined chat/view
                } else {
                    resetChatView(); // Fallback to default view if nothing to select
                }
            }

            /**
             * Saves the current application state to local storage and (for logged-in users) to the backend.
             */
            async function saveState() {
                const stateData = { state, currentChatId };
                const key = currentUser ? `goatbotState_${currentUser.id}` : 'guestState';

                try {
                    localStorage.setItem(key, JSON.stringify(stateData)); // Save to local storage
                    localStorage.setItem('lastView', currentChatId); // Save last viewed item

                    if(currentUser) {
                        // Send state to backend for persistent storage (debounced if needed for performance)
                        await fetch('/.netlify/functions/save-chats', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId: currentUser.id, stateToSave: stateData }),
                        });
                    }
                } catch (error) {
                    console.error("Failed to save state:", error);
                    // Implement a more robust error handling, maybe a queue for failed saves
                }
            }

            /**
             * Updates the UI elements related to user login status and plan.
             * Hides/shows login/user menu, personalizes welcome message, and updates model selector.
             */
            function updateUserUI() {
                const goatXProModels = document.querySelectorAll('.goat-x-pro-model');
                if (currentUser) {
                    // Logged in user UI
                    dom.loginView.classList.add('hidden');
                    dom.userMenuView.classList.remove('hidden');
                    dom.genericWelcome.classList.add('hidden');
                    dom.personalizedWelcome.classList.remove('hidden');
                    const userName = currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.email.split('@')[0];
                    dom.userEmail.textContent = currentUser.user_metadata?.full_name || currentUser.email;
                    dom.userName.textContent = userName;
                    // Show upgrade plan container only if user is on 'free' plan
                    dom.upgradePlanContainer.classList.toggle('hidden', (currentUser.app_metadata?.plan || 'free') !== 'free');
                    goatXProModels.forEach(option => option.disabled = false); // Enable GOAT X PRO for logged-in users

                } else {
                    // Guest user UI
                    dom.loginView.classList.remove('hidden');
                    dom.userMenuView.classList.add('hidden');
                    dom.genericWelcome.classList.remove('hidden');
                    dom.personalizedWelcome.classList.add('hidden');
                    dom.upgradePlanContainer.classList.add('hidden');
                    goatXProModels.forEach(option => option.disabled = true); // Disable GOAT X PRO for guests
                }
                updateCreditCounter(); // Always update credit counter after user UI changes
            }

            /**
             * Updates the display of plan credits and reward credits in the header.
             */
            function updateCreditCounter() {
                const { remaining, limit } = getCreditCount();
                const gamCredits = (gamificationState && gamificationState.credits) ? gamificationState.credits : 0;
                let displayLimit = limit === Infinity ? '∞' : limit; // Display '∞' for unlimited credits

                dom.planCreditsDisplay.textContent = `${remaining}/${displayLimit}`;
                dom.rewardCreditsDisplay.textContent = `${gamCredits}`;

                dom.messageCounterWrapper.classList.remove('hidden'); // Ensure credit counter is visible
            }


            /**
             * Sets the application theme (dark or light).
             * Updates body classes and theme icon.
             * @param {boolean} isDark - True for dark theme, false for light theme.
             */
            function setTheme(isDark) {
                document.body.className = 'w-screen overflow-x-hidden'; // Reset class to remove previous theme
                document.body.classList.add(isDark ? 'dark-theme' : 'light-theme'); // Apply new theme class
                dom.themeIcon.className = `fas fa-${isDark ? 'sun' : 'moon'}`; // Update main theme toggle icon
                if (dom.settingsThemeIcon) dom.settingsThemeIcon.className = `fas fa-${isDark ? 'moon' : 'sun'} mr-2`; // Update settings modal theme icon
                localStorage.setItem('theme', isDark ? 'dark' : 'light'); // Save theme preference
            }

            /**
             * Toggles the visibility and collapsed state of the sidebar.
             * @param {boolean} show - True to show/expand, false to hide/collapse.
             */
            function toggleSidebar(show) {
                const sidebar = dom.sidebar;
                if (show) {
                    sidebar.classList.add('is-open'); // For mobile: slides in
                    sidebar.classList.remove('collapsed'); // For desktop: expands
                    dom.sidebarOverlay.classList.remove('opacity-0', 'pointer-events-none'); // Show overlay on mobile
                    dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-right', 'fa-chevron-left'); // Update toggle arrow
                } else {
                    sidebar.classList.remove('is-open'); // For mobile: slides out
                    dom.sidebarOverlay.classList.add('opacity-0', 'pointer-events-none'); // Hide overlay on mobile
                    dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-left', 'fa-chevron-right'); // Update toggle arrow
                }
            }

            /**
             * Creates a new chat conversation.
             * @param {object} [options={}] - Options for the new chat (title, workflow, initialMessages, model).
             * @returns {string} The ID of the newly created chat.
             */
            function createNewChat(options = {}) {
                const id = 'chat-' + crypto.randomUUID(); // Generate unique ID
                const name = currentUser ? (currentUser.user_metadata.full_name?.split(' ')[0] || 'Tú') : 'viajero';
                let title = 'Jefe';
                if (name.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(name.toLowerCase())) {
                    title = 'Jefa';
                }

                let initialMessages;
                // Set initial messages based on workflow or default
                initialMessages = options.initialMessages ||
                [{
                    role: 'assistant',
                    content: `Saludos, ${title}. Soy Goatify IA, aquí para servirte. Cada idea tuya es una estrella a punto de nacer. ¿En qué universo nos sumergimos hoy?`
                }];

                // Create the new chat object
                state.chats[id] = {
                    id,
                    title: options.title || translations[localStorage.getItem('goatify-lang') || 'es'].default_chat_title || "Conversación Cósmica",
                    messages: initialMessages,
                    workflow: options.workflow || null,
                    model: options.model || 'gpt-3.5-turbo-1106'
                };

                // Add project-specific data if it's a project management workflow
                if (options.workflow === 'project-management') {
                    state.chats[id].projectData = {
                        title: options.title,
                        columns: [
                             { id: 'todo', title: 'Por Hacer', tasks: [] },
                            { id: 'doing', title: 'En Progreso', tasks: [] },
                            { id: 'done', title: 'Hecho', tasks: [] }
                         ],
                        currentView: 'list' // Default view for new projects
                    };
                }
                // Add financial-specific data if it's a financial assistant workflow
                if (options.workflow === 'financial-assistant') {
                    state.chats[id].financialData = {
                        incomeCategories: [],
                        expenseCategories: []
                    };
                }

                state.structure.unshift(id); // Add new chat to the top of the structure
                selectChat(id); // Select the new chat
                saveState(); // Save the updated state
                renderSidebar(); // Re-render sidebar to show new chat
                dom.modelSelector.value = options.model || 'gpt-3.5-turbo-1106'; // Set model selector to new chat's model
                if (window.innerWidth < 768) toggleSidebar(false); // Close sidebar on mobile

                const chatType = options.title || 'chat';
                showInAppNotification(translations[localStorage.getItem('goatify-lang') || 'es'].success_title || "Éxito", `${translations[localStorage.getItem('goatify-lang') || 'es'].new_chat_created || "Has creado un nuevo" } ${chatType}.`, 800);

                return id;
            }

            /**
             * Selects a chat or workflow view and updates the UI accordingly.
             * @param {string} chatId - The ID of the chat or special view to select.
             */
            function selectChat(chatId) {
                currentChatId = chatId;
                localStorage.setItem('lastView', chatId); // Save last viewed item
                history.pushState({ chatId }, '', `?chat=${chatId}`); // Update browser history
                if (isSelectModeActive) return; // Do not proceed if in select mode

                dom.notepadViewContainer.classList.remove('mobile-editor-active'); // Hide mobile editor if active

                // Hide all main content views initially
                dom.chatMessages.style.display = 'none';
                dom.projectManagementView.style.display = 'none';
                dom.financialAssistantView.style.display = 'none';
                dom.notepadViewContainer.style.display = 'none';
                dom.translatorView.style.display = 'none';
                dom.inputArea.style.display = 'none'; // Hide main input area by default

                if (!chatId) {
                    resetChatView(); // If no ID, reset to default view
                    return;
                }

                // Show specific view based on chatId
                if (chatId === 'translator-view') {
                    showTranslatorView();
                } else if (chatId.startsWith('note-') || chatId === 'notepad-app') {
                    dom.chatTitle.textContent = translations[localStorage.getItem('goatify-lang') || 'es'].wf_notepad;
                    dom.mobileChatTitle.textContent = translations[localStorage.getItem('goatify-lang') || 'es'].wf_notepad;
                    showNotepadView();

                    if (chatId.startsWith('note-')) {
                        selectNote(chatId); // Select specific note
                    } else {
                        // If notepad app is selected and no specific note, select the first note or hide editor
                        if (state.notes.length > 0) {
                            selectNote(state.notes[0].id);
                        } else {
                            dom.noteEditorPanel.classList.add('hidden');
                        }
                    }
                } else if (state.chats[chatId]) {
                    const chat = state.chats[chatId];
                    if (chat.workflow === 'project-management') {
                        dom.projectManagementView.style.display = 'flex';
                        renderProjectView(chatId);
                    } else if (chat.workflow === 'financial-assistant') {
                        dom.financialAssistantView.style.display = 'flex';
                        renderFinancialAssistant(chatId);
                    } else {
                        // Default chat view
                        dom.chatMessages.style.display = 'block';
                        dom.inputArea.style.display = 'flex';
                        dom.chatMessages.innerHTML = '';
                        chat.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, msg.image, index, dom.chatMessages));
                        dom.initialMessageContainer.style.display = 'none'; // Hide welcome message
                    }

                    dom.chatTitle.textContent = chat.title; // Update chat title in header
                    dom.mobileChatTitle.textContent = chat.title;
                    dom.modelSelector.value = chat.model || 'gpt-3.5-turbo-1106'; // Set model selector
                    updateContextualFooter(chat.workflow); // Update footer message
                } else {
                     resetChatView(); // If chat not found, reset view
                }


                updateActiveChatHighlight(); // Highlight selected chat in sidebar
                saveState(); // Save current state
                if (window.innerWidth < 768) toggleSidebar(false); // Close sidebar on mobile
            }

            /**
             * Resets the main chat area to the default welcome message.
             */
            function resetChatView() {
                currentChatId = null;
                localStorage.removeItem('lastView'); // Clear last viewed item
                history.pushState({ chatId: null }, '', window.location.pathname); // Clear URL parameter
                dom.chatTitle.textContent = "Goatify IA"; // Reset header title
                dom.mobileChatTitle.textContent = "Goatify IA";

                // Hide all specific views
                dom.projectManagementView.style.display = 'none';
                dom.financialAssistantView.style.display = 'none';
                dom.notepadViewContainer.style.display = 'none';
                dom.translatorView.style.display = 'none';

                // Show default chat view
                dom.chatMessages.style.display = 'block';
                dom.inputArea.style.display = 'flex';
                dom.chatMessages.innerHTML = ''; // Clear messages
                dom.initialMessageContainer.style.display = 'flex'; // Show welcome message

                updateUserUI(); // Update user-related UI
                updateActiveChatHighlight(); // Clear sidebar highlight
                dom.modelSelector.value = 'gpt-3.5-turbo-1106'; // Reset model selector
                updateContextualFooter(null); // Reset footer message
            }

            /**
             * Adds a message bubble to the UI.
             * @param {string} role - The role of the sender ('user' or 'assistant').
             * @param {string} content - The message content (can contain Markdown).
             * @param {string} [imageSrc=null] - Optional base64 image source to display.
             * @param {number} messageIndex - The index of the message in the chat's message array.
             * @param {HTMLElement} container - The DOM element to append the message to.
             * @returns {HTMLElement} The created message bubble element.
             */
            function addMessageToUI(role, content, imageSrc, messageIndex, container) {
                if (!container) return null;
                const wrapper = document.createElement('div');
                wrapper.className = `chat-bubble-wrapper group flex items-start gap-2 my-2 ${role === 'user' ? 'justify-end' : 'justify-start'}`;

                const bubble = document.createElement('div');
                bubble.className = `p-3 md:p-4 rounded-xl max-w-lg md:max-w-xl ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot'}`;
                if (imageSrc) {
                    const img = document.createElement('img');
                    img.src = imageSrc;
                    img.className = 'rounded-lg mb-2 max-w-full h-auto';
                    bubble.appendChild(img);
                }
                const contentDiv = document.createElement('div');
                contentDiv.className = 'markdown-content';
                // Render Markdown content, show ellipsis for thinking state
                const parsedContent = content === '…' ? `<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .2s;"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: .4s;"></div></div>` : marked.parse(content || "");
                contentDiv.innerHTML = parsedContent;

                // Add speaker icon for assistant messages
                if (role === 'assistant') {
                    const speakerIcon = document.createElement('i');
                    speakerIcon.className = 'fas fa-volume-up speaker-icon';
                    speakerIcon.title = translations[localStorage.getItem('goatify-lang') || 'es'].read_aloud_title || 'Leer en voz alta';
                    speakerIcon.onclick = (e) => {
                        e.stopPropagation();
                        speak(content, e.target);
                    };
                    contentDiv.appendChild(speakerIcon);
                }

                bubble.appendChild(contentDiv);

                // Add edit button for user messages in main chat
                if (role === 'user' && container === dom.chatMessages) {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'p-1 text-text-medium opacity-100 transition-opacity';
                    editBtn.innerHTML = '<i class="fas fa-pencil-alt fa-xs"></i>';
                    editBtn.title = translations[localStorage.getItem('goatify-lang') || 'es'].edit_message_title || 'Editar mensaje';
                    editBtn.onclick = (e) => { e.stopPropagation(); handleEditMessage(messageIndex); };
                    wrapper.insertBefore(editBtn, wrapper.firstChild);
                }

                // Add preview button for code content in assistant messages
                const hasCode = /```html|```css|```javascript|<pre|<code/.test(content);
                if (role === 'assistant' && hasCode) {
                    const previewButton = document.createElement('button');
                    previewButton.innerHTML = `<i class="fas fa-eye mr-2"></i>${translations[localStorage.getItem('goatify-lang') || 'es'].preview}`;
                    previewButton.className = 'btn-primary text-xs font-semibold px-3 py-1 rounded-md mt-3';
                    previewButton.addEventListener('click', () => {
                        const match = content.match(/```(html|css|javascript)\n([\s\S]*?)```/s);
                        let htmlToPreview = content;
                        if(match) {
                            if (match[1] !== 'html') {
                                htmlToPreview = `<pre><code class="language-${match[1]}">${match[2]}</code></pre>`;
                            } else {
                                htmlToPreview = match[2];
                            }
                        }
                        dom.htmlPreviewIframe.srcdoc = htmlToPreview;
                        dom.htmlPreviewModal.classList.remove('hidden');
                        dom.htmlPreviewModal.classList.add('flex');
                    });
                    bubble.appendChild(previewButton);
                }

                wrapper.appendChild(bubble);
                container.appendChild(wrapper);
                container.scrollTop = container.scrollHeight; // Scroll to bottom
                return bubble;
            }

            /**
             * Updates the content of an existing message bubble in the UI.
             * Used for updating "thinking" bubbles with the final AI response.
             * @param {HTMLElement} bubble - The message bubble element to update.
             * @param {string} content - The new message content (can contain Markdown).
             * @param {string} [imageSrc=null] - Optional base64 image source to display.
             * @param {HTMLElement} container - The parent container of the message bubble.
             */
            function updateMessageInUI(bubble, content, imageSrc, container) {
                if (!bubble) return;
                const wrapper = bubble.parentElement;
                if (!wrapper) return;

                bubble.innerHTML = ''; // Clear existing content
                 if (imageSrc) {
                    const img = document.createElement('img');
                    img.src = imageSrc;
                    img.className = 'rounded-lg mb-2 max-w-full h-auto';
                    bubble.appendChild(img);
                }
                const contentDiv = document.createElement('div');
                contentDiv.className = 'markdown-content';
                contentDiv.innerHTML = marked.parse(content || ""); // Parse and render Markdown

                // Add speaker icon for assistant messages
                const speakerIcon = document.createElement('i');
                speakerIcon.className = 'fas fa-volume-up speaker-icon';
                speakerIcon.title = translations[localStorage.getItem('goatify-lang') || 'es'].read_aloud_title || 'Leer en voz alta';
                speakerIcon.onclick = (e) => { e.stopPropagation(); speak(content, e.target); };
                contentDiv.appendChild(speakerIcon);

                bubble.appendChild(contentDiv);

                // Add preview button for code content
                const hasCode = /```html|```css|```javascript|<pre|<code/.test(content);
                if (hasCode) {
                    const previewButton = document.createElement('button');
                    previewButton.innerHTML = `<i class="fas fa-eye mr-2"></i>${translations[localStorage.getItem('goatify-lang') || 'es'].preview}`;
                    previewButton.className = 'btn-primary text-xs font-semibold px-3 py-1 rounded-md mt-3';
                    previewButton.addEventListener('click', () => {
                         const match = content.match(/```(html|css|javascript)\n([\s\S]*?)```/s);
                        let htmlToPreview = content;
                        if(match) {
                            if (match[1] !== 'html') {
                                htmlToPreview = `<pre><code class="language-${match[1]}">${match[2]}</code></pre>`;
                            } else {
                                htmlToPreview = match[2];
                            }
                        }
                        dom.htmlPreviewIframe.srcdoc = htmlToPreview;
                        dom.htmlPreviewModal.classList.remove('hidden');
                        dom.htmlPreviewModal.classList.add('flex');
                    });
                    bubble.appendChild(previewButton);
                }
            }
            /**
             * Handles editing a user message in the main chat.
             * Opens a modal to allow editing the message content.
             * @param {number} index - The index of the message in the current chat's message array.
             */
            async function handleEditMessage(index) {
                const chat = state.chats[currentChatId];
                if (!chat || !chat.messages[index]) return;
                const originalContent = chat.messages[index].content;
                const result = await showModal({
                    title: translations[localStorage.getItem('goatify-lang') || 'es'].edit_message_title || 'Editar Mensaje',
                    body: `<textarea id="edit-msg-textarea" class="w-full p-2 rounded bg-input border border-themed h-28">${originalContent}</textarea>`,
                    confirmText: translations[localStorage.getItem('goatify-lang') || 'es'].save_changes_btn || 'Guardar Cambios'
                 });
                // If confirmed and content changed, update message and re-render chat
                if (result.confirmed && result.data['edit-msg-textarea'] && result.data['edit-msg-textarea'].trim() !== originalContent.trim()) {
                    chat.messages[index].content = result.data['edit-msg-textarea'].trim();
                    await saveState();
                    selectChat(currentChatId);
                }
            }

            /**
             * Updates the content of an existing message bubble in the UI.
             * Used for updating "thinking" bubbles with the final AI response.
             * @param {HTMLElement} bubble - The message bubble element to update.
             * @param {string} content - The new message content (can contain Markdown).
             * @param {string} [imageSrc=null] - Optional base64 image source to display.
             * @param {HTMLElement} container - The parent container of the message bubble.
             */
            function updateMessageInUI(bubble, content, imageSrc, container) {
                if (!bubble) return;
                const wrapper = bubble.parentElement;
                if (!wrapper) return;

                bubble.innerHTML = ''; // Clear existing content
                 if (imageSrc) {
                    const img = document.createElement('img');
                    img.src = imageSrc;
                    img.className = 'rounded-lg mb-2 max-w-full h-auto';
                    bubble.appendChild(img);
                }
                const contentDiv = document.createElement('div');
                contentDiv.className = 'markdown-content';
                contentDiv.innerHTML = marked.parse(content || ""); // Parse and render Markdown

                // Add speaker icon for assistant messages
                const speakerIcon = document.createElement('i');
                speakerIcon.className = 'fas fa-volume-up speaker-icon';
                speakerIcon.title = translations[localStorage.getItem('goatify-lang') || 'es'].read_aloud_title || 'Leer en voz alta';
                speakerIcon.onclick = (e) => { e.stopPropagation(); speak(content, e.target); };
                contentDiv.appendChild(speakerIcon);

                bubble.appendChild(contentDiv);

                // Add preview button for code content
                const hasCode = /```html|```css|```javascript|<pre|<code/.test(content);
                if (hasCode) {
                    const previewButton = document.createElement('button');
                    previewButton.innerHTML = `<i class="fas fa-eye mr-2"></i>${translations[localStorage.getItem('goatify-lang') || 'es'].preview}`;
                    previewButton.className = 'btn-primary text-xs font-semibold px-3 py-1 rounded-md mt-3';
                    previewButton.addEventListener('click', () => {
                         const match = content.match(/```(html|css|javascript)\n([\s\S]*?)```/s);
                        let htmlToPreview = content;
                        if(match) {
                            if (match[1] !== 'html') {
                                htmlToPreview = `<pre><code class="language-${match[1]}">${match[2]}</code></pre>`;
                            } else {
                                htmlToPreview = match[2];
                            }
                        }
                        dom.htmlPreviewIframe.srcdoc = htmlToPreview;
                        dom.htmlPreviewModal.classList.remove('hidden');
                        dom.htmlPreviewModal.classList.add('flex');
                    });
                    bubble.appendChild(previewButton);
                }
            }
            /**
             * Renders the sidebar content, including chats, notes, and project folders.
             * Organizes items based on the `state.structure`.
             */
            function renderSidebar() {
                dom.sidebarContent.innerHTML = ''; // Clear existing chats
                dom.foldersContainer.innerHTML = ''; // Clear existing folders
                const fragChats = document.createDocumentFragment(); // Use fragments for performance
                const fragFolders = document.createDocumentFragment();

                // Create a map of all items (chats, notes, projects) for quick lookup
                const itemMap = new Map();
                Object.values(state.chats).forEach(chat => itemMap.set(chat.id, { type: 'chat', data: chat }));
                (state.notes || []).forEach(note => itemMap.set(note.id, { type: 'note', data: note }));
                Object.values(state.projects).forEach(proj => itemMap.set(proj.id, { type: 'project', data: proj }));

                // Track items that are not yet filed into a folder
                const unfiledItems = new Set(state.structure);

                // Render project folders first
                Object.values(state.projects).forEach(proj => {
                    const projectEl = createProjectElement(proj.id);
                    fragFolders.appendChild(projectEl);
                    unfiledItems.delete(proj.id); // Remove project itself from unfiled
                    (proj.itemIds || []).forEach(childId => unfiledItems.delete(childId)); // Remove children from unfiled
                });

                // Render unfiled chats and notes
                unfiledItems.forEach(id => {
                    const item = itemMap.get(id);
                    if (!item) return;

                    if (item.type === 'chat') fragChats.appendChild(createChatItemElement(id, false));
                    if (item.type === 'note') fragChats.appendChild(createNoteItemElement(id, false));
                });

                // Append fragments to their respective containers
                dom.foldersContainer.appendChild(fragFolders);
                dom.sidebarContent.appendChild(fragChats);
                updateActiveChatHighlight(); // Ensure the currently selected item is highlighted
            }

            /**
             * Creates a DOM element for a chat item in the sidebar.
             * Supports selection mode and regular interaction.
             * @param {string} id - The ID of the chat.
             * @param {boolean} isSubItem - True if the chat is a sub-item within a folder.
             * @returns {HTMLElement|DocumentFragment} The created chat item element or an empty fragment if chat is not deletable.
             */
            function createChatItemElement(id, isSubItem = false) {
                const chat = state.chats[id];
                if (!chat || chat.isDeletable === false) return document.createDocumentFragment(); // Skip non-deletable chats

                const item = document.createElement('div');
                item.className = `chat-item group flex items-center justify-between p-2 rounded-md cursor-pointer hover:bg-light ${isSubItem ? 'pl-8' : ''}`;
                item.dataset.id = id;
                item.dataset.type = 'chat';

                if (isSelectModeActive) {
                    // Render for selection mode
                    item.draggable = false;
                    const isSelected = chatsToDelete.has(id);
                    item.innerHTML = `<i class="far ${isSelected ? 'fa-check-square' : 'fa-square'} mr-2 text-primary"></i><span class="flex-grow truncate text-sm font-medium">${chat.title}</span>`;
                    if (isSelected) item.classList.add('selected-for-delete');
                    item.addEventListener('click', (e) => {
                        e.preventDefault(); // Prevent default chat selection
                        if (chatsToDelete.has(id)) {
                            chatsToDelete.delete(id);
                            item.querySelector('i').classList.replace('fa-check-square', 'fa-square');
                             item.classList.remove('selected-for-delete');
                        } else {
                            chatsToDelete.add(id);
                            item.querySelector('i').classList.replace('fa-square', 'fa-check-square');
                            item.classList.add('selected-for-delete');
                        }
                        dom.deleteSelectedBtn.disabled = chatsToDelete.size === 0; // Enable/disable delete button
                    });
                } else {
                    // Render for regular interaction mode
                    const isMobileView = window.innerWidth < 768;
                    const actionsOpacityClass = isMobileView ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'; // Always show actions on mobile

                    item.draggable = true;
                    item.innerHTML = `
                    <div class="flex-grow flex items-center min-w-0">
                        <i class="far fa-comment-dots mr-2"></i>
                        <span class="truncate text-sm font-medium">${chat.title}</span>
                    </div>
                    <div class="chat-item-actions flex-shrink-0 flex items-center ${actionsOpacityClass} transition-opacity">
                        <button class="add-to-folder-btn text-text-medium hover:text-primary p-1 relative" title="${translations[localStorage.getItem('goatify-lang') || 'es'].add_to_folder}"><i class="fas fa-folder-plus fa-xs"></i>
                            <div class="add-to-folder-dropdown absolute hidden top-full left-1/2 -translate-x-1/2 mt-2 p-2 rounded-md shadow-lg"></div>
                        </button>
                        <button class="rename-btn text-text-medium hover:text-primary p-1" title="${translations[localStorage.getItem('goatify-lang') || 'es'].rename_title}"><i class="fas fa-pencil-alt fa-xs"></i></button>
                        <button class="delete-btn text-text-medium hover:text-red-500 p-1" title="${translations[localStorage.getItem('goatify-lang') || 'es'].delete_title}"><i class="fas fa-trash-alt fa-xs"></i></button>
                    </div>`;

                    item.addEventListener('click', e => {
                        if (!e.target.closest('.chat-item-actions')) { // Only select chat if action buttons not clicked
                            e.preventDefault();
                            selectChat(id);
                        }
                    });

                    item.addEventListener('dragstart', e => handleDragStart(e, id)); // Enable drag for moving items

                    const addToFolderBtn = item.querySelector('.add-to-folder-btn');
                    const renameBtn = item.querySelector('.rename-btn');
                    const deleteBtn = item.querySelector('.delete-btn');

                    if (addToFolderBtn) {
                        addToFolderBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation(); // Prevent dropdown from closing immediately
                            const dropdown = addToFolderBtn.querySelector('.add-to-folder-dropdown');
                            // Close other open dropdowns
                            document.querySelectorAll('.add-to-folder-dropdown').forEach(d => {
                                if(d !== dropdown) d.classList.add('hidden');
                            });
                            dropdown.classList.toggle('hidden'); // Toggle visibility of current dropdown
                            renderFolderDropdown(id, dropdown); // Populate dropdown with folders
                        });
                    }

                    renameBtn.addEventListener('click', (e) => { e.stopPropagation(); e.preventDefault(); renameItem('chat', id); });
                    deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); e.preventDefault(); deleteItem('chat', id); });
                }
                return item;
            }

            /**
             * Creates a DOM element for a note item in the sidebar.
             * Supports selection mode and regular interaction.
             * @param {string} id - The ID of the note.
             * @param {boolean} isSubItem - True if the note is a sub-item within a folder.
             * @returns {HTMLElement|DocumentFragment} The created note item element or an empty fragment if note not found.
             */
            function createNoteItemElement(id, isSubItem = false) {
                const note = state.notes.find(n => n.id === id);
                if (!note) return document.createDocumentFragment();

                const item = document.createElement('div');
                item.className = 'note-item group flex items-center justify-between p-2 rounded-md cursor-pointer';
                if (isSubItem) item.classList.add('pl-8');
                item.dataset.id = note.id;
                item.dataset.type = 'note';

                const isMobileView = window.innerWidth < 768;
                const actionsOpacityClass = isMobileView ? 'opacity-100' : 'opacity-0 group-hover:opacity-100';

                if (isSelectModeActive) {
                    // Render for selection mode
                    item.draggable = false;
                    const isSelected = chatsToDelete.has(id);
                    item.innerHTML = `<i class="far ${isSelected ? 'fa-check-square' : 'fa-square'} mr-2 text-primary"></i><span class="flex-grow truncate text-sm font-medium">${note.title}</span>`;
                    if (isSelected) item.classList.add('selected-for-delete');
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (chatsToDelete.has(id)) {
                            chatsToDelete.delete(id);
                            item.querySelector('i').classList.replace('fa-check-square', 'fa-square');
                             item.classList.remove('selected-for-delete');
                        } else {
                            chatsToDelete.add(id);
                            item.querySelector('i').classList.replace('fa-square', 'fa-check-square');
                            item.classList.add('selected-for-delete');
                        }
                        dom.deleteSelectedBtn.disabled = chatsToDelete.size === 0;
                    });
                } else {
                    // Render for regular interaction mode
                    item.draggable = true;
                    item.innerHTML = `
                        <div class="flex-grow flex items-center min-w-0">
                            <i class="fas ${note.type === 'drawing' ? 'fa-paint-brush' : 'fa-file-alt'} mr-2"></i>
                            <span class="truncate text-sm font-medium">${note.title}</span>
                        </div>
                        <div class="chat-item-actions flex-shrink-0 ${actionsOpacityClass} transition-opacity">
                            <button class="add-to-folder-btn text-text-medium hover:text-primary p-1 relative" title="${translations[localStorage.getItem('goatify-lang') || 'es'].add_to_folder}"><i class="fas fa-folder-plus fa-xs"></i>
                                <div class="add-to-folder-dropdown absolute hidden top-full left-1/2 -translate-x-1/2 mt-2 p-2 rounded-md shadow-lg"></div>
                            </button>
                            <button class="rename-btn text-text-medium hover:text-primary p-1" title="${translations[localStorage.getItem('goatify-lang') || 'es'].rename_title}"><i class="fas fa-pencil-alt fa-xs"></i></button>
                            <button class="delete-btn text-text-medium hover:text-red-500 p-1" title="${translations[localStorage.getItem('goatify-lang') || 'es'].delete_title}"><i class="fas fa-trash-alt fa-xs"></i></button>
                        </div>
                    `;
                    item.addEventListener('click', e => {
                         if (!e.target.closest('.chat-item-actions')) {
                            e.preventDefault();
                            selectChat(id); // Select the note
                            if (window.innerWidth < 768) {
                                dom.notepadViewContainer.classList.add('mobile-editor-active'); // Show note editor on mobile
                            }
                        }
                    });

                    item.addEventListener('dragstart', e => handleDragStart(e, id)); // Enable drag for moving items

                    const addToFolderBtn = item.querySelector('.add-to-folder-btn');
                    const renameBtn = item.querySelector('.rename-btn');
                    const deleteBtn = item.querySelector('.delete-btn');

                    if (addToFolderBtn) {
                        addToFolderBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const dropdown = addToFolderBtn.querySelector('.add-to-folder-dropdown');
                            document.querySelectorAll('.add-to-folder-dropdown').forEach(d => {
                                if(d !== dropdown) d.classList.add('hidden');
                            });
                            dropdown.classList.toggle('hidden');
                            renderFolderDropdown(id, dropdown);
                        });
                    }
                    renameBtn.addEventListener('click', (e) => { e.stopPropagation(); e.preventDefault(); renameItem('note', id); });
                    deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); e.preventDefault(); deleteItem('note', id); });
                }
                return item;
            }

            /**
             * Renders the dropdown menu for moving a chat/note to a project folder.
             * @param {string} itemId - The ID of the item to move.
             * @param {HTMLElement} dropdownElement - The dropdown container element.
             */
            function renderFolderDropdown(itemId, dropdownElement) {
                dropdownElement.innerHTML = '';
                const folders = Object.values(state.projects);
                // Find the current folder the item belongs to
                const currentFolderId = Object.values(state.projects).find(p => p.itemIds && p.itemIds.includes(itemId))?.id;

                if (folders.length === 0) {
                    dropdownElement.innerHTML = `<button class="p-2 text-xs text-text-medium italic" disabled>${translations[localStorage.getItem('goatify-lang') || 'es'].no_folders_yet}</button>`;
                    return;
                }

                folders.forEach(folder => {
                    const button = document.createElement('button');
                    button.textContent = folder.title;
                    button.dataset.folderId = folder.id;
                    if (folder.id === currentFolderId) {
                        button.disabled = true; // Disable if already in this folder
                        button.classList.add('bg-current-primary', 'text-white');
                    }
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault(); // Prevent any parent link navigation
                        moveItemToProject(itemId, folder.id); // Move item to selected folder
                        dropdownElement.classList.add('hidden'); // Hide dropdown
                    });
                    dropdownElement.appendChild(button);
                });
            }

            /**
             * Creates a DOM element for a project folder in the sidebar.
             * @param {string} id - The ID of the project.
             * @returns {HTMLElement|DocumentFragment} The created project element or an empty fragment if project not found.
             */
            function createProjectElement(id) {
                const project = state.projects[id];
                if (!project) return document.createDocumentFragment();
                const div = document.createElement('div');
                div.className = 'project folders-category';
                div.dataset.id = id;
                const header = document.createElement('div');
                header.className = 'project-header folders-header group flex items-center p-2 rounded-md cursor-pointer hover:bg-light';

                const isMobileView = window.innerWidth < 768;
                const actionsOpacityClass = isMobileView ? 'opacity-100' : 'opacity-0 group-hover:opacity-100';

                header.innerHTML = `<i class="fas fa-chevron-right project-arrow folder-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-folder mr-2 text-yellow-500"></i><span class="flex-grow truncate text-sm font-bold">${project.title}</span><div class="chat-item-actions flex-shrink-0 ${actionsOpacityClass} transition-opacity"><button class="rename-btn text-text-medium hover:text-primary p-1" title="${translations[localStorage.getItem('goatify-lang') || 'es'].rename_title}"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-text-medium hover:text-red-500 p-1" title="${translations[localStorage.getItem('goatify-lang') || 'es'].delete_title}"><i class="fas fa-trash-alt fa-xs"></i></button></div>`;
                const content = document.createElement('div');
                content.className = 'project-content folders-content pt-1 space-y-1';
                // Add child items (chats and notes) to the project content
                (project.itemIds || []).forEach(itemId => {
                    if (itemId.startsWith('chat-') && itemId !== 'notepad-assistant-chat') content.appendChild(createChatItemElement(itemId, true));
                    if (itemId.startsWith('note-')) content.appendChild(createNoteItemElement(itemId, true));
                });
                div.append(header, content);
                header.addEventListener('click', e => {
                    if (!e.target.closest('.chat-item-actions')) {
                        const isOpen = div.classList.toggle('open');
                        project.isOpen = isOpen; // Persist open/closed state
                        saveState();
                    }
                });
                // Drag and drop listeners for project headers (to drop items into folders)
                header.addEventListener('dragover', e => handleDragOver(e, header));
                header.addEventListener('dragleave', e => handleDragLeave(e, header));
                header.addEventListener('drop', e => handleDrop(e, id, header));
                header.querySelector('.rename-btn').addEventListener('click', (e) => { e.stopPropagation(); e.preventDefault(); renameItem('project', id);});
                header.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); e.preventDefault(); deleteItem('project', id);});

                if (project.isOpen) {
                    div.classList.add('open');
                } else {
                    div.classList.remove('open');
                }
                return div;
            }
            let draggedItemId = null; // ID of the item currently being dragged
            let currentDragSelection = null; // Stores selected items if in multi-select mode
            /**
             * Handles the start of a drag operation for a sidebar item (chat or note).
             * @param {DragEvent} e - The drag event.
             * @param {string} id - The ID of the dragged item.
             */
            function handleDragStart(e, id) {
                draggedItemId = id;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', id); // Set plain text data for compatibility
                // If in select mode, transfer all selected items
                if (isSelectModeActive && chatsToDelete.has(id)) {
                    e.dataTransfer.setData('application/json', JSON.stringify(Array.from(chatsToDelete)));
                    currentDragSelection = new Set(chatsToDelete);
                } else {
                    currentDragSelection = new Set([id]);
                }
            }
            /**
             * Handles the drag over event for a drop target.
             * @param {DragEvent} e - The drag event.
             * @param {HTMLElement} el - The element being dragged over.
             */
            function handleDragOver(e, el) { e.preventDefault(); el.classList.add('drag-over'); }
            /**
             * Handles the drag leave event for a drop target.
             * @param {DragEvent} e - The drag event.
             * @param {HTMLElement} el - The element being left.
             */
            function handleDragLeave(e, el) { el.classList.remove('drag-over'); }
            /**
             * Handles the drop event for a sidebar item onto a project folder.
             * @param {DragEvent} e - The drop event.
             * @param {string} targetProjectId - The ID of the project folder to drop into.
             * @param {HTMLElement} targetElement - The project header element.
             */
            function handleDrop(e, targetProjectId, targetElement) {
                e.preventDefault();
                if (targetElement) targetElement.classList.remove('drag-over');

                let itemsToMove = [];
                // Check if multiple items were dragged (from selection mode)
                if (e.dataTransfer.types.includes('application/json')) {
                    try {
                        const droppedItems = JSON.parse(e.dataTransfer.getData('application/json'));
                        itemsToMove = droppedItems.filter(id => (id.startsWith('chat-') && state.chats[id]) || (id.startsWith('note-') && state.notes.find(n => n.id === id)));
                    } catch (error) {
                        console.error("Error parsing JSON drag data:", error);
                        // Fallback to single item if JSON parsing fails
                        itemsToMove = [e.dataTransfer.getData('text/plain')].filter(id => (id.startsWith('chat-') && state.chats[id]) || (id.startsWith('note-') && state.notes.find(n => n.id === id)));
                    }
                } else {
                    itemsToMove = [e.dataTransfer.getData('text/plain')].filter(id => (id.startsWith('chat-') && state.chats[id]) || (id.startsWith('note-') && state.notes.find(n => n.id === id)));
                }

                if (itemsToMove.length === 0) return;

                itemsToMove.forEach(itemId => {
                    if (itemId !== targetProjectId) { // Prevent dropping item into itself
                        moveItemToProject(itemId, targetProjectId);
                    }
                });

                // Exit select mode after drag/drop if it was active
                if (isSelectModeActive && itemsToMove.length > 0) {
                    toggleSelectMode(false);
                }
            }
            /**
             * Moves a chat or note item into a specified project folder.
             * If `targetProjectId` is null, the item is moved to the top level (unfiled).
             * @param {string} itemId - The ID of the item to move.
             * @param {string|null} targetProjectId - The ID of the target project folder, or null.
             */
            function moveItemToProject(itemId, targetProjectId = null) {
                // Remove item from its current location in the structure
                state.structure = state.structure.filter(id => id !== itemId);
                // Remove item from any existing project folders
                Object.values(state.projects).forEach(p => { if(p.itemIds) p.itemIds = p.itemIds.filter(id => id !== itemId) });

                if(targetProjectId && state.projects[targetProjectId]){
                    // Add item to the target project folder
                    if(!state.projects[targetProjectId].itemIds) state.projects[targetProjectId].itemIds = [];
                    state.projects[targetProjectId].itemIds.unshift(itemId);
                } else {
                    // Add item to the top level (unfiled)
                    state.structure.unshift(itemId);
                }

                saveState(); // Save updated state
                renderSidebar(); // Re-render sidebar
                if (currentChatId === itemId) {
                    selectChat(currentChatId); // Re-select if it was the active item
                }
            }

            /**
             * Renames a chat, project, or note item.
             * Opens a modal for the user to input the new name.
             * @param {'chat'|'project'|'note'} type - The type of item to rename.
             * @param {string} id - The ID of the item.
             */
            async function renameItem(type, id) {
                let item;
                if(type === 'chat') item = state.chats[id];
                else if(type === 'project') item = state.projects[id];
                else if(type === 'note') item = state.notes.find(n => n.id === id);
                if(!item) return;

                const result = await showModal({
                    title: `${translations[localStorage.getItem('goatify-lang') || 'es'].rename_title_prefix || "Renombrar"} ${type === 'chat' ? (translations[localStorage.getItem('goatify-lang') || 'es'].conversation_text || 'Conversación') : (type === 'project' ? (translations[localStorage.getItem('goatify-lang') || 'es'].project_text || 'Proyecto') : (translations[localStorage.getItem('goatify-lang') || 'es'].note_text || 'Nota'))}`,
                    body: `<input type="text" id="rename-input" class="w-full p-2 rounded bg-input border border-themed" value="${item.title}">`,
                    confirmText: translations[localStorage.getItem('goatify-lang') || 'es'].rename_title || 'Renombrar'
                 });
                if (result.confirmed && result.data['rename-input'] && result.data['rename-input'].trim()) {
                    item.title = result.data['rename-input'].trim();
                    // Update UI if the renamed item is currently active
                    if (type === 'chat' && currentChatId === id) {
                        dom.chatTitle.textContent = item.title;
                        if (dom.mobileChatTitle) dom.mobileChatTitle.textContent = item.title;
                        if(state.chats[id].workflow === 'project-management') {
                            state.chats[id].projectData.title = item.title;
                            dom.projectViewTitle.textContent = item.title;
                        }
                    } else if (type === 'note' && currentNoteId === id) {
                        dom.noteTitleInput.value = item.title;
                    }
                    saveState(); // Save updated state
                    renderSidebar(); // Re-render sidebar to reflect new name
                }
            }
            /**
             * Deletes a chat, project, or note item.
             * Confirms with the user before deletion, especially for projects with contained items.
             * @param {'chat'|'project'|'note'} type - The type of item to delete.
             * @param {string} id - The ID of the item.
             */
            async function deleteItem(type, id) {
                let item, childrenIds = [];
                if(type === 'chat') item = state.chats[id];
                else if(type === 'project') {
                    item = state.projects[id];
                    childrenIds = item.itemIds || [];
                }
                else if(type === 'note') item = state.notes.find(n => n.id === id);
                if(!item) return;

                let body = translations[localStorage.getItem('goatify-lang') || 'es'].undo_action_warning || 'Esta acción no se puede deshacer.';
                if(type === 'project' && childrenIds.length > 0) {
                    body += ` ${translations[localStorage.getItem('goatify-lang') || 'es'].also_delete_items_warning || "También se eliminarán los"} ${childrenIds.length} ${translations[localStorage.getItem('goatify-lang') || 'es'].items_contained_warning || "elementos que contiene."}`
                }

                const confResult = await showModal({
                    title: `${translations[localStorage.getItem('goatify-lang') || 'es'].delete_title || "Eliminar"} ${item.title}?`,
                    body: body,
                    confirmText: translations[localStorage.getItem('goatify-lang') || 'es'].delete || 'Eliminar',
                    dangerConfirm: true // Make confirm button red
                });

                if (confResult.confirmed) {
                    const idsToDelete = [id, ...childrenIds]; // Include children for project deletion
                    idsToDelete.forEach(deleteId => {
                        state.structure = state.structure.filter(i => i !== deleteId); // Remove from main structure
                        if (deleteId.startsWith('chat-')) delete state.chats[deleteId]; // Delete chat object
                        if (deleteId.startsWith('note-')) state.notes = state.notes.filter(n => n.id !== deleteId); // Filter out note
                        if (deleteId.startsWith('project-')) delete state.projects[deleteId]; // Delete project object

                        // Remove from any other project folders it might be in
                        Object.values(state.projects).forEach(p => {
                            if(p.itemIds) p.itemIds = p.itemIds.filter(cid => cid !== deleteId)
                        });

                        // Reset current view if the deleted item was active
                        if (currentChatId === deleteId) resetChatView();
                        if (currentNoteId === deleteId) {
                            currentNoteId = null;
                            dom.noteEditorPanel.classList.add('hidden');
                        }
                    });

                    saveState(); // Save updated state
                    renderSidebar(); // Re-render sidebar
                }
            }

            /**
             * Updates the visual highlight of the currently selected chat/note in the sidebar.
             */
            function updateActiveChatHighlight() {
                document.querySelectorAll('.chat-item, .note-item').forEach(item => {
                    item.classList.toggle('selected-chat', item.dataset.id === currentChatId);
                    item.classList.toggle('active', item.dataset.id === currentNoteId); // For notes in notepad
                });
            }

            /**
             * Clears the selected image data and hides the image preview.
             */
            function clearImageData() {
                dom.imageUploadInput.value = ''; // Clear file input
                dom.imagePreviewContainer.classList.add('hidden'); // Hide preview container
                dom.filePreviewArea.style.display = "none"; // Hide overall file preview area
                selectedImageBase64 = null; // Clear image data
            }
            /**
             * Clears the selected PDF data and hides the PDF preview.
             */
            function clearPdfData() {
                dom.pdfUploadInput.value = ''; // Clear file input
                dom.pdfPreviewContainer.classList.add('hidden'); // Hide preview container
                dom.filePreviewArea.style.display = "none"; // Hide overall file preview area
                selectedPdfText = null; // Clear PDF text data
            }
            /**
             * Checks if there is any file (image or PDF) currently selected.
             * @returns {boolean} True if a file is selected, false otherwise.
             */
            function hasFile() { return selectedImageBase64 || selectedPdfText; }

            /**
             * Sends a message to the AI.
             * Handles different assistant types (main, project, financial, notepad, translator).
             * Manages credit deduction, UI updates, and mission completion.
             * @param {boolean} forceSend - Whether to force sending even if input is empty (e.g., for file-only messages).
             * @param {string|null} spokenMessage - Message from speech recognition (optional).
             * @param {object} options - Options object.
             * @param {string} [options.assistantType='main'] - The type of assistant sending the message.
             */
            async function sendMessage(forceSend = false, spokenMessage = null, { assistantType = 'main' } = {}) {
                let inputEl, messageContainer, financialData = null, noteContent = null;
                let chatIdToUpdate = currentChatId;
                let modelToUse;

                // Determine which input element, message container, and model to use based on assistant type
                switch(assistantType) {
                    case 'project':
                        inputEl = dom.projectMsgInput;
                        messageContainer = dom.projectChatMessages;
                        modelToUse = getModelForRequest(state.chats[chatIdToUpdate]?.workflow, false, 'project');
                        break;
                    case 'financial':
                        inputEl = document.getElementById('financial-msg');
                        messageContainer = document.getElementById('financial-chat-messages');
                        financialData = state.chats[currentChatId].financialData; // Pass financial data
                        modelToUse = getModelForRequest(state.chats[chatIdToUpdate]?.workflow, false, 'financial');
                        break;
                    case 'notepad':
                        inputEl = dom.notepadMsgInput;
                        messageContainer = dom.notepadChatMessages;
                        chatIdToUpdate = 'notepad-assistant-chat'; // Always use the dedicated notepad assistant chat
                        noteContent = dom.noteContentEditor.innerHTML; // Pass current note content
                        modelToUse = getModelForRequest(state.chats[chatIdToUpdate]?.workflow, false, 'notepad');
                        break;
                    case 'translator':
                        inputEl = dom.translatorInputEs;
                        messageContainer = dom.translatorOutputEn; // Special case: output is directly to textarea
                        modelToUse = getModelForRequest(null, false, 'translator'); // Translator always uses GPT-4o
                        break;
                    default:
                        inputEl = dom.msgInput;
                        messageContainer = dom.chatMessages;
                        if (!chatIdToUpdate) chatIdToUpdate = createNewChat({}); // Create new chat if none selected
                        modelToUse = getModelForRequest(state.chats[chatIdToUpdate]?.workflow, hasFile(), 'main');
                }

                const userMessage = spokenMessage || inputEl.value.trim();
                // Don't send empty messages unless a file is attached
                if (!userMessage && !selectedImageBase64 && !selectedPdfText) return;

                const currentChat = state.chats[chatIdToUpdate];
                if (!currentChat && assistantType !== 'translator') return; // Ensure chat exists for non-translator types

                // Determine if web search is needed based on keywords
                const webSearchTriggers = ['busca', 'investiga', 'en internet', 'tiempo real', 'qué día es hoy', 'qué fecha es hoy', 'cuál es el precio de', 'quién es', 'qué es', 'noticias sobre'];
                const requiresWebSearch = webSearchTriggers.some(trigger => userMessage.toLowerCase().startsWith(trigger));
                if (requiresWebSearch && !hasFile() && currentChat && !currentChat.workflow) { modelToUse = 'sonar'; }

                // Determine credit cost based on model and file types
                let cost = COSTS.GENERAL;
                if(modelToUse === 'sonar') cost = COSTS.SEARCH;
                if(currentChat && currentChat.workflow) cost = COSTS.WORKFLOW;
                if(selectedPdfText) cost = COSTS.PDF_ANALYSIS;
                if(selectedImageBase64) cost = COSTS.IMAGE_ANALYSIS;
                if(modelToUse === 'gpt-4o') cost = COSTS.GPT4O;

                // Attempt to spend credits; if unsuccessful, stop sending message
                if (!spendCredits(cost, modelToUse)) return;

                // Auto-rename chat title for new general chats
                if(currentChat && currentChat.title === (translations[localStorage.getItem('goatify-lang') || 'es'].default_chat_title || 'Conversación Cósmica') && userMessage.length > 5 && assistantType === 'main') {
                    currentChat.title = userMessage.split(' ').slice(0, 4).join(' ');
                    renderSidebar();
                }

                let thinkingBubble;
                if (assistantType !== 'translator') {
                    const [image, pdf] = [selectedImageBase64, selectedPdfText];
                    currentChat.messages.push({ role: 'user', content: userMessage, image, pdfText: pdf }); // Add user message to chat history
                    addMessageToUI('user', userMessage, image, currentChat.messages.length - 1, messageContainer); // Display user message
                    thinkingBubble = addMessageToUI('assistant', '…', null, null, messageContainer); // Display thinking indicator
                    inputEl.value = ''; // Clear input field
                    inputEl.style.height = 'auto'; // Reset input height
                    if(assistantType === 'main') {
                        clearImageData(); // Clear image preview
                        clearPdfData(); // Clear PDF preview
                    }
                } else {
                    messageContainer.value = '…'; // Show thinking indicator for translator
                }


                try {
                    const userNameForCall = currentUser ? (currentUser.user_metadata.full_name || currentUser.email) : 'viajero';
                    // Call the backend AI function
                    const responseData = await getAIResponse(userMessage, currentChat?.messages.slice(0, -1), selectedImageBase64, selectedPdfText, modelToUse, currentChat?.workflow, userNameForCall, financialData, noteContent);

                    updateCreditCounter(); // Update credit display after response

                    if (assistantType === 'translator') {
                        messageContainer.value = responseData.reply; // Display translation directly
                    } else {
                        currentChat.messages.push({ role: 'assistant', content: responseData.reply }); // Add AI response to chat history
                        updateMessageInUI(thinkingBubble, responseData.reply, null, messageContainer); // Update thinking bubble with actual response
                        speak(responseData.reply); // Speak the AI response
                    }

                    // Complete gamification mission if applicable
                    if (currentChat && currentChat.workflow && currentChat.workflow !== 'notepad-assistant') {
                        completeMission(currentChat.workflow, chatIdToUpdate);
                    }

                    // Handle project updates (e.g., new tasks from AI)
                    if (assistantType === 'project' && responseData.projectUpdate && responseData.projectUpdate.tasks) {
                        const todoColumn = currentChat.projectData.columns.find(c => c.id === 'todo');
                        if (todoColumn) {
                            if (!todoColumn.tasks) todoColumn.tasks = [];
                             responseData.projectUpdate.tasks.forEach(task => {
                                 todoColumn.tasks.push({ id: `proj-${crypto.randomUUID()}`, content: task.content, completed: false, labels: task.labels || [], urgent: false });
                            });
                        }
                        renderProjectBoard(chatIdToUpdate); // Re-render project board
                    }

                    saveState(); // Save updated state
                } catch (error) {
                     // Display error message if AI response fails
                     if (assistantType === 'translator') {
                        messageContainer.value = `❌ Error: ${error.message || 'No se pudo conectar al servidor.'}`;
                    } else {
                        updateMessageInUI(thinkingBubble, `❌ **Error de Conexión**<br><small>${error.message || 'No se pudo conectar al servidor.'}</small>`, null, messageContainer);
                    }
                }
            }
            /**
             * Initiates the image generation process.
             * Prompts the user for a description and calls the backend to generate the image.
             */
            async function generateImage() {
                // Show modal to get image description from user
                const result = await showModal({ title: translations[localStorage.getItem('goatify-lang') || 'es'].create_image_title || 'Crear Imagen', body: `${translations[localStorage.getItem('goatify-lang') || 'es'].image_prompt_desc || 'Describe la imagen que quieres crear:'}<br><input type="text" id="img-prompt" class="w-full p-2 rounded bg-input border border-themed mt-2" placeholder="${translations[localStorage.getItem('goatify-lang') || 'es'].image_prompt_placeholder || 'Ej: Un astronauta en un caballo cósmico'}">`, confirmText: translations[localStorage.getItem('goatify-lang') || 'es'].generate_btn || 'Generar' });
                if (!result.confirmed || !result.data['img-prompt']) return; // Exit if cancelled or no prompt

                // Deduct credits for image generation
                if (!spendCredits(COSTS.IMAGE_GENERATION, 'dall-e-2')) return;

                let chatIdToUpdate = currentChatId || createNewChat({}); // Use current chat or create new one
                const currentChat = state.chats[chatIdToUpdate];
                // Add user's image generation request to chat history
                currentChat.messages.push({ role: 'user', content: `${translations[localStorage.getItem('goatify-lang') || 'es'].generate_image_message || 'Generar imagen:'} "${result.data['img-prompt']}"` });
                addMessageToUI('user', `${translations[localStorage.getItem('goatify-lang') || 'es'].generate_image_message || 'Generar imagen:'} "${result.data['img-prompt']}"`, null, currentChat.messages.length - 1, dom.chatMessages);
                const thinkingBubble = addMessageToUI('assistant', '…', null, null, dom.chatMessages); // Display thinking indicator
                try {
                    // Call backend to generate image
                    const response = await fetch('/.netlify/functions/generate-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ prompt: result.data['img-prompt'], model: 'dall-e-2' })
                    });
                    if (!response.ok) { throw new Error((await response.json()).error || 'Error del servidor'); }
                    const { imageData } = await response.json();
                    const imageContent = translations[localStorage.getItem('goatify-lang') || 'es'].image_creation_success || '¡Aquí está tu creación, Jefe/a!';
                    // Update thinking bubble with generated image
                    currentChat.messages.push({ role: 'assistant', content: imageContent, image: imageData });
                    updateMessageInUI(thinkingBubble, imageContent, imageData, dom.chatMessages);
                    completeMission('image-generated'); // Complete gamification mission
                    saveState(); // Save updated state
                } catch (error) {
                    // Display error message if image generation fails
                    updateMessageInUI(thinkingBubble, `${translations[localStorage.getItem('goatify-lang') || 'es'].image_creation_error || '❌ **Error al crear la imagen:**'}<br><small>${error.message}</small>`, null, dom.chatMessages);
                }
            }
            /**
             * Toggles the multi-select mode for chats/notes in the sidebar.
             * @param {boolean} active - True to activate select mode, false to deactivate.
             */
            function toggleSelectMode(active) {
                isSelectModeActive = active;
                dom.selectChatsBtn.classList.toggle('hidden', active); // Hide/show select button
                dom.deleteModeControls.classList.toggle('hidden', !active); // Show/hide delete controls
                if (!active) {
                    chatsToDelete.clear(); // Clear selected items
                    dom.deleteSelectedBtn.disabled = true; // Disable delete button
                }
                renderSidebar(); // Re-render sidebar to apply selection mode styling

                // Add/remove event listeners for drag selection
                if (active) {
                    document.addEventListener('mousedown', handleMouseDownForSelection);
                } else {
                    document.removeEventListener('mousedown', handleMouseDownForSelection);
                    clearSelectionVisuals(); // Clear any visual selection highlights
                }
            }

            let isDraggingForSelection = false; // Flag for drag-selection in progress
            let selectionRect = null; // The visual selection rectangle element
            let initialSelectionX = 0; // Initial X coordinate for drag selection
            let initialSelectionY = 0; // Initial Y coordinate for drag selection

            /**
             * Handles the mouse down event for initiating drag-selection in the sidebar.
             * @param {MouseEvent} e - The mouse event.
             */
            function handleMouseDownForSelection(e) {
                // Only start if left mouse button and click is within sidebar scrollable content
                if (e.button !== 0 || !e.target.closest('#sidebar-scrollable-content')) return;

                isDraggingForSelection = true;
                initialSelectionX = e.clientX;
                initialSelectionY = e.clientY;

                // Create and style the selection rectangle
                selectionRect = document.createElement('div');
                selectionRect.style.position = 'fixed';
                selectionRect.style.border = '1px solid var(--primary)';
                selectionRect.style.backgroundColor = 'rgba(138, 79, 255, 0.1)';
                selectionRect.style.zIndex = '99';
                document.body.appendChild(selectionRect);

                // Add mousemove and mouseup listeners globally
                document.addEventListener('mousemove', handleMouseMoveForSelection);
                document.addEventListener('mouseup', handleMouseUpForSelection);
            }

            /**
             * Handles the mouse move event during drag-selection.
             * Updates the size and position of the selection rectangle and highlights overlapping items.
             * @param {MouseEvent} e - The mouse event.
             */
            function handleMouseMoveForSelection(e) {
                if (!isDraggingForSelection || !selectionRect) return;

                const currentX = e.clientX;
                const currentY = e.clientY;

                // Calculate rectangle dimensions
                const minX = Math.min(initialSelectionX, currentX);
                const maxX = Math.max(initialSelectionX, currentX);
                const minY = Math.min(initialSelectionY, currentY);
                const maxY = Math.max(initialSelectionY, currentY);

                selectionRect.style.left = `${minX}px`;
                selectionRect.style.top = `${minY}px`;
                selectionRect.style.width = `${maxX - minX}px`;
                selectionRect.style.height = `${maxY - minY}px`;

                // Get all selectable items not already selected
                const allItems = document.querySelectorAll('.chat-item:not(.selected-for-delete), .note-item:not(.selected-for-delete)');
                const selectionBounds = selectionRect.getBoundingClientRect();

                allItems.forEach(item => {
                    const itemBounds = item.getBoundingClientRect();
                    // Check for overlap between selection rectangle and item
                    const isOverlapping = !(
                        selectionBounds.right < itemBounds.left ||
                        selectionBounds.left > itemBounds.right ||
                        selectionBounds.bottom < itemBounds.top ||
                        selectionBounds.top > itemBounds.bottom
                    );

                    if (isOverlapping) {
                        if (!chatsToDelete.has(item.dataset.id)) {
                            chatsToDelete.add(item.dataset.id);
                            item.querySelector('i').classList.replace('fa-square', 'fa-check-square');
                            item.classList.add('selected-for-delete');
                        }
                    } else {
                        // If item was previously selected but no longer overlaps, deselect it
                        if (chatsToDelete.has(item.dataset.id) && item.classList.contains('selected-for-delete')) {
                             chatsToDelete.delete(item.dataset.id);
                             item.querySelector('i').classList.replace('fa-check-square', 'fa-square');
                             item.classList.remove('selected-for-delete');
                        }
                    }
                });
                dom.deleteSelectedBtn.disabled = chatsToDelete.size === 0; // Update delete button state
            }

            /**
             * Handles the mouse up event after drag-selection.
             * Cleans up the selection rectangle and event listeners.
             */
            function handleMouseUpForSelection() {
                isDraggingForSelection = false;
                if (selectionRect) {
                    selectionRect.remove();
                    selectionRect = null;
                }
                document.removeEventListener('mousemove', handleMouseMoveForSelection);
                document.removeEventListener('mouseup', handleMouseUpForSelection);
                dom.deleteSelectedBtn.disabled = chatsToDelete.size === 0; // Final update for delete button
            }

            /**
             * Clears all visual highlights from selected items in the sidebar.
             */
            function clearSelectionVisuals() {
                document.querySelectorAll('.chat-item.selected-for-delete, .note-item.selected-for-delete').forEach(item => {
                    item.classList.remove('selected-for-delete');
                    const checkboxIcon = item.querySelector('i.fa-check-square');
                    if (checkboxIcon) checkboxIcon.classList.replace('fa-check-square', 'fa-square');
                });
            }

            // --- NOTEPAD FUNCTIONS START ---

            let drawingHistory = []; // Stores canvas states for undo/redo
            let historyIndex = -1; // Current position in drawing history

            /**
             * Saves the current state of the drawing canvas to history and the active note.
             */
            function saveDrawingState() {
                const canvas = dom.noteCanvas;
                if (!canvas) return;

                const imageData = canvas.toDataURL();
                // If current state is not the latest, truncate history
                if (historyIndex < drawingHistory.length - 1) {
                    drawingHistory = drawingHistory.slice(0, historyIndex + 1);
                }
                drawingHistory.push(imageData);
                historyIndex++;

                const activeNote = state.notes.find(n => n.id === currentNoteId);
                if (activeNote) {
                    activeNote.content = imageData; // Save image data to note content
                    saveState();
                }
            }

            /**
             * Undoes the last drawing action on the canvas.
             */
            function undoDrawing() {
                if (historyIndex > 0) {
                    historyIndex--;
                    const canvas = dom.noteCanvas;
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.onload = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height); // Redraw previous state
                    };
                    img.src = drawingHistory[historyIndex];
                    const activeNote = state.notes.find(n => n.id === currentNoteId);
                    if (activeNote) {
                        activeNote.content = drawingHistory[historyIndex];
                        saveState();
                    }
                }
            }

            /**
             * Redoes the last undone drawing action on the canvas.
             */
            function redoDrawing() {
                if (historyIndex < drawingHistory.length - 1) {
                    historyIndex++;
                    const canvas = dom.noteCanvas;
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.onload = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    };
                    img.src = drawingHistory[historyIndex];
                    const activeNote = state.notes.find(n => n.id === currentNoteId);
                    if (activeNote) {
                        activeNote.content = drawingHistory[historyIndex];
                        saveState();
                    }
                }
            }


            /**
             * Shows the Notepad view and initializes its components.
             * Handles mobile-specific layout for the notepad chat assistant.
             */
            function showNotepadView() {
                dom.notepadViewContainer.style.display = 'flex';
                // On mobile, always start with the assistant collapsed
                if (window.innerWidth < 768) {
                    dom.notepadChatContainer.classList.add('collapsed');
                } else {
                    dom.notepadChatContainer.classList.remove('collapsed');
                }
                // Hide notepad chat container on mobile initially, it will be revealed on expand
                dom.notepadChatContainer.classList.toggle('hidden', window.innerWidth < 768);


                updateContextualFooter('notepad-app'); // Update footer message

                const notepadChat = state.chats['notepad-assistant-chat'];
                dom.notepadChatMessages.innerHTML = ''; // Clear existing messages
                // Add existing messages to the notepad chat UI
                notepadChat.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, msg.image, index, dom.notepadChatMessages));


                if (state.notes.length === 0) {
                     dom.noteEditorPanel.classList.add('hidden'); // Hide editor if no notes
                } else if (!currentNoteId || !state.notes.find(n => n.id === currentNoteId)) {
                    selectNote(state.notes[0].id); // Select the first note if no current one
                } else {
                    selectNote(currentNoteId); // Select the current note
                }

                // Disable GOAT X PRO option for non-logged-in users in notepad model selector
                const notepadModelSelector = document.getElementById('notepad-model-selector');
                if (notepadModelSelector) {
                    const goatXProOption = notepadModelSelector.querySelector('.goat-x-pro-model');
                    if (goatXProOption) goatXProOption.disabled = !currentUser;
                }
            }

            /**
             * Selects a specific note and loads it into the editor.
             * @param {string} noteId - The ID of the note to select.
             */
            function selectNote(noteId) {
                const noteExists = state.notes.find(n => n.id === noteId);
                if (!noteExists) {
                    currentNoteId = null;
                    dom.noteEditorPanel.classList.add('hidden');
                    return;
                }
                dom.noteEditorPanel.classList.remove('hidden'); // Show editor panel
                currentNoteId = noteId;
                loadNoteIntoEditor(noteId); // Load note content
                updateActiveChatHighlight(); // Highlight selected note in sidebar
            }

            /**
             * Creates a new note (text or drawing) and adds it to the state.
             * @param {'text'|'drawing'} [type='text'] - The type of note to create.
             */
            function createNewNote(type = 'text') {
                const lang = localStorage.getItem('goatify-lang') || 'es';
                const newNote = {
                    id: 'note-' + crypto.randomUUID(), // Generate unique ID
                    title: type === 'text' ? (translations[lang].new_note || 'Nueva Nota') : (translations[lang].new_drawing_title || 'Nuevo Dibujo'),
                    content: type === 'text' ? '' : null, // Initial content based on type
                    type: type,
                    createdAt: new Date().toISOString()
                };
                state.notes.unshift(newNote); // Add new note to the beginning of the notes array
                state.structure.unshift(newNote.id); // Add to main structure
                saveState(); // Save state immediately
                renderSidebar(); // Re-render sidebar to show the new note
                selectChat(newNote.id); // Select the new note to open it in editor

                if (window.innerWidth < 768) {
                    dom.notepadViewContainer.classList.add('mobile-editor-active'); // Show editor on mobile
                }
                showInAppNotification(translations[lang].success_title || "Éxito", `${translations[lang].note_created_message || "Se ha creado:"} "${newNote.title}"`, 800);
            }

            /**
             * Loads the content of a specified note into the editor or canvas.
             * @param {string} noteId - The ID of the note to load.
             */
            function loadNoteIntoEditor(noteId) {
                const note = state.notes.find(n => n.id === noteId);
                if (!note) return;

                currentNoteId = noteId;

                dom.noteTitleInput.value = note.title; // Set note title
                const isDrawing = note.type === 'drawing';

                // Toggle visibility of text editor vs. canvas
                dom.noteContentEditor.style.display = isDrawing ? 'none' : 'block';
                dom.noteCanvas.style.display = isDrawing ? 'block' : 'none';
                dom.noteContentEditor.innerHTML = isDrawing ? '' : note.content; // Set text content or clear for drawing

                // Toggle visibility of text tools vs. drawing tools
                dom.textTools.style.display = isDrawing ? 'none' : 'flex';
                dom.drawingTools.style.display = isDrawing ? 'flex' : 'none';
                dom.drawingFullscreenBtn.style.display = isDrawing ? 'block' : 'none'; // Show fullscreen only for drawings

                if (isDrawing) {
                    setupCanvas(note); // Initialize canvas for drawing
                } else {
                    dom.noteEditorToolbar.querySelectorAll('.text-editor-controls button').forEach(btn => btn.classList.remove('active'));
                }
            }

            /**
             * Sets up the drawing canvas for a note of type 'drawing'.
             * Configures drawing tools, event listeners, and history.
             * @param {object} note - The note object of type 'drawing'.
             */
            function setupCanvas(note) {
                const canvas = dom.noteCanvas;
                const ctx = canvas.getContext('2d');
                const toolbar = dom.drawingTools;

                let isDrawing = false; // Flag for active drawing
                let lastX = 0; // Last X coordinate for drawing path
                let lastY = 0; // Last Y coordinate for drawing path
                let startX = 0; // Start X coordinate for shapes
                let startY = 0; // Start Y coordinate for shapes
                let currentTool = 'pencil'; // Current active drawing tool
                let currentSnapshot = null; // Canvas snapshot for shape drawing (to redraw background)

                drawingHistory = []; // Reset drawing history
                historyIndex = -1; // Reset history index

                // Function to resize canvas and redraw content
                const resizeCanvas = () => {
                    const rect = canvas.parentElement.getBoundingClientRect();
                    canvas.width = rect.width;
                    canvas.height = rect.height;
                    // Redraw content from saved image data after resize
                    if (note.content) {
                        const img = new Image();
                        img.onload = () => {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            saveDrawingState(); // Save new state after resize and redraw
                        }
                        img.src = note.content;
                    } else {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        saveDrawingState(); // Save empty state if no content
                    }
                };

                resizeCanvas(); // Initial resize
                window.removeEventListener('resize', resizeCanvas); // Remove old listener to prevent duplicates
                window.addEventListener('resize', resizeCanvas); // Add new resize listener

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (note.content) {
                    const img = new Image();
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        saveDrawingState();
                    }
                    img.src = note.content;
                } else {
                    saveDrawingState();
                }


                // Helper to get coordinates relative to canvas
                const getCoords = (e) => {
                    const event = e.touches ? e.touches[0] : e;
                    const canvasRect = canvas.getBoundingClientRect();
                    return [event.clientX - canvasRect.left, event.clientY - canvasRect.top];
                }

                // Start drawing action
                const startDrawing = (e) => {
                    e.preventDefault();
                    isDrawing = true;
                    [lastX, lastY] = getCoords(e);
                    [startX, startY] = [lastX, lastY]; // Store start point for shapes
                    if (currentTool === 'pencil' || currentTool === 'eraser') {
                         ctx.beginPath(); // Begin new path for continuous drawing
                         ctx.moveTo(lastX, lastY);
                    } else {
                        currentSnapshot = ctx.getImageData(0, 0, canvas.width, canvas.height); // Save canvas state before drawing shape
                    }
                };
                // Draw action
                const draw = (e) => {
                    if (!isDrawing) return;
                    e.preventDefault();

                    const [currentX, currentY] = getCoords(e);
                    ctx.strokeStyle = toolbar.querySelector('#drawing-color').value; // Set stroke color
                    ctx.lineWidth = toolbar.querySelector('#drawing-line-width').value; // Set line width
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    // Set composite operation for eraser effect
                    ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';

                    if (currentTool === 'pencil' || currentTool === 'eraser') {
                        ctx.lineTo(currentX, currentY);
                        ctx.stroke();
                    } else if (currentSnapshot) {
                        ctx.putImageData(currentSnapshot, 0, 0); // Restore canvas to snapshot
                        ctx.beginPath();
                        if (currentTool === 'line') {
                            ctx.moveTo(startX, startY);
                            ctx.lineTo(currentX, currentY);
                        } else if (currentTool === 'rect') {
                            ctx.rect(startX, startY, currentX - startX, currentY - startY);
                        } else if (currentTool === 'circle') {
                            const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
                            ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
                        }
                        ctx.stroke();
                    }
                    [lastX, lastY] = [currentX, currentY];
                };
                // Stop drawing action
                const stopDrawing = () => {
                    if (!isDrawing) return;
                    isDrawing = false;
                    if (currentTool === 'pencil' || currentTool === 'eraser') {
                        ctx.closePath();
                    }
                    saveDrawingState(); // Save current state to history
                    currentSnapshot = null; // Clear snapshot
                };

                // Attach mouse and touch event listeners to the canvas
                canvas.onmousedown = startDrawing;
                canvas.onmousemove = draw;
                canvas.onmouseup = stopDrawing;
                canvas.onmouseout = stopDrawing; // Stop drawing if mouse leaves canvas
                canvas.ontouchstart = startDrawing;
                canvas.ontouchmove = draw;
                canvas.ontouchend = stopDrawing;

                // Helper to set active tool and update UI
                const setActiveTool = (toolId) => {
                    toolbar.querySelectorAll('.drawing-tool').forEach(t => t.classList.remove('active'));
                    toolbar.querySelector(`#${toolId}`).classList.add('active');
                    currentTool = toolId.replace('tool-', '');
                }

                // Attach event listeners to drawing tool buttons
                toolbar.querySelector('#tool-pencil').onclick = () => setActiveTool('tool-pencil');
                toolbar.querySelector('#tool-eraser').onclick = () => setActiveTool('tool-eraser');
                toolbar.querySelector('#tool-line').onclick = () => setActiveTool('tool-line');
                toolbar.querySelector('#tool-rect').onclick = () => setActiveTool('tool-rect');
                toolbar.querySelector('#tool-circle').onclick = () => setActiveTool('tool-circle');
                toolbar.querySelector('#clear-canvas-btn').onclick = () => {
                     ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear entire canvas
                     const activeNote = state.notes.find(n => n.id === currentNoteId);
                     if (activeNote) {
                         activeNote.content = null; // Clear note content
                         saveState();
                     }
                     drawingHistory = []; // Clear history
                     historyIndex = -1;
                     saveDrawingState(); // Save empty state to history
                };
                toolbar.querySelector('#undo-drawing-btn').onclick = undoDrawing;
                toolbar.querySelector('#redo-drawing-btn').onclick = redoDrawing;

                // Fullscreen button for canvas
                dom.drawingFullscreenBtn.onclick = () => {
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    } else {
                        canvas.requestFullscreen().catch(err => {
                            console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                        });
                    }
                };
            }

            /**
             * Applies a text formatting command to the content editable editor.
             * @param {string} command - The document.execCommand command (e.g., 'bold', 'italic').
             * @param {string|null} [value=null] - The value for the command (e.g., font name).
             */
            function applyTextFormat(command, value = null) {
                document.execCommand(command, false, value);
                dom.noteContentEditor.focus(); // Keep focus on editor
                updateToolbarButtonStates(); // Update button active states
                const note = state.notes.find(n => n.id === currentNoteId);
                if (note && note.type === 'text') {
                    note.content = dom.noteContentEditor.innerHTML; // Save content after formatting
                    saveState();
                }
            }

            /**
             * Updates the active/inactive states of text formatting toolbar buttons
             * based on the current selection's formatting.
             */
            function updateToolbarButtonStates() {
                dom.boldBtn.classList.toggle('active', document.queryCommandState('bold'));
                dom.italicBtn.classList.toggle('active', document.queryCommandState('italic'));
                dom.underlineBtn.classList.toggle('active', document.queryCommandState('underline'));
                dom.alignLeftBtn.classList.toggle('active', document.queryCommandState('justifyLeft'));
                dom.alignCenterBtn.classList.toggle('active', document.queryCommandState('justifyCenter'));
                dom.alignRightBtn.classList.toggle('active', document.queryCommandState('justifyRight'));
                dom.justifyBtn.classList.toggle('active', document.queryCommandState('justifyFull'));
            }

            /**
             * Handles the click event for checklist item checkboxes.
             * Updates the `data-checked` attribute and saves the note content.
             * @param {HTMLElement} target - The clicked element.
             */
            function handleChecklistItem(target) {
                if(!target.matches('.checklist-item-checkbox')) return;
                const isChecked = target.checked;
                const textSpan = target.nextElementSibling; // Get the sibling text span
                if (textSpan && textSpan.matches('.checklist-item-text')) {
                    textSpan.dataset.checked = isChecked; // Update data attribute
                }
                const currentNote = state.notes.find(n => n.id === currentNoteId);
                if(currentNote) {
                    currentNote.content = dom.noteContentEditor.innerHTML; // Save updated content
                    saveState();
                }
            }

            /**
             * Initiates the note sharing process (currently a demo).
             * Opens a modal for the user to enter an email.
             */
            async function shareNote() {
                const lang = localStorage.getItem('goatify-lang') || 'es';
                const result = await showModal({
                    title: translations[lang].share_note,
                    body: `<p>${translations[lang].share_note_desc}</p>
                           <input type="email" id="share-email-input" class="w-full p-2 rounded bg-input border border-themed mt-2" placeholder="${translations[lang].share_note_email_placeholder}">
                           <p class="text-xs text-text-medium mt-2">${translations[lang].share_note_info}</p>`,
                    confirmText: translations[lang].share_note_button
                });

                if (result.confirmed && result.data['share-email-input']) {
                    console.log(`(DEMO) Sharing note ${currentNoteId} with ${result.data['share-email-input']}. Backend implementation needed.`);
                    showInAppNotification(translations[lang].feature_in_dev_title || "Función en Desarrollo", translations[lang].feature_in_dev_message || "La colaboración en tiempo real estará disponible pronto.", 800);
                }
            }

            /**
             * Exports the current note as a PDF.
             * Handles both text notes (using html2canvas) and drawing notes (from canvas image).
             */
            async function exportNoteAsPdf() {
                const note = state.notes.find(n => n.id === currentNoteId);
                if (!note) return;

                if (note.type === 'drawing') {
                    // For drawing notes, export the canvas directly
                    const canvas = dom.noteCanvas;
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf; // Assuming jspdf is loaded globally
                    const pdf = new jsPDF({
                        orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                        unit: 'px',
                        format: [canvas.width, canvas.height]
                    });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`${note.title || 'drawing'}.pdf`);
                } else {
                    // For text notes, use html2canvas to render the contentEditable div to an image, then add to PDF
                    const content = dom.noteContentEditor; // Get the contentEditable div
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();

                    html2canvas(content, {
                        scale: 2, // Increase scale for better resolution
                        useCORS: true // Required if content includes external images
                    }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const imgProps = pdf.getImageProperties(imgData);
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                        pdf.save(`${note.title || 'note'}.pdf`);
                    }).catch(error => {
                        console.error("Error generating PDF from HTML:", error);
                        showInAppNotification("Error al Exportar", "No se pudo generar el PDF de la nota.", 3000);
                    });
                }
                showInAppNotification("Exportado", "La nota ha sido exportada como PDF.", 800);
            }

            // --- NOTEPAD FUNCTIONS END ---


            /**
             * Sets up event listeners to close a modal when clicking outside its content.
             * @param {HTMLElement} modalElement - The main modal container element.
             * @param {Function} hideFunction - The function to call to hide the modal.
             */
            function setupModalClickOutside(modalElement, hideFunction) {
                if (!modalElement) return;
                modalElement.addEventListener('click', (e) => {
                    if (e.target === modalElement) { // Check if click was directly on the overlay
                        hideFunction();
                    }
                });
            }

            /**
             * Toggles the visibility of the voice selector container.
             * (Currently, the voice selector is always visible as per CSS).
             * @param {boolean} show - True to show, false to hide.
             */
            function toggleVoiceSelectorVisibility(show) {
                // dom.voiceSelectorContainer.classList.toggle('hidden', !show);
                // dom.actionButtonsContainer.classList.toggle('hidden', show);
            }

            /**
             * Shows the motivation modal with a random motivational quote.
             * Also manages the motivation notifications toggle.
             */
            function showMotivationModal() {
                dom.motivationModal.classList.remove('hidden');
                dom.motivationModal.classList.add('flex');

                const randomIndex = Math.floor(Math.random() * MOTIVATIONAL_MESSAGES.length);
                const randomButtonText = MOTIVATION_BUTTON_TEXTS[Math.floor(Math.random() * MOTIVATION_BUTTON_TEXTS.length)];

                // Display random quote and button text
                dom.motivationTitle.style.fontWeight = 'normal'; // Reset weight
                dom.motivationQuote.textContent = MOTIVATIONAL_MESSAGES[randomIndex];
                dom.motivationQuote.style.fontWeight = 'bold';
                dom.motivationQuote.classList.add('shimmer-text'); // Add shimmer effect
                dom.closeMotivationModal.textContent = randomButtonText;

                setTimeout(() => dom.motivationQuote.classList.remove('shimmer-text'), 2500); // Remove shimmer after a delay

                const toggle = dom.motivationToggle;
                toggle.checked = motivationEnabled; // Set toggle state based on preference
            }

            /**
             * Hides the motivation modal.
             */
            function hideMotivationModal() {
                dom.motivationModal.classList.add('hidden');
                dom.motivationModal.classList.remove('flex');
            }

            /**
             * Sets up a periodic interval for motivation notifications if enabled.
             */
            function setupMotivationInterval() {
                if (motivationInterval) clearInterval(motivationInterval); // Clear any existing interval
                if (!motivationEnabled) return; // Exit if motivation notifications are disabled

                const thirtyMinutes = 30 * 60 * 1000; // 30 minutes in milliseconds
                motivationInterval = setInterval(() => {
                    if (!motivationEnabled) { // Check again inside interval in case it was disabled
                        clearInterval(motivationInterval);
                        return;
                    }
                    const lang = localStorage.getItem('goatify-lang') || 'es';
                    const randomIndex = Math.floor(Math.random() * MOTIVATIONAL_MESSAGES.length);
                    const message = MOTIVATIONAL_MESSAGES[randomIndex];
                    const title = `<i class="fas fa-lightbulb text-yellow-400 mr-2"></i> ${translations[lang].motivation_title || 'Dosis de Motivación'}`;
                    const body = `<p class="text-md">${message}</p>`;

                    showInAppNotification(title, body, 4000); // Show in-app notification
                    triggerPushNotification(translations[lang].motivation_title, message); // Trigger push notification

                }, thirtyMinutes);
            }

            // --- TRANSLATOR FUNCTIONS START ---
            /**
             * Shows the translator view and sets up its initial state.
             */
            function showTranslatorView() {
                dom.translatorView.style.display = 'flex';
                // Update chat titles to reflect translator workflow
                dom.chatTitle.textContent = translations[localStorage.getItem('goatify-lang') || 'es'].wf_eng_1 || 'Traducir/Corregir Texto';
                dom.mobileChatTitle.textContent = translations[localStorage.getItem('goatify-lang') || 'es'].wf_eng_1 || 'Traducir/Corregir Texto';
                updateContextualFooter('english-teacher-translate'); // Update footer message

                // Set default placeholder text as requested (bolded)
                dom.translatorInputEs.value = '**Pega o escribe aquí lo que quieras y traduce correctamente al ingles:**\n\n';

                // Ensure GOAT X model option is available in the translator model selector
                if (!dom.translatorModelSelector.querySelector('option[value="gpt-3.5-turbo-1106"]')) {
                    const goatXOption = document.createElement('option');
                    goatXOption.value = 'gpt-3.5-turbo-1106';
                    goatXOption.textContent = 'GOAT X';
                    dom.translatorModelSelector.insertBefore(goatXOption, dom.translatorModelSelector.firstChild);
                }
                // Ensure GOAT X PRO option is enabled/disabled based on user plan
                const goatXProOption = dom.translatorModelSelector.querySelector('.goat-x-pro-model');
                if (goatXProOption) goatXProOption.disabled = !currentUser;
            }

            /**
             * Sets up event listeners for the translator view (translate button, paste, copy).
             */
            function setupTranslatorEventListeners() {
                const pasteBtn = document.getElementById('paste-to-translator-btn');
                const copyBtn = document.getElementById('copy-from-translator-btn');

                dom.translateBtn?.addEventListener('click', () => {
                    sendMessage(false, null, { assistantType: 'translator' }); // Send message to translator AI
                });

                pasteBtn?.addEventListener('click', async () => {
                    try {
                        const text = await navigator.clipboard.readText(); // Read from clipboard
                        dom.translatorInputEs.value += text; // Append to input
                    } catch (err) {
                        console.error('Failed to read clipboard contents: ', err);
                    }
                });

                copyBtn?.addEventListener('click', () => {
                    dom.translatorOutputEn.select(); // Select text in output
                    document.execCommand('copy'); // Copy to clipboard
                    showInAppNotification('Copiado', 'Texto traducido copiado al portapapeles.', 1500);
                });
            }
            // --- TRANSLATOR FUNCTIONS END ---

                            copyBtn?.addEventListener('click', () => {
                    dom.translatorOutputEn.select(); // Select text in output
                    document.execCommand('copy'); // Copy to clipboard
                    showInAppNotification('Copiado', 'Texto traducido copiado al portapapeles.', 1500);
                });
            }
            // --- TRANSLATOR FUNCTIONS END ---

            /**
             * Sets up all global event listeners for the application.
             */
            function setupEventListeners() {
                // Event listener for in-app notification close button
                dom.inAppNotificationClose?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dom.inAppNotification.classList.remove('show');
                });
                // Event listener for task notification close button
                dom.taskNotificationCloseBtn?.addEventListener('click', hideTaskNotification);

                // Event listener for clicking on plan credits info to show details
                dom.planCreditsInfo?.addEventListener('click', () => {
                    const { remaining, limit, plan } = getCreditCount();
                    const gamCredits = (currentUser && gamificationState.credits) ? gamificationState.credits : 0;
                    const lang = localStorage.getItem('goatify-lang') || 'es';

                    const todayKey = dayjs().format('YYYY-MM-DD');
                    const allTasksToday = getTasksForDay(todayKey);
                    const completedTasksToday = allTasksToday.filter(task => task.completed).length;
                    let totalPendingTasksToday = allTasksToday.filter(task => !task.completed).length;
                    let totalChatActivities = 0;
                    Object.values(state.chats).forEach(chat => {
                        (chat.messages || []).forEach(msg => {
                            if (dayjs(msg.timestamp).isSame(dayjs(), 'day')) {
                                totalChatActivities++;
                            }
                        });
                    });
                    const totalActivitiesToday = completedTasksToday + totalPendingTasksToday + Math.floor(totalChatActivities / 2);

                    const positiveMessages = [
                        "¡Estás haciendo un trabajo increíble!",
                        "¡Cada pequeño paso te acerca a tu éxito!",
                        "¡Sigue así, la constancia es clave!",
                        "¡Eres imparable, el GOAT en acción!",
                        "¡Tu dedicación te lleva lejos!"
                    ];
                    const randomPositiveMessage = positiveMessages[Math.floor(Math.random() * positiveMessages.length)];

                    let bodyContent = `
                        <div class="text-center mb-4">
                            <p id="modal-welcome-user-greeting" class="text-xl font-bold text-primary mb-2"></p>
                            <p id="modal-current-date-display" class="text-lg text-text-medium"></p>
                            <p id="modal-current-time-display" class="text-3xl font-extrabold text-primary animate-pulse"></p>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-center mb-4">
                            <div class="bg-current-bg-light p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
                                <h4 class="font-semibold text-text-light text-sm mb-1">
                                    <span data-translate-key="tasks_completed_today">${translations[lang].tasks_completed_today}</span>
                                    <i class="fas fa-info-circle text-text-medium ml-1 cursor-pointer" title="Número de tareas que has marcado como completadas en tu calendario o en tus proyectos durante el día de hoy."></i>
                                </h4>
                                <p id="calendar-info-completed-tasks" class="text-2xl font-bold text-primary">${completedTasksToday}/${allTasksToday.length}</p>
                            </div>
                            <div class="bg-current-bg-light p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
                                <h4 class="font-semibold text-text-light text-sm mb-1">
                                    <span data-translate-key="pending_tasks_today">${translations[lang].pending_tasks_today}</span>
                                    <i class="fas fa-info-circle text-text-medium ml-1 cursor-pointer" title="Tareas que tienen fecha de vencimiento hoy y aún no han sido completadas, incluyendo las de tus proyectos."></i>
                                </h4>
                                <p id="calendar-info-pending-tasks" class="text-2xl font-bold text-red-500">${totalPendingTasksToday}</p>
                            </div>
                            <div class="bg-current-bg-light p-4 rounded-lg shadow-md col-span-2 flex flex-col items-center justify-center">
                                <h4 class="font-semibold text-text-light text-sm mb-1">
                                    <span data-translate-key="total_activities_today">${translations[lang].total_activities_today}</span>
                                    <i class="fas fa-info-circle text-text-medium ml-1 cursor-pointer" title="Suma de todas las interacciones del día: tareas completadas, tareas pendientes y mensajes enviados en los chats."></i>
                                </h4>
                                <p id="calendar-info-total-activities" class="text-2xl font-bold text-gold">${totalActivitiesToday}</p>
                            </div>
                        </div>
                        <p class="mb-3 text-sm"><strong>${translations[lang].current_plan_details}</strong> ${plan.toUpperCase()}</p>
                        <p class="mb-4 text-sm"><strong>${translations[lang].credits_breakdown}</strong> ${remaining}/${limit === Infinity ? '∞' : limit} (${gamCredits} 🪙)</p>
                        <p class="mb-4 text-md font-semibold text-primary text-center">${randomPositiveMessage}</p>
                    `;

                    showModal({
                        title: translations[lang].credits_details_title,
                        body: bodyContent,
                        showCancel: false,
                        confirmText: translations[lang].understood_btn,
                        extraButtons: [{
                            id: 'modal-view-active-plan-btn',
                            text: translations[lang].view_active_plan,
                            classes: 'btn-primary px-4 py-2 rounded',
                            action: () => {
                                hideModal();
                                showPricingModal();
                            }
                        },
                        {
                            id: 'modal-learn-about-credits-btn',
                            text: translations[lang].learn_about_credits,
                            classes: 'px-4 py-2 rounded bg-gray-500 text-white',
                            action: () => {
                                hideModal();
                                showModal({
                                    title: translations[lang].learn_about_credits,
                                    body: `<ul class="list-disc list-inside space-y-2 text-sm">
                                <li><strong>GOAT X:</strong> ${COSTS.GENERAL} crédito</li>
                                <li><strong>Búsqueda Web:</strong> ${COSTS.SEARCH} créditos</li>
                                <li><strong>Workflows:</strong> ${COSTS.WORKFLOW} créditos</li>
                                <li><strong>Análisis de PDF:</strong> ${COSTS.PDF_ANALYSIS} créditos</li>
                                <li><strong>Análisis de Imagen:</strong> ${COSTS.IMAGE_ANALYSIS} créditos</li>
                                <li><strong>Creación de Imagen (DALL-E):</strong> ${COSTS.IMAGE_GENERATION} créditos</li>
                                <li><strong>GOAT X PRO (GPT-4o):</strong> ${COSTS.GPT4O} créditos</li>
                               </ul>
                               <p class="mt-4 text-sm italic">${translations[lang].gamification_credits_info}</p>`,
                                    confirmText: translations[lang].understood_btn,
                                    showCancel: false
                                });
                            }
                        }]
                    });

                    const modalWelcomeGreeting = document.getElementById('modal-welcome-user-greeting');
                    const modalDateDisplay = document.getElementById('modal-current-date-display');
                    const modalTimeDisplay = document.getElementById('modal-current-time-display');

                    const userName = currentUser ? (currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.email.split('@')[0]) : '';
                    let greetingTitle = 'Jefe';
                    if (userName.slice(-1).toLowerCase() === 'a' || ['isabel', 'dolores'].includes(userName.toLowerCase())) {
                        greetingTitle = 'Jefa';
                    }
                    if(modalWelcomeGreeting) modalWelcomeGreeting.innerHTML = `¡Hola, <span class="text-primary">${userName || greetingTitle}</span>! Ten un excelente día.`;

                    const updateModalTime = () => {
                        const now = dayjs();
                        if (modalDateDisplay) modalDateDisplay.textContent = now.format('dddd, D [de] MMMM [de]YYYY');
                        if (modalTimeDisplay) modalTimeDisplay.textContent = now.format('HH:mm:ss');
                    };
                    updateModalTime();
                    const modalTimeInterval = setInterval(updateModalTime, 1000);

                    const observer = new MutationObserver((mutationsList, observer) => {
                        for (const mutation of mutationsList) {
                            if (mutation.attributeName === 'class' && dom.genericModal.classList.contains('hidden')) {
                                clearInterval(modalTimeInterval);
                                observer.disconnect();
                            }
                        }
                    });
                    observer.observe(dom.genericModal, { attributes: true });
                });


                // Event listener for clicking on reward credits to show gamification modal
                dom.rewardCreditsInfo?.addEventListener('click', () => {
                    if(!currentUser) {
                        showInAppNotification(translations[localStorage.getItem('goatify-lang') || 'es'].exclusive_feature_title || "Función Exclusiva", translations[localStorage.getItem('goatify-lang') || 'es'].exclusive_feature_message || "La gamificación está disponible para usuarios logueados.", 3000);
                        return;
                    }
                    renderGamificationModal();
                    dom.gamificationModal.classList.remove('hidden');
                    dom.gamificationModal.classList.add('flex');
                    setTimeout(() => dom.gamificationModal.querySelector('.modal-content').classList.remove('scale-95'), 10);
                });

                // Event listeners for motivation button and modal
                const motivationClickHandler = () => showMotivationModal();
                dom.motivationBtnHeader?.addEventListener('click', motivationClickHandler);
                dom.motivationBtnMobile?.addEventListener('click', motivationClickHandler);

                dom.closeMotivationModal?.addEventListener('click', hideMotivationModal);
                dom.motivationToggle?.addEventListener('change', () => {
                    motivationEnabled = dom.motivationToggle.checked;
                    localStorage.setItem('goatify-motivation-enabled', motivationEnabled);
                    if(motivationEnabled) {
                        setupMotivationInterval();
                    } else {
                        if(motivationInterval) clearInterval(motivationInterval);
                    }
                });

                // Event listener for main send button
                dom.sendBtn?.addEventListener('click', () => sendMessage(false, null, { assistantType: 'main' }));

                // Helper function to set up event listeners for assistant inputs
                const setupAssistantInput = (inputId, sendId, assistantType) => {
                    const inputEl = document.getElementById(inputId);
                    const sendBtn = document.getElementById(sendId);

                    if (sendBtn) {
                        sendBtn.addEventListener('click', () => {
                             sendMessage(false, null, { assistantType });
                        });
                    }
                     if (inputEl) {
                        inputEl.addEventListener('keydown', e => {
                            if (e.key === 'Enter' && !e.shiftKey) {
                                e.preventDefault();
                                sendMessage(false, null, { assistantType });
                            }
                        });
                     }
                };

                // Setup assistant inputs for project, notepad, and translator views
                setupAssistantInput('project-msg', 'project-send', 'project');
                setupAssistantInput('notepad-msg', 'notepad-send', 'notepad');
                setupTranslatorEventListeners();


                // Event listener for main message input (textarea)
                dom.msgInput?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                         sendMessage(false, null, { assistantType: 'main' });
                    }
                });
                dom.msgInput?.addEventListener('input', () => {
                    dom.msgInput.style.height = 'auto';
                    dom.msgInput.style.height = (dom.msgInput.scrollHeight) + 'px';
                });

                // Event listeners for creating new chat and folder
                const newChatHandler = () => createNewChat();
                dom.newChatBtn?.addEventListener('click', newChatHandler);
                dom.newChatIconBtn?.addEventListener('click', newChatHandler);

                dom.newFolderBtn?.addEventListener('click', async () => {
                    const result = await showModal({
                        title: translations[localStorage.getItem('goatify-lang') || 'es'].create_folder_title || 'Crear Nueva Carpeta',
                        body: `<input type="text" id="project-name" class="w-full p-2 rounded bg-input border border-themed" placeholder="${translations[localStorage.getItem('goatify-lang') || 'es'].folder_name_placeholder || 'Nombre de la Carpeta...'}">`,
                        confirmText: translations[localStorage.getItem('goatify-lang') || 'es'].create_btn || 'Crear'
                    });
                    if (result.confirmed && result.data['project-name'].trim()) {
                        const id = 'project-' + crypto.randomUUID();
                        state.projects[id] = { id, title: result.data['project-name'].trim(), itemIds: [], isOpen: true };
                        state.structure.unshift(id);
                        saveState();
                        renderSidebar();
                        showInAppNotification(translations[localStorage.getItem('goatify-lang') || 'es'].success_title || "Éxito", `${translations[localStorage.getItem('goatify-lang') || 'es'].folder_created_message || "Carpeta"} "${result.data['project-name'].trim()}" ${translations[localStorage.getItem('goatify-lang') || 'es'].created_suffix || "creada."}`, 800);
                    }
                });
                dom.newFolderIconBtn?.addEventListener('click', async () => {
                    const result = await showModal({
                        title: translations[localStorage.getItem('goatify-lang') || 'es'].create_folder_title || 'Crear Nueva Carpeta',
                        body: `<input type="text" id="project-name" class="w-full p-2 rounded bg-input border border-themed" placeholder="${translations[localStorage.getItem('goatify-lang') || 'es'].folder_name_placeholder || 'Nombre de la Carpeta...'}">`,
                        confirmText: translations[localStorage.getItem('goatify-lang') || 'es'].create_btn || 'Crear'
                    });
                    if (result.confirmed && result.data['project-name'].trim()) {
                        const id = 'project-' + crypto.randomUUID();
                        state.projects[id] = { id, title: result.data['project-name'].trim(), itemIds: [], isOpen: true };
                        state.structure.unshift(id);
                        saveState();
                        renderSidebar();
                        showInAppNotification(translations[localStorage.getItem('goatify-lang') || 'es'].success_title || "Éxito", `${translations[localStorage.getItem('goatify-lang') || 'es'].folder_created_message || "Carpeta"} "${result.data['project-name'].trim()}" ${translations[localStorage.getItem('goatify-lang') || 'es'].created_suffix || "creada."}`, 800);
                    }
                });
                dom.addProjectFolderBtn?.addEventListener('click', async () => {
                    const result = await showModal({
                        title: translations[localStorage.getItem('goatify-lang') || 'es'].create_folder_title || 'Crear Nueva Carpeta',
                        body: `<input type="text" id="project-name" class="w-full p-2 rounded bg-input border border-themed" placeholder="${translations[localStorage.getItem('goatify-lang') || 'es'].folder_name_placeholder || 'Nombre de la Carpeta...'}">`,
                        confirmText: translations[localStorage.getItem('goatify-lang') || 'es'].create_btn || 'Crear'
                    });
                    if (result.confirmed && result.data['project-name'].trim()) {
                        const id = 'project-' + crypto.randomUUID();
                        state.projects[id] = { id, title: result.data['project-name'].trim(), itemIds: [], isOpen: true };
                        state.structure.unshift(id);
                        saveState();
                        renderSidebar();
                        showInAppNotification(translations[localStorage.getItem('goatify-lang') || 'es'].success_title || "Éxito", `${translations[localStorage.getItem('goatify-lang') || 'es'].folder_created_message || "Carpeta"} "${result.data['project-name'].trim()}" ${translations[localStorage.getItem('goatify-lang') || 'es'].created_suffix || "creada."}`, 800);
                    }
                });


                // Event listeners for pricing and theme toggles
                dom.upgradePlanBtn?.addEventListener('click', showPricingModal);
                dom.closePricingModalBtn?.addEventListener('click', hidePricingModal);
                dom.themeToggle?.addEventListener('click', () => setTheme(!document.body.classList.contains('dark-theme')));
                dom.loginBtn?.addEventListener('click', () => netlifyIdentity.open('login'));

                // Event listeners for chat title editing (desktop and mobile)
                dom.desktopChatTitleWrapper?.addEventListener('click', (e) => {
                    if (!e.target.closest('#calendar-btn') && !e.target.closest('#motivation-btn-header') && currentChatId && currentChatId.startsWith('chat-')) {
                        renameItem('chat', currentChatId);
                    }
                });
                dom.mobileChatTitleWrapper?.addEventListener('click', (e) => {
                    if (!e.target.closest('#calendar-btn-mobile') && !e.target.closest('#motivation-btn-mobile') && currentChatId && currentChatId.startsWith('chat-')) {
                        renameItem('chat', currentChatId);
                    }
                });

                // Event listeners for file uploads and image generation
                dom.imageGenBtn?.addEventListener('click', generateImage);
                dom.pdfUploadBtn?.addEventListener('click', () => dom.pdfUploadInput.click());
                dom.imageUploadBtn?.addEventListener('click', () => dom.imageUploadInput.click());

                // Speech recognition setup
                if (SR && dom.micBtn) {
                    recognition = new SR();
                    recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'es-ES';
                    recognition.onstart = () => { isRecognizing = true; dom.micBtn.classList.add('glowing-mic'); };
                    recognition.onend = () => { isRecognizing = false; dom.micBtn.classList.remove('glowing-mic'); };
                    recognition.onerror = (e) => { console.error("Speech recognition error", e); isRecognizing = false; dom.micBtn.classList.remove('glowing-mic'); };
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        const activeView = document.querySelector('#view-container > div:not(.hidden)');
                        let assistantType = 'main';
                        if(activeView) {
                            if(activeView.id === 'project-management-view') assistantType = 'project';
                            else if(activeView.id === 'financial-assistant-view') assistantType = 'financial';
                            else if(activeView.id === 'notepad-view-container') assistantType = 'notepad';
                            else if(activeView.id === 'translator-view') assistantType = 'translator';
                        }

                        let activeInput = dom.msgInput;
                        if(assistantType === 'project') activeInput = dom.projectMsgInput;
                        else if(assistantType === 'financial') activeInput = document.getElementById('financial-msg');
                        else if(assistantType === 'notepad') activeInput = dom.notepadMsgInput;
                        else if(assistantType === 'translator') activeInput = dom.translatorInputEs;

                        activeInput.value = transcript;
                        sendMessage(false, null, { assistantType });
                    };
                    dom.micBtn.addEventListener('click', () => {
                        if(isRecognizing) { recognition.stop(); }
                        else { if (speechSynthesis.speaking) { speechSynthesis.cancel(); } try { recognition.start(); } catch(e) {console.error("Could not start recognition", e)} }
                    });
                } else { if(dom.micBtn) dom.micBtn.style.display = 'none'; }

                // Text-to-speech toggle
                dom.ttsToggle?.addEventListener('click', () => {
                    speechOn = !speechOn;
                    const icon = dom.ttsToggle.querySelector('i');
                     icon.classList.toggle('fa-volume-high', speechOn);
                    icon.classList.toggle('fa-volume-mute', !speechOn);
                    if (!speechOn) {
                        speechSynthesis.cancel();
                    }
                 });

                // Model selector change listener
                dom.modelSelector?.addEventListener('change', () => {
                    const selectedValue = dom.modelSelector.value;
                    if (selectedValue === 'gpt-4o' && (!currentUser || (currentUser.app_metadata?.plan || 'free') === 'free')) {
                        showInAppNotification(translations[localStorage.getItem('goatify-lang') || 'es'].restricted_access_title || "Acceso Restringido", translations[localStorage.getItem('goatify-lang') || 'es'].restricted_access_message || "El modelo GOAT X PRO está disponible solo para usuarios con un plan de pago.", 3000);
                        dom.modelSelector.value = 'gpt-3.5-turbo-1106';
                    }
                });

                // Clear file previews
                dom.clearImageBtn?.addEventListener('click', clearImageData);
                dom.clearPdfBtn?.addEventListener('click', clearPdfData);

                // Image upload handler
                dom.imageUploadInput?.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        dom.filePreviewArea.style.display = "block"; // Show file preview area
                        clearPdfData(); // Clear PDF if image is uploaded
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            selectedImageBase64 = ev.target.result;
                            dom.imagePreview.src = selectedImageBase64;
                            dom.imagePreviewContainer.classList.remove('hidden'); // Show image preview container
                            dom.imageName.textContent = e.target.files[0].name; // Display image name
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                });

                // PDF upload handler
                dom.pdfUploadInput?.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file || file.type !== 'application/pdf') return;
                    dom.filePreviewArea.style.display = "block"; // Show file preview area
                    clearImageData(); // Clear image if PDF is uploaded
                    dom.pdfNameEl.textContent = file.name;
                    dom.pdfStatusEl.textContent = translations[localStorage.getItem('goatify-lang') || 'es'].reading_pdf_status || 'Leyendo...';
                    dom.pdfPreviewContainer.classList.remove('hidden'); // Show PDF preview container
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        dom.pdfStatusEl.textContent = translations[localStorage.getItem('goatify-lang') || 'es'].processing_pdf_status || 'Procesando...';
                        try {
                            // Use PDF.js to extract text from PDF
                            const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(ev.target.result) }).promise;
                            let text = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const content = await page.getTextContent();
                                text += content.items.map(item => item.str).join(' ') + '\n';
                            }
                            selectedPdfText = text;
                            dom.pdfStatusEl.textContent = `✅ ${translations[localStorage.getItem('goatify-lang') || 'es'].pdf_ready_status || 'Listo'} (${pdf.numPages} ${translations[localStorage.getItem('goatify-lang') || 'es'].pages_short || 'pág.'})`;
                        } catch (err) {
                            console.error("Error al procesar el PDF:", err);
                            dom.pdfStatusEl.textContent = `❌ ${translations[localStorage.getItem('goatify-lang') || 'es'].pdf_error_status || 'Error al leer PDF.'}`;
                            selectedPdfText = null;
                            setTimeout(clearPdfData, 2000); // Clear PDF data after error
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });

                // Sidebar toggle functionality
                dom.menuToggle?.addEventListener('click', (e) => { e.stopPropagation(); toggleSidebar(true); });
                dom.sidebarOverlay?.addEventListener('click', () => toggleSidebar(false));
                dom.sidebarToggleArrow?.addEventListener('click', () => {
                    dom.sidebar.classList.toggle('collapsed');
                    if (dom.sidebar.classList.contains('collapsed')) {
                        dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-left', 'fa-chevron-right');
                    } else {
                        dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-right', 'fa-chevron-left');
                    }
                });
                dom.sidebar.querySelector('#logo-space')?.addEventListener('click', () => {
                    if (window.innerWidth >= 768) {
                        dom.sidebar.classList.toggle('collapsed');
                         if (dom.sidebar.classList.contains('collapsed')) {
                            dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-left', 'fa-chevron-right');
                        } else {
                            dom.sidebarToggleArrow.querySelector('i').classList.replace('fa-chevron-right', 'fa-chevron-left');
                        }
                    }
                });

                // User menu and logout
                dom.userMenuBtn?.addEventListener('click', (e) => { e.stopPropagation(); dom.userMenuPopup.classList.toggle('hidden'); });
                dom.logoutBtn?.addEventListener('click', () => {
                    if (netlifyIdentity) {
                        netlifyIdentity.logout();
                    }
                });

                dom.userSettingsIcon?.addEventListener('click', (e) => { e.stopPropagation(); showSettingsModal(); });

                // Workflow buttons setup
                const workflowConfigs = {
                    'project-management': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_pm, workflow: 'project-management' },
                    'financial-assistant': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_financial, workflow: 'financial-assistant' },
                    'notepad-app': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_notepad, workflow: 'notepad-app' },
                    'english-teacher-translate': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_eng_1, workflow: 'english-teacher-translate' },
                    'create-full-post': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_social_1, workflow: 'create-full-post', initialMessages: [{ role: 'assistant', content: '¡Claro! Vamos a crear un post increíble. ¿Para qué red social lo necesitas (Instagram, Facebook, LinkedIn, etc.)?' }] },
                    'persuasive-copy': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_social_2, workflow: 'persuasive-copy', initialMessages: [{ role: 'assistant', content: 'Estoy listo para redactar textos que vendan. ¿Para qué necesitas este copy? (ej: Anuncio de Facebook, Post de Venta, Descripción de Producto)' }] },
                    'post-ideas': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_social_3, workflow: 'post-ideas', initialMessages: [{ role: 'assistant', content: '¡Acabemos con el bloqueo creativo! Dime un tema y te daré 7 ideas de contenido excelentes.' }] },
                    'brand-strategy': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_social_4, workflow: 'brand-strategy', initialMessages: [{ role: 'assistant', content: 'Definamos el corazón de tu marca. ¿Cuál es el nombre de tu negocio y a qué se dedica?' }] },
                    'competitor-analysis': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_business_1, workflow: 'competitor-analysis', model: 'sonar', initialMessages: [{ role: 'assistant', content: "Estoy listo para analizar a tu competencia usando el buscador web. Por favor, pega la URL (dirección web) de la página que quieres que investigue para entregarte un análisis DAFO simplificado." }] },
                    'buyer-persona': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_business_2, workflow: 'buyer-persona', initialMessages: [{ role: 'assistant', content: "Vamos a definir a tu cliente ideal (Buyer Persona). Describe tu producto o servicio, y te haré preguntas para construir el perfil detallado paso a paso." }] },
                    'brand-names': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_business_3, workflow: 'brand-names', initialMessages: [{ role: 'assistant', content: "¡Excelente! Busquemos un nombre increíble. Describe brevemente tu idea de negocio, tu público y el estilo que buscas (ej. moderno, clásico, divertido) para generar nombres y slogans." }] },
                    'sales-assistant': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_sales_1, workflow: 'sales-assistant', initialMessages: [{ role: 'assistant', content: 'Para ayudarte a cerrar esa venta, pega aquí el mensaje de tu cliente.' }] },
                    'email-writing': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_sales_2, workflow: 'email-writing', initialMessages: [{ role: 'assistant', content: 'Creemos un email que convierta. ¿Cuál es el objetivo principal de este correo?' }] },
                    'english-teacher-vocabulary': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_eng_2, workflow: 'english-teacher-vocabulary', initialMessages: [{ role: 'assistant', content: 'Excellent! Let\'s learn some new vocabulary. What topic are you interested in? (e.g., "business negotiations", "travel")' }] },
                    'english-teacher-practice': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_eng_3, workflow: 'english-teacher-practice', initialMessages: [{ role: 'assistant', content: 'Great! Let\'s practice our conversation. So, tell me about your day.' }] },
                    'social-skills': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_sales_4, workflow: 'social-skills', initialMessages: [{ role: 'assistant', content: 'Las habilidades sociales son clave. ¿En qué situación te gustaría mejorar tu comunicación? (Ej: una reunión de networking, una conversación difícil, etc.)' }] },
                    'design-web': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_sales_3, workflow: 'design-web', model: 'gpt-4o', initialMessages: [{ role: 'assistant', content: 'Estoy listo para diseñar con código. Describe la página o componente que quieres crear, y lo programaré para ti.' }] },
                    'conflict-resolution': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_expert_2, workflow: 'conflict-resolution', initialMessages: [{ role: 'assistant', content: 'Entiendo. Las situaciones difíciles requieren una comunicación clara. Por favor, describe el conflicto objetivamente: ¿quiénes están involucrados y cuál es el punto principal de desacuerdo?' }] },
                    'decision-lab': { title: translations[localStorage.getItem('goatify-lang') || 'es'].wf_expert_1, workflow: 'decision-lab', initialMessages: [{ role: 'assistant', content: 'Bienvenido al Laboratorio de Decisiones. Recuerda que una decisión puede cambiar el rumbo de tu vida. Para ayudarte a analizar tu situación, por favor, dime: ¿Cuál es la decisión que necesitas tomar y qué opciones estás considerando?' }] },
                };

                // Event listener for workflow category toggles and workflow buttons
                document.body.addEventListener('click', e => {
                    const header = e.target.closest('.workflow-header, .actions-header, .folders-header');
                    if (header) {
                        const category = header.parentElement;
                        if (category && (category.classList.contains('workflow-category') || category.classList.contains('actions-category') || category.classList.contains('folders-category'))) {
                            // Only toggle if the click is not on a child action button (like rename/delete)
                            if (!e.target.closest('.chat-item-actions') && !e.target.closest('#add-project-folder-btn')) {
                                const isOpen = category.classList.toggle('open');
                                // Rotate arrow icon
                                const arrowIcon = category.querySelector('.workflow-arrow, .actions-arrow, .folder-arrow');
                                if (arrowIcon) {
                                    arrowIcon.style.transform = isOpen ? 'rotate(90deg)' : 'rotate(0deg)';
                                }
                                // For project folders, persist their open/closed state
                                if (category.classList.contains('project')) {
                                    const project = state.projects[category.dataset.id];
                                    if(project) {
                                        project.isOpen = isOpen;
                                        saveState();
                                    }
                                }
                            }
                        }
                    }

                    const workflowButton = e.target.closest('[data-workflow]');
                    if (workflowButton && workflowButton.closest('.workflow-content, #sidebar-top-actions')) {
                        const workflowKey = workflowButton.dataset.workflow;
                        const config = workflowConfigs[workflowKey];
                         if (config) {
                            if (workflowKey === 'notepad-app') {
                                selectChat('notepad-app'); // Special handling for notepad app
                            } else if (workflowKey === 'english-teacher-translate') {
                                selectChat('translator-view'); // Special handling for translator view
                            }
                            else {
                                createNewChat(config); // Create a new chat for other workflows
                            }
                        }
                    }
                });

                dom.webLaunchOfferBtn.addEventListener('click', () => {
                    const lang = localStorage.getItem('goatify-lang') || 'es';
                    const offerTitle = `<i class="fas fa-gift mr-2"></i>${'Tu Oferta de Lanzamiento Exclusiva'}`;
                    const offerMessage = `<p class="font-bold mb-2">${'Al suscribirte a nuestro Plan Pro por $17/mes, desbloqueas:'}</p><ul class="list-disc list-inside space-y-2 text-left"><li><strong>${'Acceso Ilimitado a Goatify IA:'}</strong> ${'Todos los modelos y workflows sin restricciones.'}</li><li><strong>${'Construcción de tu Página Web Profesional:'}</strong> ${'Nosotros construiremos la primera versión, ¡gratis!'}</li></ul><p class="font-bold mt-4 mb-2">${'¿Cómo funciona?'}</p><ol class="list-decimal list-inside space-y-1 text-left"><li><strong>${'Agenda tu Sesión Estratégica:'}</strong> ${'Al confirmar, agenda tu llamada de 20 min.'}</li><li><strong>${'Co-creación:'}</strong> ${'En la llamada definiremos objetivos y crearemos el borrador con IA.'}</li><li><strong>${'Entrega:'}</strong> ${'Nuestro equipo lo pulirá y te entregará una web de una sección, lista.'}</li></ol><p class="text-xs mt-4 italic"><strong>${'Importante:'}</strong> ${'La web es tuya para siempre. Para mantenerla online con nuestro hosting, necesitas tu suscripción Pro activa. Si cancelas, te entregamos el código completo.'}</p>`;
                    showModal({ title: offerTitle, body: offerMessage, confirmText: 'Agendar Sesión Estratégica' }).then(res => { if (res.confirmed) { window.open('https://calendly.com/goatify', '_blank'); } });
                });
                dom.freeGuidesLink.addEventListener('click', (e) => { e.preventDefault(); const isPaidUser = currentUser && currentUser.app_metadata?.plan && currentUser.app_metadata.plan !== 'free'; if (isPaidUser) { window.open('https://goatify.app/guiasIA', '_blank'); } else { const lang = localStorage.getItem('goatify-lang') || 'es'; const title = 'Acceso Exclusivo para Suscriptores'; const message = 'Estas guías se actualizan semanalmente con estrategias de negocio que te ayudarán a crecer un montón. Son un beneficio exclusivo para nuestros suscriptores. ¡Únete a un plan para desbloquearlas!'; showModal({ title, body: message, confirmText: 'Ver Planes' }).then(res => { if (res.confirmed) { showPricingModal(); } }); } });
                dom.closeHtmlPreviewModalBtn?.addEventListener('click', () => { dom.htmlPreviewModal.classList.add('hidden'); dom.htmlPreviewModal.classList.remove('flex'); });

                dom.downloadHtmlBtn?.addEventListener('click', () => {
                    const htmlContent = dom.htmlPreviewIframe.srcdoc;
                    const blob = new Blob([htmlContent], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'generated_page.html';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showInAppNotification("Descarga Exitosa", "El archivo HTML ha sido descargado.", 800);
                });

                dom.copyHtmlBtn?.addEventListener('click', () => {
                    const htmlContent = dom.htmlPreviewIframe.srcdoc;
                    navigator.clipboard.writeText(htmlContent)
                        .then(() => showInAppNotification("Copiado", "El código HTML ha sido copiado al portapapeles.", 800))
                        .catch(err => console.error('Error al copiar el texto: ', err));
                });


                dom.voiceSelector?.addEventListener('change', (e) => { selectedVoice = availableVoices.find(voice => voice.name === e.target.value); });

                document.addEventListener('click', (e) => {
                    // Close user menu popup if clicked outside
                    if (dom.userMenuBtn && dom.userMenuPopup && !dom.userMenuBtn.contains(e.target) && !dom.userMenuPopup.contains(e.target) && !dom.userSettingsIcon.contains(e.target)) { dom.userMenuPopup.classList.add('hidden'); }

                    // Close services menu if clicked outside
                    const servicesMenu = dom.servicesMenu;
                    const servicesMenuBtn = dom.servicesMenuBtn;
                    if (servicesMenu && servicesMenuBtn && servicesMenu.classList.contains('show') && !servicesMenuBtn.contains(e.target) && !servicesMenu.contains(e.target)) {
                        servicesMenu.classList.remove('show');
                    }
                    // Close tag filter dropdown if clicked outside
                    if (dom.tagFilterDropdown && dom.tagFilterBtn && !dom.tagFilterBtn.contains(e.target) && !dom.tagFilterDropdown.contains(e.target)) {
                        dom.tagFilterDropdown.classList.add('hidden');
                    }
                    // Close "add to folder" dropdowns if clicked outside
                    document.querySelectorAll('.add-to-folder-dropdown').forEach(dropdown => {
                        if (!e.target.closest('.add-to-folder-btn')) {
                            dropdown.classList.add('hidden');
                        }
                    });
                });

                // WhatsApp solution links
                const solutionLinks = {
                    "sol-web": "Hola, estoy interesado en su servicio de 'Páginas Web que Convierten'. ¿Podrían darme más información?",
                    "sol-auto": "Hola, me interesa saber más sobre 'Ventas en Piloto Automático' con IA. ¿Cómo funciona?",
                    "sol-social": "Hola, quisiera información sobre los 'Avatares para Redes Sociales' y las estrategias de contenido.",
                    "sol-consult": "Hola, estoy interesado en la consultoría para 'Escalar mi Empresa con IA'. ¿Cuáles son los siguientes pasos?"
                };

                Object.entries(solutionLinks).forEach(([id, message]) => {
                    const linkEl = document.getElementById(id);
                    if (linkEl) {
                        linkEl.addEventListener('click', (e) => {
                            e.preventDefault();
                            const whatsappUrl = `https://wa.me/17439106116?text=${encodeURIComponent(message)}`;
                            window.open(whatsappUrl, '_blank');
                        });
                    }
                });

                dom.servicesMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dom.servicesMenu.classList.toggle('show');
                });

                // Set app container height on resize
                const setAppHeight = () => { const app = document.getElementById('app-container'); if(app) app.style.height = `${window.innerHeight}px`; };
                setAppHeight();
                window.addEventListener('resize', setAppHeight);

                // Multi-select mode buttons
                dom.selectChatsBtn?.addEventListener('click', () => toggleSelectMode(true));
                dom.cancelSelectModeBtn?.addEventListener('click', () => toggleSelectMode(false));
                dom.deleteSelectedBtn?.addEventListener('click', async () => {
                    if (chatsToDelete.size === 0) return;
                    const lang = localStorage.getItem('goatify-lang') || 'es';
                    const confirm = await showModal({ title: `Eliminar ${chatsToDelete.size} elemento(s)`, body: 'Esta acción es irreversible. ¿Confirmas la eliminación?', confirmText: 'Eliminar', dangerConfirm: true });
                    if (confirm.confirmed) {
                        chatsToDelete.forEach(id => deleteItem(id.split('-')[0], id)); // Delete each selected item
                        toggleSelectMode(false); // Exit select mode
                    }
                });

                // Settings modal buttons and controls
                dom.settingsBtn?.addEventListener('click', showSettingsModal);
                dom.closeSettingsModal?.addEventListener('click', hideSettingsModal);
                dom.settingsUpgradePlanBtn?.addEventListener('click', () => { hideSettingsModal(); showPricingModal(); });
                dom.fontSizeSlider?.addEventListener('input', (e) => {
                    const fontSize = e.target.value;
                    document.body.style.setProperty('--base-font-size', `${fontSize}px`); // Update CSS variable for font size
                    dom.fontSizeValue.textContent = `${fontSize}px`;
                });
                dom.settingsThemeToggle?.addEventListener('click', () => {
                    setTheme(!document.body.classList.contains('dark-theme'));
                });
                dom.notificationsToggle?.addEventListener('change', async () => {
                    notificationsEnabled = dom.notificationsToggle.checked;
                    localStorage.setItem('goatify-notifications-enabled', notificationsEnabled);
                    if (notificationsEnabled) {
                        const permission = await Notification.requestPermission(); // Request notification permission
                        if (permission === 'granted') {
                            registerServiceWorkerAndSubscribe(); // Register SW and subscribe for push
                        } else {
                            // If permission denied, revert toggle and disable notifications
                            notificationsEnabled = false;
                            dom.notificationsToggle.checked = false;
                             localStorage.setItem('goatify-notifications-enabled', 'false');
                        }
                    }
                });
                dom.languageSelector?.addEventListener('change', (e) => {
                    setLanguage(e.target.value);
                });
                dom.connectWhatsappBtn?.addEventListener('click', () => {
                    window.open('https://wa.me/17439106116?text=Hola%2C%20me%20gustar%C3%ADa%20conectar%20mi%20cuenta%20de%20Goatify%20IA%20a%20WhatsApp', '_blank');
                });
                dom.scheduleMeetingBtn?.addEventListener('click', () => {
                    window.open('https://calendly.com/goatify', '_blank');
                });
                dom.freePlanButton?.addEventListener('click', showPricingModal);

                // Calendar modal buttons and controls
                dom.calendarBtn?.addEventListener('click', showCalendarModal);
                dom.mobileCalendarBtn?.addEventListener('click', showCalendarModal);

                dom.projectCalendarBtn?.addEventListener('click', showCalendarModal);
                dom.closeCalendarModal?.addEventListener('click', hideCalendarModal);

                dom.prevMonthBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.subtract(1, 'month'); renderCalendarView(); });
                dom.nextMonthBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.add(1, 'month'); renderCalendarView(); });
                dom.prevWeekBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.subtract(1, 'week'); renderCalendarView(); });
                dom.nextWeekBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.add(1, 'week'); renderCalendarView(); });
                dom.prevDayBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.subtract(1, 'day'); renderCalendarView(); });
                dom.nextDayBtn?.addEventListener('click', () => { selectedCalendarDate = selectedCalendarDate.add(1, 'day'); renderCalendarView(); });

                dom.monthViewBtn.addEventListener('click', () => { currentCalendarView = 'month'; renderCalendarView(); });
                dom.weekViewBtn.addEventListener('click', () => { currentCalendarView = 'week'; renderCalendarView(); });
                dom.dayViewBtn.addEventListener('click', () => { currentCalendarView = 'day'; renderCalendarView(); });
                dom.addTaskBtn?.addEventListener('click', () => editCalendarTask(null, selectedCalendarDate.format('YYYY-MM-DD')));

                // Event listener for info icons in modals
                document.body.addEventListener('click', (e) => {
                    if (e.target.classList.contains('fa-info-circle')) {
                        const title = e.target.closest('h4')?.textContent.trim().replace(/\s*[\r\n].*/g, '').replace(/\s*(\r|\n)\s*/g, ' ').replace(/\s{2,}/g, ' '); // Clean title
                        const description = e.target.title;
                        showModal({ title: title, body: description, showConfirm: false, cancelText: 'Cerrar' });
                    }
                });

                // Project management view toggles
                dom.viewToggleKanban.addEventListener('click', () => {
                    if (!currentChatId) return;
                    const chat = state.chats[currentChatId];
                    if (!chat || !chat.projectData) return;
                    chat.projectData.currentView = 'kanban';
                     renderProjectBoard(currentChatId);
                });
                dom.viewToggleList.addEventListener('click', () => {
                    if (!currentChatId) return;
                    const chat = state.chats[currentChatId];
                    if (!chat || !chat.projectData) return;
                    chat.projectData.currentView = 'list';
                     renderProjectBoard(currentChatId);
                });
                 dom.addTaskListViewBtn.addEventListener('click', () => {
                    if (currentChatId) {
                        editProjectTask(currentChatId, null, 'todo'); // Add task to 'todo' column
                    }
                });

                // Chat collapse toggles for project, financial, notepad assistants
                document.body.addEventListener('click', e => {
                    const toggleAndContainer = [
                        { header: '#project-chat-container-header', container: dom.projectChatContainer },
                        { header: '#financial-chat-header', container: document.getElementById('financial-chat-container') },
                        { header: '#notepad-chat-header', container: dom.notepadChatContainer }
                    ];

                    toggleAndContainer.forEach(item => {
                        if (e.target.closest(item.header)) {
                             item.container?.classList.toggle('collapsed');
                        }
                    });
                });

                // NOTEPAD Event Listeners
                dom.addNewNoteBtn?.addEventListener('click', () => createNewNote('text'));
                dom.addNewDrawingBtn?.addEventListener('click', () => createNewNote('drawing'));
                dom.deleteNoteBtn?.addEventListener('click', () => deleteItem('note', currentNoteId));
                dom.shareNoteBtn?.addEventListener('click', shareNote);
                dom.exportPdfBtn?.addEventListener('click', exportNoteAsPdf); // New: Export to PDF button
                dom.noteBackBtn?.addEventListener('click', () => {
                    dom.notepadViewContainer.classList.remove('mobile-editor-active'); // Go back to notes list on mobile
                });
                dom.noteTitleInput?.addEventListener('input', (e) => {
                    const note = state.notes.find(n => n.id === currentNoteId);
                    if (note && note.title !== e.target.value) {
                        note.title = e.target.value;
                        saveState();
                        renderSidebar(); // Update sidebar with new title
                    }
                });
                dom.noteContentEditor?.addEventListener('input', () => {
                    const note = state.notes.find(n => n.id === currentNoteId);
                     if (note && note.type === 'text') {
                        note.content = dom.noteContentEditor.innerHTML; // Save content from editor
                        saveState();
                    }
                });
                dom.noteContentEditor?.addEventListener('keydown', (e) => {
                    // Handle Enter key for checklist items
                    if (e.key === 'Enter' && !e.shiftKey) {
                        const selection = window.getSelection();
                        const range = selection.getRangeAt(0);
                        const currentChecklistItem = range.startContainer.closest('.checklist-item');
                        if (currentChecklistItem) {
                            e.preventDefault();
                            applyTextFormat('insertHTML', '<div class="checklist-item"><input type="checkbox" class="checklist-item-checkbox"><span contenteditable="true" class="checklist-item-text"></span></div>');
                        }
                    }
                });

                // Text editor formatting buttons
                dom.boldBtn?.addEventListener('click', () => applyTextFormat('bold'));
                dom.italicBtn?.addEventListener('click', () => applyTextFormat('italic'));
                dom.underlineBtn?.addEventListener('click', () => applyTextFormat('underline'));
                dom.copyBtn?.addEventListener('click', () => document.execCommand('copy'));
                dom.cutBtn?.addEventListener('click', () => document.execCommand('cut'));
                dom.pasteBtn?.addEventListener('click', () => document.execCommand('paste'));
                dom.alignLeftBtn?.addEventListener('click', () => applyTextFormat('justifyLeft'));
                dom.alignCenterBtn?.addEventListener('click', () => applyTextFormat('justifyCenter'));
                dom.alignRightBtn?.addEventListener('click', () => applyTextFormat('justifyRight'));
                dom.justifyBtn?.addEventListener('click', () => applyTextFormat('justifyFull')); // Added Justify button

                dom.fontFamilySelector?.addEventListener('change', (e) => {
                    const selectedFont = e.target.value;
                    dom.noteContentEditor.style.fontFamily = selectedFont; // Apply font family
                    localStorage.setItem('notepad-font-family', selectedFont); // Save preference
                    const note = state.notes.find(n => n.id === currentNoteId);
                    if (note && note.type === 'text') {
                        note.content = dom.noteContentEditor.innerHTML;
                        saveState();
                    }
                });


                dom.noteContentEditor?.addEventListener('mouseup', updateToolbarButtonStates); // Update button states on selection change
                dom.noteContentEditor?.addEventListener('keyup', updateToolbarButtonStates); // Update button states on key up
                dom.noteContentEditor?.addEventListener('click', e => {
                    handleChecklistItem(e.target); // Handle checklist item clicks
                    updateToolbarButtonStates();
                });
                dom.addChecklistItemBtn?.addEventListener('click', () => {
                    const selection = window.getSelection();
                    const range = selection.getRangeAt(0);
                    const currentContainer = selection.focusNode?.parentElement?.closest('#note-content-editor, .checklist-item-text');

                    if (!currentContainer) {
                        // If no specific container, append to editor
                        dom.noteContentEditor.innerHTML += `<div class="checklist-item"><input type="checkbox" class="checklist-item-checkbox"><span contenteditable="true" class="checklist-item-text"></span></div>`;
                        const newChecklistItem = dom.noteContentEditor.lastElementChild;
                        const newTextSpan = newChecklistItem.querySelector('.checklist-item-text');
                        if (newTextSpan) {
                            newTextSpan.focus(); // Focus on new checklist item
                        }
                    } else {
                        // If inside existing text or checklist item, insert new checklist item
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = `<input type="checkbox" class="checklist-item-checkbox"><span contenteditable="true" class="checklist-item-text"></span>`;
                        const newChecklistItemContent = tempDiv.firstChild;
                        const newTextSpan = newChecklistItemContent.nextElementSibling;

                        if (currentContainer.classList.contains('checklist-item-text')) {
                            const parentChecklistItem = currentContainer.closest('.checklist-item');
                            const newChecklistItemWrapper = document.createElement('div');
                            newChecklistItemWrapper.className = 'checklist-item';
                            newChecklistItemWrapper.appendChild(newChecklistItemContent);
                            newChecklistItemWrapper.appendChild(newTextSpan);

                            parentChecklistItem.parentNode.insertBefore(newChecklistItemWrapper, parentChecklistItem.nextSibling);
                            newTextSpan.focus();
                        } else {
                            range.deleteContents();
                            const wrapper = document.createElement('div');
                            wrapper.className = 'checklist-item';
                            wrapper.appendChild(newChecklistItemContent);
                            wrapper.appendChild(newTextSpan);
                            range.insertNode(wrapper);
                            range.setStartAfter(wrapper);
                            range.setEndAfter(wrapper);
                            selection.removeAllRanges();
                            selection.addRange(range);
                            newTextSpan.focus();
                        }
                    }
                    const note = state.notes.find(n => n.id === currentNoteId);
                    if (note) {
                        note.content = dom.noteContentEditor.innerHTML;
                        saveState();
                    }
                });

                // Event listeners for pricing plan details toggle
                document.querySelectorAll('.plan-details-toggle').forEach(button => {
                    button.addEventListener('click', () => {
                        const details = button.nextElementSibling;
                        details.classList.toggle('open');
                    });
                 });

                // Setup click outside listeners for modals
                setupModalClickOutside(dom.genericModal, ()=>hideModal({confirmed: false}));
                setupModalClickOutside(dom.pricingModal, hidePricingModal);
                setupModalClickOutside(dom.settingsModal, hideSettingsModal);
                setupModalClickOutside(dom.calendarModalOverlay, hideCalendarModal);
                setupModalClickOutside(dom.motivationModal, hideMotivationModal);
                setupModalClickOutside(dom.htmlPreviewModal, () => {
                    dom.htmlPreviewModal.classList.add('hidden');
                    dom.htmlPreviewModal.classList.remove('flex');
                });
                setupModalClickOutside(dom.creditLimitModal, () => { // Modified to handle the "Ver Planes" button
                    hideModal();
                    showPricingModal();
                });

                // Gamification modal listeners
                dom.gamificationBtn?.addEventListener('click', () => {
                    if(!currentUser) {
                        showInAppNotification(translations[localStorage.getItem('goatify-lang') || 'es'].exclusive_feature_title || "Función Exclusiva", translations[localStorage.getItem('goatify-lang') || 'es'].exclusive_feature_message || "La gamificación está disponible para usuarios logueados.", 3000);
                        return;
                    }
                    renderGamificationModal();
                    dom.gamificationModal.classList.remove('hidden');
                    dom.gamificationModal.classList.add('flex');
                     setTimeout(() => dom.gamificationModal.querySelector('.modal-content').classList.remove('scale-95'), 10);
                });
                dom.closeGamificationModal?.addEventListener('click', () => {
                    dom.gamificationModal.querySelector('.modal-content').classList.add('scale-95');
                    setTimeout(() => { dom.gamificationModal.classList.add('hidden'); dom.gamificationModal.classList.remove('flex'); }, 300);
                });
                dom.gamificationModal.addEventListener('click', (e) => {
                    if (e.target === dom.gamificationModal) {
                        dom.closeGamificationModal.click();
                    }
                });

                // Gamification rules modal
                dom.gamificationRulesBtn?.addEventListener('click', () => {
                    dom.gamificationRulesModal.classList.remove('hidden');
                    dom.gamificationRulesModal.classList.add('flex');
                });
                dom.closeGamificationRulesModal?.addEventListener('click', () => {
                    dom.gamificationRulesModal.classList.add('hidden');
                    dom.gamificationRulesModal.classList.remove('flex');
                });
                setupModalClickOutside(dom.gamificationRulesModal, () => {
                    dom.gamificationRulesModal.classList.add('hidden');
                    dom.gamificationRulesModal.classList.remove('flex');
                });

                // Gamification tabs
                dom.gamificationModal.querySelectorAll('.gamification-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const currentActive = dom.gamificationModal.querySelector('.gamification-tab.active');
                        if (currentActive) currentActive.classList.remove('active');
                        tab.classList.add('active');
                        dom.gamificationModal.querySelectorAll('.gamification-tab-content').forEach(content => content.classList.add('hidden'));
                         dom.gamificationModal.querySelector(`#gamification-tab-${tab.dataset.tab}`).classList.remove('hidden');
                    });
                });
                // Gamification mission buttons
                dom.missionsContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-mission-id]');
                    if (button && !button.disabled) {
                        const missionId = button.dataset.missionId;
                        const mission = MISSIONS[missionId];
                        if (mission && mission.workflow) {
                            const workflowButton = document.querySelector(`[data-workflow="${mission.workflow}"]`);
                            if(workflowButton) {
                                workflowButton.click(); // Simulate click on workflow button
                                dom.closeGamificationModal.click(); // Close gamification modal
                            }
                        } else if (mission && mission.action === 'generateImage') {
                            generateImage(); // Trigger image generation
                            dom.closeGamificationModal.click();
                        } else {
                            dom.closeGamificationModal.click();
                        }
                    }
                });
            }

            /**
             * Renders the project management view for a specific project chat.
             * Initializes project data if not present and renders the project board.
             * @param {string} chatId - The ID of the project chat.
             */
            function renderProjectView(chatId) {
                const chat = state.chats[chatId];
                if (!chat) return;

                if (!chat.projectData) {
                    // Initialize default project data if not present
                    chat.projectData = {
                        title: chat.title,
                        columns: [
                             { id: 'todo', title: 'Por Hacer', tasks: [] },
                            { id: 'doing', title: 'En Progreso', tasks: [] },
                            { id: 'done', title: 'Hecho', tasks: [] }
                         ],
                        currentView: 'list'
                    };
                }

                dom.projectViewTitle.textContent = chat.projectData.title; // Set project title
                const projectChatMessages = document.getElementById('project-chat-messages');
                if(projectChatMessages) {
                    projectChatMessages.innerHTML = '';
                    // Display project chat messages
                    chat.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, msg.image, index, projectChatMessages));
                }

                // Collapse project chat on mobile by default
                if (window.innerWidth < 768) {
                    dom.projectChatContainer.classList.add('collapsed');
                } else {
                    dom.projectChatContainer.classList.remove('collapsed');
                }
                renderProjectBoard(chatId); // Render the Kanban or List board

                // Disable GOAT X PRO option for non-logged-in users in project model selector
                const projectModelSelector = document.getElementById('project-model-selector');
                if (projectModelSelector) {
                    const goatXProOption = projectModelSelector.querySelector('.goat-x-pro-model');
                    if (goatXProOption) goatXProOption.disabled = !currentUser;
                }
            }

            /**
             * Renders the project board (Kanban or List view) for a given project chat.
             * @param {string} chatId - The ID of the project chat.
             */
            function renderProjectBoard(chatId) {
                const chat = state.chats[chatId];
                if(!chat || !chat.projectData) return;
                const { projectData } = chat;
                const isMobile = window.innerWidth < 768;

                const isKanban = projectData.currentView === 'kanban';
                dom.viewToggleKanban.classList.toggle('active', isKanban);
                dom.viewToggleList.classList.toggle('active', !isKanban);

                // Toggle visibility of Kanban, Desktop List, and Mobile List views
                dom.kanbanView.style.display = isKanban ? 'grid' : 'none';
                dom.listView.style.display = (!isKanban && !isMobile) ? 'flex' : 'none';
                dom.listViewMobile.style.display = (!isKanban && isMobile) ? 'block' : 'none';
                dom.addTaskListViewBtn.style.display = isKanban ? 'none' : 'block'; // Show/hide add task button

                if (isKanban) {
                    renderKanbanView(chatId);
                } else {
                    if (isMobile) {
                        renderListViewMobile(chatId);
                    } else {
                        renderListView(chatId);
                    }
                }
                renderTagFilter(chatId); // Render tag filter dropdown
            }

            /**
             * Renders the Kanban board view for a project.
             * @param {string} chatId - The ID of the project chat.
             */
            function renderKanbanView(chatId) {
                const { projectData } = state.chats[chatId];
                dom.kanbanView.innerHTML = ''; // Clear existing Kanban content

                projectData.columns.forEach(column => {
                    const columnEl = document.createElement('div');
                    columnEl.className = 'kanban-column';
                    columnEl.innerHTML = `<h3 class="kanban-column-title">
                        <span>${column.title}</span>
                         <button class="add-task-to-column-btn text-lg hover:text-primary" data-column-id="${column.id}">+</button>
                    </h3><div class="kanban-cards" data-column-id="${column.id}"></div>`;

                    const cardsContainer = columnEl.querySelector('.kanban-cards');

                    // Filter tasks by active tag
                    const tasksToRender = (column.tasks || []).filter(task => !activeTagFilter || (task.labels && task.labels.includes(activeTagFilter)));

                    tasksToRender.forEach(task => {
                        const cardEl = document.createElement('div');
                         cardEl.className = 'kanban-card';
                        if (task.urgent) cardEl.classList.add('urgent');
                        if (task.completed) cardEl.classList.add('task-item-completed');
                        cardEl.draggable = true;
                        cardEl.dataset.taskId = task.id; // Store task ID

                        const labelsHtml = (task.labels || []).map(label => `<span class="task-label" style="background-color: ${getLabelColor(label)}; color: white;">${label}</span>`).join('');
                        cardEl.innerHTML = `
                        <i class="fas fa-times delete-task-icon" data-task-id="${task.id}"></i>
                        <div class="flex justify-between items-start">
                            <p>${task.content}</p>
                            ${task.urgent ? '<i class="fas fa-flag text-red-500 ml-2" title="Urgente"></i>' : ''}
                        </div>
                        <div class="task-labels">${labelsHtml}</div>
                        <div class="card-footer">
                             <span>${task.dueDate ? `<i class="fas fa-calendar-alt mr-1"></i> ${dayjs(task.dueDate).format('D MMM')}` : ''}</span>
                            <span>${task.time || ''}</span>
                        </div>`;
                        cardEl.addEventListener('dragstart', e => {
                            e.dataTransfer.setData('text/plain', task.id);
                            e.dataTransfer.effectAllowed = 'move';
                        });
                        cardEl.addEventListener('touchstart', handleTouchStart, {passive: false}); // Touch drag for mobile

                        cardEl.addEventListener('click', (e) => {
                            if (e.target.classList.contains('delete-task-icon')) {
                                e.stopPropagation();
                                deleteTask(task.id, chatId);
                            } else {
                                editProjectTask(chatId, task.id); // Edit task on click
                            }
                        });

                        cardsContainer.appendChild(cardEl);
                    });

                    // Drag and drop listeners for Kanban columns
                    cardsContainer.addEventListener('dragover', e => { e.preventDefault(); cardsContainer.classList.add('drag-over'); });
                    cardsContainer.addEventListener('dragleave', () => { cardsContainer.classList.remove('drag-over'); });
                    cardsContainer.addEventListener('drop', e => {
                        e.preventDefault();
                        cardsContainer.classList.remove('drag-over');
                        const taskId = e.dataTransfer.getData('text/plain');
                        if (!taskId.startsWith('proj-')) return; // Only accept project tasks
                         moveTask(chatId, taskId, column.id); // Move task to this column
                    });
                    dom.kanbanView.appendChild(columnEl);
                });

                // Add task button for each column
                dom.kanbanView.querySelectorAll('.add-task-to-column-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const columnId = e.currentTarget.dataset.columnId;
                        editProjectTask(chatId, null, columnId); // Add new task to specific column
                    });
                });
            }

            /**
             * Renders the List view for a project (desktop version).
             * @param {string} chatId - The ID of the project chat.
             */
            function renderListView(chatId) {
                const { projectData } = state.chats[chatId];
                dom.listView.innerHTML = ''; // Clear existing list content

                const header = document.createElement('div');
                header.className = 'list-view-header flex-shrink-0';
                header.innerHTML = `
                     <span class="truncate">Nombre</span>
                    <span class="truncate">Fecha y Hora</span>
                    <span class="truncate">Prioridad</span>
                    <span class="truncate">Etiquetas</span>
                    <span class="truncate"></span>
                `;
                dom.listView.appendChild(header);

                const listContent = document.createElement('div');
                listContent.className = 'list-view-content';

                projectData.columns.forEach(column => {
                    const columnTitle = document.createElement('h4');
                    columnTitle.className = 'font-bold text-text-medium p-2 bg-current-bg-light mt-2 rounded cursor-pointer';
                    columnTitle.textContent = column.title;
                    // Drag and drop listeners for column titles (to drop tasks into columns)
                    columnTitle.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-primary)'; });
                    columnTitle.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    columnTitle.addEventListener('drop', e => {
                        e.preventDefault();
                        e.currentTarget.style.backgroundColor = '';
                        const taskId = e.dataTransfer.getData('text/plain');
                        if (taskId) {
                            moveTask(chatId, taskId, column.id); // Move task to this column
                        }
                    });
                    listContent.appendChild(columnTitle);

                    // Filter tasks by active tag
                    const tasksToRender = (column.tasks || []).filter(task => !activeTagFilter || (task.labels && task.labels.includes(activeTagFilter)));

                    tasksToRender.forEach(task => {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'list-view-task';
                        if(column.id !== 'done') taskEl.draggable = true; // Don't allow dragging from 'done' column
                        taskEl.dataset.taskId = task.id;

                        const labelsHtml = (task.labels || []).map(label => `<span class="task-label" style="background-color: ${getLabelColor(label)}; color: white;">${label}</span>`).join('');

                        taskEl.innerHTML = `
                            <span class="truncate task-content-list ${task.urgent ? 'urgent' : ''}" data-task-id="${task.id}"><input type="text" class="w-full bg-transparent border-none outline-none" value="${task.content}"></span>
                            <span class="text-sm truncate flex items-center gap-2">
                                <input type="date" class="task-date-input" value="${task.dueDate || ''}" data-task-id="${task.id}">
                                <input type="time" class="task-time-input" value="${task.time || ''}" data-task-id="${task.id}">
                            </span>
                            <div class="priority-cell" data-task-id="${task.id}">
                                ${task.urgent ? '<i class="fas fa-flag text-red-500" title="Urgente"></i>' : '<i class="far fa-flag text-text-medium" title="No urgente"></i>'}
                            </div>
                            <div class="task-labels truncate">${labelsHtml || '–'}</div>
                            <div class="text-center">
                                <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1" data-task-id="${task.id}"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        `;

                        taskEl.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', task.id); });
                        taskEl.addEventListener('touchstart', handleTouchStart, {passive: false}); // Touch drag for mobile
                        listContent.appendChild(taskEl);
                    });

                    const newRowEl = document.createElement('div');
                    newRowEl.className = 'list-view-task';
                    newRowEl.innerHTML = `
                        <button class="add-task-to-list-btn text-left text-text-medium hover:text-primary"><i class="fas fa-plus mr-2"></i>Añadir tarea</button>
                        <span/><span/><span/><span/>
                    `;
                    newRowEl.querySelector('.add-task-to-list-btn').addEventListener('click', () => {
                        editProjectTask(chatId, null, column.id); // Add new task to specific column
                    });
                    listContent.appendChild(newRowEl);
                });

                dom.listView.appendChild(listContent);

                // Event listeners for inline editing and actions
                dom.listView.querySelectorAll('.task-content-list input').forEach(input => {
                    const save = () => {
                        const taskId = input.closest('.list-view-task').dataset.taskId;
                        updateTaskStatus(taskId, { content: input.value });
                    };
                    input.addEventListener('blur', save); // Save on blur
                    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); }); // Save on Enter
                });
                 dom.listView.querySelectorAll('.task-date-input, .task-time-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                         const taskId = e.currentTarget.dataset.taskId;
                         const field = e.currentTarget.classList.contains('task-date-input') ? 'dueDate' : 'time';
                         updateTaskStatus(taskId, { [field]: e.currentTarget.value });
                    });
                });
                dom.listView.querySelectorAll('.priority-cell').forEach(cell => {
                     cell.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const taskId = e.currentTarget.dataset.taskId;
                        const task = findTask(taskId)?.task;
                        if(task) updateTaskStatus(taskId, { urgent: !task.urgent }); // Toggle urgent status
                    });
                });
                dom.listView.querySelectorAll('.delete-task-icon').forEach(btn => {
                     btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteTask(e.currentTarget.dataset.taskId, chatId);
                    });
                });
            }

            /**
             * Renders the List view for a project (mobile version).
             * @param {string} chatId - The ID of the project chat.
             */
            function renderListViewMobile(chatId) {
                const { projectData } = state.chats[chatId];
                dom.listViewMobile.innerHTML = ''; // Clear existing mobile list content

                projectData.columns.forEach(column => {
                    const columnEl = document.createElement('div');
                    columnEl.className = "list-view-column-mobile my-2";
                    columnEl.dataset.columnId = column.id; // Store column ID for drops
                    const columnTitle = document.createElement('h4');
                    columnTitle.className = 'font-bold text-text-medium p-2 bg-current-bg-light mt-2 rounded-t-md';
                    columnTitle.textContent = column.title;
                    columnEl.appendChild(columnTitle);

                    const tasksContainer = document.createElement('div');
                    // Filter tasks by active tag
                    const tasksToRender = (column.tasks || []).filter(task => !activeTagFilter || (task.labels && task.labels.includes(activeTagFilter)));

                    tasksToRender.forEach(task => {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'list-view-task-mobile';
                        taskEl.draggable = true;
                        taskEl.dataset.taskId = task.id;
                         if (task.completed) taskEl.classList.add('task-item-completed');

                        const labelsHtml = (task.labels || []).map(label => `<span class="task-label" style="background-color: ${getLabelColor(label)}; color: white;">${label}</span>`).join('');

                        taskEl.innerHTML = `
                            <div class="list-view-task-mobile-header">
                                <span class="task-content-list flex-grow ${task.urgent ? 'urgent' : ''}" data-task-id="${task.id}">${task.content}</span>
                                <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1 flex-shrink-0" data-task-id="${task.id}"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <div class="list-view-task-mobile-footer">
                                <div class="task-labels truncate">${labelsHtml || '–'}</div>
                                <div class="task-time-date-inputs">
                                     <input type="time" class="task-time-input" value="${task.time || ''}" data-task-id="${task.id}">
                                     <input type="date" class="task-date-input" value="${task.dueDate || ''}" data-task-id="${task.id}">
                                </div>
                            </div>
                        `;
                        taskEl.addEventListener('touchstart', handleTouchStart, {passive: false}); // Touch drag for mobile
                        tasksContainer.appendChild(taskEl);
                    });

                    const addTaskBtn = document.createElement('button');
                    addTaskBtn.className = 'add-task-to-list-btn text-left text-text-medium hover:text-primary p-2 w-full';
                    addTaskBtn.innerHTML = `<i class="fas fa-plus mr-2"></i>Añadir tarea`;
                    addTaskBtn.onclick = () => {
                         editProjectTask(chatId, null, column.id); // Add new task to specific column
                    };
                    tasksContainer.appendChild(addTaskBtn);

                    columnEl.appendChild(tasksContainer);
                    // Drag and drop listeners for mobile list columns
                    columnEl.addEventListener('dragover', e => { e.preventDefault(); columnEl.style.backgroundColor = 'rgba(138, 79, 255, 0.1)'; });
                    columnEl.addEventListener('dragleave', e => { columnEl.style.backgroundColor = ''; });
                    columnEl.addEventListener('drop', e => {
                         e.preventDefault();
                         columnEl.style.backgroundColor = '';
                         const taskId = e.dataTransfer.getData('text/plain');
                         if(taskId.startsWith('proj-')) {
                            moveTask(chatId, taskId, column.id);
                         }
                    });
                    dom.listViewMobile.appendChild(columnEl);
                });

                // Event listeners for inline editing and actions in mobile list view
                dom.listViewMobile.querySelectorAll('.task-content-list').forEach(span => {
                    span.addEventListener('click', (e) => {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = span.textContent;
                        input.className = 'w-full bg-transparent border-b border-primary';
                        span.replaceWith(input);
                        input.focus();
                        input.addEventListener('blur', () => {
                            updateTaskStatus(input.closest('.list-view-task-mobile').dataset.taskId, { content: input.value });
                        });
                        input.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') input.blur(); });
                    });
                });
                dom.listViewMobile.querySelectorAll('.task-date-input, .task-time-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                         const taskId = e.currentTarget.dataset.taskId;
                         const field = e.currentTarget.classList.contains('task-date-input') ? 'dueDate' : 'time';
                         updateTaskStatus(taskId, { [field]: e.currentTarget.value });
                    });
                });
                dom.listViewMobile.querySelectorAll('.delete-task-icon').forEach(btn => {
                     btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteTask(e.currentTarget.dataset.taskId, chatId);
                    });
                });
            }

            /**
             * Deletes a task from either the personal calendar or a project.
             * Confirms deletion with the user.
             * @param {string} taskId - The ID of the task to delete.
             * @param {string} [chatId] - The ID of the project chat (if it's a project task).
             */
            async function deleteTask(taskId, chatId) {
                const lang = localStorage.getItem('goatify-lang') || 'es';
                const result = await showModal({
                    title: translations[lang].delete_task_confirm_title,
                    body: translations[lang].delete_task_confirm_body,
                    confirmText: translations[lang].delete_btn,
                    dangerConfirm: true
                });

                if (result.confirmed) {
                    const found = findTask(taskId);
                    if (!found) return;

                    if (found.type === 'personal') {
                        const { dayKey, taskIndex } = found;
                        state.calendar[dayKey].splice(taskIndex, 1); // Remove from personal calendar
                        if(state.calendar[dayKey].length === 0) delete state.calendar[dayKey]; // Remove day entry if empty
                    } else if (found.type === 'project') {
                        const { column, taskIndex } = found;
                        column.tasks.splice(taskIndex, 1); // Remove from project column
                    }
                    saveState(); // Save updated state
                    if (dom.calendarModalOverlay.classList.contains('flex')) renderCalendarView(); // Re-render calendar if open
                    if (dom.projectManagementView.style.display === 'flex') renderProjectBoard(chatId || currentChatId); // Re-render project board if open
                }
            }

            /**
             * Edits an existing project task or adds a new one.
             * Opens a modal for task details.
             * @param {string} chatId - The ID of the project chat.
             * @param {string|null} taskId - The ID of the task to edit, or null for a new task.
             * @param {string} [columnIdForNew] - The column ID to add a new task to.
             */
            async function editProjectTask(chatId, taskId, columnIdForNew) {
                const task = taskId ? findTask(taskId)?.task : null;
                const isNew = !task;
                const lang = localStorage.getItem('goatify-lang') || 'es';

                const result = await showModal({
                    title: isNew ? 'Nueva Tarea de Proyecto' : 'Editar Tarea',
                    body: `
                        <div class="space-y-4">
                            <div><label for="task-content-edit" class="block text-sm font-medium text-text-light mb-1">Contenido:</label><textarea id="task-content-edit" class="w-full p-2 rounded bg-input border border-themed h-24">${isNew ? '' : task.content}</textarea></div>
                            <div class="flex gap-4"><div class="flex-1"><label for="task-due-date" class="block text-sm font-medium text-text-light mb-1">Fecha:</label><input type="date" id="task-due-date" value="${isNew ? '' : task.dueDate || ''}" class="w-full p-2 rounded bg-input border border-themed"></div><div class="flex-1"><label for="task-due-time" class="block text-sm font-medium text-text-light mb-1">Hora:</label><input type="time" id="task-due-time" value="${isNew ? '' : task.time || ''}" class="w-full p-2 rounded bg-input border border-themed"></div></div>
                            <div><label for="task-labels-input" class="block text-sm font-medium text-text-light mb-1">Etiquetas (separadas por coma):</label><input type="text" id="task-labels-input" value="${isNew ? '' : (task.labels || []).join(', ')}" class="w-full p-2 rounded bg-input border border-themed"></div>
                            <div><label class="flex items-center cursor-pointer"><input type="checkbox" id="task-urgent-checkbox" class="rounded bg-input border-themed" ${isNew ? '' : (task.urgent ? 'checked' : '')}><span class="ml-2 text-sm text-text-light">Marcar como Urgente</span><i class="fas fa-flag text-red-500 ml-2"></i></label></div>
                        </div>`,
                    confirmText: 'Guardar'
                });

                if (result.confirmed) {
                    const newContent = result.data['task-content-edit'];
                    if (newContent.trim()) {
                        const updatedTaskData = {
                            content: newContent.trim(),
                            dueDate: result.data['task-due-date'] || null,
                            time: result.data['task-due-time'] || null,
                            labels: result.data['task-labels-input'].split(',').map(l => l.trim()).filter(Boolean),
                            urgent: result.data['task-urgent-checkbox']
                        };
                        if (isNew) {
                            const column = state.chats[chatId].projectData.columns.find(c => c.id === columnIdForNew);
                            if (column) {
                                if (!column.tasks) column.tasks = [];
                                column.tasks.push({ id: `proj-${crypto.randomUUID()}`, ...updatedTaskData, completed: false });
                                saveState();
                                renderProjectBoard(chatId);
                                completeMission('project-created', chatId); // Complete mission for new project task
                            }
                        } else {
                            updateTaskStatus(taskId, updatedTaskData); // Update existing task
                        }
                    }
                }
            }

            /**
             * Edits an existing personal calendar task or adds a new one.
             * Includes an option to create a new project from a task.
             * @param {string|null} taskId - The ID of the task to edit, or null for a new task.
             * @param {string} [preselectedDate=null] - Pre-selected date for a new task.
             * @param {string} [preselectedTime=null] - Pre-selected time for a new task.
             */
            async function editCalendarTask(taskId, preselectedDate = null, preselectedTime = null) {
                const task = taskId ? findTask(taskId)?.task : null;
                const taskDayKey = taskId ? findTask(taskId)?.dayKey : null;
                const isNew = !task;
                const lang = localStorage.getItem('goatify-lang') || 'es';

                // Function to create a new project from the task
                const createProjectFromTask = async (modalBody) => {
                    const content = modalBody.querySelector('#cal-task-content-edit').value;
                    if (!content.trim()) return;
                    hideModal(); // Hide current modal

                    setTimeout(async () => {
                         const projResult = await showModal({
                            title: 'Crear Nuevo Proyecto',
                            body: `<p>Ingresa un nombre para el nuevo proyecto basado en la tarea "${content.substring(0,30)}...".</p>
                                <input type="text" id="new-proj-name" class="w-full p-2 rounded bg-input border border-themed mt-2" value="${content.split(' ').slice(0,4).join(' ')}">`,
                            confirmText: 'Crear Proyecto'
                        });

                        if(projResult.confirmed && projResult.data['new-proj-name']) {
                            const newProjectId = 'project-' + crypto.randomUUID();
                            state.projects[newProjectId] = { id: newProjectId, title: projResult.data['new-proj-name'], itemIds: [] };
                            state.structure.unshift(newProjectId);

                            const newTaskChatId = createNewChat({title: projResult.data['new-proj-name'], workflow: 'project-management'});
                            state.projects[newProjectId].itemIds.push(newTaskChatId);

                            const taskDataFromModal = {
                                content: content,
                                dueDate: modalBody.querySelector('#cal-task-date').value || null,
                                time: modalBody.querySelector('#cal-task-time').value || null,
                                labels: [], urgent: false, completed: false
                            };
                            const todoColumn = state.chats[newTaskChatId].projectData.columns.find(c => c.id === 'todo');
                            todoColumn.tasks.push({ id: `proj-${crypto.randomUUID()}`, ...taskDataFromModal });

                            await saveState();
                            renderSidebar();
                            selectChat(newTaskChatId);
                            completeMission('project-created', newTaskChatId);
                        }
                    }, 250); // Small delay to allow modal to close
                };

                const result = await showModal({
                    title: isNew ? 'Nueva Tarea Personal' : 'Editar Tarea Personal',
                    body: `
                    <div class="space-y-4">
                        <div><label for="cal-task-content-edit" class="block text-sm font-medium text-text-light mb-1">Contenido:</label><textarea id="cal-task-content-edit" class="w-full p-2 rounded bg-input border border-themed h-24">${isNew ? '' : task.content}</textarea></div>
                        <div class="flex gap-4"><div class="flex-1"><label for="cal-task-date" class="block text-sm font-medium text-text-light mb-1">Fecha:</label><input type="date" id="cal-task-date" value="${isNew ? preselectedDate || '' : taskDayKey}" class="w-full p-2 rounded bg-input border border-themed"></div><div class="flex-1"><label for="cal-task-time" class="block text-sm font-medium text-text-light mb-1">Hora:</label><input type="time" id="cal-task-time" value="${isNew ? preselectedTime || '' : task.time || ''}" class="w-full p-2 rounded bg-input border border-themed"></div></div>
                        ${isNew ? `<div><label class="flex items-center cursor-pointer"><input type="checkbox" id="create-project-checkbox" class="rounded bg-input border-themed"><span class="ml-2 text-sm text-text-light">Crear un nuevo tablero de proyecto con esta tarea</span></label></div>` : ''}
                    </div>`,
                    confirmText: 'Guardar'
                });

                if (result.confirmed) {
                    const newContent = result.data['cal-task-content-edit'];
                    const newDate = result.data['cal-task-date'];

                    if (newContent.trim() && newDate) {
                        if(isNew && result.data['create-project-checkbox']) {
                             // If creating a new project, pass current modal data to the project creation function
                             const tempModalBody = document.createElement('div');
                             tempModalBody.innerHTML = dom.genericModal.querySelector('#modal-body').innerHTML;
                             tempModalBody.querySelector('#cal-task-content-edit').value = newContent;
                             tempModalBody.querySelector('#cal-task-date').value = newDate;
                             tempModalBody.querySelector('#cal-task-time').value = result.data['cal-task-time'];
                             await createProjectFromTask(tempModalBody);
                             return;
                        }

                        const updatedTaskData = {
                            content: newContent.trim(),
                            time: result.data['cal-task-time'] || null,
                            date: newDate
                        };

                        if (isNew) {
                            const newId = `cal-${crypto.randomUUID()}`;
                            const newTask = { id: newId, completed: false, ...updatedTaskData };
                            if (!state.calendar[newDate]) state.calendar[newDate] = [];
                            state.calendar[newDate].push(newTask);
                        } else {
                            updateTaskStatus(taskId, updatedTaskData);
                        }
                        saveState();
                        renderCalendarView();
                        completeMission('week-organized'); // Complete mission for organizing week
                    }
                }
            }

            /**
             * Moves a project task to a different column within the same project.
             * @param {string} chatId - The ID of the project chat.
             * @param {string} taskId - The ID of the task to move.
             * @param {string} targetColumnId - The ID of the target column.
             */
            function moveTask(chatId, taskId, targetColumnId) {
                const found = findTask(taskId);
                // Ensure it's a project task and it's not being moved to its current column
                if (!found || found.type !== 'project' || found.column.id === targetColumnId) return;

                const [taskToMove] = found.column.tasks.splice(found.taskIndex, 1); // Remove task from current column
                taskToMove.completed = targetColumnId === 'done'; // Set completed status if moved to 'done'

                const targetColumn = state.chats[chatId].projectData.columns.find(c => c.id === targetColumnId);
                if (targetColumn) {
                    if (!targetColumn.tasks) targetColumn.tasks = [];
                    targetColumn.tasks.push(taskToMove); // Add task to target column
                }

                saveState(); // Save updated state
                renderProjectBoard(chatId); // Re-render project board
            }

            /**
             * Generates a consistent color for a given label string.
             * @param {string} label - The label string.
             * @returns {string} A hex color string.
             */
            function getLabelColor(label) {
                if (!label) return 'var(--text-medium)';
                if (label === 'Personal') return 'var(--primary)'; // Specific color for 'Personal' label
                if (label === 'default') return 'var(--text-medium)';
                let hash = 0;
                for (let i = 0; i < label.length; i++) {
                    hash = label.charCodeAt(i) + ((hash << 5) - hash);
                }
                let color = '#';
                for (let i = 0; i < 3; i++) {
                    let value = (hash >> (i * 8)) & 0xCF; // Use 0xCF to ensure lighter colors
                    color += ('00' + value.toString(16)).substr(-2);
                }
                return color;
            }

            /**
             * Renders the tag filter dropdown for project tasks.
             * @param {string} chatId - The ID of the project chat.
             */
            function renderTagFilter(chatId) {
                const { projectData } = state.chats[chatId];
                const allTasks = projectData.columns.flatMap(c => c.tasks || []);
                const allTags = [...new Set(allTasks.flatMap(t => t.labels || []))]; // Get unique tags

                dom.tagFilterDropdown.innerHTML = ''; // Clear existing filter options
                const allBtn = document.createElement('button');
                allBtn.className = 'block w-full text-left p-2 hover:bg-medium rounded-md text-sm';
                allBtn.textContent = 'Todas las Etiquetas';
                allBtn.onclick = () => {
                    activeTagFilter = null; // Clear filter
                    dom.tagFilterBtn.innerHTML = `<i class="fas fa-tag mr-1"></i> Filtrar`;
                    dom.tagFilterDropdown.classList.add('hidden');
                    renderProjectBoard(chatId); // Re-render board with no filter
                };
                dom.tagFilterDropdown.appendChild(allBtn);
                allTags.forEach(tag => {
                    const btn = document.createElement('button');
                    btn.className = 'block w-full text-left p-2 hover:bg-medium rounded-md text-sm';
                    btn.innerHTML = `<span class="task-label inline-block mr-2" style="background-color: ${getLabelColor(tag)}; color: white;">${tag}</span>`;
                     btn.onclick = () => {
                        activeTagFilter = tag; // Set active filter
                        dom.tagFilterBtn.innerHTML = `<span class="task-label inline-block mr-2" style="background-color: ${getLabelColor(tag)}; color: white;">${tag}</span>`;
                        dom.tagFilterDropdown.classList.add('hidden');
                         renderProjectBoard(chatId); // Re-render board with filter
                    };
                    dom.tagFilterDropdown.appendChild(btn);
                });
                dom.tagFilterBtn.onclick = () => {
                    dom.tagFilterDropdown.classList.toggle('hidden'); // Toggle dropdown visibility
                };
            }

            /**
             * Renders the Financial Assistant view for a specific financial chat.
             * @param {string} chatId - The ID of the financial chat.
             */
            function renderFinancialAssistant(chatId) {
                const chat = state.chats[chatId];
                if (!chat) return;

                // Build the HTML structure for the financial assistant
                dom.financialAssistantView.innerHTML = `
                     <div id="financial-tools-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                         <div class="finance-summary">
                            <div>
                                <h4>Ingresos Totales</h4>
                                <p id="total-income" class="text-green-400">$0.00</p>
                            </div>
                            <div>
                                <h4>Gastos Totales</h4>
                                <p id="total-expenses" class="text-red-400">$0.00</p>
                            </div>
                            <div>
                                <h4>Balance Neto</h4>
                                <p id="net-balance">$0.00</p>
                            </div>
                        </div>

                        <div id="finance-unified-view" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="finance-section">
                                <div class="finance-section-header">
                                    <h3 class="text-green-400">Ingresos</h3>
                                    <button id="add-income-category-btn" class="text-sm btn-primary p-1 px-2"><i class="fas fa-folder-plus mr-1"></i> Nueva Carpeta</button>
                                </div>
                                <div id="income-categories-list" class="space-y-3"></div>
                            </div>
                            <div class="finance-section">
                                <div class="finance-section-header">
                                    <h3 class="text-red-400">Gastos</h3>
                                    <button id="add-expense-category-btn" class="text-sm btn-primary p-1 px-2"><i class="fas fa-folder-plus mr-1"></i> Nueva Carpeta</button>
                                </div>
                                <div id="expense-categories-list" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                    <div id="financial-chat-container">
                        <div id="financial-chat-header" class="flex justify-between items-center cursor-pointer p-2 border-t md:border-t-0 md:border-b border-themed">
                            <h3 class="text-lg font-semibold text-primary">Asistente Financiero</h3>
                            <button id="financial-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-up"></i></button>
                        </div>
                        <div class="financial-chat-body">
                            <div id="financial-chat-messages" class="chat-bubble-bot"></div>
                            <div id="financial-input-area" class="mt-auto pt-2 p-2">
                                <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                                     <div class="flex items-center space-x-2">
                                        <label for="financial-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1">Modelo:</label>
                                        <div class="model-selector-wrapper">
                                            <select id="financial-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                                 <option value="gpt-3.5-turbo-1106">GOAT X</option>
                                                 <option value="sonar">Búsqueda Web</option>
                                                 <option value="gpt-4o" class="goat-x-pro-model">GOAT X PRO</option>
                                             </select>
                                              <i class="fas fa-chevron-down text-xs"></i>
                                        </div>
                                     </div>
                                </div>
                                <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                    <textarea id="financial-msg" placeholder="Pregúntale a la IA sobre tus finanzas..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm"></textarea>
                                    <button id="financial-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                renderFinancialData(chatId); // Render actual financial data
                attachFinancialListeners(chatId); // Attach event listeners for financial assistant
                if (window.innerWidth < 768) {
                    document.getElementById('financial-chat-container').classList.add('collapsed'); // Collapse chat on mobile
                }

                // Disable GOAT X PRO option for non-logged-in users in financial model selector
                const financialModelSelector = document.getElementById('financial-model-selector');
                if (financialModelSelector) {
                    const goatXProOption = financialModelSelector.querySelector('.goat-x-pro-model');
                    if (goatXProOption) goatXProOption.disabled = !currentUser;
                }

            }

            /**
             * Renders the financial income and expense categories and their items.
             * Recalculates and displays totals.
             * @param {string} chatId - The ID of the financial chat.
             */
            function renderFinancialData(chatId) {
                const chat = state.chats[chatId];
                if (!chat.financialData) {
                    chat.financialData = { incomeCategories: [], expenseCategories: [] };
                }
                const { incomeCategories = [], expenseCategories = [] } = chat.financialData;

                const incomeList = dom.financialAssistantView.querySelector('#income-categories-list');
                const expenseList = dom.financialAssistantView.querySelector('#expense-categories-list');
                if(!incomeList || !expenseList) return;

                // Helper to render a single financial category
                const renderCategory = (category, type) => {
                    const categoryEl = document.createElement('div');
                    categoryEl.className = 'finance-category';
                    categoryEl.dataset.categoryId = category.id;
                    categoryEl.dataset.type = type;
                    const lang = localStorage.getItem('goatify-lang') || 'es';

                    let itemsHTML = (category.items || []).map(item => `
                        <div class="finance-item-row" data-item-id="${item.id}">
                            <input type="text" class="finance-item-input" data-field="description" value="${item.description}" placeholder="Descripción...">
                            <input type="number" class="finance-item-input text-right" data-field="amount" value="${item.amount}" placeholder="0.00">
                            <button class="delete-finance-item-btn text-red-500 p-1"><i class="fas fa-times"></i></button>
                        </div>
                    `).join('');

                    categoryEl.innerHTML = `
                        <div class="finance-category-header">
                            <input type="text" class="finance-category-name-input" value="${category.name}">
                            <div>
                                <button class="add-finance-item-btn text-primary p-1 mr-2" title="Añadir Item"><i class="fas fa-plus-circle"></i></button>
                                <button class="delete-finance-category-btn text-red-500 p-1" title="Eliminar Carpeta"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <div class="finance-category-content">
                            ${itemsHTML}
                        </div>`;
                    return categoryEl;
                };

                // Render income categories
                incomeList.innerHTML = '';
                incomeCategories.forEach(cat => incomeList.appendChild(renderCategory(cat, 'income')));
                if(incomeList.innerHTML === '') incomeList.innerHTML = `<p class="text-xs text-text-medium italic p-2">Crea carpetas para organizar tus ingresos.</p>`;

                // Render expense categories
                expenseList.innerHTML = '';
                expenseCategories.forEach(cat => expenseList.appendChild(renderCategory(cat, 'expense')));
                if(expenseList.innerHTML === '') expenseList.innerHTML = `<p class="text-xs text-text-medium italic p-2">Crea carpetas para organizar tus gastos.</p>`;

                recalculateFinances(chatId); // Recalculate and display totals
            }
            /**
             * Attaches event listeners for the Financial Assistant UI.
             * Handles adding/deleting categories and items, and updating values.
             * @param {string} chatId - The ID of the financial chat.
             */
            function attachFinancialListeners(chatId) {
                const view = dom.financialAssistantView;
                if (!view) return;

                const chat = state.chats[chatId];

                // Setup send button and Enter key for financial chat
                const financialInput = view.querySelector('#financial-msg');
                const financialSendBtn = view.querySelector('#financial-send');
                if (financialSendBtn) {
                    financialSendBtn.addEventListener('click', () => sendMessage(false, null, { assistantType: 'financial' }));
                }
                if (financialInput) {
                    financialInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            sendMessage(false, null, { assistantType: 'financial' });
                        }
                    });
                }

                // Event listener for input changes (category names, item descriptions/amounts)
                view.addEventListener('input', (e) => {
                    if (e.target.classList.contains('finance-category-name-input')) {
                        const catEl = e.target.closest('.finance-category');
                        const catId = catEl.dataset.categoryId;
                        const type = catEl.dataset.type;
                        const category = chat.financialData[`${type}Categories`].find(c => c.id === catId);
                        if (category) {
                            category.name = e.target.value;
                            saveState();
                        }
                    } else if (e.target.classList.contains('finance-item-input')) {
                        const itemRow = e.target.closest('.finance-item-row');
                        const catEl = e.target.closest('.finance-category');
                        const catId = catEl.dataset.categoryId;
                        const itemId = itemRow.dataset.itemId;
                        const type = catEl.dataset.type;
                        const category = chat.financialData[`${type}Categories`].find(c => c.id === catId);
                        const item = category?.items.find(i => i.id === itemId);
                        if (item) {
                           item[e.target.dataset.field] = e.target.type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value;
                           recalculateFinances(chatId); // Recalculate totals on item amount change
                           saveState();
                        }
                    }
                });

                // Event listener for click actions (add/delete items/categories)
                view.addEventListener('click', async (e) => {
                    const chat = state.chats[chatId];
                    if (!chat || !chat.financialData) return;

                    const addItemBtn = e.target.closest('.add-finance-item-btn');
                    if(addItemBtn) {
                        const catEl = addItemBtn.closest('.finance-category');
                        const catId = catEl.dataset.categoryId;
                        const type = catEl.dataset.type;
                        const category = chat.financialData[`${type}Categories`].find(c => c.id === catId);
                        if (category) {
                            if (!category.items) category.items = [];
                            category.items.push({ id: `fin-${crypto.randomUUID()}`, description: '', amount: 0 });
                            renderFinancialData(chatId); // Re-render to show new item
                            saveState();
                        }
                        return;
                    }

                    const deleteItemBtn = e.target.closest('.delete-finance-item-btn');
                    if (deleteItemBtn) {
                        const itemRow = deleteItemBtn.closest('.finance-item-row');
                        const catEl = deleteItemBtn.closest('.finance-category');
                        const catId = catEl.dataset.categoryId;
                        const itemId = itemRow.dataset.itemId;
                        const type = catEl.dataset.type;
                        const category = chat.financialData[`${type}Categories`].find(c => c.id === catId);
                        if (category) {
                            category.items = (category.items || []).filter(i => i.id !== itemId);
                            renderFinancialData(chatId); // Re-render after deletion
                            saveState();
                        }
                        return;
                    }

                    const deleteCategoryBtn = e.target.closest('.delete-finance-category-btn');
                    if (deleteCategoryBtn) {
                        const catEl = deleteCategoryBtn.closest('.finance-category');
                        const catId = catEl.dataset.categoryId;
                        const type = catEl.dataset.type;
                        chat.financialData[`${type}Categories`] = chat.financialData[`${type}Categories`].filter(c => c.id !== catId);
                        renderFinancialData(chatId); // Re-render after deletion
                        saveState();
                        return;
                    }
                });

                // Add category buttons
                view.querySelector('#add-income-category-btn')?.addEventListener('click', () => {
                    const newCategory = { id: `fin-cat-${crypto.randomUUID()}`, name: 'Nueva Carpeta de Ingresos', items: [] };
                    if (!chat.financialData.incomeCategories) chat.financialData.incomeCategories = [];
                    chat.financialData.incomeCategories.push(newCategory);
                    renderFinancialData(chatId);
                    saveState();
                });

                view.querySelector('#add-expense-category-btn')?.addEventListener('click', () => {
                    const newCategory = { id: `fin-cat-${crypto.randomUUID()}`, name: 'Nueva Carpeta de Gastos', items: [] };
                    if (!chat.financialData.expenseCategories) chat.financialData.expenseCategories = [];
                    chat.financialData.expenseCategories.push(newCategory);
                    renderFinancialData(chatId);
                    saveState();
                });

                // Render financial chat messages
                const chatMessagesContainer = view.querySelector('#financial-chat-messages');
                if (chatMessagesContainer) {
                    chatMessagesContainer.innerHTML = '';
                    chat.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, msg.image, index, chatMessagesContainer));
                }
            }

            /**
             * Recalculates and displays the total income, total expenses, and net balance.
             * @param {string} chatId - The ID of the financial chat.
             */
            function recalculateFinances(chatId) {
                const view = dom.financialAssistantView;
                const chat = state.chats[chatId];
                if (!chat || !chat.financialData || !view.querySelector('#total-income')) return;

                // Helper to sum amounts from all items within categories
                const sumItems = (categories) => (categories || [])
                    .flatMap(cat => cat.items || [])
                    .reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

                let totalIncome = sumItems(chat.financialData.incomeCategories);
                let totalExpenses = sumItems(chat.financialData.expenseCategories);

                const netBalance = totalIncome - totalExpenses;

                // Update display elements
                view.querySelector('#total-income').textContent = `$${totalIncome.toFixed(2)}`;
                view.querySelector('#total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
                const netBalanceEl = view.querySelector('#net-balance');
                netBalanceEl.textContent = `$${netBalance.toFixed(2)}`;
                netBalanceEl.style.color = netBalance >= 0 ? '#22c55e' : '#ef4444'; // Color based on positive/negative balance
            }

            /**
             * Checks if the "week-organized" mission is completed.
             * Requires at least one task for each day of the current week.
             * @returns {boolean} True if the mission is completed, false otherwise.
             */
            function checkWeekOrganized() {
                const startOfWeek = dayjs().startOf('isoWeek');
                for (let i = 0; i < 7; i++) {
                    const dayKey = startOfWeek.add(i, 'day').format('YYYY-MM-DD');
                    if (getTasksForDay(dayKey).length === 0) return false; // If any day has no tasks, mission is not complete
                }
                return true;
            }
            /**
             * Checks if the "project-created" mission is completed.
             * Requires a specific number of tasks in a given project.
             * @param {string} chatId - The ID of the project chat.
             * @param {number} taskCount - The minimum number of tasks required.
             * @returns {boolean} True if the mission is completed, false otherwise.
             */
            function checkProjectCreated(chatId, taskCount) {
                const chat = state.chats[chatId];
                if (!chat || !chat.projectData) return false;
                const totalTasks = chat.projectData.columns.reduce((sum, col) => sum + (col.tasks?.length || 0), 0);
                return totalTasks >= taskCount;
            }

            /**
             * Returns the default gamification state.
             * @returns {object} The default gamification state object.
             */
            function getDefaultGamificationState() {
                return {
                    xp: 0,
                     credits: 0,
                    level: 1,
                    dailyStreak: 0,
                    lastLogin: null,
                    completedMissions: [],
                     unlockedAchievements: []
                };
            }

            /**
             * Loads the gamification state from local storage.
             * Initializes with default state if not found.
             * Checks and updates daily streak.
             */
            async function loadGamificationState() {
                if(!currentUser) {
                    gamificationState = getDefaultGamificationState(); // Reset for guests
                    return;
                }
                const key = `gamificationState_${currentUser.id}`;
                const savedState = localStorage.getItem(key);
                gamificationState = savedState ? JSON.parse(savedState) : getDefaultGamificationState();

                // Load reward credits from local storage if they exist (legacy handling)
                const savedRewardCredits = localStorage.getItem(`reward_credits_${currentUser.id}`);
                if (savedRewardCredits !== null) {
                    gamificationState.credits = parseInt(savedRewardCredits, 10);
                }

                await checkDailyStreak(); // Check daily streak on load
            }

            /**
             * Saves the current gamification state to local storage.
             */
            function saveGamificationState() {
                if(!currentUser) return;
                const key = `gamificationState_${currentUser.id}`;
                localStorage.setItem(key, JSON.stringify(gamificationState));
                // Persist reward credits separately as well (for backward compatibility/simplicity)
                localStorage.setItem(`reward_credits_${currentUser.id}`, gamificationState.credits);
                renderGamificationModal(); // Re-render gamification modal
                updateCreditCounter(); // Update credit display
            }

            /**
             * Adds experience points (XP) to the user's gamification state.
             * Handles level-up logic.
             * @param {number} amount - The amount of XP to add.
             */
            function addXp(amount) {
                if(!currentUser) return;
                gamificationState.xp += amount;
                const currentLevel = gamificationState.level;
                if (currentLevel >= LEVEL_NAMES.length) return; // Already at max level

                const nextLevelXp = XP_FOR_LEVEL[currentLevel];
                if (gamificationState.xp >= nextLevelXp) {
                    gamificationState.level++; // Increment level
                    const newLevelName = LEVEL_NAMES[gamificationState.level - 1];
                    // Show level-up modal
                    showModal({
                        title: `<i class="fas fa-sparkles fa-lg text-gold animate-pulse mr-2"></i> ¡Nivel Subido! <i class="fas fa-sparkles fa-lg text-gold animate-pulse ml-2"></i>`,
                        body: `<div class="text-center">
                                <p class="text-lg">¡Felicidades! Has ascendido al</p>
                                <p class="text-3xl font-bold text-primary my-2">Nivel ${gamificationState.level}</p>
                                <p class="text-2xl font-semibold">${newLevelName}</p>
                                <p class="mt-4 text-text-medium">¡Sigue así en tu camino para ser un G.O.A.T.!</p>
                               </div>`,
                        confirmText: '¡Genial!',
                        showCancel: false
                    });
                }
                saveGamificationState(); // Save updated state
            }

            /**
             * Adds reward credits to the user's gamification state.
             * @param {number} amount - The amount of credits to add.
             */
            function addCredits(amount) {
                if(!currentUser) return;
                gamificationState.credits += amount;
                saveGamificationState(); // Save updated state
            }

            /**
             * Checks and updates the user's daily streak.
             * Awards XP and credits based on streak length.
             * Triggers GOAT Chest opening on day 7.
             */
            async function checkDailyStreak() {
                if(!currentUser) {
                    gamificationState = getDefaultGamificationState();
                    return;
                }
                const today = dayjs().format('YYYY-MM-DD');
                const lastLogin = gamificationState.lastLogin;

                if (lastLogin === today) {
                    console.log("Already processed streak for today.");
                    return; // Already processed for today
                }

                const yesterday = dayjs().subtract(1, 'day').format('YYYY-MM-DD');
                if (lastLogin === yesterday) {
                    gamificationState.dailyStreak++; // Increment streak if logged in yesterday
                } else {
                    if (lastLogin !== null) {
                        console.log("Daily streak reset.");
                    }
                    gamificationState.dailyStreak = 1; // Reset streak if not consecutive
                }

                gamificationState.lastLogin = today; // Update last login date
                const streak = gamificationState.dailyStreak;
                let xpReward = 10, creditReward = 5;
                if (streak > 3 && streak <=6) { xpReward = 20; creditReward = 10; } // Increased rewards for longer streaks

                if (streak % 7 === 0 && streak > 0) {
                    addXp(100); // Bonus XP for 7-day streak
                    openGoatChest(); // Open special chest
                } else {
                    addXp(xpReward);
                    addCredits(creditReward);
                }

                if (gamificationState.dailyStreak >= 30) {
                    unlockAchievement('streak-30'); // Unlock achievement for 30-day streak
                }

                saveGamificationState(); // Save updated state
            }

            /**
             * Opens the special "GOAT Chest" awarded on every 7-day streak.
             * Awards random rewards like credits, discounts, or free consultation.
             */
            function openGoatChest() {
                const rand = Math.random();
                let rewardTitle, rewardBody;

                if (rand < 0.01) { // 1% chance for legendary reward
                    rewardTitle = ' recompensa ¡LEGENDARIA!';
                    rewardBody = '¡Increíble! Has ganado una <strong>Asesoría Estratégica de 30 minutos GRATIS</strong> con un experto de Goatify. ¡Nos pondremos en contacto contigo!';
                } else if (rand < 0.1) { // 9% chance for epic reward
                    rewardTitle = ' recompensa ¡ÉPICA!';
                    rewardBody = '¡Genial! Has ganado un <strong>cupón del 25% de descuento</strong> en cualquiera de nuestros servicios.';
                } else if (rand < 0.4) { // 30% chance for rare reward
                    addCredits(150);
                    rewardTitle = ' recompensa RARA!';
                    rewardBody = 'Has ganado <strong>150 Créditos de Recompensa</strong> extra. ¡Sigue así!';
                } else { // 60% chance for common reward
                    addCredits(50);
                    rewardTitle = ' recompensa COMÚN!';
                    rewardBody = 'Has ganado <strong>50 Créditos de Recompensa</strong>. ¡Buen trabajo!';
                }

                showModal({
                    title: `<i class="fas fa-gift text-gold mr-2"></i>¡Cofre GOAT Abierto!`,
                    body: `<p class="text-lg text-center">¡Completaste una racha de 7 días y obtuviste una${rewardTitle}</p><p class="mt-4 text-center">${rewardBody}</p>`,
                    confirmText: '¡Fantástico!',
                     showCancel: false
                });
            }

            /**
             * Completes a specified gamification mission if its conditions are met.
             * Awards XP and credits for completion.
             * @param {string} missionId - The ID of the mission to complete.
             * @param {string|null} [contextId=null] - Optional context ID (e.g., chat ID for project mission).
             */
            function completeMission(missionId, contextId = null) {
                if (!currentUser || gamificationState.completedMissions.includes(missionId)) return; // Already completed or no user
                const mission = MISSIONS[missionId];
                if (!mission) return;

                let isCompleted = false;
                if (mission.condition) {
                    isCompleted = mission.condition(contextId); // Check custom condition
                } else {
                     isCompleted = true; // No specific condition, auto-complete
                }

                if (isCompleted) {
                    gamificationState.completedMissions.push(missionId); // Mark as completed
                    addXp(mission.xp); // Add XP
                    addCredits(mission.credits); // Add credits
                    showModal({
                        title: `<i class="fas fa-check-circle text-green-400 mr-2"></i> Misión Completada`,
                        body: `<p class="text-lg text-center">¡Completaste "${mission.text}"!</p><p class="text-center font-bold mt-2">+${mission.xp} XP | +${mission.credits} Créditos de Recompensa</p>`,
                        confirmText: '¡Vamos!',
                         showCancel: false
                    });
                    saveGamificationState(); // Save updated state
                }
            }

            /**
             * Unlocks a specified gamification achievement if its conditions are met.
             * Awards XP and potential special rewards.
             * @param {string} achievementId - The ID of the achievement to unlock.
             */
            function unlockAchievement(achievementId) {
                if (!currentUser || gamificationState.unlockedAchievements.includes(achievementId)) return; // Already unlocked or no user
                const achievement = ACHIEVEMENTS[achievementId];
                if (!achievement) return;

                gamificationState.unlockedAchievements.push(achievementId); // Mark as unlocked
                addXp(achievement.xp); // Add XP
                if (achievement.credits) addCredits(achievement.credits); // Add credits if specified
                showModal({
                    title: `<i class="fas fa-medal text-gold mr-2"></i> ¡Logro Desbloqueado!`,
                    body: `<p class="text-xl text-center font-bold">${achievement.title}</p><p class="text-center mt-2">${achievement.description}</p><p class="text-center font-bold mt-4">+${achievement.xp} XP ${achievement.reward ? `| ${achievement.reward}` : ''}</p>`,
                    confirmText: '¡Impresionante!',
                     showCancel: false
                });
                saveGamificationState(); // Save updated state
            }

            /**
             * Renders the gamification modal with current level, XP, streak, missions, and achievements.
             */
            function renderGamificationModal() {
                if(!currentUser || !dom.gamificationModal) return;
                const level = gamificationState.level;
                const currentXp = gamificationState.xp;
                const xpForCurrentLevel = XP_FOR_LEVEL[level - 1];
                const xpForNextLevel = XP_FOR_LEVEL[level];
                dom.gamificationLevelName.textContent = `Nivel ${level}: ${LEVEL_NAMES[level - 1]}`;
                dom.gamificationCredits.innerHTML = `<i class="fas fa-coins mr-1"></i>${gamificationState.credits} Créditos`;
                if (level < LEVEL_NAMES.length) {
                    const progress = ((currentXp - xpForCurrentLevel) / (xpForNextLevel - xpForCurrentLevel)) * 100;
                    dom.gamificationXp.textContent = `${currentXp} / ${xpForNextLevel} XP`;
                    dom.gamificationXpBar.style.width = `${Math.min(100, progress)}%`; // Update XP bar width
                } else {
                    dom.gamificationXp.textContent = '¡Nivel Máximo!'; // Max level reached
                    dom.gamificationXpBar.style.width = `100%`;
                }

                // Render daily streak display
                dom.dailyStreakContainer.innerHTML = '';
                for (let i = 1; i <= 7; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'streak-day p-4 rounded-lg flex flex-col items-center justify-center';
                    const isCompleted = i <= gamificationState.dailyStreak; // Check if day in streak is completed
                    const isActive = i === gamificationState.dailyStreak + 1 && dayjs().format('YYYY-MM-DD') !== gamificationState.lastLogin; // Check if next day is active

                    if (isCompleted) dayEl.classList.add('completed');
                    if (isActive) dayEl.classList.add('active');

                    let rewardText;
                    if (i === 7) rewardText = '<i class="fas fa-gift fa-2x"></i>'; // Special icon for day 7
                    else if (i > 3) rewardText = '+20 XP';
                    else rewardText = '+10 XP';

                    dayEl.innerHTML = `
                        <p class="font-bold text-lg">${i === 7 ? '' : `Día ${i}`}</p>
                        <div class="text-2xl my-2">${rewardText}</div>
                        <p class="text-xs">${i === 7 ? 'Cofre GOAT' : (i > 3 ? '+10 Créditos' : '+5 Créditos')}</p>
                    `;
                    dom.dailyStreakContainer.appendChild(dayEl);
                }

                // Render missions display
                dom.missionsContainer.innerHTML = '';
                Object.values(MISSIONS).forEach(mission => {
                    const isCompleted = gamificationState.completedMissions.includes(mission.id);
                    const missionEl = document.createElement('div');
                    missionEl.className = `mission-item p-4 rounded-lg flex items-center justify-between bg-input ${isCompleted ? 'completed' : ''}`;
                     missionEl.innerHTML = `
                        <div>
                            <p class="font-semibold">${mission.text}</p>
                            <p class="text-sm text-text-medium">+${mission.xp} XP | +${mission.credits} Créditos</p>
                         </div>
                        <button class="btn-primary px-4 py-2 rounded-lg text-sm font-bold" data-mission-id="${mission.id}" ${isCompleted ? 'disabled' : ''}>
                            ${isCompleted ? 'Hecho' : 'Empezar'}
                         </button>
                    `;
                    dom.missionsContainer.appendChild(missionEl);
                });

                // Render achievements display
                dom.achievementsContainer.innerHTML = '';
                Object.values(ACHIEVEMENTS).forEach(ach => {
                    const isUnlocked = gamificationState.unlockedAchievements.includes(ach.id);
                    const achEl = document.createElement('div');
                    achEl.className = `achievement-badge p-4 rounded-lg text-center flex flex-col items-center justify-center ${isUnlocked ? 'unlocked' : ''}`;
                     achEl.innerHTML = `
                        <i class="fas ${ach.icon} fa-3x mb-2"></i>
                        <p class="font-bold">${ach.title}</p>
                        <p class="text-xs text-text-medium mt-1">${ach.description}</p>
                     `;
                    dom.achievementsContainer.appendChild(achEl);
                });
            }

            let initFired = false; // Flag to ensure initialization only runs once
            /**
             * Completes the application initialization process.
             * Loads user state, updates UI, sets up services, and handles initial notifications.
             * @param {object|null} user - The Netlify Identity user object, or null if not logged in.
             */
            const finishInitialization = async (user) => {
                // Prevent re-initialization if already fired for the same user
                if (initFired && user?.id === currentUser?.id) return;
                initFired = true;
                const wasGuest = !currentUser; // Check if user was previously a guest
                currentUser = user; // Set the current user

                try {
                    await loadStateForUser(); // Load application state (chats, notes, projects, calendar)
                    updateUserUI(); // Update UI elements based on user login status
                    populateVoiceList(); // Populate text-to-speech voices
                    setupEventListeners(); // Attach all global event listeners

                    // Register Service Worker and subscribe for push notifications if notifications are enabled and user is logged in
                    if (currentUser && notificationsEnabled) {
                         registerServiceWorkerAndSubscribe();
                    }
                    updateContextualFooter(state.chats[currentChatId]?.workflow); // Update initial contextual footer message
                    setupMotivationInterval(); // Start periodic motivation notifications

                    dom.appContainer.classList.remove('opacity-0'); // Fade in the main app container
                    dom.loadingOverlay.style.display = 'none'; // Hide the loading overlay

                    updateNotificationBadge(); // Update the task notification badge

                    // Show motivation modal for new logged-in users
                    if (wasGuest && currentUser) {
                        showMotivationModal();
                    }

                    // Show gamification rules modal for new logged-in users who haven't seen it
                    if (currentUser && !localStorage.getItem('goatify-gamification-rules-seen')) {
                        setTimeout(() => {
                            dom.gamificationRulesModal.classList.remove('hidden');
                            dom.gamificationRulesModal.classList.add('flex');
                            localStorage.setItem('goatify-gamification-rules-seen', 'true'); // Mark as seen
                        }, 2000); // Small delay for better UX
                    }
                } catch (e) {
                    console.error("Error during finishInitialization:", e);
                    // Display a prominent error message on the loading overlay if initialization fails
                    dom.loadingOverlay.innerHTML = `<div class="text-red-500 text-center">Error al cargar la aplicación.<br>Por favor, recarga la página.<br><small>${e.message}</small></div>`;
                }
            };

            // Set initial language and theme based on local storage or system preference
            const savedLang = localStorage.getItem('goatify-lang') || 'es';
            setLanguage(savedLang);
            setTheme(localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches));

            /**
             * Unlocks audio context for web speech API on first user interaction.
             * This is a common requirement in browsers to prevent autoplay issues.
             */
            const unlockAudio = () => {
                const silence = new SpeechSynthesisUtterance('');
                silence.volume = 0; // Play silent utterance
                window.speechSynthesis.speak(silence);
                // Remove listeners after first interaction
                document.body.removeEventListener('touchstart', unlockAudio);
                document.body.removeEventListener('click', unlockAudio);
            };
            document.body.addEventListener('touchstart', unlockAudio, { once: true });
            document.body.addEventListener('click', unlockAudio, { once: true });

            // Netlify Identity widget integration
            if (window.netlifyIdentity) {
                // Initialize on 'init' event
                netlifyIdentity.on('init', (user) => finishInitialization(user));
                // Handle user login
                netlifyIdentity.on('login', (user) => {
                    netlifyIdentity.close(); // Close the identity widget
                    finishInitialization(user); // Finish app initialization
                });
                // Handle user logout
                netlifyIdentity.on('logout', () => {
                    // Clear all local storage related to user data on logout
                    localStorage.removeItem('goatbotState_' + currentUser?.id);
                    localStorage.removeItem('gamificationState_' + currentUser?.id);
                    localStorage.removeItem(`goat_x_pro_usage_${currentUser?.id}_${dayjs().format('YYYY-MM-DD')}`);
                    localStorage.removeItem(`usage_monthly_${currentUser?.id}`);
                    currentUser = null; // Explicitly set currentUser to null
                    resetChatView(); // Reset UI state
                    updateUserUI(); // Update UI elements that depend on user login
                    showInAppNotification("Sesión Cerrada", "Has cerrado sesión correctamente.", 2000);
                });
                // Handle Netlify Identity errors
                netlifyIdentity.on('error', (err) => {
                    console.error("Netlify Identity Error:", err);
                    if (!initFired) finishInitialization(null); // Fallback to guest mode if error during initial init
                });
            } else {
                 console.warn("Netlify Identity widget not found. Proceeding as guest.");
                 finishInitialization(null); // Proceed as guest if widget is not available
            }

            // Fallback for Netlify Identity initialization if 'init' event does not fire within a timeout
            // This ensures the app loads even if Netlify Identity takes too long or fails to fire 'init'.
            setTimeout(() => {
                if (!initFired) {
                    console.warn("Netlify Identity 'init' event did not fire within timeout. Forcing app initialization.");
                    finishInitialization(window.netlifyIdentity ? netlifyIdentity.currentUser() : null);
                 }
            }, 3000); // 3-second timeout

            // Handle browser's back/forward button for chat history navigation
            window.addEventListener('popstate', (event) => {
                if (event.state && event.state.chatId) {
                    selectChat(event.state.chatId); // Select chat from history state
                } else {
                    resetChatView(); // Reset view if no chat ID in state
                }
            });
        }); // End of DOMContentLoaded
            </script>
</body>
</html>
