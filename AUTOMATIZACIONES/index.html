<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#101010">
    <link rel="manifest" href="manifest.json">
    <title>Centro Iberoamericano de Educación - Aula Virtual</title>
    <link rel="icon" type="image/png" href="./Logos HD.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/locale/es.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/plugin/localizedFormat.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/plugin/isoWeek.js"></script>
    
    <style>
        /* * --- INICIO DE LA ADAPTACIÓN DE ESTILO ---
         * Paleta de colores actualizada para el Centro Iberoamericano de Educación.
         * Primario: Rojo Vino (#9B2729)
         * Fondos Oscuros: Tonos de negro/gris oscuro.
         * Fondos Claros: Tonos de blanco/gris claro.
        */
        :root {
            --bg-dark: #121212; /* Negro principal */
            --bg-medium: #1a1a1a;
            --bg-light: #282828;
            --primary: #9B2729; /* Rojo Vino Institucional */
            --primary-hover: #B02E30; /* Rojo Vino más claro para hover */
            --text-light: #f5f5f5;
            --text-medium: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
            --gold-color: #FFD700; /* Se mantiene para elementos de gamificación */
            --urgent-color: #ef4444;
            --danger-color: #dc2626;

            /* Tema Claro */
            --light-bg-dark: #f9f9f9;
            --light-bg-medium: #ffffff;
            --light-bg-light: #f1f1f1;
            --light-primary: #9B2729; /* Rojo Vino también en tema claro */
            --light-primary-hover: #862224;
            --light-text-dark: #1f2937;
            --light-text-medium: #6b7280;
            --light-border-color: rgba(0, 0, 0, 0.09);

            --base-font-size: 15px;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: var(--base-font-size);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .dark-theme {
            --current-bg-dark: var(--bg-dark);
            --current-bg-medium: var(--bg-medium);
            --current-bg-light: var(--bg-light);
            --current-primary: var(--primary);
            --current-primary-hover: var(--primary-hover);
            --current-text-light: var(--text-light);
            --current-text-medium: var(--text-medium);
            --current-border-color: var(--border-color);
            background-color: var(--current-bg-dark);
            color: var(--text-light);
        }

        .light-theme {
            --current-bg-dark: var(--light-bg-dark);
            --current-bg-medium: var(--light-bg-medium);
            --current-bg-light: var(--light-bg-light);
            --current-primary: var(--light-primary);
            --current-primary-hover: var(--light-primary-hover);
            --current-text-light: var(--light-text-dark);
            --current-text-medium: var(--light-text-medium);
            --current-border-color: var(--light-border-color);
            background-color: var(--light-bg-dark);
            color: var(--light-text-dark);
        }
        
        #sidebar { 
            background-color: var(--current-bg-dark); 
            border-right: 1px solid var(--current-border-color); 
            height: 100vh; 
            transition: width 0.3s ease, transform 0.3s ease; 
            z-index: 40; 
            position: relative;
            display: flex; 
            flex-direction: column;
        }
        #sidebar.collapsed { 
            width: 80px;
            padding: 0; 
            overflow: hidden; 
        }
        #sidebar.collapsed > *:not(#sidebar-toggle-arrow, #sidebar-header, #sidebar-bottom-fixed) { 
            display: none; 
        }
        #sidebar.collapsed #sidebar-toggle-arrow {
            display: flex;
            left: unset;
            right: -12px;
            transform: translateY(0%) rotate(180deg); 
            top: 12px;
        }

        #sidebar-toggle-arrow {
            position: absolute;
            top: 12px; 
            right: -12px;
            transform: translateY(0%) rotate(0deg); 
            background-color: var(--current-bg-dark);
            border: 1px solid var(--current-border-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: none; 
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 45;
            transition: transform 0.3s ease, left 0.3s ease, right 0.3s ease, top 0.3s ease;
        }
        #sidebar:not(.collapsed) #sidebar-toggle-arrow {
            right: -12px; 
            transform: translateY(0%) rotate(0deg); 
        }


        #sidebar-header, #sidebar-bottom-fixed {
            flex-shrink: 0;
            padding: 0.75rem;
        }
        #sidebar-header { border-bottom: 1px solid var(--current-border-color); }
        #sidebar-bottom-fixed { border-top: 1px solid var(--current-border-color); }

        #sidebar-scrollable-content {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
        }
        #sidebar-content-main {
            flex-grow: 1;
        }
        #sidebar-footer {
            flex-shrink: 0;
            margin-top: auto;
            padding-top: 1rem;
        }


        @media (max-width: 767px) {
            #sidebar {
                transform: translateX(-100%);
                position: fixed;
                top: 0;
                left: 0;
                width: 288px;
            }
            #sidebar.is-open {
                transform: translateX(0);
            }
            #sidebar, #sidebar > .flex {
                height: 100vh;
                height: -webkit-fill-available;
            }
            body { --base-font-size: 13.5px; }
            button, .btn-primary { 
                padding-top: 0.4rem; padding-bottom: 0.4rem; 
                padding-left: 0.75rem; padding-right: 0.75rem;
                font-size: 0.8rem;
            }
            .text-lg { font-size: 1rem; }
            .text-xl { font-size: 1.1rem; }
            .text-2xl { font-size: 1.2rem; }
            .text-3xl { font-size: 1.4rem; }
            #app-container {
                max-height: calc(100vh - 10px);
            }
             #sidebar.collapsed { 
                width: 0; 
                padding: 0; 
                overflow: hidden; 
                border-right: none;
            }
            #sidebar.collapsed > * { 
                display: none; 
            }
            #sidebar.collapsed #sidebar-toggle-arrow { 
                display: none;
            }
        }


        #main-chat-area, .modal-content { background-color: var(--current-bg-medium); }
        .chat-bubble-bot, .bg-input, #pdf-preview-container, .chat-item, .project-header, #user-menu-popup, #services-menu, .pro-controls-bg { background-color: var(--current-bg-light); }
        .border-themed { border-color: var(--current-border-color); }
        .chat-bubble-user { background-color: var(--current-primary); color: white; }
        .btn-primary { background-color: var(--current-primary); color: white; }
        .btn-primary:hover { background-color: var(--current-primary-hover); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .plan-card-highlight { border-color: var(--current-primary); box-shadow: 0 0 15px rgba(155, 39, 41, 0.3); } /* Sombra roja */
        .placeholder-themed::placeholder { color: var(--current-text-medium); }
        .text-primary, .workflow-header i:not(.workflow-arrow) { color: var(--current-primary) !important; }
        .glowing-mic { animation: pulse 1.5s infinite; color: var(--primary) !important; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(155, 39, 41, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(155, 39, 41, 0); }
            100% { box-shadow: 0 0 0 0 rgba(155, 39, 41, 0); }
        }

        .project .project-content { display: none; }
        .project.open .project-content { display: block; }
        .project.open .project-arrow { transform: rotate(90deg); }
        .project-header.drag-over { background-color: var(--current-primary); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        #app-container { height: 100vh; height: -webkit-fill-available; }
        #pricing-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .chat-item.selected-for-delete { background-color: var(--primary) !important; color: white; }
        
        .model-selector-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .model-selector-wrapper select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
            padding-right: 2.5rem;
            height: 32px;
            font-size: 0.875rem;
            line-height: 1.25rem;
            border: none;
            outline: none;
            cursor: pointer;
            min-width: 120px;
            background-color: transparent;
        }
         .model-selector-wrapper i {
            position: absolute;
            right: 0.5rem;
            pointer-events: none;
        }

        .pro-controls-bg {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.375rem;
            border-radius: 0.5rem;
            overflow: hidden; 
            width: 100%;
            gap: 0.5rem;
        }

        #pro-controls-left, #pro-controls-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        #pro-controls-left {
            flex-grow: 1;
            min-width: 0;
        }

        #pro-controls-right {
            flex-shrink: 0;
        }
        
        .workflow-category.open .workflow-content, .actions-category.open .actions-content { display: block; }
        .workflow-category.open .workflow-arrow, .actions-category.open .actions-arrow { transform: rotate(90deg); }
        .workflow-content, .actions-content { display: none; }
        
        .plan-card { background-color: var(--current-bg-light); }
        #pdf-preview-container { padding: 0.5rem; }
        
        @keyframes sweep {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(200%) skewX(-15deg); }
        }
        .cool-light-effect { position: relative; overflow: hidden; }
        .cool-light-effect::before {
            content: '';
            position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(155, 39, 41, 0.25) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-150%) skewX(-15deg); transition: transform 0.8s ease;
            pointer-events: none;
        }
        .cool-light-effect:hover::before { animation: sweep 2s infinite linear; }

        .input-wrapper { border: 1px solid transparent; transition: box-shadow 0.3s ease, border-color 0.3s ease; }
        .input-wrapper:focus-within { box-shadow: 0 0 10px 0px rgba(155, 39, 41, 0.5); border-color: var(--current-primary-hover); }

        #chat-title {
            color: var(--primary);
            font-weight: 700;
            transition: color 0.3s ease;
        }
        #desktop-chat-title-wrapper:hover #chat-title {
            color: var(--primary-hover);
        }
        
        #desktop-chat-title-wrapper {
            position: relative;
            cursor: pointer;
        }
        #desktop-chat-title-wrapper .edit-icon {
            opacity: 0;
            transition: opacity 0.2s;
            margin-right: 8px;
        }
        #desktop-chat-title-wrapper:hover .edit-icon {
            opacity: 1;
        }
        #mobile-chat-title-wrapper .edit-icon {
            margin-right: 8px;
        }

        .btn-disabled { background-color: #3a3a3a !important; color: #888 !important; cursor: not-allowed !important; border-color: #3a3a3a !important;}

        .chat-item.selected-chat {
            background-color: var(--current-primary);
            color: white !important;
        }
        .chat-item.selected-chat .text-sm {
            color: white !important;
        }
        .light-theme .chat-item {
            color: var(--light-text-dark);
        }

        /* Calendar styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day {
            padding: 2px;
            border-radius: 4px;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            transition: background-color 0.2s ease, border 0.2s ease;
            position: relative;
            border: 2px solid transparent;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .calendar-day-number {
            font-weight: bold;
            font-size: 0.8rem;
            margin: 4px;
            align-self: flex-start;
        }
        .calendar-day-tasks {
            flex-grow: 1;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 0 2px 2px 2px;
        }
        .calendar-day-task {
            font-size: 0.65rem;
            padding: 2px 4px;
            border-radius: 4px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
            position: relative;
        }
        .calendar-day-task .delete-task-icon {
            display: none;
            position: absolute;
            right: 1px;
            top: 1px;
            color: white;
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 14px;
            height: 14px;
            font-size: 8px;
            line-height: 14px;
            text-align: center;
        }
        .calendar-day-task:hover .delete-task-icon {
            display: block;
        }

        .calendar-day:hover {
            background-color: var(--current-bg-light);
        }
        .calendar-day.current-month {
            color: var(--current-text-light);
        }
        .calendar-day.other-month {
            color: var(--current-text-medium);
            opacity: 0.5;
        }
        .calendar-day.today .calendar-day-number {
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 2px;
        }
        .task-dots-container {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
        }
        .task-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-item-completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .notification-bell-icon {
            position: relative;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7em;
            line-height: 1;
            min-width: 18px;
            text-align: center;
        }
        
        .calendar-view-toggle, .project-view-controls {
            display: flex;
            gap: 0.5rem;
            background-color: var(--current-bg-dark);
            padding: 0.25rem;
            border-radius: 8px;
            width: 100%;
        }

        .calendar-view-toggle button, .project-view-controls button {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            font-weight: 600;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
            white-space: nowrap; 
        }
        .calendar-view-toggle button.active, .project-view-controls button.active {
            background-color: var(--current-primary);
            color: white;
            box-shadow: 0 0 8px rgba(155, 39, 41, 0.4);
        }
        .calendar-view-toggle button:hover:not(.active), .project-view-controls button:hover:not(.active) {
            background-color: var(--current-bg-medium);
        }
        .dark-theme .project-view-controls button:not(.active) {
            color: var(--current-text-light);
        }
        .light-theme .project-view-controls button:not(.active) {
            color: var(--current-text-dark);
        }

        #month-view-container, #day-view-container {
            display: block;
        }
        #week-view-container, #day-view-container {
            display: none;
        }
        #week-view-container, #day-view-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--current-border-color);
            border-radius: 8px;
            padding: 10px;
        }
        .week-day-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--current-border-color);
        }
        .week-day-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .week-day-section h5 {
            font-weight: 700;
            color: var(--current-primary);
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .week-day-section .task-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 0;
        }
        
        .day-view-timeline {
            position: relative;
        }
        .day-view-hour {
            display: flex;
            border-top: 1px solid var(--current-border-color);
        }
        .day-view-hour-label {
            width: 60px;
            flex-shrink: 0;
            text-align: right;
            padding-right: 10px;
            font-size: 0.75rem;
            color: var(--current-text-medium);
        }
        .day-view-hour-content {
            flex-grow: 1;
            border-left: 1px solid var(--current-border-color);
            padding: 5px;
            min-height: 40px;
            position: relative;
        }
        .add-task-to-time-btn {
            position: absolute;
            right: 5px;
            top: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .day-view-hour-content:hover .add-task-to-time-btn {
            opacity: 1;
        }

        /* Project, Financial & Notepad View Styles */
        #project-management-view, #financial-assistant-view, #notepad-view-container, #course-view {
            display: flex;
            flex-direction: column; 
            gap: 1rem;
            height: 100%;
            position: relative; 
            flex: 1;
            overflow: hidden;
        }
        
        #project-board-container, #financial-tools-container, #notepad-editor-and-chat-container {
            flex: 1; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0; 
        }
        
        #project-chat-container, #financial-chat-container, #notepad-chat-container {
            display: flex;
            flex-direction: column;
            border-top: 1px solid var(--current-border-color);
            padding-top: 1rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
            background-color: var(--current-bg-medium);
        }
        #project-chat-container.collapsed, #financial-chat-container.collapsed, #notepad-chat-container.collapsed {
            flex-grow: 0;
            flex-basis: auto;
            height: 50px !important;
        }

        #project-chat-container .project-chat-body,
        #financial-chat-container .financial-chat-body,
        #notepad-chat-container .notepad-chat-body {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        #project-chat-container.collapsed .project-chat-body,
        #financial-chat-container.collapsed .financial-chat-body,
        #notepad-chat-container.collapsed .notepad-chat-body {
            display: none;
        }

        #project-chat-toggle i, #financial-chat-toggle i, #notepad-chat-toggle i {
            transition: transform 0.3s ease;
        }
        #project-chat-container:not(.collapsed) #project-chat-toggle i,
        #financial-chat-container:not(.collapsed) #financial-chat-toggle i,
        #notepad-chat-container:not(.collapsed) #notepad-chat-toggle i {
            transform: rotate(180deg);
        }

        #project-chat-messages, #financial-chat-messages, #notepad-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        #kanban-view {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 1rem;
            overflow: hidden; 
            flex-grow: 1;
        }

        .kanban-column {
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-width: 0; 
        }
        .kanban-column-title {
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--current-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-cards {
            flex-grow: 1;
            min-height: 100px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .kanban-card {
            background-color: var(--current-bg-medium);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            border-left: 4px solid var(--current-primary);
            position: relative;
        }
        .kanban-card .delete-task-icon {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
            color: var(--current-text-medium);
            background-color: var(--current-bg-light);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            line-height: 18px;
            text-align: center;
            transition: all 0.2s ease;
        }
        .kanban-card .delete-task-icon:hover {
            background-color: var(--danger-color);
            color: white;
            transform: scale(1.1);
        }
        .kanban-card:hover .delete-task-icon {
            display: block;
        }
        .kanban-card.urgent {
            border-left-color: var(--urgent-color);
        }
        .kanban-card:active {
            cursor: grabbing;
            background-color: var(--primary);
        }
        .kanban-card p {
            font-weight: 500;
            padding-right: 20px; 
        }
        .kanban-card .card-footer {
            font-size: 0.75rem;
            color: var(--current-text-medium);
            margin-top: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-cards.drag-over {
            border: 2px dashed var(--current-primary);
            background-color: rgba(155, 39, 41, 0.1);
        }
        
        /* List View Styles */
        #list-view {
            overflow: hidden;
            flex-grow: 1;
            display: flex; 
            flex-direction: column; 
        }
        .list-view-header {
            display: grid;
            grid-template-columns: 1fr 150px 80px 120px 40px;
            gap: 1rem;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid var(--current-border-color);
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--current-text-medium);
            flex-shrink: 0; 
        }
        .list-view-content {
             overflow-y: auto; 
             flex-grow: 1; 
        }
        .list-view-task {
            display: grid;
            grid-template-columns: 1fr 150px 80px 120px 40px;
            gap: 1rem;
            align-items: center;
            padding: 0.25rem 1rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        .list-view-task input[type="date"], .list-view-task input[type="time"] {
                background: transparent;
                border: none;
                border-radius: 4px;
                padding: 2px 4px;
                font-size: 0.8rem;
                width: auto;
                color: var(--current-text-light);
                color-scheme: dark;
        }
        .light-theme .list-view-task input { color-scheme: light; color: var(--light-text-dark); }
        .list-view-task:hover {
            background-color: var(--current-bg-light);
        }
        .list-view-task.task-item-completed .task-content-list {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .task-content-list.urgent {
            font-weight: 600;
            color: var(--urgent-color);
        }
        .task-content-list input {
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
        }
        .task-content-list input:focus {
             background-color: var(--current-bg-dark);
        }
        .priority-cell {
            text-align: center;
            cursor: pointer;
        }
        
        .task-labels {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .task-label {
            padding: 2px 8px;
            font-size: 0.7rem;
            border-radius: 12px;
            font-weight: 600;
        }
        #project-tag-filter-container {
            position: relative;
        }
        #tag-filter-dropdown {
            position: absolute;
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Gamification Styles */
        #gamification-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .gamification-tabs { border-bottom: 2px solid var(--current-border-color); }
        .gamification-tab { padding: 0.75rem 1rem; font-weight: 600; color: var(--current-text-medium); cursor: pointer; border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; }
        .gamification-tab.active { color: var(--current-primary); border-color: var(--current-primary); }
        .xp-bar-bg { background-color: var(--current-bg-light); }
        .xp-bar-fill { background-color: var(--current-primary); transition: width 0.5s ease-out; }
        .level-badge { background-color: var(--current-primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; }
        .streak-day { background-color: var(--current-bg-light); border: 2px solid var(--current-border-color); transition: all 0.2s ease; }
        .streak-day.active { border-color: var(--current-primary); transform: scale(1.05); box-shadow: 0 0 10px rgba(155, 39, 41, 0.5); }
        .streak-day.completed { background-color: var(--current-primary); color: white; border-color: var(--current-primary); }
        .streak-day .fa-gift { color: var(--gold-color); }
        .mission-item.completed { opacity: 0.5; text-decoration: line-through; }
        .mission-item.completed .btn-primary { background-color: #4CAF50; cursor: default; }
        .achievement-badge { border: 2px solid var(--current-border-color); filter: grayscale(100%); opacity: 0.6; transition: all 0.3s ease; }
        .achievement-badge.unlocked { border-color: var(--gold-color); filter: grayscale(0%); opacity: 1; box-shadow: 0 0 15px var(--gold-color); }
        .achievement-badge.unlocked .fa-medal { color: var(--gold-color); }
        .text-gold { color: var(--gold-color); }

        /* Pricing Modal Enhancements */
        .plan-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .plan-details.open {
            max-height: 500px;
        }
        .plan-feature-list {
            list-style-position: inside;
        }
        .plan-feature-list li {
            padding-left: 1em;
            text-indent: -1em;
        }
        .plan-feature-list .fa-check-circle {
            color: var(--primary);
        }

        /* NEW Financial Assistant Styles */
        #financial-tools-container {
             padding: 1rem;
             gap: 1rem;
             overflow-y: auto;
        }
        .finance-section {
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
        }
        .finance-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        .finance-section-header h3 {
            font-size: 1.125rem;
            font-weight: 700;
        }
        .finance-category {
            margin-top: 1rem;
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
        }
        .finance-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .finance-category-header .finance-category-name-input {
            background: transparent;
            border: none;
            outline: none;
            font-weight: bold;
            width: 70%;
            color: var(--current-text-light);
        }
        .finance-category-content {
            padding: 0.75rem;
        }
        .finance-item-row {
            display: grid;
            grid-template-columns: 1fr 100px 40px;
            gap: 0.75rem;
            align-items: center;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--current-border-color);
        }
        .finance-item-row:last-child {
            border-bottom: none;
        }
        .finance-item-row input {
            background: transparent;
            border: none;
            padding: 0.25rem;
            width: 100%;
            outline: none;
            color: var(--current-text-light);
        }
        .finance-item-row input:focus {
            background-color: var(--current-bg-dark);
            border-radius: 4px;
        }
        .finance-summary {
            background-color: var(--current-bg-light);
            border-radius: 0.5rem;
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            text-align: center;
        }
        .finance-summary h4 {
            font-size: 0.8rem;
            color: var(--current-text-medium);
        }
        .finance-summary p {
            font-size: 1.25rem;
            font-weight: 700;
        }
        #total-income { color: #22c55e; }
        #total-expenses { color: #ef4444; }

        /* Notepad View */
        #notepad-view-container {
            display: none; 
            padding: 0; 
            flex-direction: column; 
        }
        
        #notes-list-panel {
            flex-shrink: 0; 
            padding: 0.5rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        
        #notepad-editor-and-chat-container {
            display: flex;
            flex-direction: row;
            flex-grow: 1;
            gap: 1rem;
            padding: 1rem;
            min-height: 0;
        }
        #notes-list {
            display: none; 
        }
        .note-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background-color: var(--current-bg-medium);
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
            display: block; 
            color: var(--current-text-light); 
            text-decoration: none; 
        }
        .note-item:hover { 
            background-color: var(--current-bg-dark);
            border-left-color: var(--current-primary-hover);
        }
        .note-item.active { 
            background-color: var(--current-primary); 
            color: white !important; 
            font-weight: bold;
            border-left-color: var(--gold-color);
        }
        .note-item.active * {
            color: white !important;
        }
        #note-editor-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        #note-editor-toolbar {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--current-border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            background-color: var(--current-bg-medium);
        }
         #note-editor-toolbar button, .drawing-tool {
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.375rem;
            padding: 0.4rem 0.6rem;
            transition: all 0.2s ease;
        }
         #note-editor-toolbar button:hover, .drawing-tool:hover {
            background-color: var(--current-bg-dark);
            border-color: var(--current-primary);
        }
        #note-editor-toolbar button.active {
            background-color: var(--current-primary);
            color: white;
            border-color: var(--current-primary);
        }
        .drawing-tool[type="color"] {
             padding: 0.2rem;
             min-width: 36px;
             height: 36px;
        }
        #note-title-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            outline: none;
            font-size: 1.1rem; 
            font-weight: bold;
            padding: 0.5rem 0.75rem; 
            border-bottom: 1px solid var(--current-border-color);
        }
        #note-content-area {
            position: relative;
            flex-grow: 1;
        }
        #note-content-editor {
            flex-grow: 1;
            width: 100%;
            height: 100%;
            background-color: transparent;
            color: var(--current-text-light);
            border: none;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            resize: none;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap; 
        }
        #note-content-editor:focus-within {
            box-shadow: none;
        }
        .checklist-item {
            display: flex;
            align-items: flex-start; 
            gap: 0.75rem; 
            margin: 0.5rem 0;
        }
        .checklist-item input[type="checkbox"] {
            width: 1.15em;
            height: 1.15em;
            accent-color: var(--current-primary);
            cursor: pointer;
            flex-shrink: 0; 
            margin-top: 0.2em; 
        }
        .checklist-item-text {
            flex-grow: 1;
            outline: none;
            min-height: 1.15em; 
            padding-top: 0.2em; 
            padding-bottom: 0.2em;
            word-wrap: break-word; 
        }
        .checklist-item-text[data-checked="true"] {
            text-decoration: line-through;
            opacity: 0.6;
        }
        #note-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--light-bg-medium); 
            cursor: crosshair;
            touch-action: none; 
        }
        #notes-list-toggle {
            position: absolute;
            top: 12px; 
            right: -12px; 
            transform: translateY(0%) rotate(0deg); 
            background-color: var(--current-bg-dark);
            border: 1px solid var(--current-border-color);
            border-radius: 50%;
            padding: 4px;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.3s ease;
        }
        #notes-list-panel:not(.collapsed) #notes-list-toggle {
            transform: translateY(0%) rotate(0deg); 
        }
        #notes-list-panel.collapsed #notes-list-toggle {
            transform: translateY(0%) rotate(180deg); 
        }

        /* In-app notification */
        #in-app-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-200%);
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            padding: 1rem;
            border-radius: 0.75rem;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            border: 1px solid var(--current-border-color);
            max-width: 90%;
            width: 400px;
            opacity: 0;
            pointer-events: none;
            cursor: pointer;
        }
        #in-app-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        #in-app-notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        #in-app-notification-header h4 {
            font-weight: bold;
        }

        @keyframes glowing {
            0% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px var(--primary), 0 0 20px var(--primary); }
            50% { text-shadow: 0 0 10px #fff, 0 0 20px var(--primary), 0 0 30px var(--primary), 0 0 40px var(--primary); }
            100% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px var(--primary), 0 0 20px var(--primary); }
        }

        .task-notification-content .glowing-text {
            animation: glowing 1.5s ease-in-out infinite;
        }


        /* Desktop specific styles */
        @media (min-width: 768px) {
            #sidebar-toggle-arrow {
                display: flex;
            }
            #sidebar.collapsed {
                width: 80px;
            }
            #sidebar:not(.collapsed) {
                width: 288px;
            }

            #services-menu {
                opacity: 0;
                visibility: hidden;
                transform: scale(0.95) translateY(-10px);
                transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
            }
            #services-menu.show {
                opacity: 1;
                visibility: visible;
                transform: scale(1) translateY(0);
            }
            #project-management-view, #financial-assistant-view, #course-view {
                display: flex; 
                flex-direction: row; 
            }
             #notepad-editor-and-chat-container {
                flex-direction: row;
            }
            
            #notes-list-toggle {
                display: block; 
            }

            #project-chat-container, #financial-chat-container, #notepad-chat-container {
                display: flex;
                border-left: 1px solid var(--current-border-color);
                border-top: none;
                padding-left: 1rem;
                padding-top: 0;
                height: 100%;
                flex-basis: 40%;
                flex-shrink: 0;
                flex-direction: column;
            }
            #project-chat-container.collapsed, #financial-chat-container.collapsed, #notepad-chat-container.collapsed {
                flex-basis: 50px;
                height: 100% !important;
            }
            #project-chat-container-header, #financial-chat-header, #notepad-chat-header { cursor: pointer; }

            #project-chat-container.collapsed .project-chat-body,
            #project-chat-container.collapsed #project-chat-container-header h3,
            #financial-chat-container.collapsed .financial-chat-body,
            #financial-chat-container.collapsed #financial-chat-header h3,
            #notepad-chat-container.collapsed .notepad-chat-body,
            #notepad-chat-container.collapsed #notepad-chat-header h3 {
                display: none;
            }

            #project-chat-container.collapsed #project-chat-toggle,
            #financial-chat-container.collapsed #financial-chat-toggle,
            #notepad-chat-container.collapsed #notepad-chat-toggle {
                transform: rotate(90deg);
                justify-content: center;
            }
            #project-chat-container.collapsed #project-chat-toggle i,
            #financial-chat-container.collapsed #financial-chat-toggle i,
            #notepad-chat-container.collapsed #notepad-chat-toggle i {
                 transform: rotate(180deg);
            }
        }
        
        /* Mobile specific adjustments */
        @media (max-width: 767px) {
            #mobile-chat-title-wrapper .edit-icon, #mobile-chat-title-wrapper #motivation-btn-mobile {
                display: inline-block;
            }
             #desktop-chat-title-wrapper .edit-icon, #desktop-chat-title-wrapper #motivation-btn-header {
                display: none;
            }
            #calendar-modal {
                padding: 0.5rem;
                max-width: 98vw;
                max-height: 95vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            #calendar-modal > div:not(:first-child) {
                overflow-y: auto;
            }

            .header-left-icons {
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 0;
            }
             .header-left-icons > * {
                padding: 0.3rem; 
            }
            .header-right-icons {
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 0;
            }
            .header-right-icons > * {
                padding: 0.3rem;
            }
            #desktop-chat-title-wrapper { display: none; }
            #main-header-content {
                display: flex;
                align-items: center;
                justify-content: space-between;
                width: 100%;
                gap: 0.5rem;
            }
            #main-header-content > * {
                flex-basis: 33.33%;
            }
            #main-header-content .header-left-icons { justify-content: flex-start; }
            #main-header-content .header-right-icons { justify-content: flex-end; }
            #main-header-content #message-counter-wrapper { text-align: center; }


             #file-preview-area {
                display: none; 
             }
             #image-preview-container {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                max-height: 45px;
                flex-shrink: 1;
            }
            #image-preview {
                max-height: 45px;
                width: auto;
                border-radius: 0.25rem;
            }
            #input-area {
                display: flex;
                flex-direction: column;
            }

            /* Mobile chat containers */
            #project-chat-container, #financial-chat-container, #notepad-chat-container {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 50px;
                overflow: hidden;
                border-top: 1px solid var(--current-border-color);
                z-index: 10;
                transition: height 0.3s ease;
                max-height: calc(100vh - 120px); 
            }
            #project-chat-container:not(.collapsed),
            #financial-chat-container:not(.collapsed),
            #notepad-chat-container:not(.collapsed) {
                 height: 100%;
            }
            #project-chat-container .project-chat-body,
            #financial-chat-container .financial-chat-body,
            #notepad-chat-container .notepad-chat-body {
                height: calc(100% - 50px);
                display: flex;
                flex-direction: column;
            }

            #kanban-view {
                grid-template-columns: repeat(3, 1fr);
                overflow-y: auto;
                overflow-x: hidden;
                gap: 0.4rem; 
                padding-bottom: 50px;
            }
            .kanban-column {
                min-width: 0;
                padding: 0.4rem;
            }
            .kanban-column-title { font-size: 0.7rem; }
            .kanban-card { padding: 0.4rem; }
            .kanban-card p { font-weight: normal; font-size: 0.7rem; }

            #list-view-mobile {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                 padding-bottom: 50px;
                 overflow-y: auto;
                 flex-grow: 1;
            }
            .list-view-task-mobile { background-color: var(--current-bg-light); padding: 0.75rem; border-radius: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
            .list-view-task-mobile-header { display: flex; align-items: flex-start; gap: 0.75rem; }
            .list-view-task-mobile-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--current-border-color); padding-top: 0.5rem; font-size: 0.75rem; }
            .list-view-task-mobile-footer .task-time-date-inputs { display: flex; align-items: center; gap: 4px; }
            .list-view-task-mobile-footer input[type="time"], .list-view-task-mobile-footer input[type="date"] {
                background: var(--current-bg-dark);
                border: none;
                border-radius: 4px;
                padding: 2px 4px;
                font-size: 0.7rem;
                width: auto;
                color-scheme: dark;
            }
            .light-theme .list-view-task-mobile-footer input[type="time"], .light-theme .list-view-task-mobile-footer input[type="date"] {
                 color-scheme: light;
            }

            /* Notepad Mobile Optimization */
            #notepad-view-container {
                flex-direction: column;
                padding: 0;
                height: 100%;
            }
            #notepad-editor-and-chat-container {
                flex-direction: column;
                padding: 0.5rem;
                height: 100%;
                gap: 0.5rem;
            }
            #notepad-view-container.mobile-editor-active #notes-list-panel {
                display: none;
            }
            #notepad-view-container:not(.mobile-editor-active) #notepad-editor-and-chat-container {
                display: none;
            }
            #notes-list-panel {
                width: 100%;
                height: auto; 
                border-radius: 0;
            }
            #note-editor-panel {
                height: 100%;
            }
            #note-back-btn {
                display: inline-block; 
            }
            #notepad-chat-container {
                position: relative;
                height: 50%; 
                max-height: 50%;
            }

            #services-menu {
                position: fixed;
                opacity: 0;
                visibility: hidden;
                transform: scale(0.95) translateY(-10px);
                transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
                width: 90vw;
                max-width: 320px;
                top: 60px;
                right: 10px;
                max-height: calc(100vh - 80px);
                overflow-y: auto;
                z-index: 50;
            }
            #services-menu.show {
                opacity: 1;
                visibility: visible;
                transform: scale(1) translateY(0);
            }
            
            .calendar-view-toggle button { padding: 6px 4px; font-size: 0.75rem; }
            .project-view-controls { width: fit-content; flex-grow: 0; }
            .project-view-controls button { padding: 6px 8px; font-size: 0.75rem; flex-grow: 0; }
            
            #gamification-modal .modal-content { padding: 1rem; }
            #gamification-modal h2 { font-size: 1.25rem; }
            .streak-day .text-lg { font-size: 0.8rem; }
            .streak-day .text-2xl { font-size: 1.1rem; }
            .streak-day .text-xs { font-size: 0.6rem; }
            .mission-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .mission-item .btn-primary { padding: 0.25rem 0.5rem; font-size: 0.75rem; align-self: flex-end; }
            #achievements-container { gap: 0.5rem; }
            .achievement-badge { padding: 0.5rem; font-size: 0.7rem; }
            .achievement-badge .fa-3x { font-size: 1.75em; }

            .chat-item .chat-item-actions {
                opacity: 1 !important;
            }
            #notes-list-panel.collapsed #notes-list-toggle { 
                display: none;
            }
        }
        
        /* Mobile Landscape */
        @media (max-height: 500px) and (orientation: landscape) {
            #sidebar.is-open #sidebar-scrollable-content {
                 overflow-y: auto;
                 height: 100%;
            }
            #main-chat-area, #project-management-view, #financial-assistant-view, #notepad-view-container, #course-view {
                overflow-y: auto;
            }
            #chat-messages {
                padding: 0.5rem;
                flex-grow: 1;
            }
            #kanban-view {
                grid-template-columns: repeat(3, minmax(250px, 1fr));
                overflow-x: auto;
            }
            .modal-content { max-height: 95vh; overflow-y: auto; }
            #input-area { padding: 0.5rem; flex-shrink: 0; }
            .pro-controls-bg { padding: 0.25rem; }
            #msg { height: 3rem !important; max-height: 3rem; }
        }

        /* Motivation Modal Shimmer Effect */
        #motivation-quote.shimmer-text {
            position: relative;
            overflow: hidden;
        }
        #motivation-quote.shimmer-text::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            animation: shimmer 2.5s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes shimmer {
            0% { transform: translateX(-150%) skewX(-15deg); }
            100% { transform: translateX(250%) skewX(-15deg); }
        }

        .dark-theme #message-counter-wrapper span {
            color: white;
        }

        .light-theme #message-counter-wrapper span {
            color: black;
        }
        .speaker-icon {
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 8px;
            display: inline-block;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .speaker-icon:hover {
            opacity: 1;
        }
        .chat-item {
            display: block;
            text-decoration: none;
        }
        .chat-item, a.chat-item:hover {
            color: var(--current-text-light);
        }
        .light-theme .chat-item, .light-theme a.chat-item:hover {
            color: var(--light-text-dark);
        }

    </style>
</head>
<body class="w-screen overflow-x-hidden dark-theme">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script type="text/javascript">
        if (window.netlifyIdentity) {
            netlifyIdentity.init();
        }
    </script>
    <div id="loading-overlay" class="fixed inset-0 bg-bg-dark bg-opacity-95 flex flex-col items-center justify-center z-[100] transition-opacity duration-300">
        <img src="./Logos HD.png" alt="Logo" class="w-24 h-24 object-contain mb-6 animate-pulse" onerror="this.onerror=null;this.src='https://placehold.co/96x96/121212/e0e0e0?text=CIE';">
        <div class="text-text-light text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3 text-lg font-semibold" data-translate-key="initializing">Inicializando Aula Virtual...</p>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden opacity-0 pointer-events-none"></div>

    <div id="app-container" class="flex w-full relative opacity-0 transition-opacity duration-300">
        <aside id="sidebar" class="w-72 flex-shrink-0 flex flex-col transition-transform duration-300 md:translate-x-0 h-full">
            
            <div id="sidebar-header">
                <div id="logo-space" class="w-16 h-16 rounded-lg mx-auto flex-shrink-0 flex items-center justify-center overflow-hidden cursor-pointer">
                    <img src="./Logos HD.png" alt="Logo Institucional" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/64x64/2c2c2c/e0e0e0?text=CIE';">
                </div>
            </div>

            <div class="flex-shrink-0 px-4 pt-2 pb-4 border-b border-themed">
                 <div class="mb-4">
                    <h3 class="text-xs font-semibold uppercase text-text-medium mb-2 px-2" data-translate-key="navigation">Navegación</h3>
                    <div id="sidebar-top-actions" class="space-y-2">
                        <button data-view="my-courses" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                            <i class="fas fa-chalkboard-teacher w-6 mr-2"></i>
                           <span class="text-sm font-bold">Mis Cursos</span>
                       </button>
                       <button data-view="grades" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                            <i class="fas fa-award w-6 mr-2"></i>
                           <span class="text-sm font-bold">Calificaciones</span>
                       </button>
                        <button data-workflow="notepad-app" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                            <i class="fas fa-book w-6 mr-2"></i>
                           <span class="text-sm font-bold">Bloc de Notas</span>
                       </button>
                   </div>
                </div>
            </div>

            <div id="sidebar-scrollable-content">
                <div id="sidebar-content-main" class="flex flex-col">
                    <div class="flex-grow">
                        <div class="mb-4">
                             <div id="workflows-container" class="space-y-1">
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-brain w-6 mr-2"></i>
                                        <span class="text-sm font-bold">Herramientas IA</span>
                                    </div>
                                     <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="decision-lab" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Laboratorio de Decisiones</button>
                                        <button data-workflow="concept-explainer" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Explicador de Conceptos</button>
                                     </div>
                                </div>
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-comments w-6 mr-2"></i>
                                        <span class="text-sm font-bold">Tutor IA</span>
                                     </div>
                                    <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="tutor-ask" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Resolver una Duda</button>
                                        <button data-workflow="tutor-practice" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Practicar para Examen</button>
                                        <button data-workflow="tutor-feedback" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Revisar un Trabajo</button>
                                    </div>
                                </div>
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-language w-6 mr-2"></i>
                                        <span class="text-sm font-bold">Asistente de Idiomas</span>
                                    </div>
                                       <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="english-teacher-translate" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Traducir/Corregir Texto</button>
                                         <button data-workflow="english-teacher-vocabulary" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Aprender Vocabulario</button>
                                     </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="actions-category border-t border-themed pt-4 open">
                            <div class="actions-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                <span class="text-sm font-bold">Acciones Rápidas</span>
                            </div>
                            <div class="actions-content pl-4 pt-2 space-y-2 block">
                                <button id="new-chat-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors w-full"><i class="fas fa-plus mr-2"></i><span data-translate-key="new_query">Nueva Consulta</span></button>
                                <button id="new-folder-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg bg-input w-full"><i class="fas fa-folder-plus mr-2"></i><span data-translate-key="new_folder">Nueva Carpeta</span></button>
                            </div>
                        </div>
    
                        <div class="border-t border-themed pt-2 mt-4">
                             <button id="select-chats-btn" class="w-full text-sm p-2 rounded hover:bg-light flex items-center justify-center">
                                <i class="fas fa-tasks mr-2"></i><span data-translate-key="select_items">Seleccionar Múltiples</span>
                            </button>
                         </div>
                        <div id="delete-mode-controls" class="hidden flex space-x-2 my-2">
                            <button id="delete-selected-btn" class="flex-1 flex items-center justify-center font-semibold p-2 rounded-lg bg-red-600 text-white disabled:opacity-50" disabled><i class="fas fa-trash-alt mr-2"></i><span data-translate-key="delete">Borrar</span></button>
                             <button id="cancel-select-mode-btn" class="p-2 rounded-lg bg-gray-600 text-white"><i class="fas fa-times"></i></button>
                        </div>
                        <div id="folders-container" class="space-y-1 mt-4"></div>
                        <div id="sidebar-content" class="pr-1 space-y-1"></div>
                    </div>
                </div>

                <div id="sidebar-footer">
                    <div class="flex flex-col space-y-2 border-t border-themed pt-4">
                        <div id="upgrade-plan-container" class="hidden text-center p-2 bg-yellow-400 rounded-lg">
                            <button id="upgrade-plan-btn" class="text-xs font-semibold text-black hover:text-gray-800">
                                <i class="fas fa-rocket mr-1"></i>
                               <span data-translate-key="upgrade_plan">Mejorar Plan</span>
                            </button>
                        </div>
                        <div class="text-center p-2 bg-input rounded-lg">
                            <a href="#" id="library-link" class="text-xs font-semibold text-primary hover:underline">
                                <i class="fas fa-book-open mr-1"></i>
                               <span data-translate-key="library">Biblioteca y Recursos</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sidebar-bottom-fixed">
                 <div id="user-section">
                    <div id="login-view" class="hidden">
                        <button id="login-btn" class="w-full flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-sign-in-alt mr-2"></i><span data-translate-key="login">Iniciar Sesión</span></button>
                    </div>
                     <div id="user-menu-view" class="hidden relative">
                        <button id="user-menu-btn" class="w-full flex items-center text-left p-2 rounded-lg hover:bg-light transition-colors">
                            <span id="user-email" class="flex-grow truncate text-sm font-semibold"></span>
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <div id="user-menu-popup" class="absolute bottom-full left-0 w-full mb-2 rounded-lg p-2 border border-themed shadow-lg hidden">
                            <button id="settings-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-cog w-6 mr-2"></i><span data-translate-key="settings">Configuración</span></button>
                             <button id="logout-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-sign-out-alt w-6 mr-2"></i><span data-translate-key="logout">Cerrar Sesión</span></button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="sidebar-toggle-arrow">
                <i class="fas fa-chevron-left"></i> </div>
        </aside>

        <main id="main-chat-area" class="flex-1 flex flex-col h-full overflow-hidden">
            <header class="flex items-center justify-between p-3 md:p-4 border-b border-themed flex-shrink-0 relative">
                <div id="main-header-content" class="flex items-center justify-between w-full">
                    <div class="flex items-center flex-shrink-0 header-left-icons">
                        <button id="menu-toggle" class="md:hidden text-xl p-2"><i class="fas fa-bars"></i></button>
                        <button id="new-chat-icon-btn" title="Nueva Consulta al Tutor" class="text-xl p-1 hover:opacity-80 transition-opacity"><i class="fas fa-plus-circle text-primary"></i></button>
                        <button id="calendar-btn" title="Mi Calendario y Tareas" class="text-sky-400 hover:text-sky-300 p-1 transition-colors notification-bell-icon">
                            <i class="fas fa-calendar-days text-lg"></i>
                            <span id="notification-badge" class="notification-badge hidden">0</span>
                        </button>
                    </div>
                    
                    <div id="desktop-chat-title-wrapper" class="hidden sm:flex items-center justify-center group cursor-pointer mx-2 flex-1 min-w-0" title="Renombrar">
                        <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                        <h1 id="chat-title" class="text-lg font-semibold truncate">Aula Virtual</h1>
                        <button id="motivation-btn-header" title="Motivación Diaria" class="text-yellow-400 hover:text-yellow-300 p-2 transition-colors ml-2"><i class="fas fa-lightbulb text-xl"></i></button>
                    </div>

                    <div class="flex items-center space-x-1 sm:space-x-2 header-right-icons">
                        <div id="message-counter-wrapper" class="flex items-center space-x-2 text-xs font-mono whitespace-nowrap block mx-2 cursor-pointer">
                             <div id="plan-credits-info" class="flex items-center">
                                <i class="fas fa-trophy text-primary mr-1 text-base"></i> <span id="plan-credits-display">0/0</span>
                            </div>
                            <div id="reward-credits-info" class="flex items-center">
                                <i class="fas fa-coins text-gold ml-2 mr-1 text-base"></i> <span id="reward-credits-display">0</span>
                            </div>
                        </div>
                        <button id="services-menu-btn" title="Portal Institucional" class="relative text-xl p-1 hover:opacity-80 transition-opacity flex items-center gap-2">
                            <i class="fas fa-graduation-cap text-primary"></i>
                            <span class="text-sm font-semibold text-primary hidden md:inline" data-translate-key="portal">Portal</span>
                        </button>
                        <button id="theme-toggle" title="Cambiar Tema" class="text-xl p-1"><i class="fas fa-moon" id="theme-icon"></i></button>
                    </div>
                </div>
                 <div id="services-menu" class="absolute top-full right-4 mt-2 w-80 rounded-xl shadow-lg border border-themed z-30 p-4 origin-top-right">
                    <h4 class="font-bold text-lg mb-1 text-text-light" data-translate-key="portal_title">Portal Institucional</h4>
                    <p class="text-sm text-text-medium mb-4" data-translate-key="portal_desc">Accesos directos a los servicios del Centro Iberoamericano de Educación.</p>
                    <ul class="space-y-3">
                        <li><a id="sol-main-site" href="https://www.ibero.education" target="_blank" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Sitio Web Principal</p><p class="text-sm text-text-medium">Visita nuestra página oficial.</p></a></li>
                         <li><a id="sol-admissions" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Admisiones</p><p class="text-sm text-text-medium">Información para nuevos estudiantes.</p></a></li>
                        <li><a id="sol-contact" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Contacto</p><p class="text-sm text-text-medium">Comunícate con nosotros.</p></a></li>
                    </ul>
                </div>
            </header>
            <div class="block sm:hidden text-center py-1.5 border-b border-themed bg-current-bg-dark shadow-sm flex-shrink-0">
                <div id="mobile-chat-title-wrapper" class="flex items-center justify-center group cursor-pointer px-4 relative" title="Renombrar">
                    <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                    <h2 id="mobile-chat-title" class="text-sm font-semibold truncate">Aula Virtual</h2>
                    <button id="motivation-btn-mobile" title="Motivación Diaria" class="text-yellow-400 hover:text-yellow-300 p-2 transition-colors"><i class="fas fa-lightbulb text-lg"></i></button>
                </div>
             </div>
            
            <div id="view-container" class="flex-1 overflow-hidden relative">
                <div id="course-view" class="hidden h-full">
                    <p>Vista del Curso (en construcción)</p>
                </div>

                <div id="chat-messages" class="h-full overflow-y-auto p-3 sm:p-6">
                    <div class="flex justify-center items-center h-full" id="initial-message-container">
                        <div id="welcome-message-wrapper" class="text-center text-text-medium">
                            <img src="./Logos HD.png" alt="Logo Institucional" class="w-24 h-24 object-contain mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=CIE';">
                            <h2 class="text-3xl font-bold text-text-light">Centro Iberoamericano de Educación</h2>
                            <div id="personalized-welcome" class="hidden"><p class="text-lg mt-1"><span data-translate-key="welcome_user">¡Hola, </span><span id="user-name"></span><span data-translate-key="welcome_user_2">! Te damos la bienvenida a tu aula virtual.</span></p></div>
                            <div id="generic-welcome" class="hidden"><p class="text-xl" data-translate-key="welcome_guest">Inicia sesión para acceder a tus cursos.</p></div>
                        </div>
                    </div>
                </div>

                <div id="notepad-view-container" class="hidden">
                    <div id="notes-list-panel">
                        <div id="notes-list-header" class="flex items-center gap-2">
                            <button id="add-new-note-btn" class="w-full btn-primary text-sm flex items-center justify-center gap-2"><i class="fas fa-file-alt"></i>Nueva Nota</button>
                            <button id="add-new-drawing-btn" class="p-2 bg-input rounded-md" title="Nuevo Dibujo"><i class="fas fa-paint-brush"></i></button>
                        </div>
                    </div>
                    <div id="notepad-editor-and-chat-container">
                        <div id="note-editor-panel">
                             <div id="note-editor-toolbar">
                                <button id="note-back-btn" title="Volver a la lista" class="p-2 hidden mr-2"><i class="fas fa-arrow-left"></i></button>
                                <input id="note-title-input" type="text" placeholder="Título de la nota...">
                                <div id="text-tools" class="flex items-center gap-2 ml-auto">
                                    <button id="add-checklist-item-btn" title="Añadir Checklist" class="p-2"><i class="fas fa-check-square"></i></button>
                                </div>
                                <div id="drawing-tools" class="hidden items-center gap-2">
                                    <button id="tool-pencil" class="drawing-tool active" title="Lápiz"><i class="fas fa-pencil-alt"></i></button>
                                    <button id="tool-eraser" class="drawing-tool" title="Borrador"><i class="fas fa-eraser"></i></button>
                                    <input type="color" id="drawing-color" class="drawing-tool" title="Color" value="#000000"> <input type="range" id="drawing-line-width" class="drawing-tool" min="1" max="50" value="3" title="Grosor">
                                    <button id="clear-canvas-btn" class="drawing-tool" title="Limpiar todo"><i class="fas fa-trash-alt"></i></button>
                                </div>
                                <button id="share-note-btn" title="Compartir / Colaborar" class="p-2 ml-2"><i class="fas fa-user-plus"></i></button>
                                <button id="delete-note-btn" title="Eliminar Nota" class="p-2 text-red-500 hover:text-red-400 transition-colors"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <div id="note-content-area" class="relative flex-grow">
                                <div id="note-content-editor" contenteditable="true" class="h-full"></div>
                                <canvas id="note-canvas" class="absolute top-0 left-0 hidden"></canvas>
                            </div>
                        </div>
                        <div id="notepad-chat-container" class="hidden md:flex">
                            <div id="notepad-chat-header" class="flex justify-between items-center cursor-pointer p-2">
                                <h3 class="text-lg font-semibold text-primary">Asistente de Redacción</h3>
                                <button id="notepad-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-up"></i></button>
                            </div>
                            <div class="notepad-chat-body">
                                <div id="notepad-chat-messages" class="chat-bubble-bot"></div>
                                <div class="mt-auto pt-2">
                                    <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                                        <div class="flex items-center space-x-2">
                                           <label for="notepad-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1">Modelo:</label>
                                            <div class="model-selector-wrapper">
                                               <select id="notepad-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                                    <option value="gpt-3.5-turbo-1106">IA General</option>
                                                    <option value="sonar">Búsqueda Web</option>
                                                    <option value="gpt-4o" class="goat-x-pro-model">IA Avanzada</option>
                                                </select>
                                                 <i class="fas fa-chevron-down text-xs"></i>
                                           </div>
                                        </div>
                                   </div>
                                    <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                        <textarea id="notepad-msg" placeholder="Pide ideas, resúmenes, o correcciones..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm"></textarea>
                                        <button id="notepad-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="financial-assistant-view" class="hidden h-full"></div>
                
                <div id="project-management-view" class="hidden p-4 h-full">
                    <div id="project-board-container" class="flex flex-col h-full">
                        <div class="flex flex-wrap justify-between items-center mb-4 flex-shrink-0 gap-2">
                            <h2 id="project-view-title" class="text-2xl font-bold">Proyecto de Clase</h2>
                             <div id="project-tag-filter-container" class="relative">
                                <button id="tag-filter-btn" class="p-2 rounded-md bg-input text-sm"><i class="fas fa-tag mr-1"></i> Filtrar</button>
                                <div id="tag-filter-dropdown" class="hidden absolute right-0 mt-1 p-2 rounded-md shadow-lg w-48"></div>
                             </div>
                        </div>
                         <div class="flex items-center space-x-2 project-view-controls mb-4 flex-shrink-0">
                            <span class="text-sm text-text-medium hidden sm:inline">Vistas:</span>
                             <button id="view-toggle-kanban" class="px-3 py-1 text-sm rounded-md">Kanban</button>
                            <button id="view-toggle-list" class="px-3 py-1 text-sm rounded-md">Lista</button>
                            <button id="add-task-list-view-btn" title="Añadir Tarea" class="hidden ml-auto p-2 rounded-md bg-primary text-white"><i class="fas fa-plus"></i></button>
                            <button id="project-calendar-btn" title="Calendario del Proyecto" class="text-sky-400 hover:text-sky-300 p-2 transition-colors ml-auto"><i class="fas fa-calendar-alt text-xl"></i></button>
                        </div>
                         <div id="kanban-view" class="hidden flex-1">
                            </div>
                        <div id="list-view" class="hidden flex-1 flex-col">
                        </div>
                        <div id="list-view-mobile" class="hidden flex-1 overflow-y-auto">
                        </div>
                    </div>
                    <div id="project-chat-container">
                         <div id="project-chat-container-header" class="flex justify-between items-center cursor-pointer p-2">
                            <h3 class="text-lg font-semibold text-primary">Asistente de Proyecto</h3>
                            <button id="project-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-up"></i></button>
                        </div>
                         <div class="project-chat-body">
                            <div id="project-chat-messages" class="chat-bubble-bot"></div>
                            <div id="project-input-area" class="mt-auto pt-2">
                                 <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                                     <div class="flex items-center space-x-2">
                                        <label for="project-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1">Modelo:</label>
                                         <div class="model-selector-wrapper">
                                            <select id="project-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                                <option value="gpt-3.5-turbo-1106">IA General</option>
                                                <option value="sonar">Búsqueda Web</option>
                                                <option value="gpt-4o" class="goat-x-pro-model">IA Avanzada</option>
                                             </select>
                                              <i class="fas fa-chevron-down text-xs"></i>
                                        </div>
                                     </div>
                                </div>
                                 <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                     <textarea id="project-msg" placeholder="Deja que la IA organice tu proyecto..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm"></textarea>
                                    <button id="project-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="input-area" class="p-2 sm:p-4 border-t border-themed flex-shrink-0">
                <div id="file-preview-area" class="mb-2 space-y-2 px-1 sm:px-0">
                     <div id="image-preview-container" class="hidden relative">
                        <img id="image-preview" src="#" alt="Image Preview">
                        <span id="image-name" class="text-xs text-text-medium truncate flex-grow"></span>
                         <button id="clear-image-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                    <div id="pdf-preview-container" class="hidden relative">
                        <i class="fas fa-file-pdf text-red-500 text-xl"></i>
                         <div class="flex-grow min-w-0">
                            <p id="pdf-name" class="font-medium truncate"></p>
                            <p id="pdf-status" class="text-xxs font-mono"></p>
                         </div>
                        <button id="clear-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                </div>
                <div class="pro-controls-bg rounded-lg p-1 cool-light-effect">
                    <div id="pro-controls-left">
                        <label for="model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1" data-translate-key="model">Modelo IA:</label>
                        <div class="model-selector-wrapper">
                            <select id="model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                <option value="gpt-3.5-turbo-1106" data-translate-key="model_general">IA General</option>
                                <option value="sonar" data-translate-key="model_web">IA con Búsqueda Web</option>
                                <option value="gpt-4o" class="goat-x-pro-model">IA Avanzada</option>
                            </select>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                    <div id="pro-controls-right">
                        <div id="voice-selector-container" class="hidden items-center space-x-2">
                            <label for="voice-selector" class="font-medium text-xs text-text-medium" data-translate-key="voice">Voz:</label>
                            <div class="model-selector-wrapper">
                                <select id="voice-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light w-24"></select>
                            </div>
                        </div>
                        <div id="action-buttons-container" class="flex items-center">
                            <button id="pdf-upload-btn" title="Subir PDF" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-file-pdf text-lg"></i></button>
                            <button id="image-upload-btn" title="Subir Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-image text-lg"></i></button>
                        </div>
                    </div>
                 </div>
                <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                    <input type="file" id="pdf-upload" accept=".pdf,application/pdf" class="hidden"><input type="file" id="image-upload" accept="image/*" class="hidden">
                    <button id="mic-btn" title="Entrada de Voz" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-microphone text-xl"></i></button>
                     <button id="tts-toggle" title="Activar/Desactivar Voz" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-volume-mute text-xl"></i></button>
                    <textarea id="msg" placeholder="Escribe una consulta al Tutor IA o arrastra un archivo..." class="flex-1 bg-transparent p-2 h-12 max-h-32 resize-none outline-none placeholder-themed" rows="1" data-translate-key="placeholder_main"></textarea>
                    <button id="send" title="Enviar" class="p-2 sm:p-4 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i id="send-icon" class="fa fa-paper-plane text-xl"></i></button>
                 </div>
                <div id="contextual-footer" class="text-center text-xs text-text-medium mt-2 px-2 h-4"></div>
            </div>
        </main>
    </div>

    <div id="in-app-notification">
        <div id="in-app-notification-header">
            <h4 id="in-app-notification-title"></h4>
            <button id="in-app-notification-close" class="text-text-medium hover:text-text-light text-2xl leading-none">&times;</button>
        </div>
        <p id="in-app-notification-body"></p>
    </div>

    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <div id="modal-body" class="mb-4 text-text-medium text-sm"></div>
            <div id="modal-buttons-container" class="flex justify-end space-x-2">
                 </div>
        </div>
    </div>

    <div id="motivation-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative text-center">
            <i class="fas fa-lightbulb text-4xl text-yellow-400 mb-4"></i>
            <h3 id="motivation-title" class="text-2xl mb-4">Dosis de Motivación</h3>
            <p id="motivation-quote" class="text-lg text-text-light mb-6 min-h-[50px]"></p>
            <div class="flex items-center justify-center mb-6">
                <label for="motivation-toggle" class="flex items-center cursor-pointer">
                    <span class="mr-3 text-text-light font-medium">
                        Notificaciones periódicas
                    </span>
                    <div class="relative">
                        <input type="checkbox" id="motivation-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                    </div>
                </label>
            </div>
            <button id="close-motivation-modal" class="btn-primary px-6 py-2 rounded-lg">¡Entendido!</button>
        </div>
    </div>
    
    <div id="pricing-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-5xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-6">
                <h2 class="text-3xl md:text-4xl font-extrabold text-center flex-grow" data-translate-key="plans_title">Programas Académicos</h2>
                 <button id="close-pricing-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="modal-content-body flex-grow overflow-y-auto px-2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-text-light">
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">Cursos de Formación</h3>
                        <p class="text-lg text-text-medium my-3">Continúa tu desarrollo profesional</p>
                         <ul class="text-sm space-y-2 mb-4 text-left">
                            <li><i class="fas fa-check-circle mr-2"></i>Certificación al finalizar</li>
                            <li><i class="fas fa-check-circle mr-2"></i>Acceso a material de por vida</li>
                             <li><i class="fas fa-check-circle mr-2"></i>Tutoría especializada</li>
                        </ul>
                        <button class="mt-auto w-full p-3 rounded-lg font-semibold border-2 border-primary text-primary hover:bg-primary hover:text-white transition-colors" data-translate-key="plan_free_cta">Ver Cursos</button>
                     </div>
                    <div class="plan-card border-2 rounded-xl p-6 flex flex-col bg-current-bg-dark plan-card-highlight">
                        <h3 class="text-2xl font-bold">Diplomado en <span class="text-primary">IA Aplicada</span></h3>
                         <p class="text-xl font-extrabold my-3">120 horas</p>
                        <button class="w-full p-2 text-sm rounded-lg font-semibold border border-primary text-primary hover:bg-primary hover:text-white transition-colors mb-4 plan-details-toggle">Ver Detalles</button>
                        <div class="plan-details text-sm text-left">
                             <ul class="space-y-2 mb-4 plan-feature-list">
                                <li><i class="fas fa-check-circle mr-2"></i><strong>Módulo 1:</strong> Fundamentos de IA</li>
                                <li><i class="fas fa-check-circle mr-2"></i><strong>Módulo 2:</strong> Machine Learning</li>
                                 <li><i class="fas fa-check-circle mr-2"></i><strong>Módulo 3:</strong> Proyecto Final</li>
                                <li><i class="fas fa-check-circle mr-2"></i>Doble certificación</li>
                            </ul>
                         </div>
                        <button data-program="diplo-ia" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_boost_cta">Solicitar Información</button>
                    </div>
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">Bachillerato Intensivo</h3>
                        <p class="text-xl font-extrabold my-3">En 10 meses</p>
                         <button class="w-full p-2 text-sm rounded-lg font-semibold border border-primary text-primary hover:bg-primary hover:text-white transition-colors mb-4 plan-details-toggle">Ver Detalles</button>
                        <div class="plan-details text-sm text-left">
                            <ul class="space-y-2 mb-4 plan-feature-list">
                                 <li><i class="fas fa-check-circle mr-2"></i>Título avalado</li>
                                <li><i class="fas fa-check-circle mr-2"></i>Plataforma virtual 24/7</li>
                                <li><i class="fas fa-check-circle text-gold"></i><strong>Inscripciones Abiertas</strong></li>
                                 <li><i class="fas fa-check-circle mr-2"></i>Plan de estudios flexible</li>
                            </ul>
                         </div>
                        <button data-program="bachillerato" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_pro_cta">Inscribirme Ahora</button>
                    </div>
                </div>
             </div>
        </div>
    </div>

    <div id="html-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4"><div class="modal-content rounded-2xl w-full h-full max-w-4xl p-2 md:p-4 relative flex flex-col"><h3 class="text-lg font-bold" data-translate-key="preview">Vista Previa</h3><button id="close-html-preview-modal" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button></div><iframe id="html-preview-iframe" class="w-full flex-grow h-full border-2 border-themed rounded-lg bg-white"></iframe></div>
    
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-lg p-6 relative">
             <h3 class="text-lg font-bold mb-4" data-translate-key="settings">Configuración</h3>
            <div class="space-y-4 text-sm max-h-[70vh] overflow-y-auto pr-2">
                <div>
                    <p class="font-semibold" data-translate-key="settings_email">Correo Electrónico:</p>
                    <p id="settings-user-email" class="text-text-medium"></p>
                 </div>
                <div>
                    <p class="font-semibold" data-translate-key="settings_plan">Mi Programa:</p>
                    <p id="settings-user-plan" class="text-text-medium"></p>
                    <button id="settings-upgrade-plan-btn" class="text-primary hover:underline mt-1 text-xs" data-translate-key="upgrade_plan">Ver Programas</button>
                 </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_fontsize">Tamaño de Letra:</p>
                    <input type="range" id="font-size-slider" min="14" max="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg dark:bg-gray-700">
                    <span id="font-size-value" class="text-xs text-text-medium">16px</span>
                </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_theme">Apariencia:</p>
                    <button id="settings-theme-toggle" class="flex items-center p-2 rounded hover:bg-medium w-full text-left">
                         <i class="fas fa-moon mr-2" id="settings-theme-icon"></i>
                        <span data-translate-key="settings_dark_mode">Modo Oscuro</span>
                    </button>
                </div>
                <div>
                     <div class="flex items-center justify-between">
                        <p class="font-semibold" data-translate-key="settings_notifications">Notificaciones de Entregas:</p>
                        <label for="notifications-toggle" class="inline-flex relative items-center cursor-pointer">
                            <input type="checkbox" id="notifications-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                 </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_lang">Idioma:</p>
                    <select id="language-selector" class="w-full p-2 rounded bg-input border border-themed">
                         <option value="es">Español</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="border-t border-themed pt-4 mt-4">
                     <h4 class="font-semibold mb-2" data-translate-key="settings_integrations">Integraciones</h4>
                     <div class="space-y-2">
                        <button id="connect-google-calendar-btn" class="w-full bg-input p-2 rounded-lg flex items-center justify-start text-left hover:bg-light transition-colors">
                             <i class="fab fa-google mr-3 text-red-500 fa-lg"></i>
                            <div>
                                <span class="font-semibold">Google Calendar</span>
                                 <p class="text-xs text-text-medium">Sincroniza tus fechas de entrega.</p>
                            </div>
                        </button>
                        </div>
                </div>
                <div>
                    <button id="connect-whatsapp-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center mb-2">
                         <i class="fab fa-whatsapp mr-2"></i><span data-translate-key="settings_whatsapp">Contactar a Secretaría</span>
                    </button>
                    <a href="https://calendly.com/goatify" target="_blank" id="schedule-meeting-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar-alt mr-2"></i><span data-translate-key="settings_schedule_meeting">Agendar Reunión Académica</span>
                     </a>
                </div>
            </div>
            <button id="close-settings-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>

    <div id="calendar-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div id="calendar-modal" class="modal-content rounded-lg w-full max-w-4xl p-6 relative">
             <h3 class="text-lg font-bold mb-4" data-translate-key="calendar_my_calendar">Mi Calendario Académico</h3>
            <div class="calendar-view-toggle mb-4">
                <button id="day-view-btn" data-translate-key="calendar_day_view">Vista de Día</button>
                <button id="week-view-btn" data-translate-key="calendar_week_view">Vista de Semana</button>
                <button id="month-view-btn" class="active" data-translate-key="calendar_month_view">Vista de Mes</button>
             </div>

            <div id="day-view-container">
                 <div class="calendar-header">
                    <button id="prev-day" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-day-display" class="text-xl font-semibold"></h4>
                     <button id="next-day" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="day-view-timeline"></div>
            </div>

            <div id="week-view-container">
                <div class="calendar-header">
                     <button id="prev-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-week-range" class="text-xl font-semibold"></h4>
                    <button id="next-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                 <div id="week-days-content"></div>
            </div>

            <div id="month-view-container">
                <div class="calendar-header">
                    <button id="prev-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-month-year" class="text-xl font-semibold"></h4>
                     <button id="next-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid mb-4">
                    <div class="font-bold text-primary" data-translate-key="calendar_mon">Lun</div>
                     <div class="font-bold text-primary" data-translate-key="calendar_tue">Mar</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_wed">Mié</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_thu">Jue</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_fri">Vie</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_sat">Sáb</div>
                     <div class="font-bold text-primary" data-translate-key="calendar_sun">Dom</div>
                </div>
                <div id="calendar-days-grid" class="calendar-grid"></div>
            </div>

            <div class="mt-6 border-t border-themed pt-4">
                <button id="add-task-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i><span data-translate-key="calendar_add_task_btn">Añadir Tarea/Recordatorio</span>
                </button>
            </div>

            <button id="close-calendar-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>
    
    <div id="task-notification-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-[110] p-4">
        <div class="modal-content text-center rounded-lg w-full max-w-md p-8 relative">
            <h3 id="task-notification-title" class="text-2xl font-bold mb-4"></h3>
            <div id="task-notification-body" class="text-lg text-text-light mb-8"></div>
            <button id="task-notification-close-btn" class="btn-primary px-8 py-3 rounded-lg font-semibold">Listo</button>
        </div>
    </div>

    <div id="gamification-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-4">
                <h2 class="text-3xl font-extrabold text-gold">
                    <i class="fas fa-trophy mr-2"></i>Mi Progreso Académico </h2>
                <button id="close-gamification-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>
            
            <div class="p-4 bg-input rounded-lg mb-4 flex-shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <span id="gamification-level-name" class="font-bold text-xl text-text-light">Nivel 1: Estudiante Iniciado</span>
                    <div class="text-right">
                        <span id="gamification-xp" class="font-bold text-primary">0 / 100 XP</span>
                         <p id="gamification-credits" class="text-sm text-gold font-semibold"><i class="fas fa-coins mr-1"></i>0 Puntos</p>
                    </div>
                </div>
                <div class="w-full xp-bar-bg rounded-full h-4">
                    <div id="gamification-xp-bar" class="xp-bar-fill h-4 rounded-full" style="width: 0%;"></div>
                 </div>
            </div>

            <div class="flex-grow overflow-hidden flex flex-col">
                <div class="flex-shrink-0 gamification-tabs flex items-center space-x-2">
                    <button class="gamification-tab active" data-tab="racha">Racha de Estudio</button>
                     <button class="gamification-tab" data-tab="misiones">Objetivos</button>
                    <button class="gamification-tab" data-tab="logros">Logros</button>
                    <button id="gamification-rules-btn" class="ml-auto text-sm text-text-medium hover:text-primary"><i class="fas fa-circle-question mr-1"></i> Cómo funciona</button>
                </div>
                <div class="flex-grow overflow-y-auto pt-4">
                     <div id="gamification-tab-racha" class="gamification-tab-content space-y-4">
                        <p class="text-center text-text-medium">Mantén tu racha de estudio para ganar XP, puntos y recompensas.</p>
                         <div id="daily-streak-container" class="grid grid-cols-7 gap-2 md:gap-4 text-center">
                            </div>
                    </div>
                     <div id="gamification-tab-misiones" class="gamification-tab-content hidden space-y-3">
                        </div>
                     <div id="gamification-tab-logros" class="gamification-tab-content hidden">
                        <div id="achievements-container" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                           </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="gamification-rules-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-[60] p-4">
         <div class="modal-content rounded-lg w-full max-w-2xl p-6 relative">
            <h3 class="text-lg font-bold mb-4 text-gold"><i class="fas fa-scroll mr-2"></i>Reglas de "Mi Progreso Académico"</h3>
            <div class="space-y-4 text-text-medium text-sm max-h-[70vh] overflow-y-auto pr-2">
                <p>¡Te damos la bienvenida a tu ruta de aprendizaje! La idea es simple: cuanto más interactúas con tus cursos y herramientas, más recompensas obtienes para enriquecer tu experiencia.</p>
                <div>
                    <h4 class="font-semibold text-text-light mt-3">1. Puntos de Experiencia (XP) vs. Puntos de Recompensa (🪙)</h4>
                    <p>Existen dos tipos de recompensas:</p>
                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li><strong>Puntos de Experiencia (XP):</strong> Miden tu progreso y avance académico. El XP <strong class="text-primary">nunca se gasta</strong>, solo se acumula para que subas de nivel y desbloquees nuevos títulos.</li>
                        <li><strong>Puntos de Recompensa (🪙):</strong> Son una <strong class="text-gold">reserva de puntos canjeables</strong> que ganas al completar objetivos y rachas. Puedes usarlos para acceder a contenido extra o consultas avanzadas con el Tutor IA.</li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-semibold text-text-light mt-3">2. Cómo Subir de Nivel</h4>
                    <p>Acumula XP para ascender de rango académico. Cada nivel representa una nueva etapa de tu dominio.</p>
                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li>Nivel 1: <strong>Estudiante Iniciado</strong></li>
                        <li>Nivel 2: <strong>Aprendiz Aplicado</strong></li>
                         <li>Nivel 3: <strong>Investigador Junior</strong></li>
                        <li>Nivel 4: <strong>Erudito</strong></li>
                        <li>Nivel 5: <strong>Graduado con Honores</strong></li>
                    </ul>
                </div>
                  <div>
                    <h4 class="font-semibold text-text-light mt-3">3. Cómo Ganar Recompensas</h4>
                     <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li><strong>Racha de Estudio:</strong> Cada día consecutivo que ingresas a la plataforma te da XP y Puntos de Recompensa.</li>
                        <li><strong>Recompensa Semanal (Día 7):</strong> ¡Tu gran premio por 7 días de estudio consecutivo!</li>
                        <li><strong>Objetivos y Logros:</strong> La forma más rápida de ganar bonificaciones de XP y Puntos. Completa tareas específicas para acelerar tu progreso.</li>
                    </ul>
                </div>
                 <p class="font-bold text-center mt-4 text-lg text-primary">¡Cada lección aprendida y tarea completada te acerca a la meta!</p>
            </div>
            <button id="close-gamification-rules-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        //<-- INICIO DEL SCRIPT DE LA APLICACIÓN -->
        window.addEventListener('DOMContentLoaded', () => {
            dayjs.extend(window.dayjs_plugin_localizedFormat);
            dayjs.extend(window.dayjs_plugin_isoWeek);
             
            // Objeto de traducciones adaptado al Aula Virtual
            const translations = {
                es: {
                    initializing: "Inicializando Aula Virtual...", new_query: "Nueva Consulta", new_folder: "Nueva Carpeta",
                    library: "Biblioteca y Recursos",
                    upgrade_plan: "Ver Programas", navigation: "Navegación",
                    my_courses: "Mis Cursos", grades: "Calificaciones", notepad: "Bloc de Notas",
                    ai_tools: "Herramientas IA", decision_lab: "Laboratorio de Decisiones", concept_explainer: "Explicador de Conceptos",
                    ai_tutor: "Tutor IA", tutor_ask: "Resolver una Duda", tutor_practice: "Practicar para Examen", tutor_feedback: "Revisar un Trabajo",
                    language_assistant: "Asistente de Idiomas", wf_eng_1: "Traducir/Corregir Texto", wf_eng_2: "Aprender Vocabulario",
                    select_items: "Seleccionar Múltiples",
                    delete: "Borrar", login: "Iniciar Sesión", settings: "Configuración", logout: "Cerrar Sesión",
                    portal: "Portal", portal_title: "Portal Institucional",
                    portal_desc: "Accesos directos a los servicios del Centro Iberoamericano de Educación.",
                    welcome_user: "¡Hola, ", welcome_user_2: "! Te damos la bienvenida a tu aula virtual.",
                    welcome_guest: "Inicia sesión para acceder a tus cursos.",
                    model: "Modelo IA:", model_general: "IA General", model_web: "IA con Búsqueda Web",
                    voice: "Voz:", placeholder_main: "Escribe una consulta al Tutor IA o arrastra un archivo...",
                    cancel: "Cancelar", confirm: "Confirmar",
                    plans_title: "Programas Académicos",
                    preview: "Vista Previa", settings_email: "Correo Electrónico:", settings_plan: "Mi Programa:",
                    settings_fontsize: "Tamaño de Letra:", settings_theme: "Apariencia:", settings_dark_mode: "Modo Oscuro",
                    settings_lang: "Idioma:", settings_whatsapp: "Contactar a Secretaría", current_plan: "Programa Actual",
                    settings_notifications: "Notificaciones de Entregas:", settings_schedule_meeting: "Agendar Reunión Académica",
                    settings_integrations: "Integraciones",
                    calendar_today: "Hoy", calendar_this_week: "Esta Semana", calendar_mon: "Lun", calendar_tue: "Mar", calendar_wed: "Mié",
                    calendar_thu: "Jue", calendar_fri: "Vie", calendar_sat: "Sáb", calendar_sun: "Dom",
                    calendar_no_tasks: "No hay entregas o eventos para este día.",
                    calendar_add_task_btn: "Añadir Tarea/Recordatorio", calendar_my_calendar: "Mi Calendario Académico",
                    calendar_day_view: "Vista de Día", calendar_month_view: "Vista de Mes", calendar_week_view: "Vista de Semana",
                    notification_task_due: "Recordatorio de entrega: ", notification_title: "Aula Virtual - ¡Tarea Pendiente!",
                    tasks_for: "Tareas para", add_task_for: "Añadir Tarea para",
                    delete_task_confirm_title: "Confirmar Eliminación", delete_task_confirm_body: "¿Estás seguro de que quieres eliminar esta tarea?",
                    delete_btn: "Eliminar",
                },
                en: {
                    initializing: "Initializing Virtual Classroom...", new_query: "New Query", new_folder: "New Folder",
                    library: "Library & Resources",
                    upgrade_plan: "View Programs", navigation: "Navigation",
                    my_courses: "My Courses", grades: "Grades", notepad: "Notepad",
                    ai_tools: "AI Tools", decision_lab: "Decision Lab", concept_explainer: "Concept Explainer",
                    ai_tutor: "AI Tutor", tutor_ask: "Ask a Question", tutor_practice: "Practice for Exam", tutor_feedback: "Review a Paper",
                    language_assistant: "Language Assistant", wf_eng_1: "Translate/Correct Text", wf_eng_2: "Learn Vocabulary",
                    select_items: "Select Multiple",
                    delete: "Delete", login: "Login", settings: "Settings", logout: "Logout",
                    portal: "Portal", portal_title: "Institutional Portal",
                    portal_desc: "Shortcuts to the services of the Centro Iberoamericano de Educación.",
                    welcome_user: "Hello, ", welcome_user_2: "! Welcome to your virtual classroom.",
                    welcome_guest: "Please log in to access your courses.",
                    model: "AI Model:", model_general: "General AI", model_web: "Web-Enhanced AI",
                    voice: "Voice:", placeholder_main: "Ask the AI Tutor a question or drag a file...",
                    cancel: "Cancel", confirm: "Confirm",
                    plans_title: "Academic Programs",
                    preview: "Preview", settings_email: "Email Address:", settings_plan: "My Program:",
                    settings_fontsize: "Font Size:", settings_theme: "Appearance:", settings_dark_mode: "Dark Mode",
                    settings_lang: "Language:", settings_whatsapp: "Contact Administration", current_plan: "Current Program",
                    settings_notifications: "Assignment Notifications:", settings_schedule_meeting: "Schedule Academic Meeting",
                    settings_integrations: "Integrations",
                    calendar_today: "Today", calendar_this_week: "This Week", calendar_mon: "Mon", calendar_tue: "Tue", calendar_wed: "Wed",
                    calendar_thu: "Thu", calendar_fri: "Fri", calendar_sat: "Sat", calendar_sun: "Sun",
                    calendar_no_tasks: "No assignments or events for this day.",
                    calendar_add_task_btn: "Add Task/Reminder", calendar_my_calendar: "My Academic Calendar",
                    calendar_day_view: "Day View", calendar_month_view: "Month View", calendar_week_view: "Week View",
                    notification_task_due: "Assignment Reminder: ", notification_title: "Virtual Classroom - Assignment Due!",
                    tasks_for: "Tasks for", add_task_for: "Add Task for",
                    delete_task_confirm_title: "Confirm Deletion", delete_task_confirm_body: "Are you sure you want to delete this task?",
                    delete_btn: "Delete",
                }
            };
            
            // Sistema de "créditos" reenfocado a "consultas IA"
            const GUEST_CONSULTA_LIMIT = 5;
            const STUDENT_CONSULTA_LIMIT = 50; // Límite mensual para estudiantes
            const PRO_PLAN_CREDIT_LIMIT = 2000; // Se mantiene por si hay un plan "Pro" para profesores o investigadores

            const MOTIVATIONAL_MESSAGES = [
                "El éxito es la suma de pequeños esfuerzos repetidos día tras día. ¡Sigue así!",
                "Cree en ti y todo lo que eres. Eres más fuerte que cualquier obstáculo.",
                "El aprendizaje es un tesoro que seguirá contigo siempre. ¡Descúbrelo!",
                "No te detengas hasta que te sientas orgulloso.",
                "La mejor forma de predecir el futuro es crearlo. ¡Estás en el camino correcto!",
                "Un pequeño progreso cada día se suma a grandes resultados."
            ];
            const MOTIVATION_BUTTON_TEXTS = ["¡Entendido!", "¡Vamos a darle!", "¡A seguir!", "¡Claro que sí!", "¡Adelante!"];

            const COSTS = { 
                GENERAL: 1, 
                SEARCH: 2, 
                WORKFLOW: 2,
                PDF_ANALYSIS: 2,
                IMAGE_ANALYSIS: 2,
                IMAGE_GENERATION: 5,
                GPT4O: 3 
            };
            
            // El estado de la aplicación ahora incluye cursos y usuarios
            let state = { 
                courses: {}, 
                users: {}, 
                chats: {}, 
                projects: {}, 
                structure: [], 
                calendar: {}, 
                notes: [] 
            };

            let gamificationState = {};
            let currentChatId = null, currentUser = null, speechOn = false, availableVoices = [], selectedVoice = null, isRecognizing = false, selectedImageBase64 = null, selectedPdfText = null;
            let currentCourseId = null; // Para saber qué curso se está viendo
            let micWasOnBeforeSpeaking = false;
            let modalResolve = null;
            let modalKeydownHandler = null;
            let isSelectModeActive = false;
            let chatsToDelete = new Set();
            let currentNoteId = null;
            let goatXProUsage = 0; 
            const GOAT_X_PRO_DAILY_LIMIT = 10; 

            let notificationsEnabled = localStorage.getItem('ibero-notifications-enabled') === null ? true : localStorage.getItem('ibero-notifications-enabled') === 'true';
            let motivationEnabled = localStorage.getItem('ibero-motivation-enabled') === null ? true : localStorage.getItem('ibero-motivation-enabled') === 'true';

            let selectedCalendarDate = dayjs();
            let currentCalendarView = 'month';
            let activeTagFilter = null;
            let motivationInterval = null;
            const dom = {};
            
            const fullDom = {
                appContainer: document.getElementById('app-container'),
                msgInput: document.getElementById('msg'), sendBtn: document.getElementById('send'),
                inputArea: document.getElementById('input-area'),
                filePreviewArea: document.getElementById('file-preview-area'),
                messageCounterWrapper: document.getElementById('message-counter-wrapper'), 
                planCreditsInfo: document.getElementById('plan-credits-info'),
                rewardCreditsInfo: document.getElementById('reward-credits-info'),
                upgradePlanContainer: document.getElementById('upgrade-plan-container'),
                upgradePlanBtn: document.getElementById('upgrade-plan-btn'),
                newChatBtn: document.getElementById('new-chat-btn'), newFolderBtn: document.getElementById('new-folder-btn'),
                pricingModal: document.getElementById('pricing-modal'), closePricingModalBtn: document.getElementById('close-pricing-modal'),
                genericModal: document.getElementById('generic-modal'), 
                // Vistas principales
                viewContainer: document.getElementById('view-container'),
                chatMessages: document.getElementById('chat-messages'),
                courseView: document.getElementById('course-view'), // Nueva vista de curso
                notepadViewContainer: document.getElementById('notepad-view-container'),
                projectManagementView: document.getElementById('project-management-view'),
                financialAssistantView: document.getElementById('financial-assistant-view'),
                // Títulos y UI
                chatTitle: document.getElementById('chat-title'), mobileChatTitle: document.getElementById('mobile-chat-title'),
                desktopChatTitleWrapper: document.getElementById('desktop-chat-title-wrapper'), mobileChatTitleWrapper: document.getElementById('mobile-chat-title-wrapper'),
                initialMessageContainer: document.getElementById('initial-message-container'), themeToggle: document.getElementById('theme-toggle'), themeIcon: document.getElementById('theme-icon'),
                micBtn: document.getElementById('mic-btn'), ttsToggle: document.getElementById('tts-toggle'), 
                modelSelector: document.getElementById('model-selector'),
                actionButtonsContainer: document.getElementById('action-buttons-container'),
                imageUploadBtn: document.getElementById('image-upload-btn'), imageUploadInput: document.getElementById('image-upload'),
                imagePreviewContainer: document.getElementById('image-preview-container'), imagePreview: document.getElementById('image-preview'),
                clearImageBtn: document.getElementById('clear-image-btn'), pdfUploadBtn: document.getElementById('pdf-upload-btn'), pdfUploadInput: document.getElementById('pdf-upload'),
                pdfPreviewContainer: document.getElementById('pdf-preview-container'), pdfNameEl: document.getElementById('pdf-name'), pdfStatusEl: document.getElementById('pdf-status'), clearPdfBtn: document.getElementById('clear-pdf-btn'),
                // Sidebar
                sidebar: document.getElementById('sidebar'), menuToggle: document.getElementById('menu-toggle'), sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarContent: document.getElementById('sidebar-content'),
                // User & Login
                loginView: document.getElementById('login-view'), userMenuView: document.getElementById('user-menu-view'),
                loginBtn: document.getElementById('login-btn'), userMenuBtn: document.getElementById('user-menu-btn'), userMenuPopup: document.getElementById('user-menu-popup'), userEmail: document.getElementById('user-email'),
                logoutBtn: document.getElementById('logout-btn'),
                // Workflows y Footer
                workflowsContainer: document.getElementById('workflows-container'),
                libraryLink: document.getElementById('library-link'),
                personalizedWelcome: document.getElementById('personalized-welcome'), genericWelcome: document.getElementById('generic-welcome'), userName: document.getElementById('user-name'),
                // Overlays & Modals
                loadingOverlay: document.getElementById('loading-overlay'), htmlPreviewModal: document.getElementById('html-preview-modal'),
                closeHtmlPreviewModalBtn: document.getElementById('close-html-preview-modal'), htmlPreviewIframe: document.getElementById('html-preview-iframe'),
                // Controles de voz
                voiceSelector: document.getElementById('voice-selector'), 
                voiceSelectorContainer: document.getElementById('voice-selector-container'),
                // Selección múltiple
                selectChatsBtn: document.getElementById('select-chats-btn'), deleteModeControls: document.getElementById('delete-mode-controls'),
                deleteSelectedBtn: document.getElementById('delete-selected-btn'), cancelSelectModeBtn: document.getElementById('cancel-select-mode-btn'),
                // Menú de servicios
                servicesMenuBtn: document.getElementById('services-menu-btn'), servicesMenu: document.getElementById('services-menu'),
                contextualFooter: document.getElementById('contextual-footer'),
                // Iconos Header
                newChatIconBtn: document.getElementById('new-chat-icon-btn'),
                newFolderIconBtn: document.getElementById('new-folder-icon-btn'), 
                // Modal de configuración
                settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'), closeSettingsModal: document.getElementById('close-settings-modal'),
                settingsUserEmail: document.getElementById('settings-user-email'), settingsUserPlan: document.getElementById('settings-user-plan'),
                settingsUpgradePlanBtn: document.getElementById('settings-upgrade-plan-btn'), fontSizeSlider: document.getElementById('font-size-slider'),
                fontSizeValue: document.getElementById('font-size-value'), settingsThemeToggle: document.getElementById('settings-theme-toggle'),
                settingsThemeIcon: document.getElementById('settings-theme-icon'), languageSelector: document.getElementById('language-selector'),
                connectWhatsappBtn: document.getElementById('connect-whatsapp-btn'), scheduleMeetingBtn: document.getElementById('schedule-meeting-btn'),
                notificationsToggle: document.getElementById('notifications-toggle'),
                // Modal de Calendario
                mainChatArea: document.getElementById('main-chat-area'),
                calendarModalOverlay: document.getElementById('calendar-modal-overlay'),
                calendarModal: document.getElementById('calendar-modal'),
                calendarBtn: document.getElementById('calendar-btn'),
                closeCalendarModal: document.getElementById('close-calendar-modal'),
                prevMonthBtn: document.getElementById('prev-month'), nextMonthBtn: document.getElementById('next-month'),
                currentMonthYear: document.getElementById('current-month-year'), calendarDaysGrid: document.getElementById('calendar-days-grid'),
                addTaskBtn: document.getElementById('add-task-btn'),
                notificationBadge: document.getElementById('notification-badge'),
                inAppNotification: document.getElementById('in-app-notification'), 
                inAppNotificationTitle: document.getElementById('in-app-notification-title'),
                inAppNotificationBody: document.getElementById('in-app-notification-body'),
                inAppNotificationClose: document.getElementById('in-app-notification-close'),
                taskNotificationModal: document.getElementById('task-notification-modal'),
                taskNotificationTitle: document.getElementById('task-notification-title'),
                taskNotificationBody: document.getElementById('task-notification-body'),
                taskNotificationCloseBtn: document.getElementById('task-notification-close-btn'),
                monthViewContainer: document.getElementById('month-view-container'), weekViewContainer: document.getElementById('week-view-container'),
                dayViewContainer: document.getElementById('day-view-container'),
                monthViewBtn: document.getElementById('month-view-btn'), weekViewBtn: document.getElementById('week-view-btn'), dayViewBtn: document.getElementById('day-view-btn'),
                prevWeekBtn: document.getElementById('prev-week'), nextWeekBtn: document.getElementById('next-week'),
                currentWeekRange: document.getElementById('current-week-range'), weekDaysContent: document.getElementById('week-days-content'),
                prevDayBtn: document.getElementById('prev-day'), nextDayBtn: document.getElementById('next-day'),
                currentDayDisplay: document.getElementById('current-day-display'), dayViewTimeline: document.getElementById('day-view-timeline'),
                // Vista de Proyecto
                projectBoardContainer: document.getElementById('project-board-container'),
                projectChatContainer: document.getElementById('project-chat-container'),
                projectChatToggle: document.getElementById('project-chat-toggle'),
                projectChatHeader: document.getElementById('project-chat-container-header'),
                projectViewTitle: document.getElementById('project-view-title'),
                kanbanView: document.getElementById('kanban-view'),
                listView: document.getElementById('list-view'),
                listViewMobile: document.getElementById('list-view-mobile'),
                viewToggleKanban: document.getElementById('view-toggle-kanban'),
                viewToggleList: document.getElementById('view-toggle-list'),
                addTaskListViewBtn: document.getElementById('add-task-list-view-btn'),
                projectChatMessages: document.getElementById('project-chat-messages'),
                projectMsgInput: document.getElementById('project-msg'),
                projectSendBtn: document.getElementById('project-send'),
                projectCalendarBtn: document.getElementById('project-calendar-btn'),
                tagFilterBtn: document.getElementById('tag-filter-btn'),
                tagFilterDropdown: document.getElementById('tag-filter-dropdown'),
                // Gamificación
                gamificationModal: document.getElementById('gamification-modal'),
                closeGamificationModal: document.getElementById('close-gamification-modal'),
                gamificationLevelName: document.getElementById('gamification-level-name'),
                gamificationXp: document.getElementById('gamification-xp'),
                gamificationCredits: document.getElementById('gamification-credits'),
                gamificationXpBar: document.getElementById('gamification-xp-bar'),
                dailyStreakContainer: document.getElementById('daily-streak-container'),
                missionsContainer: document.getElementById('gamification-tab-misiones'),
                achievementsContainer: document.getElementById('achievements-container'),
                gamificationRulesBtn: document.getElementById('gamification-rules-btn'),
                gamificationRulesModal: document.getElementById('gamification-rules-modal'),
                closeGamificationRulesModal: document.getElementById('close-gamification-rules-modal'),
                // Motivación
                motivationBtnHeader: document.getElementById('motivation-btn-header'),
                motivationBtnMobile: document.getElementById('motivation-btn-mobile'),
                motivationModal: document.getElementById('motivation-modal'),
                motivationTitle: document.getElementById('motivation-title'),
                motivationQuote: document.getElementById('motivation-quote'),
                motivationToggle: document.getElementById('motivation-toggle'),
                closeMotivationModal: document.getElementById('close-motivation-modal'),
                // Varios
                sidebarToggleArrow: document.getElementById('sidebar-toggle-arrow'),
                foldersContainer: document.getElementById('folders-container'),
                planCreditsDisplay: document.getElementById('plan-credits-display'),
                rewardCreditsDisplay: document.getElementById('reward-credits-display'),
            };
            Object.assign(dom, fullDom);

            // Niveles de Gamificación adaptados a un contexto académico
            const XP_FOR_LEVEL = [0, 250, 750, 2000, 5000, Infinity]; 
            const LEVEL_NAMES = ["Estudiante Iniciado", "Aprendiz Aplicado", "Investigador Junior", "Erudito", "Graduado con Honores"];
            
            // Misiones y logros adaptados
            const MISSIONS = {
                'first-class': { id: 'first-class', text: 'Accede a tu primera clase', xp: 20, credits: 5 },
                'first-assignment': { id: 'first-assignment', text: 'Entrega tu primera tarea', xp: 50, credits: 15 },
                'week-organized': { id: 'week-organized', text: 'Organiza tu semana en el calendario', xp: 75, credits: 25, condition: checkWeekOrganized },
                'project-created': { id: 'project-created', text: 'Crea un proyecto de estudio y añade 3 tareas', xp: 100, credits: 30, condition: (chatId) => checkProjectCreated(chatId, 3) },
                'tutor-practice': { id: 'tutor-practice', text: 'Practica para un examen con el Tutor IA', xp: 40, credits: 10, workflow: 'tutor-practice' },
            };
            const ACHIEVEMENTS = {
                'streak-30': { id: 'streak-30', title: 'Consistencia', description: 'Mantén la racha de estudio por 30 días.', icon: 'fa-calendar-check', xp: 500, credits: 250 },
                'project-master': { id: 'project-master', title: 'Maestro de Proyectos', description: 'Completa 5 proyectos de estudio.', icon: 'fa-sitemap', xp: 750, credits: 0, reward: 'Consulta avanzada con Tutor IA' },
                'top-student': { id: 'top-student', title: 'Estudiante Destacado', description: 'Obtén una calificación perfecta en una tarea.', icon: 'fa-star', xp: 500, credits: 50 },
            };

            function setLanguage(lang) {
                const translationData = translations[lang];
                if (!translationData) return;
                dayjs.locale(lang);
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    if (translationData[key]) {
                        if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') {
                             if(el.placeholder) el.placeholder = translationData[key];
                        } else {
                             const icon = el.querySelector('i');
                            if (icon && el.childNodes.length > 1 && !el.classList.contains('notification-bell-icon') && !el.classList.contains('workflow-header')) {
                                const textNode = document.createTextNode(' ' + translationData[key]);
                                el.innerHTML = '';
                                el.appendChild(icon);
                                el.appendChild(textNode);
                             } else {
                                el.textContent = translationData[key];
                            }
                        }
                     }
                });
                document.documentElement.lang = lang;
                localStorage.setItem('ibero-lang', lang);
                renderCalendarView();
                renderSidebar();
            }
            
            function updateContextualFooter(viewKey) {
                if (!dom.contextualFooter) return;
                const viewTexts = {
                    'my-courses': 'Selecciona un curso para ver los módulos y tareas.',
                    'grades': 'Aquí se mostrará un resumen de tus calificaciones.',
                    'tutor-ask': 'Modo Tutor IA: Formula tu pregunta y te ayudaré a resolverla.',
                    'tutor-practice': 'Modo Práctica: Dime sobre qué tema quieres practicar y generaré preguntas.',
                    'tutor-feedback': 'Modo Revisión: Pega el texto de tu trabajo para recibir retroalimentación.',
                    'notepad-app': 'Bloc de Notas: Organiza tus ideas. Todo se guarda automáticamente.',
                };
                const currentChat = state.chats[currentChatId];
                const key = viewKey || (currentChat ? currentChat.workflow : null);
                dom.contextualFooter.textContent = viewTexts[key] || 'Aula Virtual del Centro Iberoamericano de Educación.';
            }

            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            function showModal({ title, body, confirmText = 'Confirmar', cancelText = 'Cancelar', showCancel = true, showConfirm = true, extraButtons = [], dangerConfirm = false }) {
                const modalTitle = dom.genericModal.querySelector('#modal-title');
                const modalBody = dom.genericModal.querySelector('#modal-body');
                const modalButtonsContainer = dom.genericModal.querySelector('#modal-buttons-container');
                
                modalTitle.innerHTML = title; 
                modalBody.innerHTML = body;
                
                let buttonsHTML = '';
                extraButtons.forEach(btn => {
                    buttonsHTML += `<button id="${btn.id}" class="${btn.classes || 'px-4 py-2 rounded bg-gray-500 text-white'}">${btn.text}</button>`;
                });
                if (showCancel) {
                    buttonsHTML += `<button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded">${cancelText}</button>`;
                }
                if (showConfirm) {
                    const confirmClasses = dangerConfirm ? 'btn-danger' : 'btn-primary';
                    buttonsHTML += `<button id="modal-confirm" class="px-4 py-2 rounded text-white ${confirmClasses}">${confirmText}</button>`;
                }
                modalButtonsContainer.innerHTML = buttonsHTML;

                if (showConfirm) {
                    dom.genericModal.querySelector('#modal-confirm').addEventListener('click', () => {
                        const inputs = modalBody.querySelectorAll('input, textarea, select');
                        const data = {};
                        inputs.forEach(input => {
                            data[input.id] = input.type === 'checkbox' ? input.checked : input.value;
                        });
                        hideModal({ confirmed: true, data });
                    }, { once: true });
                }

                if (showCancel) {
                    dom.genericModal.querySelector('#modal-cancel').addEventListener('click', () => hideModal({ confirmed: false }), { once: true });
                }
                extraButtons.forEach(btn => {
                    dom.genericModal.querySelector(`#${btn.id}`).addEventListener('click', (e) => {
                         btn.action(e, modalBody);
                    });
                });
                
                const confirmButton = dom.genericModal.querySelector('#modal-confirm');
                modalKeydownHandler = (e) => {
                    if (e.key === 'Enter') {
                        if (e.target.tagName !== 'TEXTAREA') {
                            e.preventDefault();
                            if (confirmButton) {
                                confirmButton.click();
                            }
                        }
                    }
                };
                document.addEventListener('keydown', modalKeydownHandler);

                dom.genericModal.classList.remove('hidden');
                dom.genericModal.classList.add('flex');
                
                return new Promise(resolve => { modalResolve = resolve; });
            }

            function hideModal(resolveWith = null) { 
                if (modalKeydownHandler) {
                    document.removeEventListener('keydown', modalKeydownHandler);
                    modalKeydownHandler = null;
                }
                if(modalResolve) { 
                    modalResolve(resolveWith); 
                    modalResolve = null; 
                } 
                dom.genericModal.classList.add('hidden'); 
                dom.genericModal.classList.remove('flex');  
            }
            
            // Renombrada de showPricingModal a showProgramsModal
            function showProgramsModal() { 
                dom.pricingModal.classList.remove('hidden');
                dom.pricingModal.classList.add('flex'); 
                setTimeout(() => { dom.pricingModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
            }

            function hideProgramsModal() { 
                dom.pricingModal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => { dom.pricingModal.classList.add('hidden'); dom.pricingModal.classList.remove('flex'); }, 300); 
            }

            function showSettingsModal() {
                dom.settingsModal.classList.remove('hidden');
                dom.settingsModal.classList.add('flex');
                if (currentUser) {
                    dom.settingsUserEmail.textContent = currentUser.email;
                    // Lógica para mostrar el programa o rol del usuario
                    const userRole = currentUser.app_metadata?.role || 'student';
                    const userProgram = currentUser.app_metadata?.program || 'No inscrito';
                    dom.settingsUserPlan.textContent = `${userProgram} (${userRole})`;
                    dom.settingsUpgradePlanBtn.classList.remove('hidden');
                } else {
                    dom.settingsUserEmail.textContent = 'No ha iniciado sesión';
                    dom.settingsUserPlan.textContent = 'Invitado';
                    dom.settingsUpgradePlanBtn.classList.remove('hidden');
                }
                dom.fontSizeSlider.value = parseInt(getComputedStyle(document.body).getPropertyValue('--base-font-size')) || 16;
                dom.fontSizeValue.textContent = `${dom.fontSizeSlider.value}px`;
                dom.settingsThemeIcon.className = `fas fa-${document.body.classList.contains('dark-theme') ? 'sun' : 'moon'}`;
                dom.languageSelector.value = localStorage.getItem('ibero-lang') || 'es';
                dom.notificationsToggle.checked = notificationsEnabled;
            }

            function hideSettingsModal() {
                dom.settingsModal.classList.add('hidden');
                dom.settingsModal.classList.remove('flex');
            }

            function showInAppNotification(title, body, duration = 666) { 
                dom.inAppNotificationTitle.innerHTML = title;
                dom.inAppNotificationBody.innerHTML = body;
                dom.inAppNotification.classList.add('show');
            
                let timer;
            
                const closeNotification = (event) => {
                    if (event && event.target.closest('button, a')) {
                        return;
                    }
                    if(timer) clearTimeout(timer);
                    dom.inAppNotification.classList.remove('show');
                    dom.inAppNotification.removeEventListener('click', closeNotification);
                    dom.inAppNotificationClose.removeEventListener('click', closeFromX);
                };
            
                const closeFromX = (event) => {
                    event.stopPropagation();
                    closeNotification();
                };

                dom.inAppNotification.addEventListener('click', closeNotification, { once: true });
                dom.inAppNotificationClose.addEventListener('click', closeFromX, { once: true });
            
                if(duration) {
                    timer = setTimeout(closeNotification, duration);
                }
            }

            function showTaskNotification(title, body) {
                dom.taskNotificationModal.classList.remove('hidden');
                dom.taskNotificationModal.classList.add('flex');
                dom.taskNotificationTitle.textContent = title;
                
                const glowingBody = body.replace(/(Recordatorio de entrega:.*)/, '<span class="glowing-text">$1</span>');
                dom.taskNotificationBody.innerHTML = glowingBody;
            }

            function hideTaskNotification() {
                dom.taskNotificationModal.classList.add('hidden');
                dom.taskNotificationModal.classList.remove('flex');
            }

            function showCalendarModal() {
                dom.calendarModalOverlay.classList.remove('hidden');
                dom.calendarModalOverlay.classList.add('flex');
                if (!currentCalendarView) currentCalendarView = 'month'; 
                renderCalendarView();
            }
        
            function hideCalendarModal() {
                dom.calendarModalOverlay.classList.add('hidden');
                dom.calendarModalOverlay.classList.remove('flex');
            }

            function renderMonthView() {
                dom.calendarDaysGrid.innerHTML = '';
                dom.currentMonthYear.textContent = selectedCalendarDate.format('MMMM YYYY');
                const startDay = selectedCalendarDate.startOf('month').startOf('isoWeek');

                for (let i = 0; i < 42; i++) {
                    const day = startDay.add(i, 'day');
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.dataset.date = day.format('YYYY-MM-DD');

                    dayEl.innerHTML = `<span class="calendar-day-number">${day.date()}</span><div class="calendar-day-tasks"></div>`;

                    if (day.month() === selectedCalendarDate.month()) {
                        dayEl.classList.add('current-month');
                    } else {
                        dayEl.classList.add('other-month');
                    }
                    if (day.isSame(dayjs(), 'day')) {
                        dayEl.classList.add('today');
                    }

                    const tasksContainer = dayEl.querySelector('.calendar-day-tasks');
                    const tasksForDay = getTasksForDay(day.format('YYYY-MM-DD'));
                    tasksForDay.slice(0, 3).forEach(task => { 
                        const taskEl = document.createElement('div');
                        taskEl.className = 'calendar-day-task';
                        taskEl.textContent = task.text;
                        taskEl.style.backgroundColor = getLabelColor(task.source === 'Personal' ? 'Personal' : (task.labels && task.labels[0] ? task.labels[0] : 'default'));
                        taskEl.draggable = true;
                        taskEl.dataset.taskId = task.id;
                        taskEl.dataset.taskSource = task.source;
                        taskEl.innerHTML = `
                            ${task.text}
                            <i class="fas fa-times delete-task-icon" data-task-id="${task.id}" data-task-source="${task.source}"></i>
                        `;
                        tasksContainer.appendChild(taskEl);
                    });

                    dayEl.addEventListener('click', (e) => {
                        if(e.target.classList.contains('delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(e.target.dataset.taskId);
                        } else if(e.target === e.currentTarget || e.target.classList.contains('calendar-day-tasks')) {
                             editCalendarTask(null, day.format('YYYY-MM-DD'));
                        } else if(e.target.closest('.calendar-day-task')) {
                            const taskEl = e.target.closest('.calendar-day-task');
                            handleTaskClick(taskEl.dataset.taskId, taskEl.dataset.taskSource);
                        }
                    });
                    dayEl.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    dayEl.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    dayEl.addEventListener('drop', handleCalendarDrop);
                    tasksContainer.querySelectorAll('.calendar-day-task').forEach(t => t.addEventListener('dragstart', handleCalendarDragStart));
                    tasksContainer.querySelectorAll('.calendar-day-task').forEach(t => t.addEventListener('touchstart', handleTouchStart, {passive: false}));

                    dom.calendarDaysGrid.appendChild(dayEl);
                }
            }

            function renderWeekView() {
                dom.weekDaysContent.innerHTML = '';
                let startOfWeek = selectedCalendarDate.startOf('isoWeek');

                const endOfWeek = startOfWeek.add(6, 'day');
                dom.currentWeekRange.textContent = `${startOfWeek.format('D MMM')} - ${endOfWeek.format('D MMM, YYYY')}`;

            for (let i = 0; i < 7; i++) {
                    const day = startOfWeek.add(i, 'day');
                    const dayKey = day.format('YYYY-MM-DD');
                    const tasks = getTasksForDay(dayKey);
                    const lang = localStorage.getItem('ibero-lang') || 'es';
                    const displayDate = day.format('dddd, D MMM');
                    const daySection = document.createElement('div');
                    daySection.className = 'week-day-section';
                    daySection.dataset.date = dayKey;

                    daySection.innerHTML = `
                        <h5>
                            <span>${displayDate}</span>
                            <button class="add-task-to-day-btn text-lg hover:text-primary" data-date="${dayKey}">+</button>
                        </h5>
                        <div class="space-y-1">
                            ${tasks.length === 0 ? `<p class="text-xs text-text-medium italic">${translations[lang].calendar_no_tasks}</p>` : ''}
                            ${tasks.map((task) => {
                                const isPersonal = task.source === 'Personal';
                                return `
                                <div class="task-item flex items-center gap-2 cursor-pointer ${task.completed ? 'task-item-completed' : ''}" 
                                     draggable="true" data-task-id="${task.id}" data-task-source="${task.source}">
                                     <input type="checkbox" class="task-checkbox flex-shrink-0" data-task-id="${task.id}" ${task.completed ? 'checked' : ''}>
                                    <span class="flex-grow">${task.text} ${task.time ? `(${task.time})` : ''} <span class="text-xs text-primary">(${task.source})</span></span>
                                    <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            `}).join('')}
                        </div>
                     `;
                    dom.weekDaysContent.appendChild(daySection);
                    daySection.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    daySection.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    daySection.addEventListener('drop', handleCalendarDrop);
                    daySection.addEventListener('click', (e) => {
                         if(e.target === e.currentTarget || e.target.classList.contains('space-y-1')) {
                            editCalendarTask(null, dayKey);
                        }
                    });
                }

                dom.weekDaysContent.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        updateTaskStatus(e.currentTarget.dataset.taskId, { completed: e.currentTarget.checked });
                    });
                 });

                dom.weekDaysContent.querySelectorAll('.task-item').forEach(item => {
                    item.addEventListener('dragstart', handleCalendarDragStart);
                    item.addEventListener('touchstart', handleTouchStart, {passive: false});
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(item.dataset.taskId);
                            return;
                        }
                        if (e.target.type === 'checkbox') return;
                        handleTaskClick(item.dataset.taskId, item.dataset.taskSource);
                     });
                });
                dom.weekDaysContent.querySelectorAll('.add-task-to-day-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const date = e.currentTarget.dataset.date;
                        editCalendarTask(null, date);
                    });
                });
            }

            function renderDayView() {
                dom.currentDayDisplay.textContent = selectedCalendarDate.format('dddd, D [de] MMMM');
                dom.dayViewTimeline.innerHTML = '';
                const tasksForDay = getTasksForDay(selectedCalendarDate.format('YYYY-MM-DD'));
                
                for (let hour = 0; hour < 24; hour++) {
                    const hourEl = document.createElement('div');
                    hourEl.className = 'day-view-hour';
                    const hourLabel = (hour < 10 ? '0' : '') + hour + ':00';
                    hourEl.dataset.time = hourLabel.substring(0,2); 
                    const tasksInHour = tasksForDay.filter(t => t.time && t.time.startsWith((hour < 10 ? '0' : '') + hour));
                    hourEl.innerHTML = `
                        <div class="day-view-hour-label">${hourLabel}</div>
                        <div class="day-view-hour-content" data-time="${hourLabel}" data-date="${selectedCalendarDate.format('YYYY-MM-DD')}">
                            ${tasksInHour.map(task => {
                                return `
                                 <div class="task-item flex items-center gap-2 p-1 rounded-md ${task.completed ? 'bg-green-900/50 text-gray-400 line-through' : 'bg-input'} text-sm" 
                                    draggable="true" data-task-id="${task.id}" data-task-source="${task.source}">
                                    <input type="checkbox" class="task-checkbox flex-shrink-0" data-task-id="${task.id}" ${task.completed ? 'checked' : ''}>
                                     <span class="flex-grow cursor-pointer"><strong>${task.time}:</strong> ${task.text} <span class="text-xs text-primary">(${task.source})</span></span>
                                    <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1"><i class="fas fa-trash-alt"></i></button>
                                </div>
                                `
                            }).join('')}
                             <button class="add-task-to-time-btn text-lg hover:text-primary" data-date="${selectedCalendarDate.format('YYYY-MM-DD')}" data-time="${hourLabel}">+</button>
                        </div>
                    `;
                    dom.dayViewTimeline.appendChild(hourEl);

                    const hourContent = hourEl.querySelector('.day-view-hour-content');
                    hourContent.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    hourContent.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    hourContent.addEventListener('drop', handleCalendarDrop);
                     hourContent.addEventListener('click', (e) => {
                         if(e.target === e.currentTarget) {
                            editCalendarTask(null, selectedCalendarDate.format('YYYY-MM-DD'), e.currentTarget.dataset.time);
                        }
                    });
                }
                dom.dayViewTimeline.querySelectorAll('.add-task-to-time-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const date = e.currentTarget.dataset.date;
                         const time = e.currentTarget.dataset.time;
                        editCalendarTask(null, date, time);
                    });
                });
                dom.dayViewTimeline.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        updateTaskStatus(e.currentTarget.dataset.taskId, { completed: e.currentTarget.checked });
                    });
                });
                dom.dayViewTimeline.querySelectorAll('.task-item').forEach(item => {
                    item.addEventListener('dragstart', handleCalendarDragStart);
                    item.addEventListener('touchstart', handleTouchStart, {passive: false});
                    item.addEventListener('click', (e) => {
                         if (e.target.closest('.delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(item.dataset.taskId);
                            return;
                        }
                        if (e.target.type === 'checkbox') return;
                        handleTaskClick(item.dataset.taskId, item.dataset.taskSource);
                    });
                 });
            }

            function handleTaskClick(taskId, taskSource) {
                 if (taskSource === 'Personal') {
                    editCalendarTask(taskId);
                } else if (taskSource === 'Proyecto Estudiantil') { // Adaptado para proyectos de clase
                    const projectChat = Object.values(state.chats).find(c => c.projectData && c.projectData.title === taskSource);
                    if (projectChat) {
                        editProjectTask(projectChat.id, taskId);
                    }
                } else { // Es una tarea de un curso
                    // Aquí se podría abrir un modal con los detalles de la asignación
                    showInAppNotification("Tarea de Curso", "Funcionalidad para ver/entregar tarea en desarrollo.");
                }
            }
            
            let draggedCalendarTaskId = null;
            function handleCalendarDragStart(e) {
                const target = e.target.closest('[draggable="true"]');
                if (!target) return;
                draggedCalendarTaskId = target.dataset.taskId;
                e.dataTransfer.setData('text/plain', draggedCalendarTaskId);
                e.dataTransfer.effectAllowed = 'move';
            }
            
            function handleCalendarDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.style.backgroundColor = '';
                const taskId = e.dataTransfer.getData('text/plain');
                if (!taskId) return;

                const dropZone = e.currentTarget;
                const newDate = dropZone.dataset.date;
                let newTime = dropZone.dataset.time || findTask(taskId)?.task?.time || null; 
                
                if (newTime && newTime.length === 2) { 
                   const originalTask = findTask(taskId)?.task;
                   const originalMinutes = originalTask?.time?.substring(3,5) || '00';
                   newTime = `${newTime}:${originalMinutes}`;
                }
                
                const updates = { date: newDate, time: newTime };
                updateTaskStatus(taskId, updates);
            }

            let touchDragElement = null, ghostElement = null;
            function handleTouchStart(e) {
                if (e.touches.length !== 1) return;
                const target = e.target.closest('[draggable="true"]');
                if (!target) return;
                
                touchDragElement = target;
                
                ghostElement = touchDragElement.cloneNode(true);
                ghostElement.style.position = 'absolute';
                ghostElement.style.zIndex = '1000';
                ghostElement.style.opacity = '0.7';
                ghostElement.style.pointerEvents = 'none';
                ghostElement.style.width = `${touchDragElement.offsetWidth}px`;
                document.body.appendChild(ghostElement);
                
                const touch = e.touches[0];
                ghostElement.style.left = `${touch.pageX - ghostElement.offsetWidth / 2}px`;
                ghostElement.style.top = `${touch.pageY - ghostElement.offsetHeight / 2}px`;

                document.addEventListener('touchmove', handleTouchMove, {passive: false});
                document.addEventListener('touchend', handleTouchEnd);
            }
            function handleTouchMove(e) {
                if (e.touches.length !== 1 || !ghostElement) return;
                e.preventDefault();
                const touch = e.touches[0];
                ghostElement.style.left = `${touch.pageX - ghostElement.offsetWidth / 2}px`;
                ghostElement.style.top = `${touch.pageY - ghostElement.offsetHeight / 2}px`;
            }
            function handleTouchEnd(e) {
                if (!ghostElement) return;
                
                ghostElement.style.display = 'none';
                const dropTarget = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
                ghostElement.remove();
                
                if (dropTarget) {
                    const dropZone = dropTarget.closest('.calendar-day, .week-day-section, .day-view-hour-content, .kanban-cards, .list-view-column-mobile, .list-view-content > h4, .project-header');
                    if(dropZone) {
                        const taskId = touchDragElement.dataset.taskId;
                        if (dropZone.classList.contains('kanban-cards')) {
                            const chatId = currentChatId;
                            const columnId = dropZone.dataset.columnId;
                            moveTask(chatId, taskId, columnId);
                        } else if(dropZone.classList.contains('list-view-column-mobile')) {
                            const chatId = currentChatId;
                            const columnId = dropZone.dataset.columnId;
                            moveTask(chatId, taskId, columnId);
                        } else if (dropZone.tagName === 'H4' && dropZone.closest('#list-view')) {
                             const columnTitle = dropZone.textContent.trim();
                             const chat = state.chats[currentChatId];
                             const targetColumn = chat.projectData.columns.find(c => c.title === columnTitle);
                             if (targetColumn) {
                                 moveTask(currentChatId, taskId, targetColumn.id);
                             }
                        }
                        else if (dropZone.classList.contains('project-header')) {
                            const targetProjectId = dropZone.closest('.project').dataset.id;
                            moveItemToProject(draggedItemId, targetProjectId);
                        }
                        else {
                            const newDate = dropZone.dataset.date;
                            let newTime = dropZone.dataset.time || findTask(taskId)?.task?.time || null;
                            if (newTime && newTime.length === 2) {
                                const originalTask = findTask(taskId)?.task;
                                const originalMinutes = originalTask?.time?.substring(3,5) || '00';
                                newTime = `${newTime}:${originalMinutes}`;
                            }
                            updateTaskStatus(taskId, { date: newDate, time: newTime });
                        }
                    }
                }
                
                touchDragElement = null; ghostElement = null;
                document.removeEventListener('touchmove', handleTouchMove);
                document.removeEventListener('touchend', handleTouchEnd);
            }

            // Función findTask adaptada para buscar en tareas de cursos
            function findTask(taskId) {
                if (!taskId) return null;
                // Buscar en calendario personal
                if (taskId.startsWith('cal-')) {
                    for (const dayKey in state.calendar) {
                        const taskIndex = (state.calendar[dayKey] || []).findIndex(t => t.id === taskId);
                        if (taskIndex > -1) {
                            return { type: 'personal', task: state.calendar[dayKey][taskIndex], dayKey, taskIndex };
                        }
                    }
                }
                // Buscar en proyectos de estudiantes
                if (taskId.startsWith('proj-')) {
                    for (const chat of Object.values(state.chats)) {
                        if (chat.projectData && chat.projectData.columns) {
                            for (const column of chat.projectData.columns) {
                                const taskIndex = (column.tasks || []).findIndex(t => t.id === taskId);
                                if (taskIndex > -1) {
                                     return { type: 'project', task: column.tasks[taskIndex], chat, column, taskIndex };
                                }
                            }
                        }
                    }
                }
                // Buscar en asignaciones de cursos
                if (taskId.startsWith('assign-')) {
                    for (const course of Object.values(state.courses)) {
                        const assignmentIndex = (course.assignments || []).findIndex(a => a.id === taskId);
                        if (assignmentIndex > -1) {
                            return { type: 'assignment', task: course.assignments[assignmentIndex], course, assignmentIndex };
                        }
                    }
                }
                return null;
            }

            function updateTaskStatus(taskId, updates) {
                const found = findTask(taskId);
                if (!found) return;
                
                // Un estudiante no puede cambiar la fecha o contenido de una tarea de curso
                const userRole = currentUser?.app_metadata?.role || 'student';
                if (found.type === 'assignment' && userRole === 'student') {
                    if (updates.content || updates.date || updates.time || updates.dueDate) {
                        showInAppNotification("Acción no permitida", "No puedes editar los detalles de una asignación del curso.");
                        return;
                    }
                }

                if (found.type === 'personal') {
                    const { task, dayKey } = found;
                    const oldDate = dayKey;
                    const newDate = updates.date || oldDate;
                    
                    if (oldDate !== newDate) {
                        const taskIndex = state.calendar[oldDate].findIndex(t => t.id === taskId);
                        const [taskToMove] = state.calendar[oldDate].splice(taskIndex, 1);
                        if(state.calendar[oldDate].length === 0) delete state.calendar[oldDate];
                        
                        if (!state.calendar[newDate]) state.calendar[newDate] = [];
                        Object.assign(taskToMove, updates);
                        delete taskToMove.date;
                        state.calendar[newDate].push(taskToMove);
                    } else {
                        delete updates.date;
                        Object.assign(task, updates);
                    }
                } 
                else if (found.type === 'project') {
                    const { task, chat } = found;
                    const originalCompleted = task.completed;
                    Object.assign(task, updates);

                    if (updates.completed !== undefined && updates.completed !== originalCompleted) {
                        // Mover entre columnas de kanban (por hacer/hecho)
                        let sourceColumn, taskIndex;
                        for(const col of chat.projectData.columns){
                            const idx = (col.tasks || []).findIndex(t => t.id === taskId);
                            if(idx > -1){
                                sourceColumn = col;
                                taskIndex = idx;
                                break;
                            }
                        }

                        if (sourceColumn) {
                            const [taskToMove] = sourceColumn.tasks.splice(taskIndex, 1);
                            if (task.completed) {
                                const doneColumn = chat.projectData.columns.find(c => c.id === 'done');
                                if (doneColumn && sourceColumn.id !== 'done') doneColumn.tasks.push(taskToMove);
                                else sourceColumn.tasks.push(taskToMove); 
                            } else {
                                const todoColumn = chat.projectData.columns.find(c => c.id === 'todo');
                                if (todoColumn && sourceColumn.id === 'done') todoColumn.tasks.push(taskToMove);
                                else sourceColumn.tasks.push(taskToMove);
                            }
                        }
                    }
                } else if (found.type === 'assignment') {
                    // Actualizar el estado de una asignación del curso (ej. completada)
                    Object.assign(found.task, updates);
                }

                saveState();
                if (dom.calendarModalOverlay.classList.contains('flex')) {
                    renderCalendarView();
                }
                if (dom.projectManagementView.style.display === 'flex') {
                    renderProjectBoard(currentChatId);
                }
                 if (dom.courseView.style.display === 'flex') {
                    renderCourseView(currentCourseId);
                }
            }

            // Función getTasksForDay adaptada para incluir asignaciones de cursos
            function getTasksForDay(dayKey) {
                // Tareas personales del calendario
                const calendarTasks = (state.calendar[dayKey] || []).map(t => ({...t, text: t.content, source: 'Personal'}));
                
                // Tareas de proyectos estudiantiles
                const projectTasks = [];
                Object.values(state.chats).forEach(chat => {
                    if (chat.projectData && chat.projectData.columns) {
                        chat.projectData.columns.forEach(column => {
                            (column.tasks || []).forEach(task => {
                                 if (task.dueDate === dayKey) {
                                    projectTasks.push({...task, source: 'Proyecto Estudiantil', text: task.content});
                                }
                             });
                        });
                    }
                });

                // Asignaciones de los cursos del usuario
                const assignmentTasks = [];
                if (currentUser && state.users[currentUser.id]) {
                    const userCourses = state.users[currentUser.id].enrolledCourses || [];
                    userCourses.forEach(courseId => {
                        const course = state.courses[courseId];
                        if (course && course.assignments) {
                            course.assignments.forEach(assignment => {
                                if (assignment.dueDate === dayKey) {
                                    assignmentTasks.push({ ...assignment, text: assignment.title, source: course.title });
                                }
                            });
                        }
                    });
                }

                return [...calendarTasks, ...projectTasks, ...assignmentTasks].sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
            }

            function updateNotificationBadge() {
                 let pendingNotifications = 0;
                const now = dayjs();
                Object.keys(state.calendar).forEach(dayKey => {
                    const tasksForDay = getTasksForDay(dayKey);
                    tasksForDay.forEach(task => {
                         if (!task.completed) {
                            const taskDate = dayjs(task.dueDate || dayKey);
                            if (task.time) {
                                const taskDateTime = dayjs(`${task.dueDate || dayKey}T${task.time}`);
                                if (taskDateTime.isBefore(now)) {
                                     pendingNotifications++;
                                }
                            } else {
                                if (taskDate.isBefore(now, 'day') || taskDate.isSame(now, 'day')) {
                                    pendingNotifications++;
                                }
                            }
                         }
                    });
                });
                
                const badgeEl = document.getElementById('notification-badge');

                if (pendingNotifications > 0) {
                    badgeEl.textContent = pendingNotifications;
                    badgeEl.classList.remove('hidden');
                } else {
                    badgeEl.classList.add('hidden');
                }
            }
            
            function checkAndNotifyTasks() {
                if (!notificationsEnabled) return;
                const now = dayjs();
                const todayKey = now.format('YYYY-MM-DD');
                const currentHourMinute = now.format('HH:mm');
                const allTasksToday = getTasksForDay(todayKey);
                allTasksToday.forEach(task => {
                    if (!task.completed && task.time === currentHourMinute && !task.notifiedThisMinute) {
                        const lang = localStorage.getItem('ibero-lang') || 'es';
                        const notificationTitle = translations[lang].notification_title;
                        const notificationBody = `${translations[lang].notification_task_due} ${task.text} (${task.time})`;
                        
                        showTaskNotification(notificationTitle, notificationBody);

                        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                            navigator.serviceWorker.controller.postMessage({
                                type: 'show-notification',
                                options: {
                                    title: notificationTitle,
                                    body: notificationBody,
                                    icon: './Logos HD.png'
                                }
                            });
                        }
                        
                        updateTaskNotifiedFlag(task.id, true);
                    }
                });
                allTasksToday.forEach(task => {
                    if (task.notifiedThisMinute && task.time !== currentHourMinute) {
                        updateTaskNotifiedFlag(task.id, false);
                    }
                });
                saveState();
                updateNotificationBadge();
            }

            function updateTaskNotifiedFlag(taskId, isNotified) {
                const found = findTask(taskId);
                if (found) {
                    found.task.notifiedThisMinute = isNotified;
                }
            }

            function renderCalendarView() {
                 dom.dayViewContainer.style.display = currentCalendarView === 'day' ? 'block' : 'none';
                dom.weekViewContainer.style.display = currentCalendarView === 'week' ? 'block' : 'none';
                dom.monthViewContainer.style.display = currentCalendarView === 'month' ? 'block' : 'none';
                
                dom.dayViewBtn.classList.toggle('active', currentCalendarView === 'day');
                dom.weekViewBtn.classList.toggle('active', currentCalendarView === 'week');
                dom.monthViewBtn.classList.toggle('active', currentCalendarView === 'month');

                if (currentCalendarView === 'day') renderDayView();
                if (currentCalendarView === 'week') renderWeekView();
                if (currentCalendarView === 'month') renderMonthView();
            }

            setInterval(checkAndNotifyTasks, 10 * 1000);

            async function setupNotifications() {
                if ('Notification' in window && 'serviceWorker' in navigator) {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        console.warn("Permisos de notificación denegados.");
                    }
                } else {
                    console.warn("Este navegador no soporta notificaciones push.");
                }
            }

            function speak(text, element) { 
                if (!text) return;

                if (speechOn) {
                    if (!('speechSynthesis' in window)) return;
                    speechSynthesis.cancel();
                    micWasOnBeforeSpeaking = isRecognizing;
                    if (isRecognizing) { recognition.stop(); }
                    const cleanText = text.replace(/<[^>]*>/g, '').replace(/[*_`#~[\]()🔍]|(-{3,})/g, '');
                    const utterance = new SpeechSynthesisUtterance(cleanText); 
                    if (selectedVoice) { utterance.voice = selectedVoice;
                    }
                    utterance.rate = 1.15;
                    utterance.onend = () => {
                        if (micWasOnBeforeSpeaking) {
                            if (recognition && !isRecognizing) {
                                try { recognition.start(); } catch(e) { console.error("Error restarting recognition:", e); }
                            }
                            micWasOnBeforeSpeaking = false;
                        }
                        toggleVoiceSelectorVisibility(false);
                    };
                    utterance.onerror = (e) => {
                        console.error('Speech synthesis error:', e);
                        if (micWasOnBeforeSpeaking) {
                            if (recognition && !isRecognizing) {
                               try { recognition.start(); } catch(e) { console.error("Error restarting recognition on error:", e); }
                            }
                            micWasOnBeforeSpeaking = false;
                        }
                         toggleVoiceSelectorVisibility(false);
                    }
                    speechSynthesis.speak(utterance);
                } else if (element) {
                    speechSynthesis.cancel();
                    const cleanText = text.replace(/<[^>]*>/g, '').replace(/[*_`#~[\]()🔍]|(-{3,})/g, '');
                    const utterance = new SpeechSynthesisUtterance(cleanText);
                    if (selectedVoice) utterance.voice = selectedVoice;
                    utterance.rate = 1.15;
                    speechSynthesis.speak(utterance);
                }
            }

            function populateVoiceList() {
                const setVoices = () => {
                    if (typeof speechSynthesis === 'undefined') { return; }
                    availableVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('es-') || v.lang.startsWith('en-'));
                    const preferredVoices = [ "Microsoft Sabina Online (Natural) - Spanish (Mexico)", "Paulina", "Google español de Estados Unidos", "Google español" ];
                    availableVoices.sort((a, b) => {
                        let aIdx = preferredVoices.indexOf(a.name); let bIdx = preferredVoices.indexOf(b.name);
                        if (aIdx === -1) aIdx = Infinity; if (bIdx === -1) bIdx = Infinity;
                        if (aIdx !== bIdx) return aIdx - bIdx;
                        return a.name.localeCompare(b.name);
                    });
                    
                    if (availableVoices.length > 0) {
                        dom.voiceSelector.innerHTML = '';
                        availableVoices.forEach(voice => {
                            const option = document.createElement('option');
                            const displayName = voice.name.replace('Microsoft', '').replace('Online (Natural) -', '').replace('Google', '').replace('Spanish (Mexico)','Mex').trim();
                            option.textContent = `${displayName || voice.lang} (${voice.lang})`;
                            option.value = voice.name;
                            dom.voiceSelector.appendChild(option);
                        });
                        selectedVoice = availableVoices[0];
                        if (selectedVoice) dom.voiceSelector.value = selectedVoice.name;
                    }
                }
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = setVoices;
                }
                setVoices();
            }

            function getModelForRequest(workflow, hasFile, assistantType) {
                let selector = dom.modelSelector; // Default selector

                if (workflow === "design-web") return "gpt-4o-mini";
                if (hasFile) return "gpt-4o-mini"; 
                
                const selectedModel = selector.value;
                if (selectedModel === 'gpt-4o') { 
                    // Se podría añadir una lógica para roles (ej. profesores con acceso a IA avanzada)
                }
                return selectedModel;
            }

            async function getAIResponse(prompt, history, image, pdf, model, workflow, userName, courseContext = null, noteContent = null) {
                const name = (userName || '').split(' ')[0];
                let title = 'Estudiante'; // Rol por defecto
                
                let finalPrompt = prompt;
                if (courseContext) {
                    finalPrompt = `Contexto del curso: "${courseContext.title}".\n\nPregunta del estudiante: ${prompt}`;
                }

                const body = { 
                    prompt: finalPrompt, history, model,
                    workflow, userName: name, title,
                    imageData: image, pdfText: pdf, 
                    noteContent,
                 };
                try {
                    const response = await fetch('/.netlify/functions/get-ai-response', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(body),
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({details: 'Error desconocido en el servidor'}));
                        console.error("Backend Error:", errorData);
                        throw new Error(errorData.details || `Error del servidor: ${response.status}.`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("Fetch Error:", error);
                    throw error;
                }
            }

            function getConsultaCount() {
                if (!currentUser) { // Usuario invitado
                    const usageData = JSON.parse(localStorage.getItem('guest_usage')) || { count: 0 };
                    return { remaining: Math.max(0, GUEST_CONSULTA_LIMIT - usageData.count), limit: GUEST_CONSULTA_LIMIT };
                }

                // Usuario logueado (estudiante/profesor)
                // Se asume que el rol está en app_metadata
                const role = currentUser.app_metadata?.role || 'student';
                let limit = role === 'student' ? STUDENT_CONSULTA_LIMIT : Infinity; // Profesores tienen límite infinito

                const usageKey = `usage_monthly_${currentUser.id}`;
                const currentMonth = dayjs().format('YYYY-MM');
                const usageData = JSON.parse(localStorage.getItem(usageKey)) || { count: 0, month: '' };

                if (usageData.month !== currentMonth) {
                    return { remaining: limit, limit }; // Nuevo mes, consultas completas
                }
                
                return { remaining: Math.max(0, limit - usageData.count), limit };
            }

            function spendConsultas(cost, modelUsed) {
                // Lógica de límite diario para IA Avanzada se mantiene
                if (modelUsed === 'gpt-4o') {
                    const today = dayjs().format('YYYY-MM-DD');
                    const proUsageKey = `ibero_pro_usage_${currentUser?.id || 'guest'}_${today}`;
                    goatXProUsage = parseInt(localStorage.getItem(proUsageKey) || '0');

                    if (goatXProUsage >= GOAT_X_PRO_DAILY_LIMIT) {
                        showModal({
                            title: 'Límite de Uso para IA Avanzada Alcanzado',
                            body: `Has alcanzado el límite de ${GOAT_X_PRO_DAILY_LIMIT} usos diarios para el modelo de IA Avanzada. Por favor, usa el modelo General o espera hasta mañana.`,
                            confirmText: 'Entendido',
                            showCancel: false
                        });
                        return false;
                    }
                }

                // Lógica de Puntos de Recompensa
                if (currentUser && gamificationState.credits >= cost) {
                    gamificationState.credits -= cost;
                    saveGamificationState();
                    updateCreditCounter();
                    showInAppNotification("Punto de Recompensa Usado", `Se ha utilizado un punto de recompensa. Te quedan ${gamificationState.credits}.`, 2000);
                    
                    if (modelUsed === 'gpt-4o') {
                        const today = dayjs().format('YYYY-MM-DD');
                        const proUsageKey = `ibero_pro_usage_${currentUser?.id || 'guest'}_${today}`;
                        goatXProUsage++;
                        localStorage.setItem(proUsageKey, goatXProUsage.toString());
                    }
                    return true;
                }

                // Lógica para invitados
                if (!currentUser) {
                    const usageKey = 'guest_usage';
                    let usageData = JSON.parse(localStorage.getItem(usageKey)) || { count: 0 };
                    if (usageData.count + cost > GUEST_CONSULTA_LIMIT) {
                         showModal({
                            title: 'Consultas de Invitado Agotadas',
                            body: `<p>Has utilizado tus ${GUEST_CONSULTA_LIMIT} consultas de invitado. <strong>Inicia sesión con tus credenciales de estudiante para continuar.</strong></p>`,
                            confirmText: 'Iniciar Sesión',
                            cancelText: 'Más Tarde',
                        }).then(res => { if (res.confirmed) { netlifyIdentity.open('login'); } });
                        return false;
                    }
                    usageData.count += cost;
                    localStorage.setItem(usageKey, JSON.stringify(usageData));
                    updateCreditCounter();
                    if (modelUsed === 'gpt-4o') { /* ...código de límite diario... */ }
                    return true;
                }

                // Lógica para usuarios logueados
                const { remaining } = getConsultaCount();
                if (remaining < cost) {
                    showModal({
                        title: 'Consultas Insuficientes',
                        body: 'No tienes suficientes consultas de IA este mes. Espera al próximo mes para que se recarguen.',
                        confirmText: 'Entendido',
                        showCancel: false,
                    });
                    return false;
                }

                const usageKey = `usage_monthly_${currentUser.id}`;
                const currentMonth = dayjs().format('YYYY-MM');
                let usageData = JSON.parse(localStorage.getItem(usageKey)) || { count: 0, month: '' };

                if (usageData.month !== currentMonth) {
                    usageData = { count: 0, month: currentMonth };
                }
                
                usageData.count += cost;
                localStorage.setItem(usageKey, JSON.stringify(usageData));
                updateCreditCounter();

                if (modelUsed === 'gpt-4o') { /* ...código de límite diario... */ }
                return true;
            }

            async function loadStateForUser() {
                const loadLocalStorage = (key) => {
                    const saved = localStorage.getItem(key);
                    return saved ? JSON.parse(saved) : {};
                };

                if (!currentUser) {
                    const guestData = loadLocalStorage('guestState_ibero');
                    state = guestData.state || { courses: {}, users: {}, chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
                    currentChatId = guestData.currentChatId || null;
                } else {
                     try {
                        const response = await fetch('/.netlify/functions/load-data', { // Endpoint genérico
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId: currentUser.id }),
                        });
                        if (!response.ok) { throw new Error(`Server error: ${response.status}`); }
                        const dbState = await response.json();
                        state = dbState.state || { courses: {}, users: {}, chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
                        currentChatId = dbState.currentChatId;
                    } catch (error) {
                        console.error("Could not load from DB, falling back to localStorage:", error);
                        const userLocalData = loadLocalStorage(`iberoState_${currentUser.id}`);
                        state = userLocalData.state || { courses: {}, users: {}, chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
                        currentChatId = userLocalData.currentChatId;
                    }
                }

                // *** INICIO DE DATOS DE MUESTRA ***
                // Para demostración, si no hay cursos, creamos uno de ejemplo.
                if (Object.keys(state.courses).length === 0) {
                    const courseId = 'crs-ia101';
                    state.courses[courseId] = {
                        id: courseId,
                        title: 'Inteligencia Artificial 101',
                        description: 'Un curso introductorio a los fundamentos de la IA, el aprendizaje automático y sus aplicaciones prácticas.',
                        modules: [
                            { id: 'mod-1', title: 'Módulo 1: Introducción a la IA', resources: [{id: 'res-1', title: 'Lectura: ¿Qué es la IA?', type: 'pdf'}] },
                            { id: 'mod-2', title: 'Módulo 2: Aprendizaje Automático', resources: [] },
                        ],
                        assignments: [
                            { id: 'assign-1', title: 'Ensayo: Impacto de la IA', dueDate: dayjs().add(5, 'day').format('YYYY-MM-DD'), time: '23:59' },
                            { id: 'assign-2', title: 'Quiz: Conceptos Básicos', dueDate: dayjs().add(10, 'day').format('YYYY-MM-DD'), time: '23:59' }
                        ]
                    };
                    if (currentUser && !state.users[currentUser.id]) {
                        state.users[currentUser.id] = {
                            id: currentUser.id,
                            name: currentUser.user_metadata?.full_name || 'Estudiante de Muestra',
                            role: 'student',
                            enrolledCourses: [courseId]
                        };
                    }
                }
                // *** FIN DE DATOS DE MUESTRA ***

                state.calendar = state.calendar || {};
                state.projects = state.projects || {};
                state.chats = state.chats || {};
                state.structure = state.structure || [];
                state.notes = state.notes || [];
                state.courses = state.courses || {};
                state.users = state.users || {};

                const today = dayjs().format('YYYY-MM-DD');
                const proUsageKey = `ibero_pro_usage_${currentUser?.id || 'guest'}_${today}`;
                goatXProUsage = parseInt(localStorage.getItem(proUsageKey) || '0');

                loadGamificationState();
                renderSidebar();
                selectView(currentChatId || (currentUser ? `course-${Object.keys(state.courses)[0]}` : null));
            }

            async function saveState() {
                const stateData = { state, currentChatId };
                const key = currentUser ? `iberoState_${currentUser.id}` : 'guestState_ibero';
                
                try {
                    localStorage.setItem(key, JSON.stringify(stateData));
                    if(currentUser) {
                        await fetch('/.netlify/functions/save-data', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId: currentUser.id, stateToSave: stateData }),
                        });
                    }
                } catch (error) {
                    console.error("Failed to save state:", error);
                }
            }
            
            function updateUserUI() {
                const goatXProModels = document.querySelectorAll('.goat-x-pro-model');
                if (currentUser) {
                    dom.loginView.classList.add('hidden');
                    dom.userMenuView.classList.remove('hidden');
                    dom.genericWelcome.classList.add('hidden');
                    dom.personalizedWelcome.classList.remove('hidden');
                    const userName = currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.email.split('@')[0];
                    dom.userEmail.textContent = currentUser.user_metadata?.full_name || currentUser.email;
                    dom.userName.textContent = userName;
                    goatXProModels.forEach(option => option.disabled = false);

                } else {
                    dom.loginView.classList.remove('hidden');
                    dom.userMenuView.classList.add('hidden');
                    dom.genericWelcome.classList.remove('hidden');
                    dom.personalizedWelcome.classList.add('hidden');
                    goatXProModels.forEach(option => option.disabled = true);
                }
                updateCreditCounter();
            }

            function updateCreditCounter() {
                const { remaining, limit } = getConsultaCount();
                const gamCredits = (currentUser && gamificationState.credits) ? gamificationState.credits : 0;
                let displayLimit = limit === Infinity ? '∞' : limit;

                dom.planCreditsDisplay.textContent = `${remaining}/${displayLimit}`;
                dom.rewardCreditsDisplay.textContent = `${gamCredits}`;
                dom.messageCounterWrapper.classList.remove('hidden');
            }

            function setTheme(isDark) { 
                document.body.className = 'w-screen overflow-x-hidden';
                document.body.classList.add(isDark ? 'dark-theme' : 'light-theme');
                dom.themeIcon.className = `fas fa-${isDark ? 'sun' : 'moon'}`; 
                if (dom.settingsThemeIcon) dom.settingsThemeIcon.className = `fas fa-${isDark ? 'moon' : 'sun'} mr-2`;
                localStorage.setItem('ibero-theme', isDark ? 'dark' : 'light');
            }
            
            // ... (El resto de funciones de utilidad como toggleSidebar, show/hide Modals, etc., se mantienen igual que en los bloques anteriores)
            // ... (Las funciones de renderizado del calendario y manejo de tareas también se mantienen)
            
            function renderSidebar() { 
                dom.sidebarContent.innerHTML = '';
                dom.foldersContainer.innerHTML = '';
                const fragMain = document.createDocumentFragment();
                const fragFolders = document.createDocumentFragment();

                // Lógica para mostrar cursos del usuario
                const user = currentUser ? state.users[currentUser.id] : null;
                if (user && user.enrolledCourses) {
                    const coursesHeader = document.createElement('h4');
                    coursesHeader.className = 'px-2 pt-4 pb-2 text-xs font-semibold uppercase text-text-medium';
                    coursesHeader.textContent = 'Mis Cursos';
                    fragMain.appendChild(coursesHeader);

                    user.enrolledCourses.forEach(courseId => {
                        const course = state.courses[courseId];
                        if (course) {
                            const item = document.createElement('a');
                            item.href = `?view=${courseId}`;
                            item.className = 'chat-item group flex items-center p-2 rounded-md cursor-pointer';
                            item.dataset.id = courseId;
                            item.dataset.type = 'course';
                            item.innerHTML = `<i class="fas fa-book-reader mr-2"></i><span class="flex-grow truncate text-sm font-medium">${course.title}</span>`;
                            item.addEventListener('click', e => {
                                e.preventDefault();
                                selectView(courseId, 'course');
                            });
                            fragMain.appendChild(item);
                        }
                    });
                }
                
                // Lógica para mostrar consultas y notas (similar a la anterior)
                // ... (El resto de la lógica de renderSidebar para chats, notas, carpetas se mantiene)

                dom.sidebarContent.appendChild(fragMain);
                dom.foldersContainer.appendChild(fragFolders);
                updateActiveViewHighlight(); 
            }

            function selectView(viewId, type = null) {
                // Ocultar todas las vistas principales
                dom.courseView.style.display = 'none';
                dom.chatMessages.style.display = 'none';
                dom.projectManagementView.style.display = 'none';
                dom.financialAssistantView.style.display = 'none';
                dom.notepadViewContainer.style.display = 'none';
                dom.inputArea.style.display = 'none';

                if (!viewId) {
                    resetToDashboard();
                    return;
                }
                
                // Determinar el tipo si no se proporciona
                if (!type) {
                    if (viewId.startsWith('course-')) type = 'course';
                    else if (viewId.startsWith('chat-')) type = 'chat';
                    else if (viewId.startsWith('note-')) type = 'note';
                    else if (viewId.startsWith('project-')) type = 'project';
                }

                currentCourseId = null;
                currentChatId = null;
                currentNoteId = null;

                switch(type) {
                    case 'course':
                        currentCourseId = viewId;
                        selectCourse(viewId);
                        break;
                    case 'chat':
                        currentChatId = viewId;
                        selectChat(viewId);
                        break;
                    case 'note':
                        currentNoteId = viewId;
                        selectNote(viewId);
                        break;
                    // ... otros casos
                    default:
                        resetToDashboard();
                }

                updateActiveViewHighlight();
                saveState();
                if (window.innerWidth < 768) toggleSidebar(false);
            }

            function selectCourse(courseId) {
                const course = state.courses[courseId];
                if (!course) {
                    resetToDashboard();
                    return;
                }
                dom.courseView.style.display = 'flex';
                dom.inputArea.style.display = 'block'; // Permitir consultas al Tutor IA desde la vista del curso
                dom.chatTitle.textContent = course.title;
                dom.mobileChatTitle.textContent = course.title;
                renderCourseView(courseId);
                updateContextualFooter('my-courses');
            }

            function renderCourseView(courseId) {
                const course = state.courses[courseId];
                if (!course) return;

                const assignmentsHTML = (course.assignments || []).map(assign => `
                    <li class="p-3 bg-current-bg-light rounded-md flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${assign.title}</p>
                            <p class="text-sm text-text-medium">Fecha de entrega: ${dayjs(assign.dueDate).format('DD/MM/YYYY')} a las ${assign.time}</p>
                        </div>
                        <button class="btn-primary text-sm px-3 py-1">Entregar</button>
                    </li>
                `).join('');

                const modulesHTML = (course.modules || []).map(mod => `
                    <div class="bg-current-bg-light rounded-md p-4">
                        <h4 class="font-bold text-lg text-primary">${mod.title}</h4>
                        <ul class="mt-2 space-y-2">
                            ${(mod.resources || []).map(res => `
                                <li class="flex items-center gap-2"><i class="fas fa-file-alt text-text-medium"></i> ${res.title}</li>
                            `).join('')}
                        </ul>
                    </div>
                `).join('');

                dom.courseView.innerHTML = `
                    <div class="p-4 md:p-6 h-full overflow-y-auto">
                        <h2 class="text-3xl font-bold mb-2">${course.title}</h2>
                        <p class="text-text-medium mb-6">${course.description}</p>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-xl font-semibold mb-3 border-b-2 border-primary pb-1">Módulos del Curso</h3>
                                <div class="space-y-4">${modulesHTML}</div>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold mb-3 border-b-2 border-primary pb-1">Tareas y Entregas</h3>
                                <ul class="space-y-3">${assignmentsHTML}</ul>
                            </div>
                        </div>
                    </div>
                `;
            }

            // ... (Otras funciones de selección como selectChat, selectNote, resetToDashboard adaptadas)
            
            function updateActiveViewHighlight() {
                document.querySelectorAll('.chat-item').forEach(item => {
                    const id = item.dataset.id;
                    const type = item.dataset.type;
                    let isActive = (type === 'course' && id === currentCourseId) ||
                                   (type === 'chat' && id === currentChatId) ||
                                   (type === 'note' && id === currentNoteId);
                    item.classList.toggle('selected-chat', isActive);
                });
            }

            async function sendMessage(forceSend = false, spokenMessage = null, { assistantType = 'main' } = {}) {
                // ... (lógica existente para determinar inputEl, messageContainer)
                
                const userMessage = spokenMessage || dom.msgInput.value.trim();
                if (!userMessage && !selectedImageBase64 && !selectedPdfText) return;

                // Si no hay un chat de Tutor IA activo, se crea uno.
                if (!currentChatId || !currentChatId.startsWith('chat-')) {
                    currentChatId = createNewQuery();
                }
                const currentChat = state.chats[currentChatId];

                if (!spendConsultas(cost, modelToUse)) return;

                // ... (lógica existente para añadir mensaje de usuario a la UI)

                try {
                    const userNameForCall = currentUser ? (currentUser.user_metadata.full_name || currentUser.email) : 'invitado';
                    const courseContext = currentCourseId ? state.courses[currentCourseId] : null;
                    const responseData = await getAIResponse(userMessage, currentChat.messages.slice(0, -1), image, pdf, modelToUse, currentChat.workflow, userNameForCall, courseContext);
                    
                    // ... (lógica existente para manejar la respuesta)
                } catch (error) {
                    // ... (manejo de errores)
                }
            }

            // ... (resto de funciones: generateImage, gamificación, etc., adaptadas con nuevos textos y lógica de rol si es necesario)

            function setupEventListeners() {
                // ... (todos los event listeners de la versión anterior)
                
                // Nuevos listeners para la navegación del aula
                document.querySelectorAll('[data-view]').forEach(button => {
                    button.addEventListener('click', () => {
                        const view = button.dataset.view;
                        if (view === 'my-courses') {
                            const user = currentUser ? state.users[currentUser.id] : null;
                            if (user && user.enrolledCourses && user.enrolledCourses.length > 0) {
                                selectView(`course-${user.enrolledCourses[0]}`, 'course');
                            } else {
                                showInAppNotification("Sin Cursos", "No estás inscrito en ningún curso actualmente.");
                            }
                        }
                        // Aquí se añadirían listeners para 'grades', etc.
                    });
                });
                
                // Listeners para modals adaptados
                dom.closePricingModalBtn?.addEventListener('click', hideProgramsModal);
                dom.settingsUpgradePlanBtn?.addEventListener('click', () => { hideSettingsModal(); showProgramsModal(); });

                // El resto de la función setupEventListeners
                // ...
            }

            // --- BLOQUE DE INICIALIZACIÓN FINAL ---
            let initFired = false;
            const finishInitialization = (user) => {
                if (initFired) return;
                initFired = true;
                currentUser = user;
                
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const viewIdFromUrl = urlParams.get('view');

                    updateUserUI();
                    loadStateForUser().then(() => {
                        populateVoiceList();
                        setupEventListeners();
                        setupNotifications();
                        updateContextualFooter(null);
                        setupMotivationInterval();

                        dom.appContainer.classList.remove('opacity-0');
                        dom.loadingOverlay.style.display = 'none';
                        
                        if (viewIdFromUrl) {
                            selectView(viewIdFromUrl);
                        } else if (currentChatId) { // Prioridad a la última vista activa
                            selectView(currentChatId);
                        } else if (currentUser && state.users[currentUser.id]?.enrolledCourses?.length > 0) {
                            // Si es un usuario logueado, llevarlo a su primer curso
                            selectView(`course-${state.users[currentUser.id].enrolledCourses[0]}`, 'course');
                        } else {
                            resetToDashboard();
                        }

                        updateNotificationBadge();
                    });
                } catch (e) {
                    console.error("Error durante la inicialización:", e);
                    dom.loadingOverlay.innerHTML = `<div class="text-red-500 text-center">Error al cargar el aula virtual.<br>Por favor, recarga la página.<br><small>${e.message}</small></div>`;
                }
            };

            const savedLang = localStorage.getItem('ibero-lang') || 'es';
            setLanguage(savedLang);
            setTheme(localStorage.getItem('ibero-theme') === 'dark' || (!localStorage.getItem('ibero-theme') && window.matchMedia('(prefers-color-scheme: dark)').matches));

            // ... (código de desbloqueo de audio y listeners de Netlify Identity)
            if (window.netlifyIdentity) {
                netlifyIdentity.on('init', (user) => finishInitialization(user));
                netlifyIdentity.on('login', (user) => {
                    netlifyIdentity.close(); 
                    currentUser = user;
                    updateUserUI(); 
                    loadStateForUser();
                });
                netlifyIdentity.on('logout', () => {
                    currentUser = null;
                    updateUserUI(); 
                    loadStateForUser(); 
                    resetToDashboard();
                });
                netlifyIdentity.on('error', (err) => {
                    console.error("Netlify Identity Error:", err);
                    if (!initFired) finishInitialization(null); 
                });
            } else {
                 console.warn("Netlify Identity no encontrado. Procediendo como invitado.");
                 finishInitialization(null);
            }

            setTimeout(() => {
                if (!initFired) {
                    console.warn("Forzando inicialización de la aplicación.");
                    finishInitialization(window.netlifyIdentity ? netlifyIdentity.currentUser() : null);
                 }
            }, 3000);
        });
        //<-- FIN DEL SCRIPT DE LA APLICACIÓN -->
    </script>
</body>
</html>
