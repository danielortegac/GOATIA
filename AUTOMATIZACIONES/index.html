<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#101010">
    <link rel="manifest" href="manifest.json">
    <title>Aula Virtual | Centro Iberoamericano de Educación</title>
    <link rel="icon" type="image/png" href="./Logos HD.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/locale/es.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/plugin/localizedFormat.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/plugin/isoWeek.js"></script>
    
    <style>
        :root {
            /* Paleta de Colores IBERO (Rojo Vino, Negro, Blanco) */
            --bg-dark: #121212;
            --bg-medium: #1e1e1e;
            --bg-light: #2a2a2a;
            --primary: #800000; /* Rojo Vino */
            --primary-hover: #9c0000;
            --text-light: #f5f5f5;
            --text-medium: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
            --gold-color: #FFD700; /* Mantenemos el dorado para gamificación */
            --urgent-color: #c83c3c;
            --danger-color: #dc2626;

            /* Tema Claro (si se implementa) */
            --light-bg-dark: #f9f9f9;
            --light-bg-medium: #ffffff;
            --light-bg-light: #f1f1f1;
            --light-primary: #800000;
            --light-primary-hover: #9c0000;
            --light-text-dark: #1f2937;
            --light-text-medium: #6b7280;
            --light-border-color: rgba(0, 0, 0, 0.09);

            --base-font-size: 15px;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: var(--base-font-size);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .dark-theme {
            --current-bg-dark: var(--bg-dark);
            --current-bg-medium: var(--bg-medium);
            --current-bg-light: var(--bg-light);
            --current-primary: var(--primary);
            --current-primary-hover: var(--primary-hover);
            --current-text-light: var(--text-light);
            --current-text-medium: var(--text-medium);
            --current-border-color: var(--border-color);
            background-color: var(--current-bg-dark);
            color: var(--text-light);
        }

        .light-theme {
            --current-bg-dark: var(--light-bg-dark);
            --current-bg-medium: var(--light-bg-medium);
            --current-bg-light: var(--light-bg-light);
            --current-primary: var(--light-primary);
            --current-primary-hover: var(--light-primary-hover);
            --current-text-light: var(--light-text-dark);
            --current-text-medium: var(--light-text-medium);
            --current-border-color: var(--light-border-color);
            background-color: var(--light-bg-dark);
            color: var(--light-text-dark);
        }
        
        #sidebar { 
            background-color: var(--current-bg-dark); 
            border-right: 1px solid var(--current-border-color); 
            height: 100vh; 
            transition: width 0.3s ease, transform 0.3s ease; 
            z-index: 40; 
            position: relative;
            display: flex;
            flex-direction: column;
        }
        #sidebar.collapsed { 
            width: 80px;
            padding: 0; 
            overflow: hidden; 
        }
        #sidebar.collapsed > *:not(#sidebar-toggle-arrow, #sidebar-header, #sidebar-bottom-fixed) {
            display: none; 
        }
        #sidebar.collapsed #sidebar-toggle-arrow {
            display: flex;
            left: unset;
            right: -12px;
            transform: translateY(0%) rotate(180deg);
            top: 12px;
        }

        #sidebar-toggle-arrow {
            position: absolute;
            top: 12px;
            right: -12px;
            transform: translateY(0%) rotate(0deg);
            background-color: var(--current-bg-dark);
            border: 1px solid var(--current-border-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 45;
            transition: transform 0.3s ease, left 0.3s ease, right 0.3s ease, top 0.3s ease;
        }
        #sidebar:not(.collapsed) #sidebar-toggle-arrow {
            right: -12px;
            transform: translateY(0%) rotate(0deg);
        }

        #sidebar-header, #sidebar-bottom-fixed {
            flex-shrink: 0;
            padding: 0.75rem;
        }
        #sidebar-header { border-bottom: 1px solid var(--current-border-color); }
        #sidebar-bottom-fixed { border-top: 1px solid var(--current-border-color); }

        #sidebar-scrollable-content {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
        }
        #sidebar-content-main {
            flex-grow: 1;
        }
        #sidebar-footer {
            flex-shrink: 0;
            margin-top: auto;
            padding-top: 1rem;
        }

        @media (max-width: 767px) {
            #sidebar {
                transform: translateX(-100%);
                position: fixed;
                top: 0;
                left: 0;
                width: 288px;
            }
            #sidebar.is-open {
                transform: translateX(0);
            }
            #sidebar, #sidebar > .flex {
                height: 100vh;
                height: -webkit-fill-available;
            }
            body { --base-font-size: 13.5px; }
            button, .btn-primary { 
                padding-top: 0.4rem; padding-bottom: 0.4rem; 
                padding-left: 0.75rem; padding-right: 0.75rem;
                font-size: 0.8rem;
            }
            .text-lg { font-size: 1rem; }
            .text-xl { font-size: 1.1rem; }
            .text-2xl { font-size: 1.2rem; }
            .text-3xl { font-size: 1.4rem; }
            #app-container {
                max-height: calc(100vh - 10px);
            }
             #sidebar.collapsed {
                width: 0; 
                padding: 0; 
                overflow: hidden; 
                border-right: none;
            }
            #sidebar.collapsed > * {
                display: none; 
            }
            #sidebar.collapsed #sidebar-toggle-arrow {
                display: none;
            }
        }


        #main-chat-area, .modal-content { background-color: var(--current-bg-medium); }
        .chat-bubble-bot, .bg-input, #pdf-preview-container, .chat-item, .project-header, #user-menu-popup, #services-menu, .pro-controls-bg { background-color: var(--current-bg-light); }
        .border-themed { border-color: var(--current-border-color); }
        .chat-bubble-user { background-color: var(--current-primary); color: white; }
        .btn-primary { background-color: var(--current-primary); color: white; }
        .btn-primary:hover { background-color: var(--current-primary-hover); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .plan-card-highlight { border-color: var(--current-primary); box-shadow: 0 0 15px rgba(128, 0, 0, 0.3); }
        .placeholder-themed::placeholder { color: var(--current-text-medium); }
        .text-primary, .workflow-header i:not(.workflow-arrow) { color: var(--current-primary) !important; }
        .glowing-mic { animation: pulse 1.5s infinite; color: var(--primary) !important; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(128, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(128, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(128, 0, 0, 0); }
        }

        .project .project-content { display: none; }
        .project.open .project-content { display: block; }
        .project.open .project-arrow { transform: rotate(90deg); }
        .project-header.drag-over { background-color: var(--current-primary); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        #app-container { height: 100vh; height: -webkit-fill-available; }
        #pricing-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .chat-item.selected-for-delete { background-color: var(--primary) !important; color: white; }
        
        .model-selector-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .model-selector-wrapper select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
            padding-right: 2.5rem;
            height: 32px;
            font-size: 0.875rem;
            line-height: 1.25rem;
            border: none;
            outline: none;
            cursor: pointer;
            min-width: 120px;
            background-color: transparent;
        }
         .model-selector-wrapper i {
            position: absolute;
            right: 0.5rem;
            pointer-events: none;
        }

        .pro-controls-bg {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.375rem;
            border-radius: 0.5rem;
            overflow: hidden; 
            width: 100%;
            gap: 0.5rem;
        }

        #pro-controls-left, #pro-controls-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        #pro-controls-left {
            flex-grow: 1;
            min-width: 0;
        }

        #pro-controls-right {
            flex-shrink: 0;
        }
        
        .workflow-category.open .workflow-content, .actions-category.open .actions-content { display: block; }
        .workflow-category.open .workflow-arrow, .actions-category.open .actions-arrow { transform: rotate(90deg); }
        .workflow-content, .actions-content { display: none; }
        
        .plan-card { background-color: var(--current-bg-light); }
        #pdf-preview-container { padding: 0.5rem; }
        
        @keyframes sweep {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(200%) skewX(-15deg); }
        }
        .cool-light-effect { position: relative; overflow: hidden; }
        .cool-light-effect::before {
            content: '';
            position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(128, 0, 0, 0.25) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-150%) skewX(-15deg); transition: transform 0.8s ease;
            pointer-events: none;
        }
        .cool-light-effect:hover::before { animation: sweep 2s infinite linear; }

        .input-wrapper { border: 1px solid transparent; transition: box-shadow 0.3s ease, border-color 0.3s ease; }
        .input-wrapper:focus-within { box-shadow: 0 0 10px 0px rgba(128, 0, 0, 0.5); border-color: var(--current-primary-hover); }

        #chat-title {
            color: var(--primary);
            font-weight: 700;
            transition: color 0.3s ease;
        }
        #desktop-chat-title-wrapper:hover #chat-title {
            color: var(--primary-hover);
        }
        
        #desktop-chat-title-wrapper {
            position: relative;
            cursor: pointer;
        }
        #desktop-chat-title-wrapper .edit-icon {
            opacity: 0;
            transition: opacity 0.2s;
            margin-right: 8px;
        }
        #desktop-chat-title-wrapper:hover .edit-icon {
            opacity: 1;
        }
        #mobile-chat-title-wrapper .edit-icon {
            margin-right: 8px;
        }

        .btn-disabled { background-color: #3a3a3a !important; color: #888 !important; cursor: not-allowed !important; border-color: #3a3a3a !important;}

        .chat-item.selected-chat {
            background-color: var(--current-primary);
            color: white !important;
        }
        .chat-item.selected-chat .text-sm {
            color: white !important;
        }
        .light-theme .chat-item {
            color: var(--light-text-dark);
        }

        /* Calendar styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day {
            padding: 2px;
            border-radius: 4px;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            transition: background-color 0.2s ease, border 0.2s ease;
            position: relative;
            border: 2px solid transparent;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .calendar-day-number {
            font-weight: bold;
            font-size: 0.8rem;
            margin: 4px;
            align-self: flex-start;
        }
        .calendar-day-tasks {
            flex-grow: 1;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 0 2px 2px 2px;
        }
        .calendar-day-task {
            font-size: 0.65rem;
            padding: 2px 4px;
            border-radius: 4px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
            position: relative;
        }
        .calendar-day-task .delete-task-icon {
            display: none;
            position: absolute;
            right: 1px;
            top: 1px;
            color: white;
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 14px;
            height: 14px;
            font-size: 8px;
            line-height: 14px;
            text-align: center;
        }
        .calendar-day-task:hover .delete-task-icon {
            display: block;
        }

        .calendar-day:hover {
            background-color: var(--current-bg-light);
        }
        .calendar-day.current-month {
            color: var(--current-text-light);
        }
        .calendar-day.other-month {
            color: var(--current-text-medium);
            opacity: 0.5;
        }
        .calendar-day.today .calendar-day-number {
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 2px;
        }
        .task-dots-container {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
        }
        .task-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-item-completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .notification-bell-icon {
            position: relative;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7em;
            line-height: 1;
            min-width: 18px;
            text-align: center;
        }
        
        .calendar-view-toggle, .project-view-controls {
            display: flex;
            gap: 0.5rem;
            background-color: var(--current-bg-dark);
            padding: 0.25rem;
            border-radius: 8px;
            width: 100%;
        }

        .calendar-view-toggle button, .project-view-controls button {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            font-weight: 600;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
            white-space: nowrap;
        }
        .calendar-view-toggle button.active, .project-view-controls button.active {
            background-color: var(--current-primary);
            color: white;
            box-shadow: 0 0 8px rgba(128, 0, 0, 0.4);
        }
        .calendar-view-toggle button:hover:not(.active), .project-view-controls button:hover:not(.active) {
            background-color: var(--current-bg-medium);
        }
        .dark-theme .project-view-controls button:not(.active) {
            color: var(--current-text-light);
        }
        .light-theme .project-view-controls button:not(.active) {
            color: var(--current-text-dark);
        }

        #month-view-container, #day-view-container {
            display: block;
        }
        #week-view-container, #day-view-container {
            display: none;
        }
        #week-view-container, #day-view-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--current-border-color);
            border-radius: 8px;
            padding: 10px;
        }
        .week-day-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--current-border-color);
        }
        .week-day-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .week-day-section h5 {
            font-weight: 700;
            color: var(--current-primary);
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .week-day-section .task-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 0;
        }
        
        .day-view-timeline {
            position: relative;
        }
        .day-view-hour {
            display: flex;
            border-top: 1px solid var(--current-border-color);
        }
        .day-view-hour-label {
            width: 60px;
            flex-shrink: 0;
            text-align: right;
            padding-right: 10px;
            font-size: 0.75rem;
            color: var(--current-text-medium);
        }
        .day-view-hour-content {
            flex-grow: 1;
            border-left: 1px solid var(--current-border-color);
            padding: 5px;
            min-height: 40px;
            position: relative;
        }
        .add-task-to-time-btn {
            position: absolute;
            right: 5px;
            top: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .day-view-hour-content:hover .add-task-to-time-btn {
            opacity: 1;
        }

        /* Project, Financial & Notepad View Styles */
        #project-management-view, #financial-assistant-view, #notepad-view-container {
            display: flex;
            flex-direction: column; 
            gap: 1rem;
            height: 100%;
            position: relative; 
            flex: 1;
            overflow: hidden;
        }
        
        #project-board-container, #financial-tools-container, #notepad-editor-and-chat-container {
            flex: 1; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0; 
        }
        
        #project-chat-container, #financial-chat-container, #notepad-chat-container {
            display: flex;
            flex-direction: column;
            border-top: 1px solid var(--current-border-color);
            padding-top: 1rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
            background-color: var(--current-bg-medium);
        }
        #project-chat-container.collapsed, #financial-chat-container.collapsed, #notepad-chat-container.collapsed {
            flex-grow: 0;
            flex-basis: auto;
            height: 50px !important;
        }

        #project-chat-container .project-chat-body,
        #financial-chat-container .financial-chat-body,
        #notepad-chat-container .notepad-chat-body {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        #project-chat-container.collapsed .project-chat-body,
        #financial-chat-container.collapsed .financial-chat-body,
        #notepad-chat-container.collapsed .notepad-chat-body {
            display: none;
        }

        #project-chat-toggle i, #financial-chat-toggle i, #notepad-chat-toggle i {
            transition: transform 0.3s ease;
        }
        #project-chat-container:not(.collapsed) #project-chat-toggle i,
        #financial-chat-container:not(.collapsed) #financial-chat-toggle i,
        #notepad-chat-container:not(.collapsed) #notepad-chat-toggle i {
            transform: rotate(180deg);
        }

        #project-chat-messages, #financial-chat-messages, #notepad-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        #kanban-view {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 1rem;
            overflow: hidden; 
            flex-grow: 1;
        }

        .kanban-column {
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-width: 0; /* Allow columns to shrink */
        }
        .kanban-column-title {
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--current-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-cards {
            flex-grow: 1;
            min-height: 100px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .kanban-card {
            background-color: var(--current-bg-medium);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            border-left: 4px solid var(--current-primary);
            position: relative;
        }
        .kanban-card .delete-task-icon {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
            color: var(--current-text-medium);
            background-color: var(--current-bg-light);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            line-height: 18px;
            text-align: center;
            transition: all 0.2s ease;
        }
        .kanban-card .delete-task-icon:hover {
            background-color: var(--danger-color);
            color: white;
            transform: scale(1.1);
        }
        .kanban-card:hover .delete-task-icon {
            display: block;
        }
        .kanban-card.urgent {
            border-left-color: var(--urgent-color);
        }
        .kanban-card:active {
            cursor: grabbing;
            background-color: var(--primary);
        }
        .kanban-card p {
            font-weight: 500;
            padding-right: 20px; /* Space for delete icon */
        }
        .kanban-card .card-footer {
            font-size: 0.75rem;
            color: var(--current-text-medium);
            margin-top: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-cards.drag-over {
            border: 2px dashed var(--current-primary);
            background-color: rgba(128, 0, 0, 0.1);
        }
        
        /* List View Styles */
        #list-view {
            overflow: hidden;
            flex-grow: 1;
            display: flex; 
            flex-direction: column; 
        }
        .list-view-header {
            display: grid;
            grid-template-columns: 1fr 150px 80px 120px 40px;
            gap: 1rem;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid var(--current-border-color);
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--current-text-medium);
            flex-shrink: 0; 
        }
        .list-view-content {
             overflow-y: auto; 
             flex-grow: 1; 
        }
        .list-view-task {
            display: grid;
            grid-template-columns: 1fr 150px 80px 120px 40px;
            gap: 1rem;
            align-items: center;
            padding: 0.25rem 1rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        .list-view-task input[type="date"], .list-view-task input[type="time"] {
                background: transparent;
                border: none;
                border-radius: 4px;
                padding: 2px 4px;
                font-size: 0.8rem;
                width: auto;
                color: var(--current-text-light);
                color-scheme: dark;
        }
        .light-theme .list-view-task input { color-scheme: light; color: var(--light-text-dark); }
        .list-view-task:hover {
            background-color: var(--current-bg-light);
        }
        .list-view-task.task-item-completed .task-content-list {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .task-content-list.urgent {
            font-weight: 600;
            color: var(--urgent-color);
        }
        .task-content-list input {
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
        }
        .task-content-list input:focus {
             background-color: var(--current-bg-dark);
        }
        .priority-cell {
            text-align: center;
            cursor: pointer;
        }
        
        .task-labels {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .task-label {
            padding: 2px 8px;
            font-size: 0.7rem;
            border-radius: 12px;
            font-weight: 600;
        }
        #project-tag-filter-container {
            position: relative;
        }
        #tag-filter-dropdown {
            position: absolute;
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Gamification Styles */
        #gamification-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .gamification-tabs { border-bottom: 2px solid var(--current-border-color); }
        .gamification-tab { padding: 0.75rem 1rem; font-weight: 600; color: var(--current-text-medium); cursor: pointer; border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; }
        .gamification-tab.active { color: var(--current-primary); border-color: var(--current-primary); }
        .xp-bar-bg { background-color: var(--current-bg-light); }
        .xp-bar-fill { background-color: var(--current-primary); transition: width 0.5s ease-out; }
        .level-badge { background-color: var(--current-primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; }
        .streak-day { background-color: var(--current-bg-light); border: 2px solid var(--current-border-color); transition: all 0.2s ease; }
        .streak-day.active { border-color: var(--current-primary); transform: scale(1.05); box-shadow: 0 0 10px rgba(128, 0, 0, 0.5); }
        .streak-day.completed { background-color: var(--current-primary); color: white; border-color: var(--current-primary); }
        .streak-day .fa-gift { color: var(--gold-color); }
        .mission-item.completed { opacity: 0.5; text-decoration: line-through; }
        .mission-item.completed .btn-primary { background-color: #4CAF50; cursor: default; }
        .achievement-badge { border: 2px solid var(--current-border-color); filter: grayscale(100%); opacity: 0.6; transition: all 0.3s ease; }
        .achievement-badge.unlocked { border-color: var(--gold-color); filter: grayscale(0%); opacity: 1; box-shadow: 0 0 15px var(--gold-color); }
        .achievement-badge.unlocked .fa-medal { color: var(--gold-color); }
        .text-gold { color: var(--gold-color); }

        /* Pricing Modal Enhancements */
        .plan-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .plan-details.open {
            max-height: 500px; /* Adjust as needed */
        }
        .plan-feature-list {
            list-style-position: inside;
        }
        .plan-feature-list li {
            padding-left: 1em;
            text-indent: -1em;
        }
        .plan-feature-list .fa-check-circle {
            color: var(--primary);
        }

        /* NEW Financial Assistant Styles */
        #financial-tools-container {
             padding: 1rem;
             gap: 1rem;
             overflow-y: auto;
        }
        .finance-section {
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
        }
        .finance-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        .finance-section-header h3 {
            font-size: 1.125rem;
            font-weight: 700;
        }
        .finance-category {
            margin-top: 1rem;
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
        }
        .finance-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .finance-category-header .finance-category-name-input {
            background: transparent;
            border: none;
            outline: none;
            font-weight: bold;
            width: 70%;
            color: var(--current-text-light);
        }
        .finance-category-content {
            padding: 0.75rem;
        }
        .finance-item-row {
            display: grid;
            grid-template-columns: 1fr 100px 40px;
            gap: 0.75rem;
            align-items: center;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--current-border-color);
        }
        .finance-item-row:last-child {
            border-bottom: none;
        }
        .finance-item-row input {
            background: transparent;
            border: none;
            padding: 0.25rem;
            width: 100%;
            outline: none;
            color: var(--current-text-light);
        }
        .finance-item-row input:focus {
            background-color: var(--current-bg-dark);
            border-radius: 4px;
        }
        .finance-summary {
            background-color: var(--current-bg-light);
            border-radius: 0.5rem;
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            text-align: center;
        }
        .finance-summary h4 {
            font-size: 0.8rem;
            color: var(--current-text-medium);
        }
        .finance-summary p {
            font-size: 1.25rem;
            font-weight: 700;
        }
        #total-income { color: #22c55e; }
        #total-expenses { color: #ef4444; }

        /* Notepad View */
        #notepad-view-container {
            display: none; /* Hidden by default */
            padding: 0;
            flex-direction: column;
        }
        
        #notes-list-panel {
            flex-shrink: 0;
            padding: 0.5rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        
        #notepad-editor-and-chat-container {
            display: flex;
            flex-direction: row;
            flex-grow: 1;
            gap: 1rem;
            padding: 1rem;
            min-height: 0;
        }
        #notes-list {
            display: none;
        }
        .note-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background-color: var(--current-bg-medium);
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
            display: block;
            color: var(--current-text-light);
            text-decoration: none;
        }
        .note-item:hover { 
            background-color: var(--current-bg-dark);
            border-left-color: var(--current-primary-hover);
        }
        .note-item.active { 
            background-color: var(--current-primary); 
            color: white !important; 
            font-weight: bold;
            border-left-color: var(--gold-color);
        }
        .note-item.active * {
            color: white !important;
        }
        #note-editor-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        #note-editor-toolbar {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--current-border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            background-color: var(--current-bg-medium);
        }
         #note-editor-toolbar button, .drawing-tool {
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.375rem;
            padding: 0.4rem 0.6rem;
            transition: all 0.2s ease;
        }
         #note-editor-toolbar button:hover, .drawing-tool:hover {
            background-color: var(--current-bg-dark);
            border-color: var(--current-primary);
        }
        #note-editor-toolbar button.active {
            background-color: var(--current-primary);
            color: white;
            border-color: var(--current-primary);
        }
        .drawing-tool[type="color"] {
             padding: 0.2rem;
             min-width: 36px;
             height: 36px;
        }
        #note-title-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            outline: none;
            font-size: 1.1rem;
            font-weight: bold;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        #note-content-area {
            position: relative;
            flex-grow: 1;
        }
        #note-content-editor {
            flex-grow: 1;
            width: 100%;
            height: 100%;
            background-color: transparent;
            color: var(--current-text-light);
            border: none;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            resize: none;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        #note-content-editor:focus-within {
            box-shadow: none;
        }
        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin: 0.5rem 0;
        }
        .checklist-item input[type="checkbox"] {
            width: 1.15em;
            height: 1.15em;
            accent-color: var(--current-primary);
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 0.2em;
        }
        .checklist-item-text {
            flex-grow: 1;
            outline: none;
            min-height: 1.15em;
            padding-top: 0.2em;
            padding-bottom: 0.2em;
            word-wrap: break-word;
        }
        .checklist-item-text[data-checked="true"] {
            text-decoration: line-through;
            opacity: 0.6;
        }
        #note-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--light-bg-medium);
            cursor: crosshair;
            touch-action: none;
        }
        #notes-list-toggle {
            position: absolute;
            top: 12px;
            right: -12px;
            transform: translateY(0%) rotate(0deg);
            background-color: var(--current-bg-dark);
            border: 1px solid var(--current-border-color);
            border-radius: 50%;
            padding: 4px;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.3s ease;
        }
        #notes-list-panel:not(.collapsed) #notes-list-toggle {
            transform: translateY(0%) rotate(0deg);
        }
        #notes-list-panel.collapsed #notes-list-toggle {
            transform: translateY(0%) rotate(180deg);
        }

        /* In-app notification */
        #in-app-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-200%);
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            padding: 1rem;
            border-radius: 0.75rem;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            border: 1px solid var(--current-border-color);
            max-width: 90%;
            width: 400px;
            opacity: 0;
            pointer-events: none;
            cursor: pointer;
        }
        #in-app-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        #in-app-notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        #in-app-notification-header h4 {
            font-weight: bold;
        }

        @keyframes glowing {
            0% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px var(--primary), 0 0 20px var(--primary); }
            50% { text-shadow: 0 0 10px #fff, 0 0 20px var(--primary), 0 0 30px var(--primary), 0 0 40px var(--primary); }
            100% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px var(--primary), 0 0 20px var(--primary); }
        }

        .task-notification-content .glowing-text {
            animation: glowing 1.5s ease-in-out infinite;
        }


        /* Desktop specific styles */
        @media (min-width: 768px) {
            #sidebar-toggle-arrow {
                display: flex;
            }
            #sidebar.collapsed {
                width: 80px;
            }
            #sidebar:not(.collapsed) {
                width: 288px;
            }

            #services-menu {
                opacity: 0;
                visibility: hidden;
                transform: scale(0.95) translateY(-10px);
                transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
            }
            #services-menu.show {
                opacity: 1;
                visibility: visible;
                transform: scale(1) translateY(0);
            }
            #project-management-view, #financial-assistant-view {
                display: flex; 
                flex-direction: row; 
            }
             #notepad-editor-and-chat-container {
                flex-direction: row;
            }
            
            #notes-list-toggle {
                display: block;
            }


            #project-chat-container, #financial-chat-container, #notepad-chat-container {
                display: flex;
                border-left: 1px solid var(--current-border-color);
                border-top: none;
                padding-left: 1rem;
                padding-top: 0;
                height: 100%;
                flex-basis: 40%;
                flex-shrink: 0;
                flex-direction: column;
            }
            #project-chat-container.collapsed, #financial-chat-container.collapsed, #notepad-chat-container.collapsed {
                flex-basis: 50px;
                height: 100% !important;
            }
            #project-chat-container-header, #financial-chat-header, #notepad-chat-header { cursor: pointer; }

            #project-chat-container.collapsed .project-chat-body,
            #project-chat-container.collapsed #project-chat-container-header h3,
            #financial-chat-container.collapsed .financial-chat-body,
            #financial-chat-container.collapsed #financial-chat-header h3,
            #notepad-chat-container.collapsed .notepad-chat-body,
            #notepad-chat-container.collapsed #notepad-chat-header h3 {
                display: none;
            }

            #project-chat-container.collapsed #project-chat-toggle,
            #financial-chat-container.collapsed #financial-chat-toggle,
            #notepad-chat-container.collapsed #notepad-chat-toggle {
                transform: rotate(90deg);
                justify-content: center;
            }
            #project-chat-container.collapsed #project-chat-toggle i,
            #financial-chat-container.collapsed #financial-chat-toggle i,
            #notepad-chat-container.collapsed #notepad-chat-toggle i {
                 transform: rotate(180deg);
            }
        }
        
        /* Mobile specific adjustments */
        @media (max-width: 767px) {
            #mobile-chat-title-wrapper .edit-icon, #mobile-chat-title-wrapper #motivation-btn-mobile {
                display: inline-block;
            }
             #desktop-chat-title-wrapper .edit-icon, #desktop-chat-title-wrapper #motivation-btn-header {
                display: none;
            }
            #calendar-modal {
                padding: 0.5rem;
                max-width: 98vw;
                max-height: 95vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            #calendar-modal > div:not(:first-child) {
                overflow-y: auto;
            }

            .header-left-icons {
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 0;
            }
             .header-left-icons > * {
                padding: 0.3rem; 
            }
            .header-right-icons {
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 0;
            }
            .header-right-icons > * {
                padding: 0.3rem;
            }
            #desktop-chat-title-wrapper { display: none; }
            #main-header-content {
                display: flex;
                align-items: center;
                justify-content: space-between;
                width: 100%;
                gap: 0.5rem;
            }
            #main-header-content > * {
                flex-basis: 33.33%;
            }
            #main-header-content .header-left-icons { justify-content: flex-start; }
            #main-header-content .header-right-icons { justify-content: flex-end; }
            #main-header-content #message-counter-wrapper { text-align: center; }


             #file-preview-area {
                display: none;
             }
             #image-preview-container {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                max-height: 45px;
                flex-shrink: 1;
            }
            #image-preview {
                max-height: 45px;
                width: auto;
                border-radius: 0.25rem;
            }
            #input-area {
                display: flex;
                flex-direction: column;
            }

            /* Mobile chat containers */
            #project-chat-container, #financial-chat-container, #notepad-chat-container {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 50px;
                overflow: hidden;
                border-top: 1px solid var(--current-border-color);
                z-index: 10;
                transition: height 0.3s ease;
                max-height: calc(100vh - 120px); 
            }
            #project-chat-container:not(.collapsed),
            #financial-chat-container:not(.collapsed),
            #notepad-chat-container:not(.collapsed) {
                 height: 100%;
            }
            #project-chat-container .project-chat-body,
            #financial-chat-container .financial-chat-body,
            #notepad-chat-container .notepad-chat-body {
                height: calc(100% - 50px);
                display: flex;
                flex-direction: column;
            }

            #kanban-view {
                grid-template-columns: repeat(3, 1fr);
                overflow-y: auto;
                overflow-x: hidden;
                gap: 0.4rem; 
                padding-bottom: 50px;
            }
            .kanban-column {
                min-width: 0;
                padding: 0.4rem;
            }
            .kanban-column-title { font-size: 0.7rem; }
            .kanban-card { padding: 0.4rem; }
            .kanban-card p { font-weight: normal; font-size: 0.7rem; }

            #list-view-mobile {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                 padding-bottom: 50px;
                 overflow-y: auto;
                 flex-grow: 1;
            }
            .list-view-task-mobile { background-color: var(--current-bg-light); padding: 0.75rem; border-radius: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
            .list-view-task-mobile-header { display: flex; align-items: flex-start; gap: 0.75rem; }
            .list-view-task-mobile-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--current-border-color); padding-top: 0.5rem; font-size: 0.75rem; }
            .list-view-task-mobile-footer .task-time-date-inputs { display: flex; align-items: center; gap: 4px; }
            .list-view-task-mobile-footer input[type="time"], .list-view-task-mobile-footer input[type="date"] {
                background: var(--current-bg-dark);
                border: none;
                border-radius: 4px;
                padding: 2px 4px;
                font-size: 0.7rem;
                width: auto;
                color-scheme: dark;
            }
            .light-theme .list-view-task-mobile-footer input[type="time"], .light-theme .list-view-task-mobile-footer input[type="date"] {
                 color-scheme: light;
            }

            /* Notepad Mobile Optimization */
            #notepad-view-container {
                flex-direction: column;
                padding: 0;
                height: 100%;
            }
            #notepad-editor-and-chat-container {
                flex-direction: column;
                padding: 0.5rem;
                height: 100%;
                gap: 0.5rem;
            }
            #notepad-view-container.mobile-editor-active #notes-list-panel {
                display: none;
            }
            #notepad-view-container:not(.mobile-editor-active) #notepad-editor-and-chat-container {
                display: none;
            }
            #notes-list-panel {
                width: 100%;
                height: auto;
                border-radius: 0;
            }
            #note-editor-panel {
                height: 100%;
            }
            #note-back-btn {
                display: inline-block;
            }
            #notepad-chat-container {
                position: relative;
                height: 50%;
                max-height: 50%;
            }

            #services-menu {
                position: fixed;
                opacity: 0;
                visibility: hidden;
                transform: scale(0.95) translateY(-10px);
                transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
                width: 90vw;
                max-width: 320px;
                top: 60px;
                right: 10px;
                max-height: calc(100vh - 80px);
                overflow-y: auto;
                z-index: 50;
            }
            #services-menu.show {
                opacity: 1;
                visibility: visible;
                transform: scale(1) translateY(0);
            }
            
            .calendar-view-toggle button { padding: 6px 4px; font-size: 0.75rem; }
            .project-view-controls { width: fit-content; flex-grow: 0; }
            .project-view-controls button { padding: 6px 8px; font-size: 0.75rem; flex-grow: 0; }
            
            #gamification-modal .modal-content { padding: 1rem; }
            #gamification-modal h2 { font-size: 1.25rem; }
            .streak-day .text-lg { font-size: 0.8rem; }
            .streak-day .text-2xl { font-size: 1.1rem; }
            .streak-day .text-xs { font-size: 0.6rem; }
            .mission-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .mission-item .btn-primary { padding: 0.25rem 0.5rem; font-size: 0.75rem; align-self: flex-end; }
            #achievements-container { gap: 0.5rem; }
            .achievement-badge { padding: 0.5rem; font-size: 0.7rem; }
            .achievement-badge .fa-3x { font-size: 1.75em; }

            .chat-item .chat-item-actions {
                opacity: 1 !important;
            }
            #notes-list-panel.collapsed #notes-list-toggle {
                display: none;
            }
        }
        
        /* Mobile Landscape */
        @media (max-height: 500px) and (orientation: landscape) {
            #sidebar.is-open #sidebar-scrollable-content {
                 overflow-y: auto;
                 height: 100%;
            }
            #main-chat-area, #project-management-view, #financial-assistant-view, #notepad-view-container {
                overflow-y: auto;
            }
            #chat-messages {
                padding: 0.5rem;
                flex-grow: 1;
            }
            #kanban-view {
                grid-template-columns: repeat(3, minmax(250px, 1fr));
                overflow-x: auto;
            }
            .modal-content { max-height: 95vh; overflow-y: auto; }
            #input-area { padding: 0.5rem; flex-shrink: 0; }
            .pro-controls-bg { padding: 0.25rem; }
            #msg { height: 3rem !important; max-height: 3rem; }
        }

        /* Motivation Modal Shimmer Effect */
        #motivation-quote.shimmer-text {
            position: relative;
            overflow: hidden;
        }
        #motivation-quote.shimmer-text::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            animation: shimmer 2.5s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes shimmer {
            0% { transform: translateX(-150%) skewX(-15deg); }
            100% { transform: translateX(250%) skewX(-15deg); }
        }

        .dark-theme #message-counter-wrapper span {
            color: white;
        }

        .light-theme #message-counter-wrapper span {
            color: black;
        }
        .speaker-icon {
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 8px;
            display: inline-block;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .speaker-icon:hover {
            opacity: 1;
        }
        .chat-item {
            display: block;
            text-decoration: none;
        }
        .chat-item, a.chat-item:hover {
            color: var(--current-text-light);
        }
        .light-theme .chat-item, .light-theme a.chat-item:hover {
            color: var(--light-text-dark);
        }

    </style>
</head>
<body class="w-screen overflow-x-hidden dark-theme">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script type="text/javascript">
        if (window.netlifyIdentity) {
            netlifyIdentity.init();
        }
    </script>
    <div id="loading-overlay" class="fixed inset-0 bg-bg-dark bg-opacity-95 flex flex-col items-center justify-center z-[100] transition-opacity duration-300">
        <img src="./Logos HD.png" alt="IBERO Logo" class="w-24 h-24 object-contain mb-6 animate-pulse" onerror="this.onerror=null;this.src='https://placehold.co/96x96/121212/e0e0e0?text=LOGO';">
        <div class="text-text-light text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3 text-lg font-semibold" data-translate-key="initializing">Cargando Aula Virtual...</p>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden opacity-0 pointer-events-none"></div>

    <div id="app-container" class="flex w-full relative opacity-0 transition-opacity duration-300">
        <aside id="sidebar" class="w-72 flex-shrink-0 flex flex-col transition-transform duration-300 md:translate-x-0 h-full">
            
            <div id="sidebar-header">
                <div id="logo-space" class="w-16 h-16 rounded-lg mx-auto flex-shrink-0 flex items-center justify-center overflow-hidden cursor-pointer">
                    <img src="./Logos HD.png" alt="IBERO Logo" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/64x64/2c2c2c/e0e0e0?text=LOGO';">
                </div>
            </div>

            <div class="flex-shrink-0 px-4 pt-2 pb-4 border-b border-themed">
                 <div class="mb-4">
                    <h3 class="text-xs font-semibold uppercase text-text-medium mb-2 px-2" data-translate-key="workflows">Panel Principal</h3>
                    <div id="sidebar-top-actions" class="space-y-2">
                        <button data-workflow="dashboard" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                            <i class="fas fa-home w-6 mr-2"></i>
                           <span class="text-sm font-bold">Inicio</span>
                       </button>
                       <button data-workflow="my-courses" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                            <i class="fas fa-graduation-cap w-6 mr-2"></i>
                           <span class="text-sm font-bold">Mis Cursos</span>
                       </button>
                        <button data-workflow="notepad-app" class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                            <i class="fas fa-book-open w-6 mr-2"></i>
                           <span class="text-sm font-bold">Apuntes y Materiales</span>
                       </button>
                   </div>
                </div>
            </div>

            <div id="sidebar-scrollable-content">
                <div id="sidebar-content-main" class="flex flex-col">
                    <div class="flex-grow">
                        <div class="mb-4">
                             <div id="workflows-container" class="space-y-1">
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-brain w-6 mr-2"></i>
                                        <span class="text-sm font-bold">Tutor IA</span>
                                    </div>
                                     <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="decision-lab" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Consultar un Tema</button>
                                        <button data-workflow="conflict-resolution" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Explicar un Concepto</button>
                                     </div>
                                </div>
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i><i class="fas fa-pencil-ruler w-6 mr-2"></i>
                                        <span class="text-sm font-bold">Asistente de Redacción</span>
                                     </div>
                                    <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="create-full-post" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Crear un Ensayo</button>
                                         <button data-workflow="persuasive-copy" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Mejorar Redacción</button>
                                        <button data-workflow="post-ideas" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Lluvia de Ideas</button>
                                    </div>
                                </div>
                                 <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-chart-pie w-6 mr-2"></i>
                                        <span class="text-sm font-bold">Análisis de Datos</span>
                                    </div>
                                     <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="competitor-analysis" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Analizar Documento (PDF)</button>
                                         <button data-workflow="buyer-persona" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Interpretar Gráficos</button>
                                     </div>
                                </div>
                                <div class="workflow-category">
                                    <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                         <i class="fas fa-language w-6 mr-2"></i>
                                        <span class="text-sm font-bold">Asistente de Idiomas</span>
                                    </div>
                                       <div class="workflow-content pl-4 pt-1 space-y-1">
                                        <button data-workflow="english-teacher-translate" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Traducir/Corregir Texto</button>
                                         <button data-workflow="english-teacher-vocabulary" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Aprender Vocabulario</button>
                                        <button data-workflow="english-teacher-practice" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center">Practicar Conversación</button>
                                     </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="actions-category border-t border-themed pt-4 open">
                            <div class="actions-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                <span class="text-sm font-bold">Mis Cursos</span>
                            </div>
                            <div id="folders-container" class="space-y-1 mt-2"></div> <div id="sidebar-content" class="pr-1 space-y-1"></div> </div>

    
                        <div class="border-t border-themed pt-2 mt-4">
                             <button id="select-chats-btn" class="w-full text-sm p-2 rounded hover:bg-light flex items-center justify-center">
                                <i class="fas fa-check-double mr-2"></i><span>Seleccionar Múltiples</span>
                            </button>
                         </div>
                        <div id="delete-mode-controls" class="hidden flex space-x-2 my-2">
                            <button id="delete-selected-btn" class="flex-1 flex items-center justify-center font-semibold p-2 rounded-lg bg-red-600 text-white disabled:opacity-50" disabled><i class="fas fa-trash-alt mr-2"></i><span data-translate-key="delete">Borrar</span></button>
                             <button id="cancel-select-mode-btn" class="p-2 rounded-lg bg-gray-600 text-white"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                </div>

                <div id="sidebar-footer">
                    <div class="flex flex-col space-y-2 border-t border-themed pt-4">
                        <button id="gamification-btn" class="w-full text-left font-semibold text-sm p-3 rounded-lg btn-primary transition-colors cool-light-effect">
                           <i class="fas fa-trophy text-gold-color"></i> Mi Progreso Académico
                        </button>
                    </div>
                </div>
            </div>

            <div id="sidebar-bottom-fixed">
                 <div id="user-section">
                    <div id="login-view" class="hidden">
                        <button id="login-btn" class="w-full flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-sign-in-alt mr-2"></i><span data-translate-key="login">Iniciar Sesión</span></button>
                    </div>
                     <div id="user-menu-view" class="hidden relative">
                        <button id="user-menu-btn" class="w-full flex items-center text-left p-2 rounded-lg hover:bg-light transition-colors">
                            <span id="user-email" class="flex-grow truncate text-sm font-semibold"></span>
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <div id="user-menu-popup" class="absolute bottom-full left-0 w-full mb-2 rounded-lg p-2 border border-themed shadow-lg hidden">
                            <button id="settings-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-cog w-6 mr-2"></i><span data-translate-key="settings">Configuración</span></button>
                             <button id="logout-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-sign-out-alt w-6 mr-2"></i><span data-translate-key="logout">Cerrar Sesión</span></button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="sidebar-toggle-arrow">
                <i class="fas fa-chevron-left"></i> </div>
        </aside>

        <main id="main-chat-area" class="flex-1 flex flex-col h-full overflow-hidden">
            <header class="flex items-center justify-between p-3 md:p-4 border-b border-themed flex-shrink-0 relative">
                <div id="main-header-content" class="flex items-center justify-between w-full">
                    <div class="flex items-center flex-shrink-0 header-left-icons">
                        <button id="menu-toggle" class="md:hidden text-xl p-2"><i class="fas fa-bars"></i></button>
                        <button id="new-chat-icon-btn" title="Nuevo Chat con Tutor" class="text-xl p-1 hover:opacity-80 transition-opacity"><i class="fas fa-comment-plus text-primary"></i></button>
                        <button id="calendar-btn" title="Mi Calendario y Tareas" class="text-sky-400 hover:text-sky-300 p-1 transition-colors notification-bell-icon">
                            <i class="fas fa-calendar-days text-lg"></i>
                            <span id="notification-badge" class="notification-badge hidden">0</span>
                        </button>
                    </div>
                    
                    <div id="desktop-chat-title-wrapper" class="hidden sm:flex items-center justify-center group cursor-pointer mx-2 flex-1 min-w-0" title="Renombrar Módulo/Tema">
                        <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                        <h1 id="chat-title" class="text-lg font-semibold truncate">Centro Iberoamericano de Educación</h1>
                        <button id="motivation-btn-header" title="Motivación de Estudio" class="text-yellow-400 hover:text-yellow-300 p-2 transition-colors ml-2"><i class="fas fa-lightbulb text-xl"></i></button>
                    </div>

                    <div class="flex items-center space-x-1 sm:space-x-2 header-right-icons">
                        <div id="message-counter-wrapper" class="flex items-center space-x-2 text-xs font-mono whitespace-nowrap block mx-2 cursor-pointer">
                             <div id="plan-credits-info" class="flex items-center">
                                <i class="fas fa-brain text-primary mr-1 text-base"></i> <span id="plan-credits-display">0/0</span>
                            </div>
                            <div id="reward-credits-info" class="flex items-center">
                                <i class="fas fa-coins text-gold ml-2 mr-1 text-base"></i> <span id="reward-credits-display">0</span>
                            </div>
                        </div>
                        <button id="theme-toggle" title="Cambiar Tema" class="text-xl p-1"><i class="fas fa-moon" id="theme-icon"></i></button>
                    </div>
                </div>
                 <div id="services-menu" class="absolute top-full right-4 mt-2 w-80 rounded-xl shadow-lg border border-themed z-30 p-4 origin-top-right">
                    <h4 class="font-bold text-lg mb-1 text-text-light">Recursos Adicionales</h4>
                    <p class="text-sm text-text-medium mb-4">Accede a la biblioteca, soporte técnico y otros servicios de la institución.</p>
                    <ul class="space-y-3">
                        <li><a id="sol-web" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Biblioteca Virtual</p><p class="text-sm text-text-medium">Investiga en nuestra base de datos de artículos y libros.</p></a></li>
                         <li><a id="sol-auto" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Soporte Técnico</p><p class="text-sm text-text-medium">¿Problemas con la plataforma? Contáctanos.</p></a></li>
                        <li><a id="sol-social" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Reglamento Estudiantil</p><p class="text-sm text-text-medium">Consulta las normativas y políticas de la institución.</p></a></li>
                    </ul>
                </div>
            </header>
            <div class="block sm:hidden text-center py-1.5 border-b border-themed bg-current-bg-dark shadow-sm flex-shrink-0">
                <div id="mobile-chat-title-wrapper" class="flex items-center justify-center group cursor-pointer px-4 relative" title="Renombrar Módulo">
                    <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                    <h2 id="mobile-chat-title" class="text-sm font-semibold truncate">Aula Virtual</h2>
                    <button id="motivation-btn-mobile" title="Motivación de Estudio" class="text-yellow-400 hover:text-yellow-300 p-2 transition-colors"><i class="fas fa-lightbulb text-lg"></i></button>
                </div>
             </div>
             <div id="view-container" class="flex-1 overflow-hidden relative">
                <div id="chat-messages" class="h-full overflow-y-auto p-3 sm:p-6">
                    <div class="flex justify-center items-center h-full" id="initial-message-container">
                        <div id="welcome-message-wrapper" class="text-center text-text-medium">
                            <img src="./Logos HD.png" alt="IBERO Logo" class="w-24 h-24 object-contain mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=LOGO';">
                            <h2 class="text-3xl font-bold text-text-light">Aula Virtual IBERO</h2>
                            <div id="personalized-welcome" class="hidden"><p class="text-lg mt-1">¡Hola, <span id="user-name"></span>! Listo para un nuevo día de aprendizaje.</p></div>
                            <div id="generic-welcome" class="hidden"><p class="text-xl">Selecciona un curso para empezar.</p></div>
                        </div>
                    </div>
                </div>

                <div id="notepad-view-container" class="hidden">
                    <div id="notes-list-panel">
                        <div id="notes-list-header" class="flex items-center gap-2">
                            <button id="add-new-note-btn" class="w-full btn-primary text-sm flex items-center justify-center gap-2"><i class="fas fa-file-alt"></i>Nuevo Apunte</button>
                            <button id="add-new-drawing-btn" class="p-2 bg-input rounded-md" title="Nuevo Esquema"><i class="fas fa-paint-brush"></i></button>
                        </div>
                    </div>
                    <div id="notepad-editor-and-chat-container">
                        <div id="note-editor-panel">
                             <div id="note-editor-toolbar">
                                <button id="note-back-btn" title="Volver a la lista" class="p-2 hidden mr-2"><i class="fas fa-arrow-left"></i></button>
                                <input id="note-title-input" type="text" placeholder="Título del apunte...">
                                <div id="text-tools" class="flex items-center gap-2 ml-auto">
                                    <button id="add-checklist-item-btn" title="Añadir Checklist" class="p-2"><i class="fas fa-check-square"></i></button>
                                </div>
                                <div id="drawing-tools" class="hidden items-center gap-2">
                                    <button id="tool-pencil" class="drawing-tool active" title="Lápiz"><i class="fas fa-pencil-alt"></i></button>
                                    <button id="tool-eraser" class="drawing-tool" title="Borrador"><i class="fas fa-eraser"></i></button>
                                    <input type="color" id="drawing-color" class="drawing-tool" title="Color" value="#FFFFFF"> <input type="range" id="drawing-line-width" class="drawing-tool" min="1" max="50" value="3" title="Grosor">
                                    <button id="clear-canvas-btn" class="drawing-tool" title="Limpiar todo"><i class="fas fa-trash-alt"></i></button>
                                </div>
                                <button id="share-note-btn" title="Compartir Apunte" class="p-2 ml-2"><i class="fas fa-user-plus"></i></button>
                                <button id="delete-note-btn" title="Eliminar Apunte" class="p-2 text-red-500 hover:text-red-400 transition-colors"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <div id="note-content-area" class="relative flex-grow">
                                <div id="note-content-editor" contenteditable="true" class="h-full"></div>
                                <canvas id="note-canvas" class="absolute top-0 left-0 hidden"></canvas>
                            </div>
                        </div>
                        <div id="notepad-chat-container" class="hidden md:flex">
                            <div id="notepad-chat-header" class="flex justify-between items-center cursor-pointer p-2">
                                <h3 class="text-lg font-semibold text-primary">Asistente de Apuntes</h3>
                                <button id="notepad-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-up"></i></button>
                            </div>
                            <div class="notepad-chat-body">
                                <div id="notepad-chat-messages" class="chat-bubble-bot"></div>
                                <div class="mt-auto pt-2">
                                    <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                                        <div class="flex items-center space-x-2">
                                           <label for="notepad-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1">Modelo IA:</label>
                                            <div class="model-selector-wrapper">
                                               <select id="notepad-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                                    <option value="gpt-3.5-turbo-1106">Tutor General</option>
                                                    <option value="sonar">Búsqueda Web</option>
                                                    <option value="gpt-4o" class="goat-x-pro-model">Tutor Avanzado</option>
                                                </select>
                                                 <i class="fas fa-chevron-down text-xs"></i>
                                           </div>
                                        </div>
                                   </div>
                                    <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                        <textarea id="notepad-msg" placeholder="Pide resúmenes, ideas, correcciones..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm"></textarea>
                                        <button id="notepad-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="financial-assistant-view" class="hidden h-full"></div>
                
                <div id="project-management-view" class="hidden p-4 h-full">
                    <div id="project-board-container" class="flex flex-col h-full">
                        <div class="flex flex-wrap justify-between items-center mb-4 flex-shrink-0 gap-2">
                            <h2 id="project-view-title" class="text-2xl font-bold">Nombre del Curso</h2>
                             <div id="project-tag-filter-container" class="relative">
                                <button id="tag-filter-btn" class="p-2 rounded-md bg-input text-sm"><i class="fas fa-tag mr-1"></i> Filtrar Tareas</button>
                                <div id="tag-filter-dropdown" class="hidden absolute right-0 mt-1 p-2 rounded-md shadow-lg w-48"></div>
                             </div>
                        </div>
                         <div class="flex items-center space-x-2 project-view-controls mb-4 flex-shrink-0">
                            <span class="text-sm text-text-medium hidden sm:inline">Vistas del Curso:</span>
                             <button id="view-toggle-kanban" class="px-3 py-1 text-sm rounded-md">Módulos</button>
                            <button id="view-toggle-list" class="px-3 py-1 text-sm rounded-md">Tareas</button>
                            <button id="add-task-list-view-btn" title="Añadir Tarea" class="hidden ml-auto p-2 rounded-md bg-primary text-white"><i class="fas fa-plus"></i></button>
                            <button id="project-calendar-btn" title="Calendario del Curso" class="text-sky-400 hover:text-sky-300 p-2 transition-colors ml-auto"><i class="fas fa-calendar-alt text-xl"></i></button>
                        </div>
                         <div id="kanban-view" class="hidden flex-1">
                            </div>
                        <div id="list-view" class="hidden flex-1 flex-col">
                            </div>
                        <div id="list-view-mobile" class="hidden flex-1 overflow-y-auto">
                            </div>
                    </div>
                    <div id="project-chat-container">
                         <div id="project-chat-container-header" class="flex justify-between items-center cursor-pointer p-2">
                            <h3 class="text-lg font-semibold text-primary">Tutor del Curso</h3>
                            <button id="project-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-up"></i></button>
                        </div>
                         <div class="project-chat-body">
                            <div id="project-chat-messages" class="chat-bubble-bot"></div>
                            <div id="project-input-area" class="mt-auto pt-2">
                                 <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                                     <div class="flex items-center space-x-2">
                                        <label for="project-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1">Modelo IA:</label>
                                         <div class="model-selector-wrapper">
                                            <select id="project-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                                <option value="gpt-3.5-turbo-1106">Tutor General</option>
                                                <option value="sonar">Búsqueda Académica</option>
                                                <option value="gpt-4o" class="goat-x-pro-model">Tutor Avanzado</option>
                                             </select>
                                              <i class="fas fa-chevron-down text-xs"></i>
                                        </div>
                                     </div>
                                </div>
                                 <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                     <textarea id="project-msg" placeholder="Consulta tus dudas sobre el curso..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm"></textarea>
                                    <button id="project-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="input-area" class="p-2 sm:p-4 border-t border-themed flex-shrink-0">
                <div id="file-preview-area" class="mb-2 space-y-2 px-1 sm:px-0">
                     <div id="image-preview-container" class="hidden relative">
                        <img id="image-preview" src="#" alt="Image Preview">
                        <span id="image-name" class="text-xs text-text-medium truncate flex-grow"></span>
                         <button id="clear-image-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                    <div id="pdf-preview-container" class="hidden relative">
                        <i class="fas fa-file-pdf text-red-500 text-xl"></i>
                         <div class="flex-grow min-w-0">
                            <p id="pdf-name" class="font-medium truncate"></p>
                            <p id="pdf-status" class="text-xxs font-mono"></p>
                         </div>
                        <button id="clear-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                </div>
                <div class="pro-controls-bg rounded-lg p-1 cool-light-effect">
                    <div id="pro-controls-left">
                        <label for="model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1" data-translate-key="model">Modelo IA:</label>
                        <div class="model-selector-wrapper">
                            <select id="model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                <option value="gpt-3.5-turbo-1106">Tutor General</option>
                                <option value="sonar">Búsqueda Académica</option>
                                <option value="gpt-4o" class="goat-x-pro-model">Tutor Avanzado</option>
                            </select>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                    <div id="pro-controls-right">
                        <div id="voice-selector-container" class="hidden items-center space-x-2">
                            <label for="voice-selector" class="font-medium text-xs text-text-medium" data-translate-key="voice">Voz:</label>
                            <div class="model-selector-wrapper">
                                <select id="voice-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light w-24"></select>
                            </div>
                        </div>
                        <div id="action-buttons-container" class="flex items-center">
                            <button id="image-gen-btn" title="Generar Esquema Visual" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fas fa-brain text-lg"></i></button>
                            <button id="pdf-upload-btn" title="Subir Tarea (PDF)" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-file-pdf text-lg"></i></button>
                            <button id="image-upload-btn" title="Subir Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-image text-lg"></i></button>
                        </div>
                    </div>
                 </div>
                <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                    <input type="file" id="pdf-upload" accept=".pdf,application/pdf" class="hidden"><input type="file" id="image-upload" accept="image/*" class="hidden">
                    <button id="mic-btn" title="Consulta por Voz" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-microphone text-xl"></i></button>
                     <button id="tts-toggle" title="Activar/Desactivar Voz" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-volume-mute text-xl"></i></button>
                    <textarea id="msg" placeholder="Escribe tu consulta al Tutor IA..." class="flex-1 bg-transparent p-2 h-12 max-h-32 resize-none outline-none placeholder-themed" rows="1" data-translate-key="placeholder_main"></textarea>
                    <button id="send" title="Enviar" class="p-2 sm:p-4 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i id="send-icon" class="fa fa-paper-plane text-xl"></i></button>
                 </div>
                <div id="contextual-footer" class="text-center text-xs text-text-medium mt-2 px-2 h-4"></div>
            </div>
        </main>
    </div>

    <div id="in-app-notification">
        <div id="in-app-notification-header">
            <h4 id="in-app-notification-title"></h4>
            <button id="in-app-notification-close" class="text-text-medium hover:text-text-light text-2xl leading-none">&times;</button>
        </div>
        <p id="in-app-notification-body"></p>
    </div>

    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <div id="modal-body" class="mb-4 text-text-medium text-sm"></div>
            <div id="modal-buttons-container" class="flex justify-end space-x-2">
                 </div>
        </div>
    </div>
    <div id="motivation-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative text-center">
            <i class="fas fa-lightbulb text-4xl text-yellow-400 mb-4"></i>
            <h3 id="motivation-title" class="text-2xl mb-4">Dosis de Estudio</h3>
            <p id="motivation-quote" class="text-lg text-text-light mb-6 min-h-[50px]"></p>
            <div class="flex items-center justify-center mb-6">
                <label for="motivation-toggle" class="flex items-center cursor-pointer">
                    <span class="mr-3 text-text-light font-medium">
                        Recordatorios de estudio
                    </span>
                    <div class="relative">
                        <input type="checkbox" id="motivation-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                    </div>
                </label>
            </div>
            <button id="close-motivation-modal" class="btn-primary px-6 py-2 rounded-lg">¡A estudiar!</button>
        </div>
    </div>
    
    <div id="pricing-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-5xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-6">
                <h2 class="text-3xl md:text-4xl font-extrabold text-center flex-grow" data-translate-key="plans_title">Planes Educativos IBERO</h2>
                 <button id="close-pricing-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="modal-content-body flex-grow overflow-y-auto px-2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-text-light">
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">Básico</h3>
                        <p class="text-5xl font-extrabold my-3">Gratis</p>
                        <p class="text-sm text-text-medium mb-4" data-translate-key="plan_free_sub">Acceso limitado</p>
                         <ul class="text-sm space-y-2 mb-4 text-left">
                            <li><i class="fas fa-check-circle mr-2"></i>Acceso a 1 curso de inducción</li>
                            <li><i class="fas fa-check-circle mr-2"></i>Uso limitado del Tutor IA General</li>
                             <li><i class="fas fa-check-circle mr-2"></i>Calendario de tareas</li>
                        </ul>
                        <button id="free-plan-button" class="mt-auto w-full p-3 rounded-lg font-semibold border-2 border-primary text-primary hover:bg-primary hover:text-white transition-colors" data-translate-key="plan_free_cta">Tu Plan Actual</button>
                     </div>
                    <div class="plan-card border-2 rounded-xl p-6 flex flex-col bg-current-bg-dark plan-card-highlight">
                        <h3 class="text-2xl font-bold">Estudiante <span class="text-primary">PRO</span></h3>
                         <p class="text-5xl font-extrabold my-3">$25<span class="text-lg font-medium text-text-medium">/mes</span></p>
                        <button class="w-full p-2 text-sm rounded-lg font-semibold border border-primary text-primary hover:bg-primary hover:text-white transition-colors mb-4 plan-details-toggle">Ver Detalles</button>
                        <div class="plan-details text-sm text-left">
                             <ul class="space-y-2 mb-4 plan-feature-list">
                                <li><i class="fas fa-check-circle mr-2"></i><strong>Acceso a todos tus cursos inscritos</strong></li>
                                <li><i class="fas fa-check-circle mr-2"></i>Acceso a <strong>Tutor IA General y Académico</strong></li>
                                 <li><i class="fas fa-check-circle mr-2"></i><strong>Gamificación completa y recompensas</strong></li>
                                <li><i class="fas fa-check-circle mr-2"></i>Soporte Prioritario</li>
                            </ul>
                         </div>
                        <button data-plan="boost" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_boost_cta">Seleccionar Plan</button>
                    </div>
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">Profesional <span class="text-primary">PLUS</span></h3>
                        <p class="text-5xl font-extrabold my-3">$45<span class="text-lg font-medium text-text-medium">/mes</span></p>
                         <button class="w-full p-2 text-sm rounded-lg font-semibold border border-primary text-primary hover:bg-primary hover:text-white transition-colors mb-4 plan-details-toggle">Ver Detalles</button>
                        <div class="plan-details text-sm text-left">
                            <ul class="space-y-2 mb-4 plan-feature-list">
                                 <li><i class="fas fa-check-circle mr-2"></i><strong>Todo lo del plan PRO</strong></li>
                                <li><i class="fas fa-check-circle mr-2"></i>Acceso a <strong>Tutor IA Avanzado (GPT-4o)</strong></li>
                                <li><i class="fas fa-check-circle mr-2 text-gold"></i><strong>Certificados Digitales Verificables</strong></li>
                                 <li><i class="fas fa-check-circle mr-2"></i>Acceso a Biblioteca Premium</li>
                                <li><i class="fas fa-check-circle mr-2"></i>Consultoría Académica IA</li>
                            </ul>
                         </div>
                        <button data-plan="pro" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_pro_cta">Obtener Plan Plus</button>
                    </div>
                </div>
             </div>
        </div>
    </div>

    <div id="html-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4"><div class="modal-content rounded-2xl w-full h-full max-w-4xl p-2 md:p-4 relative flex flex-col"><h3 class="text-lg font-bold" data-translate-key="preview">Vista Previa de Proyecto</h3><button id="close-html-preview-modal" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button></div><iframe id="html-preview-iframe" class="w-full flex-grow h-full border-2 border-themed rounded-lg bg-white"></iframe></div>
    
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-lg p-6 relative">
             <h3 class="text-lg font-bold mb-4" data-translate-key="settings">Configuración de la Cuenta</h3>
            <div class="space-y-4 text-sm max-h-[70vh] overflow-y-auto pr-2">
                <div>
                    <p class="font-semibold" data-translate-key="settings_email">Correo Electrónico:</p>
                    <p id="settings-user-email" class="text-text-medium"></p>
                 </div>
                <div>
                    <p class="font-semibold" data-translate-key="settings_plan">Mi Plan Educativo:</p>
                    <p id="settings-user-plan" class="text-text-medium"></p>
                    <button id="settings-upgrade-plan-btn" class="text-primary hover:underline mt-1 text-xs" data-translate-key="upgrade_plan">Mejorar Plan</button>
                 </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_fontsize">Tamaño de Letra:</p>
                    <input type="range" id="font-size-slider" min="14" max="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg dark:bg-gray-700">
                    <span id="font-size-value" class="text-xs text-text-medium">16px</span>
                </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_theme">Apariencia:</p>
                    <button id="settings-theme-toggle" class="flex items-center p-2 rounded hover:bg-medium w-full text-left">
                         <i class="fas fa-moon mr-2" id="settings-theme-icon"></i>
                        <span data-translate-key="settings_dark_mode">Modo Oscuro</span>
                    </button>
                </div>
                <div>
                     <div class="flex items-center justify-between">
                        <p class="font-semibold" data-translate-key="settings_notifications">Notificaciones de Tareas:</p>
                        <label for="notifications-toggle" class="inline-flex relative items-center cursor-pointer">
                            <input type="checkbox" id="notifications-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                 </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_lang">Idioma:</p>
                    <select id="language-selector" class="w-full p-2 rounded bg-input border border-themed">
                         <option value="es">Español</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="border-t border-themed pt-4 mt-4">
                     <h4 class="font-semibold mb-2" data-translate-key="settings_integrations">Integraciones</h4>
                     <div class="space-y-2">
                        <button id="connect-google-calendar-btn" class="w-full bg-input p-2 rounded-lg flex items-center justify-start text-left hover:bg-light transition-colors">
                             <i class="fab fa-google mr-3 text-red-500 fa-lg"></i>
                            <div>
                                <span class="font-semibold">Google Calendar</span>
                                 <p class="text-xs text-text-medium">Sincroniza tus tareas y fechas de entrega.</p>
                            </div>
                        </button>
                        </div>
                </div>
                <div>
                    <button id="connect-whatsapp-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center mb-2">
                         <i class="fab fa-whatsapp mr-2"></i><span data-translate-key="settings_whatsapp">Contactar Soporte Estudiantil</span>
                    </button>
                    <a href="https://calendly.com/goatify" target="_blank" id="schedule-meeting-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar-alt mr-2"></i><span data-translate-key="settings_schedule_meeting">Agendar Asesoría</span>
                     </a>
                </div>
            </div>
            <button id="close-settings-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>

    <div id="calendar-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div id="calendar-modal" class="modal-content rounded-lg w-full max-w-4xl p-6 relative">
             <h3 class="text-lg font-bold mb-4" data-translate-key="calendar_my_calendar">Mi Calendario y Tareas</h3>
            <div class="calendar-view-toggle mb-4">
                <button id="day-view-btn" data-translate-key="calendar_day_view">Vista de Día</button>
                <button id="week-view-btn" data-translate-key="calendar_week_view">Vista de Semana</button>
                <button id="month-view-btn" class="active" data-translate-key="calendar_month_view">Vista de Mes</button>
             </div>

            <div id="day-view-container">
                 <div class="calendar-header">
                    <button id="prev-day" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-day-display" class="text-xl font-semibold"></h4>
                     <button id="next-day" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="day-view-timeline"></div>
            </div>

            <div id="week-view-container">
                <div class="calendar-header">
                     <button id="prev-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-week-range" class="text-xl font-semibold"></h4>
                    <button id="next-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                 <div id="week-days-content"></div>
            </div>

            <div id="month-view-container">
                <div class="calendar-header">
                    <button id="prev-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-month-year" class="text-xl font-semibold"></h4>
                     <button id="next-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid mb-4">
                    <div class="font-bold text-primary" data-translate-key="calendar_mon">Lun</div>
                     <div class="font-bold text-primary" data-translate-key="calendar_tue">Mar</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_wed">Mié</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_thu">Jue</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_fri">Vie</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_sat">Sáb</div>
                     <div class="font-bold text-primary" data-translate-key="calendar_sun">Dom</div>
                </div>
                <div id="calendar-days-grid" class="calendar-grid"></div>
            </div>

            <div class="mt-6 border-t border-themed pt-4">
                <button id="add-task-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i><span data-translate-key="calendar_add_task_btn">Añadir Tarea o Recordatorio</span>
                </button>
            </div>

            <button id="close-calendar-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>
    
    <div id="task-notification-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-[110] p-4">
        <div class="modal-content text-center rounded-lg w-full max-w-md p-8 relative">
            <h3 id="task-notification-title" class="text-2xl font-bold mb-4"></h3>
            <div id="task-notification-body" class="text-lg text-text-light mb-8"></div>
            <button id="task-notification-close-btn" class="btn-primary px-8 py-3 rounded-lg font-semibold">Entendido</button>
        </div>
    </div>


    <div id="gamification-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-4">
                <h2 class="text-3xl font-extrabold text-gold">
                    <i class="fas fa-trophy mr-2"></i>Mi Progreso Académico </h2>
                <button id="close-gamification-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>
            
            <div class="p-4 bg-input rounded-lg mb-4 flex-shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <span id="gamification-level-name" class="font-bold text-xl text-text-light">Nivel 1: Novato Curioso</span>
                    <div class="text-right">
                        <span id="gamification-xp" class="font-bold text-primary">0 / 250 XP</span>
                         <p id="gamification-credits" class="text-sm text-gold font-semibold"><i class="fas fa-coins mr-1"></i>0 Puntos IA</p>
                    </div>
                </div>
                <div class="w-full xp-bar-bg rounded-full h-4">
                    <div id="gamification-xp-bar" class="xp-bar-fill h-4 rounded-full" style="width: 0%;"></div>
                 </div>
            </div>

            <div class="flex-grow overflow-hidden flex flex-col">
                <div class="flex-shrink-0 gamification-tabs flex items-center space-x-2">
                    <button class="gamification-tab active" data-tab="racha">Racha de Estudio</button>
                     <button class="gamification-tab" data-tab="misiones">Misiones Académicas</button>
                    <button class="gamification-tab" data-tab="logros">Logros</button>
                    <button id="gamification-rules-btn" class="ml-auto text-sm text-text-medium hover:text-primary"><i class="fas fa-circle-question mr-1"></i> Reglas</button>
                </div>
                <div class="flex-grow overflow-y-auto pt-4">
                     <div id="gamification-tab-racha" class="gamification-tab-content space-y-4">
                        <p class="text-center text-text-medium">Mantén tu racha de estudio para ganar XP, Puntos IA y un premio especial el día 7.</p>
                         <div id="daily-streak-container" class="grid grid-cols-7 gap-2 md:gap-4 text-center">
                            </div>
                    </div>
                     <div id="gamification-tab-misiones" class="gamification-tab-content hidden space-y-3">
                        </div>
                     <div id="gamification-tab-logros" class="gamification-tab-content hidden">
                        <div id="achievements-container" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                           </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="gamification-rules-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-[60] p-4">
         <div class="modal-content rounded-lg w-full max-w-2xl p-6 relative">
            <h3 class="text-lg font-bold mb-4 text-gold"><i class="fas fa-scroll mr-2"></i>Reglas del Progreso Académico</h3>
            <div class="space-y-4 text-text-medium text-sm max-h-[70vh] overflow-y-auto pr-2">
                <p>¡Bienvenido a tu ruta de conocimiento en IBERO! La dinámica es simple: cuanto más participas y aprendes, más recompensas desbloqueas.</p>
                <div>
                    <h4 class="font-semibold text-text-light mt-3">1. Puntos de Experiencia (XP) vs. Puntos IA (🪙)</h4>
                    <p>Existen dos tipos de recompensas:</p>
                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li><strong>Puntos de Experiencia (XP):</strong> Miden tu progreso y avance académico. El XP <strong class="text-primary">nunca se gasta</strong>, solo se acumula para que subas de nivel y obtengas nuevos reconocimientos.</li>
                        <li><strong>Puntos IA (🪙):</strong> Son una <strong class="text-gold">reserva de créditos</strong> que ganas al completar misiones y rachas. Se usan para acceder a las funciones del Tutor IA Avanzado.</li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-semibold text-text-light mt-3">2. Cómo Subir de Nivel</h4>
                    <p>Acumula XP para ascender de nivel. Cada nivel representa una nueva etapa en tu dominio de la materia.</p>
                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li>Nivel 1: <strong>Novato Curioso</strong></li>
                        <li>Nivel 2: <strong>Estudiante Dedicado</strong></li>
                         <li>Nivel 3: <strong>Erudito</strong></li>
                        <li>Nivel 4: <strong>Maestro</strong></li>
                        <li>Nivel 5: <strong>Sabio Iberoamericano</strong></li>
                    </ul>
                </div>
                  <div>
                    <h4 class="font-semibold text-text-light mt-3">3. Cómo Ganar Recompensas</h4>
                     <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li><strong>Racha de Estudio:</strong> Cada día consecutivo que ingresas y completas una actividad te da XP y Puntos IA.</li>
                        <li><strong>Recompensa Semanal (Día 7):</strong> ¡Tu gran premio por 7 días de racha! Puede contener una gran cantidad de Puntos IA o cupones de descuento para futuros cursos.</li>
                        <li><strong>Misiones y Logros:</strong> La forma más rápida de ganar bonificaciones. Completa tareas específicas (entregar un trabajo, participar en un foro) para acelerar tu progreso.</li>
                    </ul>
                </div>
                 <p class="font-bold text-center mt-4 text-lg text-primary">¡Cada lección cuenta en tu camino hacia el éxito! ¡A por ello!</p>
            </div>
            <button id="close-gamification-rules-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        //<-- START OF SCRIPT -->
        window.addEventListener('DOMContentLoaded', () => {
            dayjs.extend(window.dayjs_plugin_localizedFormat);
            dayjs.extend(window.dayjs_plugin_isoWeek);
             
            // Objeto de traducciones adaptado para el LMS
            const translations = {
                es: {
                    initializing: "Iniciando Aula Virtual...", new_chat: "Nueva Consulta al Tutor", new_folder: "Nuevo Curso",
                    upgrade_plan: "Mejorar Plan", free_guides: "Biblioteca Digital", workflows: "Herramientas de Estudio",
                    wf_pm: "Gestor de Proyectos de Estudio", wf_pm_1: "Crear Tablero de Proyecto",
                    wf_social: "Asistente de Redacción", wf_social_1: "Redactar Ensayo", wf_social_2: "Revisar Ortografía y Estilo",
                    wf_social_3: "Lluvia de Ideas para Tesis", wf_social_4: "Definir Estructura de Trabajo",
                    wf_business: "Análisis de Documentos", wf_business_1: "Analizar PDF", wf_business_2: "Interpretar Gráfico",
                    wf_business_3: "Resumir Texto Largo", wf_sales: "Habilidades de Comunicación", wf_sales_1: "Preparar una Presentación",
                    wf_sales_2: "Redacción de Email Formal", wf_sales_3: "Estructurar un Debate", wf_sales_4: "Mejorar Oratoria",
                    wf_eng_1: "Traducir/Corregir Texto",
                    wf_eng_2: "Aprender Vocabulario Técnico", wf_eng_3: "Practicar Conversación", select_chats: "Seleccionar Múltiples",
                    delete: "Borrar", login: "Iniciar Sesión", settings: "Configuración", logout: "Cerrar Sesión",
                    solutions: "Recursos", ally_title: "Recursos Adicionales",
                    ally_desc: "Accede a la biblioteca, soporte técnico y otros servicios de la institución.",
                    welcome_user: "¡Hola, ", welcome_user_2: "! Listo para un nuevo día de aprendizaje.",
                    welcome_guest: "¿En qué te puedo ayudar hoy?", model: "Modelo IA:", model_general: "Tutor General",
                    model_web: "Búsqueda Académica", voice: "Voz:", placeholder_main: "Escribe tu consulta al Tutor IA...", cancel: "Cancelar",
                    confirm: "Confirmar", plans_title: "Planes Educativos IBERO", plan_free_sub: "Acceso limitado", plan_free_cta: "Plan Actual",
                    plan_boost_cta: "Seleccionar Plan PRO", plan_pro_cta: "Obtener Plan PLUS",
                    preview: "Vista Previa", settings_email: "Correo Electrónico:", settings_plan: "Mi Plan Educativo:",
                    settings_fontsize: "Tamaño de Letra:", settings_theme: "Apariencia:", settings_dark_mode: "Modo Oscuro",
                    settings_lang: "Idioma:", settings_whatsapp: "Soporte Estudiantil", current_plan: "Tu Plan Actual",
                    settings_notifications: "Notificaciones de Tareas:", settings_schedule_meeting: "Agendar Asesoría",
                    settings_integrations: "Integraciones",
                    calendar_today: "Hoy", calendar_this_week: "Esta Semana", calendar_mon: "Lun", calendar_tue: "Mar", calendar_wed: "Mié",
                    calendar_thu: "Jue", calendar_fri: "Vie", calendar_sat: "Sáb", calendar_sun: "Dom",
                    calendar_no_tasks: "No hay tareas para este día.", calendar_add_task_placeholder: "Añadir nueva tarea o recordatorio...",
                    calendar_add_task_btn: "Añadir Tarea", calendar_my_calendar: "Mi Calendario y Tareas",
                    calendar_day_view: "Vista de Día", calendar_month_view: "Vista de Mes", calendar_week_view: "Vista de Semana",
                    notification_task_due: "Recordatorio de Tarea: ", notification_title: "Aula Virtual IBERO - Tarea Pendiente",
                    tasks_for: "Tareas para", add_task_for: "Añadir Tarea para",
                    delete_task_confirm_title: "Confirmar Eliminación", delete_task_confirm_body: "¿Estás seguro de que quieres eliminar esta tarea?",
                    delete_btn: "Eliminar",
                    share_note: "Compartir Apunte",
                    share_note_desc: "Ingresa el email del compañero con quien quieres compartir este apunte.",
                    share_note_email_placeholder: "email@compañero.com",
                    share_note_info: "Nota: La colaboración en tiempo real requiere que ambos usuarios tengan un plan Estudiante PRO o superior.",
                    share_note_button: "Compartir",
                },
                en: {
                    initializing: "Initializing Virtual Classroom...", new_chat: "New Tutor Query", new_folder: "New Course",
                    upgrade_plan: "Upgrade Plan", free_guides: "Digital Library", workflows: "Study Tools",
                    wf_pm: "Study Project Manager", wf_pm_1: "Create Project Board",
                    wf_social: "Writing Assistant", wf_social_1: "Write an Essay", wf_social_2: "Check Spelling & Style",
                    wf_social_3: "Brainstorm for Thesis", wf_social_4: "Define Paper Structure",
                    wf_business: "Document Analysis", wf_business_1: "Analyze PDF", wf_business_2: "Interpret Chart",
                    wf_business_3: "Summarize Long Text", wf_sales: "Communication Skills", wf_sales_1: "Prepare a Presentation",
                    wf_sales_2: "Write Formal Email", wf_sales_3: "Structure a Debate", wf_sales_4: "Improve Oratory",
                    wf_eng_1: "Translate/Correct Text",
                    wf_eng_2: "Learn Technical Vocabulary", wf_eng_3: "Practice Conversation", select_chats: "Select Multiple",
                    delete: "Delete", login: "Login", settings: "Settings", logout: "Logout",
                    solutions: "Resources", ally_title: "Additional Resources",
                    ally_desc: "Access the library, technical support, and other institutional services.",
                    welcome_user: "Hello, ", welcome_user_2: "! Ready for a new day of learning.",
                    welcome_guest: "How can I help you today?", model: "AI Model:", model_general: "General Tutor",
                    model_web: "Academic Search", voice: "Voice:", placeholder_main: "Type your query to the AI Tutor...", cancel: "Cancel",
                    confirm: "Confirm", plans_title: "IBERO Educational Plans", plan_free_sub: "Limited Access", plan_free_cta: "Current Plan",
                    plan_boost_cta: "Select PRO Plan", plan_pro_cta: "Get PLUS Plan",
                    preview: "Preview", settings_email: "Email Address:", settings_plan: "My Educational Plan:",
                    settings_fontsize: "Font Size:", settings_theme: "Appearance:", settings_dark_mode: "Dark Mode",
                    settings_lang: "Language:", settings_whatsapp: "Student Support", current_plan: "Current Plan",
                    settings_notifications: "Task Notifications:", settings_schedule_meeting: "Schedule Advising",
                    settings_integrations: "Integrations",
                    calendar_today: "Today", calendar_this_week: "This Week", calendar_mon: "Mon", calendar_tue: "Tue", calendar_wed: "Wed",
                    calendar_thu: "Thu", calendar_fri: "Fri", calendar_sat: "Sat", calendar_sun: "Sun",
                    calendar_no_tasks: "No tasks for this day.", calendar_add_task_placeholder: "Add new task or reminder...",
                    calendar_add_task_btn: "Add Task", calendar_my_calendar: "My Calendar & Tasks",
                    calendar_day_view: "Day View", calendar_month_view: "Month View", calendar_week_view: "Week View",
                    notification_task_due: "Task Reminder: ", notification_title: "IBERO Virtual Classroom - Task Due!",
                    tasks_for: "Tasks for", add_task_for: "Add Task for",
                    delete_task_confirm_title: "Confirm Deletion", delete_task_confirm_body: "Are you sure you want to delete this task?",
                    delete_btn: "Delete",
                    share_note: "Share Notes",
                    share_note_desc: "Enter the email of the classmate you want to share these notes with.",
                    share_note_email_placeholder: "classmate@email.com",
                    share_note_info: "Note: Real-time collaboration requires both users to have a Student PRO plan or higher.",
                    share_note_button: "Share",
                }
            };
            // Límites de uso de IA
            const GUEST_CREDIT_LIMIT = 10;
            const FREE_PLAN_CREDIT_LIMIT = 50;
            const BOOST_PLAN_CREDIT_LIMIT = 500;
            const PRO_PLAN_CREDIT_LIMIT = 2000;

            // Mensajes de motivación para estudiantes
            const MOTIVATIONAL_MESSAGES = [
                "La disciplina es el puente entre tus metas y tus logros. ¡Sigue adelante!",
                "No te detengas hasta que te sientas orgulloso de lo que has aprendido.",
                "Cada página leída es un paso más hacia la cima del conocimiento.",
                "Tu potencial es infinito. ¡Cree en tu capacidad para aprender y crecer!",
                "La educación es el arma más poderosa que puedes usar para cambiar el mundo.",
                "El éxito es la suma de pequeños esfuerzos repetidos día tras día. ¡Tu esfuerzo de hoy cuenta!",
                "No importa lo lento que vayas, siempre y cuando no te detengas. ¡Cada concepto cuenta!",
                "Confía en tu proceso. Estás construyendo una versión más sabia de ti mismo."
            ];
            const MOTIVATION_BUTTON_TEXTS = ["¡Entendido!", "¡A estudiar!", "¡Perfecto!", "¡Claro que sí!", "¡Vamos!", "¡A por ello!"];

            // Costos de uso de los modelos de IA
            const COSTS = { 
                GENERAL: 1, 
                SEARCH: 2, 
                WORKFLOW: 2,
                PDF_ANALYSIS: 5,  // Analizar un PDF requiere más procesamiento
                IMAGE_ANALYSIS: 5,
                IMAGE_GENERATION: 10,
                GPT4O: 3 
            };
            // Estructura de estado principal para el LMS
            let state = { chats: {}, projects: {}, structure: [], calendar: {}, notes: [] };
            let gamificationState = {};
            let currentChatId = null, currentUser = null, speechOn = false, availableVoices = [], selectedVoice = null, isRecognizing = false, selectedImageBase64 = null, selectedPdfText = null;
            let micWasOnBeforeSpeaking = false;
            let modalResolve = null;
            let modalKeydownHandler = null;
            let isSelectModeActive = false;
            let chatsToDelete = new Set();
            let currentNoteId = null;
            let goatXProUsage = 0;
            const GOAT_X_PRO_DAILY_LIMIT = 15; // Límite para el Tutor Avanzado

            let notificationsEnabled = localStorage.getItem('ibero-notifications-enabled') === null ? true : localStorage.getItem('ibero-notifications-enabled') === 'true';
            let motivationEnabled = localStorage.getItem('ibero-motivation-enabled') === null ? true : localStorage.getItem('ibero-motivation-enabled') === 'true';

            let selectedCalendarDate = dayjs();
            let currentCalendarView = 'month';
            let activeTagFilter = null;
            let motivationInterval = null;
            const dom = {};
            
            const fullDom = {
                appContainer: document.getElementById('app-container'),
                msgInput: document.getElementById('msg'), sendBtn: document.getElementById('send'),
                inputArea: document.getElementById('input-area'),
                filePreviewArea: document.getElementById('file-preview-area'),
                messageCounterWrapper: document.getElementById('message-counter-wrapper'), 
                planCreditsInfo: document.getElementById('plan-credits-info'),
                rewardCreditsInfo: document.getElementById('reward-credits-info'),
                upgradePlanContainer: document.getElementById('upgrade-plan-container'),
                upgradePlanBtn: document.getElementById('upgrade-plan-btn'),
                newChatBtn: document.getElementById('new-chat-btn'), newFolderBtn: document.getElementById('new-folder-btn'),
                pricingModal: document.getElementById('pricing-modal'), closePricingModalBtn: document.getElementById('close-pricing-modal'),
                genericModal: document.getElementById('generic-modal'), 
                viewContainer: document.getElementById('view-container'),
                chatMessages: document.getElementById('chat-messages'),
                notepadViewContainer: document.getElementById('notepad-view-container'),
                chatTitle: document.getElementById('chat-title'), mobileChatTitle: document.getElementById('mobile-chat-title'),
                desktopChatTitleWrapper: document.getElementById('desktop-chat-title-wrapper'), mobileChatTitleWrapper: document.getElementById('mobile-chat-title-wrapper'),
                initialMessageContainer: document.getElementById('initial-message-container'), themeToggle: document.getElementById('theme-toggle'), themeIcon: document.getElementById('theme-icon'),
                micBtn: document.getElementById('mic-btn'), ttsToggle: document.getElementById('tts-toggle'), 
                modelSelector: document.getElementById('model-selector'),
                actionButtonsContainer: document.getElementById('action-buttons-container'),
                imageUploadBtn: document.getElementById('image-upload-btn'), imageUploadInput: document.getElementById('image-upload'),
                imagePreviewContainer: document.getElementById('image-preview-container'), imagePreview: document.getElementById('image-preview'),
                clearImageBtn: document.getElementById('clear-image-btn'), pdfUploadBtn: document.getElementById('pdf-upload-btn'), pdfUploadInput: document.getElementById('pdf-upload'),
                pdfPreviewContainer: document.getElementById('pdf-preview-container'), pdfNameEl: document.getElementById('pdf-name'), pdfStatusEl: document.getElementById('pdf-status'), clearPdfBtn: document.getElementById('clear-pdf-btn'),
                sidebar: document.getElementById('sidebar'), menuToggle: document.getElementById('menu-toggle'), sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarContent: document.getElementById('sidebar-content'), loginView: document.getElementById('login-view'), userMenuView: document.getElementById('user-menu-view'),
                loginBtn: document.getElementById('login-btn'), userMenuBtn: document.getElementById('user-menu-btn'), userMenuPopup: document.getElementById('user-menu-popup'), userEmail: document.getElementById('user-email'),
                logoutBtn: document.getElementById('logout-btn'), webLaunchOfferBtn: document.getElementById('web-launch-offer-btn'),
                workflowsContainer: document.getElementById('workflows-container'), freeGuidesLink: document.getElementById('free-guides-link'),
                personalizedWelcome: document.getElementById('personalized-welcome'), genericWelcome: document.getElementById('generic-welcome'), userName: document.getElementById('user-name'),
                loadingOverlay: document.getElementById('loading-overlay'), htmlPreviewModal: document.getElementById('html-preview-modal'),
                closeHtmlPreviewModalBtn: document.getElementById('close-html-preview-modal'), htmlPreviewIframe: document.getElementById('html-preview-iframe'),
                voiceSelector: document.getElementById('voice-selector'), 
                voiceSelectorContainer: document.getElementById('voice-selector-container'),
                selectChatsBtn: document.getElementById('select-chats-btn'), deleteModeControls: document.getElementById('delete-mode-controls'),
                deleteSelectedBtn: document.getElementById('delete-selected-btn'), cancelSelectModeBtn: document.getElementById('cancel-select-mode-btn'),
                imageGenBtn: document.getElementById('image-gen-btn'), servicesMenuBtn: document.getElementById('services-menu-btn'), servicesMenu: document.getElementById('services-menu'),
                contextualFooter: document.getElementById('contextual-footer'),
                newChatIconBtn: document.getElementById('new-chat-icon-btn'),
                newFolderIconBtn: document.getElementById('new-folder-icon-btn'), 
                settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'), closeSettingsModal: document.getElementById('close-settings-modal'),
                settingsUserEmail: document.getElementById('settings-user-email'), settingsUserPlan: document.getElementById('settings-user-plan'),
                settingsUpgradePlanBtn: document.getElementById('settings-upgrade-plan-btn'), fontSizeSlider: document.getElementById('font-size-slider'),
                fontSizeValue: document.getElementById('font-size-value'), settingsThemeToggle: document.getElementById('settings-theme-toggle'),
                settingsThemeIcon: document.getElementById('settings-theme-icon'), languageSelector: document.getElementById('language-selector'),
                connectWhatsappBtn: document.getElementById('connect-whatsapp-btn'), scheduleMeetingBtn: document.getElementById('schedule-meeting-btn'), freePlanButton: document.getElementById('free-plan-button'),
                notificationsToggle: document.getElementById('notifications-toggle'),
                mainChatArea: document.getElementById('main-chat-area'),
                calendarModalOverlay: document.getElementById('calendar-modal-overlay'),
                calendarModal: document.getElementById('calendar-modal'),
                calendarBtn: document.getElementById('calendar-btn'),
                closeCalendarModal: document.getElementById('close-calendar-modal'),
                prevMonthBtn: document.getElementById('prev-month'), nextMonthBtn: document.getElementById('next-month'),
                currentMonthYear: document.getElementById('current-month-year'), calendarDaysGrid: document.getElementById('calendar-days-grid'),
                addTaskBtn: document.getElementById('add-task-btn'),
                notificationBadge: document.getElementById('notification-badge'),
                inAppNotification: document.getElementById('in-app-notification'), 
                inAppNotificationTitle: document.getElementById('in-app-notification-title'),
                inAppNotificationBody: document.getElementById('in-app-notification-body'),
                inAppNotificationClose: document.getElementById('in-app-notification-close'),
                taskNotificationModal: document.getElementById('task-notification-modal'),
                taskNotificationTitle: document.getElementById('task-notification-title'),
                taskNotificationBody: document.getElementById('task-notification-body'),
                taskNotificationCloseBtn: document.getElementById('task-notification-close-btn'),
                monthViewContainer: document.getElementById('month-view-container'), weekViewContainer: document.getElementById('week-view-container'),
                dayViewContainer: document.getElementById('day-view-container'),
                monthViewBtn: document.getElementById('month-view-btn'), weekViewBtn: document.getElementById('week-view-btn'), dayViewBtn: document.getElementById('day-view-btn'),
                prevWeekBtn: document.getElementById('prev-week'), nextWeekBtn: document.getElementById('next-week'),
                currentWeekRange: document.getElementById('current-week-range'), weekDaysContent: document.getElementById('week-days-content'),
                prevDayBtn: document.getElementById('prev-day'), nextDayBtn: document.getElementById('next-day'),
                currentDayDisplay: document.getElementById('current-day-display'), dayViewTimeline: document.getElementById('day-view-timeline'),
                projectManagementView: document.getElementById('project-management-view'),
                projectBoardContainer: document.getElementById('project-board-container'),
                projectChatContainer: document.getElementById('project-chat-container'),
                projectChatToggle: document.getElementById('project-chat-toggle'),
                projectChatHeader: document.getElementById('project-chat-container-header'),
                projectViewTitle: document.getElementById('project-view-title'),
                kanbanView: document.getElementById('kanban-view'),
                listView: document.getElementById('list-view'),
                listViewMobile: document.getElementById('list-view-mobile'),
                viewToggleKanban: document.getElementById('view-toggle-kanban'),
                viewToggleList: document.getElementById('view-toggle-list'),
                addTaskListViewBtn: document.getElementById('add-task-list-view-btn'),
                projectChatMessages: document.getElementById('project-chat-messages'),
                projectMsgInput: document.getElementById('project-msg'),
                projectSendBtn: document.getElementById('project-send'),
                projectCalendarBtn: document.getElementById('project-calendar-btn'),
                tagFilterBtn: document.getElementById('tag-filter-btn'),
                tagFilterDropdown: document.getElementById('tag-filter-dropdown'),
                financialAssistantView: document.getElementById('financial-assistant-view'),
                gamificationBtn: document.getElementById('gamification-btn'),
                gamificationModal: document.getElementById('gamification-modal'),
                closeGamificationModal: document.getElementById('close-gamification-modal'),
                gamificationLevelName: document.getElementById('gamification-level-name'),
                gamificationXp: document.getElementById('gamification-xp'),
                gamificationCredits: document.getElementById('gamification-credits'),
                gamificationXpBar: document.getElementById('gamification-xp-bar'),
                dailyStreakContainer: document.getElementById('daily-streak-container'),
                missionsContainer: document.getElementById('gamification-tab-misiones'),
                achievementsContainer: document.getElementById('achievements-container'),
                gamificationRulesBtn: document.getElementById('gamification-rules-btn'),
                gamificationRulesModal: document.getElementById('gamification-rules-modal'),
                closeGamificationRulesModal: document.getElementById('close-gamification-rules-modal'),
                motivationBtnHeader: document.getElementById('motivation-btn-header'),
                motivationBtnMobile: document.getElementById('motivation-btn-mobile'),
                motivationModal: document.getElementById('motivation-modal'),
                motivationTitle: document.getElementById('motivation-title'),
                motivationQuote: document.getElementById('motivation-quote'),
                motivationToggle: document.getElementById('motivation-toggle'),
                closeMotivationModal: document.getElementById('close-motivation-modal'),
                sidebarToggleArrow: document.getElementById('sidebar-toggle-arrow'),
                foldersContainer: document.getElementById('folders-container'),
                
                // Notepad DOM elements
                notesListPanel: document.getElementById('notes-list-panel'),
                notesListHeader: document.getElementById('notes-list-header'),
                noteEditorPanel: document.getElementById('note-editor-panel'),
                noteTitleInput: document.getElementById('note-title-input'),
                noteEditorToolbar: document.getElementById('note-editor-toolbar'),
                textTools: document.getElementById('text-tools'),
                drawingTools: document.getElementById('drawing-tools'),
                deleteNoteBtn: document.getElementById('delete-note-btn'),
                shareNoteBtn: document.getElementById('share-note-btn'),
                addChecklistItemBtn: document.getElementById('add-checklist-item-btn'),
                noteContentArea: document.getElementById('note-content-area'),
                noteContentEditor: document.getElementById('note-content-editor'),
                noteCanvas: document.getElementById('note-canvas'),
                addNewNoteBtn: document.getElementById('add-new-note-btn'),
                addNewDrawingBtn: document.getElementById('add-new-drawing-btn'),
                noteBackBtn: document.getElementById('note-back-btn'),
                notepadChatContainer: document.getElementById('notepad-chat-container'),
                notepadChatHeader: document.getElementById('notepad-chat-header'),
                notepadChatToggle: document.getElementById('notepad-chat-toggle'),
                notepadChatMessages: document.getElementById('notepad-chat-messages'),
                notepadMsgInput: document.getElementById('notepad-msg'),
                notepadSendBtn: document.getElementById('notepad-send'),
                planCreditsDisplay: document.getElementById('plan-credits-display'),
                rewardCreditsDisplay: document.getElementById('reward-credits-display'),
            };
            Object.assign(dom, fullDom);

            // Niveles de Gamificación Académica
            const XP_FOR_LEVEL = [0, 250, 750, 2000, 5000, Infinity]; 
            const LEVEL_NAMES = ["Novato Curioso", "Estudiante Dedicado", "Erudito", "Maestro", "Sabio Iberoamericano"];
            
            // Misiones Académicas
            const MISSIONS = {
                'first-essay': { id: 'first-essay', text: 'Redacta tu primer ensayo con el asistente', xp: 50, credits: 15, workflow: 'create-full-post' },
                'analyze-pdf': { id: 'analyze-pdf', text: 'Analiza tu primer documento PDF', xp: 50, credits: 15, workflow: 'competitor-analysis' },
                'week-organized': { id: 'week-organized', text: 'Organiza tu semana con una tarea para cada día', xp: 75, credits: 25, condition: checkWeekOrganized },
                'first-course-tasks': { id: 'first-course-tasks', text: 'Crea tu primer curso y añade 3 tareas', xp: 100, credits: 30, condition: (chatId) => checkProjectCreated(chatId, 3) },
                'generate-schema': { id: 'generate-schema', text: 'Genera tu primer esquema visual con IA', xp: 40, credits: 10, action: 'generateImage' },
                'practice-english': { id: 'practice-english', text: 'Practica tu conversación en inglés', xp: 30, credits: 10, workflow: 'english-teacher-practice' },
                'ask-concept': { id: 'ask-concept', text: 'Pidele al tutor que te explique un concepto difícil', xp: 30, credits: 10, workflow: 'conflict-resolution' },
            };

            // Logros Académicos
            const ACHIEVEMENTS = {
                'streak-30': { id: 'streak-30', title: 'Estudiante Consistente', description: 'Mantén la racha de estudio por 30 días.', icon: 'fa-calendar-check', xp: 500, credits: 250 },
                'project-master': { id: 'project-master', title: 'Maestro de Proyectos', description: 'Completa 5 proyectos/trabajos finales.', icon: 'fa-sitemap', xp: 1000, credits: 0, reward: '25% de descuento en un curso futuro.' },
                'essay-writer': { id: 'influencer', title: 'Ensayista Pro', description: 'Genera 10 ensayos o documentos con el asistente.', icon: 'fa-feather-alt', xp: 750, credits: 0, reward: 'Un mes de Plan Estudiante PRO gratis.' },
            };

            function setLanguage(lang) {
                const translationData = translations[lang];
                if (!translationData) return;
                dayjs.locale(lang);
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    if (translationData[key]) {
                        if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') {
                             if(el.placeholder) el.placeholder = translationData[key];
                        } else {
                             const icon = el.querySelector('i');
                            if (icon && el.childNodes.length > 1 && !el.classList.contains('notification-bell-icon') && !el.classList.contains('workflow-header')) {
                                const textNode = document.createTextNode(' ' + translationData[key]);
                                el.innerHTML = '';
                                el.appendChild(icon);
                                el.appendChild(textNode);
                             } else {
                                el.textContent = translationData[key];
                            }
                        }
                     }
                });
                document.documentElement.lang = lang;
                localStorage.setItem('ibero-lang', lang);
                renderCalendarView();
                renderSidebar();
            }
            
            function updateContextualFooter(workflowKey) {
                if (!dom.contextualFooter) return;
                // Textos de ayuda adaptados al LMS
                const workflowTexts = {
                    'create-full-post': 'Modo Ensayo: Define el tema y la longitud para empezar a escribir.',
                    'persuasive-copy': 'Modo Revisor: Pega tu texto para recibir sugerencias de estilo y claridad.',
                    'brand-strategy': 'Modo Estructura: Describe tu trabajo o tesis para obtener un borrador de la estructura.',
                     'competitor-analysis': 'Modo Analista de PDF: Sube un documento para analizarlo.',
                    'sales-assistant': 'Modo Orador: Describe tu presentación para obtener un guion y consejos.',
                    'english-teacher-practice': 'Practice mode: Let\'s talk. How was your day?',
                    'design-web': 'Modo Proyecto Creativo: Describe tu idea y la IA te ayudará a visualizarla.',
                    'project-management': 'Modo Curso: Describe las tareas y la IA las añadirá a tu tablero.',
                    'conflict-resolution': 'Modo Tutor: Describe el concepto que no entiendes y te lo explicaré de otra manera.',
                    'decision-lab': 'Modo Tutor: Haz una consulta sobre cualquier tema académico.',
                    'financial-assistant': 'Modo Finanzas: Usa la tabla para registrar transacciones. Pídeme análisis en el chat.',
                    'notepad-app': 'Modo Apuntes: Organiza tus ideas, todo se guarda automáticamente. Usa el asistente para pedir resúmenes.',
                    'notepad-assistant': 'Asistente de Apuntes: Pide ideas, resúmenes o ayuda para mejorar y corregir la ortografía de tu texto actual.',
                };
                const currentChat = state.chats[currentChatId];
                const key = workflowKey || (currentChat ? currentChat.workflow : (currentChatId === 'notepad-app' ? 'notepad-app' : null));
                dom.contextualFooter.textContent = workflowTexts[key] || 'Tu asistente de estudio personal con IA.';
            }

            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            function showModal({ title, body, confirmText = 'Confirmar', cancelText = 'Cancelar', showCancel = true, showConfirm = true, extraButtons = [], dangerConfirm = false }) {
                const modalTitle = dom.genericModal.querySelector('#modal-title');
                const modalBody = dom.genericModal.querySelector('#modal-body');
                const modalButtonsContainer = dom.genericModal.querySelector('#modal-buttons-container');
                
                modalTitle.innerHTML = title; 
                modalBody.innerHTML = body;
                
                let buttonsHTML = '';
                extraButtons.forEach(btn => {
                    buttonsHTML += `<button id="${btn.id}" class="${btn.classes || 'px-4 py-2 rounded bg-gray-500 text-white'}">${btn.text}</button>`;
                });
                if (showCancel) {
                    buttonsHTML += `<button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded">${cancelText}</button>`;
                }
                if (showConfirm) {
                    const confirmClasses = dangerConfirm ? 'btn-danger' : 'btn-primary';
                    buttonsHTML += `<button id="modal-confirm" class="px-4 py-2 rounded text-white ${confirmClasses}">${confirmText}</button>`;
                }
                modalButtonsContainer.innerHTML = buttonsHTML;

                if (showConfirm) {
                    dom.genericModal.querySelector('#modal-confirm').addEventListener('click', () => {
                        const inputs = modalBody.querySelectorAll('input, textarea, select');
                        const data = {};
                        inputs.forEach(input => {
                            data[input.id] = input.type === 'checkbox' ? input.checked : input.value;
                        });
                        hideModal({ confirmed: true, data });
                    }, { once: true });
                }

                if (showCancel) {
                    dom.genericModal.querySelector('#modal-cancel').addEventListener('click', () => hideModal({ confirmed: false }), { once: true });
                }
                extraButtons.forEach(btn => {
                    dom.genericModal.querySelector(`#${btn.id}`).addEventListener('click', (e) => {
                         btn.action(e, modalBody);
                    });
                });
                
                const confirmButton = dom.genericModal.querySelector('#modal-confirm');
                modalKeydownHandler = (e) => {
                    if (e.key === 'Enter') {
                        if (e.target.tagName !== 'TEXTAREA') {
                            e.preventDefault();
                            if (confirmButton) {
                                confirmButton.click();
                            }
                        }
                    }
                };
                document.addEventListener('keydown', modalKeydownHandler);

                dom.genericModal.classList.remove('hidden');
                dom.genericModal.classList.add('flex');
                
                return new Promise(resolve => { modalResolve = resolve; });
            }
            function hideModal(resolveWith = null) { 
                if (modalKeydownHandler) {
                    document.removeEventListener('keydown', modalKeydownHandler);
                    modalKeydownHandler = null;
                }
                if(modalResolve) { 
                    modalResolve(resolveWith); 
                    modalResolve = null; 
                } 
                dom.genericModal.classList.add('hidden'); 
                dom.genericModal.classList.remove('flex');  
            }
            
            function showPricingModal() { 
                dom.pricingModal.classList.remove('hidden');
                dom.pricingModal.classList.add('flex'); 
                setTimeout(() => { dom.pricingModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
                
                const lang = localStorage.getItem('ibero-lang') || 'es';
                const isFree = !currentUser || (currentUser.app_metadata?.plan || 'free') === 'free';
                
                if (isFree) {
                    dom.freePlanButton.textContent = translations[lang].current_plan;
                    dom.freePlanButton.disabled = true;
                    dom.freePlanButton.classList.add('btn-disabled');
                } else {
                    dom.freePlanButton.textContent = translations[lang].plan_free_cta;
                    dom.freePlanButton.disabled = false;
                    dom.freePlanButton.classList.remove('btn-disabled');
                }
            }
            function hidePricingModal() { dom.pricingModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => { dom.pricingModal.classList.add('hidden'); dom.pricingModal.classList.remove('flex'); }, 300); }
            function showSettingsModal() {
                dom.settingsModal.classList.remove('hidden');
                dom.settingsModal.classList.add('flex');
                if (currentUser) {
                    dom.settingsUserEmail.textContent = currentUser.email;
                    const userPlan = currentUser.app_metadata?.plan || 'free';
                    dom.settingsUserPlan.textContent = userPlan.charAt(0).toUpperCase() + userPlan.slice(1);
                    dom.settingsUpgradePlanBtn.classList.toggle('hidden', userPlan !== 'free');
                } else {
                    dom.settingsUserEmail.textContent = 'No ha iniciado sesión';
                    dom.settingsUserPlan.textContent = 'Básico (Invitado)';
                    dom.settingsUpgradePlanBtn.classList.remove('hidden');
                }
                dom.fontSizeSlider.value = parseInt(getComputedStyle(document.body).getPropertyValue('--base-font-size')) || 16;
                dom.fontSizeValue.textContent = `${dom.fontSizeSlider.value}px`;
                dom.settingsThemeIcon.className = `fas fa-${document.body.classList.contains('dark-theme') ? 'sun' : 'moon'}`;
                dom.languageSelector.value = localStorage.getItem('ibero-lang') || 'es';
                dom.notificationsToggle.checked = notificationsEnabled;
            }

            function hideSettingsModal() {
                dom.settingsModal.classList.add('hidden');
                dom.settingsModal.classList.remove('flex');
            }

            function showInAppNotification(title, body, duration = 4000) { 
                dom.inAppNotificationTitle.innerHTML = title;
                dom.inAppNotificationBody.innerHTML = body;
                dom.inAppNotification.classList.add('show');
            
                let timer;
            
                const closeNotification = (event) => {
                    if (event && event.target.closest('button, a')) {
                        return;
                    }
                    if(timer) clearTimeout(timer);
                    dom.inAppNotification.classList.remove('show');
                    dom.inAppNotification.removeEventListener('click', closeNotification);
                    dom.inAppNotificationClose.removeEventListener('click', closeFromX);
                };
            
                const closeFromX = (event) => {
                    event.stopPropagation();
                    closeNotification();
                };

                dom.inAppNotification.addEventListener('click', closeNotification, { once: true });
                dom.inAppNotificationClose.addEventListener('click', closeFromX, { once: true });
            
                if(duration) {
                    timer = setTimeout(closeNotification, duration);
                }
            }

            function showTaskNotification(title, body) {
                dom.taskNotificationModal.classList.remove('hidden');
                dom.taskNotificationModal.classList.add('flex');
                dom.taskNotificationTitle.textContent = title;
                
                const glowingBody = body.replace(/(Recordatorio de Tarea:.*)/, '<span class="glowing-text">$1</span>');
                dom.taskNotificationBody.innerHTML = glowingBody;
            }

            function hideTaskNotification() {
                dom.taskNotificationModal.classList.add('hidden');
                dom.taskNotificationModal.classList.remove('flex');
            }

            function showCalendarModal() {
                dom.calendarModalOverlay.classList.remove('hidden');
                dom.calendarModalOverlay.classList.add('flex');
                if (!currentCalendarView) currentCalendarView = 'month'; 
                renderCalendarView();
            }

            function hideCalendarModal() {
                dom.calendarModalOverlay.classList.add('hidden');
                dom.calendarModalOverlay.classList.remove('flex');
            }

            function renderMonthView() {
                dom.calendarDaysGrid.innerHTML = '';
                dom.currentMonthYear.textContent = selectedCalendarDate.format('MMMM YYYY');
                const startDay = selectedCalendarDate.startOf('month').startOf('isoWeek');

                for (let i = 0; i < 42; i++) {
                    const day = startDay.add(i, 'day');
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.dataset.date = day.format('YYYY-MM-DD');

                    dayEl.innerHTML = `<span class="calendar-day-number">${day.date()}</span><div class="calendar-day-tasks"></div>`;

                    if (day.month() === selectedCalendarDate.month()) {
                        dayEl.classList.add('current-month');
                    } else {
                        dayEl.classList.add('other-month');
                    }
                    if (day.isSame(dayjs(), 'day')) {
                        dayEl.classList.add('today');
                    }

                    const tasksContainer = dayEl.querySelector('.calendar-day-tasks');
                    const tasksForDay = getTasksForDay(day.format('YYYY-MM-DD'));
                    tasksForDay.slice(0, 3).forEach(task => { 
                        const taskEl = document.createElement('div');
                        taskEl.className = 'calendar-day-task';
                        taskEl.textContent = task.text;
                        taskEl.style.backgroundColor = getLabelColor(task.source === 'Personal' ? 'Personal' : (task.labels && task.labels[0] ? task.labels[0] : 'default'));
                        taskEl.draggable = true;
                        taskEl.dataset.taskId = task.id;
                        taskEl.dataset.taskSource = task.source;
                        taskEl.innerHTML = `
                            ${task.text}
                            <i class="fas fa-times delete-task-icon" data-task-id="${task.id}" data-task-source="${task.source}"></i>
                        `;
                        tasksContainer.appendChild(taskEl);
                    });

                    dayEl.addEventListener('click', (e) => {
                        if(e.target.classList.contains('delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(e.target.dataset.taskId);
                        } else if(e.target === e.currentTarget || e.target.classList.contains('calendar-day-tasks')) {
                             editCalendarTask(null, day.format('YYYY-MM-DD'));
                        } else if(e.target.closest('.calendar-day-task')) {
                            const taskEl = e.target.closest('.calendar-day-task');
                            handleTaskClick(taskEl.dataset.taskId, taskEl.dataset.taskSource);
                        }
                    });
                    dayEl.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    dayEl.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    dayEl.addEventListener('drop', handleCalendarDrop);
                    tasksContainer.querySelectorAll('.calendar-day-task').forEach(t => t.addEventListener('dragstart', handleCalendarDragStart));
                    tasksContainer.querySelectorAll('.calendar-day-task').forEach(t => t.addEventListener('touchstart', handleTouchStart, {passive: false}));

                    dom.calendarDaysGrid.appendChild(dayEl);
                }
            }
            
            function renderWeekView() {
                dom.weekDaysContent.innerHTML = '';
                let startOfWeek = selectedCalendarDate.startOf('isoWeek');

                const endOfWeek = startOfWeek.add(6, 'day');
                dom.currentWeekRange.textContent = `${startOfWeek.format('D MMM')} - ${endOfWeek.format('D MMM, YYYY')}`;

                for (let i = 0; i < 7; i++) {
                    const day = startOfWeek.add(i, 'day');
                    const dayKey = day.format('YYYY-MM-DD');
                    const tasks = getTasksForDay(dayKey);
                    const lang = localStorage.getItem('ibero-lang') || 'es';
                    const displayDate = day.format('dddd, D MMM');
                    const daySection = document.createElement('div');
                    daySection.className = 'week-day-section';
                    daySection.dataset.date = dayKey;

                    daySection.innerHTML = `
                        <h5>
                            <span>${displayDate}</span>
                            <button class="add-task-to-day-btn text-lg hover:text-primary" data-date="${dayKey}">+</button>
                        </h5>
                        <div class="space-y-1">
                            ${tasks.length === 0 ? `<p class="text-xs text-text-medium italic">${translations[lang].calendar_no_tasks}</p>` : ''}
                            ${tasks.map((task) => {
                                const isPersonal = task.source === 'Personal';
                                return `
                                <div class="task-item flex items-center gap-2 cursor-pointer ${task.completed ? 'task-item-completed' : ''}" 
                                     draggable="true" data-task-id="${task.id}" data-task-source="${task.source}">
                                     <input type="checkbox" class="task-checkbox flex-shrink-0" data-task-id="${task.id}" ${task.completed ? 'checked' : ''}>
                                    <span class="flex-grow">${task.text} ${task.time ? `(${task.time})` : ''} <span class="text-xs text-primary">(${task.source})</span></span>
                                    <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            `}).join('')}
                        </div>
                     `;
                    dom.weekDaysContent.appendChild(daySection);
                    daySection.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    daySection.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    daySection.addEventListener('drop', handleCalendarDrop);
                    daySection.addEventListener('click', (e) => {
                         if(e.target === e.currentTarget || e.target.classList.contains('space-y-1')) {
                            editCalendarTask(null, dayKey);
                        }
                    });
                }

                dom.weekDaysContent.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        updateTaskStatus(e.currentTarget.dataset.taskId, { completed: e.currentTarget.checked });
                    });
                 });

                dom.weekDaysContent.querySelectorAll('.task-item').forEach(item => {
                    item.addEventListener('dragstart', handleCalendarDragStart);
                    item.addEventListener('touchstart', handleTouchStart, {passive: false});
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(item.dataset.taskId);
                            return;
                        }
                        if (e.target.type === 'checkbox') return;
                        handleTaskClick(item.dataset.taskId, item.dataset.taskSource);
                     });
                });
                dom.weekDaysContent.querySelectorAll('.add-task-to-day-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const date = e.currentTarget.dataset.date;
                        editCalendarTask(null, date);
                    });
                });
            }

            function renderDayView() {
                dom.currentDayDisplay.textContent = selectedCalendarDate.format('dddd, D [de] MMMM');
                dom.dayViewTimeline.innerHTML = '';
                const tasksForDay = getTasksForDay(selectedCalendarDate.format('YYYY-MM-DD'));
                
                for (let hour = 0; hour < 24; hour++) {
                    const hourEl = document.createElement('div');
                    hourEl.className = 'day-view-hour';
                    const hourLabel = (hour < 10 ? '0' : '') + hour + ':00';
                    hourEl.dataset.time = hourLabel.substring(0,2);
                    const tasksInHour = tasksForDay.filter(t => t.time && t.time.startsWith((hour < 10 ? '0' : '') + hour));
                    hourEl.innerHTML = `
                        <div class="day-view-hour-label">${hourLabel}</div>
                        <div class="day-view-hour-content" data-time="${hourLabel}" data-date="${selectedCalendarDate.format('YYYY-MM-DD')}">
                            ${tasksInHour.map(task => {
                                return `
                                 <div class="task-item flex items-center gap-2 p-1 rounded-md ${task.completed ? 'bg-green-900/50 text-gray-400 line-through' : 'bg-input'} text-sm" 
                                    draggable="true" data-task-id="${task.id}" data-task-source="${task.source}">
                                    <input type="checkbox" class="task-checkbox flex-shrink-0" data-task-id="${task.id}" ${task.completed ? 'checked' : ''}>
                                     <span class="flex-grow cursor-pointer"><strong>${task.time}:</strong> ${task.text} <span class="text-xs text-primary">(${task.source})</span></span>
                                    <button class="delete-task-icon text-text-medium hover:text-danger-color text-xs p-1"><i class="fas fa-trash-alt"></i></button>
                                </div>
                                `
                            }).join('')}
                             <button class="add-task-to-time-btn text-lg hover:text-primary" data-date="${selectedCalendarDate.format('YYYY-MM-DD')}" data-time="${hourLabel}">+</button>
                        </div>
                    `;
                    dom.dayViewTimeline.appendChild(hourEl);

                    const hourContent = hourEl.querySelector('.day-view-hour-content');
                    hourContent.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'var(--current-bg-light)'; });
                    hourContent.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                    hourContent.addEventListener('drop', handleCalendarDrop);
                     hourContent.addEventListener('click', (e) => {
                         if(e.target === e.currentTarget) {
                            editCalendarTask(null, selectedCalendarDate.format('YYYY-MM-DD'), e.currentTarget.dataset.time);
                        }
                    });
                }
                dom.dayViewTimeline.querySelectorAll('.add-task-to-time-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const date = e.currentTarget.dataset.date;
                         const time = e.currentTarget.dataset.time;
                        editCalendarTask(null, date, time);
                    });
                });
                dom.dayViewTimeline.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        updateTaskStatus(e.currentTarget.dataset.taskId, { completed: e.currentTarget.checked });
                    });
                });
                dom.dayViewTimeline.querySelectorAll('.task-item').forEach(item => {
                    item.addEventListener('dragstart', handleCalendarDragStart);
                    item.addEventListener('touchstart', handleTouchStart, {passive: false});
                    item.addEventListener('click', (e) => {
                         if (e.target.closest('.delete-task-icon')) {
                            e.stopPropagation();
                            deleteTask(item.dataset.taskId);
                            return;
                        }
                        if (e.target.type === 'checkbox') return;
                        handleTaskClick(item.dataset.taskId, item.dataset.taskSource);
                    });
                 });
            }

            function handleTaskClick(taskId, taskSource) {
                 if (taskSource === 'Personal') {
                    editCalendarTask(taskId);
                } else {
                    // "taskSource" in a project context is the project's title.
                    // We need to find the chat/project ID that corresponds to this title.
                    const projectChat = Object.values(state.chats).find(c => c.projectData && c.projectData.title === taskSource);
                    if (projectChat) {
                        // Open the project view and then open the edit modal for the task.
                        selectChat(projectChat.id); // This will render the project view
                        setTimeout(() => editProjectTask(projectChat.id, taskId), 100); // Delay to allow UI to update
                    }
                }
            }
            
            let draggedCalendarTaskId = null;
            function handleCalendarDragStart(e) {
                const target = e.target.closest('[draggable="true"]');
                if (!target) return;
                draggedCalendarTaskId = target.dataset.taskId;
                e.dataTransfer.setData('text/plain', draggedCalendarTaskId);
                e.dataTransfer.effectAllowed = 'move';
            }
            
            function handleCalendarDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.style.backgroundColor = '';
                const taskId = e.dataTransfer.getData('text/plain');
                if (!taskId) return;

                const dropZone = e.currentTarget;
                const newDate = dropZone.dataset.date;
                let newTime = dropZone.dataset.time || findTask(taskId)?.task?.time || null; 
                
                if (newTime && newTime.length === 2) { 
                   const originalTask = findTask(taskId)?.task;
                   const originalMinutes = originalTask?.time?.substring(3,5) || '00';
                   newTime = `${newTime}:${originalMinutes}`;
                }
                
                const updates = { date: newDate, time: newTime };
                updateTaskStatus(taskId, updates);
            }

            let touchDragElement = null, ghostElement = null;
            function handleTouchStart(e) {
                if (e.touches.length !== 1) return;
                const target = e.target.closest('[draggable="true"]');
                if (!target) return;
                
                touchDragElement = target;
                
                ghostElement = touchDragElement.cloneNode(true);
                ghostElement.style.position = 'absolute';
                ghostElement.style.zIndex = '1000';
                ghostElement.style.opacity = '0.7';
                ghostElement.style.pointerEvents = 'none';
                ghostElement.style.width = `${touchDragElement.offsetWidth}px`;
                document.body.appendChild(ghostElement);
                
                const touch = e.touches[0];
                ghostElement.style.left = `${touch.pageX - ghostElement.offsetWidth / 2}px`;
                ghostElement.style.top = `${touch.pageY - ghostElement.offsetHeight / 2}px`;

                document.addEventListener('touchmove', handleTouchMove, {passive: false});
                document.addEventListener('touchend', handleTouchEnd);
            }
            function handleTouchMove(e) {
                if (e.touches.length !== 1 || !ghostElement) return;
                e.preventDefault();
                const touch = e.touches[0];
                ghostElement.style.left = `${touch.pageX - ghostElement.offsetWidth / 2}px`;
                ghostElement.style.top = `${touch.pageY - ghostElement.offsetHeight / 2}px`;
            }
            function handleTouchEnd(e) {
                if (!ghostElement) return;
                
                ghostElement.style.display = 'none';
                const dropTarget = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
                ghostElement.remove();
                
                if (dropTarget) {
                    const dropZone = dropTarget.closest('.calendar-day, .week-day-section, .day-view-hour-content, .kanban-cards, .list-view-column-mobile, .list-view-content > h4, .project-header');
                    if(dropZone) {
                        const taskId = touchDragElement.dataset.taskId;
                        if (dropZone.classList.contains('kanban-cards')) {
                            const chatId = currentChatId;
                            const columnId = dropZone.dataset.columnId;
                            moveTask(chatId, taskId, columnId);
                        } else if(dropZone.classList.contains('list-view-column-mobile')) {
                            const chatId = currentChatId;
                            const columnId = dropZone.dataset.columnId;
                            moveTask(chatId, taskId, columnId);
                        } else if (dropZone.tagName === 'H4' && dropZone.closest('#list-view')) {
                             const columnTitle = dropZone.textContent.trim();
                             const chat = state.chats[currentChatId];
                             const targetColumn = chat.projectData.columns.find(c => c.title === columnTitle);
                             if (targetColumn) {
                                 moveTask(currentChatId, taskId, targetColumn.id);
                             }
                        }
                        else if (dropZone.classList.contains('project-header')) {
                            const targetProjectId = dropZone.closest('.project').dataset.id;
                            moveItemToProject(draggedItemId, targetProjectId);
                        }
                        else {
                            const newDate = dropZone.dataset.date;
                            let newTime = dropZone.dataset.time || findTask(taskId)?.task?.time || null;
                            if (newTime && newTime.length === 2) {
                                const originalTask = findTask(taskId)?.task;
                                const originalMinutes = originalTask?.time?.substring(3,5) || '00';
                                newTime = `${newTime}:${originalMinutes}`;
                            }
                            updateTaskStatus(taskId, { date: newDate, time: newTime });
                        }
                    }
                }
                
                touchDragElement = null; ghostElement = null;
                document.removeEventListener('touchmove', handleTouchMove);
                document.removeEventListener('touchend', handleTouchEnd);
            }

            // ... (The rest of the JS functions: findTask, updateTaskStatus, getTasksForDay, etc.)
            // ... (The entire JS logic from the original file needs to be here, adapted as planned)
            // ... (This includes init, event listeners, state management, etc.)
            
            // Final initialization logic
            let initFired = false;
            const finishInitialization = (user) => {
                if (initFired) return;
                initFired = true;
                currentUser = user;
                
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const chatIdFromUrl = urlParams.get('chat');

                    updateUserUI();
                    loadStateForUser().then(() => {
                        populateVoiceList();
                        setupEventListeners();
                        setupNotifications();
                        updateContextualFooter(null);
                        setupMotivationInterval();

                        dom.appContainer.classList.remove('opacity-0');
                        dom.loadingOverlay.style.display = 'none';
                        
                        if (chatIdFromUrl && (state.chats[chatIdFromUrl] || (state.notes || []).find(n => n.id === chatIdFromUrl))) {
                            selectChat(chatIdFromUrl);
                        } else if (currentChatId && (state.chats[currentChatId] || (state.notes || []).find(n => n.id === currentChatId))) {
                            selectChat(currentChatId);
                        } else {
                            resetChatView();
                        }

                        updateNotificationBadge();
                        if (currentUser && !localStorage.getItem('ibero-gamification-rules-seen')) {
                            setTimeout(() => {
                                dom.gamificationRulesModal.classList.remove('hidden');
                                dom.gamificationRulesModal.classList.add('flex');
                                localStorage.setItem('ibero-gamification-rules-seen', 'true');
                            }, 2000);
                        }
                    });
                } catch (e) {
                    console.error("Error during finishInitialization:", e);
                    dom.loadingOverlay.innerHTML = `<div class="text-red-500 text-center">Error al cargar el aula virtual.<br>Por favor, recarga la página.<br><small>${e.message}</small></div>`;
                }
            };

            const savedLang = localStorage.getItem('ibero-lang') || 'es';
            setLanguage(savedLang);
            setTheme(localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches));

            const unlockAudio = () => {
                const silence = new SpeechSynthesisUtterance('');
                silence.volume = 0;
                window.speechSynthesis.speak(silence);
                document.body.removeEventListener('touchstart', unlockAudio);
                document.body.removeEventListener('click', unlockAudio);
            };
            document.body.addEventListener('touchstart', unlockAudio, { once: true });
            document.body.addEventListener('click', unlockAudio, { once: true });
            
            if (window.netlifyIdentity) {
                netlifyIdentity.on('init', (user) => finishInitialization(user));
                netlifyIdentity.on('login', (user) => {
                    netlifyIdentity.close(); 
                    currentUser = user;
                    updateUserUI(); 
                    loadStateForUser();
                });
                netlifyIdentity.on('logout', () => {
                    currentUser = null;
                    updateUserUI(); 
                    loadStateForUser(); 
                    resetChatView();
                });
                netlifyIdentity.on('error', (err) => {
                    console.error("Netlify Identity Error:", err);
                    if (!initFired) finishInitialization(null); 
                });
            } else {
                 console.warn("Netlify Identity widget not found. Proceeding as guest.");
                 finishInitialization(null);
            }

            setTimeout(() => {
                if (!initFired) {
                    console.warn("Netlify Identity 'init' event did not fire within timeout. Forcing app initialization.");
                    finishInitialization(window.netlifyIdentity ? netlifyIdentity.currentUser() : null);
                 }
            }, 3000);
        });
        //<-- END OF SCRIPT -->
    </script>
</body>
</html>
