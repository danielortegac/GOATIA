<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#9B2729">
    <title>Centro Iberoamericano de Educación - Aula Virtual</title>
    <link rel="icon" type="image/png" href="https://ibero.education/wp-content/uploads/2023/12/cropped-logo-ico-32x32.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/locale/es.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/plugin/localizedFormat.js"></script>
    <script src="https://npmcdn.com/dayjs@1.10.7/plugin/isoWeek.js"></script>
    
    <style>
        :root {
            --bg-dark: #121212;
            --bg-medium: #1a1a1a;
            --bg-light: #282828;
            --primary: #9B2729;
            --primary-hover: #B02E30;
            --text-light: #f5f5f5;
            --text-medium: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
            --gold-color: #FFD700;
            --urgent-color: #ef4444;
            --danger-color: #dc2626;

            --light-bg-dark: #f9f9f9;
            --light-bg-medium: #ffffff;
            --light-bg-light: #f1f1f1;
            --light-primary: #9B2729;
            --light-primary-hover: #862224;
            --light-text-dark: #1f2937;
            --light-text-medium: #6b7280;
            --light-border-color: rgba(0, 0, 0, 0.09);

            --base-font-size: 14.5px;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: var(--base-font-size);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .dark-theme {
            --current-bg-dark: var(--bg-dark);
            --current-bg-medium: var(--bg-medium);
            --current-bg-light: var(--bg-light);
            --current-primary: var(--primary);
            --current-primary-hover: var(--primary-hover);
            --current-text-light: var(--text-light);
            --current-text-medium: var(--text-medium);
            --current-border-color: var(--border-color);
            background-color: var(--current-bg-dark);
            color: var(--text-light);
        }

        .light-theme {
            --current-bg-dark: var(--light-bg-dark);
            --current-bg-medium: var(--light-bg-medium);
            --current-bg-light: var(--light-bg-light);
            --current-primary: var(--light-primary);
            --current-primary-hover: var(--light-primary-hover);
            --current-text-light: var(--light-text-dark);
            --current-text-medium: var(--light-text-medium);
            --current-border-color: var(--light-border-color);
            background-color: var(--light-bg-dark);
            color: var(--light-text-dark);
        }
        
        #sidebar { 
            background-color: var(--current-bg-dark); 
            border-right: 1px solid var(--current-border-color); 
            height: 100vh; 
            transition: width 0.3s ease, transform 0.3s ease; 
            z-index: 40; 
            position: relative;
            display: flex; 
            flex-direction: column;
        }

        #sidebar.collapsed { 
            width: 72px;
            padding: 0; 
            overflow: visible;
        }
        #sidebar.collapsed .sidebar-text,
        #sidebar.collapsed #user-email,
        #sidebar.collapsed .workflow-arrow,
        #sidebar.collapsed .project-arrow,
        #sidebar.collapsed .actions-arrow,
        #sidebar.collapsed .project-content,
        #sidebar.collapsed .actions-header > span,
        #sidebar.collapsed #sidebar-footer,
        #sidebar.collapsed #sidebar-content-main .text-xs,
        #sidebar.collapsed #new-folder-btn,
        #sidebar.collapsed #select-chats-btn span,
        #sidebar.collapsed #delete-mode-controls span { 
            display: none; 
        }

        #sidebar.collapsed .sidebar-item-container {
            justify-content: center;
        }

        #sidebar.collapsed #sidebar-toggle-arrow {
            display: flex;
            left: unset;
            right: -12px;
            transform: translateY(0%) rotate(180deg); 
            top: 12px;
        }

        #sidebar-toggle-arrow {
            position: absolute;
            top: 12px; 
            right: -12px;
            transform: translateY(0%) rotate(0deg); 
            background-color: var(--current-bg-dark);
            border: 1px solid var(--current-border-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: none; 
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 45;
            transition: transform 0.3s ease, left 0.3s ease, right 0.3s ease, top 0.3s ease;
        }
        #sidebar:not(.collapsed) #sidebar-toggle-arrow {
            right: -12px; 
            transform: translateY(0%) rotate(0deg); 
        }


        #sidebar-header, #sidebar-bottom-fixed {
            flex-shrink: 0;
            padding: 0.75rem;
        }
        #sidebar-header { border-bottom: 1px solid var(--current-border-color); }
        #sidebar-bottom-fixed { 
            border-top: 1px solid var(--current-border-color); 
            transition: padding 0.3s ease;
        }

        #sidebar.collapsed #sidebar-bottom-fixed {
            padding: 0.5rem;
        }
        #sidebar.collapsed #user-menu-btn {
            justify-content: center;
        }
        #sidebar.collapsed #settings-btn-container {
            justify-content: center;
        }


        #sidebar-scrollable-content {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
        }
        #sidebar-content-main {
            flex-grow: 1;
        }
        #sidebar-footer {
            flex-shrink: 0;
            margin-top: auto;
            padding-top: 1rem;
        }


        @media (max-width: 767px) {
            #sidebar {
                transform: translateX(-100%);
                position: fixed;
                top: 0;
                left: 0;
                width: 288px;
            }
            #sidebar.is-open {
                transform: translateX(0);
            }
            #sidebar, #sidebar > .flex {
                height: 100vh;
                height: -webkit-fill-available;
            }
            body { --base-font-size: 13.5px; }
            button, .btn-primary { 
                padding-top: 0.4rem; padding-bottom: 0.4rem; 
                padding-left: 0.75rem; padding-right: 0.75rem;
                font-size: 0.8rem;
            }
            .text-lg { font-size: 1rem; }
            .text-xl { font-size: 1.1rem; }
            .text-2xl { font-size: 1.2rem; }
            .text-3xl { font-size: 1.4rem; }
            #app-container {
                max-height: calc(100vh - 10px);
            }
             #sidebar.collapsed { 
                width: 0; 
                padding: 0; 
                overflow: hidden; 
                border-right: none;
            }
            #sidebar.collapsed > * { 
                display: none; 
            }
            #sidebar.collapsed #sidebar-toggle-arrow { 
                display: none;
            }
        }


        #main-chat-area, .modal-content { background-color: var(--current-bg-medium); }
        .chat-bubble-bot, .bg-input, #pdf-preview-container, .chat-item, .project-header, #user-menu-popup, #services-menu, .pro-controls-bg { background-color: var(--current-bg-light); }
        .border-themed { border-color: var(--current-border-color); }
        .chat-bubble-user { background-color: var(--current-primary); color: white; }
        .btn-primary { background-color: var(--current-primary); color: white; }
        .btn-primary:hover { background-color: var(--current-primary-hover); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .plan-card-highlight { border-color: var(--current-primary); box-shadow: 0 0 15px rgba(155, 39, 41, 0.3); } /* Sombra roja */
        .placeholder-themed::placeholder { color: var(--current-text-medium); }
        .text-primary, .workflow-header i:not(.workflow-arrow) { color: var(--current-primary) !important; }
        .glowing-mic { animation: pulse 1.5s infinite; color: var(--primary) !important; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(155, 39, 41, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(155, 39, 41, 0); }
            100% { box-shadow: 0 0 0 0 rgba(155, 39, 41, 0); }
        }

        .project .project-content,
        .actions-category .actions-content,
        .workflow-category .workflow-content { 
            display: none; 
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            max-height: 0;
        }
        .project.open .project-content,
        .actions-category.open .actions-content,
        .workflow-category.open .workflow-content { 
            display: block; 
            max-height: 1000px;
        }
        .project.open .project-arrow,
        .actions-category.open .actions-arrow,
        .workflow-category.open .workflow-arrow { 
            transform: rotate(90deg); 
        }

        .project-header.drag-over { background-color: var(--current-primary); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        #app-container { height: 100vh; height: -webkit-fill-available; }
        #pricing-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        
        .chat-item.selecting, .note-item.selecting {
            background-color: rgba(155, 39, 41, 0.2);
            border: 1px dashed var(--current-primary);
        }
        .chat-item.selected-for-delete, .note-item.selected-for-delete {
            background-color: var(--primary) !important;
            color: white;
        }
        #selection-box {
            position: absolute;
            border: 1px solid var(--current-primary);
            background-color: rgba(155, 39, 41, 0.3);
            z-index: 100;
            pointer-events: none;
        }

        
        .model-selector-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .model-selector-wrapper select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
            padding-right: 2.5rem;
            height: 32px;
            font-size: 0.875rem;
            line-height: 1.25rem;
            border: none;
            outline: none;
            cursor: pointer;
            min-width: 120px;
            background-color: transparent;
        }
         .model-selector-wrapper i {
            position: absolute;
            right: 0.5rem;
            pointer-events: none;
        }

        .pro-controls-bg {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.375rem;
            border-radius: 0.5rem;
            overflow: hidden; 
            width: 100%;
            gap: 0.5rem;
        }

        #pro-controls-left, #pro-controls-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        #pro-controls-left {
            flex-grow: 1;
            min-width: 0;
        }

        #pro-controls-right {
            flex-shrink: 0;
        }
        
        .plan-card { background-color: var(--current-bg-light); }
        #pdf-preview-container { padding: 0.5rem; }
        
        @keyframes sweep {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(200%) skewX(-15deg); }
        }
        .cool-light-effect { position: relative; overflow: hidden; }
        .cool-light-effect::before {
            content: '';
            position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(155, 39, 41, 0.25) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-150%) skewX(-15deg); transition: transform 0.8s ease;
            pointer-events: none;
        }
        .cool-light-effect:hover::before { animation: sweep 2s infinite linear; }

        .input-wrapper { border: 1px solid transparent; transition: box-shadow 0.3s ease, border-color 0.3s ease; }
        .input-wrapper:focus-within { box-shadow: 0 0 10px 0px rgba(155, 39, 41, 0.5); border-color: var(--current-primary-hover); }

        #chat-title {
            color: var(--primary);
            font-weight: 700;
            transition: color 0.3s ease;
        }
        #desktop-chat-title-wrapper:hover #chat-title {
            color: var(--primary-hover);
        }
        
        #desktop-chat-title-wrapper {
            position: relative;
            cursor: pointer;
        }
        #desktop-chat-title-wrapper .edit-icon {
            opacity: 0;
            transition: opacity 0.2s;
            margin-right: 8px;
        }
        #desktop-chat-title-wrapper:hover .edit-icon {
            opacity: 1;
        }
        #mobile-chat-title-wrapper .edit-icon {
            margin-right: 8px;
        }

        .btn-disabled { background-color: #3a3a3a !important; color: #888 !important; cursor: not-allowed !important; border-color: #3a3a3a !important;}

        .chat-item.selected-chat, .note-item.active {
            background-color: var(--current-primary);
            color: white !important;
        }
        .chat-item.selected-chat .text-sm, .note-item.active .text-sm {
            color: white !important;
        }
        .light-theme .chat-item, .light-theme .note-item {
            color: var(--light-text-dark);
        }

        .move-to-folder-popup {
            position: absolute;
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .move-to-folder-popup button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }
        .move-to-folder-popup button:hover {
            background-color: var(--current-bg-medium);
        }
        
        /* Calendar styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day {
            padding: 2px;
            border-radius: 4px;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            transition: background-color 0.2s ease, border 0.2s ease;
            position: relative;
            border: 2px solid transparent;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .calendar-day-number {
            font-weight: bold;
            font-size: 0.8rem;
            margin: 4px;
            align-self: flex-start;
        }
        .calendar-day-tasks {
            flex-grow: 1;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 0 2px 2px 2px;
        }
        .calendar-day-task {
            font-size: 0.65rem;
            padding: 2px 4px;
            border-radius: 4px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
            position: relative;
        }
        .calendar-day-task .delete-task-icon {
            display: none;
            position: absolute;
            right: 1px;
            top: 1px;
            color: white;
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 14px;
            height: 14px;
            font-size: 8px;
            line-height: 14px;
            text-align: center;
        }
        .calendar-day-task:hover .delete-task-icon {
            display: block;
        }

        .calendar-day:hover {
            background-color: var(--current-bg-light);
        }
        .calendar-day.current-month {
            color: var(--current-text-light);
        }
        .calendar-day.other-month {
            color: var(--current-text-medium);
            opacity: 0.5;
        }
        .calendar-day.today .calendar-day-number {
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 2px;
        }
        .task-dots-container {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
        }
        .task-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-item-completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .notification-bell-icon {
            position: relative;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7em;
            line-height: 1;
            min-width: 18px;
            text-align: center;
        }
        
        .calendar-view-toggle, .project-view-controls {
            display: flex;
            gap: 0.5rem;
            background-color: var(--current-bg-dark);
            padding: 0.25rem;
            border-radius: 8px;
            width: 100%;
        }

        .calendar-view-toggle button, .project-view-controls button {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            font-weight: 600;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
            white-space: nowrap; 
        }
        .calendar-view-toggle button.active, .project-view-controls button.active {
            background-color: var(--current-primary);
            color: white;
            box-shadow: 0 0 8px rgba(155, 39, 41, 0.4);
        }
        .calendar-view-toggle button:hover:not(.active), .project-view-controls button:hover:not(.active) {
            background-color: var(--current-bg-medium);
        }
        .dark-theme .project-view-controls button:not(.active) {
            color: var(--current-text-light);
        }
        .light-theme .project-view-controls button:not(.active) {
            color: var(--current-text-dark);
        }

        #month-view-container, #day-view-container {
            display: block;
        }
        #week-view-container, #day-view-container {
            display: none;
        }
        #week-view-container, #day-view-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--current-border-color);
            border-radius: 8px;
            padding: 10px;
        }
        .week-day-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--current-border-color);
        }
        .week-day-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .week-day-section h5 {
            font-weight: 700;
            color: var(--current-primary);
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .week-day-section .task-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 0;
        }
        
        .day-view-timeline {
            position: relative;
        }
        .day-view-hour {
            display: flex;
            border-top: 1px solid var(--current-border-color);
        }
        .day-view-hour-label {
            width: 60px;
            flex-shrink: 0;
            text-align: right;
            padding-right: 10px;
            font-size: 0.75rem;
            color: var(--current-text-medium);
        }
        .day-view-hour-content {
            flex-grow: 1;
            border-left: 1px solid var(--current-border-color);
            padding: 5px;
            min-height: 40px;
            position: relative;
        }
        .add-task-to-time-btn {
            position: absolute;
            right: 5px;
            top: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .day-view-hour-content:hover .add-task-to-time-btn {
            opacity: 1;
        }

        /* Project, Financial & Notepad View Styles */
        #project-management-view, #financial-assistant-view, #notepad-view-container, #course-view {
            display: flex;
            flex-direction: column; 
            gap: 1rem;
            height: 100%;
            position: relative; 
            flex: 1;
            overflow: hidden;
        }
        
        #project-board-container, #financial-tools-container, #notepad-editor-and-chat-container {
            flex: 1; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0; 
        }
        
        #project-chat-container, #financial-chat-container, #notepad-chat-container {
            display: flex;
            flex-direction: column;
            border-top: 1px solid var(--current-border-color);
            padding-top: 1rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
            background-color: var(--current-bg-medium);
        }
        #project-chat-container.collapsed, #financial-chat-container.collapsed, #notepad-chat-container.collapsed {
            flex-grow: 0;
            flex-basis: auto;
            height: 50px !important;
        }

        #project-chat-container .project-chat-body,
        #financial-chat-container .financial-chat-body,
        #notepad-chat-container .notepad-chat-body {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        #project-chat-container.collapsed .project-chat-body,
        #financial-chat-container.collapsed .financial-chat-body,
        #notepad-chat-container.collapsed .notepad-chat-body {
            display: none;
        }

        #project-chat-toggle i, #financial-chat-toggle i, #notepad-chat-toggle i {
            transition: transform 0.3s ease;
        }
        #project-chat-container:not(.collapsed) #project-chat-toggle i,
        #financial-chat-container:not(.collapsed) #financial-chat-toggle i,
        #notepad-chat-container:not(.collapsed) #notepad-chat-toggle i {
            transform: rotate(180deg);
        }

        #project-chat-messages, #financial-chat-messages, #notepad-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        #kanban-view {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 1rem;
            overflow: hidden; 
            flex-grow: 1;
        }

        .kanban-column {
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-width: 0; 
        }
        .kanban-column-title {
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--current-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-cards {
            flex-grow: 1;
            min-height: 100px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .kanban-card {
            background-color: var(--current-bg-medium);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            border-left: 4px solid var(--current-primary);
            position: relative;
        }
        .kanban-card .delete-task-icon {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
            color: var(--current-text-medium);
            background-color: var(--current-bg-light);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            line-height: 18px;
            text-align: center;
            transition: all 0.2s ease;
        }
        .kanban-card .delete-task-icon:hover {
            background-color: var(--danger-color);
            color: white;
            transform: scale(1.1);
        }
        .kanban-card:hover .delete-task-icon {
            display: block;
        }
        .kanban-card.urgent {
            border-left-color: var(--urgent-color);
        }
        .kanban-card:active {
            cursor: grabbing;
            background-color: var(--primary);
        }
        .kanban-card p {
            font-weight: 500;
            padding-right: 20px; 
        }
        .kanban-card .card-footer {
            font-size: 0.75rem;
            color: var(--current-text-medium);
            margin-top: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-cards.drag-over {
            border: 2px dashed var(--current-primary);
            background-color: rgba(155, 39, 41, 0.1);
        }
        
        /* List View Styles */
        #list-view {
            overflow: hidden;
            flex-grow: 1;
            display: flex; 
            flex-direction: column; 
        }
        .list-view-header {
            display: grid;
            grid-template-columns: 1fr 150px 80px 120px 40px;
            gap: 1rem;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid var(--current-border-color);
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--current-text-medium);
            flex-shrink: 0; 
        }
        .list-view-content {
             overflow-y: auto; 
             flex-grow: 1; 
        }
        .list-view-task {
            display: grid;
            grid-template-columns: 1fr 150px 80px 120px 40px;
            gap: 1rem;
            align-items: center;
            padding: 0.25rem 1rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        .list-view-task input[type="date"], .list-view-task input[type="time"] {
                background: transparent;
                border: none;
                border-radius: 4px;
                padding: 2px 4px;
                font-size: 0.8rem;
                width: auto;
                color: var(--current-text-light);
                color-scheme: dark;
        }
        .light-theme .list-view-task input { color-scheme: light; color: var(--light-text-dark); }
        .list-view-task:hover {
            background-color: var(--current-bg-light);
        }
        .list-view-task.task-item-completed .task-content-list {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .task-content-list.urgent {
            font-weight: 600;
            color: var(--urgent-color);
        }
        .task-content-list input {
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
        }
        .task-content-list input:focus {
             background-color: var(--current-bg-dark);
        }
        .priority-cell {
            text-align: center;
            cursor: pointer;
        }
        
        .task-labels {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .task-label {
            padding: 2px 8px;
            font-size: 0.7rem;
            border-radius: 12px;
            font-weight: 600;
        }
        #project-tag-filter-container {
            position: relative;
        }
        #tag-filter-dropdown {
            position: absolute;
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Gamification Styles */
        #gamification-modal .modal-content-body { max-height: 80vh; overflow-y: auto; }
        .gamification-tabs { border-bottom: 2px solid var(--current-border-color); }
        .gamification-tab { padding: 0.75rem 1rem; font-weight: 600; color: var(--current-text-medium); cursor: pointer; border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; }
        .gamification-tab.active { color: var(--current-primary); border-color: var(--current-primary); }
        .xp-bar-bg { background-color: var(--current-bg-light); }
        .xp-bar-fill { background-color: var(--current-primary); transition: width 0.5s ease-out; }
        .level-badge { background-color: var(--current-primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; }
        .streak-day { background-color: var(--current-bg-light); border: 2px solid var(--current-border-color); transition: all 0.2s ease; }
        .streak-day.active { border-color: var(--current-primary); transform: scale(1.05); box-shadow: 0 0 10px rgba(155, 39, 41, 0.5); }
        .streak-day.completed { background-color: var(--current-primary); color: white; border-color: var(--current-primary); }
        .streak-day .fa-gift { color: var(--gold-color); }
        .mission-item.completed { opacity: 0.5; text-decoration: line-through; }
        .mission-item.completed .btn-primary { background-color: #4CAF50; cursor: default; }
        .achievement-badge { border: 2px solid var(--current-border-color); filter: grayscale(100%); opacity: 0.6; transition: all 0.3s ease; }
        .achievement-badge.unlocked { border-color: var(--gold-color); filter: grayscale(0%); opacity: 1; box-shadow: 0 0 15px var(--gold-color); }
        .achievement-badge.unlocked .fa-medal { color: var(--gold-color); }
        .text-gold { color: var(--gold-color); }

        /* Pricing Modal Enhancements */
        .plan-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .plan-details.open {
            max-height: 500px;
        }
        .plan-feature-list {
            list-style-position: inside;
        }
        .plan-feature-list li {
            padding-left: 1em;
            text-indent: -1em;
        }
        .plan-feature-list .fa-check-circle {
            color: var(--primary);
        }

        /* NEW Financial Assistant Styles */
        #financial-tools-container {
             padding: 1rem;
             gap: 1rem;
             overflow-y: auto;
        }
        .finance-section {
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
        }
        .finance-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        .finance-section-header h3 {
            font-size: 1.125rem;
            font-weight: 700;
        }
        .finance-category {
            margin-top: 1rem;
            border: 1px solid var(--current-border-color);
            border-radius: 0.5rem;
        }
        .finance-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: var(--current-bg-medium);
            cursor: pointer;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .finance-category-header .finance-category-name-input {
            background: transparent;
            border: none;
            outline: none;
            font-weight: bold;
            width: 70%;
            color: var(--current-text-light);
        }
        .finance-category-content {
            padding: 0.75rem;
        }
        .finance-item-row {
            display: grid;
            grid-template-columns: 1fr 100px 40px;
            gap: 0.75rem;
            align-items: center;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--current-border-color);
        }
        .finance-item-row:last-child {
            border-bottom: none;
        }
        .finance-item-row input {
            background: transparent;
            border: none;
            padding: 0.25rem;
            width: 100%;
            outline: none;
            color: var(--current-text-light);
        }
        .finance-item-row input:focus {
            background-color: var(--current-bg-dark);
            border-radius: 4px;
        }
        .finance-summary {
            background-color: var(--current-bg-light);
            border-radius: 0.5rem;
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            text-align: center;
        }
        .finance-summary h4 {
            font-size: 0.8rem;
            color: var(--current-text-medium);
        }
        .finance-summary p {
            font-size: 1.25rem;
            font-weight: 700;
        }
        #total-income { color: #22c55e; }
        #total-expenses { color: #ef4444; }

        /* Notepad View Styles */
        #notepad-view-container {
            display: none; 
            padding: 0; 
            flex-direction: column; 
        }
        
        #notes-list-panel {
            flex-shrink: 0; 
            padding: 0.5rem;
            border-bottom: 1px solid var(--current-border-color);
        }
        
        #notepad-editor-and-chat-container {
            display: flex;
            flex-direction: row;
            flex-grow: 1;
            gap: 1rem;
            padding: 1rem;
            min-height: 0;
        }
        .note-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background-color: var(--current-bg-medium);
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
            display: block; 
            color: var(--current-text-light); 
            text-decoration: none; 
        }
        .note-item:hover { 
            background-color: var(--current-bg-dark);
            border-left-color: var(--current-primary-hover);
        }
        #note-editor-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--current-bg-light);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        #note-editor-toolbar {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--current-border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            background-color: var(--current-bg-medium);
        }
         #note-editor-toolbar button, .drawing-tool {
            background-color: var(--current-bg-light);
            border: 1px solid var(--current-border-color);
            border-radius: 0.375rem;
            padding: 0.4rem 0.6rem;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }
         #note-editor-toolbar button:hover, .drawing-tool:hover {
            background-color: var(--current-bg-dark);
            border-color: var(--current-primary);
        }
        #note-editor-toolbar button.active {
            background-color: var(--current-primary);
            color: white;
            border-color: var(--current-primary);
        }
        .drawing-tool[type="color"] {
             padding: 0.2rem;
             min-width: 36px;
             height: 36px;
        }
        #note-title-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            outline: none;
            font-size: 1.1rem; 
            font-weight: bold;
            padding: 0.5rem 0.75rem; 
            border-bottom: 1px solid var(--current-border-color);
        }
        #note-content-area {
            position: relative;
            flex-grow: 1;
        }
        #note-content-editor {
            flex-grow: 1;
            width: 100%;
            height: 100%;
            background-color: transparent;
            color: var(--current-text-light);
            border: none;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            resize: none;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap; 
        }
        #note-content-editor:focus-within {
            box-shadow: none;
        }
        .light-theme #note-content-editor {
            color: var(--light-text-dark);
        }
        .checklist-item {
            display: flex;
            align-items: flex-start; 
            gap: 0.75rem; 
            margin: 0.5rem 0;
        }
        .checklist-item input[type="checkbox"] {
            width: 1.15em;
            height: 1.15em;
            accent-color: var(--current-primary);
            cursor: pointer;
            flex-shrink: 0; 
            margin-top: 0.2em; 
        }
        .checklist-item-text {
            flex-grow: 1;
            outline: none;
            min-height: 1.15em; 
            padding-top: 0.2em; 
            padding-bottom: 0.2em;
            word-wrap: break-word; 
        }
        .checklist-item-text[data-checked="true"] {
            text-decoration: line-through;
            opacity: 0.6;
        }
        #note-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--light-bg-medium); 
            cursor: crosshair;
            touch-action: none; 
        }
        #notes-list-toggle {
            position: absolute;
            top: 12px; 
            right: -12px; 
            transform: translateY(0%) rotate(0deg); 
            background-color: var(--current-bg-dark);
            border: 1px solid var(--current-border-color);
            border-radius: 50%;
            padding: 4px;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.3s ease;
        }
        #notes-list-panel:not(.collapsed) #notes-list-toggle {
            transform: translateY(0%) rotate(0deg); 
        }
        #notes-list-panel.collapsed #notes-list-toggle {
            transform: translateY(0%) rotate(180deg); 
        }

        /* In-app notification */
        #in-app-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-200%);
            background-color: var(--current-bg-light);
            color: var(--current-text-light);
            padding: 1rem;
            border-radius: 0.75rem;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            border: 1px solid var(--current-border-color);
            max-width: 90%;
            width: 400px;
            opacity: 0;
            pointer-events: none;
            cursor: pointer;
        }
        #in-app-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        #in-app-notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        #in-app-notification-header h4 {
            font-weight: bold;
        }

        @keyframes glowing {
            0% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px var(--primary), 0 0 20px var(--primary); }
            50% { text-shadow: 0 0 10px #fff, 0 0 20px var(--primary), 0 0 30px var(--primary), 0 0 40px var(--primary); }
            100% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px var(--primary), 0 0 20px var(--primary); }
        }

        .task-notification-content .glowing-text {
            animation: glowing 1.5s ease-in-out infinite;
        }

        /* --- FIN DE LA ADAPTACIÓN DE ESTILO --- */
    </style>
</head>
<body class="w-screen overflow-x-hidden dark-theme">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script type="text/javascript">
        if (window.netlifyIdentity) {
            netlifyIdentity.init();
        }
    </script>
    <div id="loading-overlay" class="fixed inset-0 bg-bg-dark bg-opacity-95 flex flex-col items-center justify-center z-[100] transition-opacity duration-300">
        <img src="https://ibero.education/wp-content/uploads/2023/12/LOGO-IBERO-EN-PNG.png" alt="Logo IBERO" class="w-24 h-24 object-contain mb-6 animate-pulse" onerror="this.onerror=null;this.src='https://placehold.co/96x96/121212/e0e0e0?text=CIE';">
        <div class="text-text-light text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-3 text-lg font-semibold" data-translate-key="initializing">Inicializando Aula Virtual...</p>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden opacity-0 pointer-events-none"></div>

    <div id="app-container" class="flex w-full relative opacity-0 transition-opacity duration-300">
        <aside id="sidebar" class="w-72 flex-shrink-0 flex flex-col transition-transform duration-300 md:translate-x-0 h-full">
            
            <div id="sidebar-header">
                <div id="logo-space" class="w-16 h-16 rounded-lg mx-auto flex-shrink-0 flex items-center justify-center overflow-hidden cursor-pointer">
                    <img src="https://ibero.education/wp-content/uploads/2023/12/LOGO-IBERO-EN-PNG.png" alt="Logo Institucional" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/64x64/2c2c2c/e0e0e0?text=CIE';">
                </div>
            </div>

            <div id="sidebar-scrollable-content">
                <div id="sidebar-content-main" class="flex flex-col">
                    <div class="flex-grow">
                        <div class="mb-4">
                            <h3 class="text-xs font-semibold uppercase text-text-medium mb-2 px-2" data-translate-key="navigation">Navegación</h3>
                            <div id="sidebar-top-actions" class="space-y-1">
                                <button data-view="my-courses" class="sidebar-item-container flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                                    <i class="fas fa-chalkboard-teacher w-6 mr-2 text-lg"></i>
                                   <span class="text-sm font-bold sidebar-text" data-translate-key="my_courses">Mis Cursos</span>
                               </button>
                               <button data-view="grades" class="sidebar-item-container flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                                    <i class="fas fa-award w-6 mr-2 text-lg"></i>
                                   <span class="text-sm font-bold sidebar-text" data-translate-key="grades">Calificaciones</span>
                               </button>
                                <button data-workflow="notepad-app" class="sidebar-item-container flex items-center p-2 rounded-md cursor-pointer hover:bg-light w-full text-left">
                                    <i class="fas fa-book w-6 mr-2 text-lg"></i>
                                   <span class="text-sm font-bold sidebar-text" data-translate-key="notepad">Bloc de Notas</span>
                               </button>
                           </div>
                        </div>
                        
                        <div id="workflows-container" class="space-y-1">
                            <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                     <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i>
                                     <i class="fas fa-brain w-6 mr-2 text-lg"></i>
                                    <span class="text-sm font-bold sidebar-text" data-translate-key="ai_tools">Herramientas IA</span>
                                </div>
                                 <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="decision-lab" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="decision_lab">Laboratorio de Decisiones</button>
                                    <button data-workflow="concept-explainer" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="concept_explainer">Explicador de Conceptos</button>
                                 </div>
                            </div>
                            <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                     <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i>
                                     <i class="fas fa-comments w-6 mr-2 text-lg"></i>
                                    <span class="text-sm font-bold sidebar-text" data-translate-key="ai_tutor">Tutor IA</span>
                                 </div>
                                <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="tutor-ask" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="tutor_ask">Resolver una Duda</button>
                                    <button data-workflow="tutor-practice" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="tutor_practice">Practicar para Examen</button>
                                    <button data-workflow="tutor-feedback" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="tutor_feedback">Revisar un Trabajo</button>
                                </div>
                            </div>
                            <div class="workflow-category">
                                <div class="workflow-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                     <i class="fas fa-chevron-right workflow-arrow mr-2 transition-transform text-xs"></i>
                                     <i class="fas fa-language w-6 mr-2 text-lg"></i>
                                    <span class="text-sm font-bold sidebar-text" data-translate-key="language_assistant">Asistente de Idiomas</span>
                                </div>
                                   <div class="workflow-content pl-4 pt-1 space-y-1">
                                    <button data-workflow="english-teacher-translate" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_1">Traducir/Corregir Texto</button>
                                     <button data-workflow="english-teacher-vocabulary" class="w-full text-left text-sm p-2 rounded hover:bg-light flex items-center" data-translate-key="wf_eng_2">Aprender Vocabulario</button>
                                 </div>
                            </div>
                        </div>
                        
                        <div class="actions-category border-t border-themed pt-4 mt-4">
                            <div class="actions-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                 <i class="fas fa-chevron-right actions-arrow mr-2 transition-transform text-xs"></i>
                                <span class="text-sm font-bold sidebar-text">Acciones Rápidas</span>
                            </div>
                            <div class="actions-content pl-4 pt-2 space-y-2">
                                <button id="new-chat-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors w-full"><i class="fas fa-plus mr-2"></i><span data-translate-key="new_query">Nueva Consulta</span></button>
                                <button id="new-folder-btn" class="flex items-center justify-center font-semibold p-3 rounded-lg bg-input w-full"><i class="fas fa-folder-plus mr-2"></i><span data-translate-key="new_folder">Nueva Carpeta</span></button>
                            </div>
                        </div>

                        <div class="border-t border-themed pt-2 mt-4">
                             <button id="select-chats-btn" class="w-full p-2 rounded hover:bg-light flex items-center justify-center">
                                <i class="fas fa-check-double mr-2"></i><span data-translate-key="select_items">Seleccionar Múltiples</span>
                            </button>
                         </div>
                        <div id="delete-mode-controls" class="hidden flex space-x-2 my-2">
                            <button id="delete-selected-btn" class="flex-1 flex items-center justify-center font-semibold p-2 rounded-lg bg-red-600 text-white disabled:opacity-50" disabled><i class="fas fa-trash-alt mr-2"></i><span data-translate-key="delete">Borrar</span></button>
                             <button id="cancel-select-mode-btn" class="p-2 rounded-lg bg-gray-600 text-white"><i class="fas fa-times"></i></button>
                        </div>

                        <div class="project border-t border-themed pt-4 mt-4 open">
                            <div class="project-header flex items-center p-2 rounded-md cursor-pointer hover:bg-light">
                                <i class="fas fa-chevron-right project-arrow mr-2 transition-transform text-xs"></i>
                                <i class="fas fa-folder-tree mr-2 text-yellow-500"></i>
                                <span class="flex-grow truncate text-sm font-bold sidebar-text" data-translate-key="my_projects">Mis Proyectos</span>
                                <button id="add-project-folder-btn" class="text-text-medium hover:text-primary p-1"><i class="fas fa-plus fa-xs"></i></button>
                            </div>
                            <div id="folders-container" class="project-content pt-1 space-y-1"></div>
                        </div>
                        
                        <div id="sidebar-content" class="pr-1 space-y-1 mt-2"></div>
                    </div>
                </div>

                <div id="sidebar-footer">
                    <div class="flex flex-col space-y-2 border-t border-themed pt-4">
                        <div id="upgrade-plan-container" class="hidden text-center p-2 bg-yellow-400 rounded-lg">
                            <button id="upgrade-plan-btn" class="text-xs font-semibold text-black hover:text-gray-800">
                                <i class="fas fa-rocket mr-1"></i>
                               <span data-translate-key="upgrade_plan">Ver Programas</span>
                            </button>
                        </div>
                        <div class="text-center p-2 bg-input rounded-lg">
                            <a href="#" id="library-link" class="text-xs font-semibold text-primary hover:underline">
                                <i class="fas fa-book-open mr-1"></i>
                               <span data-translate-key="library">Biblioteca y Recursos</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sidebar-bottom-fixed">
                 <div id="user-section">
                    <div id="login-view" class="hidden">
                        <button id="login-btn" class="w-full flex items-center justify-center font-semibold p-3 rounded-lg btn-primary transition-colors"><i class="fas fa-sign-in-alt mr-2"></i><span data-translate-key="login">Iniciar Sesión</span></button>
                    </div>
                     <div id="user-menu-view" class="hidden relative">
                        <button id="user-menu-btn" class="w-full flex items-center text-left p-2 rounded-lg hover:bg-light transition-colors">
                            <span id="user-email" class="flex-grow truncate text-sm font-semibold sidebar-text"></span>
                            <div id="settings-btn-container" class="flex items-center">
                                <button id="settings-btn" class="text-text-medium hover:text-primary p-1" title="Configuración"><i class="fas fa-cog"></i></button>
                                <i class="fas fa-ellipsis-h ml-2 sidebar-text"></i>
                            </div>
                        </button>
                        <div id="user-menu-popup" class="absolute bottom-full left-0 w-full mb-2 rounded-lg p-2 border border-themed shadow-lg hidden">
                             <button id="logout-btn" class="w-full text-left text-sm p-2 rounded hover:bg-medium flex items-center"><i class="fas fa-sign-out-alt w-6 mr-2"></i><span data-translate-key="logout">Cerrar Sesión</span></button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="sidebar-toggle-arrow">
                <i class="fas fa-chevron-left"></i> </div>
        </aside>

        <main id="main-chat-area" class="flex-1 flex flex-col h-full overflow-hidden">
            <header class="flex items-center justify-between p-3 md:p-4 border-b border-themed flex-shrink-0 relative">
                <div id="main-header-content" class="flex items-center justify-between w-full">
                    <div class="flex items-center flex-shrink-0 header-left-icons">
                        <button id="menu-toggle" class="md:hidden text-xl p-2"><i class="fas fa-bars"></i></button>
                        <button id="new-chat-icon-btn" title="Nueva Consulta al Tutor" class="text-xl p-1 hover:opacity-80 transition-opacity"><i class="fas fa-plus-circle text-primary"></i></button>
                    </div>
                    
                    <div id="desktop-chat-title-wrapper" class="hidden sm:flex items-center justify-center group cursor-pointer mx-2 flex-1 min-w-0" title="Renombrar">
                        <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                        <h1 id="chat-title" class="text-lg font-semibold truncate">Aula Virtual</h1>
                        <button id="motivation-btn-header" title="Motivación Diaria" class="text-yellow-400 hover:text-yellow-300 p-2 transition-colors ml-2"><i class="fas fa-lightbulb text-xl"></i></button>
                        <button id="calendar-btn" title="Mi Calendario y Tareas" class="text-sky-400 hover:text-sky-300 p-2 transition-colors notification-bell-icon">
                            <i class="fas fa-calendar-days text-lg"></i>
                            <span id="notification-badge" class="notification-badge hidden">0</span>
                        </button>
                    </div>

                    <div class="flex items-center space-x-1 sm:space-x-2 header-right-icons">
                        <div id="message-counter-wrapper" class="flex items-center space-x-2 text-xs font-mono whitespace-nowrap block mx-2 cursor-pointer">
                             <div id="plan-credits-info" class="flex items-center">
                                <i class="fas fa-trophy text-primary mr-1 text-base"></i> <span id="plan-credits-display">0/0</span>
                            </div>
                            <div id="reward-credits-info" class="flex items-center">
                                <i class="fas fa-coins text-gold ml-2 mr-1 text-base"></i> <span id="reward-credits-display">0</span>
                            </div>
                        </div>
                        <button id="services-menu-btn" title="Portal Institucional" class="relative text-xl p-1 hover:opacity-80 transition-opacity flex items-center gap-2">
                            <i class="fas fa-graduation-cap text-primary"></i>
                            <span class="text-sm font-semibold text-primary hidden md:inline" data-translate-key="portal">Portal</span>
                        </button>
                        <button id="theme-toggle" title="Cambiar Tema" class="text-xl p-1"><i class="fas fa-moon" id="theme-icon"></i></button>
                    </div>
                </div>
                 <div id="services-menu" class="absolute top-full right-4 mt-2 w-80 rounded-xl shadow-lg border border-themed z-30 p-4 origin-top-right">
                    <h4 class="font-bold text-lg mb-1 text-text-light" data-translate-key="portal_title">Portal Institucional</h4>
                    <p class="text-sm text-text-medium mb-4" data-translate-key="portal_desc">Accesos directos a los servicios del Centro Iberoamericano de Educación.</p>
                    <ul class="space-y-3">
                        <li><a id="sol-main-site" href="https://www.ibero.education" target="_blank" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Sitio Web Principal</p><p class="text-sm text-text-medium">Visita nuestra página oficial.</p></a></li>
                         <li><a id="sol-admissions" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Admisiones</p><p class="text-sm text-text-medium">Información para nuevos estudiantes.</p></a></li>
                        <li><a id="sol-contact" href="#" class="block p-3 rounded-lg hover:bg-medium transition-colors"><p class="font-semibold text-primary">Contacto</p><p class="text-sm text-text-medium">Comunícate con nosotros.</p></a></li>
                    </ul>
                </div>
            </header>
            <div class="block sm:hidden text-center py-1.5 border-b border-themed bg-current-bg-dark shadow-sm flex-shrink-0">
                <div id="mobile-chat-title-wrapper" class="flex items-center justify-center group cursor-pointer px-4 relative" title="Renombrar">
                    <i class="fas fa-pencil-alt text-xs text-text-medium edit-icon"></i>
                    <h2 id="mobile-chat-title" class="text-sm font-semibold truncate">Aula Virtual</h2>
                    <button id="motivation-btn-mobile" title="Motivación Diaria" class="text-yellow-400 hover:text-yellow-300 p-2 transition-colors"><i class="fas fa-lightbulb text-lg"></i></button>
                    <button id="calendar-btn-mobile" title="Mi Calendario y Tareas" class="text-sky-400 hover:text-sky-300 p-2 transition-colors notification-bell-icon">
                        <i class="fas fa-calendar-days text-lg"></i>
                        <span id="notification-badge-mobile" class="notification-badge hidden">0</span>
                    </button>
                </div>
             </div>
             <div id="view-container" class="flex-1 overflow-hidden relative">
                <div id="course-view" class="hidden h-full">
                    </div>

                <div id="chat-messages" class="h-full overflow-y-auto p-3 sm:p-6">
                    <div class="flex justify-center items-center h-full" id="initial-message-container">
                        <div id="welcome-message-wrapper" class="text-center text-text-medium">
                            <img src="https://ibero.education/wp-content/uploads/2023/12/LOGO-IBERO-EN-PNG.png" alt="Logo Institucional" class="w-24 h-24 object-contain mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/96x96/2c2c2c/e0e0e0?text=CIE';">
                            <h2 class="text-3xl font-bold text-text-light">Centro Iberoamericano de Educación</h2>
                            <div id="personalized-welcome" class="hidden"><p class="text-lg mt-1"><span data-translate-key="welcome_user">¡Hola, </span><span id="user-name"></span><span data-translate-key="welcome_user_2">! Te damos la bienvenida a tu aula virtual.</span></p></div>
                            <div id="generic-welcome" class="hidden"><p class="text-xl" data-translate-key="welcome_guest">Inicia sesión para acceder a tus cursos.</p></div>
                        </div>
                    </div>
                </div>

                <div id="notepad-view-container" class="hidden">
                    <div id="notes-list-panel">
                        <div id="notes-list-header" class="flex items-center gap-2">
                            <button id="add-new-note-btn" class="w-full btn-primary text-sm flex items-center justify-center gap-2"><i class="fas fa-file-alt"></i>Nueva Nota</button>
                            <button id="add-new-drawing-btn" class="p-2 bg-input rounded-md" title="Nuevo Dibujo"><i class="fas fa-paint-brush"></i></button>
                        </div>
                    </div>
                    <div id="notepad-editor-and-chat-container">
                        <div id="note-editor-panel">
                             <div id="note-editor-toolbar">
                                <button id="note-back-btn" title="Volver a la lista" class="p-2 hidden mr-2"><i class="fas fa-arrow-left"></i></button>
                                <input id="note-title-input" type="text" placeholder="Título de la nota...">
                                <div id="text-tools" class="flex items-center gap-1 ml-auto">
                                    <button data-command="bold" title="Negrita"><i class="fas fa-bold"></i></button>
                                    <button data-command="italic" title="Cursiva"><i class="fas fa-italic"></i></button>
                                    <button data-command="underline" title="Subrayado"><i class="fas fa-underline"></i></button>
                                    <button data-command="insertUnorderedList" title="Viñetas"><i class="fas fa-list-ul"></i></button>
                                    <button data-command="insertOrderedList" title="Lista numerada"><i class="fas fa-list-ol"></i></button>
                                    <button id="add-checklist-item-btn" title="Checklist"><i class="fas fa-check-square"></i></button>
                                </div>
                                <div id="drawing-tools" class="hidden items-center gap-2">
                                    <button id="tool-pencil" class="drawing-tool active" title="Lápiz"><i class="fas fa-pencil-alt"></i></button>
                                    <button id="tool-eraser" class="drawing-tool" title="Borrador"><i class="fas fa-eraser"></i></button>
                                    <input type="color" id="drawing-color" class="drawing-tool" title="Color" value="#000000">
                                    <input type="range" id="drawing-line-width" class="drawing-tool" min="1" max="50" value="3" title="Grosor">
                                    <button id="clear-canvas-btn" class="drawing-tool" title="Limpiar todo"><i class="fas fa-trash-alt"></i></button>
                                </div>
                                <button id="share-note-btn" title="Compartir / Colaborar" class="p-2 ml-2"><i class="fas fa-user-plus"></i></button>
                                <button id="delete-note-btn" title="Eliminar Nota" class="p-2 text-red-500 hover:text-red-400 transition-colors"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <div id="note-content-area" class="relative flex-grow">
                                <div id="note-content-editor" contenteditable="true" class="h-full"></div>
                                <canvas id="note-canvas" class="absolute top-0 left-0 hidden"></canvas>
                            </div>
                        </div>
                        <div id="notepad-chat-container" class="hidden md:flex">
                            <div id="notepad-chat-header" class="flex justify-between items-center cursor-pointer p-2">
                                <h3 class="text-lg font-semibold text-primary">Asistente de Redacción</h3>
                                <button id="notepad-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-up"></i></button>
                            </div>
                            <div class="notepad-chat-body">
                                <div id="notepad-chat-messages" class="chat-bubble-bot"></div>
                                <div class="mt-auto pt-2">
                                    <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                                        <div class="flex items-center space-x-2">
                                           <label for="notepad-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1">Modelo:</label>
                                            <div class="model-selector-wrapper">
                                               <select id="notepad-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                                    <option value="gpt-3.5-turbo-1106">IA General</option>
                                                    <option value="sonar">Búsqueda Web</option>
                                                    <option value="gpt-4o" class="goat-x-pro-model">IA Avanzada</option>
                                                </select>
                                                 <i class="fas fa-chevron-down text-xs"></i>
                                           </div>
                                        </div>
                                   </div>
                                    <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                        <textarea id="notepad-msg" placeholder="Pide ideas, resúmenes, o correcciones..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm"></textarea>
                                        <button id="notepad-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="financial-assistant-view" class="hidden h-full"></div>
                
                <div id="project-management-view" class="hidden p-4 h-full">
                    <div id="project-board-container" class="flex flex-col h-full">
                        <div class="flex flex-wrap justify-between items-center mb-4 flex-shrink-0 gap-2">
                            <h2 id="project-view-title" class="text-2xl font-bold">Proyecto de Clase</h2>
                             <div id="project-tag-filter-container" class="relative">
                                <button id="tag-filter-btn" class="p-2 rounded-md bg-input text-sm"><i class="fas fa-tag mr-1"></i> Filtrar</button>
                                <div id="tag-filter-dropdown" class="hidden absolute right-0 mt-1 p-2 rounded-md shadow-lg w-48"></div>
                             </div>
                        </div>
                         <div class="flex items-center space-x-2 project-view-controls mb-4 flex-shrink-0">
                            <span class="text-sm text-text-medium hidden sm:inline">Vistas:</span>
                             <button id="view-toggle-kanban" class="px-3 py-1 text-sm rounded-md">Kanban</button>
                            <button id="view-toggle-list" class="px-3 py-1 text-sm rounded-md">Lista</button>
                            <button id="add-task-list-view-btn" title="Añadir Tarea" class="hidden ml-auto p-2 rounded-md bg-primary text-white"><i class="fas fa-plus"></i></button>
                            <button id="project-calendar-btn" title="Calendario del Proyecto" class="text-sky-400 hover:text-sky-300 p-2 transition-colors ml-auto"><i class="fas fa-calendar-alt text-xl"></i></button>
                        </div>
                         <div id="kanban-view" class="hidden flex-1">
                            </div>
                        <div id="list-view" class="hidden flex-1 flex-col">
                        </div>
                        <div id="list-view-mobile" class="hidden flex-1 overflow-y-auto">
                        </div>
                    </div>
                    <div id="project-chat-container">
                         <div id="project-chat-container-header" class="flex justify-between items-center cursor-pointer p-2">
                            <h3 class="text-lg font-semibold text-primary">Asistente de Proyecto</h3>
                            <button id="project-chat-toggle" class="text-xl p-2"><i class="fas fa-angle-up"></i></button>
                        </div>
                         <div class="project-chat-body">
                            <div id="project-chat-messages" class="chat-bubble-bot"></div>
                            <div id="project-input-area" class="mt-auto pt-2">
                                 <div class="pro-controls-bg rounded-lg p-1.5 mb-2">
                                     <div class="flex items-center space-x-2">
                                        <label for="project-model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1">Modelo:</label>
                                         <div class="model-selector-wrapper">
                                            <select id="project-model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                                <option value="gpt-3.5-turbo-1106">IA General</option>
                                                <option value="sonar">Búsqueda Web</option>
                                                <option value="gpt-4o" class="goat-x-pro-model">IA Avanzada</option>
                                             </select>
                                              <i class="fas fa-chevron-down text-xs"></i>
                                        </div>
                                     </div>
                                </div>
                                 <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                                     <textarea id="project-msg" placeholder="Deja que la IA organice tu proyecto..." class="flex-1 bg-transparent p-2 h-10 max-h-28 resize-none outline-none placeholder-themed text-sm"></textarea>
                                    <button id="project-send" title="Enviar" class="p-2 sm:p-3 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i class="fa fa-paper-plane text-lg"></i></button>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="input-area" class="p-2 sm:p-4 border-t border-themed flex-shrink-0">
                <div id="file-preview-area" class="mb-2 space-y-2 px-1 sm:px-0">
                     <div id="image-preview-container" class="hidden relative">
                        <img id="image-preview" src="#" alt="Image Preview">
                        <span id="image-name" class="text-xs text-text-medium truncate flex-grow"></span>
                         <button id="clear-image-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                    <div id="pdf-preview-container" class="hidden relative">
                        <i class="fas fa-file-pdf text-red-500 text-xl"></i>
                         <div class="flex-grow min-w-0">
                            <p id="pdf-name" class="font-medium truncate"></p>
                            <p id="pdf-status" class="text-xxs font-mono"></p>
                         </div>
                        <button id="clear-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs z-10 p-0 leading-none">&times;</button>
                    </div>
                </div>
                <div class="pro-controls-bg rounded-lg p-1 cool-light-effect">
                    <div id="pro-controls-left">
                        <label for="model-selector" class="font-medium text-xs text-text-medium pl-2 pr-1" data-translate-key="model">Modelo IA:</label>
                        <div class="model-selector-wrapper">
                            <select id="model-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light">
                                <option value="gpt-3.5-turbo-1106" data-translate-key="model_general">IA General</option>
                                <option value="sonar" data-translate-key="model_web">IA con Búsqueda Web</option>
                                <option value="gpt-4o" class="goat-x-pro-model">IA Avanzada</option>
                            </select>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                    <div id="pro-controls-right">
                        <div id="voice-selector-container" class="hidden items-center space-x-2">
                            <label for="voice-selector" class="font-medium text-xs text-text-medium" data-translate-key="voice">Voz:</label>
                            <div class="model-selector-wrapper">
                                <select id="voice-selector" class="rounded-md py-1 pl-1.5 focus:outline-none focus:ring-2 focus:ring-primary text-sm bg-transparent text-text-light w-24"></select>
                            </div>
                        </div>
                        <div id="action-buttons-container" class="flex items-center">
                            <button id="pdf-upload-btn" title="Subir PDF" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-file-pdf text-lg"></i></button>
                            <button id="image-upload-btn" title="Subir Imagen" class="p-2 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-image text-lg"></i></button>
                        </div>
                    </div>
                 </div>
                <div class="relative rounded-xl flex items-center bg-input p-1 sm:p-2 input-wrapper">
                    <input type="file" id="pdf-upload" accept=".pdf,application/pdf" class="hidden"><input type="file" id="image-upload" accept="image/*" class="hidden">
                    <button id="mic-btn" title="Entrada de Voz" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-microphone text-xl"></i></button>
                     <button id="tts-toggle" title="Activar/Desactivar Voz" class="p-2 sm:p-3 hover:text-primary transition-colors rounded-full text-text-medium"><i class="fa fa-volume-mute text-xl"></i></button>
                    <textarea id="msg" placeholder="Escribe una consulta al Tutor IA o arrastra un archivo..." class="flex-1 bg-transparent p-2 h-12 max-h-32 resize-none outline-none placeholder-themed" rows="1" data-translate-key="placeholder_main"></textarea>
                    <button id="send" title="Enviar" class="p-2 sm:p-4 disabled:opacity-50 disabled:cursor-not-allowed text-primary"><i id="send-icon" class="fa fa-paper-plane text-xl"></i></button>
                 </div>
                <div id="contextual-footer" class="text-center text-xs text-text-medium mt-2 px-2 h-4"></div>
            </div>
        </main>
    </div>

    <div id="in-app-notification">
        <div id="in-app-notification-header">
            <h4 id="in-app-notification-title"></h4>
            <button id="in-app-notification-close" class="text-text-medium hover:text-text-light text-2xl leading-none">&times;</button>
        </div>
        <p id="in-app-notification-body"></p>
    </div>

    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <div id="modal-body" class="mb-4 text-text-medium text-sm"></div>
            <div id="modal-buttons-container" class="flex justify-end space-x-2">
                 </div>
        </div>
    </div>

    <div id="motivation-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-lg w-full max-w-md p-6 relative text-center">
            <i class="fas fa-lightbulb text-4xl text-yellow-400 mb-4"></i>
            <h3 id="motivation-title" class="text-2xl mb-4">Dosis de Motivación</h3>
            <p id="motivation-quote" class="text-lg text-text-light mb-6 min-h-[50px]"></p>
            <div class="flex items-center justify-center mb-6">
                <label for="motivation-toggle" class="flex items-center cursor-pointer">
                    <span class="mr-3 text-text-light font-medium">
                        Notificaciones periódicas
                    </span>
                    <div class="relative">
                        <input type="checkbox" id="motivation-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                    </div>
                </label>
            </div>
            <button id="close-motivation-modal" class="btn-primary px-6 py-2 rounded-lg">¡Entendido!</button>
        </div>
    </div>
    
    <div id="pricing-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-5xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-6">
                <h2 class="text-3xl md:text-4xl font-extrabold text-center flex-grow" data-translate-key="plans_title">Programas Académicos</h2>
                 <button id="close-pricing-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="modal-content-body flex-grow overflow-y-auto px-2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-text-light">
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">Cursos de Formación</h3>
                        <p class="text-lg text-text-medium my-3">Continúa tu desarrollo profesional</p>
                         <ul class="text-sm space-y-2 mb-4 text-left">
                            <li><i class="fas fa-check-circle mr-2"></i>Certificación al finalizar</li>
                            <li><i class="fas fa-check-circle mr-2"></i>Acceso a material de por vida</li>
                             <li><i class="fas fa-check-circle mr-2"></i>Tutoría especializada</li>
                        </ul>
                        <button class="mt-auto w-full p-3 rounded-lg font-semibold border-2 border-primary text-primary hover:bg-primary hover:text-white transition-colors" data-translate-key="plan_free_cta">Ver Cursos</button>
                     </div>
                    <div class="plan-card border-2 rounded-xl p-6 flex flex-col bg-current-bg-dark plan-card-highlight">
                        <h3 class="text-2xl font-bold">Diplomado en <span class="text-primary">IA Aplicada</span></h3>
                         <p class="text-xl font-extrabold my-3">120 horas</p>
                        <button class="w-full p-2 text-sm rounded-lg font-semibold border border-primary text-primary hover:bg-primary hover:text-white transition-colors mb-4 plan-details-toggle">Ver Detalles</button>
                        <div class="plan-details text-sm text-left">
                             <ul class="space-y-2 mb-4 plan-feature-list">
                                <li><i class="fas fa-check-circle mr-2"></i><strong>Módulo 1:</strong> Fundamentos de IA</li>
                                <li><i class="fas fa-check-circle mr-2"></i><strong>Módulo 2:</strong> Machine Learning</li>
                                 <li><i class="fas fa-check-circle mr-2"></i><strong>Módulo 3:</strong> Proyecto Final</li>
                                <li><i class="fas fa-check-circle mr-2"></i>Doble certificación</li>
                            </ul>
                         </div>
                        <button data-program="diplo-ia" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_boost_cta">Solicitar Información</button>
                    </div>
                    <div class="plan-card border-2 border-themed rounded-xl p-6 flex flex-col">
                        <h3 class="text-2xl font-bold">Bachillerato Intensivo</h3>
                        <p class="text-xl font-extrabold my-3">En 10 meses</p>
                         <button class="w-full p-2 text-sm rounded-lg font-semibold border border-primary text-primary hover:bg-primary hover:text-white transition-colors mb-4 plan-details-toggle">Ver Detalles</button>
                        <div class="plan-details text-sm text-left">
                            <ul class="space-y-2 mb-4 plan-feature-list">
                                 <li><i class="fas fa-check-circle mr-2"></i>Título avalado</li>
                                <li><i class="fas fa-check-circle mr-2"></i>Plataforma virtual 24/7</li>
                                <li><i class="fas fa-check-circle text-gold"></i><strong>Inscripciones Abiertas</strong></li>
                                 <li><i class="fas fa-check-circle mr-2"></i>Plan de estudios flexible</li>
                            </ul>
                         </div>
                        <button data-program="bachillerato" class="select-plan-btn mt-auto w-full p-3 rounded-lg font-semibold btn-primary transition-colors" data-translate-key="plan_pro_cta">Inscribirme Ahora</button>
                    </div>
                </div>
             </div>
        </div>
    </div>

    <div id="html-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4"><div class="modal-content rounded-2xl w-full h-full max-w-4xl p-2 md:p-4 relative flex flex-col"><h3 class="text-lg font-bold" data-translate-key="preview">Vista Previa</h3><button id="close-html-preview-modal" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button></div><iframe id="html-preview-iframe" class="w-full flex-grow h-full border-2 border-themed rounded-lg bg-white"></iframe></div>
    
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div class="modal-content rounded-lg w-full max-w-lg p-6 relative">
             <h3 class="text-lg font-bold mb-4" data-translate-key="settings">Configuración</h3>
            <div class="space-y-4 text-sm max-h-[70vh] overflow-y-auto pr-2">
                <div>
                    <p class="font-semibold" data-translate-key="settings_email">Correo Electrónico:</p>
                    <p id="settings-user-email" class="text-text-medium"></p>
                 </div>
                <div>
                    <p class="font-semibold" data-translate-key="settings_plan">Mi Programa:</p>
                    <p id="settings-user-plan" class="text-text-medium"></p>
                    <button id="settings-upgrade-plan-btn" class="text-primary hover:underline mt-1 text-xs" data-translate-key="upgrade_plan">Ver Programas</button>
                 </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_fontsize">Tamaño de Letra:</p>
                    <input type="range" id="font-size-slider" min="12" max="18" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg dark:bg-gray-700">
                    <span id="font-size-value" class="text-xs text-text-medium">14.5px</span>
                </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_theme">Apariencia:</p>
                    <button id="settings-theme-toggle" class="flex items-center p-2 rounded hover:bg-medium w-full text-left">
                         <i class="fas fa-moon mr-2" id="settings-theme-icon"></i>
                        <span data-translate-key="settings_dark_mode">Modo Oscuro</span>
                    </button>
                </div>
                <div>
                     <div class="flex items-center justify-between">
                        <p class="font-semibold" data-translate-key="settings_notifications">Notificaciones de Entregas:</p>
                        <label for="notifications-toggle" class="inline-flex relative items-center cursor-pointer">
                            <input type="checkbox" id="notifications-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                 </div>
                <div>
                    <p class="font-semibold mb-2" data-translate-key="settings_lang">Idioma:</p>
                    <select id="language-selector" class="w-full p-2 rounded bg-input border border-themed">
                         <option value="es">Español</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="border-t border-themed pt-4 mt-4">
                     <h4 class="font-semibold mb-2" data-translate-key="settings_integrations">Integraciones</h4>
                     <div class="space-y-2">
                        <button id="connect-google-calendar-btn" class="w-full bg-input p-2 rounded-lg flex items-center justify-start text-left hover:bg-light transition-colors">
                             <i class="fab fa-google mr-3 text-red-500 fa-lg"></i>
                            <div>
                                <span class="font-semibold">Google Calendar</span>
                                 <p class="text-xs text-text-medium">Sincroniza tus fechas de entrega.</p>
                            </div>
                        </button>
                        </div>
                </div>
                <div>
                    <button id="connect-whatsapp-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center mb-2">
                         <i class="fab fa-whatsapp mr-2"></i><span data-translate-key="settings_whatsapp">Contactar a Secretaría</span>
                    </button>
                    <a href="https://calendly.com/goatify" target="_blank" id="schedule-meeting-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar-alt mr-2"></i><span data-translate-key="settings_schedule_meeting">Agendar Reunión Académica</span>
                     </a>
                </div>
            </div>
            <button id="close-settings-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>

    <div id="calendar-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-40 p-4">
        <div id="calendar-modal" class="modal-content rounded-lg w-full max-w-4xl p-6 relative">
             <h3 class="text-lg font-bold mb-4" data-translate-key="calendar_my_calendar">Mi Calendario Académico</h3>
            <div class="calendar-view-toggle mb-4">
                <button id="day-view-btn" data-translate-key="calendar_day_view">Vista de Día</button>
                <button id="week-view-btn" data-translate-key="calendar_week_view">Vista de Semana</button>
                <button id="month-view-btn" class="active" data-translate-key="calendar_month_view">Vista de Mes</button>
             </div>

            <div id="day-view-container">
                 <div class="calendar-header">
                    <button id="prev-day" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-day-display" class="text-xl font-semibold"></h4>
                     <button id="next-day" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="day-view-timeline"></div>
            </div>

            <div id="week-view-container">
                <div class="calendar-header">
                     <button id="prev-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-week-range" class="text-xl font-semibold"></h4>
                    <button id="next-week" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                 <div id="week-days-content"></div>
            </div>

            <div id="month-view-container">
                <div class="calendar-header">
                    <button id="prev-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                    <h4 id="current-month-year" class="text-xl font-semibold"></h4>
                     <button id="next-month" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid mb-4">
                    <div class="font-bold text-primary" data-translate-key="calendar_mon">Lun</div>
                     <div class="font-bold text-primary" data-translate-key="calendar_tue">Mar</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_wed">Mié</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_thu">Jue</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_fri">Vie</div>
                    <div class="font-bold text-primary" data-translate-key="calendar_sat">Sáb</div>
                     <div class="font-bold text-primary" data-translate-key="calendar_sun">Dom</div>
                </div>
                <div id="calendar-days-grid" class="calendar-grid"></div>
            </div>

            <div class="mt-6 border-t border-themed pt-4">
                <button id="add-task-btn" class="w-full btn-primary p-2 rounded-lg flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i><span data-translate-key="calendar_add_task_btn">Añadir Tarea/Recordatorio</span>
                </button>
            </div>

            <button id="close-calendar-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>
    
    <div id="task-notification-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-[110] p-4">
        <div class="modal-content text-center rounded-lg w-full max-w-md p-8 relative">
            <h3 id="task-notification-title" class="text-2xl font-bold mb-4"></h3>
            <div id="task-notification-body" class="text-lg text-text-light mb-8"></div>
            <button id="task-notification-close-btn" class="btn-primary px-8 py-3 rounded-lg font-semibold">Listo</button>
        </div>
    </div>

    <div id="gamification-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
        <div class="modal-content rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col p-6 relative transform scale-95 transition-transform duration-300">
            <div class="flex-shrink-0 flex items-center justify-between mb-4">
                <h2 class="text-3xl font-extrabold text-gold">
                    <i class="fas fa-trophy mr-2"></i>Mi Progreso Académico </h2>
                <button id="close-gamification-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times fa-lg"></i></button>
            </div>
            
            <div class="p-4 bg-input rounded-lg mb-4 flex-shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <span id="gamification-level-name" class="font-bold text-xl text-text-light">Nivel 1: Estudiante Iniciado</span>
                    <div class="text-right">
                        <span id="gamification-xp" class="font-bold text-primary">0 / 100 XP</span>
                         <p id="gamification-credits" class="text-sm text-gold font-semibold"><i class="fas fa-coins mr-1"></i>0 Puntos</p>
                    </div>
                </div>
                <div class="w-full xp-bar-bg rounded-full h-4">
                    <div id="gamification-xp-bar" class="xp-bar-fill h-4 rounded-full" style="width: 0%;"></div>
                 </div>
            </div>

            <div class="flex-grow overflow-hidden flex flex-col">
                <div class="flex-shrink-0 gamification-tabs flex items-center space-x-2">
                    <button class="gamification-tab active" data-tab="racha">Racha de Estudio</button>
                     <button class="gamification-tab" data-tab="misiones">Objetivos</button>
                    <button class="gamification-tab" data-tab="logros">Logros</button>
                    <button id="gamification-rules-btn" class="ml-auto text-sm text-text-medium hover:text-primary"><i class="fas fa-circle-question mr-1"></i> Cómo funciona</button>
                </div>
                <div class="flex-grow overflow-y-auto pt-4">
                     <div id="gamification-tab-racha" class="gamification-tab-content space-y-4">
                        <p class="text-center text-text-medium">Mantén tu racha de estudio para ganar XP, puntos y recompensas.</p>
                         <div id="daily-streak-container" class="grid grid-cols-7 gap-2 md:gap-4 text-center">
                            </div>
                    </div>
                     <div id="gamification-tab-misiones" class="gamification-tab-content hidden space-y-3">
                        </div>
                     <div id="gamification-tab-logros" class="gamification-tab-content hidden">
                        <div id="achievements-container" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                           </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="gamification-rules-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-[60] p-4">
         <div class="modal-content rounded-lg w-full max-w-2xl p-6 relative">
            <h3 class="text-lg font-bold mb-4 text-gold"><i class="fas fa-scroll mr-2"></i>Reglas de "Mi Progreso Académico"</h3>
            <div class="space-y-4 text-text-medium text-sm max-h-[70vh] overflow-y-auto pr-2">
                <p>¡Te damos la bienvenida a tu ruta de aprendizaje! La idea es simple: cuanto más interactúas con tus cursos y herramientas, más recompensas obtienes para enriquecer tu experiencia.</p>
                <div>
                    <h4 class="font-semibold text-text-light mt-3">1. Puntos de Experiencia (XP) vs. Puntos de Recompensa (🪙)</h4>
                    <p>Existen dos tipos de recompensas:</p>
                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li><strong>Puntos de Experiencia (XP):</strong> Miden tu progreso y avance académico. El XP <strong class="text-primary">nunca se gasta</strong>, solo se acumula para que subas de nivel y desbloquees nuevos títulos.</li>
                        <li><strong>Puntos de Recompensa (🪙):</strong> Son una <strong class="text-gold">reserva de puntos canjeables</strong> que ganas al completar objetivos y rachas. Puedes usarlos para acceder a contenido extra o consultas avanzadas con el Tutor IA.</li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-semibold text-text-light mt-3">2. Cómo Subir de Nivel</h4>
                    <p>Acumula XP para ascender de rango académico. Cada nivel representa una nueva etapa de tu dominio.</p>
                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li>Nivel 1: <strong>Estudiante Iniciado</strong></li>
                        <li>Nivel 2: <strong>Aprendiz Aplicado</strong></li>
                         <li>Nivel 3: <strong>Investigador Junior</strong></li>
                        <li>Nivel 4: <strong>Erudito</strong></li>
                        <li>Nivel 5: <strong>Graduado con Honores</strong></li>
                    </ul>
                </div>
                  <div>
                    <h4 class="font-semibold text-text-light mt-3">3. Cómo Ganar Recompensas</h4>
                     <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                        <li><strong>Racha de Estudio:</strong> Cada día consecutivo que ingresas a la plataforma te da XP y Puntos de Recompensa.</li>
                        <li><strong>Recompensa Semanal (Día 7):</strong> ¡Tu gran premio por 7 días de estudio consecutivo!</li>
                        <li><strong>Objetivos y Logros:</strong> La forma más rápida de ganar bonificaciones de XP y Puntos. Completa tareas específicas para acelerar tu progreso.</li>
                    </ul>
                </div>
                 <p class="font-bold text-center mt-4 text-lg text-primary">¡Cada lección aprendida y tarea completada te acerca a la meta!</p>
            </div>
            <button id="close-gamification-rules-modal" class="absolute top-4 right-4 text-gray-400 hover:text-text-light"><i class="fas fa-times fa-lg"></i></button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        //<-- INICIO DEL SCRIPT DEL AULA VIRTUAL (BLOQUE 1/2) -->
        window.addEventListener('DOMContentLoaded', () => {
            dayjs.extend(window.dayjs_plugin_localizedFormat);
            dayjs.extend(window.dayjs_plugin_isoWeek);
             
            // Objeto de traducciones para la UI
            const translations = {
                es: {
                    initializing: "Inicializando Aula Virtual...", new_query: "Nueva Consulta", new_folder: "Nueva Carpeta",
                    library: "Biblioteca y Recursos",
                    upgrade_plan: "Ver Programas", navigation: "Navegación",
                    my_courses: "Mis Cursos", grades: "Calificaciones", notepad: "Bloc de Notas",
                    ai_tools: "Herramientas IA", decision_lab: "Laboratorio de Decisiones", concept_explainer: "Explicador de Conceptos",
                    ai_tutor: "Tutor IA", tutor_ask: "Resolver una Duda", tutor_practice: "Practicar para Examen", tutor_feedback: "Revisar un Trabajo",
                    language_assistant: "Asistente de Idiomas", wf_eng_1: "Traducir/Corregir Texto", wf_eng_2: "Aprender Vocabulario",
                    select_items: "Seleccionar Múltiples",
                    delete: "Borrar", login: "Iniciar Sesión", settings: "Configuración", logout: "Cerrar Sesión",
                    portal: "Portal", portal_title: "Portal Institucional",
                    portal_desc: "Accesos directos a los servicios del Centro Iberoamericano de Educación.",
                    welcome_user: "¡Hola, ", welcome_user_2: "! Te damos la bienvenida a tu aula virtual.",
                    welcome_guest: "Somos la primera IA que combina un Asistente de Proyectos con Modelos de Lenguaje únicos en el mercado, diseñados para potenciar tu aprendizaje. Inicia sesión para empezar.",
                    model: "Modelo IA:", model_general: "IA General", model_web: "IA con Búsqueda Web", model_advanced: "IA Avanzada",
                    voice: "Voz:", placeholder_main: "Escribe una consulta al Tutor IA o arrastra un archivo...",
                    cancel: "Cancelar", confirm: "Confirmar",
                    plans_title: "Programas Académicos",
                    preview: "Vista Previa", settings_email: "Correo Electrónico:", settings_plan: "Mi Programa:",
                    settings_fontsize: "Tamaño de Letra:", settings_theme: "Apariencia:", settings_dark_mode: "Modo Oscuro",
                    settings_lang: "Idioma:", settings_whatsapp: "Contactar a Secretaría", current_plan: "Programa Actual",
                    settings_notifications: "Notificaciones de Entregas:", settings_schedule_meeting: "Agendar Reunión Académica",
                    settings_integrations: "Integraciones",
                    calendar_today: "Hoy", calendar_this_week: "Esta Semana", calendar_mon: "Lun", calendar_tue: "Mar", calendar_wed: "Mié",
                    calendar_thu: "Jue", calendar_fri: "Vie", calendar_sat: "Sáb", calendar_sun: "Dom",
                    calendar_no_tasks: "No hay entregas o eventos para este día.",
                    calendar_add_task_btn: "Añadir Tarea/Recordatorio", calendar_my_calendar: "Mi Calendario Académico",
                    calendar_day_view: "Vista de Día", calendar_month_view: "Vista de Mes", calendar_week_view: "Vista de Semana",
                    notification_task_due: "Recordatorio de entrega: ", notification_title: "Aula Virtual - ¡Tarea Pendiente!",
                    tasks_for: "Tareas para", add_task_for: "Añadir Tarea para",
                    delete_task_confirm_title: "Confirmar Eliminación", delete_task_confirm_body: "¿Estás seguro de que quieres eliminar esta tarea?",
                    delete_btn: "Eliminar",
                    my_projects: "Mis Proyectos",
                    rename: "Renombrar",
                    add_to_folder: "Añadir a Carpeta",
                    remove_from_folder: "Quitar de Carpeta",
                    no_folders_yet: "Aún no hay carpetas. ¡Crea una!",
                    rename_item_title: "Renombrar",
                    delete_item_title: "Eliminar",
                    delete_folder_body: "También se eliminarán los {count} elementos que contiene.",
                    notepad_pro_tools_title: "Herramientas de Redacción Avanzadas",
                    notepad_pro_tools_body: "El formato de texto enriquecido (negritas, cursivas, listas) es una función disponible en los programas de pago. ¡Actualiza para desbloquear todo el potencial de tu bloc de notas!",
                    upgrade_now: "Actualizar Ahora"
                },
                en: {
                    initializing: "Initializing Virtual Classroom...", new_query: "New Query", new_folder: "New Folder",
                    library: "Library & Resources",
                    upgrade_plan: "View Programs", navigation: "Navigation",
                    my_courses: "My Courses", grades: "Grades", notepad: "Notepad",
                    ai_tools: "AI Tools", decision_lab: "Decision Lab", concept_explainer: "Concept Explainer",
                    ai_tutor: "AI Tutor", tutor_ask: "Ask a Question", tutor_practice: "Practice for Exam", tutor_feedback: "Review a Paper",
                    language_assistant: "Language Assistant", wf_eng_1: "Translate/Correct Text", wf_eng_2: "Learn Vocabulary",
                    select_items: "Select Multiple",
                    delete: "Delete", login: "Login", settings: "Settings", logout: "Logout",
                    portal: "Portal", portal_title: "Institutional Portal",
                    portal_desc: "Shortcuts to the services of the Centro Iberoamericano de Educación.",
                    welcome_user: "Hello, ", welcome_user_2: "! Welcome to your virtual classroom.",
                    welcome_guest: "We are the first AI to combine a Project Assistant with unique Language Models, designed to enhance your learning. Please log in to begin.",
                    model: "AI Model:", model_general: "General AI", model_web: "Web-Enhanced AI", model_advanced: "Advanced AI",
                    voice: "Voice:", placeholder_main: "Ask the AI Tutor a question or drag a file...",
                    cancel: "Cancel", confirm: "Confirm",
                    plans_title: "Academic Programs",
                    preview: "Preview", settings_email: "Email Address:", settings_plan: "My Program:",
                    settings_fontsize: "Font Size:", settings_theme: "Appearance:", settings_dark_mode: "Dark Mode",
                    settings_lang: "Language:", settings_whatsapp: "Contact Administration", current_plan: "Current Program",
                    settings_notifications: "Assignment Notifications:", settings_schedule_meeting: "Schedule Academic Meeting",
                    settings_integrations: "Integrations",
                    calendar_today: "Today", calendar_this_week: "This Week", calendar_mon: "Mon", calendar_tue: "Tue", calendar_wed: "Wed",
                    calendar_thu: "Thu", calendar_fri: "Fri", calendar_sat: "Sat", calendar_sun: "Sun",
                    calendar_no_tasks: "No assignments or events for this day.",
                    calendar_add_task_btn: "Add Task/Reminder", calendar_my_calendar: "My Academic Calendar",
                    calendar_day_view: "Day View", calendar_month_view: "Month View", calendar_week_view: "Week View",
                    notification_task_due: "Assignment Reminder: ", notification_title: "Virtual Classroom - Assignment Due!",
                    tasks_for: "Tasks for", add_task_for: "Add Task for",
                    delete_task_confirm_title: "Confirm Deletion", delete_task_confirm_body: "Are you sure you want to delete this task?",
                    delete_btn: "Delete",
                    my_projects: "My Projects",
                    rename: "Rename",
                    add_to_folder: "Add to Folder",
                    remove_from_folder: "Remove from Folder",
                    no_folders_yet: "No folders yet. Create one!",
                    rename_item_title: "Rename",
                    delete_item_title: "Delete",
                    delete_folder_body: "This will also delete the {count} items it contains.",
                    notepad_pro_tools_title: "Advanced Writing Tools",
                    notepad_pro_tools_body: "Rich text formatting (bold, italics, lists) is a feature available in paid programs. Upgrade to unlock the full potential of your notepad!",
                    upgrade_now: "Upgrade Now"
                }
            };
            
            const GUEST_CONSULTA_LIMIT = 5;
            const STUDENT_CONSULTA_LIMIT = 50;
            const PRO_PLAN_CREDIT_LIMIT = 2000;

            const MOTIVATIONAL_MESSAGES = [
                "El éxito es la suma de pequeños esfuerzos repetidos día tras día. ¡Sigue así!",
                "Cree en ti y todo lo que eres. Eres más fuerte que cualquier obstáculo.",
                "El aprendizaje es un tesoro que seguirá contigo siempre. ¡Descúbrelo!",
                "No te detengas hasta que te sientas orgulloso.",
                "La mejor forma de predecir el futuro es crearlo. ¡Estás en el camino correcto!",
                "Un pequeño progreso cada día se suma a grandes resultados."
            ];
            const MOTIVATION_BUTTON_TEXTS = ["¡Entendido!", "¡Vamos a darle!", "¡A seguir!", "¡Claro que sí!", "¡Adelante!"];

            const COSTS = { 
                GENERAL: 1, 
                SEARCH: 2, 
                WORKFLOW: 2,
                PDF_ANALYSIS: 2,
                IMAGE_ANALYSIS: 2,
                IMAGE_GENERATION: 5,
                GPT4O: 3 
            };
            
            // Estructura de estado rediseñada para el LMS
            let state = { 
                courses: {},
                users: {},
                chats: {},
                projects: {},
                structure: [],
                calendar: {},
                notes: []
            };

            function initializeMockData() {
                if (currentUser && (!state.users[currentUser.id] || !state.users[currentUser.id].enrolledCourses.length)) {
                    const courseId = 'crs-ia101';
                    state.courses[courseId] = {
                        id: courseId,
                        title: 'Inteligencia Artificial 101',
                        description: 'Un curso introductorio a los fundamentos de la IA.',
                        assignments: [
                            { id: 'assign-1', title: 'Ensayo: Impacto de la IA', dueDate: dayjs().add(5, 'day').format('YYYY-MM-DD'), time: '23:59', source: 'Inteligencia Artificial 101' },
                            { id: 'assign-2', title: 'Quiz: Conceptos Básicos', dueDate: dayjs().add(10, 'day').format('YYYY-MM-DD'), time: '23:59', source: 'Inteligencia Artificial 101' }
                        ]
                    };
                    if (!state.users[currentUser.id]) {
                        state.users[currentUser.id] = { id: currentUser.id, name: currentUser.user_metadata?.full_name || 'Estudiante', role: 'student', enrolledCourses: [] };
                    }
                    state.users[currentUser.id].enrolledCourses.push(courseId);
                }
            }


            let gamificationState = {};
            let currentChatId = null, currentUser = null, speechOn = false, availableVoices = [], selectedVoice = null, isRecognizing = false, selectedImageBase64 = null, selectedPdfText = null;
            let currentCourseId = null;
            let micWasOnBeforeSpeaking = false;
            let modalResolve = null;
            let modalKeydownHandler = null;
            let isSelectModeActive = false;
            let chatsToDelete = new Set();
            let selectionBox = null;
            let startSelectionPoint = { x: 0, y: 0 };
            let isMouseDownForSelection = false;
            let currentNoteId = null;
            let goatXProUsage = 0; 
            const GOAT_X_PRO_DAILY_LIMIT = 10; 

            let notificationsEnabled = localStorage.getItem('ibero-notifications-enabled') === null ? true : localStorage.getItem('ibero-notifications-enabled') === 'true';
            let motivationEnabled = localStorage.getItem('ibero-motivation-enabled') === null ? true : localStorage.getItem('ibero-motivation-enabled') === 'true';

            let selectedCalendarDate = dayjs();
            let currentCalendarView = 'month';
            let activeTagFilter = null;
            let motivationInterval = null;
            const dom = {};
            
            const fullDom = {
                appContainer: document.getElementById('app-container'),
                msgInput: document.getElementById('msg'), sendBtn: document.getElementById('send'),
                inputArea: document.getElementById('input-area'),
                filePreviewArea: document.getElementById('file-preview-area'),
                messageCounterWrapper: document.getElementById('message-counter-wrapper'), 
                planCreditsInfo: document.getElementById('plan-credits-info'),
                rewardCreditsInfo: document.getElementById('reward-credits-info'),
                upgradePlanContainer: document.getElementById('upgrade-plan-container'),
                upgradePlanBtn: document.getElementById('upgrade-plan-btn'),
                newChatBtn: document.getElementById('new-chat-btn'), newFolderBtn: document.getElementById('new-folder-btn'),
                pricingModal: document.getElementById('pricing-modal'), closePricingModalBtn: document.getElementById('close-pricing-modal'),
                genericModal: document.getElementById('generic-modal'), 
                // Vistas principales
                viewContainer: document.getElementById('view-container'),
                chatMessages: document.getElementById('chat-messages'),
                courseView: document.getElementById('course-view'), 
                notepadViewContainer: document.getElementById('notepad-view-container'),
                projectManagementView: document.getElementById('project-management-view'),
                financialAssistantView: document.getElementById('financial-assistant-view'),
                // Títulos y UI
                chatTitle: document.getElementById('chat-title'), mobileChatTitle: document.getElementById('mobile-chat-title'),
                desktopChatTitleWrapper: document.getElementById('desktop-chat-title-wrapper'), mobileChatTitleWrapper: document.getElementById('mobile-chat-title-wrapper'),
                initialMessageContainer: document.getElementById('initial-message-container'), themeToggle: document.getElementById('theme-toggle'), themeIcon: document.getElementById('theme-icon'),
                micBtn: document.getElementById('mic-btn'), ttsToggle: document.getElementById('tts-toggle'), 
                modelSelector: document.getElementById('model-selector'),
                actionButtonsContainer: document.getElementById('action-buttons-container'),
                imageUploadBtn: document.getElementById('image-upload-btn'), imageUploadInput: document.getElementById('image-upload'),
                imagePreviewContainer: document.getElementById('image-preview-container'), imagePreview: document.getElementById('image-preview'),
                clearImageBtn: document.getElementById('clear-image-btn'), pdfUploadBtn: document.getElementById('pdf-upload-btn'), pdfUploadInput: document.getElementById('pdf-upload'),
                pdfPreviewContainer: document.getElementById('pdf-preview-container'), pdfNameEl: document.getElementById('pdf-name'), pdfStatusEl: document.getElementById('pdf-status'), clearPdfBtn: document.getElementById('clear-pdf-btn'),
                // Sidebar
                sidebar: document.getElementById('sidebar'), menuToggle: document.getElementById('menu-toggle'), sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarContent: document.getElementById('sidebar-content'),
                addProjectFolderBtn: document.getElementById('add-project-folder-btn'),
                // User & Login
                loginView: document.getElementById('login-view'), userMenuView: document.getElementById('user-menu-view'),
                loginBtn: document.getElementById('login-btn'), userMenuBtn: document.getElementById('user-menu-btn'), userMenuPopup: document.getElementById('user-menu-popup'), userEmail: document.getElementById('user-email'),
                logoutBtn: document.getElementById('logout-btn'),
                // Workflows y Footer
                workflowsContainer: document.getElementById('workflows-container'),
                libraryLink: document.getElementById('library-link'),
                personalizedWelcome: document.getElementById('personalized-welcome'), genericWelcome: document.getElementById('generic-welcome'), userName: document.getElementById('user-name'),
                // Overlays & Modals
                loadingOverlay: document.getElementById('loading-overlay'), htmlPreviewModal: document.getElementById('html-preview-modal'),
                closeHtmlPreviewModalBtn: document.getElementById('close-html-preview-modal'), htmlPreviewIframe: document.getElementById('html-preview-iframe'),
                // Controles de voz
                voiceSelector: document.getElementById('voice-selector'), 
                voiceSelectorContainer: document.getElementById('voice-selector-container'),
                // Selección múltiple
                selectChatsBtn: document.getElementById('select-chats-btn'), deleteModeControls: document.getElementById('delete-mode-controls'),
                deleteSelectedBtn: document.getElementById('delete-selected-btn'), cancelSelectModeBtn: document.getElementById('cancel-select-mode-btn'),
                // Menú de servicios
                servicesMenuBtn: document.getElementById('services-menu-btn'), servicesMenu: document.getElementById('services-menu'),
                contextualFooter: document.getElementById('contextual-footer'),
                // Iconos Header
                newChatIconBtn: document.getElementById('new-chat-icon-btn'),
                // Modal de configuración
                settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'), closeSettingsModal: document.getElementById('close-settings-modal'),
                settingsUserEmail: document.getElementById('settings-user-email'), settingsUserPlan: document.getElementById('settings-user-plan'),
                settingsUpgradePlanBtn: document.getElementById('settings-upgrade-plan-btn'), fontSizeSlider: document.getElementById('font-size-slider'),
                fontSizeValue: document.getElementById('font-size-value'), settingsThemeToggle: document.getElementById('settings-theme-toggle'),
                settingsThemeIcon: document.getElementById('settings-theme-icon'), languageSelector: document.getElementById('language-selector'),
                connectWhatsappBtn: document.getElementById('connect-whatsapp-btn'), scheduleMeetingBtn: document.getElementById('schedule-meeting-btn'),
                notificationsToggle: document.getElementById('notifications-toggle'),
                // Modal de Calendario
                mainChatArea: document.getElementById('main-chat-area'),
                calendarModalOverlay: document.getElementById('calendar-modal-overlay'),
                calendarModal: document.getElementById('calendar-modal'),
                calendarBtn: document.getElementById('calendar-btn'),
                calendarBtnMobile: document.getElementById('calendar-btn-mobile'),
                closeCalendarModal: document.getElementById('close-calendar-modal'),
                prevMonthBtn: document.getElementById('prev-month'), nextMonthBtn: document.getElementById('next-month'),
                currentMonthYear: document.getElementById('current-month-year'), calendarDaysGrid: document.getElementById('calendar-days-grid'),
                addTaskBtn: document.getElementById('add-task-btn'),
                notificationBadge: document.getElementById('notification-badge'),
                notificationBadgeMobile: document.getElementById('notification-badge-mobile'),
                inAppNotification: document.getElementById('in-app-notification'), 
                inAppNotificationTitle: document.getElementById('in-app-notification-title'),
                inAppNotificationBody: document.getElementById('in-app-notification-body'),
                inAppNotificationClose: document.getElementById('in-app-notification-close'),
                taskNotificationModal: document.getElementById('task-notification-modal'),
                taskNotificationTitle: document.getElementById('task-notification-title'),
                taskNotificationBody: document.getElementById('task-notification-body'),
                taskNotificationCloseBtn: document.getElementById('task-notification-close-btn'),
                monthViewContainer: document.getElementById('month-view-container'), weekViewContainer: document.getElementById('week-view-container'),
                dayViewContainer: document.getElementById('day-view-container'),
                monthViewBtn: document.getElementById('month-view-btn'), weekViewBtn: document.getElementById('week-view-btn'), dayViewBtn: document.getElementById('day-view-btn'),
                prevWeekBtn: document.getElementById('prev-week'), nextWeekBtn: document.getElementById('next-week'),
                currentWeekRange: document.getElementById('current-week-range'), weekDaysContent: document.getElementById('week-days-content'),
                prevDayBtn: document.getElementById('prev-day'), nextDayBtn: document.getElementById('next-day'),
                currentDayDisplay: document.getElementById('current-day-display'), dayViewTimeline: document.getElementById('day-view-timeline'),
                // Vista de Proyecto
                projectBoardContainer: document.getElementById('project-board-container'),
                projectChatContainer: document.getElementById('project-chat-container'),
                projectChatToggle: document.getElementById('project-chat-toggle'),
                projectChatHeader: document.getElementById('project-chat-container-header'),
                projectViewTitle: document.getElementById('project-view-title'),
                kanbanView: document.getElementById('kanban-view'),
                listView: document.getElementById('list-view'),
                listViewMobile: document.getElementById('list-view-mobile'),
                viewToggleKanban: document.getElementById('view-toggle-kanban'),
                viewToggleList: document.getElementById('view-toggle-list'),
                addTaskListViewBtn: document.getElementById('add-task-list-view-btn'),
                projectChatMessages: document.getElementById('project-chat-messages'),
                projectMsgInput: document.getElementById('project-msg'),
                projectSendBtn: document.getElementById('project-send'),
                projectCalendarBtn: document.getElementById('project-calendar-btn'),
                tagFilterBtn: document.getElementById('tag-filter-btn'),
                tagFilterDropdown: document.getElementById('tag-filter-dropdown'),
                // Gamificación
                gamificationModal: document.getElementById('gamification-modal'),
                closeGamificationModal: document.getElementById('close-gamification-modal'),
                gamificationLevelName: document.getElementById('gamification-level-name'),
                gamificationXp: document.getElementById('gamification-xp'),
                gamificationCredits: document.getElementById('gamification-credits'),
                gamificationXpBar: document.getElementById('gamification-xp-bar'),
                dailyStreakContainer: document.getElementById('daily-streak-container'),
                missionsContainer: document.getElementById('gamification-tab-misiones'),
                achievementsContainer: document.getElementById('achievements-container'),
                gamificationRulesBtn: document.getElementById('gamification-rules-btn'),
                gamificationRulesModal: document.getElementById('gamification-rules-modal'),
                closeGamificationRulesModal: document.getElementById('close-gamification-rules-modal'),
                // Motivación
                motivationBtnHeader: document.getElementById('motivation-btn-header'),
                motivationBtnMobile: document.getElementById('motivation-btn-mobile'),
                motivationModal: document.getElementById('motivation-modal'),
                motivationTitle: document.getElementById('motivation-title'),
                motivationQuote: document.getElementById('motivation-quote'),
                motivationToggle: document.getElementById('motivation-toggle'),
                closeMotivationModal: document.getElementById('close-motivation-modal'),
                // Varios
                sidebarToggleArrow: document.getElementById('sidebar-toggle-arrow'),
                foldersContainer: document.getElementById('folders-container'),
                planCreditsDisplay: document.getElementById('plan-credits-display'),
                rewardCreditsDisplay: document.getElementById('reward-credits-display'),
                // Notepad DOM elements
                notesListPanel: document.getElementById('notes-list-panel'),
                notesListHeader: document.getElementById('notes-list-header'),
                noteEditorPanel: document.getElementById('note-editor-panel'),
                noteTitleInput: document.getElementById('note-title-input'),
                noteEditorToolbar: document.getElementById('note-editor-toolbar'),
                textTools: document.getElementById('text-tools'),
                drawingTools: document.getElementById('drawing-tools'),
                deleteNoteBtn: document.getElementById('delete-note-btn'),
                shareNoteBtn: document.getElementById('share-note-btn'),
                addChecklistItemBtn: document.getElementById('add-checklist-item-btn'),
                noteContentArea: document.getElementById('note-content-area'),
                noteContentEditor: document.getElementById('note-content-editor'),
                noteCanvas: document.getElementById('note-canvas'),
                addNewNoteBtn: document.getElementById('add-new-note-btn'),
                addNewDrawingBtn: document.getElementById('add-new-drawing-btn'),
                noteBackBtn: document.getElementById('note-back-btn'),
                notepadChatContainer: document.getElementById('notepad-chat-container'),
                notepadChatHeader: document.getElementById('notepad-chat-header'),
                notepadChatToggle: document.getElementById('notepad-chat-toggle'),
                notepadChatMessages: document.getElementById('notepad-chat-messages'),
                notepadMsgInput: document.getElementById('notepad-msg'),
                notepadSendBtn: document.getElementById('notepad-send'),
            };
            Object.assign(dom, fullDom);

            // Niveles de Gamificación adaptados a un contexto académico
            const XP_FOR_LEVEL = [0, 250, 750, 2000, 5000, Infinity]; 
            const LEVEL_NAMES = ["Estudiante Iniciado", "Aprendiz Aplicado", "Investigador Junior", "Erudito", "Graduado con Honores"];
            
            // Misiones y logros adaptados
            const MISSIONS = {
                'first-class': { id: 'first-class', text: 'Accede a tu primera clase', xp: 20, credits: 5 },
                'first-assignment': { id: 'first-assignment', text: 'Entrega tu primera tarea', xp: 50, credits: 15 },
                'week-organized': { id: 'week-organized', text: 'Organiza tu semana en el calendario', xp: 75, credits: 25, condition: checkWeekOrganized },
                'project-created': { id: 'project-created', text: 'Crea un proyecto de estudio y añade 3 tareas', xp: 100, credits: 30, condition: (chatId) => checkProjectCreated(chatId, 3) },
                'tutor-practice': { id: 'tutor-practice', text: 'Practica para un examen con el Tutor IA', xp: 40, credits: 10, workflow: 'tutor-practice' },
            };
            const ACHIEVEMENTS = {
                'streak-30': { id: 'streak-30', title: 'Consistencia', description: 'Mantén la racha de estudio por 30 días.', icon: 'fa-calendar-check', xp: 500, credits: 250 },
                'project-master': { id: 'project-master', title: 'Maestro de Proyectos', description: 'Completa 5 proyectos de estudio.', icon: 'fa-sitemap', xp: 750, credits: 0, reward: 'Consulta avanzada con Tutor IA' },
                'top-student': { id: 'top-student', title: 'Estudiante Destacado', description: 'Obtén una calificación perfecta en una tarea.', icon: 'fa-star', xp: 500, credits: 50 },
            };

            // --- CORRECCIÓN: Lógica de inicialización robusta ---
            let initFired = false;
            async function finishInitialization(user) {
                if (initFired) return;
                initFired = true;
                currentUser = user;

                try {
                    updateUserUI();
                    await loadStateForUser();
                    
                    populateVoiceList();
                    setupEventListeners();
                    setupNotifications();
                    updateContextualFooter();
                    setupMotivationInterval();

                    dom.appContainer.classList.remove('opacity-0');
                    dom.loadingOverlay.style.display = 'none';

                    if (currentChatId) { 
                        selectView(currentChatId);
                    } else if (currentUser && state.users[currentUser.id]?.enrolledCourses?.length > 0) {
                        selectView(`course-${state.users[currentUser.id].enrolledCourses[0]}`);
                    } else {
                        resetToDashboard();
                    }
                    updateNotificationBadge();
                } catch (e) {
                    console.error("Error crítico durante la inicialización:", e);
                    dom.loadingOverlay.innerHTML = `<div class="text-red-500 text-center">Error al cargar el Aula Virtual.<br>Por favor, recarga la página o contacta a soporte.<br><small>${e.message}</small></div>`;
                }
            };
            
            // --- BLOQUE DE INICIALIZACIÓN ---
            const savedLang = localStorage.getItem('ibero-lang') || 'es';
            setLanguage(savedLang);
            setTheme(localStorage.getItem('ibero-theme') === 'dark' || (!localStorage.getItem('ibero-theme') && window.matchMedia('(prefers-color-scheme: dark)').matches));

            // Service Worker para notificaciones push
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js').then(registration => {
                        console.log('ServiceWorker registrado con éxito:', registration.scope);
                    }).catch(error => {
                        console.log('Fallo en el registro de ServiceWorker:', error);
                    });
                });
            }

            if (window.netlifyIdentity) {
                netlifyIdentity.on('init', user => finishInitialization(user));
                netlifyIdentity.on('login', user => {
                    netlifyIdentity.close(); 
                    finishInitialization(user);
                });
                netlifyIdentity.on('logout', () => {
                    localStorage.removeItem(`iberoState_${currentUser.id}`);
                    finishInitialization(null); 
                    window.location.reload();
                });
                netlifyIdentity.on('error', err => {
                    console.error("Netlify Identity Error:", err);
                    if (!initFired) finishInitialization(null); 
                });
            } else {
                 console.warn("Netlify Identity no encontrado. Procediendo como invitado.");
                 finishInitialization(null);
            }

            setTimeout(() => {
                if (!initFired) {
                    console.warn("Netlify Identity no respondió, forzando inicialización.");
                    finishInitialization(window.netlifyIdentity ? netlifyIdentity.currentUser() : null);
                }
            }, 3000);
        });
    </script>
</body>
</html>
